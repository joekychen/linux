<!DOCTYPE html>
<html><head><title>joekychen/linux » security › tomoyo › condition.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>condition.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * security/tomoyo/condition.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2011  NTT DATA CORPORATION</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cm">/* List of &quot;struct tomoyo_condition&quot;. */</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">tomoyo_condition_list</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_argv - Check argv[] in &quot;struct linux_binbrm&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * @index:   Index number of @arg_ptr.</span>
<span class="cm"> * @arg_ptr: Contents of argv[@index].</span>
<span class="cm"> * @argc:    Length of @argv.</span>
<span class="cm"> * @argv:    Pointer to &quot;struct tomoyo_argv&quot;.</span>
<span class="cm"> * @checked: Set to true if @argv[@index] was found.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_argv</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg_ptr</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_argv</span> <span class="o">*</span><span class="n">argv</span><span class="p">,</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">checked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">arg_ptr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">argv</span><span class="o">++</span><span class="p">,</span> <span class="n">checked</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">result</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="n">argv</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="o">*</span><span class="n">checked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tomoyo_fill_path_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">tomoyo_path_matches_pattern</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="n">argv</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argv</span><span class="o">-&gt;</span><span class="n">is_not</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">!</span><span class="n">result</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_envp - Check envp[] in &quot;struct linux_binbrm&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * @env_name:  The name of environment variable.</span>
<span class="cm"> * @env_value: The value of environment variable.</span>
<span class="cm"> * @envc:      Length of @envp.</span>
<span class="cm"> * @envp:      Pointer to &quot;struct tomoyo_envp&quot;.</span>
<span class="cm"> * @checked:   Set to true if @envp[@env_name] was found.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_envp</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">env_name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">env_value</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">int</span> <span class="n">envc</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_envp</span> <span class="o">*</span><span class="n">envp</span><span class="p">,</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">checked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="n">name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">name</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">env_name</span><span class="p">;</span>
	<span class="n">tomoyo_fill_path_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">value</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">env_value</span><span class="p">;</span>
	<span class="n">tomoyo_fill_path_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">envc</span><span class="p">;</span> <span class="n">envp</span><span class="o">++</span><span class="p">,</span> <span class="n">checked</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">result</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_path_matches_pattern</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="n">envp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="o">*</span><span class="n">checked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">envp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">tomoyo_path_matches_pattern</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span>
							     <span class="n">envp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">envp</span><span class="o">-&gt;</span><span class="n">is_not</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="o">!</span><span class="n">result</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">envp</span><span class="o">-&gt;</span><span class="n">is_not</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="o">!</span><span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_scan_bprm - Scan &quot;struct linux_binprm&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * @ee:   Pointer to &quot;struct tomoyo_execve&quot;.</span>
<span class="cm"> * @argc: Length of @argc.</span>
<span class="cm"> * @argv: Pointer to &quot;struct tomoyo_argv&quot;.</span>
<span class="cm"> * @envc: Length of @envp.</span>
<span class="cm"> * @envp: Poiner to &quot;struct tomoyo_envp&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_scan_bprm</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_execve</span> <span class="o">*</span><span class="n">ee</span><span class="p">,</span>
			     <span class="k">const</span> <span class="n">u16</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_argv</span> <span class="o">*</span><span class="n">argv</span><span class="p">,</span>
			     <span class="k">const</span> <span class="n">u16</span> <span class="n">envc</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_envp</span> <span class="o">*</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">linux_binprm</span> <span class="o">*</span><span class="n">bprm</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">bprm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_page_dump</span> <span class="o">*</span><span class="n">dump</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">arg_ptr</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">arg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">argv_count</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">envp_count</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">envc</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">local_checked</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">checked</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">+</span> <span class="n">envc</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">local_checked</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">checked</span> <span class="o">=</span> <span class="n">local_checked</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">local_checked</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">local_checked</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">checked</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">argc</span> <span class="o">+</span> <span class="n">envc</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">checked</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">argv_count</span> <span class="o">||</span> <span class="n">envp_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_dump_page</span><span class="p">(</span><span class="n">bprm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dump</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Read. */</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kaddr</span> <span class="o">=</span> <span class="n">dump</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">kaddr</span><span class="p">[</span><span class="n">offset</span><span class="o">++</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">arg_len</span> <span class="o">&lt;</span> <span class="n">TOMOYO_EXEC_TMPSIZE</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">arg_ptr</span><span class="p">[</span><span class="n">arg_len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span>
					<span class="n">arg_ptr</span><span class="p">[</span><span class="n">arg_len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">arg_ptr</span><span class="p">[</span><span class="n">arg_len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">arg_ptr</span><span class="p">[</span><span class="n">arg_len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span>
					<span class="n">arg_ptr</span><span class="p">[</span><span class="n">arg_len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
					<span class="n">arg_ptr</span><span class="p">[</span><span class="n">arg_len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
						<span class="p">((</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
					<span class="n">arg_ptr</span><span class="p">[</span><span class="n">arg_len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">arg_ptr</span><span class="p">[</span><span class="n">arg_len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* Check. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">argv_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_argv</span><span class="p">(</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">-</span> <span class="n">argv_count</span><span class="p">,</span>
						 <span class="n">arg_ptr</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span>
						 <span class="n">checked</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">argv_count</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">envp_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">arg_ptr</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_envp</span><span class="p">(</span><span class="n">arg_ptr</span><span class="p">,</span> <span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
							 <span class="n">envc</span><span class="p">,</span> <span class="n">envp</span><span class="p">,</span>
							 <span class="n">checked</span> <span class="o">+</span> <span class="n">argc</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">envp_count</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">arg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="cm">/* Check not-yet-checked entries. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">checked</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Return true only if all unchecked indexes in</span>
<span class="cm">			 * bprm-&gt;argv[] are not matched.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_not</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">envc</span><span class="p">;</span> <span class="n">envp</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">checked</span><span class="p">[</span><span class="n">argc</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Return true only if all unchecked environ variables</span>
<span class="cm">			 * in bprm-&gt;envp[] are either undefined or not matched.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">envp</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">envp</span><span class="o">-&gt;</span><span class="n">is_not</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">envp</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">envp</span><span class="o">-&gt;</span><span class="n">is_not</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">checked</span> <span class="o">!=</span> <span class="n">local_checked</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">checked</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_scan_exec_realpath - Check &quot;exec.realpath&quot; parameter of &quot;struct tomoyo_condition&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * @file:  Pointer to &quot;struct file&quot;.</span>
<span class="cm"> * @ptr:   Pointer to &quot;struct tomoyo_name_union&quot;.</span>
<span class="cm"> * @match: True if &quot;exec.realpath=&quot;, false if &quot;exec.realpath!=&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_scan_exec_realpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_name_union</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
				      <span class="k">const</span> <span class="n">bool</span> <span class="n">match</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="n">exe</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">exe</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">tomoyo_realpath_from_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exe</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">tomoyo_fill_path_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exe</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">tomoyo_compare_name_union</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exe</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">exe</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">==</span> <span class="n">match</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_get_dqword - tomoyo_get_name() for a quoted string.</span>
<span class="cm"> *</span>
<span class="cm"> * @start: String to save.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to &quot;struct tomoyo_path_info&quot; on success, NULL otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="o">*</span><span class="nf">tomoyo_get_dqword</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">==</span> <span class="n">start</span> <span class="o">||</span> <span class="o">*</span><span class="n">start</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;&quot;&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tomoyo_correct_word</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tomoyo_get_name</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_parse_name_union_quoted - Parse a quoted word.</span>
<span class="cm"> *</span>
<span class="cm"> * @param: Pointer to &quot;struct tomoyo_acl_param&quot;.</span>
<span class="cm"> * @ptr:   Pointer to &quot;struct tomoyo_name_union&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_parse_name_union_quoted</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">tomoyo_name_union</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">filename</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">filename</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tomoyo_parse_name_union</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="n">tomoyo_get_dqword</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_parse_argv - Parse an argv[] condition part.</span>
<span class="cm"> *</span>
<span class="cm"> * @left:  Lefthand value.</span>
<span class="cm"> * @right: Righthand value.</span>
<span class="cm"> * @argv:  Pointer to &quot;struct tomoyo_argv&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_parse_argv</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">left</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">right</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">tomoyo_argv</span> <span class="o">*</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_parse_ulong</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argv</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">TOMOYO_VALUE_TYPE_DECIMAL</span> <span class="o">||</span> <span class="o">*</span><span class="n">left</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;]&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">left</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">argv</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">tomoyo_get_dqword</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">argv</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_parse_envp - Parse an envp[] condition part.</span>
<span class="cm"> *</span>
<span class="cm"> * @left:  Lefthand value.</span>
<span class="cm"> * @right: Righthand value.</span>
<span class="cm"> * @envp:  Pointer to &quot;struct tomoyo_envp&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_parse_envp</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">left</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">right</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">tomoyo_envp</span> <span class="o">*</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="o">--</span> <span class="o">!=</span> <span class="sc">&#39;]&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_correct_word</span><span class="p">(</span><span class="n">left</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">tomoyo_get_name</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="s">&quot;NULL&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">tomoyo_get_dqword</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tomoyo_put_name</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">envp</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">envp</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_same_condition - Check for duplicated &quot;struct tomoyo_condition&quot; entry.</span>
<span class="cm"> *</span>
<span class="cm"> * @a: Pointer to &quot;struct tomoyo_condition&quot;.</span>
<span class="cm"> * @b: Pointer to &quot;struct tomoyo_condition&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @a == @b, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">tomoyo_same_condition</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_condition</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
					 <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_condition</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">condc</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">condc</span> <span class="o">&amp;&amp;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">numbers_count</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">numbers_count</span> <span class="o">&amp;&amp;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">names_count</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">names_count</span> <span class="o">&amp;&amp;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">envc</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">envc</span> <span class="o">&amp;&amp;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">grant_log</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">grant_log</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">transit</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">transit</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_condition_type - Get condition type.</span>
<span class="cm"> *</span>
<span class="cm"> * @word: Keyword string.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns one of values in &quot;enum tomoyo_conditions_index&quot; on success,</span>
<span class="cm"> * TOMOYO_MAX_CONDITION_KEYWORD otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">tomoyo_condition_type</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">word</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_CONDITION_KEYWORD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">tomoyo_condition_keyword</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Define this to enable debug mode. */</span>
<span class="cm">/* #define DEBUG_CONDITION */</span>

<span class="cp">#ifdef DEBUG_CONDITION</span>
<span class="cp">#define dprintk printk</span>
<span class="cp">#else</span>
<span class="cp">#define dprintk(...) do { } while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_commit_condition - Commit &quot;struct tomoyo_condition&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * @entry: Pointer to &quot;struct tomoyo_condition&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to &quot;struct tomoyo_condition&quot; on success, NULL otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * This function merges duplicated entries. This function returns NULL if</span>
<span class="cm"> * @entry is not duplicated but memory quota for policy has exceeded.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tomoyo_condition</span> <span class="o">*</span><span class="nf">tomoyo_commit_condition</span>
<span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_condition</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_condition</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_policy_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%u: %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_condition_list</span><span class="p">,</span> <span class="n">head</span><span class="p">.</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_same_condition</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">users</span><span class="p">)</span> <span class="o">==</span> <span class="n">TOMOYO_GC_IN_PROGRESS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Same entry found. Share this entry. */</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">users</span><span class="p">);</span>
		<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_memory_ok</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">users</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_condition_list</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_policy_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tomoyo_del_condition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_get_transit_preference - Parse domain transition preference for execve().</span>
<span class="cm"> *</span>
<span class="cm"> * @param: Pointer to &quot;struct tomoyo_acl_param&quot;.</span>
<span class="cm"> * @e:     Pointer to &quot;struct tomoyo_condition&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the condition string part.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">tomoyo_get_transit_preference</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">tomoyo_condition</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">flag</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">==</span> <span class="sc">&#39;&lt;&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">transit</span> <span class="o">=</span> <span class="n">tomoyo_get_domainname</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
			<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">flag</span> <span class="o">=</span> <span class="n">tomoyo_correct_path</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="s">&quot;keep&quot;</span><span class="p">)</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="s">&quot;initialize&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="s">&quot;reset&quot;</span><span class="p">)</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="s">&quot;child&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="s">&quot;parent&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
			<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">transit</span> <span class="o">=</span> <span class="n">tomoyo_get_name</span><span class="p">(</span><span class="n">tomoyo_read_token</span><span class="p">(</span><span class="n">param</span><span class="p">));</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">transit</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Return a bad read-only condition string that will let</span>
<span class="cm">	 * tomoyo_get_condition() return NULL.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="s">&quot;/&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_get_condition - Parse condition part.</span>
<span class="cm"> *</span>
<span class="cm"> * @param: Pointer to &quot;struct tomoyo_acl_param&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to &quot;struct tomoyo_condition&quot; on success, NULL otherwise.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tomoyo_condition</span> <span class="o">*</span><span class="nf">tomoyo_get_condition</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_condition</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_condition_element</span> <span class="o">*</span><span class="n">condp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_number_union</span> <span class="o">*</span><span class="n">numbers_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_name_union</span> <span class="o">*</span><span class="n">names_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_argv</span> <span class="o">*</span><span class="n">argv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_envp</span> <span class="o">*</span><span class="n">envp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_condition</span> <span class="n">e</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">start_of_string</span> <span class="o">=</span>
		<span class="n">tomoyo_get_transit_preference</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">end_of_string</span> <span class="o">=</span> <span class="n">start_of_string</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">start_of_string</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
<span class="nl">rerun:</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">start_of_string</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">left</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">right</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">left_word</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">right_word</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">is_not</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">left_word</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Since left-hand condition does not allow use of &quot;path_group&quot;</span>
<span class="cm">		 * or &quot;number_group&quot; and environment variable&#39;s names do not</span>
<span class="cm">		 * accept &#39;=&#39;, it is guaranteed that the original line consists</span>
<span class="cm">		 * of one or more repetition of $left$operator$right blocks</span>
<span class="cm">		 * where &quot;$left is free from &#39;=&#39; and &#39; &#39;&quot; and &quot;$operator is</span>
<span class="cm">		 * either &#39;=&#39; or &#39;!=&#39;&quot; and &quot;$right is free from &#39; &#39;&quot;.</span>
<span class="cm">		 * Therefore, we can reconstruct the original line at the end</span>
<span class="cm">		 * of dry run even if we overwrite $operator with &#39;\0&#39;.</span>
<span class="cm">		 */</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="cm">/* Will restore later. */</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">right_word</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">left_word</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">right_word</span> <span class="o">||</span> <span class="n">right_word</span> <span class="o">==</span> <span class="n">left_word</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">is_not</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">right_word</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;!&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_not</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">right_word</span><span class="o">++</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="cm">/* Will restore later. */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">right_word</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span>
			<span class="o">*</span><span class="n">right_word</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="cm">/* Will restore later. */</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%u: &lt;%s&gt;%s=&lt;%s&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">left_word</span><span class="p">,</span>
			<span class="n">is_not</span> <span class="o">?</span> <span class="s">&quot;!&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">right_word</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">left_word</span><span class="p">,</span> <span class="s">&quot;grant_log&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_not</span> <span class="o">||</span>
				    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">grant_log</span> <span class="o">!=</span> <span class="n">TOMOYO_GRANTLOG_AUTO</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">right_word</span><span class="p">,</span> <span class="s">&quot;yes&quot;</span><span class="p">))</span>
					<span class="n">entry</span><span class="o">-&gt;</span><span class="n">grant_log</span> <span class="o">=</span> <span class="n">TOMOYO_GRANTLOG_YES</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">right_word</span><span class="p">,</span> <span class="s">&quot;no&quot;</span><span class="p">))</span>
					<span class="n">entry</span><span class="o">-&gt;</span><span class="n">grant_log</span> <span class="o">=</span> <span class="n">TOMOYO_GRANTLOG_NO</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">left_word</span><span class="p">,</span> <span class="s">&quot;exec.argv[&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">e</span><span class="p">.</span><span class="n">argc</span><span class="o">++</span><span class="p">;</span>
				<span class="n">e</span><span class="p">.</span><span class="n">condc</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">e</span><span class="p">.</span><span class="n">argc</span><span class="o">--</span><span class="p">;</span>
				<span class="n">e</span><span class="p">.</span><span class="n">condc</span><span class="o">--</span><span class="p">;</span>
				<span class="n">left</span> <span class="o">=</span> <span class="n">TOMOYO_ARGV_ENTRY</span><span class="p">;</span>
				<span class="n">argv</span><span class="o">-&gt;</span><span class="n">is_not</span> <span class="o">=</span> <span class="n">is_not</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_parse_argv</span><span class="p">(</span><span class="n">left_word</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span>
						       <span class="n">right_word</span><span class="p">,</span> <span class="n">argv</span><span class="o">++</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">store_value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">left_word</span><span class="p">,</span> <span class="s">&quot;exec.envp[</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">envp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">e</span><span class="p">.</span><span class="n">envc</span><span class="o">++</span><span class="p">;</span>
				<span class="n">e</span><span class="p">.</span><span class="n">condc</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">e</span><span class="p">.</span><span class="n">envc</span><span class="o">--</span><span class="p">;</span>
				<span class="n">e</span><span class="p">.</span><span class="n">condc</span><span class="o">--</span><span class="p">;</span>
				<span class="n">left</span> <span class="o">=</span> <span class="n">TOMOYO_ENVP_ENTRY</span><span class="p">;</span>
				<span class="n">envp</span><span class="o">-&gt;</span><span class="n">is_not</span> <span class="o">=</span> <span class="n">is_not</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_parse_envp</span><span class="p">(</span><span class="n">left_word</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span>
						       <span class="n">right_word</span><span class="p">,</span> <span class="n">envp</span><span class="o">++</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">store_value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">tomoyo_condition_type</span><span class="p">(</span><span class="n">left_word</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%u: &lt;%s&gt; left=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">left_word</span><span class="p">,</span>
			<span class="n">left</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="n">TOMOYO_MAX_CONDITION_KEYWORD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">numbers_p</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">e</span><span class="p">.</span><span class="n">numbers_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">e</span><span class="p">.</span><span class="n">numbers_count</span><span class="o">--</span><span class="p">;</span>
				<span class="n">left</span> <span class="o">=</span> <span class="n">TOMOYO_NUMBER_UNION</span><span class="p">;</span>
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">left_word</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">left_word</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span> <span class="o">||</span>
				    <span class="o">!</span><span class="n">tomoyo_parse_number_union</span><span class="p">(</span><span class="n">param</span><span class="p">,</span>
							       <span class="n">numbers_p</span><span class="o">++</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">condp</span><span class="p">)</span>
			<span class="n">e</span><span class="p">.</span><span class="n">condc</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">e</span><span class="p">.</span><span class="n">condc</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="n">TOMOYO_EXEC_REALPATH</span> <span class="o">||</span>
		    <span class="n">left</span> <span class="o">==</span> <span class="n">TOMOYO_SYMLINK_TARGET</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">names_p</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">e</span><span class="p">.</span><span class="n">names_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">e</span><span class="p">.</span><span class="n">names_count</span><span class="o">--</span><span class="p">;</span>
				<span class="n">right</span> <span class="o">=</span> <span class="n">TOMOYO_NAME_UNION</span><span class="p">;</span>
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">right_word</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_parse_name_union_quoted</span><span class="p">(</span><span class="n">param</span><span class="p">,</span>
								    <span class="n">names_p</span><span class="o">++</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">store_value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">tomoyo_condition_type</span><span class="p">(</span><span class="n">right_word</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">right</span> <span class="o">==</span> <span class="n">TOMOYO_MAX_CONDITION_KEYWORD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">numbers_p</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">e</span><span class="p">.</span><span class="n">numbers_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">e</span><span class="p">.</span><span class="n">numbers_count</span><span class="o">--</span><span class="p">;</span>
				<span class="n">right</span> <span class="o">=</span> <span class="n">TOMOYO_NUMBER_UNION</span><span class="p">;</span>
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">right_word</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_parse_number_union</span><span class="p">(</span><span class="n">param</span><span class="p">,</span>
							       <span class="n">numbers_p</span><span class="o">++</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="nl">store_value:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">condp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%u: dry_run left=%u right=%u &quot;</span>
				<span class="s">&quot;match=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="o">!</span><span class="n">is_not</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">condp</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
		<span class="n">condp</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
		<span class="n">condp</span><span class="o">-&gt;</span><span class="n">equals</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_not</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%u: left=%u right=%u match=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">condp</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">condp</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">,</span>
			<span class="n">condp</span><span class="o">-&gt;</span><span class="n">equals</span><span class="p">);</span>
		<span class="n">condp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%u: cond=%u numbers=%u names=%u ac=%u ec=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__LINE__</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">condc</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">numbers_count</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">names_count</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">argc</span><span class="p">,</span>
		<span class="n">e</span><span class="p">.</span><span class="n">envc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">names_count</span> <span class="o">|</span> <span class="n">e</span><span class="p">.</span><span class="n">numbers_count</span> <span class="o">|</span> <span class="n">e</span><span class="p">.</span><span class="n">argc</span> <span class="o">|</span> <span class="n">e</span><span class="p">.</span><span class="n">envc</span> <span class="o">|</span>
		       <span class="n">e</span><span class="p">.</span><span class="n">condc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tomoyo_commit_condition</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">e</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">)</span>
		<span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">condc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_condition_element</span><span class="p">)</span>
		<span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">numbers_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_number_union</span><span class="p">)</span>
		<span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">names_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_name_union</span><span class="p">)</span>
		<span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">argc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_argv</span><span class="p">)</span>
		<span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">envc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_envp</span><span class="p">);</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
	<span class="n">e</span><span class="p">.</span><span class="n">transit</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">condp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_condition_element</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">numbers_p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_number_union</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">condp</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">condc</span><span class="p">);</span>
	<span class="n">names_p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_name_union</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">numbers_p</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">numbers_count</span><span class="p">);</span>
	<span class="n">argv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_argv</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">names_p</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">names_count</span><span class="p">);</span>
	<span class="n">envp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_envp</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">argv</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">argc</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="n">bool</span> <span class="n">flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="n">start_of_string</span><span class="p">;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">end_of_string</span><span class="p">;</span> <span class="n">pos</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="cm">/* Restore &quot; &quot;. */</span>
				<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span> <span class="cm">/* Restore &quot;!=&quot;. */</span>
				<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="sc">&#39;!&#39;</span><span class="p">;</span>
			<span class="k">else</span> <span class="cm">/* Restore &quot;=&quot;. */</span>
				<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="sc">&#39;=&#39;</span><span class="p">;</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="o">!</span><span class="n">flag</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">rerun</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%u: %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tomoyo_del_condition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out2:</span>
	<span class="n">tomoyo_put_name</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">transit</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_get_attributes - Revalidate &quot;struct inode&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * @obj: Pointer to &quot;struct tomoyo_obj_info&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tomoyo_get_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_obj_info</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_PATH_STAT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TOMOYO_PATH1</span>:
			<span class="n">dentry</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">path1</span><span class="p">.</span><span class="n">dentry</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TOMOYO_PATH2</span>:
			<span class="n">dentry</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">path2</span><span class="p">.</span><span class="n">dentry</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">dentry</span> <span class="o">=</span> <span class="n">dget_parent</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tomoyo_mini_stat</span> <span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">stat</span><span class="o">-&gt;</span><span class="n">uid</span>  <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_uid</span><span class="p">;</span>
			<span class="n">stat</span><span class="o">-&gt;</span><span class="n">gid</span>  <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_gid</span><span class="p">;</span>
			<span class="n">stat</span><span class="o">-&gt;</span><span class="n">ino</span>  <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
			<span class="n">stat</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">;</span>
			<span class="n">stat</span><span class="o">-&gt;</span><span class="n">dev</span>  <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">;</span>
			<span class="n">stat</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rdev</span><span class="p">;</span>
			<span class="n">obj</span><span class="o">-&gt;</span><span class="n">stat_valid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="cm">/* i == TOMOYO_PATH1_PARENT ||</span>
<span class="cm">			      i == TOMOYO_PATH2_PARENT */</span>
			<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_condition - Check condition part.</span>
<span class="cm"> *</span>
<span class="cm"> * @r:    Pointer to &quot;struct tomoyo_request_info&quot;.</span>
<span class="cm"> * @cond: Pointer to &quot;struct tomoyo_condition&quot;. Maybe NULL.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">tomoyo_condition</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_condition</span> <span class="o">*</span><span class="n">cond</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min_v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_condition_element</span> <span class="o">*</span><span class="n">condp</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_number_union</span> <span class="o">*</span><span class="n">numbers_p</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_name_union</span> <span class="o">*</span><span class="n">names_p</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_argv</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_envp</span> <span class="o">*</span><span class="n">envp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_obj_info</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">condc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">argc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">envc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">linux_binprm</span> <span class="o">*</span><span class="n">bprm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cond</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">condc</span> <span class="o">=</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">condc</span><span class="p">;</span>
	<span class="n">argc</span> <span class="o">=</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span>
	<span class="n">envc</span> <span class="o">=</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">envc</span><span class="p">;</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ee</span><span class="p">)</span>
		<span class="n">bprm</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">bprm</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bprm</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">argc</span> <span class="o">||</span> <span class="n">envc</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">condp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_condition_element</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cond</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">numbers_p</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_number_union</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">condp</span> <span class="o">+</span> <span class="n">condc</span><span class="p">);</span>
	<span class="n">names_p</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_name_union</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">numbers_p</span> <span class="o">+</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">numbers_count</span><span class="p">);</span>
	<span class="n">argv</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_argv</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">names_p</span> <span class="o">+</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">names_count</span><span class="p">);</span>
	<span class="n">envp</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_envp</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">argv</span> <span class="o">+</span> <span class="n">argc</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">condc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">bool</span> <span class="n">match</span> <span class="o">=</span> <span class="n">condp</span><span class="o">-&gt;</span><span class="n">equals</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="n">left</span> <span class="o">=</span> <span class="n">condp</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="n">right</span> <span class="o">=</span> <span class="n">condp</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">is_bitop</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span> <span class="p">};</span>
		<span class="n">u8</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">condp</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* Check argv[] and envp[] later. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="n">TOMOYO_ARGV_ENTRY</span> <span class="o">||</span> <span class="n">left</span> <span class="o">==</span> <span class="n">TOMOYO_ENVP_ENTRY</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Check string expressions. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">right</span> <span class="o">==</span> <span class="n">TOMOYO_NAME_UNION</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_name_union</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">names_p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="o">*</span><span class="n">symlink</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">tomoyo_execve</span> <span class="o">*</span><span class="n">ee</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_SYMLINK_TARGET</span>:
				<span class="n">symlink</span> <span class="o">=</span> <span class="n">obj</span> <span class="o">?</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">symlink_target</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">symlink</span> <span class="o">||</span>
				    <span class="o">!</span><span class="n">tomoyo_compare_name_union</span><span class="p">(</span><span class="n">symlink</span><span class="p">,</span> <span class="n">ptr</span><span class="p">)</span>
				    <span class="o">==</span> <span class="n">match</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_EXEC_REALPATH</span>:
				<span class="n">ee</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ee</span><span class="p">;</span>
				<span class="n">file</span> <span class="o">=</span> <span class="n">ee</span> <span class="o">?</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_scan_exec_realpath</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span>
							       <span class="n">match</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Check numeric or bit-op expressions. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="n">index</span> <span class="o">=</span> <span class="n">j</span> <span class="o">?</span> <span class="n">right</span> <span class="o">:</span> <span class="n">left</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">TOMOYO_TASK_UID</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">current_uid</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TASK_EUID</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">current_euid</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TASK_SUID</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">current_suid</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TASK_FSUID</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">current_fsuid</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TASK_GID</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">current_gid</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TASK_EGID</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">current_egid</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TASK_SGID</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">current_sgid</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TASK_FSGID</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">current_fsgid</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TASK_PID</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">tomoyo_sys_getpid</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TASK_PPID</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">tomoyo_sys_getppid</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TYPE_IS_SOCKET</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IFSOCK</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TYPE_IS_SYMLINK</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IFLNK</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TYPE_IS_FILE</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IFREG</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TYPE_IS_BLOCK_DEV</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IFBLK</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TYPE_IS_DIRECTORY</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IFDIR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TYPE_IS_CHAR_DEV</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IFCHR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_TYPE_IS_FIFO</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IFIFO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_MODE_SETUID</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_ISUID</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_MODE_SETGID</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_ISGID</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_MODE_STICKY</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_ISVTX</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_MODE_OWNER_READ</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IRUSR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_MODE_OWNER_WRITE</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IWUSR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_MODE_OWNER_EXECUTE</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IXUSR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_MODE_GROUP_READ</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IRGRP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_MODE_GROUP_WRITE</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IWGRP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_MODE_GROUP_EXECUTE</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IXGRP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_MODE_OTHERS_READ</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IROTH</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_MODE_OTHERS_WRITE</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IWOTH</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_MODE_OTHERS_EXECUTE</span>:
				<span class="n">value</span> <span class="o">=</span> <span class="n">S_IXOTH</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_EXEC_ARGC</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bprm</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_EXEC_ENVC</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bprm</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">envc</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_NUMBER_UNION</span>:
				<span class="cm">/* Fetch values later. */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">validate_done</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tomoyo_get_attributes</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
					<span class="n">obj</span><span class="o">-&gt;</span><span class="n">validate_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="p">{</span>
					<span class="n">u8</span> <span class="n">stat_index</span><span class="p">;</span>
					<span class="k">struct</span> <span class="n">tomoyo_mini_stat</span> <span class="o">*</span><span class="n">stat</span><span class="p">;</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_UID</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_GID</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_INO</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_MAJOR</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_MINOR</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_TYPE</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_DEV_MAJOR</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_DEV_MINOR</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_PERM</span>:
						<span class="n">stat_index</span> <span class="o">=</span> <span class="n">TOMOYO_PATH1</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_UID</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_GID</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_INO</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_MAJOR</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_MINOR</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_TYPE</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_DEV_MAJOR</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_DEV_MINOR</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_PERM</span>:
						<span class="n">stat_index</span> <span class="o">=</span> <span class="n">TOMOYO_PATH2</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_PARENT_UID</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_PARENT_GID</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_PARENT_INO</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_PARENT_PERM</span>:
						<span class="n">stat_index</span> <span class="o">=</span>
							<span class="n">TOMOYO_PATH1_PARENT</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_PARENT_UID</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_PARENT_GID</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_PARENT_INO</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_PARENT_PERM</span>:
						<span class="n">stat_index</span> <span class="o">=</span>
							<span class="n">TOMOYO_PATH2_PARENT</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="nl">default:</span>
						<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">stat_valid</span><span class="p">[</span><span class="n">stat_index</span><span class="p">])</span>
						<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
					<span class="n">stat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">stat_index</span><span class="p">];</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_UID</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_UID</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_PARENT_UID</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_PARENT_UID</span>:
						<span class="n">value</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_GID</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_GID</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_PARENT_GID</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_PARENT_GID</span>:
						<span class="n">value</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_INO</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_INO</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_PARENT_INO</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_PARENT_INO</span>:
						<span class="n">value</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_MAJOR</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_MAJOR</span>:
						<span class="n">value</span> <span class="o">=</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_MINOR</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_MINOR</span>:
						<span class="n">value</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_TYPE</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_TYPE</span>:
						<span class="n">value</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">S_IFMT</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_DEV_MAJOR</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_DEV_MAJOR</span>:
						<span class="n">value</span> <span class="o">=</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_DEV_MINOR</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_DEV_MINOR</span>:
						<span class="n">value</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_PERM</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_PERM</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH1_PARENT_PERM</span>:
					<span class="k">case</span> <span class="n">TOMOYO_PATH2_PARENT_PERM</span>:
						<span class="n">value</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">S_IALLUGO</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">max_v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">min_v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">TOMOYO_MODE_SETUID</span>:
			<span class="k">case</span> <span class="n">TOMOYO_MODE_SETGID</span>:
			<span class="k">case</span> <span class="n">TOMOYO_MODE_STICKY</span>:
			<span class="k">case</span> <span class="n">TOMOYO_MODE_OWNER_READ</span>:
			<span class="k">case</span> <span class="n">TOMOYO_MODE_OWNER_WRITE</span>:
			<span class="k">case</span> <span class="n">TOMOYO_MODE_OWNER_EXECUTE</span>:
			<span class="k">case</span> <span class="n">TOMOYO_MODE_GROUP_READ</span>:
			<span class="k">case</span> <span class="n">TOMOYO_MODE_GROUP_WRITE</span>:
			<span class="k">case</span> <span class="n">TOMOYO_MODE_GROUP_EXECUTE</span>:
			<span class="k">case</span> <span class="n">TOMOYO_MODE_OTHERS_READ</span>:
			<span class="k">case</span> <span class="n">TOMOYO_MODE_OTHERS_WRITE</span>:
			<span class="k">case</span> <span class="n">TOMOYO_MODE_OTHERS_EXECUTE</span>:
				<span class="n">is_bitop</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="n">TOMOYO_NUMBER_UNION</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Fetch values now. */</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_number_union</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">numbers_p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">min_v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">max_v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">right</span> <span class="o">==</span> <span class="n">TOMOYO_NUMBER_UNION</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Fetch values now. */</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_number_union</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">numbers_p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_number_matches_group</span><span class="p">(</span><span class="n">min_v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
								<span class="n">max_v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
								<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">)</span>
				    <span class="o">==</span> <span class="n">match</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">min_v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				     <span class="n">max_v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">match</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Bit operation is valid only when counterpart value</span>
<span class="cm">		 * represents permission.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_bitop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">is_bitop</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_bitop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">TOMOYO_PATH1_PERM</span>:
			<span class="k">case</span> <span class="n">TOMOYO_PATH1_PARENT_PERM</span>:
			<span class="k">case</span> <span class="n">TOMOYO_PATH2_PERM</span>:
			<span class="k">case</span> <span class="n">TOMOYO_PATH2_PARENT_PERM</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">max_v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">max_v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="o">!</span><span class="n">match</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_bitop</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">TOMOYO_PATH1_PERM</span>:
			<span class="k">case</span> <span class="n">TOMOYO_PATH1_PARENT_PERM</span>:
			<span class="k">case</span> <span class="n">TOMOYO_PATH2_PERM</span>:
			<span class="k">case</span> <span class="n">TOMOYO_PATH2_PARENT_PERM</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">max_v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">max_v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="o">!</span><span class="n">match</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Normal value range comparison. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">min_v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">max_v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">match</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
<span class="nl">out:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check argv[] and envp[] now. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ee</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">argc</span> <span class="o">||</span> <span class="n">envc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">tomoyo_scan_bprm</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ee</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envc</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
