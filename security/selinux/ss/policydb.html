<!DOCTYPE html>
<html><head><title>joekychen/linux » security › selinux › ss › policydb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>policydb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Implementation of the policy database.</span>
<span class="cm"> *</span>
<span class="cm"> * Author : Stephen Smalley, &lt;sds@epoch.ncsc.mil&gt;</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Updated: Trusted Computer Solutions, Inc. &lt;dgoeddel@trustedcs.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	Support for enhanced MLS infrastructure.</span>
<span class="cm"> *</span>
<span class="cm"> * Updated: Frank Mayer &lt;mayerf@tresys.com&gt; and Karl MacMillan &lt;kmacmillan@tresys.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	Added conditional policy language extensions</span>
<span class="cm"> *</span>
<span class="cm"> * Updated: Hewlett-Packard &lt;paul@paul-moore.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *      Added support for the policy capability bitmap</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Hewlett-Packard Development Company, L.P.</span>
<span class="cm"> * Copyright (C) 2004-2005 Trusted Computer Solutions, Inc.</span>
<span class="cm"> * Copyright (C) 2003 - 2004 Tresys Technology, LLC</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *	it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *	the Free Software Foundation, version 2.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/audit.h&gt;</span>
<span class="cp">#include &lt;linux/flex_array.h&gt;</span>
<span class="cp">#include &quot;security.h&quot;</span>

<span class="cp">#include &quot;policydb.h&quot;</span>
<span class="cp">#include &quot;conditional.h&quot;</span>
<span class="cp">#include &quot;mls.h&quot;</span>
<span class="cp">#include &quot;services.h&quot;</span>

<span class="cp">#define _DEBUG_HASHES</span>

<span class="cp">#ifdef DEBUG_HASHES</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symtab_name</span><span class="p">[</span><span class="n">SYM_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;common prefixes&quot;</span><span class="p">,</span>
	<span class="s">&quot;classes&quot;</span><span class="p">,</span>
	<span class="s">&quot;roles&quot;</span><span class="p">,</span>
	<span class="s">&quot;types&quot;</span><span class="p">,</span>
	<span class="s">&quot;users&quot;</span><span class="p">,</span>
	<span class="s">&quot;bools&quot;</span><span class="p">,</span>
	<span class="s">&quot;levels&quot;</span><span class="p">,</span>
	<span class="s">&quot;categories&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">symtab_sizes</span><span class="p">[</span><span class="n">SYM_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">32</span><span class="p">,</span>
	<span class="mi">16</span><span class="p">,</span>
	<span class="mi">512</span><span class="p">,</span>
	<span class="mi">128</span><span class="p">,</span>
	<span class="mi">16</span><span class="p">,</span>
	<span class="mi">16</span><span class="p">,</span>
	<span class="mi">16</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">policydb_compat_info</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">version</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sym_num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ocon_num</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* These need to be updated if SYM_NUM or OCON_NUM changes */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">policydb_compat_info</span> <span class="n">policydb_compat</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">POLICYDB_VERSION_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_num</span>	<span class="o">=</span> <span class="n">SYM_NUM</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ocon_num</span>	<span class="o">=</span> <span class="n">OCON_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">POLICYDB_VERSION_BOOL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_num</span>	<span class="o">=</span> <span class="n">SYM_NUM</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ocon_num</span>	<span class="o">=</span> <span class="n">OCON_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">POLICYDB_VERSION_IPV6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_num</span>	<span class="o">=</span> <span class="n">SYM_NUM</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ocon_num</span>	<span class="o">=</span> <span class="n">OCON_NUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">POLICYDB_VERSION_NLCLASS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_num</span>	<span class="o">=</span> <span class="n">SYM_NUM</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ocon_num</span>	<span class="o">=</span> <span class="n">OCON_NUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">POLICYDB_VERSION_MLS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_num</span>	<span class="o">=</span> <span class="n">SYM_NUM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ocon_num</span>	<span class="o">=</span> <span class="n">OCON_NUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">POLICYDB_VERSION_AVTAB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_num</span>	<span class="o">=</span> <span class="n">SYM_NUM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ocon_num</span>	<span class="o">=</span> <span class="n">OCON_NUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">POLICYDB_VERSION_RANGETRANS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_num</span>	<span class="o">=</span> <span class="n">SYM_NUM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ocon_num</span>	<span class="o">=</span> <span class="n">OCON_NUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">POLICYDB_VERSION_POLCAP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_num</span>	<span class="o">=</span> <span class="n">SYM_NUM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ocon_num</span>	<span class="o">=</span> <span class="n">OCON_NUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">POLICYDB_VERSION_PERMISSIVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_num</span>	<span class="o">=</span> <span class="n">SYM_NUM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ocon_num</span>	<span class="o">=</span> <span class="n">OCON_NUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">POLICYDB_VERSION_BOUNDARY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_num</span>	<span class="o">=</span> <span class="n">SYM_NUM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ocon_num</span>	<span class="o">=</span> <span class="n">OCON_NUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">POLICYDB_VERSION_FILENAME_TRANS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_num</span>	<span class="o">=</span> <span class="n">SYM_NUM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ocon_num</span>	<span class="o">=</span> <span class="n">OCON_NUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">POLICYDB_VERSION_ROLETRANS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_num</span>	<span class="o">=</span> <span class="n">SYM_NUM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ocon_num</span>	<span class="o">=</span> <span class="n">OCON_NUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">POLICYDB_VERSION_NEW_OBJECT_DEFAULTS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_num</span>	<span class="o">=</span> <span class="n">SYM_NUM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ocon_num</span>	<span class="o">=</span> <span class="n">OCON_NUM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">POLICYDB_VERSION_DEFAULT_TYPE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_num</span>	<span class="o">=</span> <span class="n">SYM_NUM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ocon_num</span>	<span class="o">=</span> <span class="n">OCON_NUM</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">policydb_compat_info</span> <span class="o">*</span><span class="nf">policydb_lookup_compat</span><span class="p">(</span><span class="kt">int</span> <span class="n">version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policydb_compat_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">policydb_compat</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">policydb_compat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">version</span> <span class="o">==</span> <span class="n">version</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">policydb_compat</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">info</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the role table.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">roles_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">role_datum</span> <span class="o">*</span><span class="n">role</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">role</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">role</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">role</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">role</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="o">++</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_roles</span><span class="p">.</span><span class="n">nprim</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">role</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">!=</span> <span class="n">OBJECT_R_VAL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">OBJECT_R</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_insert</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_roles</span><span class="p">.</span><span class="n">table</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">role</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">role</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">filenametr_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">filename_trans</span> <span class="o">*</span><span class="n">ft</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hash</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">byte_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">focus</span><span class="p">;</span>

	<span class="n">hash</span> <span class="o">=</span> <span class="n">ft</span><span class="o">-&gt;</span><span class="n">stype</span> <span class="o">^</span> <span class="n">ft</span><span class="o">-&gt;</span><span class="n">ttype</span> <span class="o">^</span> <span class="n">ft</span><span class="o">-&gt;</span><span class="n">tclass</span><span class="p">;</span>

	<span class="n">byte_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">focus</span> <span class="o">=</span> <span class="n">ft</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">byte_num</span><span class="o">++</span><span class="p">]))</span>
		<span class="n">hash</span> <span class="o">=</span> <span class="n">partial_name_hash</span><span class="p">(</span><span class="n">focus</span><span class="p">,</span> <span class="n">hash</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hash</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">filenametr_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">k1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">k2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">filename_trans</span> <span class="o">*</span><span class="n">ft1</span> <span class="o">=</span> <span class="n">k1</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">filename_trans</span> <span class="o">*</span><span class="n">ft2</span> <span class="o">=</span> <span class="n">k2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">ft1</span><span class="o">-&gt;</span><span class="n">stype</span> <span class="o">-</span> <span class="n">ft2</span><span class="o">-&gt;</span><span class="n">stype</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">ft1</span><span class="o">-&gt;</span><span class="n">ttype</span> <span class="o">-</span> <span class="n">ft2</span><span class="o">-&gt;</span><span class="n">ttype</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">ft1</span><span class="o">-&gt;</span><span class="n">tclass</span> <span class="o">-</span> <span class="n">ft2</span><span class="o">-&gt;</span><span class="n">tclass</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">ft1</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ft2</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">rangetr_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">range_trans</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">source_type</span> <span class="o">+</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">target_type</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">target_class</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rangetr_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">k1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">k2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">range_trans</span> <span class="o">*</span><span class="n">key1</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="o">*</span><span class="n">key2</span> <span class="o">=</span> <span class="n">k2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">key1</span><span class="o">-&gt;</span><span class="n">source_type</span> <span class="o">-</span> <span class="n">key2</span><span class="o">-&gt;</span><span class="n">source_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">key1</span><span class="o">-&gt;</span><span class="n">target_type</span> <span class="o">-</span> <span class="n">key2</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">key1</span><span class="o">-&gt;</span><span class="n">target_class</span> <span class="o">-</span> <span class="n">key2</span><span class="o">-&gt;</span><span class="n">target_class</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize a policy database structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">policydb_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SYM_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">symtab_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">symtab_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">avtab_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">te_avtab</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">roles_init</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cond_policydb_init</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">filename_trans</span> <span class="o">=</span> <span class="n">hashtab_create</span><span class="p">(</span><span class="n">filenametr_hash</span><span class="p">,</span> <span class="n">filenametr_cmp</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">filename_trans</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">range_tr</span> <span class="o">=</span> <span class="n">hashtab_create</span><span class="p">(</span><span class="n">rangetr_hash</span><span class="p">,</span> <span class="n">rangetr_cmp</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">range_tr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ebitmap_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">filename_trans_ttypes</span><span class="p">);</span>
	<span class="n">ebitmap_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policycaps</span><span class="p">);</span>
	<span class="n">ebitmap_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">permissive_map</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">hashtab_destroy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">filename_trans</span><span class="p">);</span>
	<span class="n">hashtab_destroy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">range_tr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SYM_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hashtab_destroy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">table</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The following *_index functions are used to</span>
<span class="cm"> * define the val_to_name and val_to_struct arrays</span>
<span class="cm"> * in a policy database structure.  The val_to_name</span>
<span class="cm"> * arrays are used when converting security context</span>
<span class="cm"> * structures into string representations.  The</span>
<span class="cm"> * val_to_struct arrays are used when the attributes</span>
<span class="cm"> * of a class, role, or user are needed.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">common_index</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_datum</span> <span class="o">*</span><span class="n">comdatum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flex_array</span> <span class="o">*</span><span class="n">fa</span><span class="p">;</span>

	<span class="n">comdatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">datap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">comdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">||</span> <span class="n">comdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_commons</span><span class="p">.</span><span class="n">nprim</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fa</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sym_val_to_name</span><span class="p">[</span><span class="n">SYM_COMMONS</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flex_array_put_ptr</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span> <span class="n">comdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
			       <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">class_index</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">class_datum</span> <span class="o">*</span><span class="n">cladatum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flex_array</span> <span class="o">*</span><span class="n">fa</span><span class="p">;</span>

	<span class="n">cladatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">datap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">||</span> <span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_classes</span><span class="p">.</span><span class="n">nprim</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">fa</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sym_val_to_name</span><span class="p">[</span><span class="n">SYM_CLASSES</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flex_array_put_ptr</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span> <span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
			       <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">class_val_to_struct</span><span class="p">[</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cladatum</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">role_index</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">role_datum</span> <span class="o">*</span><span class="n">role</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flex_array</span> <span class="o">*</span><span class="n">fa</span><span class="p">;</span>

	<span class="n">role</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">datap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">role</span><span class="o">-&gt;</span><span class="n">value</span>
	    <span class="o">||</span> <span class="n">role</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_roles</span><span class="p">.</span><span class="n">nprim</span>
	    <span class="o">||</span> <span class="n">role</span><span class="o">-&gt;</span><span class="n">bounds</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_roles</span><span class="p">.</span><span class="n">nprim</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fa</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sym_val_to_name</span><span class="p">[</span><span class="n">SYM_ROLES</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flex_array_put_ptr</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span> <span class="n">role</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
			       <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">role_val_to_struct</span><span class="p">[</span><span class="n">role</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">role</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">type_index</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">type_datum</span> <span class="o">*</span><span class="n">typdatum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flex_array</span> <span class="o">*</span><span class="n">fa</span><span class="p">;</span>

	<span class="n">typdatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">datap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">primary</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">value</span>
		    <span class="o">||</span> <span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_types</span><span class="p">.</span><span class="n">nprim</span>
		    <span class="o">||</span> <span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">bounds</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_types</span><span class="p">.</span><span class="n">nprim</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">fa</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sym_val_to_name</span><span class="p">[</span><span class="n">SYM_TYPES</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flex_array_put_ptr</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span> <span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
				       <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">))</span>
			<span class="n">BUG</span><span class="p">();</span>

		<span class="n">fa</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">type_val_to_struct_array</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flex_array_put_ptr</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span> <span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">typdatum</span><span class="p">,</span>
				       <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">))</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">user_index</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">user_datum</span> <span class="o">*</span><span class="n">usrdatum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flex_array</span> <span class="o">*</span><span class="n">fa</span><span class="p">;</span>

	<span class="n">usrdatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">datap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">value</span>
	    <span class="o">||</span> <span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_users</span><span class="p">.</span><span class="n">nprim</span>
	    <span class="o">||</span> <span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">bounds</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_users</span><span class="p">.</span><span class="n">nprim</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fa</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sym_val_to_name</span><span class="p">[</span><span class="n">SYM_USERS</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flex_array_put_ptr</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span> <span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
			       <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">user_val_to_struct</span><span class="p">[</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">usrdatum</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sens_index</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">level_datum</span> <span class="o">*</span><span class="n">levdatum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flex_array</span> <span class="o">*</span><span class="n">fa</span><span class="p">;</span>

	<span class="n">levdatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">datap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">levdatum</span><span class="o">-&gt;</span><span class="n">isalias</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">levdatum</span><span class="o">-&gt;</span><span class="n">level</span><span class="o">-&gt;</span><span class="n">sens</span> <span class="o">||</span>
		    <span class="n">levdatum</span><span class="o">-&gt;</span><span class="n">level</span><span class="o">-&gt;</span><span class="n">sens</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_levels</span><span class="p">.</span><span class="n">nprim</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">fa</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sym_val_to_name</span><span class="p">[</span><span class="n">SYM_LEVELS</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flex_array_put_ptr</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span> <span class="n">levdatum</span><span class="o">-&gt;</span><span class="n">level</span><span class="o">-&gt;</span><span class="n">sens</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
				       <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">))</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cat_index</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cat_datum</span> <span class="o">*</span><span class="n">catdatum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flex_array</span> <span class="o">*</span><span class="n">fa</span><span class="p">;</span>

	<span class="n">catdatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">datap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">catdatum</span><span class="o">-&gt;</span><span class="n">isalias</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">catdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">||</span> <span class="n">catdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_cats</span><span class="p">.</span><span class="n">nprim</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">fa</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sym_val_to_name</span><span class="p">[</span><span class="n">SYM_CATS</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flex_array_put_ptr</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span> <span class="n">catdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
				       <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">))</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">index_f</span><span class="p">[</span><span class="n">SYM_NUM</span><span class="p">])</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datap</span><span class="p">)</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">common_index</span><span class="p">,</span>
	<span class="n">class_index</span><span class="p">,</span>
	<span class="n">role_index</span><span class="p">,</span>
	<span class="n">type_index</span><span class="p">,</span>
	<span class="n">user_index</span><span class="p">,</span>
	<span class="n">cond_index_bool</span><span class="p">,</span>
	<span class="n">sens_index</span><span class="p">,</span>
	<span class="n">cat_index</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef DEBUG_HASHES</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hash_eval</span><span class="p">(</span><span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hash_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hashtab_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">hashtab_stat</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;SELinux: %s:  %d entries and %d/%d buckets used, &quot;</span>
	       <span class="s">&quot;longest chain length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hash_name</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nel</span><span class="p">,</span>
	       <span class="n">info</span><span class="p">.</span><span class="n">slots_used</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">max_chain_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">symtab_hash_eval</span><span class="p">(</span><span class="k">struct</span> <span class="n">symtab</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SYM_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hash_eval</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">table</span><span class="p">,</span> <span class="n">symtab_name</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hash_eval</span><span class="p">(</span><span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hash_name</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Define the other val_to_name and val_to_struct arrays</span>
<span class="cm"> * in a policy database structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller must clean up on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">policydb_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;SELinux:  %d users, %d roles, %d types, %d bools&quot;</span><span class="p">,</span>
	       <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_users</span><span class="p">.</span><span class="n">nprim</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_roles</span><span class="p">.</span><span class="n">nprim</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_types</span><span class="p">.</span><span class="n">nprim</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_bools</span><span class="p">.</span><span class="n">nprim</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mls_enabled</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, %d sens, %d cats&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_levels</span><span class="p">.</span><span class="n">nprim</span><span class="p">,</span>
		       <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_cats</span><span class="p">.</span><span class="n">nprim</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;SELinux:  %d classes, %d rules</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_classes</span><span class="p">.</span><span class="n">nprim</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">te_avtab</span><span class="p">.</span><span class="n">nel</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG_HASHES</span>
	<span class="n">avtab_hash_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">te_avtab</span><span class="p">,</span> <span class="s">&quot;rules&quot;</span><span class="p">);</span>
	<span class="n">symtab_hash_eval</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">class_val_to_struct</span> <span class="o">=</span>
		<span class="n">kmalloc</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_classes</span><span class="p">.</span><span class="n">nprim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">class_val_to_struct</span><span class="p">)),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">class_val_to_struct</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">role_val_to_struct</span> <span class="o">=</span>
		<span class="n">kmalloc</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_roles</span><span class="p">.</span><span class="n">nprim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">role_val_to_struct</span><span class="p">)),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">role_val_to_struct</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">user_val_to_struct</span> <span class="o">=</span>
		<span class="n">kmalloc</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_users</span><span class="p">.</span><span class="n">nprim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">user_val_to_struct</span><span class="p">)),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">user_val_to_struct</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Yes, I want the sizeof the pointer, not the structure */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">type_val_to_struct_array</span> <span class="o">=</span> <span class="n">flex_array_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">type_datum</span> <span class="o">*</span><span class="p">),</span>
						       <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_types</span><span class="p">.</span><span class="n">nprim</span><span class="p">,</span>
						       <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type_val_to_struct_array</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">flex_array_prealloc</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type_val_to_struct_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_types</span><span class="p">.</span><span class="n">nprim</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cond_init_bool_indexes</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SYM_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">sym_val_to_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">flex_array_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">),</span>
							 <span class="n">p</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nprim</span><span class="p">,</span>
							 <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sym_val_to_name</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">flex_array_prealloc</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sym_val_to_name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					 <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nprim</span><span class="p">,</span>
					 <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_map</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">table</span><span class="p">,</span> <span class="n">index_f</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The following *_destroy functions are used to</span>
<span class="cm"> * free any memory allocated for each kind of</span>
<span class="cm"> * symbol data in the policy database.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perm_destroy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">datum</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">common_destroy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">common_datum</span> <span class="o">*</span><span class="n">comdatum</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comdatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
		<span class="n">hashtab_map</span><span class="p">(</span><span class="n">comdatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="p">,</span> <span class="n">perm_destroy</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">hashtab_destroy</span><span class="p">(</span><span class="n">comdatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">datum</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cls_destroy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">class_datum</span> <span class="o">*</span><span class="n">cladatum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">constraint_node</span> <span class="o">*</span><span class="n">constraint</span><span class="p">,</span> <span class="o">*</span><span class="n">ctemp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">constraint_expr</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">etmp</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cladatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
		<span class="n">hashtab_map</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="p">,</span> <span class="n">perm_destroy</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">hashtab_destroy</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="p">);</span>
		<span class="n">constraint</span> <span class="o">=</span> <span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">constraint</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">-&gt;</span><span class="n">expr</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">names</span><span class="p">);</span>
				<span class="n">etmp</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
				<span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">etmp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ctemp</span> <span class="o">=</span> <span class="n">constraint</span><span class="p">;</span>
			<span class="n">constraint</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ctemp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">constraint</span> <span class="o">=</span> <span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">validatetrans</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">constraint</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">-&gt;</span><span class="n">expr</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">names</span><span class="p">);</span>
				<span class="n">etmp</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
				<span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">etmp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ctemp</span> <span class="o">=</span> <span class="n">constraint</span><span class="p">;</span>
			<span class="n">constraint</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ctemp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">comkey</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">datum</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">role_destroy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">role_datum</span> <span class="o">*</span><span class="n">role</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">role</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
		<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">role</span><span class="o">-&gt;</span><span class="n">dominates</span><span class="p">);</span>
		<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">role</span><span class="o">-&gt;</span><span class="n">types</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">datum</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">type_destroy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">datum</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">user_destroy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">user_datum</span> <span class="o">*</span><span class="n">usrdatum</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usrdatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
		<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">);</span>
		<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">.</span><span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cat</span><span class="p">);</span>
		<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">.</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cat</span><span class="p">);</span>
		<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">dfltlevel</span><span class="p">.</span><span class="n">cat</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">datum</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sens_destroy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">level_datum</span> <span class="o">*</span><span class="n">levdatum</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">levdatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
		<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">levdatum</span><span class="o">-&gt;</span><span class="n">level</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">levdatum</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">datum</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cat_destroy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">datum</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">destroy_f</span><span class="p">[</span><span class="n">SYM_NUM</span><span class="p">])</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datap</span><span class="p">)</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">common_destroy</span><span class="p">,</span>
	<span class="n">cls_destroy</span><span class="p">,</span>
	<span class="n">role_destroy</span><span class="p">,</span>
	<span class="n">type_destroy</span><span class="p">,</span>
	<span class="n">user_destroy</span><span class="p">,</span>
	<span class="n">cond_destroy_bool</span><span class="p">,</span>
	<span class="n">sens_destroy</span><span class="p">,</span>
	<span class="n">cat_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">filenametr_destroy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filename_trans</span> <span class="o">*</span><span class="n">ft</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ft</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">datum</span><span class="p">);</span>
	<span class="n">cond_resched</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">range_tr_destroy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mls_range</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cat</span><span class="p">);</span>
	<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cat</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">datum</span><span class="p">);</span>
	<span class="n">cond_resched</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocontext_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocontext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">context_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">context_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">OCON_ISID</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">OCON_FS</span> <span class="o">||</span>
	    <span class="n">i</span> <span class="o">==</span> <span class="n">OCON_NETIF</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">OCON_FSUSE</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free any memory allocated by a policy database structure.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">policydb_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocontext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">ctmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">genfs</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="o">*</span><span class="n">gtmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">role_allow</span> <span class="o">*</span><span class="n">ra</span><span class="p">,</span> <span class="o">*</span><span class="n">lra</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">role_trans</span> <span class="o">*</span><span class="n">tr</span><span class="p">,</span> <span class="o">*</span><span class="n">ltr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SYM_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cond_resched</span><span class="p">();</span>
		<span class="n">hashtab_map</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">table</span><span class="p">,</span> <span class="n">destroy_f</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">hashtab_destroy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">table</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SYM_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sym_val_to_name</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">flex_array_free</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sym_val_to_name</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">class_val_to_struct</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">role_val_to_struct</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">user_val_to_struct</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type_val_to_struct_array</span><span class="p">)</span>
		<span class="n">flex_array_free</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type_val_to_struct_array</span><span class="p">);</span>

	<span class="n">avtab_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">te_avtab</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OCON_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cond_resched</span><span class="p">();</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ocontexts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctmp</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">ocontext_destroy</span><span class="p">(</span><span class="n">ctmp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">ocontexts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">g</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">genfs</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cond_resched</span><span class="p">();</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">fstype</span><span class="p">);</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctmp</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">ocontext_destroy</span><span class="p">(</span><span class="n">ctmp</span><span class="p">,</span> <span class="n">OCON_FSUSE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">gtmp</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
		<span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">gtmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">genfs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cond_policydb_destroy</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">role_tr</span><span class="p">;</span> <span class="n">tr</span><span class="p">;</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cond_resched</span><span class="p">();</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ltr</span><span class="p">);</span>
		<span class="n">ltr</span> <span class="o">=</span> <span class="n">tr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ltr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ra</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">role_allow</span><span class="p">;</span> <span class="n">ra</span><span class="p">;</span> <span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cond_resched</span><span class="p">();</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">lra</span><span class="p">);</span>
		<span class="n">lra</span> <span class="o">=</span> <span class="n">ra</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lra</span><span class="p">);</span>

	<span class="n">hashtab_map</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">filename_trans</span><span class="p">,</span> <span class="n">filenametr_destroy</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">hashtab_destroy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">filename_trans</span><span class="p">);</span>

	<span class="n">hashtab_map</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">range_tr</span><span class="p">,</span> <span class="n">range_tr_destroy</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">hashtab_destroy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">range_tr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type_attr_map_array</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_types</span><span class="p">.</span><span class="n">nprim</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ebitmap</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

			<span class="n">e</span> <span class="o">=</span> <span class="n">flex_array_get</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type_attr_map_array</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">flex_array_free</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type_attr_map_array</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">filename_trans_ttypes</span><span class="p">);</span>
	<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policycaps</span><span class="p">);</span>
	<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">permissive_map</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Load the initial SIDs specified in a policy database</span>
<span class="cm"> * structure into a SID table.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">policydb_load_isids</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sidtab</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocontext</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sidtab_init</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  out of memory on SID table init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ocontexts</span><span class="p">[</span><span class="n">OCON_ISID</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span> <span class="n">c</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  SID %s was never defined.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">sidtab_insert</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  unable to load initial SID %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">policydb_class_isvalid</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">class</span> <span class="o">||</span> <span class="n">class</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_classes</span><span class="p">.</span><span class="n">nprim</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">policydb_role_isvalid</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">role</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">role</span> <span class="o">||</span> <span class="n">role</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_roles</span><span class="p">.</span><span class="n">nprim</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">policydb_type_isvalid</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type</span> <span class="o">||</span> <span class="n">type</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_types</span><span class="p">.</span><span class="n">nprim</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return 1 if the fields in the security context</span>
<span class="cm"> * structure `c&#39; are valid.  Return 0 otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">policydb_context_isvalid</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">context</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">role_datum</span> <span class="o">*</span><span class="n">role</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">user_datum</span> <span class="o">*</span><span class="n">usrdatum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_roles</span><span class="p">.</span><span class="n">nprim</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">user</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">user</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_users</span><span class="p">.</span><span class="n">nprim</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_types</span><span class="p">.</span><span class="n">nprim</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">!=</span> <span class="n">OBJECT_R_VAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Role must be authorized for the type.</span>
<span class="cm">		 */</span>
		<span class="n">role</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">role_val_to_struct</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ebitmap_get_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">role</span><span class="o">-&gt;</span><span class="n">types</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="cm">/* role may not be associated with type */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * User must be authorized for the role.</span>
<span class="cm">		 */</span>
		<span class="n">usrdatum</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">user_val_to_struct</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">user</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usrdatum</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ebitmap_get_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="cm">/* user may not be associated with role */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mls_context_isvalid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read a MLS range structure from a policydb binary</span>
<span class="cm"> * representation file.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mls_read_range_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">mls_range</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">items</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">items</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: mls:  range overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">items</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: mls:  truncated range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sens</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sens</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sens</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sens</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cat</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: mls:  error reading low categories</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cat</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: mls:  error reading high categories</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad_high</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_cpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: mls:  out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad_high</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad_high:</span>
	<span class="n">ebitmap_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cat</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read and validate a security context structure</span>
<span class="cm"> * from a policydb binary representation file.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">context_read_and_validate</span><span class="p">(</span><span class="k">struct</span> <span class="n">context</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: context truncated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">user</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_MLS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mls_read_range_helper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: error reading MLS range of context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policydb_context_isvalid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  invalid security context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">context_destroy</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The following *_read functions are used to</span>
<span class="cm"> * read the symbol data from a policy database</span>
<span class="cm"> * binary representation file.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perm_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perm_datum</span> <span class="o">*</span><span class="n">perdatum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">perdatum</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">perdatum</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perdatum</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">perdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">key</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_insert</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">perdatum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="n">perm_destroy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">perdatum</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">common_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_datum</span> <span class="o">*</span><span class="n">comdatum</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">nel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">comdatum</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">comdatum</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">comdatum</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">comdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">symtab_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comdatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">,</span> <span class="n">PERM_SYMTAB_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">comdatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">nprim</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">nel</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">key</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nel</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">perm_read</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">comdatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_insert</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">comdatum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="n">common_destroy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">comdatum</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_cons_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">constraint_node</span> <span class="o">**</span><span class="n">nodep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ncons</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">allowxtarget</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">constraint_node</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">lc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">constraint_expr</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">le</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">nexpr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">depth</span><span class="p">;</span>

	<span class="n">lc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ncons</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lc</span><span class="p">)</span>
			<span class="n">lc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">nodep</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">permissions</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">nexpr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">le</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nexpr</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">le</span><span class="p">)</span>
				<span class="n">le</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">expr</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">expr_type</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">attr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">expr_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">CEXPR_NOT</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CEXPR_AND</span>:
			<span class="k">case</span> <span class="n">CEXPR_OR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="n">depth</span><span class="o">--</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CEXPR_ATTR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="p">(</span><span class="n">CEXPR_MAXDEPTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="n">depth</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CEXPR_NAMES</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">allowxtarget</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="n">CEXPR_XTARGET</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="p">(</span><span class="n">CEXPR_MAXDEPTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="n">depth</span><span class="o">++</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">names</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">le</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">lc</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">class_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">class_datum</span> <span class="o">*</span><span class="n">cladatum</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">len2</span><span class="p">,</span> <span class="n">ncons</span><span class="p">,</span> <span class="n">nel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cladatum</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cladatum</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cladatum</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">len2</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">symtab_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">,</span> <span class="n">PERM_SYMTAB_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">nprim</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">nel</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

	<span class="n">ncons</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">key</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">comkey</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">comkey</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">comkey</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">comkey</span><span class="p">[</span><span class="n">len2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">comdatum</span> <span class="o">=</span> <span class="n">hashtab_search</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_commons</span><span class="p">.</span><span class="n">table</span><span class="p">,</span> <span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">comkey</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">comdatum</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  unknown common %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">comkey</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nel</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">perm_read</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">read_cons_helper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">,</span> <span class="n">ncons</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_VALIDATETRANS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* grab the validatetrans rules */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">ncons</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">read_cons_helper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">validatetrans</span><span class="p">,</span> <span class="n">ncons</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_NEW_OBJECT_DEFAULTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

		<span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">default_user</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">default_role</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">default_range</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_DEFAULT_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">default_type</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_insert</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">cladatum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="n">cls_destroy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cladatum</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">role_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">role_datum</span> <span class="o">*</span><span class="n">role</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">to_read</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">role</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">role</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">role</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_BOUNDARY</span><span class="p">)</span>
		<span class="n">to_read</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">to_read</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">role</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_BOUNDARY</span><span class="p">)</span>
		<span class="n">role</span><span class="o">-&gt;</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">key</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">role</span><span class="o">-&gt;</span><span class="n">dominates</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">role</span><span class="o">-&gt;</span><span class="n">types</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">OBJECT_R</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">role</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">!=</span> <span class="n">OBJECT_R_VAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: Role %s has wrong value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">OBJECT_R</span><span class="p">,</span> <span class="n">role</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_insert</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">role</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="n">role_destroy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">type_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">type_datum</span> <span class="o">*</span><span class="n">typdatum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">to_read</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">typdatum</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">typdatum</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">typdatum</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_BOUNDARY</span><span class="p">)</span>
		<span class="n">to_read</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">to_read</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_BOUNDARY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">prop</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prop</span> <span class="o">&amp;</span> <span class="n">TYPEDATUM_PROPERTY_PRIMARY</span><span class="p">)</span>
			<span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">primary</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prop</span> <span class="o">&amp;</span> <span class="n">TYPEDATUM_PROPERTY_ATTRIBUTE</span><span class="p">)</span>
			<span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">attribute</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">primary</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">key</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_insert</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">typdatum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="n">type_destroy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">typdatum</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Read a MLS level structure from a policydb binary</span>
<span class="cm"> * representation file.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mls_read_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">mls_level</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: mls: truncated level</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">sens</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: mls:  error reading level categories</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">user_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">user_datum</span> <span class="o">*</span><span class="n">usrdatum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">to_read</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">usrdatum</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">usrdatum</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usrdatum</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_BOUNDARY</span><span class="p">)</span>
		<span class="n">to_read</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">to_read</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_BOUNDARY</span><span class="p">)</span>
		<span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">key</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_MLS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mls_read_range_helper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mls_read_level</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">dfltlevel</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_insert</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">usrdatum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="n">user_destroy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">usrdatum</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sens_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">level_datum</span> <span class="o">*</span><span class="n">levdatum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">levdatum</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">levdatum</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">levdatum</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">levdatum</span><span class="o">-&gt;</span><span class="n">isalias</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">key</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">levdatum</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mls_level</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">levdatum</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mls_read_level</span><span class="p">(</span><span class="n">levdatum</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_insert</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">levdatum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="n">sens_destroy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">levdatum</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cat_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cat_datum</span> <span class="o">*</span><span class="n">catdatum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">catdatum</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">catdatum</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">catdatum</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">catdatum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">catdatum</span><span class="o">-&gt;</span><span class="n">isalias</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">key</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_insert</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">catdatum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="n">cat_destroy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">catdatum</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read_f</span><span class="p">[</span><span class="n">SYM_NUM</span><span class="p">])</span> <span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hashtab</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">common_read</span><span class="p">,</span>
	<span class="n">class_read</span><span class="p">,</span>
	<span class="n">role_read</span><span class="p">,</span>
	<span class="n">type_read</span><span class="p">,</span>
	<span class="n">user_read</span><span class="p">,</span>
	<span class="n">cond_read_bool</span><span class="p">,</span>
	<span class="n">sens_read</span><span class="p">,</span>
	<span class="n">cat_read</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">user_bounds_sanity_check</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">user_datum</span> <span class="o">*</span><span class="n">upper</span><span class="p">,</span> <span class="o">*</span><span class="n">user</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">datap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">upper</span> <span class="o">=</span> <span class="n">user</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">upper</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ebitmap_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">depth</span> <span class="o">==</span> <span class="n">POLICYDB_BOUNDS_MAXDEPTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: user %s: &quot;</span>
			       <span class="s">&quot;too deep or looped boundary&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">upper</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">user_val_to_struct</span><span class="p">[</span><span class="n">upper</span><span class="o">-&gt;</span><span class="n">bounds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">ebitmap_for_each_positive_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ebitmap_get_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">upper</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">,</span> <span class="n">bit</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;SELinux: boundary violated policy: &quot;</span>
			       <span class="s">&quot;user=%s role=%s bounds=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">sym_name</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SYM_USERS</span><span class="p">,</span> <span class="n">user</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
			       <span class="n">sym_name</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SYM_ROLES</span><span class="p">,</span> <span class="n">bit</span><span class="p">),</span>
			       <span class="n">sym_name</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SYM_USERS</span><span class="p">,</span> <span class="n">upper</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">role_bounds_sanity_check</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">role_datum</span> <span class="o">*</span><span class="n">upper</span><span class="p">,</span> <span class="o">*</span><span class="n">role</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">datap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">upper</span> <span class="o">=</span> <span class="n">role</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">upper</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ebitmap_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">depth</span> <span class="o">==</span> <span class="n">POLICYDB_BOUNDS_MAXDEPTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: role %s: &quot;</span>
			       <span class="s">&quot;too deep or looped bounds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">upper</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">role_val_to_struct</span><span class="p">[</span><span class="n">upper</span><span class="o">-&gt;</span><span class="n">bounds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">ebitmap_for_each_positive_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">role</span><span class="o">-&gt;</span><span class="n">types</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ebitmap_get_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">upper</span><span class="o">-&gt;</span><span class="n">types</span><span class="p">,</span> <span class="n">bit</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;SELinux: boundary violated policy: &quot;</span>
			       <span class="s">&quot;role=%s type=%s bounds=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">sym_name</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SYM_ROLES</span><span class="p">,</span> <span class="n">role</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
			       <span class="n">sym_name</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SYM_TYPES</span><span class="p">,</span> <span class="n">bit</span><span class="p">),</span>
			       <span class="n">sym_name</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SYM_ROLES</span><span class="p">,</span> <span class="n">upper</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">type_bounds_sanity_check</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">type_datum</span> <span class="o">*</span><span class="n">upper</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">datap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">upper</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">upper</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">depth</span> <span class="o">==</span> <span class="n">POLICYDB_BOUNDS_MAXDEPTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: type %s: &quot;</span>
			       <span class="s">&quot;too deep or looped boundary</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">upper</span> <span class="o">=</span> <span class="n">flex_array_get_ptr</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type_val_to_struct_array</span><span class="p">,</span>
					   <span class="n">upper</span><span class="o">-&gt;</span><span class="n">bounds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">upper</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">upper</span><span class="o">-&gt;</span><span class="n">attribute</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: type %s: &quot;</span>
			       <span class="s">&quot;bounded by attribute %s&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span>
			       <span class="n">sym_name</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SYM_TYPES</span><span class="p">,</span> <span class="n">upper</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">policydb_bounds_sanity_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&lt;</span> <span class="n">POLICYDB_VERSION_BOUNDARY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_map</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_users</span><span class="p">.</span><span class="n">table</span><span class="p">,</span>
			 <span class="n">user_bounds_sanity_check</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_map</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_roles</span><span class="p">.</span><span class="n">table</span><span class="p">,</span>
			 <span class="n">role_bounds_sanity_check</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_map</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_types</span><span class="p">.</span><span class="n">table</span><span class="p">,</span>
			 <span class="n">type_bounds_sanity_check</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">string_to_security_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">class_datum</span> <span class="o">*</span><span class="n">cladatum</span><span class="p">;</span>

	<span class="n">cladatum</span> <span class="o">=</span> <span class="n">hashtab_search</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_classes</span><span class="p">.</span><span class="n">table</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cladatum</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">string_to_av_perm</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tclass</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">class_datum</span> <span class="o">*</span><span class="n">cladatum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perm_datum</span> <span class="o">*</span><span class="n">perdatum</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_datum</span> <span class="o">*</span><span class="n">comdatum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tclass</span> <span class="o">||</span> <span class="n">tclass</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_classes</span><span class="p">.</span><span class="n">nprim</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cladatum</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">class_val_to_struct</span><span class="p">[</span><span class="n">tclass</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">comdatum</span> <span class="o">=</span> <span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">comdatum</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">comdatum</span><span class="p">)</span>
		<span class="n">perdatum</span> <span class="o">=</span> <span class="n">hashtab_search</span><span class="p">(</span><span class="n">comdatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="p">,</span>
					  <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perdatum</span><span class="p">)</span>
		<span class="n">perdatum</span> <span class="o">=</span> <span class="n">hashtab_search</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="p">,</span>
					  <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perdatum</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">perdatum</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">range_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">range_trans</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mls_range</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">nel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&lt;</span> <span class="n">POLICYDB_VERSION_MLS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">nel</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nel</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">rt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rt</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">source_type</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">target_type</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_RANGETRANS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">rt</span><span class="o">-&gt;</span><span class="n">target_class</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rt</span><span class="o">-&gt;</span><span class="n">target_class</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">process_class</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policydb_type_isvalid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">source_type</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">policydb_type_isvalid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">policydb_class_isvalid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">target_class</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">mls_read_range_helper</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mls_range_isvalid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;SELinux:  rangetrans:  invalid range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_insert</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">range_tr</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hash_eval</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">range_tr</span><span class="p">,</span> <span class="s">&quot;rangetr&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">filename_trans_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filename_trans</span> <span class="o">*</span><span class="n">ft</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filename_trans_datum</span> <span class="o">*</span><span class="n">otype</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nel</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&lt;</span> <span class="n">POLICYDB_VERSION_FILENAME_TRANS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">nel</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nel</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ft</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">otype</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">ft</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ft</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ft</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">otype</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">otype</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otype</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* length of the path component string */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">ft</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

		<span class="cm">/* path component string */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">ft</span><span class="o">-&gt;</span><span class="n">stype</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ft</span><span class="o">-&gt;</span><span class="n">ttype</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ft</span><span class="o">-&gt;</span><span class="n">tclass</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

		<span class="n">otype</span><span class="o">-&gt;</span><span class="n">otype</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_set_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">filename_trans_ttypes</span><span class="p">,</span> <span class="n">ft</span><span class="o">-&gt;</span><span class="n">ttype</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">hashtab_insert</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">filename_trans</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">otype</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hash_eval</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">filename_trans</span><span class="p">,</span> <span class="s">&quot;filenametr&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ft</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">otype</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genfs_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nel</span><span class="p">,</span> <span class="n">nel2</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">len2</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ocontext</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocontext</span> <span class="o">*</span><span class="n">newc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">genfs</span> <span class="o">*</span><span class="n">genfs_p</span><span class="p">,</span> <span class="o">*</span><span class="n">genfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">genfs</span> <span class="o">*</span><span class="n">newgenfs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">nel</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nel</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">newgenfs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">newgenfs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newgenfs</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">newgenfs</span><span class="o">-&gt;</span><span class="n">fstype</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newgenfs</span><span class="o">-&gt;</span><span class="n">fstype</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">newgenfs</span><span class="o">-&gt;</span><span class="n">fstype</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">newgenfs</span><span class="o">-&gt;</span><span class="n">fstype</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">genfs_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">genfs</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">genfs</span><span class="p">;</span> <span class="n">genfs</span><span class="p">;</span>
		     <span class="n">genfs_p</span> <span class="o">=</span> <span class="n">genfs</span><span class="p">,</span> <span class="n">genfs</span> <span class="o">=</span> <span class="n">genfs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">newgenfs</span><span class="o">-&gt;</span><span class="n">fstype</span><span class="p">,</span> <span class="n">genfs</span><span class="o">-&gt;</span><span class="n">fstype</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  dup genfs fstype %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">newgenfs</span><span class="o">-&gt;</span><span class="n">fstype</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">newgenfs</span><span class="o">-&gt;</span><span class="n">fstype</span><span class="p">,</span> <span class="n">genfs</span><span class="o">-&gt;</span><span class="n">fstype</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">newgenfs</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">genfs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">genfs_p</span><span class="p">)</span>
			<span class="n">genfs_p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">newgenfs</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">genfs</span> <span class="o">=</span> <span class="n">newgenfs</span><span class="p">;</span>
		<span class="n">genfs</span> <span class="o">=</span> <span class="n">newgenfs</span><span class="p">;</span>
		<span class="n">newgenfs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">nel2</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nel2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">newc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">newc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">newc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">newc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">newc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">newc</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sclass</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">context_read_and_validate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newc</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">genfs</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span> <span class="n">c</span><span class="p">;</span>
			     <span class="n">l</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">newc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sclass</span> <span class="o">||</span> <span class="o">!</span><span class="n">newc</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sclass</span> <span class="o">||</span>
				     <span class="n">newc</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sclass</span> <span class="o">==</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sclass</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  dup genfs entry (%s,%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">genfs</span><span class="o">-&gt;</span><span class="n">fstype</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">newc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
				<span class="n">len2</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">len2</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">newc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span>
				<span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">newc</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">genfs</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">newc</span><span class="p">;</span>
			<span class="n">newc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newgenfs</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">newgenfs</span><span class="o">-&gt;</span><span class="n">fstype</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">newgenfs</span><span class="p">);</span>
	<span class="n">ocontext_destroy</span><span class="p">(</span><span class="n">newc</span><span class="p">,</span> <span class="n">OCON_FSUSE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocontext_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">policydb_compat_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nel</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ocontext</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nodebuf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ocon_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">nel</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">l</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nel</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span>
				<span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">ocontexts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">OCON_ISID</span>:
				<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

				<span class="n">c</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">context_read_and_validate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OCON_FS</span>:
			<span class="k">case</span> <span class="n">OCON_NETIF</span>:
				<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

				<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

				<span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">context_read_and_validate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">context_read_and_validate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OCON_PORT</span>:
				<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">low_port</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">high_port</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">context_read_and_validate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OCON_NODE</span>:
				<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">nodebuf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">nodebuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* network order */</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">nodebuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cm">/* network order */</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">context_read_and_validate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OCON_FSUSE</span>:
				<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">behavior</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">behavior</span> <span class="o">&gt;</span> <span class="n">SECURITY_FS_USE_NONE</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

				<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">context_read_and_validate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OCON_NODE6</span>: <span class="p">{</span>
				<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

				<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">nodebuf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">node6</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodebuf</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">node6</span><span class="p">.</span><span class="n">mask</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodebuf</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">4</span><span class="p">];</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">context_read_and_validate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the configuration data from a policy database binary</span>
<span class="cm"> * representation file into a policy database structure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">policydb_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">role_allow</span> <span class="o">*</span><span class="n">ra</span><span class="p">,</span> <span class="o">*</span><span class="n">lra</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">role_trans</span> <span class="o">*</span><span class="n">tr</span><span class="p">,</span> <span class="o">*</span><span class="n">ltr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">nprim</span><span class="p">,</span> <span class="n">nel</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">policydb_str</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policydb_compat_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">policydb_init</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Read the magic number and string length. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">POLICYDB_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  policydb magic number 0x%x does &quot;</span>
		       <span class="s">&quot;not match expected magic number 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">POLICYDB_MAGIC</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">POLICYDB_STRING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  policydb string length %d does not &quot;</span>
		       <span class="s">&quot;match expected length %Zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">len</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">POLICYDB_STRING</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">policydb_str</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policydb_str</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  unable to allocate memory for policydb &quot;</span>
		       <span class="s">&quot;string of length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">policydb_str</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  truncated policydb string identifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">policydb_str</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">policydb_str</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">policydb_str</span><span class="p">,</span> <span class="n">POLICYDB_STRING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  policydb string %s does not match &quot;</span>
		       <span class="s">&quot;my string %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">policydb_str</span><span class="p">,</span> <span class="n">POLICYDB_STRING</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">policydb_str</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Done with policydb_str. */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">policydb_str</span><span class="p">);</span>
	<span class="n">policydb_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Read the version and table sizes. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&lt;</span> <span class="n">POLICYDB_VERSION_MIN</span> <span class="o">||</span>
	    <span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;</span> <span class="n">POLICYDB_VERSION_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  policydb version %d does not match &quot;</span>
		       <span class="s">&quot;my version range %d-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">POLICYDB_VERSION_MIN</span><span class="p">,</span> <span class="n">POLICYDB_VERSION_MAX</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">POLICYDB_CONFIG_MLS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">mls_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&lt;</span> <span class="n">POLICYDB_VERSION_MLS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: security policydb version %d &quot;</span>
				<span class="s">&quot;(MLS) not backwards compatible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">reject_unknown</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">REJECT_UNKNOWN</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">allow_unknown</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">ALLOW_UNKNOWN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_POLCAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policycaps</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_PERMISSIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">permissive_map</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">policydb_lookup_compat</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  unable to find policy compat info &quot;</span>
		       <span class="s">&quot;for version %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sym_num</span> <span class="o">||</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ocon_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux:  policydb table sizes (%d,%d) do &quot;</span>
		       <span class="s">&quot;not match mine (%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">sym_num</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ocon_num</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sym_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">nprim</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">nel</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nel</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">read_f</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">table</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nprim</span> <span class="o">=</span> <span class="n">nprim</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">process_class</span> <span class="o">=</span> <span class="n">string_to_security_class</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;process&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">process_class</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">avtab_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">te_avtab</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_BOOL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cond_read_list</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">nel</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">ltr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nel</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">tr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ltr</span><span class="p">)</span>
			<span class="n">ltr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tr</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">role_tr</span> <span class="o">=</span> <span class="n">tr</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">tr</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">tr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">tr</span><span class="o">-&gt;</span><span class="n">new_role</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_ROLETRANS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
			<span class="n">tr</span><span class="o">-&gt;</span><span class="n">tclass</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">tr</span><span class="o">-&gt;</span><span class="n">tclass</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">process_class</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policydb_role_isvalid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">policydb_type_isvalid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">policydb_class_isvalid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">tclass</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">policydb_role_isvalid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">new_role</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">ltr</span> <span class="o">=</span> <span class="n">tr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">nel</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">lra</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nel</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">ra</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ra</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ra</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lra</span><span class="p">)</span>
			<span class="n">lra</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ra</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">role_allow</span> <span class="o">=</span> <span class="n">ra</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">next_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">ra</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ra</span><span class="o">-&gt;</span><span class="n">new_role</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policydb_role_isvalid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ra</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">policydb_role_isvalid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ra</span><span class="o">-&gt;</span><span class="n">new_role</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">lra</span> <span class="o">=</span> <span class="n">ra</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">filename_trans_read</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">policydb_index</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">process_trans_perms</span> <span class="o">=</span> <span class="n">string_to_av_perm</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">process_class</span><span class="p">,</span> <span class="s">&quot;transition&quot;</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">process_trans_perms</span> <span class="o">|=</span> <span class="n">string_to_av_perm</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">process_class</span><span class="p">,</span> <span class="s">&quot;dyntransition&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">process_trans_perms</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ocontext_read</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">genfs_read</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">range_read</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">type_attr_map_array</span> <span class="o">=</span> <span class="n">flex_array_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ebitmap</span><span class="p">),</span>
						  <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_types</span><span class="p">.</span><span class="n">nprim</span><span class="p">,</span>
						  <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type_attr_map_array</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="cm">/* preallocate so we don&#39;t have to worry about the put ever failing */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">flex_array_prealloc</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type_attr_map_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_types</span><span class="p">.</span><span class="n">nprim</span><span class="p">,</span>
				 <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_types</span><span class="p">.</span><span class="n">nprim</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ebitmap</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">flex_array_get</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type_attr_map_array</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">);</span>
		<span class="n">ebitmap_init</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_AVTAB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_read</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* add the type itself as the degenerate case */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_set_bit</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">policydb_bounds_sanity_check</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="n">policydb_destroy</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write a MLS level structure to a policydb binary</span>
<span class="cm"> * representation file.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mls_write_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">mls_level</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write a MLS range structure to a policydb binary</span>
<span class="cm"> * representation file.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mls_write_range_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">mls_range</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">items</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">eq</span><span class="p">;</span>

	<span class="n">eq</span> <span class="o">=</span> <span class="n">mls_level_eq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eq</span><span class="p">)</span>
		<span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">items</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sens</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eq</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sens</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">items</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">items</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cat</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cat</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sens_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vkey</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">vkey</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">level_datum</span> <span class="o">*</span><span class="n">levdatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policy_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">levdatum</span><span class="o">-&gt;</span><span class="n">isalias</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mls_write_level</span><span class="p">(</span><span class="n">levdatum</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cat_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vkey</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">vkey</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cat_datum</span> <span class="o">*</span><span class="n">catdatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policy_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">catdatum</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">catdatum</span><span class="o">-&gt;</span><span class="n">isalias</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">role_trans_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">role_trans</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">role_tr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">role_trans</span> <span class="o">*</span><span class="n">tr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">nel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">nel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tr</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span> <span class="n">tr</span><span class="p">;</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">nel</span><span class="o">++</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nel</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tr</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span> <span class="n">tr</span><span class="p">;</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">new_role</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_ROLETRANS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">tclass</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">role_allow_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">role_allow</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">role_allow</span> <span class="o">*</span><span class="n">ra</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">nel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">nel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ra</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span> <span class="n">ra</span><span class="p">;</span> <span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">nel</span><span class="o">++</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nel</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ra</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span> <span class="n">ra</span><span class="p">;</span> <span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ra</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ra</span><span class="o">-&gt;</span><span class="n">new_role</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write a security context structure</span>
<span class="cm"> * to a policydb binary representation file.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">context_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">context</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mls_write_range_helper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The following *_write functions are used to</span>
<span class="cm"> * write the symbol data to a policy database</span>
<span class="cm"> * binary representation file.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perm_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vkey</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">vkey</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perm_datum</span> <span class="o">*</span><span class="n">perdatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">perdatum</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">common_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vkey</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">vkey</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_datum</span> <span class="o">*</span><span class="n">comdatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policy_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">comdatum</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">comdatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">nprim</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">comdatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">nel</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_map</span><span class="p">(</span><span class="n">comdatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="p">,</span> <span class="n">perm_write</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_cons_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">constraint_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">constraint_node</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">constraint_expr</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">nel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span> <span class="n">c</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">expr</span><span class="p">;</span> <span class="n">e</span><span class="p">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="n">nel</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nel</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">expr</span><span class="p">;</span> <span class="n">e</span><span class="p">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">expr_type</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">expr_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">CEXPR_NAMES</span>:
				<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">names</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">class_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vkey</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">vkey</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">class_datum</span> <span class="o">*</span><span class="n">cladatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policy_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">constraint_node</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">ncons</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">len2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">comkey</span><span class="p">)</span>
		<span class="n">len2</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">comkey</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ncons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">;</span> <span class="n">c</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">ncons</span><span class="o">++</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len2</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">nprim</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">nel</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ncons</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">6</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">comkey</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">comkey</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len2</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_map</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="p">,</span> <span class="n">perm_write</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">write_cons_helper</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* write out the validatetrans rule */</span>
	<span class="n">ncons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">validatetrans</span><span class="p">;</span> <span class="n">c</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">ncons</span><span class="o">++</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ncons</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">write_cons_helper</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">validatetrans</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_NEW_OBJECT_DEFAULTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">default_user</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">default_role</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">default_range</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_DEFAULT_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cladatum</span><span class="o">-&gt;</span><span class="n">default_type</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">role_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vkey</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">vkey</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">role_datum</span> <span class="o">*</span><span class="n">role</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policy_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">items</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">items</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">items</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">items</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">role</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_BOUNDARY</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">items</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">role</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">items</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">items</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">role</span><span class="o">-&gt;</span><span class="n">dominates</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">role</span><span class="o">-&gt;</span><span class="n">types</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">type_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vkey</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">vkey</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">type_datum</span> <span class="o">*</span><span class="n">typdatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policy_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">items</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">items</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">items</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">items</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_BOUNDARY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">properties</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">primary</span><span class="p">)</span>
			<span class="n">properties</span> <span class="o">|=</span> <span class="n">TYPEDATUM_PROPERTY_PRIMARY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">attribute</span><span class="p">)</span>
			<span class="n">properties</span> <span class="o">|=</span> <span class="n">TYPEDATUM_PROPERTY_ATTRIBUTE</span><span class="p">;</span>

		<span class="n">buf</span><span class="p">[</span><span class="n">items</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">properties</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">items</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">items</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">typdatum</span><span class="o">-&gt;</span><span class="n">primary</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">items</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">items</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">user_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vkey</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">vkey</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">user_datum</span> <span class="o">*</span><span class="n">usrdatum</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policy_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">items</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">items</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">items</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">items</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_BOUNDARY</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">items</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">items</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">items</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mls_write_range_helper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mls_write_level</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usrdatum</span><span class="o">-&gt;</span><span class="n">dfltlevel</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">write_f</span><span class="p">[</span><span class="n">SYM_NUM</span><span class="p">])</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">datum</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">datap</span><span class="p">)</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">common_write</span><span class="p">,</span>
	<span class="n">class_write</span><span class="p">,</span>
	<span class="n">role_write</span><span class="p">,</span>
	<span class="n">type_write</span><span class="p">,</span>
	<span class="n">user_write</span><span class="p">,</span>
	<span class="n">cond_write_bool</span><span class="p">,</span>
	<span class="n">sens_write</span><span class="p">,</span>
	<span class="n">cat_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocontext_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">policydb_compat_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">nel</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">nodebuf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ocontext</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ocon_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ocontexts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">c</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="n">nel</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nel</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ocontexts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">c</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">OCON_ISID</span>:
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">context_write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OCON_FS</span>:
			<span class="k">case</span> <span class="n">OCON_NETIF</span>:
				<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">context_write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">context_write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OCON_PORT</span>:
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">protocol</span><span class="p">);</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">low_port</span><span class="p">);</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">high_port</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">context_write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OCON_NODE</span>:
				<span class="n">nodebuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span> <span class="cm">/* network order */</span>
				<span class="n">nodebuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">mask</span><span class="p">;</span> <span class="cm">/* network order */</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">nodebuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">context_write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OCON_FSUSE</span>:
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">behavior</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">context_write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OCON_NODE6</span>:
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="n">nodebuf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">node6</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="cm">/* network order */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="n">nodebuf</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">node6</span><span class="p">.</span><span class="n">mask</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="cm">/* network order */</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">nodebuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">8</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">context_write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genfs_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">genfs</span> <span class="o">*</span><span class="n">genfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocontext</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">genfs</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">genfs</span><span class="p">;</span> <span class="n">genfs</span><span class="p">;</span> <span class="n">genfs</span> <span class="o">=</span> <span class="n">genfs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">len</span><span class="o">++</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">genfs</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">genfs</span><span class="p">;</span> <span class="n">genfs</span><span class="p">;</span> <span class="n">genfs</span> <span class="o">=</span> <span class="n">genfs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">genfs</span><span class="o">-&gt;</span><span class="n">fstype</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">genfs</span><span class="o">-&gt;</span><span class="n">fstype</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">genfs</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span> <span class="n">c</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">genfs</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span> <span class="n">c</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sclass</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">context_write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hashtab_cnt</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cnt</span> <span class="o">=</span> <span class="o">*</span><span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">range_write_helper</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">range_trans</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mls_range</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policy_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">source_type</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_RANGETRANS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">target_class</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mls_write_range_helper</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">range_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">nel</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policy_data</span> <span class="n">pd</span><span class="p">;</span>

	<span class="n">pd</span><span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">pd</span><span class="p">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>

	<span class="cm">/* count the number of entries in the hashtab */</span>
	<span class="n">nel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_map</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">range_tr</span><span class="p">,</span> <span class="n">hashtab_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nel</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* actually write all of the entries */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_map</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">range_tr</span><span class="p">,</span> <span class="n">range_write_helper</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">filename_write_helper</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">filename_trans</span> <span class="o">*</span><span class="n">ft</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filename_trans_datum</span> <span class="o">*</span><span class="n">otype</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ft</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">ft</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ft</span><span class="o">-&gt;</span><span class="n">stype</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ft</span><span class="o">-&gt;</span><span class="n">ttype</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ft</span><span class="o">-&gt;</span><span class="n">tclass</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">otype</span><span class="o">-&gt;</span><span class="n">otype</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">filename_trans_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nel</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&lt;</span> <span class="n">POLICYDB_VERSION_FILENAME_TRANS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_map</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">filename_trans</span><span class="p">,</span> <span class="n">hashtab_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nel</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_map</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">filename_trans</span><span class="p">,</span> <span class="n">filename_write_helper</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write the configuration data in a policy database</span>
<span class="cm"> * structure to a policy database binary representation</span>
<span class="cm"> * file.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">policydb_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">policydb</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_syms</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">config</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">policydb_compat_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * refuse to write policy older than compressed avtab</span>
<span class="cm">	 * to simplify the writer.  There are other tests dropped</span>
<span class="cm">	 * since we assume this throughout the writer code.  Be</span>
<span class="cm">	 * careful if you ever try to remove this restriction</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&lt;</span> <span class="n">POLICYDB_VERSION_AVTAB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: refusing to write policy version %d.&quot;</span>
		       <span class="s">&quot;  Because it is less than version %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span><span class="p">,</span>
		       <span class="n">POLICYDB_VERSION_AVTAB</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mls_enabled</span><span class="p">)</span>
		<span class="n">config</span> <span class="o">|=</span> <span class="n">POLICYDB_CONFIG_MLS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">reject_unknown</span><span class="p">)</span>
		<span class="n">config</span> <span class="o">|=</span> <span class="n">REJECT_UNKNOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">allow_unknown</span><span class="p">)</span>
		<span class="n">config</span> <span class="o">|=</span> <span class="n">ALLOW_UNKNOWN</span><span class="p">;</span>

	<span class="cm">/* Write the magic number and string identifiers. */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">POLICYDB_MAGIC</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">POLICYDB_STRING</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">POLICYDB_STRING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Write the version, config, and table sizes. */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">policydb_lookup_compat</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SELinux: compatibility lookup failed for policy &quot;</span>
		    <span class="s">&quot;version %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sym_num</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ocon_num</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_POLCAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policycaps</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policyvers</span> <span class="o">&gt;=</span> <span class="n">POLICYDB_VERSION_PERMISSIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">permissive_map</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">num_syms</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sym_num</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_syms</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">policy_data</span> <span class="n">pd</span><span class="p">;</span>

		<span class="n">pd</span><span class="p">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>
		<span class="n">pd</span><span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nprim</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">nel</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">hashtab_map</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">table</span><span class="p">,</span> <span class="n">write_f</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">avtab_write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">te_avtab</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cond_write_list</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cond_list</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">role_trans_write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">role_allow_write</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">role_allow</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">filename_trans_write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ocontext_write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">genfs_write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">range_write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p_types</span><span class="p">.</span><span class="n">nprim</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ebitmap</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">flex_array_get</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type_attr_map_array</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ebitmap_write</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
