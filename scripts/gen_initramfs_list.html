<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › gen_initramfs_list.sh

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>gen_initramfs_list.sh</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/sh</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Copyright (C) Martin Schlemmer <a href="&#109;&#97;&#105;&#108;&#x74;o:&#x61;&#122;&#97;&#114;&#x61;&#104;&#x40;&#x6E;&#x6F;&#x73;&#x66;&#101;r&#x61;&#x74;&#117;&#46;&#x7A;&#97;&#46;&#111;r&#103;">&#x61;&#122;&#97;&#114;&#x61;&#104;&#x40;&#x6E;&#x6F;&#x73;&#x66;&#101;r&#x61;&#x74;&#117;&#46;&#x7A;&#97;&#46;&#111;r&#103;</a>
Copyright (C) 2006 Sam Ravnborg <a href="&#x6D;&#97;&#x69;&#108;&#x74;&#x6F;:&#115;&#97;&#x6D;&#x40;r&#x61;&#118;&#x6E;&#98;&#x6F;&#114;&#103;&#x2E;&#x6F;&#x72;&#x67;">&#115;&#97;&#x6D;&#x40;r&#x61;&#118;&#x6E;&#98;&#x6F;&#114;&#103;&#x2E;&#x6F;&#x72;&#x67;</a></p>

<p>Released under the terms of the GNU GPL</p>

<p>Generate a cpio packed initramfs. It uses gen<em>init</em>cpio to generate
the cpio archive, and then compresses it.
The script may also be used to generate the inputfile used for gen<em>init</em>cpio
This script assumes that gen<em>init</em>cpio is located in usr/ directory</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>error out on errors</p></td><td class="code"><div class="highlight"><pre><span class="nb">set</span> -e

usage<span class="o">()</span> <span class="o">{</span>
cat <span class="s">&lt;&lt; EOF</span>
<span class="s">Usage:</span>
<span class="s">$0 [-o &lt;file&gt;] [-u &lt;uid&gt;] [-g &lt;gid&gt;] {-d | &lt;cpio_source&gt;} ...</span>
<span class="s">	-o &lt;file&gt;      Create compressed initramfs file named &lt;file&gt; using</span>
<span class="s">		       gen_init_cpio and compressor depending on the extension</span>
<span class="s">	-u &lt;uid&gt;       User ID to map to user ID 0 (root).</span>
<span class="s">		       &lt;uid&gt; is only meaningful if &lt;cpio_source&gt; is a</span>
<span class="s">		       directory.  &quot;squash&quot; forces all files to uid 0.</span>
<span class="s">	-g &lt;gid&gt;       Group ID to map to group ID 0 (root).</span>
<span class="s">		       &lt;gid&gt; is only meaningful if &lt;cpio_source&gt; is a</span>
<span class="s">		       directory.  &quot;squash&quot; forces all files to gid 0.</span>
<span class="s">	&lt;cpio_source&gt;  File list or directory for cpio archive.</span>
<span class="s">		       If &lt;cpio_source&gt; is a .cpio file it will be used</span>
<span class="s">		       as direct input to initramfs.</span>
<span class="s">	-d             Output the default cpio list.</span>

<span class="s">All options except -o and -l may be repeated and are interpreted</span>
<span class="s">sequentially and immediately.  -u and -g states are preserved across</span>
<span class="s">&lt;cpio_source&gt; options so an explicit &quot;-u 0 -g 0&quot; is required</span>
<span class="s">to reset the root/group mapping.</span>
<span class="s">EOF</span>
<span class="o">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>awk style field access
$1 - field number; rest is argument string</p></td><td class="code"><div class="highlight"><pre>field<span class="o">()</span> <span class="o">{</span>
	<span class="nb">shift</span> <span class="nv">$1</span> ; <span class="nb">echo</span> <span class="nv">$1</span>
<span class="o">}</span>

list_default_initramfs<span class="o">()</span> <span class="o">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>echo usr/kinit/kinit</p></td><td class="code"><div class="highlight"><pre>	:
<span class="o">}</span>

default_initramfs<span class="o">()</span> <span class="o">{</span>
	cat <span class="s">&lt;&lt;-EOF &gt;&gt; ${output}</span>

<span class="s">#DIVIDER</span>

<span class="s">		dir /dev 0755 0 0</span>
<span class="s">		nod /dev/console 0600 0 0 c 5 1</span>
<span class="s">		dir /root 0700 0 0</span>

<span class="s">#DIVIDER</span>
<span class="s">	EOF</span>
<span class="o">}</span>

filetype<span class="o">()</span> <span class="o">{</span>
	<span class="nb">local </span><span class="nv">argv1</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>This is a very simple, default initramfs</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="o">[</span> -L <span class="s2">&quot;${argv1}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;slink&quot;</span>
	<span class="k">elif</span> <span class="o">[</span> -f <span class="s2">&quot;${argv1}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;file&quot;</span>
	<span class="k">elif</span> <span class="o">[</span> -d <span class="s2">&quot;${argv1}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;dir&quot;</span>
	<span class="k">elif</span> <span class="o">[</span> -b <span class="s2">&quot;${argv1}&quot;</span> -o -c <span class="s2">&quot;${argv1}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;nod&quot;</span>
	<span class="k">elif</span> <span class="o">[</span> -p <span class="s2">&quot;${argv1}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;pipe&quot;</span>
	<span class="k">elif</span> <span class="o">[</span> -S <span class="s2">&quot;${argv1}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;sock&quot;</span>
	<span class="k">else</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;invalid&quot;</span>
	<span class="k">fi</span>
<span class="k">	return </span>0
<span class="o">}</span>

list_print_mtime<span class="o">()</span> <span class="o">{</span>
	:
<span class="o">}</span>

print_mtime<span class="o">()</span> <span class="o">{</span>
	<span class="nb">local </span><span class="nv">my_mtime</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>

	<span class="k">if</span> <span class="o">[</span> -e <span class="s2">&quot;$1&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">my_mtime</span><span class="o">=</span><span class="k">$(</span>find <span class="s2">&quot;$1&quot;</span> -printf <span class="s2">&quot;%T@\n&quot;</span> | sort -r | head -n 1<span class="k">)</span>
	<span class="k">fi</span>

<span class="k">	</span><span class="nb">echo</span> <span class="s2">&quot;# Last modified: ${my_mtime}&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">output</span><span class="k">}</span>
	<span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">output</span><span class="k">}</span>
<span class="o">}</span>

list_parse<span class="o">()</span> <span class="o">{</span>
	<span class="o">[</span> ! -L <span class="s2">&quot;$1&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$1 \\&quot;</span> <span class="o">||</span> :
<span class="o">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>file /kinit usr/kinit/kinit 0755 0 0
slink /init kinit 0755 0 0</p></td><td class="code"><div class="highlight"><pre>parse<span class="o">()</span> <span class="o">{</span>
	<span class="nb">local </span><span class="nv">location</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
	<span class="nb">local </span><span class="nv">name</span><span class="o">=</span><span class="s2">&quot;/${location#${srcdir}}&quot;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>symlink test must come before file test</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">name</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$name&quot;</span> | sed -e <span class="s1">&#39;s://*:/:g&#39;</span><span class="k">)</span>
	<span class="nb">local </span><span class="nv">mode</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span>
	<span class="nb">local </span><span class="nv">uid</span><span class="o">=</span><span class="s2">&quot;$3&quot;</span>
	<span class="nb">local </span><span class="nv">gid</span><span class="o">=</span><span class="s2">&quot;$4&quot;</span>
	<span class="nb">local </span><span class="nv">ftype</span><span class="o">=</span><span class="k">$(</span>filetype <span class="s2">&quot;${location}&quot;</span><span class="k">)</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>for each file print a line in following format
<filetype> <name> <path to file> <octal mode> <uid> <gid>
for links, devices etc the format differs. See gen<em>init</em>cpio for details</p></td><td class="code"><div class="highlight"><pre>	<span class="o">[</span> <span class="s2">&quot;$root_uid&quot;</span> <span class="o">=</span> <span class="s2">&quot;squash&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">uid</span><span class="o">=</span>0 <span class="o">||</span> <span class="o">[</span> <span class="s2">&quot;$uid&quot;</span> -eq <span class="s2">&quot;$root_uid&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">uid</span><span class="o">=</span>0
	<span class="o">[</span> <span class="s2">&quot;$root_gid&quot;</span> <span class="o">=</span> <span class="s2">&quot;squash&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">gid</span><span class="o">=</span>0 <span class="o">||</span> <span class="o">[</span> <span class="s2">&quot;$gid&quot;</span> -eq <span class="s2">&quot;$root_gid&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">gid</span><span class="o">=</span>0
	<span class="nb">local </span><span class="nv">str</span><span class="o">=</span><span class="s2">&quot;${mode} ${uid} ${gid}&quot;</span>

	<span class="o">[</span> <span class="s2">&quot;${ftype}&quot;</span> <span class="o">=</span> <span class="s2">&quot;invalid&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0
	<span class="o">[</span> <span class="s2">&quot;${location}&quot;</span> <span class="o">=</span> <span class="s2">&quot;${srcdir}&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0

	<span class="k">case</span> <span class="s2">&quot;${ftype}&quot;</span> in
		<span class="s2">&quot;file&quot;</span><span class="o">)</span>
			<span class="nv">str</span><span class="o">=</span><span class="s2">&quot;${ftype} ${name} ${location} ${str}&quot;</span>
			;;
		<span class="s2">&quot;nod&quot;</span><span class="o">)</span>
			<span class="nb">local </span><span class="nv">dev</span><span class="o">=</span><span class="sb">`</span><span class="nv">LC_ALL</span><span class="o">=</span>C ls -l <span class="s2">&quot;${location}&quot;</span><span class="sb">`</span>
			<span class="nb">local </span><span class="nv">maj</span><span class="o">=</span><span class="sb">`</span>field 5 <span class="k">${</span><span class="nv">dev</span><span class="k">}</span><span class="sb">`</span>
			<span class="nb">local </span><span class="nv">min</span><span class="o">=</span><span class="sb">`</span>field 6 <span class="k">${</span><span class="nv">dev</span><span class="k">}</span><span class="sb">`</span>
			<span class="nv">maj</span><span class="o">=</span><span class="k">${</span><span class="nv">maj</span><span class="p">%,</span><span class="k">}</span>

			<span class="o">[</span> -b <span class="s2">&quot;${location}&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&quot;b&quot;</span> <span class="o">||</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&quot;c&quot;</span>

			<span class="nv">str</span><span class="o">=</span><span class="s2">&quot;${ftype} ${name} ${str} ${dev} ${maj} ${min}&quot;</span>
			;;
		<span class="s2">&quot;slink&quot;</span><span class="o">)</span>
			<span class="nb">local </span><span class="nv">target</span><span class="o">=</span><span class="sb">`</span>readlink <span class="s2">&quot;${location}&quot;</span><span class="sb">`</span>
			<span class="nv">str</span><span class="o">=</span><span class="s2">&quot;${ftype} ${name} ${target} ${str}&quot;</span>
			;;
		*<span class="o">)</span>
			<span class="nv">str</span><span class="o">=</span><span class="s2">&quot;${ftype} ${name} ${str}&quot;</span>
			;;
	<span class="k">esac</span>

<span class="k">	</span><span class="nb">echo</span> <span class="s2">&quot;${str}&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">output</span><span class="k">}</span>

	<span class="k">return </span>0
<span class="o">}</span>

unknown_option<span class="o">()</span> <span class="o">{</span>
	<span class="nb">printf</span> <span class="s2">&quot;ERROR: unknown option \&quot;$arg\&quot;\n&quot;</span> &gt;&amp;2
	<span class="nb">printf</span> <span class="s2">&quot;If the filename validly begins with &#39;-&#39;, &quot;</span> &gt;&amp;2
	<span class="nb">printf</span> <span class="s2">&quot;then it must be prefixed\n&quot;</span> &gt;&amp;2
	<span class="nb">printf</span> <span class="s2">&quot;by &#39;./&#39; so that it won&#39;t be interpreted as an option.&quot;</span> &gt;&amp;2
	<span class="nb">printf</span> <span class="s2">&quot;\n&quot;</span> &gt;&amp;2
	usage &gt;&amp;2
	<span class="nb">exit </span>1
<span class="o">}</span>

list_header<span class="o">()</span> <span class="o">{</span>
	:
<span class="o">}</span>

header<span class="o">()</span> <span class="o">{</span>
	<span class="nb">printf</span> <span class="s2">&quot;\n#####################\n# $1\n&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">output</span><span class="k">}</span>
<span class="o">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>change '//' into '/'</p></td><td class="code"><div class="highlight"><pre>dir_filelist<span class="o">()</span> <span class="o">{</span>
	<span class="k">${</span><span class="nv">dep_list</span><span class="k">}</span>header <span class="s2">&quot;$1&quot;</span>

	<span class="nv">srcdir</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$1&quot;</span> | sed -e <span class="s1">&#39;s://*:/:g&#39;</span><span class="k">)</span>
	<span class="nv">dirlist</span><span class="o">=</span><span class="k">$(</span>find <span class="s2">&quot;${srcdir}&quot;</span> -printf <span class="s2">&quot;%p %m %U %G\n&quot;</span><span class="k">)</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>remap uid/gid to 0 if necessary</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="o">[</span>  <span class="s2">&quot;$(echo &quot;</span><span class="k">${</span><span class="nv">dirlist</span><span class="k">}</span><span class="s2">&quot; | wc -l)&quot;</span> -gt 1 <span class="o">]</span>; <span class="k">then</span>
		<span class="k">${</span><span class="nv">dep_list</span><span class="k">}</span>print_mtime <span class="s2">&quot;$1&quot;</span>

		<span class="nb">echo</span> <span class="s2">&quot;${dirlist}&quot;</span> | <span class="se">\</span>
		<span class="k">while </span><span class="nb">read </span>x; <span class="k">do</span>
			<span class="k">${</span><span class="nv">dep_list</span><span class="k">}</span>parse <span class="k">${</span><span class="nv">x</span><span class="k">}</span>
		<span class="k">done</span>
<span class="k">	fi</span>
<span class="o">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>process one directory (incl sub-directories)</p></td><td class="code"><div class="highlight"><pre>input_file<span class="o">()</span> <span class="o">{</span>
	<span class="nb">source</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
	<span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;$1&quot;</span> <span class="o">]</span>; <span class="k">then</span>
		<span class="k">${</span><span class="nv">dep_list</span><span class="k">}</span>header <span class="s2">&quot;$1&quot;</span>
		<span class="nv">is_cpio</span><span class="o">=</span><span class="s2">&quot;$(echo &quot;</span><span class="nv">$1</span><span class="s2">&quot; | sed &#39;s/^.*\.cpio\(\..*\)\?/cpio/&#39;)&quot;</span>
		<span class="k">if</span> <span class="o">[</span> <span class="nv">$2</span> -eq 0 -a <span class="k">${</span><span class="nv">is_cpio</span><span class="k">}</span> <span class="o">=</span> <span class="s2">&quot;cpio&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">			</span><span class="nv">cpio_file</span><span class="o">=</span><span class="nv">$1</span>
			<span class="nb">echo</span> <span class="s2">&quot;$1&quot;</span> | grep -q <span class="s1">&#39;^.*\.cpio\..*&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">is_cpio_compressed</span><span class="o">=</span><span class="s2">&quot;compressed&quot;</span>
			<span class="o">[</span> ! -z <span class="k">${</span><span class="nv">dep_list</span><span class="k">}</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$1&quot;</span>
			<span class="k">return </span>0
		<span class="k">fi</span>
<span class="k">		if</span> <span class="o">[</span> -z <span class="k">${</span><span class="nv">dep_list</span><span class="k">}</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">			</span>print_mtime <span class="s2">&quot;$1&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">output</span><span class="k">}</span>
			cat <span class="s2">&quot;$1&quot;</span>         &gt;&gt; <span class="k">${</span><span class="nv">output</span><span class="k">}</span>
		<span class="k">else</span>
<span class="k">		        </span><span class="nb">echo</span> <span class="s2">&quot;$1 \\&quot;</span>
			cat <span class="s2">&quot;$1&quot;</span> | <span class="k">while </span><span class="nb">read type </span>dir file perm ; <span class="k">do</span>
<span class="k">				if</span> <span class="o">[</span> <span class="s2">&quot;$type&quot;</span> <span class="o">=</span> <span class="s2">&quot;file&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">					</span><span class="nb">echo</span> <span class="s2">&quot;$file \\&quot;</span>;
				<span class="k">fi</span>
<span class="k">			done</span>
<span class="k">		fi</span>
<span class="k">	elif</span> <span class="o">[</span> -d <span class="s2">&quot;$1&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span>dir_filelist <span class="s2">&quot;$1&quot;</span>
	<span class="k">else</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;  ${prog}: Cannot open &#39;$1&#39;&quot;</span> &gt;&amp;2
		<span class="nb">exit </span>1
	<span class="k">fi</span>
<span class="o">}</span>

<span class="nv">prog</span><span class="o">=</span><span class="nv">$0</span>
<span class="nv">root_uid</span><span class="o">=</span>0
<span class="nv">root_gid</span><span class="o">=</span>0
<span class="nv">dep_list</span><span class="o">=</span>
<span class="nv">cpio_file</span><span class="o">=</span>
<span class="nv">cpio_list</span><span class="o">=</span>
<span class="nv">output</span><span class="o">=</span><span class="s2">&quot;/dev/stdout&quot;</span>
<span class="nv">output_file</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">is_cpio_compressed</span><span class="o">=</span>
<span class="nv">compr</span><span class="o">=</span><span class="s2">&quot;gzip -n -9 -f&quot;</span>

<span class="nv">arg</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
<span class="k">case</span> <span class="s2">&quot;$arg&quot;</span> in
	<span class="s2">&quot;-l&quot;</span><span class="o">)</span>	<span class="c"># files included in initramfs - used by kbuild</span>
		<span class="nv">dep_list</span><span class="o">=</span><span class="s2">&quot;list_&quot;</span>
		<span class="nb">echo</span> <span class="s2">&quot;deps_initramfs := $0 \\&quot;</span>
		<span class="nb">shift</span>
		;;
	<span class="s2">&quot;-o&quot;</span><span class="o">)</span>	<span class="c"># generate compressed cpio image named $1</span>
		<span class="nb">shift</span>
<span class="nb">		</span><span class="nv">output_file</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
		<span class="nv">cpio_list</span><span class="o">=</span><span class="s2">&quot;$(mktemp ${TMPDIR:-/tmp}/cpiolist.XXXXXX)&quot;</span>
		<span class="nv">output</span><span class="o">=</span><span class="k">${</span><span class="nv">cpio_list</span><span class="k">}</span>
		<span class="nb">echo</span> <span class="s2">&quot;$output_file&quot;</span> | grep -q <span class="s2">&quot;\.gz$&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">compr</span><span class="o">=</span><span class="s2">&quot;gzip -n -9 -f&quot;</span>
		<span class="nb">echo</span> <span class="s2">&quot;$output_file&quot;</span> | grep -q <span class="s2">&quot;\.bz2$&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">compr</span><span class="o">=</span><span class="s2">&quot;bzip2 -9 -f&quot;</span>
		<span class="nb">echo</span> <span class="s2">&quot;$output_file&quot;</span> | grep -q <span class="s2">&quot;\.lzma$&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">compr</span><span class="o">=</span><span class="s2">&quot;lzma -9 -f&quot;</span>
		<span class="nb">echo</span> <span class="s2">&quot;$output_file&quot;</span> | grep -q <span class="s2">&quot;\.xz$&quot;</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
				<span class="nv">compr</span><span class="o">=</span><span class="s2">&quot;xz --check=crc32 --lzma2=dict=1MiB&quot;</span>
		<span class="nb">echo</span> <span class="s2">&quot;$output_file&quot;</span> | grep -q <span class="s2">&quot;\.lzo$&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">compr</span><span class="o">=</span><span class="s2">&quot;lzop -9 -f&quot;</span>
		<span class="nb">echo</span> <span class="s2">&quot;$output_file&quot;</span> | grep -q <span class="s2">&quot;\.cpio$&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">compr</span><span class="o">=</span><span class="s2">&quot;cat&quot;</span>
		<span class="nb">shift</span>
		;;
<span class="k">esac</span>
<span class="k">while</span> <span class="o">[</span> <span class="nv">$# </span>-gt 0 <span class="o">]</span>; <span class="k">do</span>
<span class="k">	</span><span class="nv">arg</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
	<span class="nb">shift</span>
<span class="nb">	</span><span class="k">case</span> <span class="s2">&quot;$arg&quot;</span> in
		<span class="s2">&quot;-u&quot;</span><span class="o">)</span>	<span class="c"># map $1 to uid=0 (root)</span>
			<span class="nv">root_uid</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
			<span class="nb">shift</span>
			;;
		<span class="s2">&quot;-g&quot;</span><span class="o">)</span>	<span class="c"># map $1 to gid=0 (root)</span>
			<span class="nv">root_gid</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
			<span class="nb">shift</span>
			;;
		<span class="s2">&quot;-d&quot;</span><span class="o">)</span>	<span class="c"># display default initramfs list</span>
			<span class="nv">default_list</span><span class="o">=</span><span class="s2">&quot;$arg&quot;</span>
			<span class="k">${</span><span class="nv">dep_list</span><span class="k">}</span>default_initramfs
			;;
		<span class="s2">&quot;-h&quot;</span><span class="o">)</span>
			usage
			<span class="nb">exit </span>0
			;;
		*<span class="o">)</span>
			<span class="k">case</span> <span class="s2">&quot;$arg&quot;</span> in
				<span class="s2">&quot;-&quot;</span>*<span class="o">)</span>
					unknown_option
					;;
				*<span class="o">)</span>	<span class="c"># input file/dir - process it</span>
					input_file <span class="s2">&quot;$arg&quot;</span> <span class="s2">&quot;$#&quot;</span>
					;;
			<span class="k">esac</span>
			;;
	<span class="k">esac</span>
<span class="k">done</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>If $dirlist is only one line, then the directory is empty</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="o">[</span> ! -z <span class="k">${</span><span class="nv">output_file</span><span class="k">}</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	if</span> <span class="o">[</span> -z <span class="k">${</span><span class="nv">cpio_file</span><span class="k">}</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">timestamp</span><span class="o">=</span>
		<span class="k">if </span><span class="nb">test</span> -n <span class="s2">&quot;$KBUILD_BUILD_TIMESTAMP&quot;</span>; <span class="k">then</span>
<span class="k">			</span><span class="nv">timestamp</span><span class="o">=</span><span class="s2">&quot;$(date -d&quot;</span><span class="nv">$KBUILD_BUILD_TIMESTAMP</span><span class="s2">&quot; +%s || :)&quot;</span>
			<span class="k">if </span><span class="nb">test</span> -n <span class="s2">&quot;$timestamp&quot;</span>; <span class="k">then</span>
<span class="k">				</span><span class="nv">timestamp</span><span class="o">=</span><span class="s2">&quot;-t $timestamp&quot;</span>
			<span class="k">fi</span>
<span class="k">		fi</span>
<span class="k">		</span><span class="nv">cpio_tfile</span><span class="o">=</span><span class="s2">&quot;$(mktemp ${TMPDIR:-/tmp}/cpiofile.XXXXXX)&quot;</span>
		usr/gen_init_cpio <span class="nv">$timestamp</span> <span class="k">${</span><span class="nv">cpio_list</span><span class="k">}</span> &gt; <span class="k">${</span><span class="nv">cpio_tfile</span><span class="k">}</span>
	<span class="k">else</span>
<span class="k">		</span><span class="nv">cpio_tfile</span><span class="o">=</span><span class="k">${</span><span class="nv">cpio_file</span><span class="k">}</span>
	<span class="k">fi</span>
<span class="k">	</span>rm <span class="k">${</span><span class="nv">cpio_list</span><span class="k">}</span>
	<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;${is_cpio_compressed}&quot;</span> <span class="o">=</span> <span class="s2">&quot;compressed&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span>cat <span class="k">${</span><span class="nv">cpio_tfile</span><span class="k">}</span> &gt; <span class="k">${</span><span class="nv">output_file</span><span class="k">}</span>
	<span class="k">else</span>
		<span class="o">(</span>cat <span class="k">${</span><span class="nv">cpio_tfile</span><span class="k">}</span> | <span class="k">${</span><span class="nv">compr</span><span class="k">}</span>  - &gt; <span class="k">${</span><span class="nv">output_file</span><span class="k">}</span><span class="o">)</span> <span class="se">\</span>
		<span class="o">||</span> <span class="o">(</span>rm -f <span class="k">${</span><span class="nv">output_file</span><span class="k">}</span> ; <span class="nb">false</span><span class="o">)</span>
	<span class="k">fi</span>
	<span class="o">[</span> -z <span class="k">${</span><span class="nv">cpio_file</span><span class="k">}</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> rm <span class="k">${</span><span class="nv">cpio_tfile</span><span class="k">}</span>
<span class="k">fi</span>
<span class="nb">exit </span>0

</pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>if only one file is specified and it is .cpio file then use it direct as fs
if a directory is specified then add all files in given direcotry to fs
if a regular file is specified assume it is in gen_initramfs format</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>If output_file is set we will generate cpio archive and compress it
we are careful to delete tmp files</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
