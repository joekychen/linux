<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › recordmcount.pl

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>recordmcount.pl</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c1">#!/usr/bin/perl -w</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>(c) 2008, Steven Rostedt <a href="&#109;&#97;&#105;&#x6C;&#116;&#111;:&#115;&#x72;&#x6F;&#115;&#116;&#x65;&#x64;&#x74;&#64;&#x72;&#x65;&#x64;&#104;&#97;t&#x2E;&#99;&#111;m">&#115;&#x72;&#x6F;&#115;&#116;&#x65;&#x64;&#x74;&#64;&#x72;&#x65;&#x64;&#104;&#97;t&#x2E;&#99;&#111;m</a>
Licensed under the terms of the GNU GPL License version 2</p>

<p>recordmcount.pl - makes a section called <em>_mcount</em>loc that holds
                  all the offsets to the calls to mcount.</p>

<p>What we want to end up with this is that each object file will have a
section called <em>_mcount</em>loc that will hold the list of pointers to mcount
callers. After final linking, the vmlinux will have within .init.data the
list of all callers to mcount between <em>_start</em>mcount<em>loc and _</em>stop<em>mcount</em>loc.
Later on boot up, the kernel will read this list, save the locations and turn
them into nops. When tracing or profiling is later enabled, these locations
will then be converted back to pointers to some function.</p>

<p>This is no easy feat. This script is called just after the original
object is compiled and before it is linked.</p>

<p>When parse this object file using 'objdump', the references to the call
sites are offsets from the section that the call site is in. Hence, all
functions in a section that has a call site to mcount, will have the
offset from the beginning of the section and not the beginning of the
function.</p>

<p>But where this section will reside finally in vmlinx is undetermined at
this point. So we can't use this kind of offsets to record the final
address of this call site.</p>

<p>The trick is to change the call offset referring the start of a section to
referring a function symbol in this section. During the link step, 'ld' will
compute the final address according to the information we record.</p>

<p>e.g.</p>

<p>.section ".sched.text", "ax"
       [...]
 func1:
       [...]
       call mcount  (offset: 0x10)
       [...]
       ret
 .globl fun2
 func2:             (offset: 0x20)
       [...]
       [...]
       ret
 func3:
       [...]
       call mcount (offset: 0x30)
       [...]</p>

<p>Both relocation offsets for the mcounts in the above example will be
offset from .sched.text. If we choose global symbol func2 as a reference and
make another file called tmp.s with the new offsets:</p>

<p>.section <em>_mcount</em>loc
 .quad  func2 - 0x10
 .quad  func2 + 0x10</p>

<p>We can then compile this tmp.s into tmp.o, and link it back to the original
object.</p>

<p>In our algorithm, we will choose the first global function we meet in this
section as the reference. But this gets hard if there is no global functions
in this section. In such a case we have to select a local one. E.g. func1:</p>

<p>.section ".sched.text", "ax"
 func1:
       [...]
       call mcount  (offset: 0x10)
       [...]
       ret
 func2:
       [...]
       call mcount (offset: 0x20)
       [...]
 .section "other.section"</p>

<p>If we make the tmp.s the same as above, when we link together with
the original object, we will end up with two symbols for func1:
one local, one global.  After final compile, we will end up with
an undefined reference to func1 or a wrong reference to another global
func1 in other files.</p>

<p>Since local objects can reference local variables, we need to find
a way to make tmp.o reference the local objects of the original object
file after it is linked together. To do this, we convert func1
into a global symbol before linking tmp.o. Then after we link tmp.o
we will only have a single symbol for func1 that is global.
We can convert func1 back into a local symbol and we are done.</p>

<p>Here are the steps we take:</p>

<p>1) Record all the local and weak symbols by using 'nm'
2) Use objdump to find all the call site offsets and sections for
   mcount.
3) Compile the list into its own object.
4) Do we have to deal with local functions? If not, go to step 8.
5) Make an object that converts these local functions to global symbols
   with objcopy.
6) Link together this new object with the list object.
7) Convert the local functions back to local symbols and rename
   the result as the original object.
8) Link the object with the list object.
9) Move the result back to the original object.</p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">strict</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$P</span> <span class="o">=</span> <span class="nv">$0</span><span class="p">;</span>
<span class="nv">$P</span> <span class="o">=~</span> <span class="sr">s@.*/@@g</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$V</span> <span class="o">=</span> <span class="s">&#39;0.1&#39;</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$#ARGV</span> <span class="o">!=</span> <span class="mi">11</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="s">&quot;usage: $P arch endian bits objdump objcopy cc ld nm rm mv is_module inputfile\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;version: $V\n&quot;</span><span class="p">;</span>
	<span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">my</span> <span class="p">(</span><span class="nv">$arch</span><span class="p">,</span> <span class="nv">$endian</span><span class="p">,</span> <span class="nv">$bits</span><span class="p">,</span> <span class="nv">$objdump</span><span class="p">,</span> <span class="nv">$objcopy</span><span class="p">,</span> <span class="nv">$cc</span><span class="p">,</span>
    <span class="nv">$ld</span><span class="p">,</span> <span class="nv">$nm</span><span class="p">,</span> <span class="nv">$rm</span><span class="p">,</span> <span class="nv">$mv</span><span class="p">,</span> <span class="nv">$is_module</span><span class="p">,</span> <span class="nv">$inputfile</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@ARGV</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>This file refers to mcount and shouldn't be ftraced, so lets' ignore it</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nv">$inputfile</span> <span class="o">=~</span> <span class="n">m</span><span class="p">,</span><span class="n">kernel</span><span class="sr">/trace/</span><span class="n">ftrace</span><span class="o">\.</span><span class="n">o</span><span class="vg">$,</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Acceptable sections to record.</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">%text_sections</span> <span class="o">=</span> <span class="p">(</span>
     <span class="s">&quot;.text&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
     <span class="s">&quot;.ref.text&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
     <span class="s">&quot;.sched.text&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
     <span class="s">&quot;.spinlock.text&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
     <span class="s">&quot;.irqentry.text&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
     <span class="s">&quot;.kprobes.text&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
     <span class="s">&quot;.text.unlikely&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Note: we are nice to C-programmers here, thus we skip the '||='-idiom.</p></td><td class="code"><div class="highlight"><pre><span class="nv">$objdump</span> <span class="o">=</span> <span class="s">&#39;objdump&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$objdump</span><span class="p">);</span>
<span class="nv">$objcopy</span> <span class="o">=</span> <span class="s">&#39;objcopy&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$objcopy</span><span class="p">);</span>
<span class="nv">$cc</span> <span class="o">=</span> <span class="s">&#39;gcc&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$cc</span><span class="p">);</span>
<span class="nv">$ld</span> <span class="o">=</span> <span class="s">&#39;ld&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$ld</span><span class="p">);</span>
<span class="nv">$nm</span> <span class="o">=</span> <span class="s">&#39;nm&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$nm</span><span class="p">);</span>
<span class="nv">$rm</span> <span class="o">=</span> <span class="s">&#39;rm&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$rm</span><span class="p">);</span>
<span class="nv">$mv</span> <span class="o">=</span> <span class="s">&#39;mv&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$mv</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>print STDERR "running: $P '$arch' '$objdump' '$objcopy' '$cc' '$ld' " .
   "'$nm' '$rm' '$mv' '$inputfile'\n";</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">%locals</span><span class="p">;</span>		<span class="c1"># List of local (static) functions</span>
<span class="k">my</span> <span class="nv">%weak</span><span class="p">;</span>		<span class="c1"># List of weak functions</span>
<span class="k">my</span> <span class="nv">%convert</span><span class="p">;</span>		<span class="c1"># List of local functions used that needs conversion</span>

<span class="k">my</span> <span class="nv">$type</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$local_regex</span><span class="p">;</span>	<span class="c1"># Match a local function (return function)</span>
<span class="k">my</span> <span class="nv">$weak_regex</span><span class="p">;</span> 	<span class="c1"># Match a weak function (return function)</span>
<span class="k">my</span> <span class="nv">$section_regex</span><span class="p">;</span>	<span class="c1"># Find the start of a section</span>
<span class="k">my</span> <span class="nv">$function_regex</span><span class="p">;</span>	<span class="c1"># Find the name of a function</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>(return offset and func name)</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$mcount_regex</span><span class="p">;</span>	<span class="c1"># Find the call site to mcount (return offset)</span>
<span class="k">my</span> <span class="nv">$mcount_adjust</span><span class="p">;</span>	<span class="c1"># Address adjustment to mcount offset</span>
<span class="k">my</span> <span class="nv">$alignment</span><span class="p">;</span>		<span class="c1"># The .align value to use for $mcount_section</span>
<span class="k">my</span> <span class="nv">$section_type</span><span class="p">;</span>	<span class="c1"># Section header plus possible alignment command</span>
<span class="k">my</span> <span class="nv">$can_use_local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 	<span class="c1"># If we can use local function references</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Shut up recordmcount if user has older objcopy</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$quiet_recordmcount</span> <span class="o">=</span> <span class="s">&quot;.tmp_quiet_recordmcount&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$print_warning</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nv">$print_warning</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="p">(</span> <span class="o">-</span><span class="n">f</span> <span class="nv">$quiet_recordmcount</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>#
check_objcopy - whether objcopy supports --globalize-symbols</p>

<p>--globalize-symbols came out in 2.17, we must test the version
 of objcopy, and if it is less than 2.17, then we can not
 record local functions.</p></td><td class="code"><div class="highlight"><pre><span class="k">sub </span><span class="nf">check_objcopy</span>
<span class="p">{</span>
    <span class="nb">open</span> <span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="s">&quot;$objcopy --version |&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;error running $objcopy&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="sr">/objcopy.*\s(\d+)\.(\d+)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$can_use_local</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$1</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$1</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nv">$2</span> <span class="o">&gt;=</span> <span class="mi">17</span><span class="p">));</span>
	    <span class="k">last</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">close</span> <span class="p">(</span><span class="n">IN</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$can_use_local</span> <span class="o">&amp;&amp;</span> <span class="nv">$print_warning</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;WARNING: could not find objcopy version or version &quot;</span> <span class="o">.</span>
	    <span class="s">&quot;is less than 2.17.\n&quot;</span> <span class="o">.</span>
	    <span class="s">&quot;\tLocal function references are disabled.\n&quot;</span><span class="p">;</span>
	<span class="nb">open</span> <span class="p">(</span><span class="n">QUIET</span><span class="p">,</span> <span class="s">&quot;&gt;$quiet_recordmcount&quot;</span><span class="p">);</span>
	<span class="nb">printf</span> <span class="n">QUIET</span> <span class="s">&quot;Disables the warning from recordmcount.pl\n&quot;</span><span class="p">;</span>
	<span class="nb">close</span> <span class="n">QUIET</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$arch</span> <span class="o">=~</span><span class="sr"> /(x86(_64)?)|(i386)/</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$bits</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$arch</span> <span class="o">=</span> <span class="s">&quot;x86_64&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nv">$arch</span> <span class="o">=</span> <span class="s">&quot;i386&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>We base the defaults off of i386, the other archs may
feel free to change them in the below if statements.</p></td><td class="code"><div class="highlight"><pre><span class="nv">$local_regex</span> <span class="o">=</span> <span class="s">&quot;^[0-9a-fA-F]+\\s+t\\s+(\\S+)&quot;</span><span class="p">;</span>
<span class="nv">$weak_regex</span> <span class="o">=</span> <span class="s">&quot;^[0-9a-fA-F]+\\s+([wW])\\s+(\\S+)&quot;</span><span class="p">;</span>
<span class="nv">$section_regex</span> <span class="o">=</span> <span class="s">&quot;Disassembly of section\\s+(\\S+):&quot;</span><span class="p">;</span>
<span class="nv">$function_regex</span> <span class="o">=</span> <span class="s">&quot;^([0-9a-fA-F]+)\\s+&lt;(.*?)&gt;:&quot;</span><span class="p">;</span>
<span class="nv">$mcount_regex</span> <span class="o">=</span> <span class="s">&quot;^\\s*([0-9a-fA-F]+):.*\\smcount\$&quot;</span><span class="p">;</span>
<span class="nv">$section_type</span> <span class="o">=</span> <span class="s">&#39;@progbits&#39;</span><span class="p">;</span>
<span class="nv">$mcount_adjust</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nv">$type</span> <span class="o">=</span> <span class="s">&quot;.long&quot;</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$arch</span> <span class="ow">eq</span> <span class="s">&quot;x86_64&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$mcount_regex</span> <span class="o">=</span> <span class="s">&quot;^\\s*([0-9a-fA-F]+):.*\\smcount([+-]0x[0-9a-zA-Z]+)?\$&quot;</span><span class="p">;</span>
    <span class="nv">$type</span> <span class="o">=</span> <span class="s">&quot;.quad&quot;</span><span class="p">;</span>
    <span class="nv">$alignment</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="nv">$mcount_adjust</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>force flags for this arch</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">$ld</span> <span class="o">.=</span> <span class="s">&quot; -m elf_x86_64&quot;</span><span class="p">;</span>
    <span class="nv">$objdump</span> <span class="o">.=</span> <span class="s">&quot; -M x86-64&quot;</span><span class="p">;</span>
    <span class="nv">$objcopy</span> <span class="o">.=</span> <span class="s">&quot; -O elf64-x86-64&quot;</span><span class="p">;</span>
    <span class="nv">$cc</span> <span class="o">.=</span> <span class="s">&quot; -m64&quot;</span><span class="p">;</span>

<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arch</span> <span class="ow">eq</span> <span class="s">&quot;i386&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$alignment</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="nv">$mcount_adjust</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>force flags for this arch</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">$ld</span> <span class="o">.=</span> <span class="s">&quot; -m elf_i386&quot;</span><span class="p">;</span>
    <span class="nv">$objdump</span> <span class="o">.=</span> <span class="s">&quot; -M i386&quot;</span><span class="p">;</span>
    <span class="nv">$objcopy</span> <span class="o">.=</span> <span class="s">&quot; -O elf32-i386&quot;</span><span class="p">;</span>
    <span class="nv">$cc</span> <span class="o">.=</span> <span class="s">&quot; -m32&quot;</span><span class="p">;</span>

<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arch</span> <span class="ow">eq</span> <span class="s">&quot;s390&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$bits</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$mcount_regex</span> <span class="o">=</span> <span class="s">&quot;^\\s*([0-9a-fA-F]+):\\s*R_390_32\\s+_mcount\$&quot;</span><span class="p">;</span>
    <span class="nv">$mcount_adjust</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
    <span class="nv">$alignment</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="nv">$ld</span> <span class="o">.=</span> <span class="s">&quot; -m elf_s390&quot;</span><span class="p">;</span>
    <span class="nv">$cc</span> <span class="o">.=</span> <span class="s">&quot; -m31&quot;</span><span class="p">;</span>

<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arch</span> <span class="ow">eq</span> <span class="s">&quot;s390&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$bits</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$mcount_regex</span> <span class="o">=</span> <span class="s">&quot;^\\s*([0-9a-fA-F]+):\\s*R_390_(PC|PLT)32DBL\\s+_mcount\\+0x2\$&quot;</span><span class="p">;</span>
    <span class="nv">$mcount_adjust</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8</span><span class="p">;</span>
    <span class="nv">$alignment</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="nv">$type</span> <span class="o">=</span> <span class="s">&quot;.quad&quot;</span><span class="p">;</span>
    <span class="nv">$ld</span> <span class="o">.=</span> <span class="s">&quot; -m elf64_s390&quot;</span><span class="p">;</span>
    <span class="nv">$cc</span> <span class="o">.=</span> <span class="s">&quot; -m64&quot;</span><span class="p">;</span>

<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arch</span> <span class="ow">eq</span> <span class="s">&quot;sh&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$alignment</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>force flags for this arch</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">$ld</span> <span class="o">.=</span> <span class="s">&quot; -m shlelf_linux&quot;</span><span class="p">;</span>
    <span class="nv">$objcopy</span> <span class="o">.=</span> <span class="s">&quot; -O elf32-sh-linux&quot;</span><span class="p">;</span>
    <span class="nv">$cc</span> <span class="o">.=</span> <span class="s">&quot; -m32&quot;</span><span class="p">;</span>

<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arch</span> <span class="ow">eq</span> <span class="s">&quot;powerpc&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$local_regex</span> <span class="o">=</span> <span class="s">&quot;^[0-9a-fA-F]+\\s+t\\s+(\\.?\\S+)&quot;</span><span class="p">;</span>
    <span class="nv">$function_regex</span> <span class="o">=</span> <span class="s">&quot;^([0-9a-fA-F]+)\\s+&lt;(\\.?.*?)&gt;:&quot;</span><span class="p">;</span>
    <span class="nv">$mcount_regex</span> <span class="o">=</span> <span class="s">&quot;^\\s*([0-9a-fA-F]+):.*\\s\\.?_mcount\$&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$bits</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$type</span> <span class="o">=</span> <span class="s">&quot;.quad&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arch</span> <span class="ow">eq</span> <span class="s">&quot;arm&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$alignment</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nv">$section_type</span> <span class="o">=</span> <span class="s">&#39;%progbits&#39;</span><span class="p">;</span>
    <span class="nv">$mcount_regex</span> <span class="o">=</span> <span class="s">&quot;^\\s*([0-9a-fA-F]+):\\s*R_ARM_(CALL|PC24|THM_CALL)&quot;</span> <span class="o">.</span>
			<span class="s">&quot;\\s+(__gnu_mcount_nc|mcount)\$&quot;</span><span class="p">;</span>

<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arch</span> <span class="ow">eq</span> <span class="s">&quot;ia64&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$mcount_regex</span> <span class="o">=</span> <span class="s">&quot;^\\s*([0-9a-fA-F]+):.*\\s_mcount\$&quot;</span><span class="p">;</span>
    <span class="nv">$type</span> <span class="o">=</span> <span class="s">&quot;data8&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$is_module</span> <span class="ow">eq</span> <span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$cc</span> <span class="o">.=</span> <span class="s">&quot; -mconstant-gp&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arch</span> <span class="ow">eq</span> <span class="s">&quot;sparc64&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>In the objdump output there are giblets like:
0000000000000000 <igmp_net_exit-0x18>:
As there's some data blobs that get emitted into the
text section before the first instructions and the first
real symbols.  We don't want to match that, so to combat
this we use '\w' so we'll match just plain symbol names,
and not those that also include hex offsets inside of the
'&lt;>' brackets.  Actually the generic function_regex setting
could safely use this too.</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">$function_regex</span> <span class="o">=</span> <span class="s">&quot;^([0-9a-fA-F]+)\\s+&lt;(\\w*?)&gt;:&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Sparc64 calls '_mcount' instead of plain 'mcount'.</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">$mcount_regex</span> <span class="o">=</span> <span class="s">&quot;^\\s*([0-9a-fA-F]+):.*\\s_mcount\$&quot;</span><span class="p">;</span>

    <span class="nv">$alignment</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="nv">$type</span> <span class="o">=</span> <span class="s">&quot;.xword&quot;</span><span class="p">;</span>
    <span class="nv">$ld</span> <span class="o">.=</span> <span class="s">&quot; -m elf64_sparc&quot;</span><span class="p">;</span>
    <span class="nv">$cc</span> <span class="o">.=</span> <span class="s">&quot; -m64&quot;</span><span class="p">;</span>
    <span class="nv">$objcopy</span> <span class="o">.=</span> <span class="s">&quot; -O elf64-sparc&quot;</span><span class="p">;</span>
<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arch</span> <span class="ow">eq</span> <span class="s">&quot;mips&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>To enable module support, we need to enable the -mlong-calls option
of gcc for module, after using this option, we can not get the real
offset of the calling to _mcount, but the offset of the lui
instruction or the addiu one. herein, we record the address of the
first one, and then we can replace this instruction by a branch
instruction to jump over the profiling function to filter the
indicated functions, or swith back to the lui instruction to trace
them, which means dynamic tracing.</p>

<pre><code>  c:    3c030000    lui v1,0x0
    c: R_MIPS_HI16  _mcount
    c: R_MIPS_NONE  *ABS*
    c: R_MIPS_NONE  *ABS*
 10:    64630000    daddiu  v1,v1,0
    10: R_MIPS_LO16 _mcount
    10: R_MIPS_NONE *ABS*
    10: R_MIPS_NONE *ABS*
 14:    03e0082d    move    at,ra
 18:    0060f809    jalr    v1
</code></pre>

<p>for the kernel:</p>

<pre><code>10:   03e0082d        move    at,ra
</code></pre>

<p>14:   0c000000        jal     0 <loongson_halt>
                   14: R<em>MIPS</em>26   <em>mcount
                   14: R</em>MIPS<em>NONE *ABS*
                   14: R</em>MIPS_NONE <em>ABS</em>
 18:   00020021        nop</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$is_module</span> <span class="ow">eq</span> <span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$mcount_regex</span> <span class="o">=</span> <span class="s">&quot;^\\s*([0-9a-fA-F]+): R_MIPS_26\\s+_mcount\$&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nv">$mcount_regex</span> <span class="o">=</span> <span class="s">&quot;^\\s*([0-9a-fA-F]+): R_MIPS_HI16\\s+_mcount\$&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$objdump</span> <span class="o">.=</span> <span class="s">&quot; -Melf-trad&quot;</span><span class="o">.</span><span class="nv">$endian</span><span class="o">.</span><span class="s">&quot;mips &quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$endian</span> <span class="ow">eq</span> <span class="s">&quot;big&quot;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$endian</span> <span class="o">=</span> <span class="s">&quot; -EB &quot;</span><span class="p">;</span>
	    <span class="nv">$ld</span> <span class="o">.=</span> <span class="s">&quot; -melf&quot;</span><span class="o">.</span><span class="nv">$bits</span><span class="o">.</span><span class="s">&quot;btsmip&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nv">$endian</span> <span class="o">=</span> <span class="s">&quot; -EL &quot;</span><span class="p">;</span>
	    <span class="nv">$ld</span> <span class="o">.=</span> <span class="s">&quot; -melf&quot;</span><span class="o">.</span><span class="nv">$bits</span><span class="o">.</span><span class="s">&quot;ltsmip&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$cc</span> <span class="o">.=</span> <span class="s">&quot; -mno-abicalls -fno-pic -mabi=&quot;</span> <span class="o">.</span> <span class="nv">$bits</span> <span class="o">.</span> <span class="nv">$endian</span><span class="p">;</span>
    <span class="nv">$ld</span> <span class="o">.=</span> <span class="nv">$endian</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$bits</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$function_regex</span> <span class="o">=</span>
		<span class="s">&quot;^([0-9a-fA-F]+)\\s+&lt;(.|[^\$]L.*?|\$[^L].*?|[^\$][^L].*?)&gt;:&quot;</span><span class="p">;</span>
	    <span class="nv">$type</span> <span class="o">=</span> <span class="s">&quot;.dword&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arch</span> <span class="ow">eq</span> <span class="s">&quot;microblaze&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Microblaze calls '_mcount' instead of plain 'mcount'.</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">$mcount_regex</span> <span class="o">=</span> <span class="s">&quot;^\\s*([0-9a-fA-F]+):.*\\s_mcount\$&quot;</span><span class="p">;</span>
<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arch</span> <span class="ow">eq</span> <span class="s">&quot;blackfin&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$mcount_regex</span> <span class="o">=</span> <span class="s">&quot;^\\s*([0-9a-fA-F]+):.*\\s__mcount\$&quot;</span><span class="p">;</span>
    <span class="nv">$mcount_adjust</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">die</span> <span class="s">&quot;Arch $arch is not supported with CONFIG_FTRACE_MCOUNT_RECORD&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$text_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$read_function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$opened</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$mcount_section</span> <span class="o">=</span> <span class="s">&quot;__mcount_loc&quot;</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$dirname</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$filename</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$prefix</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$ext</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$inputfile</span> <span class="o">=~</span> <span class="n">m</span><span class="p">,</span><span class="o">^</span><span class="p">(</span><span class="o">.*</span><span class="p">)</span><span class="sr">/([^/</span><span class="p">]</span><span class="o">*</span><span class="p">)</span><span class="vg">$,</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$dirname</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
    <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$dirname</span> <span class="o">=</span> <span class="s">&quot;.&quot;</span><span class="p">;</span>
    <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$inputfile</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$filename</span> <span class="o">=~</span> <span class="n">m</span><span class="p">,</span><span class="o">^</span><span class="p">(</span><span class="o">.*</span><span class="p">)(</span><span class="o">\.\</span><span class="n">S</span><span class="p">),)</span> <span class="p">{</span>
    <span class="nv">$prefix</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
    <span class="nv">$ext</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$prefix</span> <span class="o">=</span> <span class="nv">$filename</span><span class="p">;</span>
    <span class="nv">$ext</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$mcount_s</span> <span class="o">=</span> <span class="nv">$dirname</span> <span class="o">.</span> <span class="s">&quot;/.tmp_mc_&quot;</span> <span class="o">.</span> <span class="nv">$prefix</span> <span class="o">.</span> <span class="s">&quot;.s&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$mcount_o</span> <span class="o">=</span> <span class="nv">$dirname</span> <span class="o">.</span> <span class="s">&quot;/.tmp_mc_&quot;</span> <span class="o">.</span> <span class="nv">$prefix</span> <span class="o">.</span> <span class="s">&quot;.o&quot;</span><span class="p">;</span>

<span class="n">check_objcopy</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Step 1: find all the local (static functions) and weak symbols.
        't' is local, 'w/W' is weak</p></td><td class="code"><div class="highlight"><pre><span class="nb">open</span> <span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="s">&quot;$nm $inputfile|&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nb">die</span> <span class="s">&quot;error running $nm&quot;</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="sr">/$local_regex/</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$locals</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/$weak_regex/</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$weak</span><span class="p">{</span><span class="nv">$2</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nb">close</span><span class="p">(</span><span class="n">IN</span><span class="p">);</span>

<span class="k">my</span> <span class="nv">@offsets</span><span class="p">;</span>		<span class="c1"># Array of offsets of mcount callers</span>
<span class="k">my</span> <span class="nv">$ref_func</span><span class="p">;</span>		<span class="c1"># reference function to use for offsets</span>
<span class="k">my</span> <span class="nv">$offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="c1"># offset of ref_func to section beginning</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>#
update_funcs - print out the current mcount callers</p>

<p>Go through the list of offsets to callers and write them to
 the output file in a format that can be read by an assembler.</p></td><td class="code"><div class="highlight"><pre><span class="k">sub </span><span class="nf">update_funcs</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="p">(</span><span class="nv">$ref_func</span> <span class="ow">and</span> <span class="nv">@offsets</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Sanity check on weak function. A weak function may be overwritten by
another function of the same name, making all these offsets incorrect.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$weak</span><span class="p">{</span><span class="nv">$ref_func</span><span class="p">})</span> <span class="p">{</span>
	<span class="nb">die</span> <span class="s">&quot;$inputfile: ERROR: referencing weak function&quot;</span> <span class="o">.</span>
	    <span class="s">&quot; $ref_func for mcount\n&quot;</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>is this function static? If so, note this fact.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$locals</span><span class="p">{</span><span class="nv">$ref_func</span><span class="p">})</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>only use locals if objcopy supports globalize-symbols</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$can_use_local</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nv">$convert</span><span class="p">{</span><span class="nv">$ref_func</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Loop through all the mcount caller offsets and print a reference
to the caller based from the ref_func.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$opened</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">open</span><span class="p">(</span><span class="n">FILE</span><span class="p">,</span> <span class="s">&quot;&gt;$mcount_s&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nb">die</span> <span class="s">&quot;can&#39;t create $mcount_s\n&quot;</span><span class="p">;</span>
	<span class="nv">$opened</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">print</span> <span class="n">FILE</span> <span class="s">&quot;\t.section $mcount_section,\&quot;a\&quot;,$section_type\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="n">FILE</span> <span class="s">&quot;\t.align $alignment\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$alignment</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$cur_offset</span> <span class="p">(</span><span class="nv">@offsets</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">printf</span> <span class="n">FILE</span> <span class="s">&quot;\t%s %s + %d\n&quot;</span><span class="p">,</span> <span class="nv">$type</span><span class="p">,</span> <span class="nv">$ref_func</span><span class="p">,</span> <span class="nv">$cur_offset</span> <span class="o">-</span> <span class="nv">$offset</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Step 2: find the sections and mcount call sites</p></td><td class="code"><div class="highlight"><pre><span class="nb">open</span><span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="s">&quot;$objdump -hdr $inputfile|&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nb">die</span> <span class="s">&quot;error running $objdump&quot;</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$text</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>read headers first</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$read_headers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$read_headers</span> <span class="o">&amp;&amp;</span> <span class="sr">/$mcount_section/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Somehow the make process can execute this script on an
object twice. If it does, we would duplicate the mcount
section and it will cause the function tracer self test
to fail. Check if the mcount section exists, and if it does,
warn and exit.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;ERROR: $mcount_section already in $inputfile\n&quot;</span> <span class="o">.</span>
	    <span class="s">&quot;\tThis may be an indication that your build is corrupted.\n&quot;</span> <span class="o">.</span>
	    <span class="s">&quot;\tDelete $inputfile and try again. If the same object file\n&quot;</span> <span class="o">.</span>
	    <span class="s">&quot;\tstill causes an issue, then disable CONFIG_DYNAMIC_FTRACE.\n&quot;</span><span class="p">;</span>
	<span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>is it a section?</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="sr">/$section_regex/</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$read_headers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Only record text sections that we know are safe</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$read_function</span> <span class="o">=</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$text_sections</span><span class="p">{</span><span class="nv">$1</span><span class="p">});</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>print out any recorded offsets</p></td><td class="code"><div class="highlight"><pre>	<span class="n">update_funcs</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>reset all markers and arrays</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$text_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nb">undef</span><span class="p">(</span><span class="nv">$ref_func</span><span class="p">);</span>
	<span class="nb">undef</span><span class="p">(</span><span class="nv">@offsets</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>section found, now is this a start of a function?</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$read_function</span> <span class="o">&amp;&amp;</span> <span class="sr">/$function_regex/</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$text_found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nv">$text</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>if this is either a local function or a weak function
keep looking for functions that are global that
we can use safely.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$locals</span><span class="p">{</span><span class="nv">$text</span><span class="p">})</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$weak</span><span class="p">{</span><span class="nv">$text</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="nv">$ref_func</span> <span class="o">=</span> <span class="nv">$text</span><span class="p">;</span>
	    <span class="nv">$read_function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="nv">$offset</span> <span class="o">=</span> <span class="nb">hex</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>if we already have a function, and this is weak, skip it</p></td><td class="code"><div class="highlight"><pre>	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$ref_func</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$weak</span><span class="p">{</span><span class="nv">$text</span><span class="p">})</span> <span class="o">&amp;&amp;</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>PPC64 can have symbols that start with .L and
gcc considers these special. Don't use them!</p></td><td class="code"><div class="highlight"><pre>		 <span class="nv">$text</span> <span class="o">!~</span> <span class="sr">/^\.L/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$ref_func</span> <span class="o">=</span> <span class="nv">$text</span><span class="p">;</span>
		<span class="nv">$offset</span> <span class="o">=</span> <span class="nb">hex</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>is this a call site to mcount? If so, record it to print later</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$text_found</span> <span class="o">&amp;&amp;</span> <span class="sr">/$mcount_regex/</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">push</span><span class="p">(</span><span class="nv">@offsets</span><span class="p">,</span> <span class="p">(</span><span class="nb">hex</span> <span class="nv">$1</span><span class="p">)</span> <span class="o">+</span> <span class="nv">$mcount_adjust</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>dump out anymore offsets that may have been found</p></td><td class="code"><div class="highlight"><pre><span class="n">update_funcs</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>If we did not find any mcount callers, we are done (do nothing).</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$opened</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">close</span><span class="p">(</span><span class="n">FILE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>Step 3: Compile the file that holds the list of call sites to mcount.</p></td><td class="code"><div class="highlight"><pre><span class="sb">`$cc -o $mcount_o -c $mcount_s`</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">@converts</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%convert</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>Step 4: Do we have sections that started with local functions?</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nv">$#converts</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$globallist</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$locallist</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$con</span> <span class="p">(</span><span class="nv">@converts</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$globallist</span> <span class="o">.=</span> <span class="s">&quot; --globalize-symbol $con&quot;</span><span class="p">;</span>
	<span class="nv">$locallist</span> <span class="o">.=</span> <span class="s">&quot; --localize-symbol $con&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$globalobj</span> <span class="o">=</span> <span class="nv">$dirname</span> <span class="o">.</span> <span class="s">&quot;/.tmp_gl_&quot;</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$globalmix</span> <span class="o">=</span> <span class="nv">$dirname</span> <span class="o">.</span> <span class="s">&quot;/.tmp_mx_&quot;</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>Step 5: set up each local function as a global</p></td><td class="code"><div class="highlight"><pre>    <span class="sb">`$objcopy $globallist $inputfile $globalobj`</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>Step 6: Link the global version to our list.</p></td><td class="code"><div class="highlight"><pre>    <span class="sb">`$ld -r $globalobj $mcount_o -o $globalmix`</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>Step 7: Convert the local functions back into local symbols</p></td><td class="code"><div class="highlight"><pre>    <span class="sb">`$objcopy $locallist $globalmix $inputfile`</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>Remove the temp files</p></td><td class="code"><div class="highlight"><pre>    <span class="sb">`$rm $globalobj $globalmix`</span><span class="p">;</span>

<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

    <span class="k">my</span> <span class="nv">$mix</span> <span class="o">=</span> <span class="nv">$dirname</span> <span class="o">.</span> <span class="s">&quot;/.tmp_mx_&quot;</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>Step 8: Link the object with our list of call sites object.</p></td><td class="code"><div class="highlight"><pre>    <span class="sb">`$ld -r $inputfile $mcount_o -o $mix`</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>Step 9: Move the result back to the original object.</p></td><td class="code"><div class="highlight"><pre>    <span class="sb">`$mv $mix $inputfile`</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>Clean up the temp files</p></td><td class="code"><div class="highlight"><pre><span class="sb">`$rm $mcount_o $mcount_s`</span><span class="p">;</span>

<span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
