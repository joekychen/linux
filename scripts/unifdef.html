<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › unifdef.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>unifdef.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2002 - 2011 Tony Finch &lt;dot@dotat.at&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *    documentation and/or other materials provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&#39;&#39; AND</span>
<span class="cm"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE</span>
<span class="cm"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<span class="cm"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="cm"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<span class="cm"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<span class="cm"> * SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * unifdef - remove ifdef&#39;ed lines</span>
<span class="cm"> *</span>
<span class="cm"> * This code was derived from software contributed to Berkeley by Dave Yost.</span>
<span class="cm"> * It was rewritten to support ANSI C by Tony Finch. The original version</span>
<span class="cm"> * of unifdef carried the 4-clause BSD copyright licence. None of its code</span>
<span class="cm"> * remains in this version (though some of the names remain) so it now</span>
<span class="cm"> * carries a more liberal licence.</span>
<span class="cm"> *</span>
<span class="cm"> *  Wishlist:</span>
<span class="cm"> *      provide an option which will append the name of the</span>
<span class="cm"> *        appropriate symbol after #else&#39;s and #endif&#39;s</span>
<span class="cm"> *      provide an option which will check symbols after</span>
<span class="cm"> *        #else&#39;s and #endif&#39;s to see that they match their</span>
<span class="cm"> *        corresponding #ifdef or #ifndef</span>
<span class="cm"> *</span>
<span class="cm"> *   These require better buffer handling, which would also make</span>
<span class="cm"> *   it possible to handle all &quot;dodgy&quot; directives correctly.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>

<span class="cp">#include &lt;ctype.h&gt;</span>
<span class="cp">#include &lt;err.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &lt;stdbool.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>

<span class="k">const</span> <span class="kt">char</span> <span class="n">copyright</span><span class="p">[]</span> <span class="o">=</span>
    <span class="s">&quot;@(#) $Version: unifdef-2.5 $</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;@(#) $Author: Tony Finch (dot@dotat.at) $</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;@(#) $URL: http://dotat.at/prog/unifdef $</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="p">;</span>

<span class="cm">/* types of input lines: */</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">LT_TRUEI</span><span class="p">,</span>		<span class="cm">/* a true #if with ignore flag */</span>
	<span class="n">LT_FALSEI</span><span class="p">,</span>		<span class="cm">/* a false #if with ignore flag */</span>
	<span class="n">LT_IF</span><span class="p">,</span>			<span class="cm">/* an unknown #if */</span>
	<span class="n">LT_TRUE</span><span class="p">,</span>		<span class="cm">/* a true #if */</span>
	<span class="n">LT_FALSE</span><span class="p">,</span>		<span class="cm">/* a false #if */</span>
	<span class="n">LT_ELIF</span><span class="p">,</span>		<span class="cm">/* an unknown #elif */</span>
	<span class="n">LT_ELTRUE</span><span class="p">,</span>		<span class="cm">/* a true #elif */</span>
	<span class="n">LT_ELFALSE</span><span class="p">,</span>		<span class="cm">/* a false #elif */</span>
	<span class="n">LT_ELSE</span><span class="p">,</span>		<span class="cm">/* #else */</span>
	<span class="n">LT_ENDIF</span><span class="p">,</span>		<span class="cm">/* #endif */</span>
	<span class="n">LT_DODGY</span><span class="p">,</span>		<span class="cm">/* flag: directive is not on one line */</span>
	<span class="n">LT_DODGY_LAST</span> <span class="o">=</span> <span class="n">LT_DODGY</span> <span class="o">+</span> <span class="n">LT_ENDIF</span><span class="p">,</span>
	<span class="n">LT_PLAIN</span><span class="p">,</span>		<span class="cm">/* ordinary line */</span>
	<span class="n">LT_EOF</span><span class="p">,</span>			<span class="cm">/* end of file */</span>
	<span class="n">LT_ERROR</span><span class="p">,</span>		<span class="cm">/* unevaluable #if */</span>
	<span class="n">LT_COUNT</span>
<span class="p">}</span> <span class="n">Linetype</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="k">const</span> <span class="n">linetype_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;TRUEI&quot;</span><span class="p">,</span> <span class="s">&quot;FALSEI&quot;</span><span class="p">,</span> <span class="s">&quot;IF&quot;</span><span class="p">,</span> <span class="s">&quot;TRUE&quot;</span><span class="p">,</span> <span class="s">&quot;FALSE&quot;</span><span class="p">,</span>
	<span class="s">&quot;ELIF&quot;</span><span class="p">,</span> <span class="s">&quot;ELTRUE&quot;</span><span class="p">,</span> <span class="s">&quot;ELFALSE&quot;</span><span class="p">,</span> <span class="s">&quot;ELSE&quot;</span><span class="p">,</span> <span class="s">&quot;ENDIF&quot;</span><span class="p">,</span>
	<span class="s">&quot;DODGY TRUEI&quot;</span><span class="p">,</span> <span class="s">&quot;DODGY FALSEI&quot;</span><span class="p">,</span>
	<span class="s">&quot;DODGY IF&quot;</span><span class="p">,</span> <span class="s">&quot;DODGY TRUE&quot;</span><span class="p">,</span> <span class="s">&quot;DODGY FALSE&quot;</span><span class="p">,</span>
	<span class="s">&quot;DODGY ELIF&quot;</span><span class="p">,</span> <span class="s">&quot;DODGY ELTRUE&quot;</span><span class="p">,</span> <span class="s">&quot;DODGY ELFALSE&quot;</span><span class="p">,</span>
	<span class="s">&quot;DODGY ELSE&quot;</span><span class="p">,</span> <span class="s">&quot;DODGY ENDIF&quot;</span><span class="p">,</span>
	<span class="s">&quot;PLAIN&quot;</span><span class="p">,</span> <span class="s">&quot;EOF&quot;</span><span class="p">,</span> <span class="s">&quot;ERROR&quot;</span>
<span class="p">};</span>

<span class="cm">/* state of #if processing */</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">IS_OUTSIDE</span><span class="p">,</span>
	<span class="n">IS_FALSE_PREFIX</span><span class="p">,</span>	<span class="cm">/* false #if followed by false #elifs */</span>
	<span class="n">IS_TRUE_PREFIX</span><span class="p">,</span>		<span class="cm">/* first non-false #(el)if is true */</span>
	<span class="n">IS_PASS_MIDDLE</span><span class="p">,</span>		<span class="cm">/* first non-false #(el)if is unknown */</span>
	<span class="n">IS_FALSE_MIDDLE</span><span class="p">,</span>	<span class="cm">/* a false #elif after a pass state */</span>
	<span class="n">IS_TRUE_MIDDLE</span><span class="p">,</span>		<span class="cm">/* a true #elif after a pass state */</span>
	<span class="n">IS_PASS_ELSE</span><span class="p">,</span>		<span class="cm">/* an else after a pass state */</span>
	<span class="n">IS_FALSE_ELSE</span><span class="p">,</span>		<span class="cm">/* an else after a true state */</span>
	<span class="n">IS_TRUE_ELSE</span><span class="p">,</span>		<span class="cm">/* an else after only false states */</span>
	<span class="n">IS_FALSE_TRAILER</span><span class="p">,</span>	<span class="cm">/* #elifs after a true are false */</span>
	<span class="n">IS_COUNT</span>
<span class="p">}</span> <span class="n">Ifstate</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="k">const</span> <span class="n">ifstate_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;OUTSIDE&quot;</span><span class="p">,</span> <span class="s">&quot;FALSE_PREFIX&quot;</span><span class="p">,</span> <span class="s">&quot;TRUE_PREFIX&quot;</span><span class="p">,</span>
	<span class="s">&quot;PASS_MIDDLE&quot;</span><span class="p">,</span> <span class="s">&quot;FALSE_MIDDLE&quot;</span><span class="p">,</span> <span class="s">&quot;TRUE_MIDDLE&quot;</span><span class="p">,</span>
	<span class="s">&quot;PASS_ELSE&quot;</span><span class="p">,</span> <span class="s">&quot;FALSE_ELSE&quot;</span><span class="p">,</span> <span class="s">&quot;TRUE_ELSE&quot;</span><span class="p">,</span>
	<span class="s">&quot;FALSE_TRAILER&quot;</span>
<span class="p">};</span>

<span class="cm">/* state of comment parser */</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">NO_COMMENT</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>	<span class="cm">/* outside a comment */</span>
	<span class="n">C_COMMENT</span><span class="p">,</span>		<span class="cm">/* in a comment like this one */</span>
	<span class="n">CXX_COMMENT</span><span class="p">,</span>		<span class="cm">/* between // and end of line */</span>
	<span class="n">STARTING_COMMENT</span><span class="p">,</span>	<span class="cm">/* just after slash-backslash-newline */</span>
	<span class="n">FINISHING_COMMENT</span><span class="p">,</span>	<span class="cm">/* star-backslash-newline in a C comment */</span>
	<span class="n">CHAR_LITERAL</span><span class="p">,</span>		<span class="cm">/* inside &#39;&#39; */</span>
	<span class="n">STRING_LITERAL</span>		<span class="cm">/* inside &quot;&quot; */</span>
<span class="p">}</span> <span class="n">Comment_state</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="k">const</span> <span class="n">comment_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;NO&quot;</span><span class="p">,</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CXX&quot;</span><span class="p">,</span> <span class="s">&quot;STARTING&quot;</span><span class="p">,</span> <span class="s">&quot;FINISHING&quot;</span><span class="p">,</span> <span class="s">&quot;CHAR&quot;</span><span class="p">,</span> <span class="s">&quot;STRING&quot;</span>
<span class="p">};</span>

<span class="cm">/* state of preprocessor line parser */</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">LS_START</span><span class="p">,</span>		<span class="cm">/* only space and comments on this line */</span>
	<span class="n">LS_HASH</span><span class="p">,</span>		<span class="cm">/* only space, comments, and a hash */</span>
	<span class="n">LS_DIRTY</span>		<span class="cm">/* this line can&#39;t be a preprocessor line */</span>
<span class="p">}</span> <span class="n">Line_state</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="k">const</span> <span class="n">linestate_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;START&quot;</span><span class="p">,</span> <span class="s">&quot;HASH&quot;</span><span class="p">,</span> <span class="s">&quot;DIRTY&quot;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Minimum translation limits from ISO/IEC 9899:1999 5.2.4.1</span>
<span class="cm"> */</span>
<span class="cp">#define	MAXDEPTH        64			</span><span class="cm">/* maximum #if nesting */</span><span class="cp"></span>
<span class="cp">#define	MAXLINE         4096			</span><span class="cm">/* maximum length of line */</span><span class="cp"></span>
<span class="cp">#define	MAXSYMS         4096			</span><span class="cm">/* maximum number of symbols */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Sometimes when editing a keyword the replacement text is longer, so</span>
<span class="cm"> * we leave some space at the end of the tline buffer to accommodate this.</span>
<span class="cm"> */</span>
<span class="cp">#define	EDITSLOP        10</span>

<span class="cm">/*</span>
<span class="cm"> * For temporary filenames</span>
<span class="cm"> */</span>
<span class="cp">#define TEMPLATE        &quot;unifdef.XXXXXX&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Globals.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">bool</span>             <span class="n">compblank</span><span class="p">;</span>		<span class="cm">/* -B: compress blank lines */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">lnblank</span><span class="p">;</span>		<span class="cm">/* -b: blank deleted lines */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">complement</span><span class="p">;</span>		<span class="cm">/* -c: do the complement */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">debugging</span><span class="p">;</span>		<span class="cm">/* -d: debugging reports */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">iocccok</span><span class="p">;</span>		<span class="cm">/* -e: fewer IOCCC errors */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">strictlogic</span><span class="p">;</span>		<span class="cm">/* -K: keep ambiguous #ifs */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">killconsts</span><span class="p">;</span>		<span class="cm">/* -k: eval constant #ifs */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">lnnum</span><span class="p">;</span>			<span class="cm">/* -n: add #line directives */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">symlist</span><span class="p">;</span>		<span class="cm">/* -s: output symbol list */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">symdepth</span><span class="p">;</span>		<span class="cm">/* -S: output symbol depth */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">text</span><span class="p">;</span>			<span class="cm">/* -t: this is a text file */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>      <span class="o">*</span><span class="n">symname</span><span class="p">[</span><span class="n">MAXSYMS</span><span class="p">];</span>	<span class="cm">/* symbol name */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>      <span class="o">*</span><span class="n">value</span><span class="p">[</span><span class="n">MAXSYMS</span><span class="p">];</span>		<span class="cm">/* -Dsym=value */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">ignore</span><span class="p">[</span><span class="n">MAXSYMS</span><span class="p">];</span>	<span class="cm">/* -iDsym or -iUsym */</span>
<span class="k">static</span> <span class="kt">int</span>              <span class="n">nsyms</span><span class="p">;</span>			<span class="cm">/* number of symbols */</span>

<span class="k">static</span> <span class="kt">FILE</span>            <span class="o">*</span><span class="n">input</span><span class="p">;</span>			<span class="cm">/* input file pointer */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>      <span class="o">*</span><span class="n">filename</span><span class="p">;</span>		<span class="cm">/* input file name */</span>
<span class="k">static</span> <span class="kt">int</span>              <span class="n">linenum</span><span class="p">;</span>		<span class="cm">/* current line number */</span>
<span class="k">static</span> <span class="kt">FILE</span>            <span class="o">*</span><span class="n">output</span><span class="p">;</span>			<span class="cm">/* output file pointer */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>      <span class="o">*</span><span class="n">ofilename</span><span class="p">;</span>		<span class="cm">/* output file name */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">overwriting</span><span class="p">;</span>		<span class="cm">/* output overwrites input */</span>
<span class="k">static</span> <span class="kt">char</span>             <span class="n">tempname</span><span class="p">[</span><span class="n">FILENAME_MAX</span><span class="p">];</span>	<span class="cm">/* used when overwriting */</span>

<span class="k">static</span> <span class="kt">char</span>             <span class="n">tline</span><span class="p">[</span><span class="n">MAXLINE</span><span class="o">+</span><span class="n">EDITSLOP</span><span class="p">];</span><span class="cm">/* input buffer plus space */</span>
<span class="k">static</span> <span class="kt">char</span>            <span class="o">*</span><span class="n">keyword</span><span class="p">;</span>		<span class="cm">/* used for editing #elif&#39;s */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>      <span class="o">*</span><span class="n">newline</span><span class="p">;</span>		<span class="cm">/* input file format */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>       <span class="n">newline_unix</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>       <span class="n">newline_crlf</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="n">Comment_state</span>    <span class="n">incomment</span><span class="p">;</span>		<span class="cm">/* comment parser state */</span>
<span class="k">static</span> <span class="n">Line_state</span>       <span class="n">linestate</span><span class="p">;</span>		<span class="cm">/* #if line parser state */</span>
<span class="k">static</span> <span class="n">Ifstate</span>          <span class="n">ifstate</span><span class="p">[</span><span class="n">MAXDEPTH</span><span class="p">];</span>	<span class="cm">/* #if processor state */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">ignoring</span><span class="p">[</span><span class="n">MAXDEPTH</span><span class="p">];</span>	<span class="cm">/* ignore comments state */</span>
<span class="k">static</span> <span class="kt">int</span>              <span class="n">stifline</span><span class="p">[</span><span class="n">MAXDEPTH</span><span class="p">];</span>	<span class="cm">/* start of current #if */</span>
<span class="k">static</span> <span class="kt">int</span>              <span class="n">depth</span><span class="p">;</span>			<span class="cm">/* current #if nesting */</span>
<span class="k">static</span> <span class="kt">int</span>              <span class="n">delcount</span><span class="p">;</span>		<span class="cm">/* count of deleted lines */</span>
<span class="k">static</span> <span class="kt">unsigned</span>         <span class="n">blankcount</span><span class="p">;</span>		<span class="cm">/* count of blank lines */</span>
<span class="k">static</span> <span class="kt">unsigned</span>         <span class="n">blankmax</span><span class="p">;</span>		<span class="cm">/* maximum recent blankcount */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">constexpr</span><span class="p">;</span>		<span class="cm">/* constant #if expression */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">zerosyms</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>	<span class="cm">/* to format symdepth output */</span>
<span class="k">static</span> <span class="n">bool</span>             <span class="n">firstsym</span><span class="p">;</span>		<span class="cm">/* ditto */</span>

<span class="k">static</span> <span class="kt">int</span>              <span class="n">exitstat</span><span class="p">;</span>		<span class="cm">/* program exit status */</span>

<span class="k">static</span> <span class="kt">void</span>             <span class="n">addsym</span><span class="p">(</span><span class="n">bool</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>             <span class="n">closeout</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>             <span class="n">debug</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="p">...);</span>
<span class="k">static</span> <span class="kt">void</span>             <span class="n">done</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>             <span class="n">error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>              <span class="n">findsym</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>             <span class="n">flushline</span><span class="p">(</span><span class="n">bool</span><span class="p">);</span>
<span class="k">static</span> <span class="n">Linetype</span>         <span class="n">parseline</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="n">Linetype</span>         <span class="n">ifeval</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>             <span class="n">ignoreoff</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>             <span class="n">ignoreon</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>             <span class="n">keywordedit</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>             <span class="n">nest</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>             <span class="n">process</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>      <span class="o">*</span><span class="n">skipargs</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>      <span class="o">*</span><span class="n">skipcomment</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>      <span class="o">*</span><span class="n">skipsym</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>             <span class="n">state</span><span class="p">(</span><span class="n">Ifstate</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>              <span class="n">strlcmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>             <span class="n">unnest</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>             <span class="n">usage</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>             <span class="n">version</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#define endsym(c) (!isalnum((unsigned char)c) &amp;&amp; c != &#39;_&#39;)</span>

<span class="cm">/*</span>
<span class="cm"> * The main program.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">opt</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">opt</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;i:D:U:I:o:bBcdeKklnsStV&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;i&#39;</span>: <span class="cm">/* treat stuff controlled by these symbols as text */</span>
			<span class="cm">/*</span>
<span class="cm">			 * For strict backwards-compatibility the U or D</span>
<span class="cm">			 * should be immediately after the -i but it doesn&#39;t</span>
<span class="cm">			 * matter much if we relax that requirement.</span>
<span class="cm">			 */</span>
			<span class="n">opt</span> <span class="o">=</span> <span class="o">*</span><span class="n">optarg</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">==</span> <span class="sc">&#39;D&#39;</span><span class="p">)</span>
				<span class="n">addsym</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">==</span> <span class="sc">&#39;U&#39;</span><span class="p">)</span>
				<span class="n">addsym</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">usage</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;D&#39;</span>: <span class="cm">/* define a symbol */</span>
			<span class="n">addsym</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;U&#39;</span>: <span class="cm">/* undef a symbol */</span>
			<span class="n">addsym</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;I&#39;</span>: <span class="cm">/* no-op for compatibility with cpp */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;b&#39;</span>: <span class="cm">/* blank deleted lines instead of omitting them */</span>
		<span class="k">case</span> <span class="sc">&#39;l&#39;</span>: <span class="cm">/* backwards compatibility */</span>
			<span class="n">lnblank</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;B&#39;</span>: <span class="cm">/* compress blank lines around removed section */</span>
			<span class="n">compblank</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span>: <span class="cm">/* treat -D as -U and vice versa */</span>
			<span class="n">complement</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="n">debugging</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;e&#39;</span>: <span class="cm">/* fewer errors from dodgy lines */</span>
			<span class="n">iocccok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;K&#39;</span>: <span class="cm">/* keep ambiguous #ifs */</span>
			<span class="n">strictlogic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;k&#39;</span>: <span class="cm">/* process constant #ifs */</span>
			<span class="n">killconsts</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;n&#39;</span>: <span class="cm">/* add #line directive after deleted lines */</span>
			<span class="n">lnnum</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;o&#39;</span>: <span class="cm">/* output to a file */</span>
			<span class="n">ofilename</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>: <span class="cm">/* only output list of symbols that control #ifs */</span>
			<span class="n">symlist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;S&#39;</span>: <span class="cm">/* list symbols with their nesting depth */</span>
			<span class="n">symlist</span> <span class="o">=</span> <span class="n">symdepth</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;t&#39;</span>: <span class="cm">/* don&#39;t parse C comments */</span>
			<span class="n">text</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;V&#39;</span>: <span class="cm">/* print version */</span>
			<span class="n">version</span><span class="p">();</span>
		<span class="nl">default:</span>
			<span class="n">usage</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="n">argc</span> <span class="o">-=</span> <span class="n">optind</span><span class="p">;</span>
	<span class="n">argv</span> <span class="o">+=</span> <span class="n">optind</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">compblank</span> <span class="o">&amp;&amp;</span> <span class="n">lnblank</span><span class="p">)</span>
		<span class="n">errx</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;-B and -b are mutually exclusive&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errx</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;can only do one file&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>
		<span class="n">input</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">err</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;can&#39;t open %s&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;[stdin]&quot;</span><span class="p">;</span>
		<span class="n">input</span> <span class="o">=</span> <span class="n">stdin</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofilename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ofilename</span> <span class="o">=</span> <span class="s">&quot;[stdout]&quot;</span><span class="p">;</span>
		<span class="n">output</span> <span class="o">=</span> <span class="n">stdout</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">stat</span> <span class="n">ist</span><span class="p">,</span> <span class="n">ost</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">ofilename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ost</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fstat</span><span class="p">(</span><span class="n">fileno</span><span class="p">(</span><span class="n">input</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">overwriting</span> <span class="o">=</span> <span class="p">(</span><span class="n">ist</span><span class="p">.</span><span class="n">st_dev</span> <span class="o">==</span> <span class="n">ost</span><span class="p">.</span><span class="n">st_dev</span>
				    <span class="o">&amp;&amp;</span> <span class="n">ist</span><span class="p">.</span><span class="n">st_ino</span> <span class="o">==</span> <span class="n">ost</span><span class="p">.</span><span class="n">st_ino</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">overwriting</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dirsep</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">ofd</span><span class="p">;</span>

			<span class="n">dirsep</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">ofilename</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dirsep</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">tempname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tempname</span><span class="p">),</span>
				    <span class="s">&quot;%.*s/&quot;</span> <span class="n">TEMPLATE</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">dirsep</span> <span class="o">-</span> <span class="n">ofilename</span><span class="p">),</span> <span class="n">ofilename</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">tempname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tempname</span><span class="p">),</span>
				    <span class="n">TEMPLATE</span><span class="p">);</span>
			<span class="n">ofd</span> <span class="o">=</span> <span class="n">mkstemp</span><span class="p">(</span><span class="n">tempname</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ofd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">output</span> <span class="o">=</span> <span class="n">fdopen</span><span class="p">(</span><span class="n">ofd</span><span class="p">,</span> <span class="s">&quot;wb+&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">output</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">err</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;can&#39;t create temporary file&quot;</span><span class="p">);</span>
			<span class="n">fchmod</span><span class="p">(</span><span class="n">ofd</span><span class="p">,</span> <span class="n">ist</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">S_IRWXU</span><span class="o">|</span><span class="n">S_IRWXG</span><span class="o">|</span><span class="n">S_IRWXO</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">output</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">ofilename</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">output</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">err</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;can&#39;t open %s&quot;</span><span class="p">,</span> <span class="n">ofilename</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">process</span><span class="p">();</span>
	<span class="n">abort</span><span class="p">();</span> <span class="cm">/* bug */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">copyright</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*++</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;$&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
				<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*++</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;$&#39;</span><span class="p">)</span>
			<span class="n">putc</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
		<span class="n">putc</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">usage</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;usage: unifdef [-bBcdeKknsStV] [-Ipath]&quot;</span>
	    <span class="s">&quot; [-Dsym[=val]] [-Usym] [-iDsym[=val]] [-iUsym] ... [file]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * A state transition function alters the global #if processing state</span>
<span class="cm"> * in a particular way. The table below is indexed by the current</span>
<span class="cm"> * processing state and the type of the current line.</span>
<span class="cm"> *</span>
<span class="cm"> * Nesting is handled by keeping a stack of states; some transition</span>
<span class="cm"> * functions increase or decrease the depth. They also maintain the</span>
<span class="cm"> * ignore state on a stack. In some complicated cases they have to</span>
<span class="cm"> * alter the preprocessor directive, as follows.</span>
<span class="cm"> *</span>
<span class="cm"> * When we have processed a group that starts off with a known-false</span>
<span class="cm"> * #if/#elif sequence (which has therefore been deleted) followed by a</span>
<span class="cm"> * #elif that we don&#39;t understand and therefore must keep, we edit the</span>
<span class="cm"> * latter into a #if to keep the nesting correct. We use strncpy() to</span>
<span class="cm"> * overwrite the 4 byte token &quot;elif&quot; with &quot;if  &quot; without a &#39;\0&#39; byte.</span>
<span class="cm"> *</span>
<span class="cm"> * When we find a true #elif in a group, the following block will</span>
<span class="cm"> * always be kept and the rest of the sequence after the next #elif or</span>
<span class="cm"> * #else will be discarded. We edit the #elif into a #else and the</span>
<span class="cm"> * following directive to #endif since this has the desired behaviour.</span>
<span class="cm"> *</span>
<span class="cm"> * &quot;Dodgy&quot; directives are split across multiple lines, the most common</span>
<span class="cm"> * example being a multi-line comment hanging off the right of the</span>
<span class="cm"> * directive. We can handle them correctly only if there is no change</span>
<span class="cm"> * from printing to dropping (or vice versa) caused by that directive.</span>
<span class="cm"> * If the directive is the first of a group we have a choice between</span>
<span class="cm"> * failing with an error, or passing it through unchanged instead of</span>
<span class="cm"> * evaluating it. The latter is not the default to avoid questions from</span>
<span class="cm"> * users about unifdef unexpectedly leaving behind preprocessor directives.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="n">state_fn</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* report an error */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Eelif</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;Inappropriate #elif&quot;</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Eelse</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;Inappropriate #else&quot;</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Eendif</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;Inappropriate #endif&quot;</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Eeof</span>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;Premature EOF&quot;</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Eioccc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;Obfuscated preprocessor control line&quot;</span><span class="p">);</span> <span class="p">}</span>
<span class="cm">/* plain line handling */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">flushline</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drop</span>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">flushline</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span> <span class="p">}</span>
<span class="cm">/* output lacks group&#39;s start line */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Strue</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">drop</span><span class="p">();</span>  <span class="n">ignoreoff</span><span class="p">();</span> <span class="n">state</span><span class="p">(</span><span class="n">IS_TRUE_PREFIX</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Sfalse</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">drop</span><span class="p">();</span>  <span class="n">ignoreoff</span><span class="p">();</span> <span class="n">state</span><span class="p">(</span><span class="n">IS_FALSE_PREFIX</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Selse</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">drop</span><span class="p">();</span>               <span class="n">state</span><span class="p">(</span><span class="n">IS_TRUE_ELSE</span><span class="p">);</span> <span class="p">}</span>
<span class="cm">/* print/pass this block */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Pelif</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">print</span><span class="p">();</span> <span class="n">ignoreoff</span><span class="p">();</span> <span class="n">state</span><span class="p">(</span><span class="n">IS_PASS_MIDDLE</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Pelse</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">print</span><span class="p">();</span>              <span class="n">state</span><span class="p">(</span><span class="n">IS_PASS_ELSE</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Pendif</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">print</span><span class="p">();</span> <span class="n">unnest</span><span class="p">();</span> <span class="p">}</span>
<span class="cm">/* discard this block */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Dfalse</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">drop</span><span class="p">();</span>  <span class="n">ignoreoff</span><span class="p">();</span> <span class="n">state</span><span class="p">(</span><span class="n">IS_FALSE_TRAILER</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Delif</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">drop</span><span class="p">();</span>  <span class="n">ignoreoff</span><span class="p">();</span> <span class="n">state</span><span class="p">(</span><span class="n">IS_FALSE_MIDDLE</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Delse</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">drop</span><span class="p">();</span>               <span class="n">state</span><span class="p">(</span><span class="n">IS_FALSE_ELSE</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Dendif</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">drop</span><span class="p">();</span>  <span class="n">unnest</span><span class="p">();</span> <span class="p">}</span>
<span class="cm">/* first line of group */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Fdrop</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">nest</span><span class="p">();</span>  <span class="n">Dfalse</span><span class="p">();</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Fpass</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">nest</span><span class="p">();</span>  <span class="n">Pelif</span><span class="p">();</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Ftrue</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">nest</span><span class="p">();</span>  <span class="n">Strue</span><span class="p">();</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Ffalse</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">nest</span><span class="p">();</span>  <span class="n">Sfalse</span><span class="p">();</span> <span class="p">}</span>
<span class="cm">/* variable pedantry for obfuscated lines */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Oiffy</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iocccok</span><span class="p">)</span> <span class="n">Eioccc</span><span class="p">();</span> <span class="n">Fpass</span><span class="p">();</span> <span class="n">ignoreon</span><span class="p">();</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Oif</span>   <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iocccok</span><span class="p">)</span> <span class="n">Eioccc</span><span class="p">();</span> <span class="n">Fpass</span><span class="p">();</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Oelif</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iocccok</span><span class="p">)</span> <span class="n">Eioccc</span><span class="p">();</span> <span class="n">Pelif</span><span class="p">();</span> <span class="p">}</span>
<span class="cm">/* ignore comments in this block */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Idrop</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">Fdrop</span><span class="p">();</span>  <span class="n">ignoreon</span><span class="p">();</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Itrue</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">Ftrue</span><span class="p">();</span>  <span class="n">ignoreon</span><span class="p">();</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Ifalse</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">Ffalse</span><span class="p">();</span> <span class="n">ignoreon</span><span class="p">();</span> <span class="p">}</span>
<span class="cm">/* modify this line */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Mpass</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">strncpy</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="s">&quot;if  &quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="n">Pelif</span><span class="p">();</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Mtrue</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">keywordedit</span><span class="p">(</span><span class="s">&quot;else&quot;</span><span class="p">);</span>  <span class="n">state</span><span class="p">(</span><span class="n">IS_TRUE_MIDDLE</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Melif</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">keywordedit</span><span class="p">(</span><span class="s">&quot;endif&quot;</span><span class="p">);</span> <span class="n">state</span><span class="p">(</span><span class="n">IS_FALSE_TRAILER</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">Melse</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="n">keywordedit</span><span class="p">(</span><span class="s">&quot;endif&quot;</span><span class="p">);</span> <span class="n">state</span><span class="p">(</span><span class="n">IS_FALSE_ELSE</span><span class="p">);</span> <span class="p">}</span>

<span class="k">static</span> <span class="n">state_fn</span> <span class="o">*</span> <span class="k">const</span> <span class="n">trans_table</span><span class="p">[</span><span class="n">IS_COUNT</span><span class="p">][</span><span class="n">LT_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* IS_OUTSIDE */</span>
<span class="p">{</span> <span class="n">Itrue</span><span class="p">,</span> <span class="n">Ifalse</span><span class="p">,</span><span class="n">Fpass</span><span class="p">,</span> <span class="n">Ftrue</span><span class="p">,</span> <span class="n">Ffalse</span><span class="p">,</span><span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelse</span><span class="p">,</span> <span class="n">Eendif</span><span class="p">,</span>
  <span class="n">Oiffy</span><span class="p">,</span> <span class="n">Oiffy</span><span class="p">,</span> <span class="n">Fpass</span><span class="p">,</span> <span class="n">Oif</span><span class="p">,</span>   <span class="n">Oif</span><span class="p">,</span>   <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelse</span><span class="p">,</span> <span class="n">Eendif</span><span class="p">,</span>
  <span class="n">print</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span>  <span class="n">abort</span> <span class="p">},</span>
<span class="cm">/* IS_FALSE_PREFIX */</span>
<span class="p">{</span> <span class="n">Idrop</span><span class="p">,</span> <span class="n">Idrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Mpass</span><span class="p">,</span> <span class="n">Strue</span><span class="p">,</span> <span class="n">Sfalse</span><span class="p">,</span><span class="n">Selse</span><span class="p">,</span> <span class="n">Dendif</span><span class="p">,</span>
  <span class="n">Idrop</span><span class="p">,</span> <span class="n">Idrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Mpass</span><span class="p">,</span> <span class="n">Eioccc</span><span class="p">,</span><span class="n">Eioccc</span><span class="p">,</span><span class="n">Eioccc</span><span class="p">,</span><span class="n">Eioccc</span><span class="p">,</span>
  <span class="n">drop</span><span class="p">,</span>  <span class="n">Eeof</span><span class="p">,</span>  <span class="n">abort</span> <span class="p">},</span>
<span class="cm">/* IS_TRUE_PREFIX */</span>
<span class="p">{</span> <span class="n">Itrue</span><span class="p">,</span> <span class="n">Ifalse</span><span class="p">,</span><span class="n">Fpass</span><span class="p">,</span> <span class="n">Ftrue</span><span class="p">,</span> <span class="n">Ffalse</span><span class="p">,</span><span class="n">Dfalse</span><span class="p">,</span><span class="n">Dfalse</span><span class="p">,</span><span class="n">Dfalse</span><span class="p">,</span><span class="n">Delse</span><span class="p">,</span> <span class="n">Dendif</span><span class="p">,</span>
  <span class="n">Oiffy</span><span class="p">,</span> <span class="n">Oiffy</span><span class="p">,</span> <span class="n">Fpass</span><span class="p">,</span> <span class="n">Oif</span><span class="p">,</span>   <span class="n">Oif</span><span class="p">,</span>   <span class="n">Eioccc</span><span class="p">,</span><span class="n">Eioccc</span><span class="p">,</span><span class="n">Eioccc</span><span class="p">,</span><span class="n">Eioccc</span><span class="p">,</span><span class="n">Eioccc</span><span class="p">,</span>
  <span class="n">print</span><span class="p">,</span> <span class="n">Eeof</span><span class="p">,</span>  <span class="n">abort</span> <span class="p">},</span>
<span class="cm">/* IS_PASS_MIDDLE */</span>
<span class="p">{</span> <span class="n">Itrue</span><span class="p">,</span> <span class="n">Ifalse</span><span class="p">,</span><span class="n">Fpass</span><span class="p">,</span> <span class="n">Ftrue</span><span class="p">,</span> <span class="n">Ffalse</span><span class="p">,</span><span class="n">Pelif</span><span class="p">,</span> <span class="n">Mtrue</span><span class="p">,</span> <span class="n">Delif</span><span class="p">,</span> <span class="n">Pelse</span><span class="p">,</span> <span class="n">Pendif</span><span class="p">,</span>
  <span class="n">Oiffy</span><span class="p">,</span> <span class="n">Oiffy</span><span class="p">,</span> <span class="n">Fpass</span><span class="p">,</span> <span class="n">Oif</span><span class="p">,</span>   <span class="n">Oif</span><span class="p">,</span>   <span class="n">Pelif</span><span class="p">,</span> <span class="n">Oelif</span><span class="p">,</span> <span class="n">Oelif</span><span class="p">,</span> <span class="n">Pelse</span><span class="p">,</span> <span class="n">Pendif</span><span class="p">,</span>
  <span class="n">print</span><span class="p">,</span> <span class="n">Eeof</span><span class="p">,</span>  <span class="n">abort</span> <span class="p">},</span>
<span class="cm">/* IS_FALSE_MIDDLE */</span>
<span class="p">{</span> <span class="n">Idrop</span><span class="p">,</span> <span class="n">Idrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Pelif</span><span class="p">,</span> <span class="n">Mtrue</span><span class="p">,</span> <span class="n">Delif</span><span class="p">,</span> <span class="n">Pelse</span><span class="p">,</span> <span class="n">Pendif</span><span class="p">,</span>
  <span class="n">Idrop</span><span class="p">,</span> <span class="n">Idrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Eioccc</span><span class="p">,</span><span class="n">Eioccc</span><span class="p">,</span><span class="n">Eioccc</span><span class="p">,</span><span class="n">Eioccc</span><span class="p">,</span><span class="n">Eioccc</span><span class="p">,</span>
  <span class="n">drop</span><span class="p">,</span>  <span class="n">Eeof</span><span class="p">,</span>  <span class="n">abort</span> <span class="p">},</span>
<span class="cm">/* IS_TRUE_MIDDLE */</span>
<span class="p">{</span> <span class="n">Itrue</span><span class="p">,</span> <span class="n">Ifalse</span><span class="p">,</span><span class="n">Fpass</span><span class="p">,</span> <span class="n">Ftrue</span><span class="p">,</span> <span class="n">Ffalse</span><span class="p">,</span><span class="n">Melif</span><span class="p">,</span> <span class="n">Melif</span><span class="p">,</span> <span class="n">Melif</span><span class="p">,</span> <span class="n">Melse</span><span class="p">,</span> <span class="n">Pendif</span><span class="p">,</span>
  <span class="n">Oiffy</span><span class="p">,</span> <span class="n">Oiffy</span><span class="p">,</span> <span class="n">Fpass</span><span class="p">,</span> <span class="n">Oif</span><span class="p">,</span>   <span class="n">Oif</span><span class="p">,</span>   <span class="n">Eioccc</span><span class="p">,</span><span class="n">Eioccc</span><span class="p">,</span><span class="n">Eioccc</span><span class="p">,</span><span class="n">Eioccc</span><span class="p">,</span><span class="n">Pendif</span><span class="p">,</span>
  <span class="n">print</span><span class="p">,</span> <span class="n">Eeof</span><span class="p">,</span>  <span class="n">abort</span> <span class="p">},</span>
<span class="cm">/* IS_PASS_ELSE */</span>
<span class="p">{</span> <span class="n">Itrue</span><span class="p">,</span> <span class="n">Ifalse</span><span class="p">,</span><span class="n">Fpass</span><span class="p">,</span> <span class="n">Ftrue</span><span class="p">,</span> <span class="n">Ffalse</span><span class="p">,</span><span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelse</span><span class="p">,</span> <span class="n">Pendif</span><span class="p">,</span>
  <span class="n">Oiffy</span><span class="p">,</span> <span class="n">Oiffy</span><span class="p">,</span> <span class="n">Fpass</span><span class="p">,</span> <span class="n">Oif</span><span class="p">,</span>   <span class="n">Oif</span><span class="p">,</span>   <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelse</span><span class="p">,</span> <span class="n">Pendif</span><span class="p">,</span>
  <span class="n">print</span><span class="p">,</span> <span class="n">Eeof</span><span class="p">,</span>  <span class="n">abort</span> <span class="p">},</span>
<span class="cm">/* IS_FALSE_ELSE */</span>
<span class="p">{</span> <span class="n">Idrop</span><span class="p">,</span> <span class="n">Idrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelse</span><span class="p">,</span> <span class="n">Dendif</span><span class="p">,</span>
  <span class="n">Idrop</span><span class="p">,</span> <span class="n">Idrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelse</span><span class="p">,</span> <span class="n">Eioccc</span><span class="p">,</span>
  <span class="n">drop</span><span class="p">,</span>  <span class="n">Eeof</span><span class="p">,</span>  <span class="n">abort</span> <span class="p">},</span>
<span class="cm">/* IS_TRUE_ELSE */</span>
<span class="p">{</span> <span class="n">Itrue</span><span class="p">,</span> <span class="n">Ifalse</span><span class="p">,</span><span class="n">Fpass</span><span class="p">,</span> <span class="n">Ftrue</span><span class="p">,</span> <span class="n">Ffalse</span><span class="p">,</span><span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelse</span><span class="p">,</span> <span class="n">Dendif</span><span class="p">,</span>
  <span class="n">Oiffy</span><span class="p">,</span> <span class="n">Oiffy</span><span class="p">,</span> <span class="n">Fpass</span><span class="p">,</span> <span class="n">Oif</span><span class="p">,</span>   <span class="n">Oif</span><span class="p">,</span>   <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelif</span><span class="p">,</span> <span class="n">Eelse</span><span class="p">,</span> <span class="n">Eioccc</span><span class="p">,</span>
  <span class="n">print</span><span class="p">,</span> <span class="n">Eeof</span><span class="p">,</span>  <span class="n">abort</span> <span class="p">},</span>
<span class="cm">/* IS_FALSE_TRAILER */</span>
<span class="p">{</span> <span class="n">Idrop</span><span class="p">,</span> <span class="n">Idrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Dfalse</span><span class="p">,</span><span class="n">Dfalse</span><span class="p">,</span><span class="n">Dfalse</span><span class="p">,</span><span class="n">Delse</span><span class="p">,</span> <span class="n">Dendif</span><span class="p">,</span>
  <span class="n">Idrop</span><span class="p">,</span> <span class="n">Idrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Fdrop</span><span class="p">,</span> <span class="n">Dfalse</span><span class="p">,</span><span class="n">Dfalse</span><span class="p">,</span><span class="n">Dfalse</span><span class="p">,</span><span class="n">Delse</span><span class="p">,</span> <span class="n">Eioccc</span><span class="p">,</span>
  <span class="n">drop</span><span class="p">,</span>  <span class="n">Eeof</span><span class="p">,</span>  <span class="n">abort</span> <span class="p">}</span>
<span class="cm">/*TRUEI  FALSEI IF     TRUE   FALSE  ELIF   ELTRUE ELFALSE ELSE  ENDIF</span>
<span class="cm">  TRUEI  FALSEI IF     TRUE   FALSE  ELIF   ELTRUE ELFALSE ELSE  ENDIF (DODGY)</span>
<span class="cm">  PLAIN  EOF    ERROR */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * State machine utility functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ignoreoff</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">abort</span><span class="p">();</span> <span class="cm">/* bug */</span>
	<span class="n">ignoring</span><span class="p">[</span><span class="n">depth</span><span class="p">]</span> <span class="o">=</span> <span class="n">ignoring</span><span class="p">[</span><span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ignoreon</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ignoring</span><span class="p">[</span><span class="n">depth</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">keywordedit</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">replacement</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">tline</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tline</span><span class="p">)</span> <span class="o">-</span> <span class="n">keyword</span><span class="p">,</span>
	    <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">newline</span><span class="p">);</span>
	<span class="n">print</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nest</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="n">MAXDEPTH</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">abort</span><span class="p">();</span> <span class="cm">/* bug */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="n">MAXDEPTH</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">error</span><span class="p">(</span><span class="s">&quot;Too many levels of nesting&quot;</span><span class="p">);</span>
	<span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stifline</span><span class="p">[</span><span class="n">depth</span><span class="p">]</span> <span class="o">=</span> <span class="n">linenum</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">unnest</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">abort</span><span class="p">();</span> <span class="cm">/* bug */</span>
	<span class="n">depth</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">state</span><span class="p">(</span><span class="n">Ifstate</span> <span class="n">is</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ifstate</span><span class="p">[</span><span class="n">depth</span><span class="p">]</span> <span class="o">=</span> <span class="n">is</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write a line to the output or not, according to command line options.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">flushline</span><span class="p">(</span><span class="n">bool</span> <span class="n">keep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">symlist</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keep</span> <span class="o">^</span> <span class="n">complement</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">blankline</span> <span class="o">=</span> <span class="n">tline</span><span class="p">[</span><span class="n">strspn</span><span class="p">(</span><span class="n">tline</span><span class="p">,</span> <span class="s">&quot; </span><span class="se">\t\r\n</span><span class="s">&quot;</span><span class="p">)]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blankline</span> <span class="o">&amp;&amp;</span> <span class="n">compblank</span> <span class="o">&amp;&amp;</span> <span class="n">blankcount</span> <span class="o">!=</span> <span class="n">blankmax</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">delcount</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">blankcount</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lnnum</span> <span class="o">&amp;&amp;</span> <span class="n">delcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;#line %d%s&quot;</span><span class="p">,</span> <span class="n">linenum</span><span class="p">,</span> <span class="n">newline</span><span class="p">);</span>
			<span class="n">fputs</span><span class="p">(</span><span class="n">tline</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
			<span class="n">delcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">blankmax</span> <span class="o">=</span> <span class="n">blankcount</span> <span class="o">=</span> <span class="n">blankline</span> <span class="o">?</span> <span class="n">blankcount</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lnblank</span><span class="p">)</span>
			<span class="n">fputs</span><span class="p">(</span><span class="n">newline</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
		<span class="n">exitstat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">delcount</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">blankcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
		<span class="n">fflush</span><span class="p">(</span><span class="n">output</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The driver for the state machine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">process</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* When compressing blank lines, act as if the file</span>
<span class="cm">	   is preceded by a large number of blank lines. */</span>
	<span class="n">blankmax</span> <span class="o">=</span> <span class="n">blankcount</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">Linetype</span> <span class="n">lineval</span> <span class="o">=</span> <span class="n">parseline</span><span class="p">();</span>
		<span class="n">trans_table</span><span class="p">[</span><span class="n">ifstate</span><span class="p">[</span><span class="n">depth</span><span class="p">]][</span><span class="n">lineval</span><span class="p">]();</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;process line %d %s -&gt; %s depth %d&quot;</span><span class="p">,</span>
		    <span class="n">linenum</span><span class="p">,</span> <span class="n">linetype_name</span><span class="p">[</span><span class="n">lineval</span><span class="p">],</span>
		    <span class="n">ifstate_name</span><span class="p">[</span><span class="n">ifstate</span><span class="p">[</span><span class="n">depth</span><span class="p">]],</span> <span class="n">depth</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Flush the output and handle errors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">closeout</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">symdepth</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">zerosyms</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fclose</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warn</span><span class="p">(</span><span class="s">&quot;couldn&#39;t write to %s&quot;</span><span class="p">,</span> <span class="n">ofilename</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">overwriting</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">unlink</span><span class="p">(</span><span class="n">tempname</span><span class="p">);</span>
			<span class="n">errx</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s unchanged&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clean up and exit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">done</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">incomment</span><span class="p">)</span>
		<span class="n">error</span><span class="p">(</span><span class="s">&quot;EOF in comment&quot;</span><span class="p">);</span>
	<span class="n">closeout</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">overwriting</span> <span class="o">&amp;&amp;</span> <span class="n">rename</span><span class="p">(</span><span class="n">tempname</span><span class="p">,</span> <span class="n">ofilename</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warn</span><span class="p">(</span><span class="s">&quot;couldn&#39;t rename temporary file&quot;</span><span class="p">);</span>
		<span class="n">unlink</span><span class="p">(</span><span class="n">tempname</span><span class="p">);</span>
		<span class="n">errx</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s unchanged&quot;</span><span class="p">,</span> <span class="n">ofilename</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">exit</span><span class="p">(</span><span class="n">exitstat</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse a line and determine its type. We keep the preprocessor line</span>
<span class="cm"> * parser state between calls in the global variable linestate, with</span>
<span class="cm"> * help from skipcomment().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">Linetype</span>
<span class="nf">parseline</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cursym</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">kwlen</span><span class="p">;</span>
	<span class="n">Linetype</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">Comment_state</span> <span class="n">wascomment</span><span class="p">;</span>

	<span class="n">linenum</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">tline</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">,</span> <span class="n">input</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">LT_EOF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newline</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strrchr</span><span class="p">(</span><span class="n">tline</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">tline</span><span class="p">,</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">newline</span> <span class="o">=</span> <span class="n">newline_crlf</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">newline</span> <span class="o">=</span> <span class="n">newline_unix</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">LT_PLAIN</span><span class="p">;</span>
	<span class="n">wascomment</span> <span class="o">=</span> <span class="n">incomment</span><span class="p">;</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">skipcomment</span><span class="p">(</span><span class="n">tline</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">linestate</span> <span class="o">==</span> <span class="n">LS_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">linestate</span> <span class="o">=</span> <span class="n">LS_HASH</span><span class="p">;</span>
			<span class="n">firstsym</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">skipcomment</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="n">linestate</span> <span class="o">=</span> <span class="n">LS_DIRTY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">incomment</span> <span class="o">&amp;&amp;</span> <span class="n">linestate</span> <span class="o">==</span> <span class="n">LS_HASH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">keyword</span> <span class="o">=</span> <span class="n">tline</span> <span class="o">+</span> <span class="p">(</span><span class="n">cp</span> <span class="o">-</span> <span class="n">tline</span><span class="p">);</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">skipsym</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">kwlen</span> <span class="o">=</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">keyword</span><span class="p">;</span>
		<span class="cm">/* no way can we deal with a continuation inside a keyword */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">Eioccc</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlcmp</span><span class="p">(</span><span class="s">&quot;ifdef&quot;</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">kwlen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">strlcmp</span><span class="p">(</span><span class="s">&quot;ifndef&quot;</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">kwlen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">skipcomment</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cursym</span> <span class="o">=</span> <span class="n">findsym</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">LT_IF</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">keyword</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;n&#39;</span><span class="p">)</span>
				    <span class="o">?</span> <span class="n">LT_FALSE</span> <span class="o">:</span> <span class="n">LT_TRUE</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">cursym</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">LT_TRUE</span><span class="p">)</span>
					    <span class="o">?</span> <span class="n">LT_FALSE</span> <span class="o">:</span> <span class="n">LT_TRUE</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ignore</span><span class="p">[</span><span class="n">cursym</span><span class="p">])</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">LT_TRUE</span><span class="p">)</span>
					    <span class="o">?</span> <span class="n">LT_TRUEI</span> <span class="o">:</span> <span class="n">LT_FALSEI</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">skipsym</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlcmp</span><span class="p">(</span><span class="s">&quot;if&quot;</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">kwlen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ifeval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlcmp</span><span class="p">(</span><span class="s">&quot;elif&quot;</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">kwlen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ifeval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">)</span> <span class="o">-</span> <span class="n">LT_IF</span> <span class="o">+</span> <span class="n">LT_ELIF</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlcmp</span><span class="p">(</span><span class="s">&quot;else&quot;</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">kwlen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">LT_ELSE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlcmp</span><span class="p">(</span><span class="s">&quot;endif&quot;</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">kwlen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">LT_ENDIF</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">linestate</span> <span class="o">=</span> <span class="n">LS_DIRTY</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">LT_PLAIN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">skipcomment</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">linestate</span> <span class="o">=</span> <span class="n">LS_DIRTY</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">LT_TRUE</span> <span class="o">||</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">LT_FALSE</span> <span class="o">||</span>
			    <span class="n">retval</span> <span class="o">==</span> <span class="n">LT_TRUEI</span> <span class="o">||</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">LT_FALSEI</span><span class="p">)</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">LT_IF</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">LT_ELTRUE</span> <span class="o">||</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">LT_ELFALSE</span><span class="p">)</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">LT_ELIF</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">LT_PLAIN</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wascomment</span> <span class="o">||</span> <span class="n">incomment</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">+=</span> <span class="n">LT_DODGY</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">incomment</span><span class="p">)</span>
				<span class="n">linestate</span> <span class="o">=</span> <span class="n">LS_DIRTY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* skipcomment normally changes the state, except</span>
<span class="cm">		   if the last line of the file lacks a newline, or</span>
<span class="cm">		   if there is too much whitespace in a directive */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">linestate</span> <span class="o">==</span> <span class="n">LS_HASH</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">tline</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">tline</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">MAXLINE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="n">input</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* append the missing newline */</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">tline</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">newline</span><span class="p">);</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">newline</span><span class="p">);</span>
				<span class="n">linestate</span> <span class="o">=</span> <span class="n">LS_START</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">linestate</span> <span class="o">=</span> <span class="n">LS_DIRTY</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">linestate</span> <span class="o">==</span> <span class="n">LS_DIRTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">skipcomment</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;parser line %d state %s comment %s line&quot;</span><span class="p">,</span> <span class="n">linenum</span><span class="p">,</span>
	    <span class="n">comment_name</span><span class="p">[</span><span class="n">incomment</span><span class="p">],</span> <span class="n">linestate_name</span><span class="p">[</span><span class="n">linestate</span><span class="p">]);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * These are the binary operators that are supported by the expression</span>
<span class="cm"> * evaluator.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">Linetype</span> <span class="nf">op_strict</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">at</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">bt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">at</span> <span class="o">==</span> <span class="n">LT_IF</span> <span class="o">||</span> <span class="n">bt</span> <span class="o">==</span> <span class="n">LT_IF</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="n">LT_IF</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span> <span class="o">?</span> <span class="n">LT_TRUE</span> <span class="o">:</span> <span class="n">LT_FALSE</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">Linetype</span> <span class="nf">op_lt</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">bt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">op_strict</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">bt</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">Linetype</span> <span class="nf">op_gt</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">bt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">op_strict</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">bt</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">Linetype</span> <span class="nf">op_le</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">bt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">op_strict</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">bt</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">Linetype</span> <span class="nf">op_ge</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">bt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">op_strict</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">bt</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">Linetype</span> <span class="nf">op_eq</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">bt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">op_strict</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">bt</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">Linetype</span> <span class="nf">op_ne</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">bt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">op_strict</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">bt</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">Linetype</span> <span class="nf">op_or</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">bt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strictlogic</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">at</span> <span class="o">==</span> <span class="n">LT_TRUE</span> <span class="o">||</span> <span class="n">bt</span> <span class="o">==</span> <span class="n">LT_TRUE</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LT_TRUE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">op_strict</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="o">||</span> <span class="n">b</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">bt</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">Linetype</span> <span class="nf">op_and</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">Linetype</span> <span class="n">bt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strictlogic</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">at</span> <span class="o">==</span> <span class="n">LT_FALSE</span> <span class="o">||</span> <span class="n">bt</span> <span class="o">==</span> <span class="n">LT_FALSE</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LT_FALSE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">op_strict</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">b</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">bt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * An evaluation function takes three arguments, as follows: (1) a pointer to</span>
<span class="cm"> * an element of the precedence table which lists the operators at the current</span>
<span class="cm"> * level of precedence; (2) a pointer to an integer which will receive the</span>
<span class="cm"> * value of the expression; and (3) a pointer to a char* that points to the</span>
<span class="cm"> * expression to be evaluated and that is updated to the end of the expression</span>
<span class="cm"> * when evaluation is complete. The function returns LT_FALSE if the value of</span>
<span class="cm"> * the expression is zero, LT_TRUE if it is non-zero, LT_IF if the expression</span>
<span class="cm"> * depends on an unknown symbol, or LT_ERROR if there is a parse failure.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ops</span><span class="p">;</span>

<span class="k">typedef</span> <span class="n">Linetype</span> <span class="n">eval_fn</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ops</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">);</span>

<span class="k">static</span> <span class="n">eval_fn</span> <span class="n">eval_table</span><span class="p">,</span> <span class="n">eval_unary</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * The precedence table. Expressions involving binary operators are evaluated</span>
<span class="cm"> * in a table-driven way by eval_table. When it evaluates a subexpression it</span>
<span class="cm"> * calls the inner function with its first argument pointing to the next</span>
<span class="cm"> * element of the table. Innermost expressions have special non-table-driven</span>
<span class="cm"> * handling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ops</span> <span class="p">{</span>
	<span class="n">eval_fn</span> <span class="o">*</span><span class="n">inner</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">op</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
		<span class="n">Linetype</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="kt">int</span> <span class="o">*</span><span class="p">,</span> <span class="n">Linetype</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">Linetype</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="p">}</span> <span class="n">op</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="p">}</span> <span class="n">eval_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">eval_table</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="s">&quot;||&quot;</span><span class="p">,</span> <span class="n">op_or</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">eval_table</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="s">&quot;&amp;&amp;&quot;</span><span class="p">,</span> <span class="n">op_and</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">eval_table</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="s">&quot;==&quot;</span><span class="p">,</span> <span class="n">op_eq</span> <span class="p">},</span>
			<span class="p">{</span> <span class="s">&quot;!=&quot;</span><span class="p">,</span> <span class="n">op_ne</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">eval_unary</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="s">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="n">op_le</span> <span class="p">},</span>
			<span class="p">{</span> <span class="s">&quot;&gt;=&quot;</span><span class="p">,</span> <span class="n">op_ge</span> <span class="p">},</span>
			<span class="p">{</span> <span class="s">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">op_lt</span> <span class="p">},</span>
			<span class="p">{</span> <span class="s">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">op_gt</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Function for evaluating the innermost parts of expressions,</span>
<span class="cm"> * viz. !expr (expr) number defined(symbol) symbol</span>
<span class="cm"> * We reset the constexpr flag in the last two cases.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">Linetype</span>
<span class="nf">eval_unary</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">valp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">cpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sym</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">defparen</span><span class="p">;</span>
	<span class="n">Linetype</span> <span class="n">lt</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">skipcomment</span><span class="p">(</span><span class="o">*</span><span class="n">cpp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;eval%d !&quot;</span><span class="p">,</span> <span class="n">ops</span> <span class="o">-</span> <span class="n">eval_ops</span><span class="p">);</span>
		<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">lt</span> <span class="o">=</span> <span class="n">eval_unary</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="n">valp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lt</span> <span class="o">==</span> <span class="n">LT_ERROR</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">LT_ERROR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lt</span> <span class="o">!=</span> <span class="n">LT_IF</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="o">!*</span><span class="n">valp</span><span class="p">;</span>
			<span class="n">lt</span> <span class="o">=</span> <span class="o">*</span><span class="n">valp</span> <span class="o">?</span> <span class="n">LT_TRUE</span> <span class="o">:</span> <span class="n">LT_FALSE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;(&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;eval%d (&quot;</span><span class="p">,</span> <span class="n">ops</span> <span class="o">-</span> <span class="n">eval_ops</span><span class="p">);</span>
		<span class="n">lt</span> <span class="o">=</span> <span class="n">eval_table</span><span class="p">(</span><span class="n">eval_ops</span><span class="p">,</span> <span class="n">valp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lt</span> <span class="o">==</span> <span class="n">LT_ERROR</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">LT_ERROR</span><span class="p">);</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">skipcomment</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;)&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">LT_ERROR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">cp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;eval%d number&quot;</span><span class="p">,</span> <span class="n">ops</span> <span class="o">-</span> <span class="n">eval_ops</span><span class="p">);</span>
		<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="n">cp</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">LT_ERROR</span><span class="p">);</span>
		<span class="n">lt</span> <span class="o">=</span> <span class="o">*</span><span class="n">valp</span> <span class="o">?</span> <span class="n">LT_TRUE</span> <span class="o">:</span> <span class="n">LT_FALSE</span><span class="p">;</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">skipsym</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;defined&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">endsym</span><span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">skipcomment</span><span class="p">(</span><span class="n">cp</span><span class="o">+</span><span class="mi">7</span><span class="p">);</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;eval%d defined&quot;</span><span class="p">,</span> <span class="n">ops</span> <span class="o">-</span> <span class="n">eval_ops</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;(&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">skipcomment</span><span class="p">(</span><span class="n">cp</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">defparen</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">defparen</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sym</span> <span class="o">=</span> <span class="n">findsym</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lt</span> <span class="o">=</span> <span class="n">LT_IF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">lt</span> <span class="o">=</span> <span class="o">*</span><span class="n">valp</span> <span class="o">?</span> <span class="n">LT_TRUE</span> <span class="o">:</span> <span class="n">LT_FALSE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">skipsym</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">skipcomment</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">defparen</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;)&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">LT_ERROR</span><span class="p">);</span>
		<span class="n">constexpr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">endsym</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;eval%d symbol&quot;</span><span class="p">,</span> <span class="n">ops</span> <span class="o">-</span> <span class="n">eval_ops</span><span class="p">);</span>
		<span class="n">sym</span> <span class="o">=</span> <span class="n">findsym</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">skipsym</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lt</span> <span class="o">=</span> <span class="n">LT_IF</span><span class="p">;</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">skipargs</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lt</span> <span class="o">=</span> <span class="n">LT_FALSE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">sym</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ep</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">||</span> <span class="n">ep</span> <span class="o">==</span> <span class="n">value</span><span class="p">[</span><span class="n">sym</span><span class="p">])</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">LT_ERROR</span><span class="p">);</span>
			<span class="n">lt</span> <span class="o">=</span> <span class="o">*</span><span class="n">valp</span> <span class="o">?</span> <span class="n">LT_TRUE</span> <span class="o">:</span> <span class="n">LT_FALSE</span><span class="p">;</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">skipargs</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">constexpr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;eval%d bad expr&quot;</span><span class="p">,</span> <span class="n">ops</span> <span class="o">-</span> <span class="n">eval_ops</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">LT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">cpp</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;eval%d = %d&quot;</span><span class="p">,</span> <span class="n">ops</span> <span class="o">-</span> <span class="n">eval_ops</span><span class="p">,</span> <span class="o">*</span><span class="n">valp</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">lt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Table-driven evaluation of binary operators.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">Linetype</span>
<span class="nf">eval_table</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">valp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">cpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">op</span> <span class="o">*</span><span class="n">op</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">Linetype</span> <span class="n">lt</span><span class="p">,</span> <span class="n">rt</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;eval%d&quot;</span><span class="p">,</span> <span class="n">ops</span> <span class="o">-</span> <span class="n">eval_ops</span><span class="p">);</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
	<span class="n">lt</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">inner</span><span class="p">(</span><span class="n">ops</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">valp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lt</span> <span class="o">==</span> <span class="n">LT_ERROR</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">LT_ERROR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">skipcomment</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">op</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">;</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">op</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cp</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;eval%d %s&quot;</span><span class="p">,</span> <span class="n">ops</span> <span class="o">-</span> <span class="n">eval_ops</span><span class="p">,</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
		<span class="n">rt</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">inner</span><span class="p">(</span><span class="n">ops</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span> <span class="o">==</span> <span class="n">LT_ERROR</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">LT_ERROR</span><span class="p">);</span>
		<span class="n">lt</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">(</span><span class="n">valp</span><span class="p">,</span> <span class="n">lt</span><span class="p">,</span> <span class="o">*</span><span class="n">valp</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">cpp</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;eval%d = %d&quot;</span><span class="p">,</span> <span class="n">ops</span> <span class="o">-</span> <span class="n">eval_ops</span><span class="p">,</span> <span class="o">*</span><span class="n">valp</span><span class="p">);</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;eval%d lt = %s&quot;</span><span class="p">,</span> <span class="n">ops</span> <span class="o">-</span> <span class="n">eval_ops</span><span class="p">,</span> <span class="n">linetype_name</span><span class="p">[</span><span class="n">lt</span><span class="p">]);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">lt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Evaluate the expression on a #if or #elif line. If we can work out</span>
<span class="cm"> * the result we return LT_TRUE or LT_FALSE accordingly, otherwise we</span>
<span class="cm"> * return just a generic LT_IF.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">Linetype</span>
<span class="nf">ifeval</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">cpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;eval %s&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">cpp</span><span class="p">);</span>
	<span class="n">constexpr</span> <span class="o">=</span> <span class="n">killconsts</span> <span class="o">?</span> <span class="nb">false</span> <span class="o">:</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">eval_table</span><span class="p">(</span><span class="n">eval_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">cpp</span><span class="p">);</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;eval = %d&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">constexpr</span> <span class="o">?</span> <span class="n">LT_IF</span> <span class="o">:</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">LT_ERROR</span> <span class="o">?</span> <span class="n">LT_IF</span> <span class="o">:</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Skip over comments, strings, and character literals and stop at the</span>
<span class="cm"> * next character position that is not whitespace. Between calls we keep</span>
<span class="cm"> * the comment state in the global variable incomment, and we also adjust</span>
<span class="cm"> * the global variable linestate when we see a newline.</span>
<span class="cm"> * XXX: doesn&#39;t cope with the buffer splitting inside a state transition.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">skipcomment</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">text</span> <span class="o">||</span> <span class="n">ignoring</span><span class="p">[</span><span class="n">depth</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">isspace</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">cp</span><span class="p">);</span> <span class="n">cp</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
				<span class="n">linestate</span> <span class="o">=</span> <span class="n">LS_START</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="cm">/* don&#39;t reset to LS_START after a line continuation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cp</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">switch</span> <span class="p">(</span><span class="n">incomment</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NO_COMMENT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;/</span><span class="se">\\\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">STARTING_COMMENT</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;/</span><span class="se">\\\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">STARTING_COMMENT</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;/*&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">C_COMMENT</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;//&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">CXX_COMMENT</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&#39;</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">CHAR_LITERAL</span><span class="p">;</span>
				<span class="n">linestate</span> <span class="o">=</span> <span class="n">LS_DIRTY</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">STRING_LITERAL</span><span class="p">;</span>
				<span class="n">linestate</span> <span class="o">=</span> <span class="n">LS_DIRTY</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">linestate</span> <span class="o">=</span> <span class="n">LS_START</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="s">&quot; </span><span class="se">\r\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CXX_COMMENT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">NO_COMMENT</span><span class="p">;</span>
				<span class="n">linestate</span> <span class="o">=</span> <span class="n">LS_START</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CHAR_LITERAL</span>:
		<span class="k">case</span> <span class="n">STRING_LITERAL</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">incomment</span> <span class="o">==</span> <span class="n">CHAR_LITERAL</span> <span class="o">&amp;&amp;</span> <span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\&#39;&#39;</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">incomment</span> <span class="o">==</span> <span class="n">STRING_LITERAL</span> <span class="o">&amp;&amp;</span> <span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\&quot;&#39;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">NO_COMMENT</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
					<span class="n">cp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">cp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">incomment</span> <span class="o">==</span> <span class="n">CHAR_LITERAL</span><span class="p">)</span>
					<span class="n">error</span><span class="p">(</span><span class="s">&quot;unterminated char literal&quot;</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">error</span><span class="p">(</span><span class="s">&quot;unterminated string literal&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">C_COMMENT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;*</span><span class="se">\\\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">FINISHING_COMMENT</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;*</span><span class="se">\\\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">FINISHING_COMMENT</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;*/&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">NO_COMMENT</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STARTING_COMMENT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">C_COMMENT</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">CXX_COMMENT</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">NO_COMMENT</span><span class="p">;</span>
				<span class="n">linestate</span> <span class="o">=</span> <span class="n">LS_DIRTY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FINISHING_COMMENT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">NO_COMMENT</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">incomment</span> <span class="o">=</span> <span class="n">C_COMMENT</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">abort</span><span class="p">();</span> <span class="cm">/* bug */</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Skip macro arguments.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">skipargs</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ocp</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">skipcomment</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39;(&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;(&#39;</span><span class="p">)</span>
			<span class="n">level</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;)&#39;</span><span class="p">)</span>
			<span class="n">level</span><span class="o">--</span><span class="p">;</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">skipcomment</span><span class="p">(</span><span class="n">cp</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="k">else</span>
	<span class="cm">/* Rewind and re-detect the syntax error later. */</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ocp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Skip over an identifier.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">skipsym</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">endsym</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">))</span>
		<span class="o">++</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Look for the symbol in the symbol table. If it is found, we return</span>
<span class="cm"> * the symbol table index, else we return -1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">findsym</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">symind</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">skipsym</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">==</span> <span class="n">str</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">symlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">symdepth</span> <span class="o">&amp;&amp;</span> <span class="n">firstsym</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s%3d&quot;</span><span class="p">,</span> <span class="n">zerosyms</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
		<span class="n">firstsym</span> <span class="o">=</span> <span class="n">zerosyms</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s%.*s%s&quot;</span><span class="p">,</span>
		    <span class="n">symdepth</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">cp</span><span class="o">-</span><span class="n">str</span><span class="p">),</span> <span class="n">str</span><span class="p">,</span>
		    <span class="n">symdepth</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* we don&#39;t care about the value of the symbol */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">symind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">symind</span> <span class="o">&lt;</span> <span class="n">nsyms</span><span class="p">;</span> <span class="o">++</span><span class="n">symind</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlcmp</span><span class="p">(</span><span class="n">symname</span><span class="p">[</span><span class="n">symind</span><span class="p">],</span> <span class="n">str</span><span class="p">,</span> <span class="n">cp</span><span class="o">-</span><span class="n">str</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;findsym %s %s&quot;</span><span class="p">,</span> <span class="n">symname</span><span class="p">[</span><span class="n">symind</span><span class="p">],</span>
			    <span class="n">value</span><span class="p">[</span><span class="n">symind</span><span class="p">]</span> <span class="o">?</span> <span class="n">value</span><span class="p">[</span><span class="n">symind</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">symind</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add a symbol to the symbol table.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">addsym</span><span class="p">(</span><span class="n">bool</span> <span class="n">ignorethis</span><span class="p">,</span> <span class="n">bool</span> <span class="n">definethis</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sym</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">symind</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>

	<span class="n">symind</span> <span class="o">=</span> <span class="n">findsym</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">symind</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nsyms</span> <span class="o">&gt;=</span> <span class="n">MAXSYMS</span><span class="p">)</span>
			<span class="n">errx</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;too many symbols&quot;</span><span class="p">);</span>
		<span class="n">symind</span> <span class="o">=</span> <span class="n">nsyms</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">symname</span><span class="p">[</span><span class="n">symind</span><span class="p">]</span> <span class="o">=</span> <span class="n">sym</span><span class="p">;</span>
	<span class="n">ignore</span><span class="p">[</span><span class="n">symind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ignorethis</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sym</span> <span class="o">+</span> <span class="p">(</span><span class="n">skipsym</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">-</span> <span class="n">sym</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">definethis</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">val</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span><span class="p">[</span><span class="n">symind</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">val</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="n">value</span><span class="p">[</span><span class="n">symind</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;1&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">usage</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">val</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="n">usage</span><span class="p">();</span>
		<span class="n">value</span><span class="p">[</span><span class="n">symind</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;addsym %s=%s&quot;</span><span class="p">,</span> <span class="n">symname</span><span class="p">[</span><span class="n">symind</span><span class="p">],</span>
	    <span class="n">value</span><span class="p">[</span><span class="n">symind</span><span class="p">]</span> <span class="o">?</span> <span class="n">value</span><span class="p">[</span><span class="n">symind</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;undef&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Compare s with n characters of t.</span>
<span class="cm"> * The same as strncmp() except that it checks that s[n] == &#39;\0&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">strlcmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">t</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">!=</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">s</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">t</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">++</span><span class="n">s</span><span class="p">,</span> <span class="o">++</span><span class="n">t</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Diagnostics.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">debug</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">vwarnx</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
		<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;%s: %d: %s&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">linenum</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;%s: %d: %s (#if line %d depth %d)&quot;</span><span class="p">,</span>
		    <span class="n">filename</span><span class="p">,</span> <span class="n">linenum</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">stifline</span><span class="p">[</span><span class="n">depth</span><span class="p">],</span> <span class="n">depth</span><span class="p">);</span>
	<span class="n">closeout</span><span class="p">();</span>
	<span class="n">errx</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;output may be truncated&quot;</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
