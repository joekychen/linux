<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › checkpatch.pl

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>checkpatch.pl</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c1">#!/usr/bin/perl -w</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>(c) 2001, Dave Jones. (the file handling bit)
(c) 2005, Joel Schopp <a href="&#x6D;&#97;&#x69;&#x6C;&#x74;&#111;:j&#x73;&#x63;&#104;&#x6F;&#112;&#x70;&#x40;&#x61;&#x75;&#115;&#x74;&#105;&#x6E;&#x2E;&#105;&#98;&#109;&#46;&#x63;&#111;&#x6D;">j&#x73;&#x63;&#104;&#x6F;&#112;&#x70;&#x40;&#x61;&#x75;&#115;&#x74;&#105;&#x6E;&#x2E;&#105;&#98;&#109;&#46;&#x63;&#111;&#x6D;</a> (the ugly bit)
(c) 2007,2008, Andy Whitcroft <a href="&#x6D;&#97;i&#108;t&#x6F;:&#97;&#112;&#119;&#64;&#x75;&#x6B;.&#105;&#x62;&#x6D;&#x2E;&#x63;&#x6F;m">&#97;&#112;&#119;&#64;&#x75;&#x6B;.&#105;&#x62;&#x6D;&#x2E;&#x63;&#x6F;m</a> (new conditions, test suite)
(c) 2008-2010 Andy Whitcroft <a href="&#109;&#x61;&#105;&#x6C;&#x74;&#x6F;:&#x61;&#x70;&#x77;&#64;&#99;&#x61;&#110;&#x6F;&#110;&#105;&#99;&#x61;&#x6C;&#x2E;&#99;&#x6F;&#x6D;">&#x61;&#x70;&#x77;&#64;&#99;&#x61;&#110;&#x6F;&#110;&#105;&#99;&#x61;&#x6C;&#x2E;&#99;&#x6F;&#x6D;</a>
Licensed under the terms of the GNU GPL License version 2</p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">strict</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$P</span> <span class="o">=</span> <span class="nv">$0</span><span class="p">;</span>
<span class="nv">$P</span> <span class="o">=~</span> <span class="sr">s@.*/@@g</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$V</span> <span class="o">=</span> <span class="s">&#39;0.32&#39;</span><span class="p">;</span>

<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Long</span> <span class="sx">qw(:config no_auto_abbrev)</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$quiet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$tree</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$chk_signoff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$chk_patch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$tst_only</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$emacs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$terse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$summary</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$mailback</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$summary_file</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$show_types</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$root</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%debug</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%ignore_type</span> <span class="o">=</span> <span class="p">();</span>
<span class="k">my</span> <span class="nv">@ignore</span> <span class="o">=</span> <span class="p">();</span>
<span class="k">my</span> <span class="nv">$help</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$configuration_file</span> <span class="o">=</span> <span class="s">&quot;.checkpatch.conf&quot;</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">help</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$exitcode</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">print</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOM&quot;</span><span class="p">;</span>
<span class="n">Usage:</span> <span class="nv">$P</span> <span class="p">[</span><span class="n">OPTION</span><span class="p">]</span><span class="o">...</span> <span class="p">[</span><span class="n">FILE</span><span class="p">]</span><span class="o">...</span>
<span class="n">Version:</span> <span class="nv">$V</span>

<span class="n">Options:</span>
  <span class="o">-</span><span class="sx">q, --quiet                quiet</span>
<span class="sx">  --no-tree                  run without a kernel tree</span>
<span class="sx">  --no-signoff               do not check for &#39;Signed-off-by&#39; line</span>
<span class="sx">  --patch                    treat FILE as patchfile (default)</span>
<span class="sx">  --emacs                    emacs compile window format</span>
<span class="sx">  --terse                    one line per report</span>
<span class="sx">  -f,</span> <span class="o">--</span><span class="n">file</span>                 <span class="n">treat</span> <span class="n">FILE</span> <span class="n">as</span> <span class="n">regular</span> <span class="n">source</span> <span class="n">file</span>
  <span class="o">--</span><span class="n">subjective</span><span class="p">,</span> <span class="o">--</span><span class="n">strict</span>     <span class="n">enable</span> <span class="n">more</span> <span class="n">subjective</span> <span class="n">tests</span>
  <span class="o">--</span><span class="n">ignore</span> <span class="n">TYPE</span><span class="p">(,</span><span class="n">TYPE2</span><span class="o">...</span><span class="p">)</span>   <span class="n">ignore</span> <span class="n">various</span> <span class="n">comma</span> <span class="n">separated</span> <span class="n">message</span> <span class="n">types</span>
  <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">types</span>               <span class="n">show</span> <span class="n">the</span> <span class="n">message</span> <span class="s">&quot;types&quot;</span> <span class="n">in</span> <span class="n">the</span> <span class="n">output</span>
  <span class="o">--</span><span class="n">root</span><span class="o">=</span><span class="n">PATH</span>                <span class="n">PATH</span> <span class="n">to</span> <span class="n">the</span> <span class="n">kernel</span> <span class="n">tree</span> <span class="n">root</span>
  <span class="o">--</span><span class="nb">no</span><span class="o">-</span><span class="n">summary</span>               <span class="n">suppress</span> <span class="n">the</span> <span class="n">per</span><span class="o">-</span><span class="n">file</span> <span class="n">summary</span>
  <span class="o">--</span><span class="n">mailback</span>                 <span class="n">only</span> <span class="n">produce</span> <span class="n">a</span> <span class="n">report</span> <span class="n">in</span> <span class="k">case</span> <span class="n">of</span> <span class="n">warnings</span><span class="o">/</span><span class="n">errors</span>
  <span class="o">--</span><span class="n">summary</span><span class="o">-</span><span class="n">file</span>             <span class="n">include</span> <span class="n">the</span> <span class="n">filename</span> <span class="n">in</span> <span class="n">summary</span>
  <span class="o">--</span><span class="n">debug</span> <span class="n">KEY</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="o">|</span><span class="mi">1</span><span class="p">]</span>          <span class="n">turn</span> <span class="n">on</span><span class="o">/</span><span class="n">off</span> <span class="n">debugging</span> <span class="n">of</span> <span class="n">KEY</span><span class="p">,</span> <span class="n">where</span> <span class="n">KEY</span> <span class="n">is</span> <span class="n">one</span> <span class="n">of</span>
                             <span class="s">&#39;values&#39;</span><span class="p">,</span> <span class="s">&#39;possible&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="ow">and</span> <span class="s">&#39;attr&#39;</span> <span class="p">(</span><span class="n">default</span>
                             <span class="n">is</span> <span class="n">all</span> <span class="n">off</span><span class="p">)</span>
  <span class="o">--</span><span class="n">test</span><span class="o">-</span><span class="n">only</span><span class="o">=</span><span class="n">WORD</span>           <span class="n">report</span> <span class="n">only</span> <span class="n">warnings</span><span class="o">/</span><span class="n">errors</span> <span class="n">containing</span> <span class="n">WORD</span>
                             <span class="n">literally</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span><span class="p">,</span> <span class="o">--</span><span class="n">version</span>      <span class="n">display</span> <span class="n">this</span> <span class="n">help</span> <span class="ow">and</span> <span class="nb">exit</span>

<span class="n">When</span> <span class="n">FILE</span> <span class="n">is</span> <span class="o">-</span> <span class="nb">read</span> <span class="n">standard</span> <span class="n">input</span><span class="o">.</span>
<span class="n">EOM</span>

	<span class="nb">exit</span><span class="p">(</span><span class="nv">$exitcode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$conf</span> <span class="o">=</span> <span class="n">which_conf</span><span class="p">(</span><span class="nv">$configuration_file</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">f</span> <span class="nv">$conf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">@conf_args</span><span class="p">;</span>
	<span class="nb">open</span><span class="p">(</span><span class="k">my</span> <span class="nv">$conffile</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&quot;$conf&quot;</span><span class="p">)</span>
	    <span class="ow">or</span> <span class="nb">warn</span> <span class="s">&quot;$P: Can&#39;t find a readable $configuration_file file $!\n&quot;</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$conffile&gt;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>

		<span class="nv">$line</span> <span class="o">=~</span> <span class="sr">s/\s*\n?$//g</span><span class="p">;</span>
		<span class="nv">$line</span> <span class="o">=~</span> <span class="sr">s/^\s*//g</span><span class="p">;</span>
		<span class="nv">$line</span> <span class="o">=~</span> <span class="sr">s/\s+/ /g</span><span class="p">;</span>

		<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span> <span class="sr">m/^\s*#/</span><span class="p">);</span>
		<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span> <span class="sr">m/^\s*$/</span><span class="p">);</span>

		<span class="k">my</span> <span class="nv">@words</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="nv">$line</span><span class="p">);</span>
		<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$word</span> <span class="p">(</span><span class="nv">@words</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">last</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$word</span> <span class="o">=~</span> <span class="sr">m/^#/</span><span class="p">);</span>
			<span class="nb">push</span> <span class="p">(</span><span class="nv">@conf_args</span><span class="p">,</span> <span class="nv">$word</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nb">close</span><span class="p">(</span><span class="nv">$conffile</span><span class="p">);</span>
	<span class="nb">unshift</span><span class="p">(</span><span class="nv">@ARGV</span><span class="p">,</span> <span class="nv">@conf_args</span><span class="p">)</span> <span class="k">if</span> <span class="nv">@conf_args</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">GetOptions</span><span class="p">(</span>
	<span class="s">&#39;q|quiet+&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$quiet</span><span class="p">,</span>
	<span class="s">&#39;tree!&#39;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$tree</span><span class="p">,</span>
	<span class="s">&#39;signoff!&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$chk_signoff</span><span class="p">,</span>
	<span class="s">&#39;patch!&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$chk_patch</span><span class="p">,</span>
	<span class="s">&#39;emacs!&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$emacs</span><span class="p">,</span>
	<span class="s">&#39;terse!&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$terse</span><span class="p">,</span>
	<span class="s">&#39;f|file!&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$file</span><span class="p">,</span>
	<span class="s">&#39;subjective!&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$check</span><span class="p">,</span>
	<span class="s">&#39;strict!&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$check</span><span class="p">,</span>
	<span class="s">&#39;ignore=s&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@ignore</span><span class="p">,</span>
	<span class="s">&#39;show-types!&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$show_types</span><span class="p">,</span>
	<span class="s">&#39;root=s&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$root</span><span class="p">,</span>
	<span class="s">&#39;summary!&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$summary</span><span class="p">,</span>
	<span class="s">&#39;mailback!&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$mailback</span><span class="p">,</span>
	<span class="s">&#39;summary-file!&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$summary_file</span><span class="p">,</span>

	<span class="s">&#39;debug=s&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">%debug</span><span class="p">,</span>
	<span class="s">&#39;test-only=s&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$tst_only</span><span class="p">,</span>
	<span class="s">&#39;h|help&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$help</span><span class="p">,</span>
	<span class="s">&#39;version&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$help</span>
<span class="p">)</span> <span class="ow">or</span> <span class="n">help</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="n">help</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$help</span><span class="p">);</span>

<span class="k">my</span> <span class="nv">$exit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$#ARGV</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="s">&quot;$P: no input files\n&quot;</span><span class="p">;</span>
	<span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">@ignore</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/,/</span><span class="p">,</span> <span class="nb">join</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="nv">@ignore</span><span class="p">));</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$word</span> <span class="p">(</span><span class="nv">@ignore</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$word</span> <span class="o">=~</span> <span class="sr">s/\s*\n?$//g</span><span class="p">;</span>
	<span class="nv">$word</span> <span class="o">=~</span> <span class="sr">s/^\s*//g</span><span class="p">;</span>
	<span class="nv">$word</span> <span class="o">=~</span> <span class="sr">s/\s+/ /g</span><span class="p">;</span>
	<span class="nv">$word</span> <span class="o">=~</span> <span class="nb">tr</span><span class="sr">/[a-z]/</span><span class="p">[</span><span class="n">A</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="o">/</span><span class="p">;</span>

	<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$word</span> <span class="o">=~</span> <span class="sr">m/^\s*#/</span><span class="p">);</span>
	<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$word</span> <span class="o">=~</span> <span class="sr">m/^\s*$/</span><span class="p">);</span>

	<span class="nv">$ignore_type</span><span class="p">{</span><span class="nv">$word</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$dbg_values</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$dbg_possible</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$dbg_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$dbg_attr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="k">my</span> <span class="nv">$key</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%debug</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><h1>no critic</h1></td><td class="code"><div class="highlight"><pre>	<span class="nb">eval</span> <span class="s">&quot;\${dbg_$key} = &#39;$debug{$key}&#39;;&quot;</span><span class="p">;</span>
	<span class="nb">die</span> <span class="s">&quot;$@&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="vg">$@</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$rpt_cleaners</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$terse</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$emacs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nv">$quiet</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$tree</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$root</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">top_of_kernel_tree</span><span class="p">(</span><span class="nv">$root</span><span class="p">))</span> <span class="p">{</span>
			<span class="nb">die</span> <span class="s">&quot;$P: $root: --root does not point at a valid tree\n&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">top_of_kernel_tree</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">))</span> <span class="p">{</span>
			<span class="nv">$root</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$0</span> <span class="o">=~</span> <span class="sr">m@(.*)/scripts/[^/]*$@</span> <span class="o">&amp;&amp;</span>
						<span class="n">top_of_kernel_tree</span><span class="p">(</span><span class="nv">$1</span><span class="p">))</span> <span class="p">{</span>
			<span class="nv">$root</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$root</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">print</span> <span class="s">&quot;Must be run from the top-level dir. of a kernel tree\n&quot;</span><span class="p">;</span>
		<span class="nb">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$emitted_corrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">our</span> <span class="nv">$Ident</span>	<span class="o">=</span> <span class="sx">qr{</span>
<span class="sx">			[A-Za-z_][A-Za-z\d_]*</span>
<span class="sx">			(?:\s*\#\#\s*[A-Za-z_][A-Za-z\d_]*)*</span>
<span class="sx">		}</span><span class="n">x</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$Storage</span>	<span class="o">=</span> <span class="sx">qr{extern|static|asmlinkage}</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$Sparse</span>	<span class="o">=</span> <span class="sx">qr{</span>
<span class="sx">			__user|</span>
<span class="sx">			__kernel|</span>
<span class="sx">			__force|</span>
<span class="sx">			__iomem|</span>
<span class="sx">			__must_check|</span>
<span class="sx">			__init_refok|</span>
<span class="sx">			__kprobes|</span>
<span class="sx">			__ref|</span>
<span class="sx">			__rcu</span>
<span class="sx">		}</span><span class="n">x</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Notes to $Attribute:
We need \b after 'init' otherwise 'initconst' will cause a false positive in a check</p></td><td class="code"><div class="highlight"><pre><span class="k">our</span> <span class="nv">$Attribute</span>	<span class="o">=</span> <span class="sx">qr{</span>
<span class="sx">			const|</span>
<span class="sx">			__percpu|</span>
<span class="sx">			__nocast|</span>
<span class="sx">			__safe|</span>
<span class="sx">			__bitwise__|</span>
<span class="sx">			__packed__|</span>
<span class="sx">			__packed2__|</span>
<span class="sx">			__naked|</span>
<span class="sx">			__maybe_unused|</span>
<span class="sx">			__always_unused|</span>
<span class="sx">			__noreturn|</span>
<span class="sx">			__used|</span>
<span class="sx">			__cold|</span>
<span class="sx">			__noclone|</span>
<span class="sx">			__deprecated|</span>
<span class="sx">			__read_mostly|</span>
<span class="sx">			__kprobes|</span>
<span class="sx">			__(?:mem|cpu|dev|)(?:initdata|initconst|init\b)|</span>
<span class="sx">			____cacheline_aligned|</span>
<span class="sx">			____cacheline_aligned_in_smp|</span>
<span class="sx">			____cacheline_internodealigned_in_smp|</span>
<span class="sx">			__weak</span>
<span class="sx">		  }</span><span class="n">x</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$Modifier</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$Inline</span>	<span class="o">=</span> <span class="sx">qr{inline|__always_inline|noinline}</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$Member</span>	<span class="o">=</span> <span class="sx">qr{-&gt;$Ident|\.$Ident|\[[^]]*\]}</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$Lval</span>	<span class="o">=</span> <span class="sx">qr{$Ident(?:$Member)*}</span><span class="p">;</span>

<span class="k">our</span> <span class="nv">$Constant</span>	<span class="o">=</span> <span class="sx">qr{(?i:(?:[0-9]+|0x[0-9a-f]+)[ul]*)}</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$Assignment</span>	<span class="o">=</span> <span class="sx">qr{(?:\*\=|/=|%=|\+=|-=|&lt;&lt;=|&gt;&gt;=|&amp;=|\^=|\|=|=)}</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$Compare</span>    <span class="o">=</span> <span class="sx">qr{&lt;=|&gt;=|==|!=|&lt;|&gt;}</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$Operators</span>	<span class="o">=</span> <span class="sx">qr{</span>
<span class="sx">			&lt;=|&gt;=|==|!=|</span>
<span class="sx">			=&gt;|-&gt;|&lt;&lt;|&gt;&gt;|&lt;|&gt;|!|~|</span>
<span class="sx">			&amp;&amp;|\|\||,|\^|\+\+|--|&amp;|\||\+|-|\*|\/|%</span>
<span class="sx">		  }</span><span class="n">x</span><span class="p">;</span>

<span class="k">our</span> <span class="nv">$NonptrType</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$Type</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$Declare</span><span class="p">;</span>

<span class="k">our</span> <span class="nv">$NON_ASCII_UTF8</span>	<span class="o">=</span> <span class="sx">qr{</span>
<span class="sx">	[\xC2-\xDF][\x80-\xBF]               # non-overlong 2-byte</span>
<span class="sx">	|  \xE0[\xA0-\xBF][\x80-\xBF]        # excluding overlongs</span>
<span class="sx">	| [\xE1-\xEC\xEE\xEF][\x80-\xBF]{2}  # straight 3-byte</span>
<span class="sx">	|  \xED[\x80-\x9F][\x80-\xBF]        # excluding surrogates</span>
<span class="sx">	|  \xF0[\x90-\xBF][\x80-\xBF]{2}     # planes 1-3</span>
<span class="sx">	| [\xF1-\xF3][\x80-\xBF]{3}          # planes 4-15</span>
<span class="sx">	|  \xF4[\x80-\x8F][\x80-\xBF]{2}     # plane 16</span>
<span class="sx">}</span><span class="n">x</span><span class="p">;</span>

<span class="k">our</span> <span class="nv">$UTF8</span>	<span class="o">=</span> <span class="sx">qr{</span>
<span class="sx">	[\x09\x0A\x0D\x20-\x7E]              # ASCII</span>
<span class="sx">	| $NON_ASCII_UTF8</span>
<span class="sx">}</span><span class="n">x</span><span class="p">;</span>

<span class="k">our</span> <span class="nv">$typeTypedefs</span> <span class="o">=</span> <span class="sx">qr{(?x:</span>
<span class="sx">	(?:__)?(?:u|s|be|le)(?:8|16|32|64)|</span>
<span class="sx">	atomic_t</span>
<span class="sx">)}</span><span class="p">;</span>

<span class="k">our</span> <span class="nv">$logFunctions</span> <span class="o">=</span> <span class="sx">qr{(?x:</span>
<span class="sx">	printk(?:_ratelimited|_once|)|</span>
<span class="sx">	[a-z0-9]+_(?:printk|emerg|alert|crit|err|warning|warn|notice|info|debug|dbg|vdbg|devel|cont|WARN)(?:_ratelimited|_once|)|</span>
<span class="sx">	WARN(?:_RATELIMIT|_ONCE|)|</span>
<span class="sx">	panic|</span>
<span class="sx">	MODULE_[A-Z_]+</span>
<span class="sx">)}</span><span class="p">;</span>

<span class="k">our</span> <span class="nv">$signature_tags</span> <span class="o">=</span> <span class="sx">qr{(?xi:</span>
<span class="sx">	Signed-off-by:|</span>
<span class="sx">	Acked-by:|</span>
<span class="sx">	Tested-by:|</span>
<span class="sx">	Reviewed-by:|</span>
<span class="sx">	Reported-by:|</span>
<span class="sx">	To:|</span>
<span class="sx">	Cc:</span>
<span class="sx">)}</span><span class="p">;</span>

<span class="k">our</span> <span class="nv">@typeList</span> <span class="o">=</span> <span class="p">(</span>
	<span class="sx">qr{void}</span><span class="p">,</span>
	<span class="sx">qr{(?:unsigned\s+)?char}</span><span class="p">,</span>
	<span class="sx">qr{(?:unsigned\s+)?short}</span><span class="p">,</span>
	<span class="sx">qr{(?:unsigned\s+)?int}</span><span class="p">,</span>
	<span class="sx">qr{(?:unsigned\s+)?long}</span><span class="p">,</span>
	<span class="sx">qr{(?:unsigned\s+)?long\s+int}</span><span class="p">,</span>
	<span class="sx">qr{(?:unsigned\s+)?long\s+long}</span><span class="p">,</span>
	<span class="sx">qr{(?:unsigned\s+)?long\s+long\s+int}</span><span class="p">,</span>
	<span class="sx">qr{unsigned}</span><span class="p">,</span>
	<span class="sx">qr{float}</span><span class="p">,</span>
	<span class="sx">qr{double}</span><span class="p">,</span>
	<span class="sx">qr{bool}</span><span class="p">,</span>
	<span class="sx">qr{struct\s+$Ident}</span><span class="p">,</span>
	<span class="sx">qr{union\s+$Ident}</span><span class="p">,</span>
	<span class="sx">qr{enum\s+$Ident}</span><span class="p">,</span>
	<span class="sx">qr{${Ident}_t}</span><span class="p">,</span>
	<span class="sx">qr{${Ident}_handler}</span><span class="p">,</span>
	<span class="sx">qr{${Ident}_handler_fn}</span><span class="p">,</span>
<span class="p">);</span>
<span class="k">our</span> <span class="nv">@modifierList</span> <span class="o">=</span> <span class="p">(</span>
	<span class="sx">qr{fastcall}</span><span class="p">,</span>
<span class="p">);</span>

<span class="k">our</span> <span class="nv">$allowed_asm_includes</span> <span class="o">=</span> <span class="sx">qr{(?x:</span>
<span class="sx">	irq|</span>
<span class="sx">	memory</span>
<span class="sx">)}</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>memory.h: ARM has a custom one</p></td><td class="code"><div class="highlight"><pre><span class="k">sub </span><span class="nf">build_types</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$mods</span> <span class="o">=</span> <span class="s">&quot;(?x:  \n&quot;</span> <span class="o">.</span> <span class="nb">join</span><span class="p">(</span><span class="s">&quot;|\n  &quot;</span><span class="p">,</span> <span class="nv">@modifierList</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n)&quot;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$all</span> <span class="o">=</span> <span class="s">&quot;(?x:  \n&quot;</span> <span class="o">.</span> <span class="nb">join</span><span class="p">(</span><span class="s">&quot;|\n  &quot;</span><span class="p">,</span> <span class="nv">@typeList</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n)&quot;</span><span class="p">;</span>
	<span class="nv">$Modifier</span>	<span class="o">=</span> <span class="sx">qr{(?:$Attribute|$Sparse|$mods)}</span><span class="p">;</span>
	<span class="nv">$NonptrType</span>	<span class="o">=</span> <span class="sx">qr{</span>
<span class="sx">			(?:$Modifier\s+|const\s+)*</span>
<span class="sx">			(?:</span>
<span class="sx">				(?:typeof|__typeof__)\s*\([^\)]*\)|</span>
<span class="sx">				(?:$typeTypedefs\b)|</span>
<span class="sx">				(?:${all}\b)</span>
<span class="sx">			)</span>
<span class="sx">			(?:\s+$Modifier|\s+const)*</span>
<span class="sx">		  }</span><span class="n">x</span><span class="p">;</span>
	<span class="nv">$Type</span>	<span class="o">=</span> <span class="sx">qr{</span>
<span class="sx">			$NonptrType</span>
<span class="sx">			(?:(?:\s|\*|\[\])+\s*const|(?:\s|\*|\[\])+|(?:\s*\[\s*\])+)?</span>
<span class="sx">			(?:\s+$Inline|\s+$Modifier)*</span>
<span class="sx">		  }</span><span class="n">x</span><span class="p">;</span>
	<span class="nv">$Declare</span>	<span class="o">=</span> <span class="sx">qr{(?:$Storage\s+)?$Type}</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">build_types</span><span class="p">();</span>


<span class="k">our</span> <span class="nv">$Typecast</span>	<span class="o">=</span> <span class="sx">qr{\s*(\(\s*$NonptrType\s*\)){0,1}\s*}</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Using $balanced_parens, $LvalOrFunc, or $FuncArg
requires at least perl version v5.10.0
Any use must be runtime checked with $^V</p></td><td class="code"><div class="highlight"><pre><span class="k">our</span> <span class="nv">$balanced_parens</span> <span class="o">=</span> <span class="sx">qr/(\((?:[^\(\)]++|(?-1))*\))/</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$LvalOrFunc</span>	<span class="o">=</span> <span class="sx">qr{($Lval)\s*($balanced_parens{0,1})\s*}</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$FuncArg</span> <span class="o">=</span> <span class="sx">qr{$Typecast{0,1}($LvalOrFunc|$Constant)}</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">deparenthesize</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$string</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
	<span class="k">return</span> <span class="s">&quot;&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$string</span><span class="p">));</span>
	<span class="nv">$string</span> <span class="o">=~</span> <span class="sr">s@^\s*\(\s*@@g</span><span class="p">;</span>
	<span class="nv">$string</span> <span class="o">=~</span> <span class="sr">s@\s*\)\s*$@@g</span><span class="p">;</span>
	<span class="nv">$string</span> <span class="o">=~</span> <span class="sr">s@\s+@ @g</span><span class="p">;</span>
	<span class="k">return</span> <span class="nv">$string</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$chk_signoff</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$file</span><span class="p">);</span>

<span class="k">my</span> <span class="nv">@dep_includes</span> <span class="o">=</span> <span class="p">();</span>
<span class="k">my</span> <span class="nv">@dep_functions</span> <span class="o">=</span> <span class="p">();</span>
<span class="k">my</span> <span class="nv">$removal</span> <span class="o">=</span> <span class="s">&quot;Documentation/feature-removal-schedule.txt&quot;</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$tree</span> <span class="o">&amp;&amp;</span> <span class="o">-</span><span class="n">f</span> <span class="s">&quot;$root/$removal&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">open</span><span class="p">(</span><span class="k">my</span> <span class="nv">$REMOVE</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&quot;$root/$removal&quot;</span><span class="p">)</span> <span class="o">||</span>
				<span class="nb">die</span> <span class="s">&quot;$P: $removal: open failed - $!\n&quot;</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$REMOVE&gt;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="sr">/^Check:\s+(.*\S)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="k">my</span> <span class="nv">$entry</span> <span class="p">(</span><span class="nb">split</span><span class="p">(</span><span class="sr">/[, ]+/</span><span class="p">,</span> <span class="nv">$1</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$entry</span> <span class="o">=~</span> <span class="sr">m@include/(.*)@</span><span class="p">)</span> <span class="p">{</span>
					<span class="nb">push</span><span class="p">(</span><span class="nv">@dep_includes</span><span class="p">,</span> <span class="nv">$1</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$entry</span> <span class="o">!~</span> <span class="sr">m@/@</span><span class="p">)</span> <span class="p">{</span>
					<span class="nb">push</span><span class="p">(</span><span class="nv">@dep_functions</span><span class="p">,</span> <span class="nv">$entry</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nb">close</span><span class="p">(</span><span class="nv">$REMOVE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">@rawlines</span> <span class="o">=</span> <span class="p">();</span>
<span class="k">my</span> <span class="nv">@lines</span> <span class="o">=</span> <span class="p">();</span>
<span class="k">my</span> <span class="nv">$vname</span><span class="p">;</span>
<span class="k">for</span> <span class="k">my</span> <span class="nv">$filename</span> <span class="p">(</span><span class="nv">@ARGV</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$FILE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">open</span><span class="p">(</span><span class="nv">$FILE</span><span class="p">,</span> <span class="s">&#39;-|&#39;</span><span class="p">,</span> <span class="s">&quot;diff -u /dev/null $filename&quot;</span><span class="p">)</span> <span class="o">||</span>
			<span class="nb">die</span> <span class="s">&quot;$P: $filename: diff failed - $!\n&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$filename</span> <span class="ow">eq</span> <span class="s">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">open</span><span class="p">(</span><span class="nv">$FILE</span><span class="p">,</span> <span class="s">&#39;&lt;&amp;STDIN&#39;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nb">open</span><span class="p">(</span><span class="nv">$FILE</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&quot;$filename&quot;</span><span class="p">)</span> <span class="o">||</span>
			<span class="nb">die</span> <span class="s">&quot;$P: $filename: open failed - $!\n&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$filename</span> <span class="ow">eq</span> <span class="s">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$vname</span> <span class="o">=</span> <span class="s">&#39;Your patch&#39;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nv">$vname</span> <span class="o">=</span> <span class="nv">$filename</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$FILE&gt;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">chomp</span><span class="p">;</span>
		<span class="nb">push</span><span class="p">(</span><span class="nv">@rawlines</span><span class="p">,</span> <span class="nv">$_</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="nb">close</span><span class="p">(</span><span class="nv">$FILE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">process</span><span class="p">(</span><span class="nv">$filename</span><span class="p">))</span> <span class="p">{</span>
		<span class="nv">$exit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nv">@rawlines</span> <span class="o">=</span> <span class="p">();</span>
	<span class="nv">@lines</span> <span class="o">=</span> <span class="p">();</span>
<span class="p">}</span>

<span class="nb">exit</span><span class="p">(</span><span class="nv">$exit</span><span class="p">);</span>

<span class="k">sub </span><span class="nf">top_of_kernel_tree</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$root</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">@tree_check</span> <span class="o">=</span> <span class="p">(</span>
		<span class="s">&quot;COPYING&quot;</span><span class="p">,</span> <span class="s">&quot;CREDITS&quot;</span><span class="p">,</span> <span class="s">&quot;Kbuild&quot;</span><span class="p">,</span> <span class="s">&quot;MAINTAINERS&quot;</span><span class="p">,</span> <span class="s">&quot;Makefile&quot;</span><span class="p">,</span>
		<span class="s">&quot;README&quot;</span><span class="p">,</span> <span class="s">&quot;Documentation&quot;</span><span class="p">,</span> <span class="s">&quot;arch&quot;</span><span class="p">,</span> <span class="s">&quot;include&quot;</span><span class="p">,</span> <span class="s">&quot;drivers&quot;</span><span class="p">,</span>
		<span class="s">&quot;fs&quot;</span><span class="p">,</span> <span class="s">&quot;init&quot;</span><span class="p">,</span> <span class="s">&quot;ipc&quot;</span><span class="p">,</span> <span class="s">&quot;kernel&quot;</span><span class="p">,</span> <span class="s">&quot;lib&quot;</span><span class="p">,</span> <span class="s">&quot;scripts&quot;</span><span class="p">,</span>
	<span class="p">);</span>

	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$check</span> <span class="p">(</span><span class="nv">@tree_check</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">-</span><span class="n">e</span> <span class="nv">$root</span> <span class="o">.</span> <span class="s">&#39;/&#39;</span> <span class="o">.</span> <span class="nv">$check</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

<span class="k">sub </span><span class="nf">parse_email</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$formatted_email</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$address</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$formatted_email</span> <span class="o">=~</span><span class="sr"> /^(.*)&lt;(\S+\@\S+)&gt;(.*)$/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$name</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="nv">$address</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
		<span class="nv">$comment</span> <span class="o">=</span> <span class="nv">$3</span> <span class="k">if</span> <span class="nb">defined</span> <span class="nv">$3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$formatted_email</span> <span class="o">=~</span><span class="sr"> /^\s*&lt;(\S+\@\S+)&gt;(.*)$/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$address</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="nv">$comment</span> <span class="o">=</span> <span class="nv">$2</span> <span class="k">if</span> <span class="nb">defined</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$formatted_email</span> <span class="o">=~</span><span class="sr"> /(\S+\@\S+)(.*)$/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$address</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="nv">$comment</span> <span class="o">=</span> <span class="nv">$2</span> <span class="k">if</span> <span class="nb">defined</span> <span class="nv">$2</span><span class="p">;</span>
		<span class="nv">$formatted_email</span> <span class="o">=~</span> <span class="sr">s/$address.*$//</span><span class="p">;</span>
		<span class="nv">$name</span> <span class="o">=</span> <span class="nv">$formatted_email</span><span class="p">;</span>
		<span class="nv">$name</span> <span class="o">=~</span> <span class="sr">s/^\s+|\s+$//g</span><span class="p">;</span>
		<span class="nv">$name</span> <span class="o">=~</span> <span class="sr">s/^\&quot;|\&quot;$//g</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>If there's a name left after stripping spaces and
leading quotes, and the address doesn't have both
leading and trailing angle brackets, the address
is invalid. ie:
  "joe smith joe@smith.com" bad
  "joe smith <joe@smith.com" bad</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="ow">ne</span> <span class="s">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$address</span> <span class="o">!~</span> <span class="sr">/^&lt;[^&gt;]+&gt;$/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
			<span class="nv">$address</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
			<span class="nv">$comment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nv">$name</span> <span class="o">=~</span> <span class="sr">s/^\s+|\s+$//g</span><span class="p">;</span>
	<span class="nv">$name</span> <span class="o">=~</span> <span class="sr">s/^\&quot;|\&quot;$//g</span><span class="p">;</span>
	<span class="nv">$address</span> <span class="o">=~</span> <span class="sr">s/^\s+|\s+$//g</span><span class="p">;</span>
	<span class="nv">$address</span> <span class="o">=~</span> <span class="sr">s/^\&lt;|\&gt;$//g</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="o">=~</span><span class="sr"> /[^\w \-]/i</span><span class="p">)</span> <span class="p">{</span> <span class="c1">##has &quot;must quote&quot; chars</span>
		<span class="nv">$name</span> <span class="o">=~</span> <span class="sr">s/(?&lt;!\\)&quot;/\\&quot;/g</span><span class="p">;</span> <span class="c1">##escape quotes</span>
		<span class="nv">$name</span> <span class="o">=</span> <span class="s">&quot;\&quot;$name\&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$address</span><span class="p">,</span> <span class="nv">$comment</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">format_email</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$address</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$formatted_email</span><span class="p">;</span>

	<span class="nv">$name</span> <span class="o">=~</span> <span class="sr">s/^\s+|\s+$//g</span><span class="p">;</span>
	<span class="nv">$name</span> <span class="o">=~</span> <span class="sr">s/^\&quot;|\&quot;$//g</span><span class="p">;</span>
	<span class="nv">$address</span> <span class="o">=~</span> <span class="sr">s/^\s+|\s+$//g</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="o">=~</span><span class="sr"> /[^\w \-]/i</span><span class="p">)</span> <span class="p">{</span> <span class="c1">##has &quot;must quote&quot; chars</span>
		<span class="nv">$name</span> <span class="o">=~</span> <span class="sr">s/(?&lt;!\\)&quot;/\\&quot;/g</span><span class="p">;</span> <span class="c1">##escape quotes</span>
		<span class="nv">$name</span> <span class="o">=</span> <span class="s">&quot;\&quot;$name\&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="s">&quot;$name&quot;</span> <span class="ow">eq</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$formatted_email</span> <span class="o">=</span> <span class="s">&quot;$address&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nv">$formatted_email</span> <span class="o">=</span> <span class="s">&quot;$name &lt;$address&gt;&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nv">$formatted_email</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">which_conf</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$conf</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$path</span> <span class="p">(</span><span class="nb">split</span><span class="p">(</span><span class="sr">/:/</span><span class="p">,</span> <span class="s">&quot;.:$ENV{HOME}:.scripts&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">e</span> <span class="s">&quot;$path/$conf&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="s">&quot;$path/$conf&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">expand_tabs</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="k">my</span> <span class="nv">$c</span> <span class="p">(</span><span class="nb">split</span><span class="p">(</span><span class="sr">//</span><span class="p">,</span> <span class="nv">$str</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$c</span> <span class="ow">eq</span> <span class="s">&quot;\t&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$res</span> <span class="o">.=</span> <span class="s">&#39; &#39;</span><span class="p">;</span>
			<span class="nv">$n</span><span class="o">++</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="p">(</span><span class="nv">$n</span> <span class="nv">%</span> <span class="nv">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$res</span> <span class="o">.=</span> <span class="s">&#39; &#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nv">$res</span> <span class="o">.=</span> <span class="nv">$c</span><span class="p">;</span>
		<span class="nv">$n</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nv">$res</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">copy_spacing</span> <span class="p">{</span>
	<span class="p">(</span><span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">)</span> <span class="o">=~</span> <span class="nb">tr</span><span class="sr">/\t/</span> <span class="o">/</span><span class="n">c</span><span class="p">;</span>
	<span class="k">return</span> <span class="nv">$res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">line_stats</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$line</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Drop the diff line leader and expand tabs</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$line</span> <span class="o">=~</span> <span class="sr">s/^.//</span><span class="p">;</span>
	<span class="nv">$line</span> <span class="o">=</span> <span class="n">expand_tabs</span><span class="p">(</span><span class="nv">$line</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Pick the indent from the front of the line.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="p">(</span><span class="nv">$white</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^(\s*)/</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nv">$line</span><span class="p">),</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$white</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$sanitise_quote</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">sanitise_line_reset</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$in_comment</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$in_comment</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$sanitise_quote</span> <span class="o">=</span> <span class="s">&#39;*/&#39;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nv">$sanitise_quote</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">sanitise_line</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$line</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$l</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$qlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$c</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Always copy over the diff marker.</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$res</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="nv">$off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$off</span> <span class="o">&lt;</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$line</span><span class="p">);</span> <span class="nv">$off</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$c</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Comments we are wacking completly including the begin
and end, all to $;.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$sanitise_quote</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">eq</span> <span class="s">&#39;/*&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$sanitise_quote</span> <span class="o">=</span> <span class="s">&#39;*/&#39;</span><span class="p">;</span>

			<span class="nb">substr</span><span class="p">(</span><span class="nv">$res</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;$;$;&quot;</span><span class="p">);</span>
			<span class="nv">$off</span><span class="o">++</span><span class="p">;</span>
			<span class="k">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$sanitise_quote</span> <span class="ow">eq</span> <span class="s">&#39;*/&#39;</span> <span class="o">&amp;&amp;</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">eq</span> <span class="s">&#39;*/&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$sanitise_quote</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
			<span class="nb">substr</span><span class="p">(</span><span class="nv">$res</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;$;$;&quot;</span><span class="p">);</span>
			<span class="nv">$off</span><span class="o">++</span><span class="p">;</span>
			<span class="k">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$sanitise_quote</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">eq</span> <span class="s">&#39;//&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$sanitise_quote</span> <span class="o">=</span> <span class="s">&#39;//&#39;</span><span class="p">;</span>

			<span class="nb">substr</span><span class="p">(</span><span class="nv">$res</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nv">$sanitise_quote</span><span class="p">);</span>
			<span class="nv">$off</span><span class="o">++</span><span class="p">;</span>
			<span class="k">next</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>A \ in a string means ignore the next character.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="nv">$sanitise_quote</span> <span class="ow">eq</span> <span class="s">&quot;&#39;&quot;</span> <span class="o">||</span> <span class="nv">$sanitise_quote</span> <span class="ow">eq</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$c</span> <span class="ow">eq</span> <span class="s">&quot;\\&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nb">substr</span><span class="p">(</span><span class="nv">$res</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;XX&#39;</span><span class="p">);</span>
			<span class="nv">$off</span><span class="o">++</span><span class="p">;</span>
			<span class="k">next</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Regular quotes.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$c</span> <span class="ow">eq</span> <span class="s">&quot;&#39;&quot;</span> <span class="o">||</span> <span class="nv">$c</span> <span class="ow">eq</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$sanitise_quote</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$sanitise_quote</span> <span class="o">=</span> <span class="nv">$c</span><span class="p">;</span>

				<span class="nb">substr</span><span class="p">(</span><span class="nv">$res</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$c</span><span class="p">);</span>
				<span class="k">next</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$sanitise_quote</span> <span class="ow">eq</span> <span class="nv">$c</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$sanitise_quote</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>print "c&lt;$c> SQ&lt;$sanitise_quote>\n";</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$off</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$sanitise_quote</span> <span class="ow">eq</span> <span class="s">&#39;*/&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$c</span> <span class="ow">ne</span> <span class="s">&quot;\t&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nb">substr</span><span class="p">(</span><span class="nv">$res</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="vg">$;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$off</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$sanitise_quote</span> <span class="ow">eq</span> <span class="s">&#39;//&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$c</span> <span class="ow">ne</span> <span class="s">&quot;\t&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nb">substr</span><span class="p">(</span><span class="nv">$res</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="vg">$;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$off</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$sanitise_quote</span> <span class="o">&amp;&amp;</span> <span class="nv">$c</span> <span class="ow">ne</span> <span class="s">&quot;\t&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nb">substr</span><span class="p">(</span><span class="nv">$res</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;X&#39;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nb">substr</span><span class="p">(</span><span class="nv">$res</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$c</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$sanitise_quote</span> <span class="ow">eq</span> <span class="s">&#39;//&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$sanitise_quote</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>The pathname on a #include may be surrounded by '&lt;' and '>'.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$res</span> <span class="o">=~</span><span class="sr"> /^.\s*\#\s*include\s+\&lt;(.*)\&gt;/</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$clean</span> <span class="o">=</span> <span class="s">&#39;X&#39;</span> <span class="n">x</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$1</span><span class="p">);</span>
		<span class="nv">$res</span> <span class="o">=~</span> <span class="sr">s@\&lt;.*\&gt;@&lt;$clean&gt;@</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>The whole of a #error is a string.</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$res</span> <span class="o">=~</span><span class="sr"> /^.\s*\#\s*(?:error|warning)\s+(.*)\b/</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$clean</span> <span class="o">=</span> <span class="s">&#39;X&#39;</span> <span class="n">x</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$1</span><span class="p">);</span>
		<span class="nv">$res</span> <span class="o">=~</span> <span class="sr">s@(\#\s*(?:error|warning)\s+).*@$1$clean@</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nv">$res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">ctx_statement_block</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">,</span> <span class="nv">$off</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="nv">$linenr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$blk</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$soff</span> <span class="o">=</span> <span class="nv">$off</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$coff</span> <span class="o">=</span> <span class="nv">$off</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$coff_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$loff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">@stack</span> <span class="o">=</span> <span class="p">();</span>
	<span class="k">my</span> <span class="nv">$p</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$c</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$remainder</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">@stack</span> <span class="o">=</span> <span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$#stack</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>warn "CSB: blk&lt;$blk> remain&lt;$remain>\n";
If we are about to drop off the end, pull in more
context.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$off</span> <span class="o">&gt;=</span> <span class="nv">$len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="nv">$remain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$line</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">last</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$line</span><span class="p">]);</span>
				<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="nv">$line</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^-/</span><span class="p">);</span>
				<span class="nv">$remain</span><span class="o">--</span><span class="p">;</span>
				<span class="nv">$loff</span> <span class="o">=</span> <span class="nv">$len</span><span class="p">;</span>
				<span class="nv">$blk</span> <span class="o">.=</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$line</span><span class="p">]</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
				<span class="nv">$len</span> <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$blk</span><span class="p">);</span>
				<span class="nv">$line</span><span class="o">++</span><span class="p">;</span>
				<span class="k">last</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Bail if there is no further context.
warn "CSB: blk&lt;$blk> off&lt;$off> len&lt;$len>\n";</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$off</span> <span class="o">&gt;=</span> <span class="nv">$len</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">last</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$level</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$blk</span><span class="p">,</span> <span class="nv">$off</span><span class="p">)</span> <span class="o">=~</span><span class="sr"> /^.\s*#\s*define/</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$level</span><span class="o">++</span><span class="p">;</span>
				<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;#&#39;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="nv">$p</span> <span class="o">=</span> <span class="nv">$c</span><span class="p">;</span>
		<span class="nv">$c</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$blk</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="nv">$remainder</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$blk</span><span class="p">,</span> <span class="nv">$off</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>warn "CSB: c&lt;$c> type&lt;$type> level&lt;$level> remainder&lt;$remainder> coff<em>set&lt;$coff</em>set>\n";</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Handle nested #if/#else.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$remainder</span> <span class="o">=~</span><span class="sr"> /^#\s*(?:ifndef|ifdef|if)\s/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nb">push</span><span class="p">(</span><span class="nv">@stack</span><span class="p">,</span> <span class="p">[</span> <span class="nv">$type</span><span class="p">,</span> <span class="nv">$level</span> <span class="p">]);</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$remainder</span> <span class="o">=~</span><span class="sr"> /^#\s*(?:else|elif)\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$level</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$stack</span><span class="p">[</span><span class="nv">$#stack</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]};</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$remainder</span> <span class="o">=~</span><span class="sr"> /^#\s*endif\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$level</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@</span><span class="p">{</span><span class="nb">pop</span><span class="p">(</span><span class="nv">@stack</span><span class="p">)};</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Statement ends at the ';' or a close '}' at the
outermost level.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$level</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$c</span> <span class="ow">eq</span> <span class="s">&#39;;&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">last</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>An else is really a conditional as long as its not else if</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$level</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$coff_set</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$p</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$p</span> <span class="o">=~</span><span class="sr"> /(?:\s|\}|\+)/</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$remainder</span> <span class="o">=~</span><span class="sr"> /^(else)(?:\s|{)/</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$remainder</span> <span class="o">!~</span> <span class="sr">/^else\s+if\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$coff</span> <span class="o">=</span> <span class="nv">$off</span> <span class="o">+</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="nv">$coff_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>warn "CSB: mark coff&lt;$coff> soff&lt;$soff> 1&lt;$1>\n";
warn "[" . substr($blk, $soff, $coff - $soff + 1) . "]\n";</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span> <span class="o">||</span> <span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;(&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$c</span> <span class="ow">eq</span> <span class="s">&#39;(&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$level</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;(&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;(&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$c</span> <span class="ow">eq</span> <span class="s">&#39;)&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$level</span><span class="o">--</span><span class="p">;</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)?</span> <span class="s">&#39;(&#39;</span> <span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$level</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$coff</span> <span class="o">&lt;</span> <span class="nv">$soff</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$coff</span> <span class="o">=</span> <span class="nv">$off</span><span class="p">;</span>
				<span class="nv">$coff_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>warn "CSB: mark coff&lt;$coff>\n";</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span> <span class="o">||</span> <span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;{&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$c</span> <span class="ow">eq</span> <span class="s">&#39;{&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$level</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;{&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;{&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$c</span> <span class="ow">eq</span> <span class="s">&#39;}&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$level</span><span class="o">--</span><span class="p">;</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)?</span> <span class="s">&#39;{&#39;</span> <span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$blk</span><span class="p">,</span> <span class="nv">$off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">eq</span> <span class="s">&#39;;&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$off</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">last</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Preprocessor commands end at the newline unless escaped.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;#&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$c</span> <span class="ow">eq</span> <span class="s">&quot;\n&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$p</span> <span class="ow">ne</span> <span class="s">&quot;\\&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$level</span><span class="o">--</span><span class="p">;</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
			<span class="nv">$off</span><span class="o">++</span><span class="p">;</span>
			<span class="k">last</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nv">$off</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>We are truly at the end, so shuffle to the next line.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$off</span> <span class="o">==</span> <span class="nv">$len</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$loff</span> <span class="o">=</span> <span class="nv">$len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="nv">$line</span><span class="o">++</span><span class="p">;</span>
		<span class="nv">$remain</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">my</span> <span class="nv">$statement</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$blk</span><span class="p">,</span> <span class="nv">$soff</span><span class="p">,</span> <span class="nv">$off</span> <span class="o">-</span> <span class="nv">$soff</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">my</span> <span class="nv">$condition</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$blk</span><span class="p">,</span> <span class="nv">$soff</span><span class="p">,</span> <span class="nv">$coff</span> <span class="o">-</span> <span class="nv">$soff</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>warn "STATEMENT&lt;$statement>\n";
warn "CONDITION&lt;$condition>\n";</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>print "coff&lt;$coff> soff&lt;$off> loff&lt;$loff>\n";</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="p">(</span><span class="nv">$statement</span><span class="p">,</span> <span class="nv">$condition</span><span class="p">,</span>
			<span class="nv">$line</span><span class="p">,</span> <span class="nv">$remain</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$off</span> <span class="o">-</span> <span class="nv">$loff</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$level</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">statement_lines</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$stmt</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Strip the diff line prefixes and rip blank lines at start and end.</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$stmt</span> <span class="o">=~</span> <span class="sr">s/(^|\n)./$1/g</span><span class="p">;</span>
	<span class="nv">$stmt</span> <span class="o">=~</span> <span class="sr">s/^\s*//</span><span class="p">;</span>
	<span class="nv">$stmt</span> <span class="o">=~</span> <span class="sr">s/\s*$//</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">@stmt_lines</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$stmt</span> <span class="o">=~</span><span class="sr"> /\n/g</span><span class="p">);</span>

	<span class="k">return</span> <span class="nv">$#stmt_lines</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">statement_rawlines</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$stmt</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">@stmt_lines</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$stmt</span> <span class="o">=~</span><span class="sr"> /\n/g</span><span class="p">);</span>

	<span class="k">return</span> <span class="nv">$#stmt_lines</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">statement_block_size</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$stmt</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="nv">$stmt</span> <span class="o">=~</span> <span class="sr">s/(^|\n)./$1/g</span><span class="p">;</span>
	<span class="nv">$stmt</span> <span class="o">=~</span> <span class="sr">s/^\s*{//</span><span class="p">;</span>
	<span class="nv">$stmt</span> <span class="o">=~</span> <span class="sr">s/}\s*$//</span><span class="p">;</span>
	<span class="nv">$stmt</span> <span class="o">=~</span> <span class="sr">s/^\s*//</span><span class="p">;</span>
	<span class="nv">$stmt</span> <span class="o">=~</span> <span class="sr">s/\s*$//</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">@stmt_lines</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$stmt</span> <span class="o">=~</span><span class="sr"> /\n/g</span><span class="p">);</span>
	<span class="k">my</span> <span class="nv">@stmt_statements</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$stmt</span> <span class="o">=~</span><span class="sr"> /;/g</span><span class="p">);</span>

	<span class="k">my</span> <span class="nv">$stmt_lines</span> <span class="o">=</span> <span class="nv">$#stmt_lines</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$stmt_statements</span> <span class="o">=</span> <span class="nv">$#stmt_statements</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$stmt_lines</span> <span class="o">&gt;</span> <span class="nv">$stmt_statements</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nv">$stmt_lines</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nv">$stmt_statements</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">ctx_statement_full</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">,</span> <span class="nv">$off</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$statement</span><span class="p">,</span> <span class="nv">$condition</span><span class="p">,</span> <span class="nv">$level</span><span class="p">);</span>

	<span class="k">my</span> <span class="p">(</span><span class="nv">@chunks</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Grab the first conditional/block pair.</p></td><td class="code"><div class="highlight"><pre>	<span class="p">(</span><span class="nv">$statement</span><span class="p">,</span> <span class="nv">$condition</span><span class="p">,</span> <span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="nv">$level</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">ctx_statement_block</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">,</span> <span class="nv">$off</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>print "F: c&lt;$condition> s&lt;$statement> remain&lt;$remain>\n";</p></td><td class="code"><div class="highlight"><pre>	<span class="nb">push</span><span class="p">(</span><span class="nv">@chunks</span><span class="p">,</span> <span class="p">[</span> <span class="nv">$condition</span><span class="p">,</span> <span class="nv">$statement</span> <span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$remain</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$condition</span> <span class="o">=~</span><span class="sr"> /^\s*(?:\n[+-])?\s*(?:if|else|do)\b/s</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="nv">$level</span><span class="p">,</span> <span class="nv">$linenr</span><span class="p">,</span> <span class="nv">@chunks</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Pull in the following conditional/block pairs and see if they
could continue the statement.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="p">(</span><span class="nv">$statement</span><span class="p">,</span> <span class="nv">$condition</span><span class="p">,</span> <span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="nv">$level</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">ctx_statement_block</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">,</span> <span class="nv">$off</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>print "C: c&lt;$condition> s&lt;$statement> remain&lt;$remain>\n";</p></td><td class="code"><div class="highlight"><pre>		<span class="k">last</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$remain</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$condition</span> <span class="o">=~</span><span class="sr"> /^(?:\s*\n[+-])*\s*(?:else|do)\b/s</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>print "C: push\n";</p></td><td class="code"><div class="highlight"><pre>		<span class="nb">push</span><span class="p">(</span><span class="nv">@chunks</span><span class="p">,</span> <span class="p">[</span> <span class="nv">$condition</span><span class="p">,</span> <span class="nv">$statement</span> <span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="nv">$level</span><span class="p">,</span> <span class="nv">$linenr</span><span class="p">,</span> <span class="nv">@chunks</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">ctx_block_get</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">,</span> <span class="nv">$outer</span><span class="p">,</span> <span class="nv">$open</span><span class="p">,</span> <span class="nv">$close</span><span class="p">,</span> <span class="nv">$off</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$line</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$start</span> <span class="o">=</span> <span class="nv">$linenr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$blk</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">@o</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">@c</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">@res</span> <span class="o">=</span> <span class="p">();</span>

	<span class="k">my</span> <span class="nv">$level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">@stack</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$level</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=</span> <span class="nv">$start</span><span class="p">;</span> <span class="nv">$remain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$line</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$rawlines</span><span class="p">[</span><span class="nv">$line</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^-/</span><span class="p">);</span>
		<span class="nv">$remain</span><span class="o">--</span><span class="p">;</span>

		<span class="nv">$blk</span> <span class="o">.=</span> <span class="nv">$rawlines</span><span class="p">[</span><span class="nv">$line</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>Handle nested #if/#else.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="nv">$line</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^.\s*#\s*(?:ifndef|ifdef|if)\s/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nb">push</span><span class="p">(</span><span class="nv">@stack</span><span class="p">,</span> <span class="nv">$level</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="nv">$line</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^.\s*#\s*(?:else|elif)\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$level</span> <span class="o">=</span> <span class="nv">$stack</span><span class="p">[</span><span class="nv">$#stack</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="nv">$line</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^.\s*#\s*endif\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$level</span> <span class="o">=</span> <span class="nb">pop</span><span class="p">(</span><span class="nv">@stack</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$c</span> <span class="p">(</span><span class="nb">split</span><span class="p">(</span><span class="sr">//</span><span class="p">,</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$line</span><span class="p">]))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><h1>print "C&lt;$c>L&lt;$level>&lt;$open$close>O&lt;$off>\n";</h1></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$off</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$off</span><span class="o">--</span><span class="p">;</span>
				<span class="k">next</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$c</span> <span class="ow">eq</span> <span class="nv">$close</span> <span class="o">&amp;&amp;</span> <span class="nv">$level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$level</span><span class="o">--</span><span class="p">;</span>
				<span class="k">last</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$c</span> <span class="ow">eq</span> <span class="nv">$open</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$level</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$outer</span> <span class="o">||</span> <span class="nv">$level</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="nb">push</span><span class="p">(</span><span class="nv">@res</span><span class="p">,</span> <span class="nv">$rawlines</span><span class="p">[</span><span class="nv">$line</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">last</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="nv">$level</span><span class="p">,</span> <span class="nv">@res</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">ctx_block_outer</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">my</span> <span class="p">(</span><span class="nv">$level</span><span class="p">,</span> <span class="nv">@r</span><span class="p">)</span> <span class="o">=</span> <span class="n">ctx_block_get</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;{&#39;</span><span class="p">,</span> <span class="s">&#39;}&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="nv">@r</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">ctx_block</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">my</span> <span class="p">(</span><span class="nv">$level</span><span class="p">,</span> <span class="nv">@r</span><span class="p">)</span> <span class="o">=</span> <span class="n">ctx_block_get</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;{&#39;</span><span class="p">,</span> <span class="s">&#39;}&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="nv">@r</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">ctx_statement</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">,</span> <span class="nv">$off</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">my</span> <span class="p">(</span><span class="nv">$level</span><span class="p">,</span> <span class="nv">@r</span><span class="p">)</span> <span class="o">=</span> <span class="n">ctx_block_get</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;(&#39;</span><span class="p">,</span> <span class="s">&#39;)&#39;</span><span class="p">,</span> <span class="nv">$off</span><span class="p">);</span>
	<span class="k">return</span> <span class="nv">@r</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">ctx_block_level</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ctx_block_get</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;{&#39;</span><span class="p">,</span> <span class="s">&#39;}&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">ctx_statement_level</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">,</span> <span class="nv">$off</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ctx_block_get</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$remain</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;(&#39;</span><span class="p">,</span> <span class="s">&#39;)&#39;</span><span class="p">,</span> <span class="nv">$off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">ctx_locate_comment</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$first_line</span><span class="p">,</span> <span class="nv">$end_line</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>Catch a comment on the end of the line itself.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="p">(</span><span class="nv">$current_comment</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$rawlines</span><span class="p">[</span><span class="nv">$end_line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=~</span> <span class="sr">m@.*(/\*.*\*/)\s*(?:\\\s*)?$@</span><span class="p">);</span>
	<span class="k">return</span> <span class="nv">$current_comment</span> <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$current_comment</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>Look through the context and try and figure out if there is a
comment.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="nv">$in_comment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nv">$current_comment</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$linenr</span> <span class="o">=</span> <span class="nv">$first_line</span><span class="p">;</span> <span class="nv">$linenr</span> <span class="o">&lt;</span> <span class="nv">$end_line</span><span class="p">;</span> <span class="nv">$linenr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="nv">$rawlines</span><span class="p">[</span><span class="nv">$linenr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>warn "           $line\n";</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$linenr</span> <span class="o">==</span> <span class="nv">$first_line</span> <span class="ow">and</span> <span class="nv">$line</span> <span class="o">=~</span> <span class="sr">m@^.\s*\*@</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$in_comment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span> <span class="sr">m@/\*@</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$in_comment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$in_comment</span> <span class="o">&amp;&amp;</span> <span class="nv">$current_comment</span> <span class="ow">ne</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$current_comment</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nv">$current_comment</span> <span class="o">.=</span> <span class="nv">$line</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$in_comment</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span> <span class="sr">m@\*/@</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$in_comment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nb">chomp</span><span class="p">(</span><span class="nv">$current_comment</span><span class="p">);</span>
	<span class="k">return</span><span class="p">(</span><span class="nv">$current_comment</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">ctx_has_comment</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$first_line</span><span class="p">,</span> <span class="nv">$end_line</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$cmt</span> <span class="o">=</span> <span class="n">ctx_locate_comment</span><span class="p">(</span><span class="nv">$first_line</span><span class="p">,</span> <span class="nv">$end_line</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><h1>print "LINE: $rawlines[$end_line - 1 ]\n";</h1>

<h1>print "CMMT: $cmt\n";</h1></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="p">(</span><span class="nv">$cmt</span> <span class="ow">ne</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">raw_line</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$cnt</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$offset</span> <span class="o">=</span> <span class="nv">$linenr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nv">$cnt</span><span class="o">++</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$line</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="nv">$cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$line</span> <span class="o">=</span> <span class="nv">$rawlines</span><span class="p">[</span><span class="nv">$offset</span><span class="o">++</span><span class="p">];</span>
		<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$line</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^-/</span><span class="p">);</span>
		<span class="nv">$cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nv">$line</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">cat_vet</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$vet</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$res</span><span class="p">,</span> <span class="nv">$coded</span><span class="p">);</span>

	<span class="nv">$res</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="nv">$vet</span> <span class="o">=~</span><span class="sr"> /([^[:cntrl:]]*)([[:cntrl:]]|$)/g</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$res</span> <span class="o">.=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$2</span> <span class="ow">ne</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$coded</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s">&quot;^%c&quot;</span><span class="p">,</span> <span class="nb">unpack</span><span class="p">(</span><span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="nv">$2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">64</span><span class="p">);</span>
			<span class="nv">$res</span> <span class="o">.=</span> <span class="nv">$coded</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nv">$res</span> <span class="o">=~</span> <span class="sr">s/$/\$/</span><span class="p">;</span>

	<span class="k">return</span> <span class="nv">$res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$av_preprocessor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$av_pending</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@av_paren_type</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$av_pend_colon</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">annotate_reset</span> <span class="p">{</span>
	<span class="nv">$av_preprocessor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nv">$av_pending</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span><span class="p">;</span>
	<span class="nv">@av_paren_type</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;E&#39;</span><span class="p">);</span>
	<span class="nv">$av_pend_colon</span> <span class="o">=</span> <span class="s">&#39;O&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">annotate_values</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$stream</span><span class="p">,</span> <span class="nv">$type</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$res</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$var</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span> <span class="n">x</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$stream</span><span class="p">);</span>
	<span class="k">my</span> <span class="nv">$cur</span> <span class="o">=</span> <span class="nv">$stream</span><span class="p">;</span>

	<span class="k">print</span> <span class="s">&quot;$stream\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nv">$cur</span><span class="p">))</span> <span class="p">{</span>
		<span class="nv">@av_paren_type</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;E&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$#av_paren_type</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">print</span> <span class="s">&quot; &lt;&quot;</span> <span class="o">.</span> <span class="nb">join</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nv">@av_paren_type</span><span class="p">)</span> <span class="o">.</span>
				<span class="s">&quot;&gt; &lt;$type&gt; &lt;$av_pending&gt;&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(\s+)/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;WS($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$1</span> <span class="o">=~</span><span class="sr"> /\n/</span> <span class="o">&amp;&amp;</span> <span class="nv">$av_preprocessor</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$type</span> <span class="o">=</span> <span class="nb">pop</span><span class="p">(</span><span class="nv">@av_paren_type</span><span class="p">);</span>
				<span class="nv">$av_preprocessor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(\(\s*$Type\s*)\)/</span> <span class="o">&amp;&amp;</span> <span class="nv">$av_pending</span> <span class="ow">eq</span> <span class="s">&#39;_&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;CAST($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nb">push</span><span class="p">(</span><span class="nv">@av_paren_type</span><span class="p">,</span> <span class="nv">$type</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;c&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^($Type)\s*(?:$Ident|,|\)|\(|\s*$)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;DECLARE($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;T&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^($Modifier)\s*/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;MODIFIER($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;T&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(\#\s*define\s*$Ident)(\(?)/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;DEFINE($1,$2)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$av_preprocessor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="nb">push</span><span class="p">(</span><span class="nv">@av_paren_type</span><span class="p">,</span> <span class="nv">$type</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$2</span> <span class="ow">ne</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$av_pending</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(\#\s*(?:undef\s*$Ident|include\b))/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;UNDEF($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$av_preprocessor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="nb">push</span><span class="p">(</span><span class="nv">@av_paren_type</span><span class="p">,</span> <span class="nv">$type</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(\#\s*(?:ifdef|ifndef|if))/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;PRE_START($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$av_preprocessor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="nb">push</span><span class="p">(</span><span class="nv">@av_paren_type</span><span class="p">,</span> <span class="nv">$type</span><span class="p">);</span>
			<span class="nb">push</span><span class="p">(</span><span class="nv">@av_paren_type</span><span class="p">,</span> <span class="nv">$type</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(\#\s*(?:else|elif))/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;PRE_RESTART($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$av_preprocessor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="nb">push</span><span class="p">(</span><span class="nv">@av_paren_type</span><span class="p">,</span> <span class="nv">$av_paren_type</span><span class="p">[</span><span class="nv">$#av_paren_type</span><span class="p">]);</span>

			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(\#\s*(?:endif))/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;PRE_END($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>

			<span class="nv">$av_preprocessor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>Assume all arms of the conditional end as this
one does, and continue as if the #endif was not here.</p></td><td class="code"><div class="highlight"><pre>			<span class="nb">pop</span><span class="p">(</span><span class="nv">@av_paren_type</span><span class="p">);</span>
			<span class="nb">push</span><span class="p">(</span><span class="nv">@av_paren_type</span><span class="p">,</span> <span class="nv">$type</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(\\\n)/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;PRECONT($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(__attribute__)\s*\(?/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;ATTR($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$av_pending</span> <span class="o">=</span> <span class="nv">$type</span><span class="p">;</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(sizeof)\s*(\()?/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;SIZEOF($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$2</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$av_pending</span> <span class="o">=</span> <span class="s">&#39;V&#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(if|while|for)\b/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;COND($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$av_pending</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span><span class="p">;</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr">/^(case)/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;CASE($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$av_pend_colon</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span><span class="p">;</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr">/^(return|else|goto|typeof|__typeof__)\b/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;KEYWORD($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(\()/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;PAREN(&#39;$1&#39;)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nb">push</span><span class="p">(</span><span class="nv">@av_paren_type</span><span class="p">,</span> <span class="nv">$av_pending</span><span class="p">);</span>
			<span class="nv">$av_pending</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span><span class="p">;</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(\))/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$new_type</span> <span class="o">=</span> <span class="nb">pop</span><span class="p">(</span><span class="nv">@av_paren_type</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$new_type</span> <span class="ow">ne</span> <span class="s">&#39;_&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$type</span> <span class="o">=</span> <span class="nv">$new_type</span><span class="p">;</span>
				<span class="k">print</span> <span class="s">&quot;PAREN(&#39;$1&#39;) -&gt; $type\n&quot;</span>
							<span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">print</span> <span class="s">&quot;PAREN(&#39;$1&#39;)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^($Ident)\s*\(/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;FUNC($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;V&#39;</span><span class="p">;</span>
			<span class="nv">$av_pending</span> <span class="o">=</span> <span class="s">&#39;V&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^($Ident\s*):(?:\s*\d+\s*(,|=|;))?/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$2</span> <span class="o">&amp;&amp;</span> <span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;C&#39;</span> <span class="o">||</span> <span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;T&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$av_pend_colon</span> <span class="o">=</span> <span class="s">&#39;B&#39;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;E&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$av_pend_colon</span> <span class="o">=</span> <span class="s">&#39;L&#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">print</span> <span class="s">&quot;IDENT_COLON($1,$type&gt;$av_pend_colon)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;V&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^($Ident|$Constant)/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;IDENT($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;V&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^($Assignment)/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;ASSIGN($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr">/^(;|{|})/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;END($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span><span class="p">;</span>
			<span class="nv">$av_pend_colon</span> <span class="o">=</span> <span class="s">&#39;O&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr">/^(,)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;COMMA($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(\?)/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;QUESTION($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(:)/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;COLON($1,$av_pend_colon)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>

			<span class="nb">substr</span><span class="p">(</span><span class="nv">$var</span><span class="p">,</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$res</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$av_pend_colon</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$av_pend_colon</span> <span class="ow">eq</span> <span class="s">&#39;C&#39;</span> <span class="o">||</span> <span class="nv">$av_pend_colon</span> <span class="ow">eq</span> <span class="s">&#39;L&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="nv">$av_pend_colon</span> <span class="o">=</span> <span class="s">&#39;O&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(\[)/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;CLOSE($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^(-(?![-&gt;])|\+(?!\+)|\*|\&amp;\&amp;|\&amp;)/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$variant</span><span class="p">;</span>

			<span class="k">print</span> <span class="s">&quot;OPV($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;V&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$variant</span> <span class="o">=</span> <span class="s">&#39;B&#39;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nv">$variant</span> <span class="o">=</span> <span class="s">&#39;U&#39;</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="nb">substr</span><span class="p">(</span><span class="nv">$var</span><span class="p">,</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$res</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$variant</span><span class="p">);</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /^($Operators)/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;OP($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$1</span> <span class="ow">ne</span> <span class="s">&#39;++&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$1</span> <span class="ow">ne</span> <span class="s">&#39;--&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$cur</span> <span class="o">=~</span><span class="sr"> /(^.)/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;C($1)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$1</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$cur</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$cur</span><span class="p">,</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$1</span><span class="p">));</span>
			<span class="nv">$res</span> <span class="o">.=</span> <span class="nv">$type</span> <span class="n">x</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="nv">$res</span><span class="p">,</span> <span class="nv">$var</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">possible</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$possible</span><span class="p">,</span> <span class="nv">$line</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$notPermitted</span> <span class="o">=</span> <span class="sx">qr{(?:</span>
<span class="sx">		^(?:</span>
<span class="sx">			$Modifier|</span>
<span class="sx">			$Storage|</span>
<span class="sx">			$Type|</span>
<span class="sx">			DEFINE_\S+</span>
<span class="sx">		)$|</span>
<span class="sx">		^(?:</span>
<span class="sx">			goto|</span>
<span class="sx">			return|</span>
<span class="sx">			case|</span>
<span class="sx">			else|</span>
<span class="sx">			asm|__asm__|</span>
<span class="sx">			do|</span>
<span class="sx">			\#|</span>
<span class="sx">			\#\#|</span>
<span class="sx">		)(?:\s|$)|</span>
<span class="sx">		^(?:typedef|struct|enum)\b</span>
<span class="sx">	    )}</span><span class="n">x</span><span class="p">;</span>
	<span class="nb">warn</span> <span class="s">&quot;CHECK&lt;$possible&gt; ($line)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_possible</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$possible</span> <span class="o">!~</span> <span class="nv">$notPermitted</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>Check for modifiers.</p></td><td class="code"><div class="highlight"><pre>		<span class="nv">$possible</span> <span class="o">=~</span> <span class="sr">s/\s*$Storage\s*//g</span><span class="p">;</span>
		<span class="nv">$possible</span> <span class="o">=~</span> <span class="sr">s/\s*$Sparse\s*//g</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$possible</span> <span class="o">=~</span><span class="sr"> /^\s*$/</span><span class="p">)</span> <span class="p">{</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$possible</span> <span class="o">=~</span><span class="sr"> /\s/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$possible</span> <span class="o">=~</span> <span class="sr">s/\s*$Type\s*//g</span><span class="p">;</span>
			<span class="k">for</span> <span class="k">my</span> <span class="nv">$modifier</span> <span class="p">(</span><span class="nb">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="nv">$possible</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$modifier</span> <span class="o">!~</span> <span class="nv">$notPermitted</span><span class="p">)</span> <span class="p">{</span>
					<span class="nb">warn</span> <span class="s">&quot;MODIFIER: $modifier ($possible) ($line)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_possible</span><span class="p">);</span>
					<span class="nb">push</span><span class="p">(</span><span class="nv">@modifierList</span><span class="p">,</span> <span class="nv">$modifier</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nb">warn</span> <span class="s">&quot;POSSIBLE: $possible ($line)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_possible</span><span class="p">);</span>
			<span class="nb">push</span><span class="p">(</span><span class="nv">@typeList</span><span class="p">,</span> <span class="nv">$possible</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">build_types</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nb">warn</span> <span class="s">&quot;NOTPOSS: $possible ($line)\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_possible</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">show_type</span> <span class="p">{</span>
       <span class="k">return</span> <span class="o">!</span><span class="nb">defined</span> <span class="nv">$ignore_type</span><span class="p">{</span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">]};</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">report</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">show_type</span><span class="p">(</span><span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">||</span>
	    <span class="p">(</span><span class="nb">defined</span> <span class="nv">$tst_only</span> <span class="o">&amp;&amp;</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!~</span> <span class="sr">/\Q$tst_only\E/</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">my</span> <span class="nv">$line</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$show_types</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$line</span> <span class="o">=</span> <span class="s">&quot;$prefix$_[0]:$_[1]: $_[2]\n&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nv">$line</span> <span class="o">=</span> <span class="s">&quot;$prefix$_[0]: $_[2]\n&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nv">$line</span> <span class="o">=</span> <span class="p">(</span><span class="nb">split</span><span class="p">(</span><span class="s">&#39;\n&#39;</span><span class="p">,</span> <span class="nv">$line</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$terse</span><span class="p">);</span>

	<span class="nb">push</span><span class="p">(</span><span class="k">our</span> <span class="nv">@report</span><span class="p">,</span> <span class="nv">$line</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">report_dump</span> <span class="p">{</span>
	<span class="k">our</span> <span class="nv">@report</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">ERROR</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="p">(</span><span class="s">&quot;ERROR&quot;</span><span class="p">,</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
		<span class="k">our</span> <span class="nv">$clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">our</span> <span class="nv">$cnt_error</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">WARN</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="p">(</span><span class="s">&quot;WARNING&quot;</span><span class="p">,</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
		<span class="k">our</span> <span class="nv">$clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">our</span> <span class="nv">$cnt_warn</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">CHK</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$check</span> <span class="o">&amp;&amp;</span> <span class="n">report</span><span class="p">(</span><span class="s">&quot;CHECK&quot;</span><span class="p">,</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
		<span class="k">our</span> <span class="nv">$clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">our</span> <span class="nv">$cnt_chk</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">check_absolute_file</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$absolute</span><span class="p">,</span> <span class="nv">$herecurr</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$absolute</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><h1>print "absolute&lt;$absolute>\n";</h1></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>See if any suffix of this path is a path within the tree.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">while</span> <span class="p">(</span><span class="nv">$file</span> <span class="o">=~</span> <span class="sr">s@^[^/]*/@@</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">f</span> <span class="s">&quot;$root/$file&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><h1>print "file&lt;$file>\n";</h1></td><td class="code"><div class="highlight"><pre>			<span class="k">last</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">-</span><span class="n">f</span> <span class="n">_</span><span class="p">)</span>  <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>It is, so see if the prefix is acceptable.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="nv">$prefix</span> <span class="o">=</span> <span class="nv">$absolute</span><span class="p">;</span>
	<span class="nb">substr</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">,</span> <span class="o">-</span><span class="nb">length</span><span class="p">(</span><span class="nv">$file</span><span class="p">))</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><h1>print "prefix&lt;$prefix>\n";</h1></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$prefix</span> <span class="ow">ne</span> <span class="s">&quot;.../&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;USE_RELATIVE_PATH&quot;</span><span class="p">,</span>
		     <span class="s">&quot;use relative pathname instead of absolute in changelog text\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">pos_last_openparen</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$line</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$opens</span> <span class="o">=</span> <span class="nv">$line</span> <span class="o">=~</span> <span class="nb">tr</span><span class="sr">/\(/</span><span class="o">\</span><span class="p">(</span><span class="sr">/;</span>
<span class="sr">	my $closes = $line =~ tr/</span><span class="o">\</span><span class="p">)</span><span class="sr">/\)/</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$last_openparen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="nv">$opens</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$closes</span> <span class="o">&gt;=</span> <span class="nv">$opens</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">my</span> <span class="nv">$len</span> <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$line</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="nv">$pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$pos</span> <span class="o">&lt;</span> <span class="nv">$len</span><span class="p">;</span> <span class="nv">$pos</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$string</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="nv">$pos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$string</span> <span class="o">=~</span><span class="sr"> /^($FuncArg|$balanced_parens)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$pos</span> <span class="o">+=</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="nv">$pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">eq</span> <span class="s">&#39;(&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$last_openparen</span> <span class="o">=</span> <span class="nv">$pos</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nb">index</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="s">&#39;(&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">last</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nv">$last_openparen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">process</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$filename</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$linenr</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$prevline</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$prevrawline</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$stashline</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$stashrawline</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$length</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$indent</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$previndent</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$stashindent</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">our</span> <span class="nv">$clean</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$signoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$is_patch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$in_header_lines</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$in_commit_log</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="c1">#Scanning lines before patch</span>

	<span class="k">our</span> <span class="nv">@report</span> <span class="o">=</span> <span class="p">();</span>
	<span class="k">our</span> <span class="nv">$cnt_lines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">our</span> <span class="nv">$cnt_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">our</span> <span class="nv">$cnt_warn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">our</span> <span class="nv">$cnt_chk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>Trace the real file/line as we go.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="nv">$realfile</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$realline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$realcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$here</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$in_comment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$comment_edge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$first_line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$p1_prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$prev_values</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>suppression flags</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="nv">%suppress_ifbraces</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">%suppress_whiletrailers</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">%suppress_export</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$suppress_statement</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>Pre-scan the patch sanitizing the lines.
Pre-scan the patch looking for any __setup documentation.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="nv">@setup_docs</span> <span class="o">=</span> <span class="p">();</span>
	<span class="k">my</span> <span class="nv">$setup_docs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sanitise_line_reset</span><span class="p">();</span>
	<span class="k">my</span> <span class="nv">$line</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$rawline</span> <span class="p">(</span><span class="nv">@rawlines</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$linenr</span><span class="o">++</span><span class="p">;</span>
		<span class="nv">$line</span> <span class="o">=</span> <span class="nv">$rawline</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$rawline</span><span class="o">=~</span><span class="sr">/^\+\+\+\s+(\S+)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$setup_docs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$1</span> <span class="o">=~</span> <span class="sr">m@Documentation/kernel-parameters.txt$@</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$setup_docs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>next;</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$rawline</span><span class="o">=~</span><span class="sr">/^\@\@ -\d+(?:,\d+)? \+(\d+)(,(\d+))? \@\@/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$realline</span><span class="o">=</span><span class="nv">$1</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$2</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$realcnt</span><span class="o">=</span><span class="nv">$3</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nv">$realcnt</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="nv">$in_comment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>Guestimate if this is a continuing comment.  Run
the context looking for a comment "edge".  If this
edge is a close comment then we must be in a comment
at context start.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">my</span> <span class="nv">$edge</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$cnt</span> <span class="o">=</span> <span class="nv">$realcnt</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$ln</span> <span class="o">=</span> <span class="nv">$linenr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$ln</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$rawlines</span><span class="p">[</span><span class="nv">$ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
					 <span class="nv">$rawlines</span><span class="p">[</span><span class="nv">$ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^-/</span><span class="p">);</span>
				<span class="nv">$cnt</span><span class="o">--</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>print "RAW&lt;$rawlines[$ln - 1]>\n";</p></td><td class="code"><div class="highlight"><pre>				<span class="k">last</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$rawlines</span><span class="p">[</span><span class="nv">$ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$rawlines</span><span class="p">[</span><span class="nv">$ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=~</span> <span class="sr">m@(/\*|\*/)@</span> <span class="o">&amp;&amp;</span>
				    <span class="nv">$rawlines</span><span class="p">[</span><span class="nv">$ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!~</span> <span class="sr">m@&quot;[^&quot;]*(?:/\*|\*/)[^&quot;]*&quot;@</span><span class="p">)</span> <span class="p">{</span>
					<span class="p">(</span><span class="nv">$edge</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
					<span class="k">last</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$edge</span> <span class="o">&amp;&amp;</span> <span class="nv">$edge</span> <span class="ow">eq</span> <span class="s">&#39;*/&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$in_comment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>Guestimate if this is a continuing comment.  If this
is the start of a diff block and this line starts
' *' then it is very likely a comment.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$edge</span> <span class="o">&amp;&amp;</span>
			    <span class="nv">$rawlines</span><span class="p">[</span><span class="nv">$linenr</span><span class="p">]</span> <span class="o">=~</span> <span class="sr">m@^.\s*(?:\*\*+| \*)(?:\s|$)@</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="nv">$in_comment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><h1>print "COMMENT:$in_comment edge&lt;$edge> $rawline\n";</h1></td><td class="code"><div class="highlight"><pre>			<span class="n">sanitise_line_reset</span><span class="p">(</span><span class="nv">$in_comment</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$realcnt</span> <span class="o">&amp;&amp;</span> <span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> /^(?:\+| |$)/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>Standardise the strings and chars within the input to
simplify matching -- only bother with positive lines.</p></td><td class="code"><div class="highlight"><pre>			<span class="nv">$line</span> <span class="o">=</span> <span class="n">sanitise_line</span><span class="p">(</span><span class="nv">$rawline</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="nb">push</span><span class="p">(</span><span class="nv">@lines</span><span class="p">,</span> <span class="nv">$line</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$realcnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$realcnt</span><span class="o">--</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^(?:\+| |$)/</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nv">$realcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>print "==>$rawline\n";
print "-->$line\n";</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$setup_docs</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^\+/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nb">push</span><span class="p">(</span><span class="nv">@setup_docs</span><span class="p">,</span> <span class="nv">$line</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nv">$prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>

	<span class="nv">$realcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nv">$linenr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$line</span> <span class="p">(</span><span class="nv">@lines</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$linenr</span><span class="o">++</span><span class="p">;</span>

		<span class="k">my</span> <span class="nv">$rawline</span> <span class="o">=</span> <span class="nv">$rawlines</span><span class="p">[</span><span class="nv">$linenr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>extract the line range in the file after the patch is applied</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span><span class="o">=~</span><span class="sr">/^\@\@ -\d+(?:,\d+)? \+(\d+)(,(\d+))? \@\@/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$is_patch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="nv">$first_line</span> <span class="o">=</span> <span class="nv">$linenr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="nv">$realline</span><span class="o">=</span><span class="nv">$1</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$2</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$realcnt</span><span class="o">=</span><span class="nv">$3</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nv">$realcnt</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">annotate_reset</span><span class="p">();</span>
			<span class="nv">$prev_values</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span><span class="p">;</span>

			<span class="nv">%suppress_ifbraces</span> <span class="o">=</span> <span class="p">();</span>
			<span class="nv">%suppress_whiletrailers</span> <span class="o">=</span> <span class="p">();</span>
			<span class="nv">%suppress_export</span> <span class="o">=</span> <span class="p">();</span>
			<span class="nv">$suppress_statement</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">next</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>track the line number as we move through the hunk, note that
new versions of GNU diff omit the leading space on completely
blank context lines so we need to count that too.</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^( |\+|$)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$realline</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$realcnt</span><span class="o">--</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$realcnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>Measure the line length and indent.</p></td><td class="code"><div class="highlight"><pre>			<span class="p">(</span><span class="nv">$length</span><span class="p">,</span> <span class="nv">$indent</span><span class="p">)</span> <span class="o">=</span> <span class="n">line_stats</span><span class="p">(</span><span class="nv">$rawline</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>Track the previous line.</p></td><td class="code"><div class="highlight"><pre>			<span class="p">(</span><span class="nv">$prevline</span><span class="p">,</span> <span class="nv">$stashline</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$stashline</span><span class="p">,</span> <span class="nv">$line</span><span class="p">);</span>
			<span class="p">(</span><span class="nv">$previndent</span><span class="p">,</span> <span class="nv">$stashindent</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$stashindent</span><span class="p">,</span> <span class="nv">$indent</span><span class="p">);</span>
			<span class="p">(</span><span class="nv">$prevrawline</span><span class="p">,</span> <span class="nv">$stashrawline</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$stashrawline</span><span class="p">,</span> <span class="nv">$rawline</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>warn "line&lt;$line>\n";</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$realcnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$realcnt</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">my</span> <span class="nv">$hunk_line</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$realcnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>make up the handle for any error we report on this line</p></td><td class="code"><div class="highlight"><pre>		<span class="nv">$prefix</span> <span class="o">=</span> <span class="s">&quot;$filename:$realline: &quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$emacs</span> <span class="o">&amp;&amp;</span> <span class="nv">$file</span><span class="p">);</span>
		<span class="nv">$prefix</span> <span class="o">=</span> <span class="s">&quot;$filename:$linenr: &quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$emacs</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$file</span><span class="p">);</span>

		<span class="nv">$here</span> <span class="o">=</span> <span class="s">&quot;#$linenr: &quot;</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$file</span><span class="p">);</span>
		<span class="nv">$here</span> <span class="o">=</span> <span class="s">&quot;#$realline: &quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$file</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>extract the filename as it passes</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^diff --git.*?(\S+)$/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$realfile</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="nv">$realfile</span> <span class="o">=~</span> <span class="sr">s@^([^/]*)/@@</span><span class="p">;</span>
			<span class="nv">$in_commit_log</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^\+\+\+\s+(\S+)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$realfile</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="nv">$realfile</span> <span class="o">=~</span> <span class="sr">s@^([^/]*)/@@</span><span class="p">;</span>
			<span class="nv">$in_commit_log</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="nv">$p1_prefix</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$file</span> <span class="o">&amp;&amp;</span> <span class="nv">$tree</span> <span class="o">&amp;&amp;</span> <span class="nv">$p1_prefix</span> <span class="ow">ne</span> <span class="s">&#39;&#39;</span> <span class="o">&amp;&amp;</span>
			    <span class="o">-</span><span class="n">e</span> <span class="s">&quot;$root/$p1_prefix&quot;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;PATCH_PREFIX&quot;</span><span class="p">,</span>
				     <span class="s">&quot;patch prefix &#39;$p1_prefix&#39; exists, appears to be a -p0 patch\n&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$realfile</span> <span class="o">=~</span> <span class="sr">m@^include/asm/@</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;MODIFIED_INCLUDE_ASM&quot;</span><span class="p">,</span>
				      <span class="s">&quot;do not modify files in include/asm, change architecture specific files in include/asm-&lt;architecture&gt;\n&quot;</span> <span class="o">.</span> <span class="s">&quot;$here$rawline\n&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nv">$here</span> <span class="o">.=</span> <span class="s">&quot;FILE: $realfile:$realline:&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$realcnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">my</span> <span class="nv">$hereline</span> <span class="o">=</span> <span class="s">&quot;$here\n$rawline\n&quot;</span><span class="p">;</span>
		<span class="k">my</span> <span class="nv">$herecurr</span> <span class="o">=</span> <span class="s">&quot;$here\n$rawline\n&quot;</span><span class="p">;</span>
		<span class="k">my</span> <span class="nv">$hereprev</span> <span class="o">=</span> <span class="s">&quot;$here\n$prevrawline\n$rawline\n&quot;</span><span class="p">;</span>

		<span class="nv">$cnt_lines</span><span class="o">++</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$realcnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>Check for incorrect file permissions</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^new (file )?mode.*[7531]\d{0,2}$/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$permhere</span> <span class="o">=</span> <span class="nv">$here</span> <span class="o">.</span> <span class="s">&quot;FILE: $realfile\n&quot;</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$realfile</span> <span class="o">=~</span><span class="sr"> /(Makefile|Kconfig|\.c|\.h|\.S|\.tmpl)$/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;EXECUTE_PERMISSIONS&quot;</span><span class="p">,</span>
				      <span class="s">&quot;do not set execute permissions for source files\n&quot;</span> <span class="o">.</span> <span class="nv">$permhere</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>Check the patch for a signoff:</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^\s*signed-off-by:/i</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$signoff</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$in_commit_log</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>Check signature styles</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$in_header_lines</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^(\s*)($signature_tags)(\s*)(.*)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$space_before</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$sign_off</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$space_after</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$email</span> <span class="o">=</span> <span class="nv">$4</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$ucfirst_sign_off</span> <span class="o">=</span> <span class="nb">ucfirst</span><span class="p">(</span><span class="nb">lc</span><span class="p">(</span><span class="nv">$sign_off</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$space_before</span> <span class="o">&amp;&amp;</span> <span class="nv">$space_before</span> <span class="ow">ne</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;BAD_SIGN_OFF&quot;</span><span class="p">,</span>
				     <span class="s">&quot;Do not use whitespace before $ucfirst_sign_off\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$sign_off</span> <span class="o">=~</span><span class="sr"> /-by:$/i</span> <span class="o">&amp;&amp;</span> <span class="nv">$sign_off</span> <span class="ow">ne</span> <span class="nv">$ucfirst_sign_off</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;BAD_SIGN_OFF&quot;</span><span class="p">,</span>
				     <span class="s">&quot;&#39;$ucfirst_sign_off&#39; is the preferred signature form\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$space_after</span> <span class="o">||</span> <span class="nv">$space_after</span> <span class="ow">ne</span> <span class="s">&quot; &quot;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;BAD_SIGN_OFF&quot;</span><span class="p">,</span>
				     <span class="s">&quot;Use a single space after $ucfirst_sign_off\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">my</span> <span class="p">(</span><span class="nv">$email_name</span><span class="p">,</span> <span class="nv">$email_address</span><span class="p">,</span> <span class="nv">$comment</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_email</span><span class="p">(</span><span class="nv">$email</span><span class="p">);</span>
			<span class="k">my</span> <span class="nv">$suggested_email</span> <span class="o">=</span> <span class="n">format_email</span><span class="p">((</span><span class="nv">$email_name</span><span class="p">,</span> <span class="nv">$email_address</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$suggested_email</span> <span class="ow">eq</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;BAD_SIGN_OFF&quot;</span><span class="p">,</span>
				      <span class="s">&quot;Unrecognized email address: &#39;$email&#39;\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">my</span> <span class="nv">$dequoted</span> <span class="o">=</span> <span class="nv">$suggested_email</span><span class="p">;</span>
				<span class="nv">$dequoted</span> <span class="o">=~</span> <span class="sr">s/^&quot;//</span><span class="p">;</span>
				<span class="nv">$dequoted</span> <span class="o">=~</span> <span class="sr">s/&quot; &lt;/ &lt;/</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>Don't force email to have quotes
Allow just an angle bracketed address</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="s">&quot;$dequoted$comment&quot;</span> <span class="ow">ne</span> <span class="nv">$email</span> <span class="o">&amp;&amp;</span>
				    <span class="s">&quot;&lt;$email_address&gt;$comment&quot;</span> <span class="ow">ne</span> <span class="nv">$email</span> <span class="o">&amp;&amp;</span>
				    <span class="s">&quot;$suggested_email$comment&quot;</span> <span class="ow">ne</span> <span class="nv">$email</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;BAD_SIGN_OFF&quot;</span><span class="p">,</span>
					     <span class="s">&quot;email address &#39;$email&#39; might be better as &#39;$suggested_email$comment&#39;\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>Check for wrappage within a valid hunk of the file</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$realcnt</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">m{^(?:\+|-| |\\ No newline|$)}</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;CORRUPTED_PATCH&quot;</span><span class="p">,</span>
			      <span class="s">&quot;patch seems to be corrupt (line wrapped?)\n&quot;</span> <span class="o">.</span>
				<span class="nv">$herecurr</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$emitted_corrupt</span><span class="o">++</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>Check for absolute kernel paths.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$tree</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span> <span class="sr">m{(?:^|\s)(/\S*)}g</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="nv">$file</span> <span class="o">=~</span> <span class="sr">m{^(.*?)(?::\d+)+:?$}</span> <span class="o">&amp;&amp;</span>
				    <span class="n">check_absolute_file</span><span class="p">(</span><span class="nv">$1</span><span class="p">,</span> <span class="nv">$herecurr</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">check_absolute_file</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$herecurr</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>UTF-8 regex found at http://www.w3.org/International/questions/qa-forms-utf-8.en.php</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="nv">$realfile</span> <span class="o">=~</span><span class="sr"> /^$/</span> <span class="o">||</span> <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^\+/</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$rawline</span> <span class="o">!~</span> <span class="sr">m/^$UTF8*$/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="p">(</span><span class="nv">$utf8_prefix</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> /^($UTF8*)/</span><span class="p">);</span>

			<span class="k">my</span> <span class="nv">$blank</span> <span class="o">=</span> <span class="n">copy_spacing</span><span class="p">(</span><span class="nv">$rawline</span><span class="p">);</span>
			<span class="k">my</span> <span class="nv">$ptr</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$blank</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$utf8_prefix</span><span class="p">))</span> <span class="o">.</span> <span class="s">&quot;^&quot;</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$hereptr</span> <span class="o">=</span> <span class="s">&quot;$hereline$ptr\n&quot;</span><span class="p">;</span>

			<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;INVALID_UTF8&quot;</span><span class="p">,</span>
			    <span class="s">&quot;Invalid UTF-8, patch and commit message should be encoded in UTF-8\n&quot;</span> <span class="o">.</span> <span class="nv">$hereptr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>Check if it's the start of a commit log
(not a header line and we haven't seen the patch filename)</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$in_header_lines</span> <span class="o">&amp;&amp;</span> <span class="nv">$realfile</span> <span class="o">=~</span><span class="sr"> /^$/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$rawline</span> <span class="o">!~</span> <span class="sr">/^(commit\b|from\b|[\w-]+:).+$/i</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$in_header_lines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="nv">$in_commit_log</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>Still not yet in a patch, check for any UTF-8</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$in_commit_log</span> <span class="o">&amp;&amp;</span> <span class="nv">$realfile</span> <span class="o">=~</span><span class="sr"> /^$/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> /$NON_ASCII_UTF8/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;UTF8_BEFORE_PATCH&quot;</span><span class="p">,</span>
			    <span class="s">&quot;8-bit UTF-8 used in possible commit log\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>ignore non-hunk lines and lines being removed</p></td><td class="code"><div class="highlight"><pre>		<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$hunk_line</span> <span class="o">||</span> <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^-/</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>trailing whitespace</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^\+.*\015/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$herevet</span> <span class="o">=</span> <span class="s">&quot;$here\n&quot;</span> <span class="o">.</span> <span class="n">cat_vet</span><span class="p">(</span><span class="nv">$rawline</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;DOS_LINE_ENDINGS&quot;</span><span class="p">,</span>
			      <span class="s">&quot;DOS line endings\n&quot;</span> <span class="o">.</span> <span class="nv">$herevet</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> /^\+.*\S\s+$/</span> <span class="o">||</span> <span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> /^\+\s+$/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$herevet</span> <span class="o">=</span> <span class="s">&quot;$here\n&quot;</span> <span class="o">.</span> <span class="n">cat_vet</span><span class="p">(</span><span class="nv">$rawline</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;TRAILING_WHITESPACE&quot;</span><span class="p">,</span>
			      <span class="s">&quot;trailing whitespace\n&quot;</span> <span class="o">.</span> <span class="nv">$herevet</span><span class="p">);</span>
			<span class="nv">$rpt_cleaners</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>check for Kconfig help text having a real description
Only applies when adding the entry originally, after that we do not have
sufficient context to determine whether it is indeed long enough.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$realfile</span> <span class="o">=~</span><span class="sr"> /Kconfig/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /.\s*config\s+/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$cnt</span> <span class="o">=</span> <span class="nv">$realcnt</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$ln</span> <span class="o">=</span> <span class="nv">$linenr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$f</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$is_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$is_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="nv">$cnt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nb">defined</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span> <span class="nv">$ln</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$f</span> <span class="o">=</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="nv">$cnt</span><span class="o">--</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="nv">$ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!~</span> <span class="sr">/^-/</span><span class="p">);</span>
				<span class="nv">$is_end</span> <span class="o">=</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^\+/</span><span class="p">;</span>

				<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$f</span> <span class="o">=~</span><span class="sr"> /^-/</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="nv">$ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /.\s*(?:bool|tristate)\s*\&quot;/</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$is_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="nv">$ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /.\s*(?:---)?help(?:---)?$/</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$length</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="nv">$f</span> <span class="o">=~</span> <span class="sr">s/^.//</span><span class="p">;</span>
				<span class="nv">$f</span> <span class="o">=~</span> <span class="sr">s/#.*//</span><span class="p">;</span>
				<span class="nv">$f</span> <span class="o">=~</span> <span class="sr">s/^\s+//</span><span class="p">;</span>
				<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$f</span> <span class="o">=~</span><span class="sr"> /^$/</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$f</span> <span class="o">=~</span><span class="sr"> /^\s*config\s/</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$is_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">last</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="nv">$length</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;CONFIG_DESCRIPTION&quot;</span><span class="p">,</span>
			     <span class="s">&quot;please write a paragraph that describes the config symbol fully\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$is_start</span> <span class="o">&amp;&amp;</span> <span class="nv">$is_end</span> <span class="o">&amp;&amp;</span> <span class="nv">$length</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>print "is<em>start&lt;$is</em>start> is<em>end&lt;$is</em>end> length&lt;$length>\n";</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="nv">$realfile</span> <span class="o">=~</span><span class="sr"> /Makefile.*/</span> <span class="o">||</span> <span class="nv">$realfile</span> <span class="o">=~</span><span class="sr"> /Kbuild.*/</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\+(EXTRA_[A-Z]+FLAGS).*/</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$flag</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$replacement</span> <span class="o">=</span> <span class="p">{</span>
				<span class="s">&#39;EXTRA_AFLAGS&#39;</span> <span class="o">=&gt;</span>   <span class="s">&#39;asflags-y&#39;</span><span class="p">,</span>
				<span class="s">&#39;EXTRA_CFLAGS&#39;</span> <span class="o">=&gt;</span>   <span class="s">&#39;ccflags-y&#39;</span><span class="p">,</span>
				<span class="s">&#39;EXTRA_CPPFLAGS&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;cppflags-y&#39;</span><span class="p">,</span>
				<span class="s">&#39;EXTRA_LDFLAGS&#39;</span> <span class="o">=&gt;</span>  <span class="s">&#39;ldflags-y&#39;</span><span class="p">,</span>
			<span class="p">};</span>

			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;DEPRECATED_VARIABLE&quot;</span><span class="p">,</span>
			     <span class="s">&quot;Use of $flag is deprecated, please use \`$replacement-&gt;{$flag} instead.\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$replacement</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$flag</span><span class="p">});</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>check we are in a valid source file if not then ignore this hunk</p></td><td class="code"><div class="highlight"><pre>		<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$realfile</span> <span class="o">!~</span> <span class="sr">/\.(h|c|s|S|pl|sh)$/</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>80 column limit</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^\+/</span> <span class="o">&amp;&amp;</span> <span class="nv">$prevrawline</span> <span class="o">!~</span> <span class="sr">/\/\*\*/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$rawline</span> <span class="o">!~</span> <span class="sr">/^.\s*\*\s*\@$Ident\s/</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^\+\s*$logFunctions\s*\(\s*(?:(KERN_\S+\s*|[^&quot;]*))?&quot;[X\t]*&quot;\s*(?:|,|\)\s*;)\s*$/</span> <span class="o">||</span>
		    <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^\+\s*&quot;[^&quot;]*&quot;\s*(?:\s*|,|\)\s*;)\s*$/</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$length</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;LONG_LINE&quot;</span><span class="p">,</span>
			     <span class="s">&quot;line over 80 characters\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>Check for user-visible strings broken across lines, which breaks the ability
to grep for the string.  Limited to strings used as parameters (those
following an open parenthesis), which almost completely eliminates false
positives, as well as warning only once per parameter rather than once per
line of the string.  Make an exception when the previous string ends in a
newline (multiple lines in one string constant) or \n\t (common in inline
assembly to indent the instruction on the following line).</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^\+\s*&quot;/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$prevline</span> <span class="o">=~</span><span class="sr"> /&quot;\s*$/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$prevline</span> <span class="o">=~</span><span class="sr"> /\(/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$prevrawline</span> <span class="o">!~</span> <span class="sr">/\\n(?:\\t)*&quot;\s*$/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;SPLIT_STRING&quot;</span><span class="p">,</span>
			     <span class="s">&quot;quoted string split across lines\n&quot;</span> <span class="o">.</span> <span class="nv">$hereprev</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>check for spaces before a quoted newline</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> /^.*\&quot;.*\s\\n/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;QUOTED_WHITESPACE_BEFORE_NEWLINE&quot;</span><span class="p">,</span>
			     <span class="s">&quot;unnecessary whitespace before a quoted newline\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>check for adding lines without a newline.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^\+/</span> <span class="o">&amp;&amp;</span> <span class="nb">defined</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$linenr</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$linenr</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^\\ No newline at end of file/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;MISSING_EOF_NEWLINE&quot;</span><span class="p">,</span>
			     <span class="s">&quot;adding a line without newline at end of file\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>Blackfin: use hi/lo macros</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$realfile</span> <span class="o">=~</span> <span class="sr">m@arch/blackfin/.*\.S$@</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\.[lL][[:space:]]*=.*&amp;[[:space:]]*0x[fF][fF][fF][fF]/</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">my</span> <span class="nv">$herevet</span> <span class="o">=</span> <span class="s">&quot;$here\n&quot;</span> <span class="o">.</span> <span class="n">cat_vet</span><span class="p">(</span><span class="nv">$line</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;LO_MACRO&quot;</span><span class="p">,</span>
				      <span class="s">&quot;use the LO() macro, not (... &amp; 0xFFFF)\n&quot;</span> <span class="o">.</span> <span class="nv">$herevet</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\.[hH][[:space:]]*=.*&gt;&gt;[[:space:]]*16/</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">my</span> <span class="nv">$herevet</span> <span class="o">=</span> <span class="s">&quot;$here\n&quot;</span> <span class="o">.</span> <span class="n">cat_vet</span><span class="p">(</span><span class="nv">$line</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;HI_MACRO&quot;</span><span class="p">,</span>
				      <span class="s">&quot;use the HI() macro, not (... &gt;&gt; 16)\n&quot;</span> <span class="o">.</span> <span class="nv">$herevet</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><p>check we are in a valid source file C or perl if not then ignore this hunk</p></td><td class="code"><div class="highlight"><pre>		<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$realfile</span> <span class="o">!~</span> <span class="sr">/\.(h|c|pl)$/</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><p>at the beginning of a line any tabs must come first and anything
more than 8 must use tabs.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> /^\+\s* \t\s*\S/</span> <span class="o">||</span>
		    <span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> /^\+\s*        \s*/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$herevet</span> <span class="o">=</span> <span class="s">&quot;$here\n&quot;</span> <span class="o">.</span> <span class="n">cat_vet</span><span class="p">(</span><span class="nv">$rawline</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;CODE_INDENT&quot;</span><span class="p">,</span>
			      <span class="s">&quot;code indent should use tabs where possible\n&quot;</span> <span class="o">.</span> <span class="nv">$herevet</span><span class="p">);</span>
			<span class="nv">$rpt_cleaners</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>check for space before tabs.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> /^\+/</span> <span class="o">&amp;&amp;</span> <span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> / \t/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$herevet</span> <span class="o">=</span> <span class="s">&quot;$here\n&quot;</span> <span class="o">.</span> <span class="n">cat_vet</span><span class="p">(</span><span class="nv">$rawline</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;SPACE_BEFORE_TAB&quot;</span><span class="p">,</span>
			     <span class="s">&quot;please, no space before tabs\n&quot;</span> <span class="o">.</span> <span class="nv">$herevet</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>check for &amp;&amp; or || at the start of a line</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> /^\+\s*(&amp;&amp;|\|\|)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;LOGICAL_CONTINUATIONS&quot;</span><span class="p">,</span>
			    <span class="s">&quot;Logical continuations should be on the previous line\n&quot;</span> <span class="o">.</span> <span class="nv">$hereprev</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>check multi-line statement indentation matches previous line</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$</span><span class="err">^</span><span class="nv">V</span> <span class="o">&amp;&amp;</span> <span class="nv">$</span><span class="err">^</span><span class="nv">V</span> <span class="ow">ge</span> <span class="mf">5.10.0</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$prevline</span> <span class="o">=~</span><span class="sr"> /^\+(\t*)(if \(|$Ident\().*(\&amp;\&amp;|\|\||,)\s*$/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$prevline</span> <span class="o">=~</span><span class="sr"> /^\+(\t*)(.*)$/</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$oldindent</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$rest</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>

			<span class="k">my</span> <span class="nv">$pos</span> <span class="o">=</span> <span class="n">pos_last_openparen</span><span class="p">(</span><span class="nv">$rest</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^\+([ \t]*)/</span><span class="p">;</span>
				<span class="k">my</span> <span class="nv">$newindent</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>

				<span class="k">my</span> <span class="nv">$goodtabindent</span> <span class="o">=</span> <span class="nv">$oldindent</span> <span class="o">.</span>
					<span class="s">&quot;\t&quot;</span> <span class="n">x</span> <span class="p">(</span><span class="nv">$pos</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">.</span>
					<span class="s">&quot; &quot;</span>  <span class="n">x</span> <span class="p">(</span><span class="nv">$pos</span> <span class="nv">%</span> <span class="nv">8</span><span class="p">);</span>
				<span class="k">my</span> <span class="nv">$goodspaceindent</span> <span class="o">=</span> <span class="nv">$oldindent</span> <span class="o">.</span> <span class="s">&quot; &quot;</span>  <span class="n">x</span> <span class="nv">$pos</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="nv">$newindent</span> <span class="ow">ne</span> <span class="nv">$goodtabindent</span> <span class="o">&amp;&amp;</span>
				    <span class="nv">$newindent</span> <span class="ow">ne</span> <span class="nv">$goodspaceindent</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;PARENTHESIS_ALIGNMENT&quot;</span><span class="p">,</span>
					    <span class="s">&quot;Alignment should match open parenthesis\n&quot;</span> <span class="o">.</span> <span class="nv">$hereprev</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^\+.*\*[ \t]*\)[ \t]+/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
			    <span class="s">&quot;No space is necessary after a cast\n&quot;</span> <span class="o">.</span> <span class="nv">$hereprev</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>check for spaces at the beginning of a line.
Exceptions:
 1) within comments
 2) indented preprocessor commands
 3) hanging labels</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> /^\+ /</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/\+ *(?:$;|#|$Ident:)/</span><span class="p">)</span>  <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$herevet</span> <span class="o">=</span> <span class="s">&quot;$here\n&quot;</span> <span class="o">.</span> <span class="n">cat_vet</span><span class="p">(</span><span class="nv">$rawline</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;LEADING_SPACE&quot;</span><span class="p">,</span>
			     <span class="s">&quot;please, no spaces at the start of a line\n&quot;</span> <span class="o">.</span> <span class="nv">$herevet</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><p>check we are in a valid C source file if not then ignore this hunk</p></td><td class="code"><div class="highlight"><pre>		<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$realfile</span> <span class="o">!~</span> <span class="sr">/\.(h|c)$/</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><p>check for RCS/CVS revision markers</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> /^\+.*\$(Revision|Log|Id)(?:\$|)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;CVS_KEYWORD&quot;</span><span class="p">,</span>
			     <span class="s">&quot;CVS style keyword markers, these will _not_ be updated\n&quot;</span><span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>Blackfin: don't use <em>_builtin</em>bfin_[cs]sync</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /__builtin_bfin_csync/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$herevet</span> <span class="o">=</span> <span class="s">&quot;$here\n&quot;</span> <span class="o">.</span> <span class="n">cat_vet</span><span class="p">(</span><span class="nv">$line</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;CSYNC&quot;</span><span class="p">,</span>
			      <span class="s">&quot;use the CSYNC() macro in asm/blackfin.h\n&quot;</span> <span class="o">.</span> <span class="nv">$herevet</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /__builtin_bfin_ssync/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$herevet</span> <span class="o">=</span> <span class="s">&quot;$here\n&quot;</span> <span class="o">.</span> <span class="n">cat_vet</span><span class="p">(</span><span class="nv">$line</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SSYNC&quot;</span><span class="p">,</span>
			      <span class="s">&quot;use the SSYNC() macro in asm/blackfin.h\n&quot;</span> <span class="o">.</span> <span class="nv">$herevet</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-94"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-94">&#182;</a></div><p>Check for potential 'bare' types</p></td><td class="code"><div class="highlight"><pre>		<span class="k">my</span> <span class="p">(</span><span class="nv">$stat</span><span class="p">,</span> <span class="nv">$cond</span><span class="p">,</span> <span class="nv">$line_nr_next</span><span class="p">,</span> <span class="nv">$remain_next</span><span class="p">,</span> <span class="nv">$off_next</span><span class="p">,</span>
		    <span class="nv">$realline_next</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-95"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-95">&#182;</a></div><p>print "LINE&lt;$line>\n";</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$linenr</span> <span class="o">&gt;=</span> <span class="nv">$suppress_statement</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$realcnt</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /.\s*\S/</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="nv">$stat</span><span class="p">,</span> <span class="nv">$cond</span><span class="p">,</span> <span class="nv">$line_nr_next</span><span class="p">,</span> <span class="nv">$remain_next</span><span class="p">,</span> <span class="nv">$off_next</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">ctx_statement_block</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$realcnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="nv">$stat</span> <span class="o">=~</span> <span class="sr">s/\n./\n /g</span><span class="p">;</span>
			<span class="nv">$cond</span> <span class="o">=~</span> <span class="sr">s/\n./\n /g</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-96"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-96">&#182;</a></div><p>print "linenr&lt;$linenr> &lt;$stat>\n";
If this statement has no statement boundaries within
it there is no point in retrying a statement scan
until we hit end of it.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">my</span> <span class="nv">$frag</span> <span class="o">=</span> <span class="nv">$stat</span><span class="p">;</span> <span class="nv">$frag</span> <span class="o">=~</span> <span class="sr">s/;+\s*$//</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$frag</span> <span class="o">!~</span> <span class="sr">/(?:{|;)/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-97"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-97">&#182;</a></div><p>print "skip&lt;$line<em>nr</em>next>\n";</p></td><td class="code"><div class="highlight"><pre>				<span class="nv">$suppress_statement</span> <span class="o">=</span> <span class="nv">$line_nr_next</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-98"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-98">&#182;</a></div><p>Find the real next line.</p></td><td class="code"><div class="highlight"><pre>			<span class="nv">$realline_next</span> <span class="o">=</span> <span class="nv">$line_nr_next</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$realline_next</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$realline_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">||</span>
			     <span class="nb">substr</span><span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="nv">$realline_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="nv">$off_next</span><span class="p">)</span> <span class="o">=~</span><span class="sr"> /^\s*$/</span><span class="p">))</span> <span class="p">{</span>
				<span class="nv">$realline_next</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">my</span> <span class="nv">$s</span> <span class="o">=</span> <span class="nv">$stat</span><span class="p">;</span>
			<span class="nv">$s</span> <span class="o">=~</span> <span class="sr">s/{.*$//s</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-99"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-99">&#182;</a></div><p>Ignore goto labels.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">=~</span><span class="sr"> /$Ident:\*$/s</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-100"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-100">&#182;</a></div><p>Ignore functions being called</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">=~</span><span class="sr"> /^.\s*$Ident\s*\(/s</span><span class="p">)</span> <span class="p">{</span>

			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">=~</span><span class="sr"> /^.\s*else\b/s</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-101"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-101">&#182;</a></div><p>declarations always start with types</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$prev_values</span> <span class="ow">eq</span> <span class="s">&#39;E&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$s</span> <span class="o">=~</span><span class="sr"> /^.\s*(?:$Storage\s+)?(?:$Inline\s+)?(?:const\s+)?((?:\s*$Ident)+?)\b(?:\s+$Sparse)?\s*\**\s*(?:$Ident|\(\*[^\)]*\))(?:\s*$Modifier)?\s*(?:;|=|,|\()/s</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">my</span> <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
				<span class="nv">$type</span> <span class="o">=~</span> <span class="sr">s/\s+/ /g</span><span class="p">;</span>
				<span class="n">possible</span><span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="s">&quot;A:&quot;</span> <span class="o">.</span> <span class="nv">$s</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-102"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-102">&#182;</a></div><p>definitions in global scope can only start with types</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">=~</span><span class="sr"> /^.(?:$Storage\s+)?(?:$Inline\s+)?(?:const\s+)?($Ident)\b\s*(?!:)/s</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">possible</span><span class="p">(</span><span class="nv">$1</span><span class="p">,</span> <span class="s">&quot;B:&quot;</span> <span class="o">.</span> <span class="nv">$s</span><span class="p">);</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-103"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-103">&#182;</a></div><p>any (foo ... *) is a pointer cast, and foo is a type</p></td><td class="code"><div class="highlight"><pre>			<span class="k">while</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">=~</span><span class="sr"> /\(($Ident)(?:\s+$Sparse)*[\s\*]+\s*\)/sg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">possible</span><span class="p">(</span><span class="nv">$1</span><span class="p">,</span> <span class="s">&quot;C:&quot;</span> <span class="o">.</span> <span class="nv">$s</span><span class="p">);</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-104"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-104">&#182;</a></div><p>Check for any sort of function declaration.
int foo(something bar, other baz);
void (*store<em>gdt)(x86</em>descr_ptr *);</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$prev_values</span> <span class="ow">eq</span> <span class="s">&#39;E&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$s</span> <span class="o">=~</span><span class="sr"> /^(.(?:typedef\s*)?(?:(?:$Storage|$Inline)\s*)*\s*$Type\s*(?:\b$Ident|\(\*\s*$Ident\))\s*)\(/s</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">my</span> <span class="p">(</span><span class="nv">$name_len</span><span class="p">)</span> <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$1</span><span class="p">);</span>

				<span class="k">my</span> <span class="nv">$ctx</span> <span class="o">=</span> <span class="nv">$s</span><span class="p">;</span>
				<span class="nb">substr</span><span class="p">(</span><span class="nv">$ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
				<span class="nv">$ctx</span> <span class="o">=~</span> <span class="sr">s/\)[^\)]*$//</span><span class="p">;</span>

				<span class="k">for</span> <span class="k">my</span> <span class="nv">$arg</span> <span class="p">(</span><span class="nb">split</span><span class="p">(</span><span class="sr">/\s*,\s*/</span><span class="p">,</span> <span class="nv">$ctx</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$arg</span> <span class="o">=~</span><span class="sr"> /^(?:const\s+)?($Ident)(?:\s+$Sparse)*\s*\**\s*(:?\b$Ident)?$/s</span> <span class="o">||</span> <span class="nv">$arg</span> <span class="o">=~</span><span class="sr"> /^($Ident)$/s</span><span class="p">)</span> <span class="p">{</span>

						<span class="n">possible</span><span class="p">(</span><span class="nv">$1</span><span class="p">,</span> <span class="s">&quot;D:&quot;</span> <span class="o">.</span> <span class="nv">$s</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span></pre></div></td></tr>


<tr id="section-105"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-105">&#182;</a></div><p>Checks which may be anchored in the context.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-106"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-106">&#182;</a></div><p>Check for switch () and associated case and default
statements should be at the same indent.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span><span class="o">=~</span><span class="sr">/\bswitch\s*\(.*\)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$sep</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">@ctx</span> <span class="o">=</span> <span class="n">ctx_block_outer</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$realcnt</span><span class="p">);</span>
			<span class="nb">shift</span><span class="p">(</span><span class="nv">@ctx</span><span class="p">);</span>
			<span class="k">for</span> <span class="k">my</span> <span class="nv">$ctx</span> <span class="p">(</span><span class="nv">@ctx</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">my</span> <span class="p">(</span><span class="nv">$clen</span><span class="p">,</span> <span class="nv">$cindent</span><span class="p">)</span> <span class="o">=</span> <span class="n">line_stats</span><span class="p">(</span><span class="nv">$ctx</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">=~</span><span class="sr"> /^\+\s*(case\s+|default:)/</span> <span class="o">&amp;&amp;</span>
							<span class="nv">$indent</span> <span class="o">!=</span> <span class="nv">$cindent</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$err</span> <span class="o">.=</span> <span class="s">&quot;$sep$ctx\n&quot;</span><span class="p">;</span>
					<span class="nv">$sep</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="nv">$sep</span> <span class="o">=</span> <span class="s">&quot;[...]\n&quot;</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$err</span> <span class="ow">ne</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SWITCH_CASE_INDENT_LEVEL&quot;</span><span class="p">,</span>
				      <span class="s">&quot;switch and case should be at the same indent\n$hereline$err&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-107"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-107">&#182;</a></div><p>if/while/etc brace do not go on next line, unless defining a do while loop,
or if that brace on the next line is for something else</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /(.*)\b((?:if|while|for|switch)\s*\(|do\b|else\b)/</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/^.\s*\#/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$pre_ctx</span> <span class="o">=</span> <span class="s">&quot;$1$2&quot;</span><span class="p">;</span>

			<span class="k">my</span> <span class="p">(</span><span class="nv">$level</span><span class="p">,</span> <span class="nv">@ctx</span><span class="p">)</span> <span class="o">=</span> <span class="n">ctx_statement_level</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$realcnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^\+\t{6,}/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;DEEP_INDENTATION&quot;</span><span class="p">,</span>
				     <span class="s">&quot;Too many leading tabs - consider code refactoring\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">my</span> <span class="nv">$ctx_cnt</span> <span class="o">=</span> <span class="nv">$realcnt</span> <span class="o">-</span> <span class="nv">$#ctx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$ctx</span> <span class="o">=</span> <span class="nb">join</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">,</span> <span class="nv">@ctx</span><span class="p">);</span>

			<span class="k">my</span> <span class="nv">$ctx_ln</span> <span class="o">=</span> <span class="nv">$linenr</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$ctx_skip</span> <span class="o">=</span> <span class="nv">$realcnt</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="nv">$ctx_skip</span> <span class="o">&gt;</span> <span class="nv">$ctx_cnt</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$ctx_skip</span> <span class="o">==</span> <span class="nv">$ctx_cnt</span> <span class="o">&amp;&amp;</span>
					<span class="nb">defined</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$ctx_ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
					<span class="nv">$lines</span><span class="p">[</span><span class="nv">$ctx_ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^-/</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-108"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-108">&#182;</a></div><h1>print "SKIP&lt;$ctx<em>skip> CNT&lt;$ctx</em>cnt>\n";</h1></td><td class="code"><div class="highlight"><pre>				<span class="nv">$ctx_skip</span><span class="o">--</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$ctx_ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$ctx_ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!~</span> <span class="sr">/^-/</span><span class="p">);</span>
				<span class="nv">$ctx_ln</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-109"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-109">&#182;</a></div><p>print "realcnt&lt;$realcnt> ctx<em>cnt&lt;$ctx</em>cnt>\n";
print "pre&lt;$pre<em>ctx>\nline&lt;$line>\nctx&lt;$ctx>\nnext&lt;$lines[$ctx</em>ln - 1]>\n";</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">!~</span> <span class="sr">/{\s*/</span> <span class="o">&amp;&amp;</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="nv">$ctx_ln</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$ctx_ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^\+\s*{/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;OPEN_BRACE&quot;</span><span class="p">,</span>
				      <span class="s">&quot;that open brace { should be on the previous line\n&quot;</span> <span class="o">.</span>
					<span class="s">&quot;$here\n$ctx\n$rawlines[$ctx_ln - 1]\n&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$level</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$pre_ctx</span> <span class="o">!~</span> <span class="sr">/}\s*while\s*\($/</span> <span class="o">&amp;&amp;</span>
			    <span class="nv">$ctx</span> <span class="o">=~</span><span class="sr"> /\)\s*\;\s*$/</span> <span class="o">&amp;&amp;</span>
			    <span class="nb">defined</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$ctx_ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
			<span class="p">{</span>
				<span class="k">my</span> <span class="p">(</span><span class="nv">$nlength</span><span class="p">,</span> <span class="nv">$nindent</span><span class="p">)</span> <span class="o">=</span> <span class="n">line_stats</span><span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="nv">$ctx_ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$nindent</span> <span class="o">&gt;</span> <span class="nv">$indent</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;TRAILING_SEMICOLON&quot;</span><span class="p">,</span>
					     <span class="s">&quot;trailing semicolon indicates no statements, indent implies otherwise\n&quot;</span> <span class="o">.</span>
						<span class="s">&quot;$here\n$ctx\n$rawlines[$ctx_ln - 1]\n&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-110"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-110">&#182;</a></div><p>Check relative indent for conditionals and blocks.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\b(?:(?:if|while|for)\s*\(|do\b)/</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/^.\s*#/</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/\}\s*while\s*/</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="nv">$stat</span><span class="p">,</span> <span class="nv">$cond</span><span class="p">,</span> <span class="nv">$line_nr_next</span><span class="p">,</span> <span class="nv">$remain_next</span><span class="p">,</span> <span class="nv">$off_next</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">ctx_statement_block</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$realcnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$stat</span><span class="p">);</span>
			<span class="k">my</span> <span class="p">(</span><span class="nv">$s</span><span class="p">,</span> <span class="nv">$c</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$stat</span><span class="p">,</span> <span class="nv">$cond</span><span class="p">);</span>

			<span class="nb">substr</span><span class="p">(</span><span class="nv">$s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$c</span><span class="p">),</span> <span class="s">&#39;&#39;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-111"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-111">&#182;</a></div><p>Make sure we remove the line prefixes as we have
none on the first line, and are going to readd them
where necessary.</p></td><td class="code"><div class="highlight"><pre>			<span class="nv">$s</span> <span class="o">=~</span> <span class="sr">s/\n./\n/gs</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-112"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-112">&#182;</a></div><p>Find out how long the conditional actually is.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">my</span> <span class="nv">@newlines</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$c</span> <span class="o">=~</span><span class="sr"> /\n/gs</span><span class="p">);</span>
			<span class="k">my</span> <span class="nv">$cond_lines</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nv">$#newlines</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-113"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-113">&#182;</a></div><p>We want to check the first line inside the block
starting at the end of the conditional, so remove:
 1) any blank line termination
 2) any opening brace { on end of the line
 3) any do (...) {</p></td><td class="code"><div class="highlight"><pre>			<span class="k">my</span> <span class="nv">$continuation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="nv">$s</span> <span class="o">=~</span> <span class="sr">s/^.*\bdo\b//</span><span class="p">;</span>
			<span class="nv">$s</span> <span class="o">=~</span> <span class="sr">s/^\s*{//</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">=~</span> <span class="sr">s/^\s*\\//</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$continuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">=~</span> <span class="sr">s/^\s*?\n//</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="nv">$cond_lines</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-114"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-114">&#182;</a></div><p>Also ignore a loop construct at the end of a
preprocessor statement.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">((</span><span class="nv">$prevline</span> <span class="o">=~</span><span class="sr"> /^.\s*#\s*define\s/</span> <span class="o">||</span>
			    <span class="nv">$prevline</span> <span class="o">=~</span><span class="sr"> /\\\s*$/</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$continuation</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">my</span> <span class="nv">$cond_ptr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="nv">$continuation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="nv">$cond_ptr</span> <span class="o">!=</span> <span class="nv">$cond_lines</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$cond_ptr</span> <span class="o">=</span> <span class="nv">$cond_lines</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-115"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-115">&#182;</a></div><p>If we see an #else/#elif then the code
is not linear.</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">=~</span><span class="sr"> /^\s*\#\s*(?:else|elif)/</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span></pre></div></td></tr>


<tr id="section-116"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-116">&#182;</a></div><p>Ignore:
 1) blank lines, they should be at 0,
 2) preprocessor lines, and
 3) labels.</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="nv">$continuation</span> <span class="o">||</span>
				    <span class="nv">$s</span> <span class="o">=~</span><span class="sr"> /^\s*?\n/</span> <span class="o">||</span>
				    <span class="nv">$s</span> <span class="o">=~</span><span class="sr"> /^\s*#\s*?/</span> <span class="o">||</span>
				    <span class="nv">$s</span> <span class="o">=~</span><span class="sr"> /^\s*$Ident\s*:/</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$continuation</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">=~</span><span class="sr"> /^.*?\\\n/</span><span class="p">)</span> <span class="p">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">=~</span> <span class="sr">s/^.*?\n//</span><span class="p">)</span> <span class="p">{</span>
						<span class="nv">$cond_lines</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">my</span> <span class="p">(</span><span class="nb">undef</span><span class="p">,</span> <span class="nv">$sindent</span><span class="p">)</span> <span class="o">=</span> <span class="n">line_stats</span><span class="p">(</span><span class="s">&quot;+&quot;</span> <span class="o">.</span> <span class="nv">$s</span><span class="p">);</span>
			<span class="k">my</span> <span class="nv">$stat_real</span> <span class="o">=</span> <span class="n">raw_line</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$cond_lines</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-117"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-117">&#182;</a></div><p>Check if either of these lines are modified, else
this is not this patch's fault.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$stat_real</span><span class="p">)</span> <span class="o">||</span>
			    <span class="nv">$stat</span> <span class="o">!~</span> <span class="sr">/^\+/</span> <span class="o">&amp;&amp;</span> <span class="nv">$stat_real</span> <span class="o">!~</span> <span class="sr">/^\+/</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$stat_real</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$cond_lines</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$stat_real</span> <span class="o">=</span> <span class="s">&quot;[...]\n$stat_real&quot;</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-118"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-118">&#182;</a></div><p>print "line&lt;$line> prevline&lt;$prevline> indent&lt;$indent> sindent&lt;$sindent> check&lt;$check> continuation&lt;$continuation> s&lt;$s> cond<em>lines&lt;$cond</em>lines> stat<em>real&lt;$stat</em>real> stat&lt;$stat>\n";</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$check</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nv">$sindent</span> <span class="nv">%</span> <span class="nv">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="p">(</span><span class="nv">$sindent</span> <span class="o">&lt;=</span> <span class="nv">$indent</span> <span class="o">&amp;&amp;</span> <span class="nv">$s</span> <span class="ow">ne</span> <span class="s">&#39;&#39;</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;SUSPECT_CODE_INDENT&quot;</span><span class="p">,</span>
				     <span class="s">&quot;suspect code indent for conditional statements ($indent, $sindent)\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span> <span class="o">.</span> <span class="s">&quot;$stat_real\n&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-119"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-119">&#182;</a></div><p>Track the 'values' across context and added lines.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">my</span> <span class="nv">$opline</span> <span class="o">=</span> <span class="nv">$line</span><span class="p">;</span> <span class="nv">$opline</span> <span class="o">=~</span> <span class="sr">s/^./ /</span><span class="p">;</span>
		<span class="k">my</span> <span class="p">(</span><span class="nv">$curr_values</span><span class="p">,</span> <span class="nv">$curr_vars</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">annotate_values</span><span class="p">(</span><span class="nv">$opline</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">,</span> <span class="nv">$prev_values</span><span class="p">);</span>
		<span class="nv">$curr_values</span> <span class="o">=</span> <span class="nv">$prev_values</span> <span class="o">.</span> <span class="nv">$curr_values</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_values</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$outline</span> <span class="o">=</span> <span class="nv">$opline</span><span class="p">;</span> <span class="nv">$outline</span> <span class="o">=~</span> <span class="sr">s/\t/ /g</span><span class="p">;</span>
			<span class="k">print</span> <span class="s">&quot;$linenr &gt; .$outline\n&quot;</span><span class="p">;</span>
			<span class="k">print</span> <span class="s">&quot;$linenr &gt; $curr_values\n&quot;</span><span class="p">;</span>
			<span class="k">print</span> <span class="s">&quot;$linenr &gt;  $curr_vars\n&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nv">$prev_values</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$curr_values</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-120"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-120">&#182;</a></div><p>ignore lines not being added</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span><span class="o">=~</span><span class="sr">/^[^\+]/</span><span class="p">)</span> <span class="p">{</span><span class="k">next</span><span class="p">;}</span></pre></div></td></tr>


<tr id="section-121"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-121">&#182;</a></div><p>TEST: allow direct testing of the type matcher.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*$Declare\s*$/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;TEST_TYPE&quot;</span><span class="p">,</span>
				      <span class="s">&quot;TEST: is type\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$dbg_type</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.+($Declare)/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;TEST_NOT_TYPE&quot;</span><span class="p">,</span>
				      <span class="s">&quot;TEST: is not type ($1 is)\n&quot;</span><span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">next</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-122"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-122">&#182;</a></div><p>TEST: allow direct testing of the attribute matcher.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$dbg_attr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*$Modifier\s*$/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;TEST_ATTR&quot;</span><span class="p">,</span>
				      <span class="s">&quot;TEST: is attr\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$dbg_attr</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.+($Modifier)/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;TEST_NOT_ATTR&quot;</span><span class="p">,</span>
				      <span class="s">&quot;TEST: is not attr ($1 is)\n&quot;</span><span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">next</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-123"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-123">&#182;</a></div><p>check for initialisation to aggregates open brace on the next line</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*{/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$prevline</span> <span class="o">=~</span><span class="sr"> /(?:^|[^=])=\s*$/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;OPEN_BRACE&quot;</span><span class="p">,</span>
			      <span class="s">&quot;that open brace { should be on the previous line\n&quot;</span> <span class="o">.</span> <span class="nv">$hereprev</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-124"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-124">&#182;</a></div><p>Checks which are anchored on the added line.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-125"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-125">&#182;</a></div><p>check for malformed paths in #include statements (uses RAW line)</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$rawline</span> <span class="o">=~</span> <span class="sr">m{^.\s*\#\s*include\s+[&lt;&quot;](.*)[&quot;&gt;]}</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$path</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$path</span> <span class="o">=~</span> <span class="sr">m{//}</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;MALFORMED_INCLUDE&quot;</span><span class="p">,</span>
				      <span class="s">&quot;malformed #include filename\n&quot;</span> <span class="o">.</span>
					<span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-126"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-126">&#182;</a></div><p>no C99 // comments</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span> <span class="sr">m{//}</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;C99_COMMENTS&quot;</span><span class="p">,</span>
			      <span class="s">&quot;do not use C99 // comments\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-127"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-127">&#182;</a></div><p>Remove C99 comments.</p></td><td class="code"><div class="highlight"><pre>		<span class="nv">$line</span> <span class="o">=~</span> <span class="sr">s@//.*@@</span><span class="p">;</span>
		<span class="nv">$opline</span> <span class="o">=~</span> <span class="sr">s@//.*@@</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-128"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-128">&#182;</a></div><p>EXPORT<em>SYMBOL should immediately follow the thing it is exporting, consider
the whole statement.
print "APW &lt;$lines[$realline</em>next - 1]>\n";</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$realline_next</span> <span class="o">&amp;&amp;</span>
		    <span class="nb">exists</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$realline_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="nb">defined</span> <span class="nv">$suppress_export</span><span class="p">{</span><span class="nv">$realline_next</span><span class="p">}</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="nv">$realline_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /EXPORT_SYMBOL.*\((.*)\)/</span> <span class="o">||</span>
		     <span class="nv">$lines</span><span class="p">[</span><span class="nv">$realline_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /EXPORT_UNUSED_SYMBOL.*\((.*)\)/</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-129"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-129">&#182;</a></div><p>Handle definitions which produce identifiers with
a prefix:
  XXX(foo);
  EXPORT<em>SYMBOL(something</em>foo);</p></td><td class="code"><div class="highlight"><pre>			<span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$stat</span> <span class="o">=~</span><span class="sr"> /^(?:.\s*}\s*\n)?.([A-Z_]+)\s*\(\s*($Ident)/</span> <span class="o">&amp;&amp;</span>
			    <span class="nv">$name</span> <span class="o">=~</span><span class="sr"> /^${Ident}_$2/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-130"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-130">&#182;</a></div><p>print "FOO C name&lt;$name>\n";</p></td><td class="code"><div class="highlight"><pre>				<span class="nv">$suppress_export</span><span class="p">{</span><span class="nv">$realline_next</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$stat</span> <span class="o">!~</span> <span class="o">/</span><span class="p">(?:</span>
				<span class="o">\</span><span class="n">n</span><span class="o">.</span><span class="p">}</span><span class="o">\</span><span class="n">s</span><span class="o">*</span><span class="vg">$|</span>
				<span class="o">^.</span><span class="n">DEFINE_</span><span class="nv">$Ident</span><span class="o">\</span><span class="p">(</span><span class="o">\</span><span class="n">Q</span><span class="nv">$name</span><span class="o">\</span><span class="n">E</span><span class="o">\</span><span class="p">)</span><span class="o">|</span>
				<span class="o">^.</span><span class="n">DECLARE_</span><span class="nv">$Ident</span><span class="o">\</span><span class="p">(</span><span class="o">\</span><span class="n">Q</span><span class="nv">$name</span><span class="o">\</span><span class="n">E</span><span class="o">\</span><span class="p">)</span><span class="o">|</span>
				<span class="o">^.</span><span class="n">LIST_HEAD</span><span class="o">\</span><span class="p">(</span><span class="o">\</span><span class="n">Q</span><span class="nv">$name</span><span class="o">\</span><span class="n">E</span><span class="o">\</span><span class="p">)</span><span class="o">|</span>
				<span class="o">^.</span><span class="p">(?:</span><span class="nv">$Storage</span><span class="o">\</span><span class="n">s</span><span class="o">+</span><span class="p">)?</span><span class="nv">$Type</span><span class="o">\</span><span class="n">s</span><span class="o">*\</span><span class="p">(</span><span class="o">\</span><span class="n">s</span><span class="o">*\*\</span><span class="n">s</span><span class="o">*\</span><span class="n">Q</span><span class="nv">$name</span><span class="o">\</span><span class="n">E</span><span class="o">\</span><span class="n">s</span><span class="o">*\</span><span class="p">)</span><span class="o">\</span><span class="n">s</span><span class="o">*\</span><span class="p">(</span><span class="o">|</span>
				<span class="o">\</span><span class="n">b</span><span class="o">\</span><span class="n">Q</span><span class="nv">$name</span><span class="o">\</span><span class="n">E</span><span class="p">(?:</span><span class="o">\</span><span class="n">s</span><span class="o">+</span><span class="nv">$Attribute</span><span class="p">)</span><span class="o">*\</span><span class="n">s</span><span class="o">*</span><span class="p">(?:;</span><span class="o">|=|\</span><span class="p">[</span><span class="o">|\</span><span class="p">()</span>
			    <span class="p">)</span><span class="o">/</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-131"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-131">&#182;</a></div><p>print "FOO A&lt;$lines[$realline_next - 1]> stat&lt;$stat> name&lt;$name>\n";</p></td><td class="code"><div class="highlight"><pre>				<span class="nv">$suppress_export</span><span class="p">{</span><span class="nv">$realline_next</span><span class="p">}</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nv">$suppress_export</span><span class="p">{</span><span class="nv">$realline_next</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$suppress_export</span><span class="p">{</span><span class="nv">$linenr</span><span class="p">}</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$prevline</span> <span class="o">=~</span><span class="sr"> /^.\s*$/</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /EXPORT_SYMBOL.*\((.*)\)/</span> <span class="o">||</span>
		     <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /EXPORT_UNUSED_SYMBOL.*\((.*)\)/</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-132"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-132">&#182;</a></div><p>print "FOO B &lt;$lines[$linenr - 1]>\n";</p></td><td class="code"><div class="highlight"><pre>			<span class="nv">$suppress_export</span><span class="p">{</span><span class="nv">$linenr</span><span class="p">}</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$suppress_export</span><span class="p">{</span><span class="nv">$linenr</span><span class="p">}</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$suppress_export</span><span class="p">{</span><span class="nv">$linenr</span><span class="p">}</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;EXPORT_SYMBOL&quot;</span><span class="p">,</span>
			     <span class="s">&quot;EXPORT_SYMBOL(foo); should immediately follow its function/variable\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-133"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-133">&#182;</a></div><p>check for global initialisers.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.$Type\s*$Ident\s*(?:\s+$Modifier)*\s*=\s*(0|NULL|false)\s*;/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;GLOBAL_INITIALISERS&quot;</span><span class="p">,</span>
			      <span class="s">&quot;do not initialise globals to 0 or NULL\n&quot;</span> <span class="o">.</span>
				<span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-134"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-134">&#182;</a></div><p>check for static initialisers.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bstatic\s.*=\s*(0|NULL|false)\s*;/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;INITIALISED_STATIC&quot;</span><span class="p">,</span>
			      <span class="s">&quot;do not initialise statics to 0 or NULL\n&quot;</span> <span class="o">.</span>
				<span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-135"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-135">&#182;</a></div><p>check for static const char * arrays.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bstatic\s+const\s+char\s*\*\s*(\w+)\s*\[\s*\]\s*=\s*/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;STATIC_CONST_CHAR_ARRAY&quot;</span><span class="p">,</span>
			     <span class="s">&quot;static const char * array should probably be static const char * const\n&quot;</span> <span class="o">.</span>
				<span class="nv">$herecurr</span><span class="p">);</span>
               <span class="p">}</span></pre></div></td></tr>


<tr id="section-136"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-136">&#182;</a></div><p>check for static char foo[] = "bar" declarations.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bstatic\s+char\s+(\w+)\s*\[\s*\]\s*=\s*&quot;/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;STATIC_CONST_CHAR_ARRAY&quot;</span><span class="p">,</span>
			     <span class="s">&quot;static char array declaration should probably be static const char\n&quot;</span> <span class="o">.</span>
				<span class="nv">$herecurr</span><span class="p">);</span>
               <span class="p">}</span></pre></div></td></tr>


<tr id="section-137"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-137">&#182;</a></div><p>check for declarations of struct pci<em>device</em>id</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bstruct\s+pci_device_id\s+\w+\s*\[\s*\]\s*\=\s*\{/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;DEFINE_PCI_DEVICE_TABLE&quot;</span><span class="p">,</span>
			     <span class="s">&quot;Use DEFINE_PCI_DEVICE_TABLE for struct pci_device_id\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-138"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-138">&#182;</a></div><p>check for new typedefs, only function parameters and sparse annotations
make sense.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\btypedef\s/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/\btypedef\s+$Type\s*\(\s*\*?$Ident\s*\)\s*\(/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/\btypedef\s+$Type\s+$Ident\s*\(/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/\b$typeTypedefs\b/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/\b__bitwise(?:__|)\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;NEW_TYPEDEFS&quot;</span><span class="p">,</span>
			     <span class="s">&quot;do not add new typedefs\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-139"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-139">&#182;</a></div><ul>
<li>goes on variable not on type
(char*[ const])</li>
</ul></td><td class="code"><div class="highlight"><pre>		<span class="k">while</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span> <span class="sr">m{(\($NonptrType(\s*(?:$Modifier\b\s*|\*\s*)+)\))}g</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-140"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-140">&#182;</a></div><p>print "AA&lt;$1>\n";</p></td><td class="code"><div class="highlight"><pre>			<span class="k">my</span> <span class="p">(</span><span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$2</span><span class="p">,</span> <span class="nv">$2</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-141"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-141">&#182;</a></div><p>Should start with a space.</p></td><td class="code"><div class="highlight"><pre>			<span class="nv">$to</span> <span class="o">=~</span> <span class="sr">s/^(\S)/ $1/</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-142"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-142">&#182;</a></div><p>Should not end with a space.</p></td><td class="code"><div class="highlight"><pre>			<span class="nv">$to</span> <span class="o">=~</span> <span class="sr">s/\s+$//</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-143"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-143">&#182;</a></div><p>'*'s should not have spaces between.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">while</span> <span class="p">(</span><span class="nv">$to</span> <span class="o">=~</span> <span class="sr">s/\*\s+\*/\*\*/</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-144"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-144">&#182;</a></div><p>print "from&lt;$from> to&lt;$to>\n";</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$from</span> <span class="ow">ne</span> <span class="nv">$to</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;POINTER_LOCATION&quot;</span><span class="p">,</span>
				      <span class="s">&quot;\&quot;(foo$from)\&quot; should be \&quot;(foo$to)\&quot;\n&quot;</span> <span class="o">.</span>  <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span> <span class="sr">m{(\b$NonptrType(\s*(?:$Modifier\b\s*|\*\s*)+)($Ident))}g</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-145"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-145">&#182;</a></div><p>print "BB&lt;$1>\n";</p></td><td class="code"><div class="highlight"><pre>			<span class="k">my</span> <span class="p">(</span><span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span><span class="p">,</span> <span class="nv">$ident</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$2</span><span class="p">,</span> <span class="nv">$2</span><span class="p">,</span> <span class="nv">$3</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-146"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-146">&#182;</a></div><p>Should start with a space.</p></td><td class="code"><div class="highlight"><pre>			<span class="nv">$to</span> <span class="o">=~</span> <span class="sr">s/^(\S)/ $1/</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-147"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-147">&#182;</a></div><p>Should not end with a space.</p></td><td class="code"><div class="highlight"><pre>			<span class="nv">$to</span> <span class="o">=~</span> <span class="sr">s/\s+$//</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-148"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-148">&#182;</a></div><p>'*'s should not have spaces between.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">while</span> <span class="p">(</span><span class="nv">$to</span> <span class="o">=~</span> <span class="sr">s/\*\s+\*/\*\*/</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-149"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-149">&#182;</a></div><p>Modifiers should have spaces.</p></td><td class="code"><div class="highlight"><pre>			<span class="nv">$to</span> <span class="o">=~</span> <span class="sr">s/(\b$Modifier$)/$1 /</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-150"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-150">&#182;</a></div><p>print "from&lt;$from> to&lt;$to> ident&lt;$ident>\n";</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$from</span> <span class="ow">ne</span> <span class="nv">$to</span> <span class="o">&amp;&amp;</span> <span class="nv">$ident</span> <span class="o">!~</span> <span class="sr">/^$Modifier$/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;POINTER_LOCATION&quot;</span><span class="p">,</span>
				      <span class="s">&quot;\&quot;foo${from}bar\&quot; should be \&quot;foo${to}bar\&quot;\n&quot;</span> <span class="o">.</span>  <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-151"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-151">&#182;</a></div><h1>no BUG() or BUG_ON()</h1>

<pre><code>    if ($line =~ /\b(BUG|BUG_ON)\b/) {
        print "Try to use WARN_ON &amp; Recovery code rather than BUG() or BUG_ON()\n";
        print "$herecurr";
        $clean = 0;
    }
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bLINUX_VERSION_CODE\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;LINUX_VERSION_CODE&quot;</span><span class="p">,</span>
			     <span class="s">&quot;LINUX_VERSION_CODE should be avoided, code should be for the version to which it is merged\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-152"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-152">&#182;</a></div><p>check for uses of printk_ratelimit</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bprintk_ratelimit\s*\(/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;PRINTK_RATELIMITED&quot;</span><span class="p">,</span>
<span class="s">&quot;Prefer printk_ratelimited or pr_&lt;level&gt;_ratelimited to printk_ratelimit\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-153"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-153">&#182;</a></div><p>printk should use KERN_* levels.  Note that follow on printk's on the
same line do not need a level, so we use the current block context
to try and find and validate the current printk.  In summary the current
printk includes all preceding printk's which have no newline on the end.
we assume the first bad printk is the one to report.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bprintk\((?!KERN_)\s*&quot;/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$ln</span> <span class="o">=</span> <span class="nv">$linenr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$ln</span> <span class="o">&gt;=</span> <span class="nv">$first_line</span><span class="p">;</span> <span class="nv">$ln</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-154"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-154">&#182;</a></div><p>print "CHECK&lt;$lines[$ln - 1]\n";
we have a preceding printk if it ends
with "\n" ignore it, else it is to blame</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="nv">$ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=~</span> <span class="sr">m{\bprintk\(}</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$rawlines</span><span class="p">[</span><span class="nv">$ln</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!~</span> <span class="sr">m{\\n&quot;}</span><span class="p">)</span> <span class="p">{</span>
						<span class="nv">$ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">last</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$ok</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;PRINTK_WITHOUT_KERN_LEVEL&quot;</span><span class="p">,</span>
				     <span class="s">&quot;printk() should include KERN_ facility level\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bprintk\s*\(\s*KERN_([A-Z]+)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$orig</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$level</span> <span class="o">=</span> <span class="nb">lc</span><span class="p">(</span><span class="nv">$orig</span><span class="p">);</span>
			<span class="nv">$level</span> <span class="o">=</span> <span class="s">&quot;warn&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$level</span> <span class="ow">eq</span> <span class="s">&quot;warning&quot;</span><span class="p">);</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;PREFER_PR_LEVEL&quot;</span><span class="p">,</span>
			     <span class="s">&quot;Prefer pr_$level(... to printk(KERN_$1, ...\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bpr_warning\s*\(/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;PREFER_PR_LEVEL&quot;</span><span class="p">,</span>
			     <span class="s">&quot;Prefer pr_warn(... to pr_warning(...\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-155"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-155">&#182;</a></div><p>function brace can't be on same line, except for #defines of do while,
or if closed on same line</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="nv">$line</span><span class="o">=~</span><span class="sr">/$Type\s*$Ident\(.*\).*\s{/</span><span class="p">)</span> <span class="ow">and</span>
		    <span class="o">!</span><span class="p">(</span><span class="nv">$line</span><span class="o">=~</span><span class="sr">/\#\s*define.*do\s{/</span><span class="p">)</span> <span class="ow">and</span> <span class="o">!</span><span class="p">(</span><span class="nv">$line</span><span class="o">=~</span><span class="sr">/}/</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;OPEN_BRACE&quot;</span><span class="p">,</span>
			      <span class="s">&quot;open brace &#39;{&#39; following function declarations go on the next line\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-156"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-156">&#182;</a></div><p>open braces for enum, union and struct go on the same line.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*{/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$prevline</span> <span class="o">=~</span><span class="sr"> /^.\s*(?:typedef\s+)?(enum|union|struct)(?:\s+$Ident)?\s*$/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;OPEN_BRACE&quot;</span><span class="p">,</span>
			      <span class="s">&quot;open brace &#39;{&#39; following $1 go on the same line\n&quot;</span> <span class="o">.</span> <span class="nv">$hereprev</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-157"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-157">&#182;</a></div><p>missing space after union, struct or enum definition</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*(?:typedef\s+)?(enum|union|struct)(?:\s+$Ident)?(?:\s+$Ident)?[=\{]/</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">WARN</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
			 <span class="s">&quot;missing space after $1 definition\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-158"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-158">&#182;</a></div><p>check for spacing round square brackets; allowed:
 1. with a type on the left -- int [] a;
 2. at the beginning of a line for slice initialisers -- [0...10] = 5,
 3. inside a curly brace -- = { [0...10] = 5 }</p></td><td class="code"><div class="highlight"><pre>		<span class="k">while</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /(.*?\s)\[/g</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="p">(</span><span class="nv">$where</span><span class="p">,</span> <span class="nv">$prefix</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="vg">$-</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nv">$1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$prefix</span> <span class="o">!~</span> <span class="sr">/$Type\s+$/</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="nv">$where</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nv">$prefix</span> <span class="o">!~</span> <span class="sr">/^.\s+$/</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="nv">$prefix</span> <span class="o">!~</span> <span class="sr">/[{,]\s+$/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;BRACKET_SPACE&quot;</span><span class="p">,</span>
				      <span class="s">&quot;space prohibited before open square bracket &#39;[&#39;\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-159"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-159">&#182;</a></div><p>check for spaces between functions and their parentheses.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">while</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /($Ident)\s+\(/g</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$ctx_before</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="vg">$-</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">my</span> <span class="nv">$ctx</span> <span class="o">=</span> <span class="s">&quot;$ctx_before$name&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-160"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-160">&#182;</a></div><p>Ignore those directives where spaces <em>are</em> permitted.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="o">=~</span><span class="sr"> /^(?:</span>
<span class="sr">				if|for|while|switch|return|case|</span>
<span class="sr">				volatile|__volatile__|</span>
<span class="sr">				__attribute__|format|__extension__|</span>
<span class="sr">				asm|__asm__)$/x</span><span class="p">)</span>
			<span class="p">{</span></pre></div></td></tr>


<tr id="section-161"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-161">&#182;</a></div><p>cpp #define statements have non-optional spaces, ie
if there is a space between the name and the open
parenthesis it is simply not a parameter group.</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$ctx_before</span> <span class="o">=~</span><span class="sr"> /^.\s*\#\s*define\s*$/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-162"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-162">&#182;</a></div><p>cpp #elif statement condition may start with a (</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">=~</span><span class="sr"> /^.\s*\#\s*elif\s*$/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-163"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-163">&#182;</a></div><p>If this whole things ends with a type its most
likely a typedef for a function.</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">=~</span><span class="sr"> /$Type$/</span><span class="p">)</span> <span class="p">{</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
				     <span class="s">&quot;space prohibited between function name and open parenthesis &#39;(&#39;\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-164"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-164">&#182;</a></div><p>check for whitespace before a non-naked semicolon</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^\+.*\S\s+;/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
			    <span class="s">&quot;space prohibited before semicolon\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-165"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-165">&#182;</a></div><p>Check operator spacing.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$line</span><span class="o">=~</span><span class="sr">/\#\s*include/</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$ops</span> <span class="o">=</span> <span class="sx">qr{</span>
<span class="sx">				&lt;&lt;=|&gt;&gt;=|&lt;=|&gt;=|==|!=|</span>
<span class="sx">				\+=|-=|\*=|\/=|%=|\^=|\|=|&amp;=|</span>
<span class="sx">				=&gt;|-&gt;|&lt;&lt;|&gt;&gt;|&lt;|&gt;|=|!|~|</span>
<span class="sx">				&amp;&amp;|\|\||,|\^|\+\+|--|&amp;|\||\+|-|\*|\/|%|</span>
<span class="sx">				\?|:</span>
<span class="sx">			}</span><span class="n">x</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">@elements</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/($ops|;)/</span><span class="p">,</span> <span class="nv">$opline</span><span class="p">);</span>
			<span class="k">my</span> <span class="nv">$off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">my</span> <span class="nv">$blank</span> <span class="o">=</span> <span class="n">copy_spacing</span><span class="p">(</span><span class="nv">$opline</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$n</span> <span class="o">&lt;</span> <span class="nv">$#elements</span><span class="p">;</span> <span class="nv">$n</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$off</span> <span class="o">+=</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-166"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-166">&#182;</a></div><p>Pick up the preceding and succeeding characters.</p></td><td class="code"><div class="highlight"><pre>				<span class="k">my</span> <span class="nv">$ca</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$opline</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$off</span><span class="p">);</span>
				<span class="k">my</span> <span class="nv">$cc</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nv">$opline</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="nv">$off</span> <span class="o">+</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])))</span> <span class="p">{</span>
					<span class="nv">$cc</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$opline</span><span class="p">,</span> <span class="nv">$off</span> <span class="o">+</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]));</span>
				<span class="p">}</span>
				<span class="k">my</span> <span class="nv">$cb</span> <span class="o">=</span> <span class="s">&quot;$ca$;$cc&quot;</span><span class="p">;</span>

				<span class="k">my</span> <span class="nv">$a</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
				<span class="nv">$a</span> <span class="o">=</span> <span class="s">&#39;V&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span><span class="p">]</span> <span class="ow">ne</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
				<span class="nv">$a</span> <span class="o">=</span> <span class="s">&#39;W&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /\s$/</span><span class="p">);</span>
				<span class="nv">$a</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /$;$/</span><span class="p">);</span>
				<span class="nv">$a</span> <span class="o">=</span> <span class="s">&#39;B&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /(\[|\()$/</span><span class="p">);</span>
				<span class="nv">$a</span> <span class="o">=</span> <span class="s">&#39;O&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span><span class="p">]</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
				<span class="nv">$a</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$ca</span> <span class="o">=~</span><span class="sr"> /^\s*$/</span><span class="p">);</span>

				<span class="k">my</span> <span class="nv">$op</span> <span class="o">=</span> <span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

				<span class="k">my</span> <span class="nv">$c</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
					<span class="nv">$c</span> <span class="o">=</span> <span class="s">&#39;V&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="ow">ne</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
					<span class="nv">$c</span> <span class="o">=</span> <span class="s">&#39;W&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^\s/</span><span class="p">);</span>
					<span class="nv">$c</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^$;/</span><span class="p">);</span>
					<span class="nv">$c</span> <span class="o">=</span> <span class="s">&#39;B&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^(\)|\]|;)/</span><span class="p">);</span>
					<span class="nv">$c</span> <span class="o">=</span> <span class="s">&#39;O&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
					<span class="nv">$c</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^\s*\\$/</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="nv">$c</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">my</span> <span class="nv">$ctx</span> <span class="o">=</span> <span class="s">&quot;${a}x${c}&quot;</span><span class="p">;</span>

				<span class="k">my</span> <span class="nv">$at</span> <span class="o">=</span> <span class="s">&quot;(ctx:$ctx)&quot;</span><span class="p">;</span>

				<span class="k">my</span> <span class="nv">$ptr</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$blank</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$off</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;^&quot;</span><span class="p">;</span>
				<span class="k">my</span> <span class="nv">$hereptr</span> <span class="o">=</span> <span class="s">&quot;$hereline$ptr\n&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-167"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-167">&#182;</a></div><p>Pull out the value of this operator.</p></td><td class="code"><div class="highlight"><pre>				<span class="k">my</span> <span class="nv">$op_type</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$curr_values</span><span class="p">,</span> <span class="nv">$off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-168"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-168">&#182;</a></div><p>Get the full operator variant.</p></td><td class="code"><div class="highlight"><pre>				<span class="k">my</span> <span class="nv">$opv</span> <span class="o">=</span> <span class="nv">$op</span> <span class="o">.</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$curr_vars</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-169"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-169">&#182;</a></div><p>Ignore operators passed as parameters.</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="nv">$op_type</span> <span class="ow">ne</span> <span class="s">&#39;V&#39;</span> <span class="o">&amp;&amp;</span>
				    <span class="nv">$ca</span> <span class="o">=~</span><span class="sr"> /\s$/</span> <span class="o">&amp;&amp;</span> <span class="nv">$cc</span> <span class="o">=~</span><span class="sr"> /^\s*,/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-170"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-170">&#182;</a></div><pre><code>        # Ignore comments
        } elsif ($op =~ /^$;+$/) {
</code></pre></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-171"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-171">&#182;</a></div><p>; should have either the end of line or a space or \ after it</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;;&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">!~</span> <span class="sr">/.x[WEBC]/</span> <span class="o">&amp;&amp;</span>
					    <span class="nv">$cc</span> <span class="o">!~</span> <span class="sr">/^\\/</span> <span class="o">&amp;&amp;</span> <span class="nv">$cc</span> <span class="o">!~</span> <span class="sr">/^;/</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
						      <span class="s">&quot;space required after that &#39;$op&#39; $at\n&quot;</span> <span class="o">.</span> <span class="nv">$hereptr</span><span class="p">);</span>
					<span class="p">}</span></pre></div></td></tr>


<tr id="section-172"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-172">&#182;</a></div><p>// is a comment</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;//&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-173"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-173">&#182;</a></div><p>No spaces for:
  ->
  :   when part of a bitfield</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;-&gt;&#39;</span> <span class="o">||</span> <span class="nv">$opv</span> <span class="ow">eq</span> <span class="s">&#39;:B&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">=~</span><span class="sr"> /Wx.|.xW/</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
						      <span class="s">&quot;spaces prohibited around that &#39;$op&#39; $at\n&quot;</span> <span class="o">.</span> <span class="nv">$hereptr</span><span class="p">);</span>
					<span class="p">}</span></pre></div></td></tr>


<tr id="section-174"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-174">&#182;</a></div><p>, must have a space on the right.</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">!~</span> <span class="sr">/.x[WEC]/</span> <span class="o">&amp;&amp;</span> <span class="nv">$cc</span> <span class="o">!~</span> <span class="sr">/^}/</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
						      <span class="s">&quot;space required after that &#39;$op&#39; $at\n&quot;</span> <span class="o">.</span> <span class="nv">$hereptr</span><span class="p">);</span>
					<span class="p">}</span></pre></div></td></tr>


<tr id="section-175"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-175">&#182;</a></div><p>'*' as part of a type definition -- reported already.</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$opv</span> <span class="ow">eq</span> <span class="s">&#39;*_&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-176"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-176">&#182;</a></div><p>warn "'*' is part of type\n";</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-177"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-177">&#182;</a></div><p>unary operators should have a space before and
none after.  May be left adjacent to another
unary operator, or a cast</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;!&#39;</span> <span class="o">||</span> <span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;~&#39;</span> <span class="o">||</span>
					 <span class="nv">$opv</span> <span class="ow">eq</span> <span class="s">&#39;*U&#39;</span> <span class="o">||</span> <span class="nv">$opv</span> <span class="ow">eq</span> <span class="s">&#39;-U&#39;</span> <span class="o">||</span>
					 <span class="nv">$opv</span> <span class="ow">eq</span> <span class="s">&#39;&amp;U&#39;</span> <span class="o">||</span> <span class="nv">$opv</span> <span class="ow">eq</span> <span class="s">&#39;&amp;&amp;U&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">!~</span> <span class="sr">/[WEBC]x./</span> <span class="o">&amp;&amp;</span> <span class="nv">$ca</span> <span class="o">!~</span> <span class="sr">/(?:\)|!|~|\*|-|\&amp;|\||\+\+|\-\-|\{)$/</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
						      <span class="s">&quot;space required before that &#39;$op&#39; $at\n&quot;</span> <span class="o">.</span> <span class="nv">$hereptr</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;*&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$cc</span> <span class="o">=~</span><span class="sr">/\s*$Modifier\b/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-178"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-178">&#182;</a></div><p>A unary '*' may be const</p></td><td class="code"><div class="highlight"><pre>					<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">=~</span><span class="sr"> /.xW/</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
						      <span class="s">&quot;space prohibited after that &#39;$op&#39; $at\n&quot;</span> <span class="o">.</span> <span class="nv">$hereptr</span><span class="p">);</span>
					<span class="p">}</span></pre></div></td></tr>


<tr id="section-179"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-179">&#182;</a></div><p>unary ++ and unary -- are allowed no space on one side.</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;++&#39;</span> <span class="ow">or</span> <span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;--&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">!~</span> <span class="sr">/[WEOBC]x[^W]/</span> <span class="o">&amp;&amp;</span> <span class="nv">$ctx</span> <span class="o">!~</span> <span class="sr">/[^W]x[WOBEC]/</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
						      <span class="s">&quot;space required one side of that &#39;$op&#39; $at\n&quot;</span> <span class="o">.</span> <span class="nv">$hereptr</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">=~</span><span class="sr"> /Wx[BE]/</span> <span class="o">||</span>
					    <span class="p">(</span><span class="nv">$ctx</span> <span class="o">=~</span><span class="sr"> /Wx./</span> <span class="o">&amp;&amp;</span> <span class="nv">$cc</span> <span class="o">=~</span><span class="sr"> /^;/</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
						      <span class="s">&quot;space prohibited before that &#39;$op&#39; $at\n&quot;</span> <span class="o">.</span> <span class="nv">$hereptr</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">=~</span><span class="sr"> /ExW/</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
						      <span class="s">&quot;space prohibited after that &#39;$op&#39; $at\n&quot;</span> <span class="o">.</span> <span class="nv">$hereptr</span><span class="p">);</span>
					<span class="p">}</span></pre></div></td></tr>


<tr id="section-180"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-180">&#182;</a></div><p>&lt;&lt; and >> may either have or not have spaces both sides</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;&lt;&lt;&#39;</span> <span class="ow">or</span> <span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;&gt;&gt;&#39;</span> <span class="ow">or</span>
					 <span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;&amp;&#39;</span> <span class="ow">or</span> <span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;^&#39;</span> <span class="ow">or</span> <span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;|&#39;</span> <span class="ow">or</span>
					 <span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;+&#39;</span> <span class="ow">or</span> <span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;-&#39;</span> <span class="ow">or</span>
					 <span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;*&#39;</span> <span class="ow">or</span> <span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;/&#39;</span> <span class="ow">or</span>
					 <span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;%&#39;</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">=~</span><span class="sr"> /Wx[^WCE]|[^WCE]xW/</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
						      <span class="s">&quot;need consistent spacing around &#39;$op&#39; $at\n&quot;</span> <span class="o">.</span>
							<span class="nv">$hereptr</span><span class="p">);</span>
					<span class="p">}</span></pre></div></td></tr>


<tr id="section-181"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-181">&#182;</a></div><p>A colon needs no spaces before when it is
terminating a case value or a label.</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$opv</span> <span class="ow">eq</span> <span class="s">&#39;:C&#39;</span> <span class="o">||</span> <span class="nv">$opv</span> <span class="ow">eq</span> <span class="s">&#39;:L&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">=~</span><span class="sr"> /Wx./</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
						      <span class="s">&quot;space prohibited before that &#39;$op&#39; $at\n&quot;</span> <span class="o">.</span> <span class="nv">$hereptr</span><span class="p">);</span>
					<span class="p">}</span></pre></div></td></tr>


<tr id="section-182"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-182">&#182;</a></div><p>All the others need spaces both sides.</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$ctx</span> <span class="o">!~</span> <span class="sr">/[EWC]x[CWE]/</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">my</span> <span class="nv">$ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-183"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-183">&#182;</a></div><p>Ignore email addresses <foo@bar></p></td><td class="code"><div class="highlight"><pre>					<span class="k">if</span> <span class="p">((</span><span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;&lt;&#39;</span> <span class="o">&amp;&amp;</span>
					     <span class="nv">$cc</span> <span class="o">=~</span><span class="sr"> /^\S+\@\S+&gt;/</span><span class="p">)</span> <span class="o">||</span>
					    <span class="p">(</span><span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;&gt;&#39;</span> <span class="o">&amp;&amp;</span>
					     <span class="nv">$ca</span> <span class="o">=~</span><span class="sr"> /&lt;\S+\@\S+$/</span><span class="p">))</span>
					<span class="p">{</span>
					    	<span class="nv">$ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span></pre></div></td></tr>


<tr id="section-184"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-184">&#182;</a></div><p>Ignore ?:</p></td><td class="code"><div class="highlight"><pre>					<span class="k">if</span> <span class="p">((</span><span class="nv">$opv</span> <span class="ow">eq</span> <span class="s">&#39;:O&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$ca</span> <span class="o">=~</span><span class="sr"> /\?$/</span><span class="p">)</span> <span class="o">||</span>
					    <span class="p">(</span><span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;?&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$cc</span> <span class="o">=~</span><span class="sr"> /^:/</span><span class="p">))</span> <span class="p">{</span>
					    	<span class="nv">$ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="nv">$ok</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
						      <span class="s">&quot;spaces required around that &#39;$op&#39; $at\n&quot;</span> <span class="o">.</span> <span class="nv">$hereptr</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="nv">$off</span> <span class="o">+=</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-185"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-185">&#182;</a></div><p>check for multiple assignments</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*$Lval\s*=\s*$Lval\s*=(?!=)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;MULTIPLE_ASSIGNMENTS&quot;</span><span class="p">,</span>
			    <span class="s">&quot;multiple assignments should be avoided\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-186"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-186">&#182;</a></div><h1># check for multiple declarations, allowing for a function declaration</h1>

<h1># continuation.</h1>

<h1>if ($line =~ /^.\s<em>$Type\s+$Ident(?:\s</em>=[^,{]<em>)?\s</em>,\s<em>$Ident.</em>/ &amp;&amp;</h1>

<h1>$line !~ /^.\s<em>$Type\s+$Ident(?:\s</em>=[^,{]<em>)?\s</em>,\s<em>$Type\s</em>$Ident.*/) {</h1>

<p>#</p>

<h1># Remove any bracketed sections to ensure we do not</h1>

<h1># falsly report the parameters of functions.</h1>

<h1>my $ln = $line;</h1>

<h1>while ($ln =~ s/([^()]*)//g) {</h1>

<h1>}</h1>

<h1>if ($ln =~ /,/) {</h1>

<h1>WARN("MULTIPLE_DECLARATION",</h1>

<h1>"declaring multiple variables together should be avoided\n" . $herecurr);</h1>

<h1>}</h1>

<h1>}</h1></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-187"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-187">&#182;</a></div><p>need space before brace following if, while, etc</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\(.*\){/</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/\($Type\){/</span><span class="p">)</span> <span class="o">||</span>
		    <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /do{/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
			      <span class="s">&quot;space required before the open brace &#39;{&#39;\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-188"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-188">&#182;</a></div><p>closing brace should have a space following it when it has anything
on the line</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /}(?!(?:,|;|\)))\S/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
			      <span class="s">&quot;space required after that close brace &#39;}&#39;\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-189"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-189">&#182;</a></div><p>check spacing on square brackets</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\[\s/</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/\[\s*$/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
			      <span class="s">&quot;space prohibited after that open square bracket &#39;[&#39;\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\s\]/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
			      <span class="s">&quot;space prohibited before that close square bracket &#39;]&#39;\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-190"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-190">&#182;</a></div><p>check spacing on parentheses</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\(\s/</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/\(\s*(?:\\)?$/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/for\s*\(\s+;/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
			      <span class="s">&quot;space prohibited after that open parenthesis &#39;(&#39;\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /(\s+)\)/</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/^.\s*\)/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/for\s*\(.*;\s+\)/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/:\s+\)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
			      <span class="s">&quot;space prohibited before that close parenthesis &#39;)&#39;\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-191"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-191">&#182;</a></div><p>goto labels aren't indented, allow a single space however</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span><span class="o">=~</span><span class="sr">/^.\s+[A-Za-z\d_]+:(?![0-9]+)/</span> <span class="ow">and</span>
		   <span class="o">!</span><span class="p">(</span><span class="nv">$line</span><span class="o">=~</span><span class="sr">/^. [A-Za-z\d_]+:/</span><span class="p">)</span> <span class="ow">and</span> <span class="o">!</span><span class="p">(</span><span class="nv">$line</span><span class="o">=~</span><span class="sr">/^.\s+default:/</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;INDENTED_LABEL&quot;</span><span class="p">,</span>
			     <span class="s">&quot;labels should not be indented\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-192"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-192">&#182;</a></div><p>Return is not a function.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$stat</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$stat</span> <span class="o">=~</span><span class="sr"> /^.\s*return(\s*)(\(.*);/s</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$spacing</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-193"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-193">&#182;</a></div><p>Flatten any parentheses</p></td><td class="code"><div class="highlight"><pre>			<span class="nv">$value</span> <span class="o">=~</span> <span class="sr">s/\(/ \(/g</span><span class="p">;</span>
			<span class="nv">$value</span> <span class="o">=~</span> <span class="sr">s/\)/\) /g</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="nv">$value</span> <span class="o">=~</span> <span class="sr">s/\[[^\[\]]*\]/1/</span> <span class="o">||</span>
			       <span class="nv">$value</span> <span class="o">!~</span> <span class="o">/</span><span class="p">(?:</span><span class="nv">$Ident</span><span class="o">|-</span><span class="p">?</span><span class="nv">$Constant</span><span class="p">)</span><span class="o">\</span><span class="n">s</span><span class="o">*</span>
					     <span class="nv">$Compare</span><span class="o">\</span><span class="n">s</span><span class="o">*</span>
					     <span class="p">(?:</span><span class="nv">$Ident</span><span class="o">|-</span><span class="p">?</span><span class="nv">$Constant</span><span class="p">)</span><span class="o">/</span><span class="n">x</span> <span class="o">&amp;&amp;</span>
			       <span class="nv">$value</span> <span class="o">=~</span> <span class="sr">s/\([^\(\)]*\)/1/</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-194"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-194">&#182;</a></div><p>print "value&lt;$value>\n";</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$value</span> <span class="o">=~</span><span class="sr"> /^\s*(?:$Ident|-?$Constant)\s*$/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;RETURN_PARENTHESES&quot;</span><span class="p">,</span>
				      <span class="s">&quot;return is not a function, parentheses are not required\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$spacing</span> <span class="o">!~</span> <span class="sr">/\s+/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
				      <span class="s">&quot;space required before the open parenthesis &#39;(&#39;\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-195"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-195">&#182;</a></div><p>Return of what appears to be an errno should normally be -'ve</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*return\s*(E[A-Z]*)\s*;/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="ow">ne</span> <span class="s">&#39;EOF&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="ow">ne</span> <span class="s">&#39;ERROR&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;USE_NEGATIVE_ERRNO&quot;</span><span class="p">,</span>
				     <span class="s">&quot;return of an errno should typically be -ve (return -$1)\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-196"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-196">&#182;</a></div><p>Need a space before open parenthesis after if, while etc</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span><span class="o">=~</span><span class="sr">/\b(if|while|for|switch)\(/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span> <span class="s">&quot;space required before the open parenthesis &#39;(&#39;\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-197"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-197">&#182;</a></div><p>Check for illegal assignment in if conditional -- and check for trailing
statements after the conditional.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /do\s*(?!{)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="nv">$stat</span><span class="p">,</span> <span class="nv">$cond</span><span class="p">,</span> <span class="nv">$line_nr_next</span><span class="p">,</span> <span class="nv">$remain_next</span><span class="p">,</span> <span class="nv">$off_next</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">ctx_statement_block</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$realcnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$stat</span><span class="p">);</span>
			<span class="k">my</span> <span class="p">(</span><span class="nv">$stat_next</span><span class="p">)</span> <span class="o">=</span> <span class="n">ctx_statement_block</span><span class="p">(</span><span class="nv">$line_nr_next</span><span class="p">,</span>
						<span class="nv">$remain_next</span><span class="p">,</span> <span class="nv">$off_next</span><span class="p">);</span>
			<span class="nv">$stat_next</span> <span class="o">=~</span> <span class="sr">s/\n./\n /g</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-198"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-198">&#182;</a></div><h1>print "stat&lt;$stat> stat<em>next&lt;$stat</em>next>\n";</h1></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$stat_next</span> <span class="o">=~</span><span class="sr"> /^\s*while\b/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-199"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-199">&#182;</a></div><p>If the statement carries leading newlines,
then count those as offsets.</p></td><td class="code"><div class="highlight"><pre>				<span class="k">my</span> <span class="p">(</span><span class="nv">$whitespace</span><span class="p">)</span> <span class="o">=</span>
					<span class="p">(</span><span class="nv">$stat_next</span> <span class="o">=~</span><span class="sr"> /^((?:\s*\n[+-])*\s*)/s</span><span class="p">);</span>
				<span class="k">my</span> <span class="nv">$offset</span> <span class="o">=</span>
					<span class="n">statement_rawlines</span><span class="p">(</span><span class="nv">$whitespace</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

				<span class="nv">$suppress_whiletrailers</span><span class="p">{</span><span class="nv">$line_nr_next</span> <span class="o">+</span>
								<span class="nv">$offset</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$suppress_whiletrailers</span><span class="p">{</span><span class="nv">$linenr</span><span class="p">}</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\b(?:if|while|for)\s*\(/</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/^.\s*#/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="p">(</span><span class="nv">$s</span><span class="p">,</span> <span class="nv">$c</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$stat</span><span class="p">,</span> <span class="nv">$cond</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$c</span> <span class="o">=~</span><span class="sr"> /\bif\s*\(.*[^&lt;&gt;!=]=[^=].*/s</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;ASSIGN_IN_IF&quot;</span><span class="p">,</span>
				      <span class="s">&quot;do not use assignment in if condition\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-200"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-200">&#182;</a></div><p>Find out what is on the end of the line after the
conditional.</p></td><td class="code"><div class="highlight"><pre>			<span class="nb">substr</span><span class="p">(</span><span class="nv">$s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$c</span><span class="p">),</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
			<span class="nv">$s</span> <span class="o">=~</span> <span class="sr">s/\n.*//g</span><span class="p">;</span>
			<span class="nv">$s</span> <span class="o">=~</span> <span class="sr">s/$;//g</span><span class="p">;</span> 	<span class="c1"># Remove any comments</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nv">$c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$s</span> <span class="o">!~</span> <span class="sr">/^\s*{?\s*\\*\s*$/</span> <span class="o">&amp;&amp;</span>
			    <span class="nv">$c</span> <span class="o">!~</span> <span class="sr">/}\s*while\s*/</span><span class="p">)</span>
			<span class="p">{</span></pre></div></td></tr>


<tr id="section-201"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-201">&#182;</a></div><p>Find out how long the conditional actually is.</p></td><td class="code"><div class="highlight"><pre>				<span class="k">my</span> <span class="nv">@newlines</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$c</span> <span class="o">=~</span><span class="sr"> /\n/gs</span><span class="p">);</span>
				<span class="k">my</span> <span class="nv">$cond_lines</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nv">$#newlines</span><span class="p">;</span>
				<span class="k">my</span> <span class="nv">$stat_real</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>

				<span class="nv">$stat_real</span> <span class="o">=</span> <span class="n">raw_line</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$cond_lines</span><span class="p">)</span>
							<span class="o">.</span> <span class="s">&quot;\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$cond_lines</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$stat_real</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$cond_lines</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$stat_real</span> <span class="o">=</span> <span class="s">&quot;[...]\n$stat_real&quot;</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;TRAILING_STATEMENTS&quot;</span><span class="p">,</span>
				      <span class="s">&quot;trailing statements should be on next line\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span> <span class="o">.</span> <span class="nv">$stat_real</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-202"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-202">&#182;</a></div><p>Check for bitwise tests written as boolean</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /</span>
<span class="sr">			(?:</span>
<span class="sr">				(?:\[|\(|\&amp;\&amp;|\|\|)</span>
<span class="sr">				\s*0[xX][0-9]+\s*</span>
<span class="sr">				(?:\&amp;\&amp;|\|\|)</span>
<span class="sr">			|</span>
<span class="sr">				(?:\&amp;\&amp;|\|\|)</span>
<span class="sr">				\s*0[xX][0-9]+\s*</span>
<span class="sr">				(?:\&amp;\&amp;|\|\||\)|\])</span>
<span class="sr">			)/x</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;HEXADECIMAL_BOOLEAN_TEST&quot;</span><span class="p">,</span>
			     <span class="s">&quot;boolean test with hexadecimal, perhaps just 1 \&amp; or \|?\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-203"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-203">&#182;</a></div><p>if and else should not have general statements after it</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*(?:}\s*)?else\b(.*)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$s</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="nv">$s</span> <span class="o">=~</span> <span class="sr">s/$;//g</span><span class="p">;</span> 	<span class="c1"># Remove any comments</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">!~</span> <span class="sr">/^\s*(?:\sif|(?:{|)\s*\\?\s*$)/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;TRAILING_STATEMENTS&quot;</span><span class="p">,</span>
				      <span class="s">&quot;trailing statements should be on next line\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-204"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-204">&#182;</a></div><p>if should not continue a brace</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /}\s*if\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;TRAILING_STATEMENTS&quot;</span><span class="p">,</span>
			      <span class="s">&quot;trailing statements should be on next line\n&quot;</span> <span class="o">.</span>
				<span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-205"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-205">&#182;</a></div><p>case and default should not have general statements after them</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*(?:case\s*.*|default\s*):/g</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">!~</span> <span class="o">/\</span><span class="n">G</span><span class="p">(?:</span>
			<span class="p">(?:</span><span class="o">\</span><span class="n">s</span><span class="o">*</span><span class="vg">$;</span><span class="o">*</span><span class="p">)(?:</span><span class="o">\</span><span class="n">s</span><span class="o">*</span><span class="p">{)?(?:</span><span class="o">\</span><span class="n">s</span><span class="o">*</span><span class="vg">$;</span><span class="o">*</span><span class="p">)(?:</span><span class="o">\</span><span class="n">s</span><span class="o">*\\</span><span class="p">)?</span><span class="o">\</span><span class="n">s</span><span class="o">*</span><span class="vg">$|</span>
			<span class="o">\</span><span class="n">s</span><span class="o">*</span><span class="k">return</span><span class="o">\</span><span class="n">s</span><span class="o">+</span>
		    <span class="p">)</span><span class="o">/</span><span class="n">xg</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;TRAILING_STATEMENTS&quot;</span><span class="p">,</span>
			      <span class="s">&quot;trailing statements should be on next line\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-206"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-206">&#182;</a></div><p>Check for }<nl>else {, these must be at the same
indent level to be relevant to each other.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$prevline</span><span class="o">=~</span><span class="sr">/}\s*$/</span> <span class="ow">and</span> <span class="nv">$line</span><span class="o">=~</span><span class="sr">/^.\s*else\s*/</span> <span class="ow">and</span>
						<span class="nv">$previndent</span> <span class="o">==</span> <span class="nv">$indent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;ELSE_AFTER_BRACE&quot;</span><span class="p">,</span>
			      <span class="s">&quot;else should follow close brace &#39;}&#39;\n&quot;</span> <span class="o">.</span> <span class="nv">$hereprev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$prevline</span><span class="o">=~</span><span class="sr">/}\s*$/</span> <span class="ow">and</span> <span class="nv">$line</span><span class="o">=~</span><span class="sr">/^.\s*while\s*/</span> <span class="ow">and</span>
						<span class="nv">$previndent</span> <span class="o">==</span> <span class="nv">$indent</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="p">(</span><span class="nv">$s</span><span class="p">,</span> <span class="nv">$c</span><span class="p">)</span> <span class="o">=</span> <span class="n">ctx_statement_block</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$realcnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-207"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-207">&#182;</a></div><p>Find out what is on the end of the line after the
conditional.</p></td><td class="code"><div class="highlight"><pre>			<span class="nb">substr</span><span class="p">(</span><span class="nv">$s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$c</span><span class="p">),</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
			<span class="nv">$s</span> <span class="o">=~</span> <span class="sr">s/\n.*//g</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">=~</span><span class="sr"> /^\s*;/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;WHILE_AFTER_BRACE&quot;</span><span class="p">,</span>
				      <span class="s">&quot;while should follow close brace &#39;}&#39;\n&quot;</span> <span class="o">.</span> <span class="nv">$hereprev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-208"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-208">&#182;</a></div><p>studly caps, commented out until figure out how to distinguish between use of existing and adding new
    if (($line=~/[\w_][a-z\d]+[A-Z]/) and !($line=~/print/)) {
        print "No studly caps, use _\n";
        print "$herecurr";
        $clean = 0;
    }</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-209"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-209">&#182;</a></div><p>no spaces allowed after \ in define</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span><span class="o">=~</span><span class="sr">/\#\s*define.*\\\s$/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;WHITESPACE_AFTER_LINE_CONTINUATION&quot;</span><span class="p">,</span>
			     <span class="s">&quot;Whitepspace after \\ makes next lines useless\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-210"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-210">&#182;</a></div><p>warn if <asm/foo.h> is #included and <linux/foo.h> is available (uses RAW line)</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$tree</span> <span class="o">&amp;&amp;</span> <span class="nv">$rawline</span> <span class="o">=~</span> <span class="sr">m{^.\s*\#\s*include\s*\&lt;asm\/(.*)\.h\&gt;}</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="s">&quot;$1.h&quot;</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$checkfile</span> <span class="o">=</span> <span class="s">&quot;include/linux/$file&quot;</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">f</span> <span class="s">&quot;$root/$checkfile&quot;</span> <span class="o">&amp;&amp;</span>
			    <span class="nv">$realfile</span> <span class="ow">ne</span> <span class="nv">$checkfile</span> <span class="o">&amp;&amp;</span>
			    <span class="nv">$1</span> <span class="o">!~</span> <span class="sr">/$allowed_asm_includes/</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$realfile</span> <span class="o">=~</span> <span class="sr">m{^arch/}</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;ARCH_INCLUDE_LINUX&quot;</span><span class="p">,</span>
					    <span class="s">&quot;Consider using #include &lt;linux/$file&gt; instead of &lt;asm/$file&gt;\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;INCLUDE_LINUX&quot;</span><span class="p">,</span>
					     <span class="s">&quot;Use #include &lt;linux/$file&gt; instead of &lt;asm/$file&gt;\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-211"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-211">&#182;</a></div><p>multi-statement macros should be enclosed in a do while loop, grab the
first statement and ensure its the whole macro if its not enclosed
in a known good container</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$realfile</span> <span class="o">!~</span> <span class="sr">m@/vmlinux.lds.h$@</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*\#\s*define\s*$Ident(\()?/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$ln</span> <span class="o">=</span> <span class="nv">$linenr</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$cnt</span> <span class="o">=</span> <span class="nv">$realcnt</span><span class="p">;</span>
			<span class="k">my</span> <span class="p">(</span><span class="nv">$off</span><span class="p">,</span> <span class="nv">$dstat</span><span class="p">,</span> <span class="nv">$dcond</span><span class="p">,</span> <span class="nv">$rest</span><span class="p">);</span>
			<span class="k">my</span> <span class="nv">$ctx</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
			<span class="p">(</span><span class="nv">$dstat</span><span class="p">,</span> <span class="nv">$dcond</span><span class="p">,</span> <span class="nv">$ln</span><span class="p">,</span> <span class="nv">$cnt</span><span class="p">,</span> <span class="nv">$off</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">ctx_statement_block</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$realcnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="nv">$ctx</span> <span class="o">=</span> <span class="nv">$dstat</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-212"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-212">&#182;</a></div><p>print "dstat&lt;$dstat> dcond&lt;$dcond> cnt&lt;$cnt> off&lt;$off>\n";
print "LINE&lt;$lines[$ln-1]> len&lt;" . length($lines[$ln-1]) . "\n";</p></td><td class="code"><div class="highlight"><pre>			<span class="nv">$dstat</span> <span class="o">=~</span> <span class="sr">s/^.\s*\#\s*define\s+$Ident(?:\([^\)]*\))?\s*//</span><span class="p">;</span>
			<span class="nv">$dstat</span> <span class="o">=~</span> <span class="sr">s/$;//g</span><span class="p">;</span>
			<span class="nv">$dstat</span> <span class="o">=~</span> <span class="sr">s/\\\n.//g</span><span class="p">;</span>
			<span class="nv">$dstat</span> <span class="o">=~</span> <span class="sr">s/^\s*//s</span><span class="p">;</span>
			<span class="nv">$dstat</span> <span class="o">=~</span> <span class="sr">s/\s*$//s</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-213"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-213">&#182;</a></div><p>Flatten any parentheses and braces</p></td><td class="code"><div class="highlight"><pre>			<span class="k">while</span> <span class="p">(</span><span class="nv">$dstat</span> <span class="o">=~</span> <span class="sr">s/\([^\(\)]*\)/1/</span> <span class="o">||</span>
			       <span class="nv">$dstat</span> <span class="o">=~</span> <span class="sr">s/\{[^\{\}]*\}/1/</span> <span class="o">||</span>
			       <span class="nv">$dstat</span> <span class="o">=~</span> <span class="sr">s/\[[^\[\]]*\]/1/</span><span class="p">)</span>
			<span class="p">{</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-214"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-214">&#182;</a></div><p>Flatten any obvious string concatentation.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">while</span> <span class="p">(</span><span class="nv">$dstat</span> <span class="o">=~</span> <span class="sr">s/(&quot;X*&quot;)\s*$Ident/$1/</span> <span class="o">||</span>
			       <span class="nv">$dstat</span> <span class="o">=~</span> <span class="sr">s/$Ident\s*(&quot;X*&quot;)/$1/</span><span class="p">)</span>
			<span class="p">{</span>
			<span class="p">}</span>

			<span class="k">my</span> <span class="nv">$exceptions</span> <span class="o">=</span> <span class="sx">qr{</span>
<span class="sx">				$Declare|</span>
<span class="sx">				module_param_named|</span>
<span class="sx">				MODULE_PARAM_DESC|</span>
<span class="sx">				DECLARE_PER_CPU|</span>
<span class="sx">				DEFINE_PER_CPU|</span>
<span class="sx">				__typeof__\(|</span>
<span class="sx">				union|</span>
<span class="sx">				struct|</span>
<span class="sx">				\.$Ident\s*=\s*|</span>
<span class="sx">				^\&quot;|\&quot;$</span>
<span class="sx">			}</span><span class="n">x</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-215"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-215">&#182;</a></div><p>print "REST&lt;$rest> dstat&lt;$dstat> ctx&lt;$ctx>\n";</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$dstat</span> <span class="ow">ne</span> <span class="s">&#39;&#39;</span> <span class="o">&amp;&amp;</span>
			    <span class="nv">$dstat</span> <span class="o">!~</span> <span class="sr">/^(?:$Ident|-?$Constant),$/</span> <span class="o">&amp;&amp;</span>			<span class="c1"># 10, // foo(),</span>
			    <span class="nv">$dstat</span> <span class="o">!~</span> <span class="sr">/^(?:$Ident|-?$Constant);$/</span> <span class="o">&amp;&amp;</span>			<span class="c1"># foo();</span>
			    <span class="nv">$dstat</span> <span class="o">!~</span> <span class="sr">/^[!~-]?(?:$Ident|$Constant)$/</span> <span class="o">&amp;&amp;</span>		<span class="c1"># 10 // foo() // !foo // ~foo // -foo</span>
			    <span class="nv">$dstat</span> <span class="o">!~</span> <span class="sr">/^&#39;X&#39;$/</span> <span class="o">&amp;&amp;</span>					<span class="c1"># character constants</span>
			    <span class="nv">$dstat</span> <span class="o">!~</span> <span class="sr">/$exceptions/</span> <span class="o">&amp;&amp;</span>
			    <span class="nv">$dstat</span> <span class="o">!~</span> <span class="sr">/^\.$Ident\s*=/</span> <span class="o">&amp;&amp;</span>				<span class="c1"># .foo =</span>
			    <span class="nv">$dstat</span> <span class="o">!~</span> <span class="sr">/^do\s*$Constant\s*while\s*$Constant;?$/</span> <span class="o">&amp;&amp;</span>	<span class="c1"># do {...} while (...); // do {...} while (...)</span>
			    <span class="nv">$dstat</span> <span class="o">!~</span> <span class="sr">/^for\s*$Constant$/</span> <span class="o">&amp;&amp;</span>				<span class="c1"># for (...)</span>
			    <span class="nv">$dstat</span> <span class="o">!~</span> <span class="sr">/^for\s*$Constant\s+(?:$Ident|-?$Constant)$/</span> <span class="o">&amp;&amp;</span>	<span class="c1"># for (...) bar()</span>
			    <span class="nv">$dstat</span> <span class="o">!~</span> <span class="sr">/^do\s*{/</span> <span class="o">&amp;&amp;</span>					<span class="c1"># do {...</span>
			    <span class="nv">$dstat</span> <span class="o">!~</span> <span class="sr">/^\({/</span><span class="p">)</span>						<span class="c1"># ({...</span>
			<span class="p">{</span>
				<span class="nv">$ctx</span> <span class="o">=~</span> <span class="sr">s/\n*$//</span><span class="p">;</span>
				<span class="k">my</span> <span class="nv">$herectx</span> <span class="o">=</span> <span class="nv">$here</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
				<span class="k">my</span> <span class="nv">$cnt</span> <span class="o">=</span> <span class="n">statement_rawlines</span><span class="p">(</span><span class="nv">$ctx</span><span class="p">);</span>

				<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$n</span> <span class="o">&lt;</span> <span class="nv">$cnt</span><span class="p">;</span> <span class="nv">$n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$herectx</span> <span class="o">.=</span> <span class="n">raw_line</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$n</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="nv">$dstat</span> <span class="o">=~</span><span class="sr"> /;/</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;MULTISTATEMENT_MACRO_USE_DO_WHILE&quot;</span><span class="p">,</span>
					      <span class="s">&quot;Macros with multiple statements should be enclosed in a do - while loop\n&quot;</span> <span class="o">.</span> <span class="s">&quot;$herectx&quot;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;COMPLEX_MACRO&quot;</span><span class="p">,</span>
					      <span class="s">&quot;Macros with complex values should be enclosed in parenthesis\n&quot;</span> <span class="o">.</span> <span class="s">&quot;$herectx&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-216"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-216">&#182;</a></div><p>make sure symbols are always wrapped with VMLINUX<em>SYMBOL() ...
all assignments may have only one of the following with an assignment:
.
ALIGN(...)
VMLINUX</em>SYMBOL(...)</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$realfile</span> <span class="ow">eq</span> <span class="s">&#39;vmlinux.lds.h&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /(?:(?:^|\s)$Ident\s*=|=\s*$Ident(?:\s|$))/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;MISSING_VMLINUX_SYMBOL&quot;</span><span class="p">,</span>
			     <span class="s">&quot;vmlinux.lds.h needs VMLINUX_SYMBOL() around C-visible symbols\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-217"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-217">&#182;</a></div><p>check for redundant bracing round if etc</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /(^.*)\bif\b/</span> <span class="o">&amp;&amp;</span> <span class="nv">$1</span> <span class="o">!~</span> <span class="sr">/else\s*$/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="p">(</span><span class="nv">$level</span><span class="p">,</span> <span class="nv">$endln</span><span class="p">,</span> <span class="nv">@chunks</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">ctx_statement_full</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$realcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-218"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-218">&#182;</a></div><p>print "chunks&lt;$#chunks> linenr&lt;$linenr> endln&lt;$endln> level&lt;$level>\n";
print "APW: &lt;&lt;$chunks[1][0]>>&lt;&lt;$chunks[1][1]>>\n";</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$#chunks</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">my</span> <span class="nv">@allowed</span> <span class="o">=</span> <span class="p">();</span>
				<span class="k">my</span> <span class="nv">$allow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">my</span> <span class="nv">$seen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">my</span> <span class="nv">$herectx</span> <span class="o">=</span> <span class="nv">$here</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
				<span class="k">my</span> <span class="nv">$ln</span> <span class="o">=</span> <span class="nv">$linenr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">for</span> <span class="k">my</span> <span class="nv">$chunk</span> <span class="p">(</span><span class="nv">@chunks</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">my</span> <span class="p">(</span><span class="nv">$cond</span><span class="p">,</span> <span class="nv">$block</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$chunk</span><span class="p">};</span></pre></div></td></tr>


<tr id="section-219"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-219">&#182;</a></div><p>If the condition carries leading newlines, then count those as offsets.</p></td><td class="code"><div class="highlight"><pre>					<span class="k">my</span> <span class="p">(</span><span class="nv">$whitespace</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$cond</span> <span class="o">=~</span><span class="sr"> /^((?:\s*\n[+-])*\s*)/s</span><span class="p">);</span>
					<span class="k">my</span> <span class="nv">$offset</span> <span class="o">=</span> <span class="n">statement_rawlines</span><span class="p">(</span><span class="nv">$whitespace</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

					<span class="nv">$allowed</span><span class="p">[</span><span class="nv">$allow</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-220"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-220">&#182;</a></div><p>print "COND&lt;$cond> whitespace&lt;$whitespace> offset&lt;$offset>\n";</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-221"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-221">&#182;</a></div><p>We have looked at and allowed this specific line.</p></td><td class="code"><div class="highlight"><pre>					<span class="nv">$suppress_ifbraces</span><span class="p">{</span><span class="nv">$ln</span> <span class="o">+</span> <span class="nv">$offset</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

					<span class="nv">$herectx</span> <span class="o">.=</span> <span class="s">&quot;$rawlines[$ln + $offset]\n[...]\n&quot;</span><span class="p">;</span>
					<span class="nv">$ln</span> <span class="o">+=</span> <span class="n">statement_rawlines</span><span class="p">(</span><span class="nv">$block</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

					<span class="nb">substr</span><span class="p">(</span><span class="nv">$block</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$cond</span><span class="p">),</span> <span class="s">&#39;&#39;</span><span class="p">);</span>

					<span class="nv">$seen</span><span class="o">++</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$block</span> <span class="o">=~</span><span class="sr"> /^\s*{/</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-222"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-222">&#182;</a></div><p>print "cond&lt;$cond> block&lt;$block> allowed&lt;$allowed[$allow]>\n";</p></td><td class="code"><div class="highlight"><pre>					<span class="k">if</span> <span class="p">(</span><span class="n">statement_lines</span><span class="p">(</span><span class="nv">$cond</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-223"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-223">&#182;</a></div><p>print "APW: ALLOWED: cond&lt;$cond>\n";</p></td><td class="code"><div class="highlight"><pre>						<span class="nv">$allowed</span><span class="p">[</span><span class="nv">$allow</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$block</span> <span class="o">=~</span><span class="sr">/\b(?:if|for|while)\b/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-224"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-224">&#182;</a></div><p>print "APW: ALLOWED: block&lt;$block>\n";</p></td><td class="code"><div class="highlight"><pre>						<span class="nv">$allowed</span><span class="p">[</span><span class="nv">$allow</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">statement_block_size</span><span class="p">(</span><span class="nv">$block</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-225"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-225">&#182;</a></div><p>print "APW: ALLOWED: lines block&lt;$block>\n";</p></td><td class="code"><div class="highlight"><pre>						<span class="nv">$allowed</span><span class="p">[</span><span class="nv">$allow</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="nv">$allow</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$seen</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">my</span> <span class="nv">$sum_allowed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">foreach</span> <span class="p">(</span><span class="nv">@allowed</span><span class="p">)</span> <span class="p">{</span>
						<span class="nv">$sum_allowed</span> <span class="o">+=</span> <span class="nv">$_</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$sum_allowed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;BRACES&quot;</span><span class="p">,</span>
						     <span class="s">&quot;braces {} are not necessary for any arm of this statement\n&quot;</span> <span class="o">.</span> <span class="nv">$herectx</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$sum_allowed</span> <span class="o">!=</span> <span class="nv">$allow</span> <span class="o">&amp;&amp;</span>
						 <span class="nv">$seen</span> <span class="o">!=</span> <span class="nv">$allow</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;BRACES&quot;</span><span class="p">,</span>
						    <span class="s">&quot;braces {} should be used on all arms of this statement\n&quot;</span> <span class="o">.</span> <span class="nv">$herectx</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$suppress_ifbraces</span><span class="p">{</span><span class="nv">$linenr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span> <span class="o">&amp;&amp;</span>
					<span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\b(if|while|for|else)\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$allowed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-226"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-226">&#182;</a></div><p>Check the pre-context.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="vg">$-</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">=~</span><span class="sr"> /(\}\s*)$/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-227"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-227">&#182;</a></div><p>print "APW: ALLOWED: pre&lt;$1>\n";</p></td><td class="code"><div class="highlight"><pre>				<span class="nv">$allowed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">my</span> <span class="p">(</span><span class="nv">$level</span><span class="p">,</span> <span class="nv">$endln</span><span class="p">,</span> <span class="nv">@chunks</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">ctx_statement_full</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$realcnt</span><span class="p">,</span> <span class="vg">$-</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-228"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-228">&#182;</a></div><p>Check the condition.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">my</span> <span class="p">(</span><span class="nv">$cond</span><span class="p">,</span> <span class="nv">$block</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">]};</span></pre></div></td></tr>


<tr id="section-229"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-229">&#182;</a></div><p>print "CHECKING&lt;$linenr> cond&lt;$cond> block&lt;$block>\n";</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$cond</span><span class="p">)</span> <span class="p">{</span>
				<span class="nb">substr</span><span class="p">(</span><span class="nv">$block</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$cond</span><span class="p">),</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">statement_lines</span><span class="p">(</span><span class="nv">$cond</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-230"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-230">&#182;</a></div><p>print "APW: ALLOWED: cond&lt;$cond>\n";</p></td><td class="code"><div class="highlight"><pre>				<span class="nv">$allowed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$block</span> <span class="o">=~</span><span class="sr">/\b(?:if|for|while)\b/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-231"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-231">&#182;</a></div><p>print "APW: ALLOWED: block&lt;$block>\n";</p></td><td class="code"><div class="highlight"><pre>				<span class="nv">$allowed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">statement_block_size</span><span class="p">(</span><span class="nv">$block</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-232"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-232">&#182;</a></div><p>print "APW: ALLOWED: lines block&lt;$block>\n";</p></td><td class="code"><div class="highlight"><pre>				<span class="nv">$allowed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-233"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-233">&#182;</a></div><p>Check the post-context.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">my</span> <span class="p">(</span><span class="nv">$cond</span><span class="p">,</span> <span class="nv">$block</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">]};</span>
				<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$cond</span><span class="p">)</span> <span class="p">{</span>
					<span class="nb">substr</span><span class="p">(</span><span class="nv">$block</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$cond</span><span class="p">),</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$block</span> <span class="o">=~</span><span class="sr"> /^\s*\{/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-234"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-234">&#182;</a></div><p>print "APW: ALLOWED: chunk-1 block&lt;$block>\n";</p></td><td class="code"><div class="highlight"><pre>					<span class="nv">$allowed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$level</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$block</span> <span class="o">=~</span><span class="sr"> /^\s*\{/</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$allowed</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">my</span> <span class="nv">$herectx</span> <span class="o">=</span> <span class="nv">$here</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
				<span class="k">my</span> <span class="nv">$cnt</span> <span class="o">=</span> <span class="n">statement_rawlines</span><span class="p">(</span><span class="nv">$block</span><span class="p">);</span>

				<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$n</span> <span class="o">&lt;</span> <span class="nv">$cnt</span><span class="p">;</span> <span class="nv">$n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$herectx</span> <span class="o">.=</span> <span class="n">raw_line</span><span class="p">(</span><span class="nv">$linenr</span><span class="p">,</span> <span class="nv">$n</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;BRACES&quot;</span><span class="p">,</span>
				     <span class="s">&quot;braces {} are not necessary for single statement blocks\n&quot;</span> <span class="o">.</span> <span class="nv">$herectx</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-235"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-235">&#182;</a></div><p>don't include deprecated include files (uses RAW line)</p></td><td class="code"><div class="highlight"><pre>		<span class="k">for</span> <span class="k">my</span> <span class="nv">$inc</span> <span class="p">(</span><span class="nv">@dep_includes</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$rawline</span> <span class="o">=~</span> <span class="sr">m@^.\s*\#\s*include\s*\&lt;$inc&gt;@</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;DEPRECATED_INCLUDE&quot;</span><span class="p">,</span>
				      <span class="s">&quot;Don&#39;t use &lt;$inc&gt;: see Documentation/feature-removal-schedule.txt\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-236"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-236">&#182;</a></div><p>don't use deprecated functions</p></td><td class="code"><div class="highlight"><pre>		<span class="k">for</span> <span class="k">my</span> <span class="nv">$func</span> <span class="p">(</span><span class="nv">@dep_functions</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\b$func\b/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;DEPRECATED_FUNCTION&quot;</span><span class="p">,</span>
				      <span class="s">&quot;Don&#39;t use $func(): see Documentation/feature-removal-schedule.txt\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-237"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-237">&#182;</a></div><p>no volatiles please</p></td><td class="code"><div class="highlight"><pre>		<span class="k">my</span> <span class="nv">$asm_volatile</span> <span class="o">=</span> <span class="sx">qr{\b(__asm__|asm)\s+(__volatile__|volatile)\b}</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bvolatile\b/</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/$asm_volatile/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;VOLATILE&quot;</span><span class="p">,</span>
			     <span class="s">&quot;Use of volatile is usually wrong: see Documentation/volatile-considered-harmful.txt\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-238"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-238">&#182;</a></div><p>warn about #if 0</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*\#\s*if\s+0\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;REDUNDANT_CODE&quot;</span><span class="p">,</span>
			    <span class="s">&quot;if this code is redundant consider removing it\n&quot;</span> <span class="o">.</span>
				<span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-239"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-239">&#182;</a></div><p>check for needless kfree() checks</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$prevline</span> <span class="o">=~</span><span class="sr"> /\bif\s*\(([^\)]*)\)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$expr</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bkfree\(\Q$expr\E\);/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;NEEDLESS_KFREE&quot;</span><span class="p">,</span>
				     <span class="s">&quot;kfree(NULL) is safe this check is probably not required\n&quot;</span> <span class="o">.</span> <span class="nv">$hereprev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-240"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-240">&#182;</a></div><p>check for needless usb<em>free</em>urb() checks</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$prevline</span> <span class="o">=~</span><span class="sr"> /\bif\s*\(([^\)]*)\)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$expr</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\busb_free_urb\(\Q$expr\E\);/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;NEEDLESS_USB_FREE_URB&quot;</span><span class="p">,</span>
				     <span class="s">&quot;usb_free_urb(NULL) is safe this check is probably not required\n&quot;</span> <span class="o">.</span> <span class="nv">$hereprev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-241"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-241">&#182;</a></div><p>prefer usleep_range over udelay</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\budelay\s*\(\s*(\w+)\s*\)/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-242"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-242">&#182;</a></div><p>ignore udelay's &lt; 10, however</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">((</span><span class="nv">$1</span> <span class="o">=~</span><span class="sr"> /(\d+)/</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$1</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;USLEEP_RANGE&quot;</span><span class="p">,</span>
				    <span class="s">&quot;usleep_range is preferred over udelay; see Documentation/timers/timers-howto.txt\n&quot;</span> <span class="o">.</span> <span class="nv">$line</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-243"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-243">&#182;</a></div><p>warn about unexpectedly long msleep's</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bmsleep\s*\((\d+)\);/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$1</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;MSLEEP&quot;</span><span class="p">,</span>
				     <span class="s">&quot;msleep &lt; 20ms can sleep for up to 20ms; see Documentation/timers/timers-howto.txt\n&quot;</span> <span class="o">.</span> <span class="nv">$line</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-244"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-244">&#182;</a></div><p>warn about #ifdefs in C files
    if ($line =~ /^.\s<em>#\s</em>if(|n)def/ &amp;&amp; ($realfile =~ /.c$/)) {
        print "#ifdef in C files should be avoided\n";
        print "$herecurr";
        $clean = 0;
    }</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-245"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-245">&#182;</a></div><p>warn about spacing in #ifdefs</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*\#\s*(ifdef|ifndef|elif)\s\s+/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;SPACING&quot;</span><span class="p">,</span>
			      <span class="s">&quot;exactly one space required after that #$1\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-246"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-246">&#182;</a></div><p>check for spinlock_t definitions without a comment.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*(struct\s+mutex|spinlock_t)\s+\S+;/</span> <span class="o">||</span>
		    <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*(DEFINE_MUTEX)\s*\(/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$which</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx_has_comment</span><span class="p">(</span><span class="nv">$first_line</span><span class="p">,</span> <span class="nv">$linenr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;UNCOMMENTED_DEFINITION&quot;</span><span class="p">,</span>
				    <span class="s">&quot;$1 definition without comment\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-247"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-247">&#182;</a></div><p>check for memory barriers without a comment.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\b(mb|rmb|wmb|read_barrier_depends|smp_mb|smp_rmb|smp_wmb|smp_read_barrier_depends)\(/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx_has_comment</span><span class="p">(</span><span class="nv">$first_line</span><span class="p">,</span> <span class="nv">$linenr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;MEMORY_BARRIER&quot;</span><span class="p">,</span>
				    <span class="s">&quot;memory barrier without comment\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-248"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-248">&#182;</a></div><p>check of hardware specific defines</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span> <span class="sr">m@^.\s*\#\s*if.*\b(__i386__|__powerpc64__|__sun__|__s390x__)\b@</span> <span class="o">&amp;&amp;</span> <span class="nv">$realfile</span> <span class="o">!~</span> <span class="sr">m@include/asm-@</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;ARCH_DEFINES&quot;</span><span class="p">,</span>
			    <span class="s">&quot;architecture specific defines should be avoided\n&quot;</span> <span class="o">.</span>  <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-249"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-249">&#182;</a></div><p>Check that the storage class is at the beginning of a declaration</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\b$Storage\b/</span> <span class="o">&amp;&amp;</span> <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/^.\s*$Storage\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;STORAGE_CLASS&quot;</span><span class="p">,</span>
			     <span class="s">&quot;storage class should be at the beginning of the declaration\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">)</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-250"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-250">&#182;</a></div><p>check the location of the inline attribute, that it is between
storage class and type.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\b$Type\s+$Inline\b/</span> <span class="o">||</span>
		    <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\b$Inline\s+$Storage\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;INLINE_LOCATION&quot;</span><span class="p">,</span>
			      <span class="s">&quot;inline keyword should sit between storage class and type\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-251"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-251">&#182;</a></div><p>Check for <strong>inline</strong> and __inline, prefer inline</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\b(__inline__|__inline)\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;INLINE&quot;</span><span class="p">,</span>
			     <span class="s">&quot;plain inline is preferred over $1\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-252"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-252">&#182;</a></div><p>Check for <strong>attribute</strong> packed, prefer __packed</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\b__attribute__\s*\(\s*\(.*\bpacked\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;PREFER_PACKED&quot;</span><span class="p">,</span>
			     <span class="s">&quot;__packed is preferred over __attribute__((packed))\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-253"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-253">&#182;</a></div><p>Check for <strong>attribute</strong> aligned, prefer __aligned</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\b__attribute__\s*\(\s*\(.*aligned/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;PREFER_ALIGNED&quot;</span><span class="p">,</span>
			     <span class="s">&quot;__aligned(size) is preferred over __attribute__((aligned(size)))\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-254"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-254">&#182;</a></div><p>Check for <strong>attribute</strong> format(printf, prefer __printf</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\b__attribute__\s*\(\s*\(\s*format\s*\(\s*printf/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;PREFER_PRINTF&quot;</span><span class="p">,</span>
			     <span class="s">&quot;__printf(string-index, first-to-check) is preferred over __attribute__((format(printf, string-index, first-to-check)))\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-255"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-255">&#182;</a></div><p>Check for <strong>attribute</strong> format(scanf, prefer __scanf</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\b__attribute__\s*\(\s*\(\s*format\s*\(\s*scanf\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;PREFER_SCANF&quot;</span><span class="p">,</span>
			     <span class="s">&quot;__scanf(string-index, first-to-check) is preferred over __attribute__((format(scanf, string-index, first-to-check)))\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-256"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-256">&#182;</a></div><p>check for sizeof(&amp;)</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bsizeof\s*\(\s*\&amp;/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;SIZEOF_ADDRESS&quot;</span><span class="p">,</span>
			     <span class="s">&quot;sizeof(&amp; should be avoided\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-257"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-257">&#182;</a></div><p>check for line continuations in quoted strings with odd counts of "</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> /\\$/</span> <span class="o">&amp;&amp;</span> <span class="nv">$rawline</span> <span class="o">=~</span> <span class="nb">tr</span><span class="sr">/&quot;/</span><span class="s">&quot;/ % 2) {</span>
<span class="s">			WARN(&quot;</span><span class="n">LINE_CONTINUATIONS</span><span class="s">&quot;,</span>
<span class="s">			     &quot;</span><span class="n">Avoid</span> <span class="n">line</span> <span class="n">continuations</span> <span class="n">in</span> <span class="n">quoted</span> <span class="n">strings</span><span class="o">\</span><span class="n">n</span><span class="s">&quot; . $herecurr);</span>
<span class="s">		}</span>


<span class="s">#DIVIDER</span>
<span class="s">		if ($^V &amp;&amp; $^V ge 5.10.0 &amp;&amp;</span>
<span class="s">		    defined $stat &amp;&amp;</span>
<span class="s">		    $stat =~ /^\+(?:.*?)\bmemset\s*\(\s*$FuncArg\s*,\s*$FuncArg\s*\,\s*$FuncArg\s*\)/s) {</span>

<span class="s">			my $ms_addr = $2;</span>
<span class="s">			my $ms_val = $7;</span>
<span class="s">			my $ms_size = $12;</span>

<span class="s">			if ($ms_size =~ /^(0x|)0$/i) {</span>
<span class="s">				ERROR(&quot;</span><span class="n">MEMSET</span><span class="s">&quot;,</span>
<span class="s">				      &quot;</span><span class="n">memset</span> <span class="n">to</span> <span class="mi">0</span><span class="s">&#39;s uses 0 as the 2nd argument, not the 3rd\n&quot; . &quot;$here\n$stat\n&quot;);</span>
<span class="s">			} elsif ($ms_size =~ /^(0x|)1$/i) {</span>
<span class="s">				WARN(&quot;MEMSET&quot;,</span>
<span class="s">				     &quot;single byte memset is suspicious. Swapped 2nd/3rd argument?\n&quot; . &quot;$here\n$stat\n&quot;);</span>
<span class="s">			}</span>
<span class="s">		}</span>


<span class="s">#DIVIDER</span>
<span class="s">		if ($^V &amp;&amp; $^V ge 5.10.0 &amp;&amp;</span>
<span class="s">		    defined $stat &amp;&amp;</span>
<span class="s">		    $stat =~ /^\+(?:.*?)\b(min|max)\s*\(\s*$FuncArg\s*,\s*$FuncArg\s*\)/) {</span>
<span class="s">			if (defined $2 || defined $7) {</span>
<span class="s">				my $call = $1;</span>
<span class="s">				my $cast1 = deparenthesize($2);</span>
<span class="s">				my $arg1 = $3;</span>
<span class="s">				my $cast2 = deparenthesize($7);</span>
<span class="s">				my $arg2 = $8;</span>
<span class="s">				my $cast;</span>

<span class="s">				if ($cast1 ne &quot;&quot; &amp;&amp; $cast2 ne &quot;&quot; &amp;&amp; $cast1 ne $cast2) {</span>
<span class="s">					$cast = &quot;$cast1 or $cast2&quot;;</span>
<span class="s">				} elsif ($cast1 ne &quot;&quot;) {</span>
<span class="s">					$cast = $cast1;</span>
<span class="s">				} else {</span>
<span class="s">					$cast = $cast2;</span>
<span class="s">				}</span>
<span class="s">				WARN(&quot;MINMAX&quot;,</span>
<span class="s">				     &quot;$call() should probably be ${call}_t($cast, $arg1, $arg2)\n&quot; . &quot;$here\n$stat\n&quot;);</span>
<span class="s">			}</span>
<span class="s">		}</span>


<span class="s">#DIVIDER</span>
<span class="s">		if ($realfile =~ /\.c$/ &amp;&amp; defined $stat &amp;&amp;</span>
<span class="s">		    $stat =~ /^.\s*(?:extern\s+)?$Type\s+($Ident)(\s*)\(/s)</span>
<span class="s">		{</span>
<span class="s">			my $function_name = $1;</span>
<span class="s">			my $paren_space = $2;</span>

<span class="s">			my $s = $stat;</span>
<span class="s">			if (defined $cond) {</span>
<span class="s">				substr($s, 0, length($cond), &#39;&#39;);</span>
<span class="s">			}</span>
<span class="s">			if ($s =~ /^\s*;/ &amp;&amp;</span>
<span class="s">			    $function_name ne &#39;</span><span class="n">uninitialized_var</span><span class="err">&#39;</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;AVOID_EXTERNS&quot;</span><span class="p">,</span>
				     <span class="s">&quot;externs should be avoided in .c files\n&quot;</span> <span class="o">.</span>  <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$paren_space</span> <span class="o">=~</span><span class="sr"> /\n/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;FUNCTION_ARGUMENTS&quot;</span><span class="p">,</span>
				     <span class="s">&quot;arguments for function declarations should follow identifier\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$realfile</span> <span class="o">=~</span><span class="sr"> /\.c$/</span> <span class="o">&amp;&amp;</span> <span class="nb">defined</span> <span class="nv">$stat</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$stat</span> <span class="o">=~</span><span class="sr"> /^.\s*extern\s+/</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;AVOID_EXTERNS&quot;</span><span class="p">,</span>
			     <span class="s">&quot;externs should be avoided in .c files\n&quot;</span> <span class="o">.</span>  <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-258"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-258">&#182;</a></div><p>Check for misused memsets</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$rawline</span> <span class="o">=~</span><span class="sr"> /\b__setup\(&quot;([^&quot;]*)&quot;/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">grep</span><span class="p">(</span><span class="sr">/$name/</span><span class="p">,</span> <span class="nv">@setup_docs</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">CHK</span><span class="p">(</span><span class="s">&quot;UNDOCUMENTED_SETUP&quot;</span><span class="p">,</span>
				    <span class="s">&quot;__setup appears un-documented -- check Documentation/kernel-parameters.txt\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-259"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-259">&#182;</a></div><p>typecasts on min/max could be min<em>t/max</em>t</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\*\s*\)\s*[kv][czm]alloc(_node){0,1}\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;UNNECESSARY_CASTS&quot;</span><span class="p">,</span>
			     <span class="s">&quot;unnecessary cast may hide bugs, see http://c-faq.com/malloc/mallocnocast.html\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-260"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-260">&#182;</a></div><p>check for new externs in .c files.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /;\s*;\s*$/</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">WARN</span><span class="p">(</span><span class="s">&quot;ONE_SEMICOLON&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Statements terminations use 1 semicolon\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-261"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-261">&#182;</a></div><p>checks for new __setup's</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /__FUNCTION__/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;USE_FUNC&quot;</span><span class="p">,</span>
			     <span class="s">&quot;__func__ should be used instead of gcc specific __FUNCTION__\n&quot;</span>  <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-262"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-262">&#182;</a></div><p>check for pointless casting of kmalloc return</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\byield\s*\(\s*\)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;YIELD&quot;</span><span class="p">,</span>
			     <span class="s">&quot;Using yield() is generally wrong. See yield() kernel-doc (sched/core.c)\n&quot;</span>  <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-263"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-263">&#182;</a></div><p>check for multiple semicolons</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*sema_init.+,\W?0\W?\)/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;CONSIDER_COMPLETION&quot;</span><span class="p">,</span>
			     <span class="s">&quot;consider using a completion\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-264"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-264">&#182;</a></div><p>check for gcc specific <strong>FUNCTION</strong></p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\b((simple|strict)_(strto(l|ll|ul|ull)))\s*\(/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;CONSIDER_KSTRTO&quot;</span><span class="p">,</span>
			     <span class="s">&quot;$1 is obsolete, use k$3 instead\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-265"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-265">&#182;</a></div><p>check for use of yield()</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*__initcall\s*\(/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;USE_DEVICE_INITCALL&quot;</span><span class="p">,</span>
			     <span class="s">&quot;please use device_initcall() instead of __initcall()\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-266"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-266">&#182;</a></div><p>check for semaphores initialized locked</p></td><td class="code"><div class="highlight"><pre>		<span class="k">my</span> <span class="nv">$struct_ops</span> <span class="o">=</span> <span class="sx">qr{acpi_dock_ops|</span>
<span class="sx">				address_space_operations|</span>
<span class="sx">				backlight_ops|</span>
<span class="sx">				block_device_operations|</span>
<span class="sx">				dentry_operations|</span>
<span class="sx">				dev_pm_ops|</span>
<span class="sx">				dma_map_ops|</span>
<span class="sx">				extent_io_ops|</span>
<span class="sx">				file_lock_operations|</span>
<span class="sx">				file_operations|</span>
<span class="sx">				hv_ops|</span>
<span class="sx">				ide_dma_ops|</span>
<span class="sx">				intel_dvo_dev_ops|</span>
<span class="sx">				item_operations|</span>
<span class="sx">				iwl_ops|</span>
<span class="sx">				kgdb_arch|</span>
<span class="sx">				kgdb_io|</span>
<span class="sx">				kset_uevent_ops|</span>
<span class="sx">				lock_manager_operations|</span>
<span class="sx">				microcode_ops|</span>
<span class="sx">				mtrr_ops|</span>
<span class="sx">				neigh_ops|</span>
<span class="sx">				nlmsvc_binding|</span>
<span class="sx">				pci_raw_ops|</span>
<span class="sx">				pipe_buf_operations|</span>
<span class="sx">				platform_hibernation_ops|</span>
<span class="sx">				platform_suspend_ops|</span>
<span class="sx">				proto_ops|</span>
<span class="sx">				rpc_pipe_ops|</span>
<span class="sx">				seq_operations|</span>
<span class="sx">				snd_ac97_build_ops|</span>
<span class="sx">				soc_pcmcia_socket_ops|</span>
<span class="sx">				stacktrace_ops|</span>
<span class="sx">				sysfs_ops|</span>
<span class="sx">				tty_operations|</span>
<span class="sx">				usb_mon_operations|</span>
<span class="sx">				wd_ops}</span><span class="n">x</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/\bconst\b/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bstruct\s+($struct_ops)\b/</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;CONST_STRUCT&quot;</span><span class="p">,</span>
			     <span class="s">&quot;struct $1 should normally be const\n&quot;</span> <span class="o">.</span>
				<span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-267"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-267">&#182;</a></div><p>recommend kstrto* over simple<em>strto* and strict</em>strto*</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bNR_CPUS\b/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/^.\s*\s*#\s*if\b.*\bNR_CPUS\b/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/^.\s*\s*#\s*define\b.*\bNR_CPUS\b/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/^.\s*$Declare\s.*\[[^\]]*NR_CPUS[^\]]*\]/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/\[[^\]]*\.\.\.[^\]]*NR_CPUS[^\]]*\]/</span> <span class="o">&amp;&amp;</span>
		    <span class="nv">$line</span> <span class="o">!~</span> <span class="sr">/\[[^\]]*NR_CPUS[^\]]*\.\.\.[^\]]*\]/</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;NR_CPUS&quot;</span><span class="p">,</span>
			     <span class="s">&quot;usage of NR_CPUS is often wrong - consider using cpu_possible(), num_possible_cpus(), for_each_possible_cpu(), etc\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-268"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-268">&#182;</a></div><p>check for <em>_initcall(), use device</em>initcall() explicitly please</p></td><td class="code"><div class="highlight"><pre>		<span class="k">my</span> <span class="nv">$string</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /(?:^|&quot;)([X\t]*)(?:&quot;|$)/g</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$string</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$rawline</span><span class="p">,</span> <span class="vg">$-</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="vg">$+</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="vg">$-</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="nv">$string</span> <span class="o">=~</span> <span class="sr">s/%%/__/g</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$string</span> <span class="o">=~</span><span class="sr"> /(?&lt;!%)%L[udi]/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;PRINTF_L&quot;</span><span class="p">,</span>
				     <span class="s">&quot;\%Ld/%Lu are not-standard C, use %lld/%llu\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
				<span class="k">last</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-269"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-269">&#182;</a></div><p>check for various ops structs, ensure they are const.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\bin_atomic\s*\(/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$realfile</span> <span class="o">=~</span> <span class="sr">m@^drivers/@</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;IN_ATOMIC&quot;</span><span class="p">,</span>
				      <span class="s">&quot;do not use in_atomic in drivers\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$realfile</span> <span class="o">!~</span> <span class="sr">m@^kernel/@</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;IN_ATOMIC&quot;</span><span class="p">,</span>
				     <span class="s">&quot;use of in_atomic() is incorrect outside core kernel code\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-270"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-270">&#182;</a></div><p>use of NR<em>CPUS is usually wrong
ignore definitions of NR</em>CPUS and usage to define arrays as likely right</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^.\s*lockdep_set_novalidate_class\s*\(/</span> <span class="o">||</span>
		    <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /__lockdep_no_validate__\s*\)/</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$realfile</span> <span class="o">!~</span> <span class="sr">m@^kernel/lockdep@</span> <span class="o">&amp;&amp;</span>
			    <span class="nv">$realfile</span> <span class="o">!~</span> <span class="sr">m@^include/linux/lockdep@</span> <span class="o">&amp;&amp;</span>
			    <span class="nv">$realfile</span> <span class="o">!~</span> <span class="sr">m@^drivers/base/core@</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;LOCKDEP&quot;</span><span class="p">,</span>
				      <span class="s">&quot;lockdep_no_validate class is reserved for device-&gt;mutex.\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /debugfs_create_file.*S_IWUGO/</span> <span class="o">||</span>
		    <span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /DEVICE_ATTR.*S_IWUGO/</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;EXPORTED_WORLD_WRITABLE&quot;</span><span class="p">,</span>
			     <span class="s">&quot;Exporting world writable files is usually an error. Consider more restrictive permissions.\n&quot;</span> <span class="o">.</span> <span class="nv">$herecurr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-271"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-271">&#182;</a></div><p>check for %L{u,d,i} in strings</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$#rawlines</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-272"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-272">&#182;</a></div><p>whine mightly about in_atomic</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$mailback</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$clean</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$is_patch</span><span class="p">))</span> <span class="p">{</span>
		<span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-273"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-273">&#182;</a></div><p>check for lockdep<em>set</em>novalidate_class</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$chk_patch</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$is_patch</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$is_patch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;NOT_UNIFIED_DIFF&quot;</span><span class="p">,</span>
		      <span class="s">&quot;Does not appear to be a unified-diff format patch\n&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$is_patch</span> <span class="o">&amp;&amp;</span> <span class="nv">$chk_signoff</span> <span class="o">&amp;&amp;</span> <span class="nv">$signoff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;MISSING_SIGN_OFF&quot;</span><span class="p">,</span>
		      <span class="s">&quot;Missing Signed-off-by: line(s)\n&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">print</span> <span class="n">report_dump</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$summary</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nv">$clean</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$quiet</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">print</span> <span class="s">&quot;$filename &quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$summary_file</span><span class="p">);</span>
		<span class="k">print</span> <span class="s">&quot;total: $cnt_error errors, $cnt_warn warnings, &quot;</span> <span class="o">.</span>
			<span class="p">((</span><span class="nv">$check</span><span class="p">)?</span> <span class="s">&quot;$cnt_chk checks, &quot;</span> <span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">.</span>
			<span class="s">&quot;$cnt_lines lines checked\n&quot;</span><span class="p">;</span>
		<span class="k">print</span> <span class="s">&quot;\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$quiet</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$quiet</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$</span><span class="err">^</span><span class="nv">V</span> <span class="ow">lt</span> <span class="mf">5.10.0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span><span class="p">(</span><span class="s">&quot;NOTE: perl $^V is not modern enough to detect all possible issues.\n&quot;</span><span class="p">);</span>
			<span class="k">print</span><span class="p">(</span><span class="s">&quot;An upgrade to at least perl v5.10.0 is suggested.\n\n&quot;</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-274"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-274">&#182;</a></div><p>If we have no input at all, then there is nothing to report on
so just keep quiet.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$rpt_cleaners</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;NOTE: whitespace errors detected, you may wish to use scripts/cleanpatch or\n&quot;</span><span class="p">;</span>
			<span class="k">print</span> <span class="s">&quot;      scripts/cleanfile\n\n&quot;</span><span class="p">;</span>
			<span class="nv">$rpt_cleaners</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$quiet</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nb">keys</span> <span class="nv">%ignore_type</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">print</span> <span class="s">&quot;NOTE: Ignored message types:&quot;</span><span class="p">;</span>
	    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$ignore</span> <span class="p">(</span><span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%ignore_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">print</span> <span class="s">&quot; $ignore&quot;</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">print</span> <span class="s">&quot;\n\n&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$clean</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$quiet</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">print</span> <span class="s">&quot;$vname has no obvious style problems and is ready for submission.\n&quot;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$clean</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$quiet</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">print</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOM&quot;</span><span class="p">;</span>
<span class="nv">$vname</span> <span class="n">has</span> <span class="n">style</span> <span class="n">problems</span><span class="p">,</span> <span class="n">please</span> <span class="n">review</span><span class="o">.</span>

<span class="n">If</span> <span class="n">any</span> <span class="n">of</span> <span class="n">these</span> <span class="n">errors</span> <span class="n">are</span> <span class="n">false</span> <span class="n">positives</span><span class="p">,</span> <span class="n">please</span> <span class="n">report</span>
<span class="n">them</span> <span class="n">to</span> <span class="n">the</span> <span class="n">maintainer</span><span class="p">,</span> <span class="n">see</span> <span class="n">CHECKPATCH</span> <span class="n">in</span> <span class="n">MAINTAINERS</span><span class="o">.</span>
<span class="n">EOM</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nv">$clean</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>


<tr id="section-275"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-275">&#182;</a></div><p>In mailback mode only produce a report in the negative, for
things that appear to be patches.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-276"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-276">&#182;</a></div><p>This is not a patch, and we are are in 'no-patch' mode so
just keep quiet.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-277"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-277">&#182;</a></div><p>If there were whitespace errors which cleanpatch can fix
then suggest that.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
