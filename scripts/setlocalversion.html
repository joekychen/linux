<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › setlocalversion

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>setlocalversion</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>This scripts adds local version information from the version
control systems git, mercurial (hg) and subversion (svn).</p>

<p>If something goes wrong, send a mail the kernel build mailinglist
(see MAINTAINERS) and CC Nico Schottelius
<nico-linuxsetlocalversion -at- schottelius.org>.</p></td><td class="code"><div class="highlight"><pre>usage<span class="o">()</span> <span class="o">{</span>
	<span class="nb">echo</span> <span class="s2">&quot;Usage: $0 [--save-scmversion] [srctree]&quot;</span> &gt;&amp;2
	<span class="nb">exit </span>1
<span class="o">}</span>

<span class="nv">scm_only</span><span class="o">=</span><span class="nb">false</span>
<span class="nv">srctree</span><span class="o">=</span>.
<span class="k">if </span><span class="nb">test</span> <span class="s2">&quot;$1&quot;</span> <span class="o">=</span> <span class="s2">&quot;--save-scmversion&quot;</span>; <span class="k">then</span>
<span class="k">	</span><span class="nv">scm_only</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">	shift</span>
<span class="k">fi</span>
<span class="k">if </span><span class="nb">test</span> <span class="nv">$# </span>-gt 0; <span class="k">then</span>
<span class="k">	</span><span class="nv">srctree</span><span class="o">=</span><span class="nv">$1</span>
	<span class="nb">shift</span>
<span class="k">fi</span>
<span class="k">if </span><span class="nb">test</span> <span class="nv">$# </span>-gt 0 -o ! -d <span class="s2">&quot;$srctree&quot;</span>; <span class="k">then</span>
<span class="k">	</span>usage
<span class="k">fi</span>

scm_version<span class="o">()</span>
<span class="o">{</span>
	<span class="nb">local </span>short
	<span class="nv">short</span><span class="o">=</span><span class="nb">false</span>

<span class="nb">	cd</span> <span class="s2">&quot;$srctree&quot;</span>
	<span class="k">if </span><span class="nb">test</span> -e .scmversion; <span class="k">then</span>
<span class="k">		</span>cat .scmversion
		<span class="k">return</span>
<span class="k">	fi</span>
<span class="k">	if </span><span class="nb">test</span> <span class="s2">&quot;$1&quot;</span> <span class="o">=</span> <span class="s2">&quot;--short&quot;</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">short</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">	</span><span class="k">fi</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div></td><td class="code"><div class="highlight shebang"><pre><span>#!/bin/sh
</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Check for git and a git repo.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if </span><span class="nb">test</span> -d .git <span class="o">&amp;&amp;</span> <span class="nv">head</span><span class="o">=</span><span class="sb">`</span>git rev-parse --verify --short HEAD 2&gt;/dev/null<span class="sb">`</span>; <span class="k">then</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>If we are at a tagged commit (like "v2.6.30-rc6"), we ignore
it, because this version is defined in the top level Makefile.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;`git describe --exact-match 2&gt;/dev/null`&quot;</span> <span class="o">]</span>; <span class="k">then</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>If only the short version is requested, don't bother
running further git commands</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="nv">$short</span>; <span class="k">then</span>
<span class="k">				</span><span class="nb">echo</span> <span class="s2">&quot;+&quot;</span>
				<span class="k">return</span>
<span class="k">			fi</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>If we are past a tagged commit (like
"v2.6.30-rc5-302-g72357d5"), we pretty print it.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if </span><span class="nv">atag</span><span class="o">=</span><span class="s2">&quot;`git describe 2&gt;/dev/null`&quot;</span>; <span class="k">then</span>
<span class="k">				</span><span class="nb">echo</span> <span class="s2">&quot;$atag&quot;</span> | awk -F- <span class="s1">&#39;{printf(&quot;-%05d-%s&quot;, $(NF-1),$(NF))}&#39;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>If we don't have a tag at all we print -g{commitish}.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">else</span>
<span class="k">				</span><span class="nb">printf</span> <span class="s1">&#39;%s%s&#39;</span> -g <span class="nv">$head</span>
			<span class="k">fi</span>
<span class="k">		fi</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Is this git on svn?</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if </span>git config --get svn-remote.svn.url &gt;/dev/null; <span class="k">then</span>
<span class="k">			</span><span class="nb">printf</span> -- <span class="s1">&#39;-svn%s&#39;</span> <span class="s2">&quot;`git svn find-rev $head`&quot;</span>
		<span class="k">fi</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Update index only on r/w media</p></td><td class="code"><div class="highlight"><pre>		<span class="o">[</span> -w . <span class="o">]</span> <span class="o">&amp;&amp;</span> git update-index --refresh --unmerged &gt; /dev/null</pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Check for uncommitted changes</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if </span>git diff-index --name-only HEAD | grep -qv <span class="s2">&quot;^scripts/package&quot;</span>; <span class="k">then</span>
<span class="k">			</span><span class="nb">printf</span> <span class="s1">&#39;%s&#39;</span> -dirty
		<span class="k">fi</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>All done with git</p></td><td class="code"><div class="highlight"><pre>		<span class="k">return</span>
<span class="k">	fi</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Check for mercurial and a mercurial repo.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if </span><span class="nb">test</span> -d .hg <span class="o">&amp;&amp;</span> <span class="nv">hgid</span><span class="o">=</span><span class="sb">`</span>hg id 2&gt;/dev/null<span class="sb">`</span>; <span class="k">then</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Do we have an tagged version?  If so, latesttagdistance == 1</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;`hg log -r . --template &#39;{latesttagdistance}&#39;`&quot;</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">			</span><span class="nv">id</span><span class="o">=</span><span class="sb">`</span>hg log -r . --template <span class="s1">&#39;{latesttag}&#39;</span><span class="sb">`</span>
			<span class="nb">printf</span> <span class="s1">&#39;%s%s&#39;</span> -hg <span class="s2">&quot;$id&quot;</span>
		<span class="k">else</span>
<span class="k">			</span><span class="nv">tag</span><span class="o">=</span><span class="sb">`</span><span class="nb">printf</span> <span class="s1">&#39;%s&#39;</span> <span class="s2">&quot;$hgid&quot;</span> | cut -d<span class="s1">&#39; &#39;</span> -f2<span class="sb">`</span>
			<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$tag&quot;</span> -o <span class="s2">&quot;$tag&quot;</span> <span class="o">=</span> tip <span class="o">]</span>; <span class="k">then</span>
<span class="k">				</span><span class="nv">id</span><span class="o">=</span><span class="sb">`</span><span class="nb">printf</span> <span class="s1">&#39;%s&#39;</span> <span class="s2">&quot;$hgid&quot;</span> | sed <span class="s1">&#39;s/[+ ].*//&#39;</span><span class="sb">`</span>
				<span class="nb">printf</span> <span class="s1">&#39;%s%s&#39;</span> -hg <span class="s2">&quot;$id&quot;</span>
			<span class="k">fi</span>
<span class="k">		fi</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Are there uncommitted changes?
These are represented by + after the changeset id.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">case</span> <span class="s2">&quot;$hgid&quot;</span> in
			*+|*+<span class="se">\ </span>*<span class="o">)</span> <span class="nb">printf</span> <span class="s1">&#39;%s&#39;</span> -dirty ;;
		<span class="k">esac</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>All done with mercurial</p></td><td class="code"><div class="highlight"><pre>		<span class="k">return</span>
<span class="k">	fi</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Check for svn and a svn repo.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if </span><span class="nv">rev</span><span class="o">=</span><span class="sb">`</span>svn info 2&gt;/dev/null | grep <span class="s1">&#39;^Last Changed Rev&#39;</span><span class="sb">`</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">rev</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$rev</span> | awk <span class="s1">&#39;{print $NF}&#39;</span><span class="sb">`</span>
		<span class="nb">printf</span> -- <span class="s1">&#39;-svn%s&#39;</span> <span class="s2">&quot;$rev&quot;</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>All done with svn</p></td><td class="code"><div class="highlight"><pre>		<span class="k">return</span>
<span class="k">	fi</span>
<span class="o">}</span>

collect_files<span class="o">()</span>
<span class="o">{</span>
	<span class="nb">local </span>file res

	<span class="k">for </span>file; <span class="k">do</span>
<span class="k">		case</span> <span class="s2">&quot;$file&quot;</span> in
		*<span class="se">\~</span>*<span class="o">)</span>
			<span class="k">continue</span>
			;;
		<span class="k">esac</span>
<span class="k">		if </span><span class="nb">test</span> -e <span class="s2">&quot;$file&quot;</span>; <span class="k">then</span>
<span class="k">			</span><span class="nv">res</span><span class="o">=</span><span class="s2">&quot;$res$(cat &quot;</span><span class="nv">$file</span><span class="s2">&quot;)&quot;</span>
		<span class="k">fi</span>
<span class="k">	done</span>
<span class="k">	</span><span class="nb">echo</span> <span class="s2">&quot;$res&quot;</span>
<span class="o">}</span>

<span class="k">if</span> <span class="nv">$scm_only</span>; <span class="k">then</span>
<span class="k">	if </span><span class="nb">test</span> ! -e .scmversion; <span class="k">then</span>
<span class="k">		</span><span class="nv">res</span><span class="o">=</span><span class="k">$(</span>scm_version<span class="k">)</span>
		<span class="nb">echo</span> <span class="s2">&quot;$res&quot;</span> &gt;.scmversion
	<span class="k">fi</span>
<span class="k">	</span><span class="nb">exit</span>
<span class="k">fi</span>

<span class="k">if </span><span class="nb">test</span> -e include/config/auto.conf; <span class="k">then</span>
	. include/config/auto.conf
<span class="k">else</span>
<span class="k">	</span><span class="nb">echo</span> <span class="s2">&quot;Error: kernelrelease not valid - run &#39;make prepare&#39; to update it&quot;</span>
	<span class="nb">exit </span>1
<span class="k">fi</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>localversion* files in the build and source directory</p></td><td class="code"><div class="highlight"><pre><span class="nv">res</span><span class="o">=</span><span class="s2">&quot;$(collect_files localversion*)&quot;</span>
<span class="k">if </span><span class="nb">test</span> ! <span class="s2">&quot;$srctree&quot;</span> -ef .; <span class="k">then</span>
<span class="k">	</span><span class="nv">res</span><span class="o">=</span><span class="s2">&quot;$res$(collect_files &quot;</span><span class="nv">$srctree</span><span class="s2">&quot;/localversion*)&quot;</span>
<span class="k">fi</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>CONFIG_LOCALVERSION and LOCALVERSION (if set)</p></td><td class="code"><div class="highlight"><pre><span class="nv">res</span><span class="o">=</span><span class="s2">&quot;${res}${CONFIG_LOCALVERSION}${LOCALVERSION}&quot;</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>scm version string if not at a tagged commit</p></td><td class="code"><div class="highlight"><pre><span class="k">if </span><span class="nb">test</span> <span class="s2">&quot;$CONFIG_LOCALVERSION_AUTO&quot;</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span>; <span class="k">then</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>full scm version string</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">res</span><span class="o">=</span><span class="s2">&quot;$res$(scm_version)&quot;</span>
<span class="k">else</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>append a plus sign if the repository is not in a clean
annotated or signed tagged state (as git describe only
looks at signed or annotated tags - git tag -a/-s) and
LOCALVERSION= is not specified</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if </span><span class="nb">test</span> <span class="s2">&quot;${LOCALVERSION+set}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;set&quot;</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">scm</span><span class="o">=</span><span class="k">$(</span>scm_version --short<span class="k">)</span>
		<span class="nv">res</span><span class="o">=</span><span class="s2">&quot;$res${scm:++}&quot;</span>
	<span class="k">fi</span>
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">&quot;$res&quot;</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
