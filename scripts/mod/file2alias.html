<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › mod › file2alias.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>file2alias.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Simple code to turn various tables in an ELF file into alias definitions.</span>
<span class="cm"> * This deals with kernel datastructures where they should be</span>
<span class="cm"> * dealt with: in the kernel source.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2002-2003  Rusty Russell, IBM Corporation</span>
<span class="cm"> *           2003       Kai Germaschewski</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;modpost.h&quot;</span>

<span class="cm">/* We use the ELF typedefs for kernel_ulong_t but bite the bullet and</span>
<span class="cm"> * use either stdint.h or inttypes.h for the rest. */</span>
<span class="cp">#if KERNEL_ELFCLASS == ELFCLASS32</span>
<span class="k">typedef</span> <span class="n">Elf32_Addr</span>	<span class="n">kernel_ulong_t</span><span class="p">;</span>
<span class="cp">#define BITS_PER_LONG 32</span>
<span class="cp">#else</span>
<span class="k">typedef</span> <span class="n">Elf64_Addr</span>	<span class="n">kernel_ulong_t</span><span class="p">;</span>
<span class="cp">#define BITS_PER_LONG 64</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef __sun__</span>
<span class="cp">#include &lt;inttypes.h&gt;</span>
<span class="cp">#else</span>
<span class="cp">#include &lt;stdint.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;ctype.h&gt;</span>
<span class="cp">#include &lt;stdbool.h&gt;</span>

<span class="k">typedef</span> <span class="kt">uint32_t</span>	<span class="n">__u32</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">uint16_t</span>	<span class="n">__u16</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">__u8</span><span class="p">;</span>

<span class="cm">/* Big exception to the &quot;don&#39;t include kernel headers into userspace, which</span>
<span class="cm"> * even potentially has different endianness and word sizes, since</span>
<span class="cm"> * we handle those differences explicitly below */</span>
<span class="cp">#include &quot;../../include/linux/mod_devicetable.h&quot;</span>

<span class="cm">/* This array collects all instances that use the generic do_table */</span>
<span class="k">struct</span> <span class="n">devtable</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">device_id</span><span class="p">;</span> <span class="cm">/* name of table, __mod_&lt;name&gt;_device_table. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">id_size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">function</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define ___cat(a,b) a ## b</span>
<span class="cp">#define __cat(a,b) ___cat(a,b)</span>

<span class="cm">/* we need some special handling for this host tool running eventually on</span>
<span class="cm"> * Darwin. The Mach-O section handling is a bit different than ELF section</span>
<span class="cm"> * handling. The differnces in detail are:</span>
<span class="cm"> *  a) we have segments which have sections</span>
<span class="cm"> *  b) we need a API call to get the respective section symbols */</span>
<span class="cp">#if defined(__MACH__)</span>
<span class="cp">#include &lt;mach-o/getsect.h&gt;</span>

<span class="cp">#define INIT_SECTION(name)  do {					\</span>
<span class="cp">		unsigned long name ## _len;				\</span>
<span class="cp">		char *__cat(pstart_,name) = getsectdata(&quot;__TEXT&quot;,	\</span>
<span class="cp">			#name, &amp;__cat(name,_len));			\</span>
<span class="cp">		char *__cat(pstop_,name) = __cat(pstart_,name) +	\</span>
<span class="cp">			__cat(name, _len);				\</span>
<span class="cp">		__cat(__start_,name) = (void *)__cat(pstart_,name);	\</span>
<span class="cp">		__cat(__stop_,name) = (void *)__cat(pstop_,name);	\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define SECTION(name)   __attribute__((section(&quot;__TEXT, &quot; #name)))</span>

<span class="k">struct</span> <span class="n">devtable</span> <span class="o">**</span><span class="n">__start___devtable</span><span class="p">,</span> <span class="o">**</span><span class="n">__stop___devtable</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#define INIT_SECTION(name) </span><span class="cm">/* no-op for ELF */</span><span class="cp"></span>
<span class="cp">#define SECTION(name)   __attribute__((section(#name)))</span>

<span class="cm">/* We construct a table of pointers in an ELF section (pointers generally</span>
<span class="cm"> * go unpadded by gcc).  ld creates boundary syms for us. */</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">devtable</span> <span class="o">*</span><span class="n">__start___devtable</span><span class="p">[],</span> <span class="o">*</span><span class="n">__stop___devtable</span><span class="p">[];</span>
<span class="cp">#endif </span><span class="cm">/* __MACH__ */</span><span class="cp"></span>

<span class="cp">#if __GNUC__ == 3 &amp;&amp; __GNUC_MINOR__ &lt; 3</span>
<span class="cp"># define __used			__attribute__((__unused__))</span>
<span class="cp">#else</span>
<span class="cp"># define __used			__attribute__((__used__))</span>
<span class="cp">#endif</span>

<span class="cm">/* Add a table entry.  We test function type matches while we&#39;re here. */</span>
<span class="cp">#define ADD_TO_DEVTABLE(device_id, type, function) \</span>
<span class="cp">	static struct devtable __cat(devtable,__LINE__) = {	\</span>
<span class="cp">		device_id + 0*sizeof((function)((const char *)NULL,	\</span>
<span class="cp">						(type *)NULL,		\</span>
<span class="cp">						(char *)NULL)),		\</span>
<span class="cp">		sizeof(type), (function) };				\</span>
<span class="cp">	static struct devtable *SECTION(__devtable) __used \</span>
<span class="cp">		__cat(devtable_ptr,__LINE__) = &amp;__cat(devtable,__LINE__)</span>

<span class="cp">#define ADD(str, sep, cond, field)                              \</span>
<span class="cp">do {                                                            \</span>
<span class="cp">        strcat(str, sep);                                       \</span>
<span class="cp">        if (cond)                                               \</span>
<span class="cp">                sprintf(str + strlen(str),                      \</span>
<span class="cp">                        sizeof(field) == 1 ? &quot;%02X&quot; :           \</span>
<span class="cp">                        sizeof(field) == 2 ? &quot;%04X&quot; :           \</span>
<span class="cp">                        sizeof(field) == 4 ? &quot;%08X&quot; : &quot;&quot;,       \</span>
<span class="cp">                        field);                                 \</span>
<span class="cp">        else                                                    \</span>
<span class="cp">                sprintf(str + strlen(str), &quot;*&quot;);                \</span>
<span class="cp">} while(0)</span>

<span class="cm">/* Always end in a wildcard, for future extension */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">add_wildcard</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cross_build</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/**</span>
<span class="cm"> * Check that sizeof(device_id type) are consistent with size of section</span>
<span class="cm"> * in .o file. If in-consistent then userspace and kernel does not agree</span>
<span class="cm"> * on actual size which is a bug.</span>
<span class="cm"> * Also verify that the final entry in the table is all zeros.</span>
<span class="cm"> * Ignore both checks if build host differ from target host and size differs.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_id_check</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">modname</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">device_id</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">id_size</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">symval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="n">id_size</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">id_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cross_build</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">fatal</span><span class="p">(</span><span class="s">&quot;%s: sizeof(struct %s_device_id)=%lu is not a modulo &quot;</span>
		      <span class="s">&quot;of the size of section __mod_%s_device_table=%lu.</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;Fix definition of struct %s_device_id &quot;</span>
		      <span class="s">&quot;in mod_devicetable.h</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">modname</span><span class="p">,</span> <span class="n">device_id</span><span class="p">,</span> <span class="n">id_size</span><span class="p">,</span> <span class="n">device_id</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">device_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Verify last one is a terminator */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">id_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">symval</span><span class="o">+</span><span class="n">size</span><span class="o">-</span><span class="n">id_size</span><span class="o">+</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;%s: struct %s_device_id is %lu bytes.  &quot;</span>
				<span class="s">&quot;The last of %lu is:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">modname</span><span class="p">,</span> <span class="n">device_id</span><span class="p">,</span> <span class="n">id_size</span><span class="p">,</span> <span class="n">size</span> <span class="o">/</span> <span class="n">id_size</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">id_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;0x%02x &quot;</span><span class="p">,</span>
					<span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">symval</span><span class="o">+</span><span class="n">size</span><span class="o">-</span><span class="n">id_size</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="p">);</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fatal</span><span class="p">(</span><span class="s">&quot;%s: struct %s_device_id is not terminated &quot;</span>
				<span class="s">&quot;with a NULL entry!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">modname</span><span class="p">,</span> <span class="n">device_id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* USB is special because the bcdDevice can be matched against a numeric range */</span>
<span class="cm">/* Looks like &quot;usb:vNpNdNdcNdscNdpNicNiscNipN&quot; */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_usb_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bcdDevice_initial</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcdDevice_initial_digits</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">range_lo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">range_hi</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">max</span><span class="p">,</span> <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">alias</span><span class="p">[</span><span class="mi">500</span><span class="p">];</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;usb:&quot;</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="o">&amp;</span><span class="n">USB_DEVICE_ID_MATCH_VENDOR</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">idVendor</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;p&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="o">&amp;</span><span class="n">USB_DEVICE_ID_MATCH_PRODUCT</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">idProduct</span><span class="p">);</span>

	<span class="n">strcat</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcdDevice_initial_digits</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s">&quot;%0*X&quot;</span><span class="p">,</span>
			<span class="n">bcdDevice_initial_digits</span><span class="p">,</span> <span class="n">bcdDevice_initial</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">range_lo</span> <span class="o">==</span> <span class="n">range_hi</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s">&quot;%X&quot;</span><span class="p">,</span> <span class="n">range_lo</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">range_lo</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">range_hi</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">range_lo</span> <span class="o">&gt;</span> <span class="mh">0x9</span> <span class="o">||</span> <span class="n">range_hi</span> <span class="o">&lt;</span> <span class="mh">0xA</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span>
				<span class="s">&quot;[%X-%X]&quot;</span><span class="p">,</span>
				<span class="n">range_lo</span><span class="p">,</span>
				<span class="n">range_hi</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span>
				<span class="n">range_lo</span> <span class="o">&lt;</span> <span class="mh">0x9</span> <span class="o">?</span> <span class="s">&quot;[%X-9&quot;</span> <span class="o">:</span> <span class="s">&quot;[%X&quot;</span><span class="p">,</span>
				<span class="n">range_lo</span><span class="p">);</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span>
				<span class="n">range_hi</span> <span class="o">&gt;</span> <span class="mh">0xA</span> <span class="o">?</span> <span class="s">&quot;a-%X]&quot;</span> <span class="o">:</span> <span class="s">&quot;%X]&quot;</span><span class="p">,</span>
				<span class="n">range_lo</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcdDevice_initial_digits</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">bcdDevice_lo</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">);</span>

	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;dc&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="o">&amp;</span><span class="n">USB_DEVICE_ID_MATCH_DEV_CLASS</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">bDeviceClass</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;dsc&quot;</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="o">&amp;</span><span class="n">USB_DEVICE_ID_MATCH_DEV_SUBCLASS</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">bDeviceSubClass</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;dp&quot;</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="o">&amp;</span><span class="n">USB_DEVICE_ID_MATCH_DEV_PROTOCOL</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">bDeviceProtocol</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;ic&quot;</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="o">&amp;</span><span class="n">USB_DEVICE_ID_MATCH_INT_CLASS</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">bInterfaceClass</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;isc&quot;</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="o">&amp;</span><span class="n">USB_DEVICE_ID_MATCH_INT_SUBCLASS</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">bInterfaceSubClass</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;ip&quot;</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="o">&amp;</span><span class="n">USB_DEVICE_ID_MATCH_INT_PROTOCOL</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">bInterfaceProtocol</span><span class="p">);</span>

	<span class="n">add_wildcard</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
	<span class="n">buf_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">dev_table_buf</span><span class="p">,</span>
		   <span class="s">&quot;MODULE_ALIAS(</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">alias</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Handles increment/decrement of BCD formatted integers */</span>
<span class="cm">/* Returns the previous value, so it works like i++ or i-- */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">incbcd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bcd</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">inc</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">max</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">chars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">init</span> <span class="o">=</span> <span class="o">*</span><span class="n">bcd</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">c</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If bcd is not in BCD format, just increment */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&gt;</span> <span class="mh">0x9</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">bcd</span> <span class="o">+=</span> <span class="n">inc</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">init</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Convert BCD to Decimal */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chars</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">bcd</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">9</span> <span class="o">?</span> <span class="mi">9</span> <span class="o">:</span> <span class="n">c</span><span class="p">;</span> <span class="cm">/* force to bcd just in case */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">dec</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do our increment/decrement */</span>
	<span class="n">dec</span> <span class="o">+=</span> <span class="n">inc</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bcd</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Convert back to BCD */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chars</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">dec</span> <span class="o">/</span> <span class="n">c</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bcd</span> <span class="o">+=</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">init</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_usb_entry_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devlo</span><span class="p">,</span> <span class="n">devhi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">chi</span><span class="p">,</span> <span class="n">clo</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ndigits</span><span class="p">;</span>

	<span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">idVendor</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">idVendor</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">idProduct</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">idProduct</span><span class="p">);</span>

	<span class="n">devlo</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">USB_DEVICE_ID_MATCH_DEV_LO</span> <span class="o">?</span>
		<span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">bcdDevice_lo</span><span class="p">)</span> <span class="o">:</span> <span class="mh">0x0U</span><span class="p">;</span>
	<span class="n">devhi</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">USB_DEVICE_ID_MATCH_DEV_HI</span> <span class="o">?</span>
		<span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">bcdDevice_hi</span><span class="p">)</span> <span class="o">:</span> <span class="o">~</span><span class="mh">0x0U</span><span class="p">;</span>

	<span class="cm">/* Figure out if this entry is in bcd or hex format */</span>
	<span class="n">max</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">;</span> <span class="cm">/* Default to decimal format */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ndigits</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">ndigits</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">bcdDevice_lo</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">;</span> <span class="n">ndigits</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clo</span> <span class="o">=</span> <span class="p">(</span><span class="n">devlo</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">ndigits</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">chi</span> <span class="o">=</span> <span class="p">((</span><span class="n">devhi</span> <span class="o">&gt;</span> <span class="mh">0x9999</span> <span class="o">?</span> <span class="mh">0x9999</span> <span class="o">:</span> <span class="n">devhi</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">ndigits</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clo</span> <span class="o">&gt;</span> <span class="n">max</span> <span class="o">||</span> <span class="n">chi</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some modules (visor) have empty slots as placeholder for</span>
<span class="cm">	 * run-time specification that results in catch-all alias</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">idVendor</span> <span class="o">|</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">idProduct</span> <span class="o">|</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">bDeviceClass</span> <span class="o">|</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">bInterfaceClass</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Convert numeric bcdDevice range into fnmatch-able pattern(s) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ndigits</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">bcdDevice_lo</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">devlo</span> <span class="o">&lt;=</span> <span class="n">devhi</span><span class="p">;</span> <span class="n">ndigits</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clo</span> <span class="o">=</span> <span class="n">devlo</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">chi</span> <span class="o">=</span> <span class="n">devhi</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chi</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>	<span class="cm">/* If we are in bcd mode, truncate if necessary */</span>
			<span class="n">chi</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
		<span class="n">devlo</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">devhi</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devlo</span> <span class="o">==</span> <span class="n">devhi</span> <span class="o">||</span> <span class="o">!</span><span class="n">ndigits</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_usb_entry</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">devlo</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">,</span> <span class="n">clo</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clo</span> <span class="o">&gt;</span> <span class="mh">0x0</span><span class="p">)</span>
			<span class="n">do_usb_entry</span><span class="p">(</span><span class="n">id</span><span class="p">,</span>
				     <span class="n">incbcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devlo</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">bcdDevice_lo</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
				     <span class="n">ndigits</span><span class="p">,</span> <span class="n">clo</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chi</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">)</span>
			<span class="n">do_usb_entry</span><span class="p">(</span><span class="n">id</span><span class="p">,</span>
				     <span class="n">incbcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devhi</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">bcdDevice_lo</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
				     <span class="n">ndigits</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_usb_table</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">symval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">id_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device_id</span><span class="p">);</span>

	<span class="n">device_id_check</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;usb&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">id_size</span><span class="p">,</span> <span class="n">symval</span><span class="p">);</span>

	<span class="cm">/* Leave last one: it&#39;s the terminator. */</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">id_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">id_size</span><span class="p">)</span>
		<span class="n">do_usb_entry_multi</span><span class="p">(</span><span class="n">symval</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Looks like: hid:bNvNpN */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_hid_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">hid_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;hid:&quot;</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">!=</span> <span class="n">HID_BUS_ANY</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;g&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">!=</span> <span class="n">HID_GROUP_ANY</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">HID_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;p&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">!=</span> <span class="n">HID_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;hid&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_device_id</span><span class="p">,</span> <span class="n">do_hid_entry</span><span class="p">);</span>

<span class="cm">/* Looks like: ieee1394:venNmoNspNverN */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_ieee1394_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee1394_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">model_id</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">specifier_id</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">specifier_id</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;ieee1394:&quot;</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;ven&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">IEEE1394_MATCH_VENDOR_ID</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;mo&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">IEEE1394_MATCH_MODEL_ID</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">model_id</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;sp&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">IEEE1394_MATCH_SPECIFIER_ID</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">specifier_id</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;ver&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">IEEE1394_MATCH_VERSION</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

	<span class="n">add_wildcard</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;ieee1394&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee1394_device_id</span><span class="p">,</span> <span class="n">do_ieee1394_entry</span><span class="p">);</span>

<span class="cm">/* Looks like: pci:vNdNsvNsdNbcNscNiN. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_pci_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Class field can be divided into these three. */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">baseclass</span><span class="p">,</span> <span class="n">subclass</span><span class="p">,</span> <span class="n">interface</span><span class="p">,</span>
		<span class="n">baseclass_mask</span><span class="p">,</span> <span class="n">subclass_mask</span><span class="p">,</span> <span class="n">interface_mask</span><span class="p">;</span>

	<span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">subvendor</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">subvendor</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">subdevice</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">class_mask</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">class_mask</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;pci:&quot;</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;sv&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">subvendor</span> <span class="o">!=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">subvendor</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;sd&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">subdevice</span> <span class="o">!=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">subdevice</span><span class="p">);</span>

	<span class="n">baseclass</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">baseclass_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">class_mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">subclass</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">subclass_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">class_mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">interface</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">;</span>
	<span class="n">interface_mask</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">class_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">baseclass_mask</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">baseclass_mask</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">subclass_mask</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">subclass_mask</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">interface_mask</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">interface_mask</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">warn</span><span class="p">(</span><span class="s">&quot;Can&#39;t handle masks in %s:%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">filename</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">class_mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;bc&quot;</span><span class="p">,</span> <span class="n">baseclass_mask</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">baseclass</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;sc&quot;</span><span class="p">,</span> <span class="n">subclass_mask</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">subclass</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">interface_mask</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">interface</span><span class="p">);</span>
	<span class="n">add_wildcard</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;pci&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_device_id</span><span class="p">,</span> <span class="n">do_pci_entry</span><span class="p">);</span>

<span class="cm">/* looks like: &quot;ccw:tNmNdtNdmN&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_ccw_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ccw_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">cu_type</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">cu_type</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">cu_model</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">cu_model</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">dev_model</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;ccw:&quot;</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="o">&amp;</span><span class="n">CCW_DEVICE_ID_MATCH_CU_TYPE</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">cu_type</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;m&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="o">&amp;</span><span class="n">CCW_DEVICE_ID_MATCH_CU_MODEL</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">cu_model</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;dt&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="o">&amp;</span><span class="n">CCW_DEVICE_ID_MATCH_DEVICE_TYPE</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;dm&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="o">&amp;</span><span class="n">CCW_DEVICE_ID_MATCH_DEVICE_MODEL</span><span class="p">,</span>
	    <span class="n">id</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">);</span>
	<span class="n">add_wildcard</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;ccw&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ccw_device_id</span><span class="p">,</span> <span class="n">do_ccw_entry</span><span class="p">);</span>

<span class="cm">/* looks like: &quot;ap:tN&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_ap_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ap_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;ap:t%02X*&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;ap&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ap_device_id</span><span class="p">,</span> <span class="n">do_ap_entry</span><span class="p">);</span>

<span class="cm">/* looks like: &quot;css:tN&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_css_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">css_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;css:t%01X&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;css&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">css_device_id</span><span class="p">,</span> <span class="n">do_css_entry</span><span class="p">);</span>

<span class="cm">/* Looks like: &quot;serio:tyNprNidNexN&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_serio_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">serio_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;serio:&quot;</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;ty&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SERIO_ANY</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;pr&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">SERIO_ANY</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">SERIO_ANY</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;ex&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">!=</span> <span class="n">SERIO_ANY</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>

	<span class="n">add_wildcard</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;serio&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serio_device_id</span><span class="p">,</span> <span class="n">do_serio_entry</span><span class="p">);</span>

<span class="cm">/* looks like: &quot;acpi:ACPI0003 or acpi:PNP0C0B&quot; or &quot;acpi:LNXVIDEO&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_acpi_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">acpi_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;acpi*:%s:*&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;acpi&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">acpi_device_id</span><span class="p">,</span> <span class="n">do_acpi_entry</span><span class="p">);</span>

<span class="cm">/* looks like: &quot;pnp:dD&quot; */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_pnp_device_entry</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">symval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">id_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_device_id</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">id_size</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="o">*</span><span class="n">devs</span> <span class="o">=</span> <span class="n">symval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">device_id_check</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;pnp&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">id_size</span><span class="p">,</span> <span class="n">symval</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">acpi_id</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">id</span><span class="p">)];</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="n">buf_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">dev_table_buf</span><span class="p">,</span>
			   <span class="s">&quot;MODULE_ALIAS(</span><span class="se">\&quot;</span><span class="s">pnp:d%s*</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

		<span class="cm">/* fix broken pnp bus lowercasing */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acpi_id</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">acpi_id</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">buf_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">dev_table_buf</span><span class="p">,</span>
			   <span class="s">&quot;MODULE_ALIAS(</span><span class="se">\&quot;</span><span class="s">acpi*:%s:*</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acpi_id</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* looks like: &quot;pnp:dD&quot; for every device of the card */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_pnp_card_entries</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">symval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">id_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_card_device_id</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">id_size</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_card_device_id</span> <span class="o">*</span><span class="n">cards</span> <span class="o">=</span> <span class="n">symval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">device_id_check</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;pnp&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">id_size</span><span class="p">,</span> <span class="n">symval</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_card_device_id</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">PNP_MAX_DEVICES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i2</span><span class="p">,</span> <span class="n">j2</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">dup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* find duplicate, already added value */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i2</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dup</span><span class="p">;</span> <span class="n">i2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_card_device_id</span> <span class="o">*</span><span class="n">card2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cards</span><span class="p">[</span><span class="n">i2</span><span class="p">];</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">j2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j2</span> <span class="o">&lt;</span> <span class="n">PNP_MAX_DEVICES</span><span class="p">;</span> <span class="n">j2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">card2</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j2</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
						<span class="k">break</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">id2</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">dup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* add an individual alias for every device entry */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dup</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="n">acpi_id</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">id</span><span class="p">)];</span>
				<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

				<span class="n">buf_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">dev_table_buf</span><span class="p">,</span>
					   <span class="s">&quot;MODULE_ALIAS(</span><span class="se">\&quot;</span><span class="s">pnp:d%s*</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

				<span class="cm">/* fix broken pnp bus lowercasing */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acpi_id</span><span class="p">);</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
					<span class="n">acpi_id</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
				<span class="n">buf_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">dev_table_buf</span><span class="p">,</span>
					   <span class="s">&quot;MODULE_ALIAS(</span><span class="se">\&quot;</span><span class="s">acpi*:%s:*</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acpi_id</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Looks like: pcmcia:mNcNfNfnNpfnNvaNvbNvcNvdN. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_pcmcia_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">pcmcia_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">manf_id</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">card_id</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">card_id</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">func_id</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">func_id</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">device_no</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">device_no</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">prod_id_hash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">prod_id_hash</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
       <span class="p">}</span>

       <span class="n">strcpy</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;pcmcia:&quot;</span><span class="p">);</span>
       <span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;m&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_MANF_ID</span><span class="p">,</span>
	   <span class="n">id</span><span class="o">-&gt;</span><span class="n">manf_id</span><span class="p">);</span>
       <span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_CARD_ID</span><span class="p">,</span>
	   <span class="n">id</span><span class="o">-&gt;</span><span class="n">card_id</span><span class="p">);</span>
       <span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;f&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_FUNC_ID</span><span class="p">,</span>
	   <span class="n">id</span><span class="o">-&gt;</span><span class="n">func_id</span><span class="p">);</span>
       <span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;fn&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_FUNCTION</span><span class="p">,</span>
	   <span class="n">id</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
       <span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;pfn&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_DEVICE_NO</span><span class="p">,</span>
	   <span class="n">id</span><span class="o">-&gt;</span><span class="n">device_no</span><span class="p">);</span>
       <span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;pa&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_PROD_ID1</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">prod_id_hash</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
       <span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;pb&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_PROD_ID2</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">prod_id_hash</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
       <span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;pc&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_PROD_ID3</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">prod_id_hash</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
       <span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;pd&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_PROD_ID4</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">prod_id_hash</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">add_wildcard</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
       <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;pcmcia&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pcmcia_device_id</span><span class="p">,</span> <span class="n">do_pcmcia_entry</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_of_entry</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">of</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
    <span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;of:N%sT%s&quot;</span><span class="p">,</span>
                    <span class="n">of</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">of</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;*&quot;</span><span class="p">,</span>
                    <span class="n">of</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">of</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">:</span> <span class="s">&quot;*&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">of</span><span class="o">-&gt;</span><span class="n">compatible</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">sprintf</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">alias</span><span class="p">[</span><span class="n">len</span><span class="p">],</span> <span class="s">&quot;%sC%s&quot;</span><span class="p">,</span>
                     <span class="n">of</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="s">&quot;*&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                     <span class="n">of</span><span class="o">-&gt;</span><span class="n">compatible</span><span class="p">);</span>

    <span class="cm">/* Replace all whitespace with underscores */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">alias</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isspace</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="p">))</span>
            <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="sc">&#39;_&#39;</span><span class="p">;</span>

    <span class="n">add_wildcard</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;of&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">of_device_id</span><span class="p">,</span> <span class="n">do_of_entry</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_vio_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vio_device_id</span> <span class="o">*</span><span class="n">vio</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;vio:T%sS%s&quot;</span><span class="p">,</span> <span class="n">vio</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">vio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">:</span> <span class="s">&quot;*&quot;</span><span class="p">,</span>
			<span class="n">vio</span><span class="o">-&gt;</span><span class="n">compat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">vio</span><span class="o">-&gt;</span><span class="n">compat</span> <span class="o">:</span> <span class="s">&quot;*&quot;</span><span class="p">);</span>

	<span class="cm">/* Replace all whitespace with underscores */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">alias</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isspace</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="p">))</span>
			<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="sc">&#39;_&#39;</span><span class="p">;</span>

	<span class="n">add_wildcard</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;vio&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vio_device_id</span><span class="p">,</span> <span class="n">do_vio_entry</span><span class="p">);</span>

<span class="cp">#define ARRAY_SIZE(x) (sizeof(x) / sizeof((x)[0]))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_input</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">,</span>
		     <span class="n">kernel_ulong_t</span> <span class="o">*</span><span class="n">arr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="n">BITS_PER_LONG</span><span class="p">)))</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s">&quot;%X,*&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* input:b0v0p0e0-eXkXrXaXmXlXsXfXwX where X is comma-separated %02X. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_input_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">struct</span> <span class="n">input_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;input:&quot;</span><span class="p">);</span>

	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_BUS</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">bustype</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_VENDOR</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;p&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_PRODUCT</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_VERSION</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s">&quot;-e*&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_EVBIT</span><span class="p">)</span>
		<span class="n">do_input</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INPUT_DEVICE_ID_EV_MAX</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s">&quot;k*&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_KEYBIT</span><span class="p">)</span>
		<span class="n">do_input</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">,</span>
			 <span class="n">INPUT_DEVICE_ID_KEY_MIN_INTERESTING</span><span class="p">,</span>
			 <span class="n">INPUT_DEVICE_ID_KEY_MAX</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s">&quot;r*&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_RELBIT</span><span class="p">)</span>
		<span class="n">do_input</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INPUT_DEVICE_ID_REL_MAX</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s">&quot;a*&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_ABSBIT</span><span class="p">)</span>
		<span class="n">do_input</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INPUT_DEVICE_ID_ABS_MAX</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s">&quot;m*&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_MSCIT</span><span class="p">)</span>
		<span class="n">do_input</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">mscbit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INPUT_DEVICE_ID_MSC_MAX</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s">&quot;l*&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_LEDBIT</span><span class="p">)</span>
		<span class="n">do_input</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">ledbit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INPUT_DEVICE_ID_LED_MAX</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s">&quot;s*&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_SNDBIT</span><span class="p">)</span>
		<span class="n">do_input</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">sndbit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INPUT_DEVICE_ID_SND_MAX</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s">&quot;f*&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_FFBIT</span><span class="p">)</span>
		<span class="n">do_input</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INPUT_DEVICE_ID_FF_MAX</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s">&quot;w*&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_SWBIT</span><span class="p">)</span>
		<span class="n">do_input</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">swbit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INPUT_DEVICE_ID_SW_MAX</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">input_device_id</span><span class="p">,</span> <span class="n">do_input_entry</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_eisa_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eisa_device_id</span> <span class="o">*</span><span class="n">eisa</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eisa</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">EISA_DEVICE_MODALIAS_FMT</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">eisa</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;eisa&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eisa_device_id</span><span class="p">,</span> <span class="n">do_eisa_entry</span><span class="p">);</span>

<span class="cm">/* Looks like: parisc:tNhvNrevNsvN */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_parisc_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">struct</span> <span class="n">parisc_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">hw_type</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">hw_type</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">hversion</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">hversion</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">hversion_rev</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">hversion_rev</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">sversion</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">sversion</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;parisc:&quot;</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">hw_type</span> <span class="o">!=</span> <span class="n">PA_HWTYPE_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">hw_type</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;hv&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">hversion</span> <span class="o">!=</span> <span class="n">PA_HVERSION_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">hversion</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;rev&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">hversion_rev</span> <span class="o">!=</span> <span class="n">PA_HVERSION_REV_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">hversion_rev</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;sv&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">sversion</span> <span class="o">!=</span> <span class="n">PA_SVERSION_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">sversion</span><span class="p">);</span>

	<span class="n">add_wildcard</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;parisc&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">parisc_device_id</span><span class="p">,</span> <span class="n">do_parisc_entry</span><span class="p">);</span>

<span class="cm">/* Looks like: sdio:cNvNdN. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_sdio_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sdio_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;sdio:&quot;</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">!=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span><span class="n">SDIO_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span><span class="n">SDIO_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span><span class="n">SDIO_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">add_wildcard</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;sdio&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdio_device_id</span><span class="p">,</span> <span class="n">do_sdio_entry</span><span class="p">);</span>

<span class="cm">/* Looks like: ssb:vNidNrevN. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_ssb_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ssb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">coreid</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">coreid</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;ssb:&quot;</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">SSB_ANY_VENDOR</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">coreid</span> <span class="o">!=</span> <span class="n">SSB_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">coreid</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;rev&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="n">SSB_ANY_REV</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
	<span class="n">add_wildcard</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;ssb&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ssb_device_id</span><span class="p">,</span> <span class="n">do_ssb_entry</span><span class="p">);</span>

<span class="cm">/* Looks like: bcma:mNidNrevNclN. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_bcma_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">bcma_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">manuf</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">manuf</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;bcma:&quot;</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;m&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">manuf</span> <span class="o">!=</span> <span class="n">BCMA_ANY_MANUF</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">manuf</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">BCMA_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;rev&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="n">BCMA_ANY_REV</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;cl&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">!=</span> <span class="n">BCMA_ANY_CLASS</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">);</span>
	<span class="n">add_wildcard</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;bcma&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bcma_device_id</span><span class="p">,</span> <span class="n">do_bcma_entry</span><span class="p">);</span>

<span class="cm">/* Looks like: virtio:dNvN */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_virtio_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">struct</span> <span class="n">virtio_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;virtio:&quot;</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">VIRTIO_DEV_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">VIRTIO_DEV_ANY_ID</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>

	<span class="n">add_wildcard</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;virtio&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">virtio_device_id</span><span class="p">,</span> <span class="n">do_virtio_entry</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Looks like: vmbus:guid</span>
<span class="cm"> * Each byte of the guid will be represented by two hex characters</span>
<span class="cm"> * in the name.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_vmbus_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hv_vmbus_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">guid_name</span><span class="p">[((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">guid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">guid</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">guid_name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">guid</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;vmbus:&quot;</span><span class="p">);</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">guid_name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;vmbus&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hv_vmbus_device_id</span><span class="p">,</span> <span class="n">do_vmbus_entry</span><span class="p">);</span>

<span class="cm">/* Looks like: i2c:S */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_i2c_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">I2C_MODULE_PREFIX</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;i2c&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_device_id</span><span class="p">,</span> <span class="n">do_i2c_entry</span><span class="p">);</span>

<span class="cm">/* Looks like: spi:S */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_spi_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">SPI_MODULE_PREFIX</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;spi&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_device_id</span><span class="p">,</span> <span class="n">do_spi_entry</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmifield</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">dmi_fields</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;bvn&quot;</span><span class="p">,</span> <span class="n">DMI_BIOS_VENDOR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;bvr&quot;</span><span class="p">,</span> <span class="n">DMI_BIOS_VERSION</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;bd&quot;</span><span class="p">,</span>  <span class="n">DMI_BIOS_DATE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;svn&quot;</span><span class="p">,</span> <span class="n">DMI_SYS_VENDOR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;pn&quot;</span><span class="p">,</span>  <span class="n">DMI_PRODUCT_NAME</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;pvr&quot;</span><span class="p">,</span> <span class="n">DMI_PRODUCT_VERSION</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rvn&quot;</span><span class="p">,</span> <span class="n">DMI_BOARD_VENDOR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rn&quot;</span><span class="p">,</span>  <span class="n">DMI_BOARD_NAME</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rvr&quot;</span><span class="p">,</span> <span class="n">DMI_BOARD_VERSION</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;cvn&quot;</span><span class="p">,</span> <span class="n">DMI_CHASSIS_VENDOR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ct&quot;</span><span class="p">,</span>  <span class="n">DMI_CHASSIS_TYPE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;cvr&quot;</span><span class="p">,</span> <span class="n">DMI_CHASSIS_VERSION</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span>  <span class="n">DMI_NONE</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmi_ascii_filter</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Filter out characters we don&#39;t want to see in the modalias string */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> <span class="n">s</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">&gt;</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">s</span> <span class="o">&lt;</span> <span class="mi">127</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">s</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_dmi_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;dmi*&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dmi_fields</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">matches</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">slot</span> <span class="o">&amp;&amp;</span>
			    <span class="n">id</span><span class="o">-&gt;</span><span class="n">matches</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">slot</span> <span class="o">==</span> <span class="n">dmi_fields</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s">&quot;:%s*&quot;</span><span class="p">,</span>
					<span class="n">dmi_fields</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prefix</span><span class="p">);</span>
				<span class="n">dmi_ascii_filter</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span>
						 <span class="n">id</span><span class="o">-&gt;</span><span class="n">matches</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">substr</span><span class="p">);</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">strcat</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;dmi&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dmi_system_id</span><span class="p">,</span> <span class="n">do_dmi_entry</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_platform_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">PLATFORM_MODULE_PREFIX</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;platform&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">platform_device_id</span><span class="p">,</span> <span class="n">do_platform_entry</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_mdio_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">mdio_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">alias</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">MDIO_MODULE_PREFIX</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">phy_id_mask</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">31</span><span class="o">-</span><span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="o">*</span><span class="p">(</span><span class="n">alias</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;?&#39;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">31</span><span class="o">-</span><span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">alias</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;1&#39;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="p">(</span><span class="n">alias</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Terminate the string */</span>
	<span class="o">*</span><span class="n">alias</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;mdio&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mdio_device_id</span><span class="p">,</span> <span class="n">do_mdio_entry</span><span class="p">);</span>

<span class="cm">/* Looks like: zorro:iN. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_zorro_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zorro_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;zorro:&quot;</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">ZORRO_WILDCARD</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;zorro&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zorro_device_id</span><span class="p">,</span> <span class="n">do_zorro_entry</span><span class="p">);</span>

<span class="cm">/* looks like: &quot;pnp:dD&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_isapnp_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">isapnp_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;pnp:d%c%c%c%x%x%x%x*&quot;</span><span class="p">,</span>
		<span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="p">(((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span>
		<span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;isapnp&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isapnp_device_id</span><span class="p">,</span> <span class="n">do_isapnp_entry</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Append a match expression for a single masked hex digit.</span>
<span class="cm"> * outp points to a pointer to the character at which to append.</span>
<span class="cm"> *	*outp is updated on return to point just after the appended text,</span>
<span class="cm"> *	to facilitate further appending.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">append_nibble_mask</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">outp</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nibble</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">outp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;?&#39;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0xf</span>:
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%X&quot;</span><span class="p">,</span>  <span class="n">nibble</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * Dumbly emit a match pattern for all possible matching</span>
<span class="cm">		 * digits.  This could be improved in some cases using ranges,</span>
<span class="cm">		 * but it has the advantage of being trivially correct, and is</span>
<span class="cm">		 * often optimal.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;[&#39;</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">nibble</span><span class="p">)</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%X&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;]&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure that the string remains NUL-terminated: */</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="cm">/* Advance the caller&#39;s end-of-string pointer: */</span>
	<span class="o">*</span><span class="n">outp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * looks like: &quot;amba:dN&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * N is exactly 8 digits, where each is an upper-case hex digit, or</span>
<span class="cm"> *	a ? or [] pattern matching exactly one digit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_amba_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">amba_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">digit</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">alias</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
		<span class="n">fatal</span><span class="p">(</span><span class="s">&quot;%s: Masked-off bit(s) of AMBA device ID are non-zero: &quot;</span>
		      <span class="s">&quot;id=0x%08X, mask=0x%08X.  Please fix this driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">filename</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;amba:d&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">digit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">digit</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">digit</span><span class="o">++</span><span class="p">)</span>
		<span class="n">append_nibble_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="n">digit</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="n">digit</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;amba&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">amba_id</span><span class="p">,</span> <span class="n">do_amba_entry</span><span class="p">);</span>

<span class="cm">/* LOOKS like x86cpu:vendor:VVVV:family:FFFF:model:MMMM:feature:*,FEAT,*</span>
<span class="cm"> * All fields are numbers. It would be nicer to use strings for vendor</span>
<span class="cm"> * and feature, but getting those out of the build system here is too</span>
<span class="cm"> * complicated.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_x86cpu_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">struct</span> <span class="n">x86_cpu_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">feature</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">TO_NATIVE</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;x86cpu:&quot;</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;vendor:&quot;</span><span class="p">,</span>  <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">X86_VENDOR_ANY</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;:family:&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">!=</span> <span class="n">X86_FAMILY_ANY</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
	<span class="n">ADD</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;:model:&quot;</span><span class="p">,</span>  <span class="n">id</span><span class="o">-&gt;</span><span class="n">model</span>  <span class="o">!=</span> <span class="n">X86_MODEL_ANY</span><span class="p">,</span>  <span class="n">id</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">);</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&quot;:feature:*&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">!=</span> <span class="n">X86_FEATURE_ANY</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">alias</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s">&quot;%04X*&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">feature</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ADD_TO_DEVTABLE</span><span class="p">(</span><span class="s">&quot;x86cpu&quot;</span><span class="p">,</span> <span class="k">struct</span> <span class="n">x86_cpu_id</span><span class="p">,</span> <span class="n">do_x86cpu_entry</span><span class="p">);</span>

<span class="cm">/* Does namelen bytes of name exactly match the symbol? */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">sym_is</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">namelen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symbol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">namelen</span> <span class="o">!=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">namelen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_table</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">symval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">id_size</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">device_id</span><span class="p">,</span>
		     <span class="kt">void</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">alias</span><span class="p">[</span><span class="mi">500</span><span class="p">];</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">do_entry</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">)</span> <span class="o">=</span> <span class="n">function</span><span class="p">;</span>

	<span class="n">device_id_check</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">device_id</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">id_size</span><span class="p">,</span> <span class="n">symval</span><span class="p">);</span>
	<span class="cm">/* Leave last one: it&#39;s the terminator. */</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">id_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">id_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_entry</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">symval</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">alias</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">buf_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">dev_table_buf</span><span class="p">,</span>
				   <span class="s">&quot;MODULE_ALIAS(</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">alias</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Create MODULE_ALIAS() statements.</span>
<span class="cm"> * At this time, we cannot write the actual output C source yet,</span>
<span class="cm"> * so we write into the mod-&gt;dev_table_buf buffer. */</span>
<span class="kt">void</span> <span class="nf">handle_moddevtable</span><span class="p">(</span><span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">,</span> <span class="k">struct</span> <span class="n">elf_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="n">Elf_Sym</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">symval</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">zeros</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">namelen</span><span class="p">;</span>

	<span class="cm">/* We&#39;re looking for a section relative symbol */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_shndx</span> <span class="o">||</span> <span class="n">get_secindex</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">sym</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">num_sections</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We&#39;re looking for an object */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ELF_ST_TYPE</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_info</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STT_OBJECT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* All our symbols are of form &lt;prefix&gt;__mod_XXX_device_table. */</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">symname</span><span class="p">,</span> <span class="s">&quot;__mod_&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">name</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;__mod_&quot;</span><span class="p">);</span>
	<span class="n">namelen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">namelen</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;_device_table&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="n">namelen</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;_device_table&quot;</span><span class="p">),</span> <span class="s">&quot;_device_table&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">namelen</span> <span class="o">-=</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;_device_table&quot;</span><span class="p">);</span>

	<span class="cm">/* Handle all-NULL symbols allocated into .bss */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">get_secindex</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">sym</span><span class="p">)].</span><span class="n">sh_type</span> <span class="o">&amp;</span> <span class="n">SHT_NOBITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zeros</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">);</span>
		<span class="n">symval</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">symval</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span>
			<span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">get_secindex</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">sym</span><span class="p">)].</span><span class="n">sh_offset</span>
			<span class="o">+</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* First handle the &quot;special&quot; cases */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sym_is</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="s">&quot;usb&quot;</span><span class="p">))</span>
		<span class="n">do_usb_table</span><span class="p">(</span><span class="n">symval</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sym_is</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="s">&quot;pnp&quot;</span><span class="p">))</span>
		<span class="n">do_pnp_device_entry</span><span class="p">(</span><span class="n">symval</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sym_is</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="s">&quot;pnp_card&quot;</span><span class="p">))</span>
		<span class="n">do_pnp_card_entries</span><span class="p">(</span><span class="n">symval</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">devtable</span> <span class="o">**</span><span class="n">p</span><span class="p">;</span>
		<span class="n">INIT_SECTION</span><span class="p">(</span><span class="n">__devtable</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">__start___devtable</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">__stop___devtable</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sym_is</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">do_table</span><span class="p">(</span><span class="n">symval</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id_size</span><span class="p">,</span>
					 <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">free</span><span class="p">(</span><span class="n">zeros</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Now add out buffered information to the generated C source */</span>
<span class="kt">void</span> <span class="nf">add_moddevtable</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">buf_printf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">buf_write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">dev_table_buf</span><span class="p">.</span><span class="n">p</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">dev_table_buf</span><span class="p">.</span><span class="n">pos</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">dev_table_buf</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
