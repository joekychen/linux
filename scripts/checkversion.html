<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › checkversion.pl

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>checkversion.pl</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>! /usr/bin/perl</p>

<p>checkversion find uses of LINUX<em>VERSION</em>CODE or KERNEL_VERSION
without including <linux/version.h>, or cases of
including <linux/version.h> that don't need it.
Copyright (C) 2003, Randy Dunlap <a href="&#x6D;&#97;&#x69;&#x6C;&#x74;&#111;:&#x72;&#100;&#x75;&#110;&#x6C;&#97;&#112;&#64;&#120;en&#111;&#116;i&#109;&#x65;&#46;&#x6E;e&#116;">&#x72;&#100;&#x75;&#110;&#x6C;&#97;&#112;&#64;&#120;en&#111;&#116;i&#109;&#x65;&#46;&#x6E;e&#116;</a></p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">strict</span><span class="p">;</span>

<span class="vg">$|</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$debugging</span><span class="p">;</span>

<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$file</span> <span class="p">(</span><span class="nv">@ARGV</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">next</span> <span class="k">if</span> <span class="nv">$file</span> <span class="o">=~</span> <span class="s">&quot;include/linux/version\.h&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Open this file.</p></td><td class="code"><div class="highlight"><pre>    <span class="nb">open</span><span class="p">(</span> <span class="k">my</span> <span class="nv">$f</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="nv">$file</span> <span class="p">)</span>
      <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Can&#39;t open $file: $!\n&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Initialize variables.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">my</span> <span class="p">(</span><span class="nv">$fInComment</span><span class="p">,</span> <span class="nv">$fInString</span><span class="p">,</span> <span class="nv">$fUseVersion</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$iLinuxVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$f&gt;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Strip comments.</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$fInComment</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s</span><span class="o">+^.*</span><span class="p">?</span><span class="o">\*/+</span> <span class="o">+</span><span class="n">o</span> <span class="p">?</span> <span class="p">(</span><span class="nv">$fInComment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">:</span> <span class="k">next</span><span class="p">);</span>
	<span class="n">m</span><span class="o">+</span><span class="sr">/\*+o &amp;&amp; (s+/</span><span class="o">\*.*</span><span class="p">?</span><span class="o">\*</span><span class="sr">/+ +go, (s+/</span><span class="o">\*.*</span><span class="vg">$+</span> <span class="o">+</span><span class="n">o</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$fInComment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)));</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Pick up definitions.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span> <span class="sr">m/^\s*#/o</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$iLinuxVersion</span>      <span class="o">=</span> <span class="vg">$.</span> <span class="k">if</span> <span class="sr">m/^\s*#\s*include\s*&quot;linux\/version\.h&quot;/o</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Strip strings.</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$fInString</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s</span><span class="o">+^.*</span><span class="p">?</span><span class="s">&quot;+ +o ? ($fInString = 0) : next);</span>
<span class="s">	m+&quot;</span><span class="o">+</span><span class="n">o</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="s">&quot;.*?&quot;</span><span class="o">+</span> <span class="o">+</span><span class="n">go</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="s">&quot;.*$+ +o &amp;&amp; ($fInString = 1)));</span>


<span class="s">#DIVIDER</span>
<span class="s">	if ( m/^\s*#/o ) {</span>
<span class="s">	    $iLinuxVersion      = $. if m/^\s*#\s*include\s*&lt;linux\/version\.h&gt;/o;</span>
<span class="s">	}</span>


<span class="s">#DIVIDER</span>
<span class="s">	if (($_ =~ /LINUX_VERSION_CODE/) || ($_ =~ /\WKERNEL_VERSION/)) {</span>
<span class="s">	    $fUseVersion = 1;</span>
<span class="s">            last if $iLinuxVersion;</span>
<span class="s">        }</span>
<span class="s">    }</span>


<span class="s">#DIVIDER</span>
<span class="s">    if ($fUseVersion &amp;&amp; ! $iLinuxVersion) {</span>
<span class="s">	print &quot;</span><span class="nv">$file:</span> <span class="vg">$.</span><span class="p">:</span> <span class="n">need</span> <span class="n">linux</span><span class="o">/</span><span class="n">version</span><span class="o">.</span><span class="n">h</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">    }</span>


<span class="s">#DIVIDER</span>
<span class="s">    if ($iLinuxVersion &amp;&amp; ! $fUseVersion) {</span>
<span class="s">	print &quot;</span><span class="nv">$file:</span> <span class="nv">$iLinuxVersion</span> <span class="n">linux</span><span class="o">/</span><span class="n">version</span><span class="o">.</span><span class="n">h</span> <span class="ow">not</span> <span class="n">needed</span><span class="o">.\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">    }</span>


<span class="s">#DIVIDER</span>
<span class="s">    if ($debugging) {</span>
<span class="s">        if ($iLinuxVersion &amp;&amp; $fUseVersion) {</span>
<span class="s">	    print &quot;</span><span class="nv">$file:</span> <span class="n">version</span> <span class="k">use</span> <span class="n">is</span> <span class="n">OK</span> <span class="p">(</span><span class="nv">$iLinuxVersion</span><span class="p">)</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">        }</span>
<span class="s">        if (! $iLinuxVersion &amp;&amp; ! $fUseVersion) {</span>
<span class="s">	    print &quot;</span><span class="nv">$file:</span> <span class="n">version</span> <span class="k">use</span> <span class="n">is</span> <span class="n">OK</span> <span class="p">(</span><span class="n">none</span><span class="p">)</span><span class="o">\</span><span class="n">n</span><span class="err">&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nb">close</span><span class="p">(</span><span class="nv">$f</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Pick up definitions.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Look for uses: LINUX<em>VERSION</em>CODE, KERNEL<em>VERSION, UTS</em>RELEASE</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Report used version IDs without include?</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Report superfluous includes.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>debug: report OK results:</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
