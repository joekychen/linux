<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › checkkconfigsymbols.sh

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>checkkconfigsymbols.sh</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/sh</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Find Kconfig variables used in source code but never defined in Kconfig
Copyright (C) 2007, Paolo 'Blaisorblade' Giarrusso <a href="&#x6D;&#x61;&#105;&#x6C;&#x74;&#111;:&#98;&#108;&#x61;&#x69;&#x73;&#x6F;&#114;&#x62;&#108;&#x61;&#x64;&#101;&#64;&#x79;&#x61;&#104;&#x6F;&#x6F;&#x2E;&#105;&#x74;">&#98;&#108;&#x61;&#x69;&#x73;&#x6F;&#114;&#x62;&#108;&#x61;&#x64;&#101;&#64;&#x79;&#x61;&#104;&#x6F;&#x6F;&#x2E;&#105;&#x74;</a></p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Tested with dash.</p></td><td class="code"><div class="highlight"><pre><span class="nv">paths</span><span class="o">=</span><span class="s2">&quot;$@&quot;</span>
<span class="o">[</span> -z <span class="s2">&quot;$paths&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">paths</span><span class="o">=</span>.</pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Doing this once at the beginning saves a lot of time, on a cache-hot tree.</p></td><td class="code"><div class="highlight"><pre><span class="nv">Kconfigs</span><span class="o">=</span><span class="s2">&quot;`find . -name &#39;Kconfig&#39; -o -name &#39;Kconfig*[^~]&#39;`&quot;</span>

/bin/echo -e <span class="s2">&quot;File list \tundefined symbol used&quot;</span>
find <span class="nv">$paths</span> -name <span class="s1">&#39;*.[chS]&#39;</span> -o -name <span class="s1">&#39;Makefile&#39;</span> -o -name <span class="s1">&#39;Makefile*[^~]&#39;</span>| <span class="k">while </span><span class="nb">read </span>i
<span class="k">do</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Output the bare Kconfig variable and the filename; the _MODULE part at
the end is not removed here (would need perl an not-hungry regexp for that).</p></td><td class="code"><div class="highlight"><pre>	sed -ne <span class="s1">&#39;s!^.*\&lt;\(UML_\)\?CONFIG_\([0-9A-Za-z_]\+\).*!\2 &#39;</span><span class="nv">$i</span><span class="s1">&#39;!p&#39;</span> &lt; <span class="nv">$i</span>
<span class="k">done</span> | <span class="se">\</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Smart "sort|uniq" implemented in awk and tuned to collect the names of all
files which use a given symbol</p></td><td class="code"><div class="highlight"><pre>awk <span class="s1">&#39;{map[$1, count[$1]++] = $2; }</span>
<span class="s1">END {</span>
<span class="s1">	for (combIdx in map) {</span>
<span class="s1">		split(combIdx, separate, SUBSEP);</span>

<span class="s1">#DIVIDER</span>
<span class="s1">		if (! ( (separate[1], separate[2]) in map ) )</span>
<span class="s1">			continue;</span>
<span class="s1">		symb=separate[1];</span>
<span class="s1">		printf &quot;%s &quot;, symb;</span>

<span class="s1">#DIVIDER</span>
<span class="s1">		delete names;</span>

<span class="s1">#DIVIDER</span>
<span class="s1">		for (i=0; i &lt; count[symb]; i++) {</span>
<span class="s1">			names[map[symb, i]] = 1;</span>

<span class="s1">#DIVIDER</span>
<span class="s1">			delete map[symb, i];</span>
<span class="s1">		}</span>
<span class="s1">		i=0;</span>
<span class="s1">		for (name in names) {</span>
<span class="s1">			if (i &gt; 0)</span>
<span class="s1">				printf &quot;, %s&quot;, name;</span>
<span class="s1">			else</span>
<span class="s1">				printf &quot;%s&quot;, name;</span>
<span class="s1">			i++;</span>
<span class="s1">		}</span>
<span class="s1">		printf &quot;\n&quot;;</span>
<span class="s1">	}</span>
<span class="s1">}&#39;</span> |
<span class="k">while </span><span class="nb">read </span>symb files; <span class="k">do</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>The value may have been removed.</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">symb_bare</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$symb</span> | sed -e <span class="s1">&#39;s/_MODULE//&#39;</span><span class="sb">`</span>
	<span class="k">if</span> ! grep -q <span class="s2">&quot;\&lt;$symb_bare\&gt;&quot;</span> <span class="nv">$Kconfigs</span>; <span class="k">then</span>
		/bin/echo -e <span class="s2">&quot;$files: \t$symb&quot;</span>
	<span class="k">fi</span>
<span class="k">done</span>|sort

</pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Use gawk extension to delete the names vector</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Portably delete the names vector
split("", names);</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Unfortunately, we may still encounter symb, i in the
outside iteration.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Remove the _MODULE suffix when checking the variable name. This should
be done only on tristate symbols, actually, but Kconfig parsing is
beyond the purpose of this script.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
