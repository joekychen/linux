<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › selinux › install_policy.sh

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>install_policy.sh</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/sh</span>
<span class="k">if</span> <span class="o">[</span> <span class="sb">`</span>id -u<span class="sb">`</span> -ne 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span><span class="nb">echo</span> <span class="s2">&quot;$0: must be root to install the selinux policy&quot;</span>
	<span class="nb">exit </span>1
<span class="k">fi</span>
<span class="nv">SF</span><span class="o">=</span><span class="sb">`</span>which setfiles<span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq 1 <span class="o">]</span>; <span class="k">then</span>
<span class="k">	if</span> <span class="o">[</span> -f /sbin/setfiles <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">SF</span><span class="o">=</span><span class="s2">&quot;/usr/setfiles&quot;</span>
	<span class="k">else</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;no selinux tools installed: setfiles&quot;</span>
		<span class="nb">exit </span>1
	<span class="k">fi</span>
<span class="k">fi</span>

<span class="nb">cd </span>mdp

<span class="nv">CP</span><span class="o">=</span><span class="sb">`</span>which checkpolicy<span class="sb">`</span>
<span class="nv">VERS</span><span class="o">=</span><span class="sb">`</span><span class="nv">$CP</span> -V | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>

./mdp policy.conf file_contexts
<span class="nv">$CP</span> -o policy.<span class="nv">$VERS</span> policy.conf

mkdir -p /etc/selinux/dummy/policy
mkdir -p /etc/selinux/dummy/contexts/files

cp file_contexts /etc/selinux/dummy/contexts/files
cp dbus_contexts /etc/selinux/dummy/contexts
cp policy.<span class="nv">$VERS</span> /etc/selinux/dummy/policy
<span class="nv">FC_FILE</span><span class="o">=</span>/etc/selinux/dummy/contexts/files/file_contexts

<span class="k">if</span> <span class="o">[</span> ! -d /etc/selinux <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>mkdir -p /etc/selinux
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> ! -f /etc/selinux/config <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>cat &gt; /etc/selinux/config <span class="s">&lt;&lt; EOF</span>
<span class="s">SELINUX=enforcing</span>
<span class="s">SELINUXTYPE=dummy</span>
<span class="s">EOF</span>
<span class="k">else</span>
<span class="k">	</span><span class="nv">TYPE</span><span class="o">=</span><span class="sb">`</span>cat /etc/selinux/config | grep <span class="s2">&quot;^SELINUXTYPE&quot;</span> | tail -1 | awk -F<span class="o">=</span> <span class="s1">&#39;{ print $2 &#39;</span><span class="o">}</span><span class="sb">`</span>
	<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;eq$TYPE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;eqdummy&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span>selinuxenabled
		<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">			</span><span class="nb">echo</span> <span class="s2">&quot;SELinux already enabled with a non-dummy policy.&quot;</span>
			<span class="nb">echo</span> <span class="s2">&quot;Exiting.  Please install policy by hand if that&quot;</span>
			<span class="nb">echo</span> <span class="s2">&quot;is what you REALLY want.&quot;</span>
			<span class="nb">exit </span>1
		<span class="k">fi</span>
<span class="k">		</span>mv /etc/selinux/config /etc/selinux/config.mdpbak
		grep -v <span class="s2">&quot;^SELINUXTYPE&quot;</span> /etc/selinux/config.mdpbak &gt;&gt; /etc/selinux/config
		<span class="nb">echo</span> <span class="s2">&quot;SELINUXTYPE=dummy&quot;</span> &gt;&gt; /etc/selinux/config
	<span class="k">fi</span>
<span class="k">fi</span>

<span class="nb">cd</span> /etc/selinux/dummy/contexts/files
<span class="nv">$SF</span> file_contexts /

<span class="nv">mounts</span><span class="o">=</span><span class="sb">`</span>cat /proc/<span class="nv">$$</span>/mounts | egrep <span class="s2">&quot;ext2|ext3|xfs|jfs|ext4|ext4dev|gfs2&quot;</span> | awk <span class="s1">&#39;{ print $2 &#39;</span><span class="o">}</span><span class="sb">`</span>
<span class="nv">$SF</span> file_contexts <span class="nv">$mounts</span>


<span class="nv">dodev</span><span class="o">=</span><span class="sb">`</span>cat /proc/<span class="nv">$$</span>/mounts | grep <span class="s2">&quot;/dev &quot;</span><span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;eq$dodev&quot;</span> !<span class="o">=</span> <span class="s2">&quot;eq&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>mount --move /dev /mnt
	<span class="nv">$SF</span> file_contexts /dev
	mount --move /mnt /dev
<span class="k">fi</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
