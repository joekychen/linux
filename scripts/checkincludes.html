<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › checkincludes.pl

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>checkincludes.pl</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c1">#!/usr/bin/perl</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>checkincludes: find/remove files included more than once</p>

<p>Copyright abandoned, 2000, Niels Kristian Bech Jensen <a href="&#x6D;a&#x69;&#108;&#x74;&#x6F;:&#110;&#107;&#98;&#106;&#64;im&#97;&#x67;&#101;&#46;&#100;&#x6B;">&#110;&#107;&#98;&#106;&#64;im&#97;&#x67;&#101;&#46;&#100;&#x6B;</a>.
Copyright 2009 Luis R. Rodriguez <a href="&#x6D;&#x61;&#105;&#x6C;&#116;&#111;:&#x6D;c&#x67;&#x72;&#111;&#102;&#x40;&#103;&#x6D;&#x61;&#105;&#x6C;&#46;&#99;&#111;m">&#x6D;c&#x67;&#x72;&#111;&#102;&#x40;&#103;&#x6D;&#x61;&#105;&#x6C;&#46;&#99;&#111;m</a></p>

<p>This script checks for duplicate includes. It also has support
to remove them in place. Note that this will not take into
consideration macros so you should run this only if you know
you do have real dups and do not have them under #ifdef's. You
could also just review the results.</p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">strict</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">usage</span> <span class="p">{</span>
	<span class="k">print</span> <span class="s">&quot;Usage: checkincludes.pl [-r]\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;By default we just warn of duplicates\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;To remove duplicated includes in place use -r\n&quot;</span><span class="p">;</span>
	<span class="nb">exit</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$remove</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$#ARGV</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">usage</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$#ARGV</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /^-/</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">eq</span> <span class="s">&quot;-r&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$remove</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="nb">shift</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">usage</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$file</span> <span class="p">(</span><span class="nv">@ARGV</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">open</span><span class="p">(</span><span class="k">my</span> <span class="nv">$f</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="nv">$file</span><span class="p">)</span>
	    <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cannot open $file: $!.\n&quot;</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">%includedfiles</span> <span class="o">=</span> <span class="p">();</span>
	<span class="k">my</span> <span class="nv">@file_lines</span> <span class="o">=</span> <span class="p">();</span>

	<span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$f&gt;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="sr">m/^\s*#\s*include\s*[&lt;&quot;](\S*)[&gt;&quot;]/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="nv">$includedfiles</span><span class="p">{</span><span class="nv">$1</span><span class="p">};</span>
		<span class="p">}</span>
		<span class="nb">push</span><span class="p">(</span><span class="nv">@file_lines</span><span class="p">,</span> <span class="nv">$_</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="nb">close</span><span class="p">(</span><span class="nv">$f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$remove</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$filename</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%includedfiles</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$includedfiles</span><span class="p">{</span><span class="nv">$filename</span><span class="p">}</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">print</span> <span class="s">&quot;$file: $filename is included more than once.\n&quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nb">open</span><span class="p">(</span><span class="nv">$f</span><span class="p">,</span> <span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="nv">$file</span><span class="p">)</span>
	    <span class="ow">or</span> <span class="nb">die</span><span class="p">(</span><span class="s">&quot;Cannot write to $file: $!&quot;</span><span class="p">);</span>

	<span class="k">my</span> <span class="nv">$dups</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="p">(</span><span class="nv">@file_lines</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="sr">m/^\s*#\s*include\s*[&lt;&quot;](\S*)[&gt;&quot;]/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$filename</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%includedfiles</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$1</span> <span class="ow">eq</span> <span class="nv">$filename</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$includedfiles</span><span class="p">{</span><span class="nv">$filename</span><span class="p">}</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="nv">$includedfiles</span><span class="p">{</span><span class="nv">$filename</span><span class="p">}</span><span class="o">--</span><span class="p">;</span>
						<span class="nv">$dups</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">print</span> <span class="p">{</span><span class="nv">$f</span><span class="p">}</span> <span class="nv">$_</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">print</span> <span class="p">{</span><span class="nv">$f</span><span class="p">}</span> <span class="nv">$_</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$dups</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">print</span> <span class="s">&quot;$file: removed $dups duplicate includes\n&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nb">close</span><span class="p">(</span><span class="nv">$f</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
