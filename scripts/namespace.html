<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › namespace.pl

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>namespace.pl</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c1">#!/usr/bin/perl -w</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>namespace.pl.  Mon Aug 30 2004</p>

<p>Perform a name space analysis on the linux kernel.</p>

<p>Copyright Keith Owens <a href="&#x6D;&#x61;&#x69;&#x6C;&#116;&#111;:&#107;&#x61;&#111;s&#x40;&#x6F;&#99;&#x73;&#46;&#99;o&#x6D;.&#97;&#x75;">&#107;&#x61;&#111;s&#x40;&#x6F;&#99;&#x73;&#46;&#99;o&#x6D;.&#97;&#x75;</a>.  GPL.</p>

<p>Invoke by changing directory to the top of the kernel object
tree then namespace.pl, no parameters.</p>

<p>Tuned for 2.1.x kernels with the new module handling, it will
work with 2.0 kernels as well.</p>

<p>Last change 2.6.9-rc1, adding support for separate source and object
trees.</p>

<p>The source must be compiled/assembled first, the object files
are the primary input to this script.  Incomplete or missing
objects will result in a flawed analysis.  Compile both vmlinux
and modules.</p>

<p>Even with complete objects, treat the result of the analysis
with caution.  Some external references are only used by
certain architectures, others with certain combinations of
configuration parameters.  Ideally the source should include
something like</p>

<h1>ifndef CONFIG_...</h1>

<p>static</p>

<h1>endif</h1>

<p>symbol_definition;</p>

<p>so the symbols are defined as static unless a particular
CONFIG_... requires it to be external.</p>

<p>A symbol that is suffixed with '(export only)' has these properties</p>

<ul>
<li>It is global.</li>
<li>It is marked EXPORT<em>SYMBOL or EXPORT</em>SYMBOL_GPL, either in the same
source file or a different source file.</li>
<li>Given the current .config, nothing uses the symbol.</li>
</ul>

<p>The symbol is a candidate for conversion to static, plus removal of the
export.  But be careful that a different .config might use the symbol.</p>

<p>Name space analysis and cleanup is an iterative process.  You cannot
expect to find all the problems in a single pass.</p>

<ul>
<li>Identify possibly unnecessary global declarations, verify that they
really are unnecessary and change them to static.</li>
<li>Compile and fix up gcc warnings about static, removing dead symbols
as necessary.</li>
<li>make clean and rebuild with different configs (especially
CONFIG_MODULES=n) to see which symbols are being defined when the
config does not require them.  These symbols bloat the kernel object
for no good reason, which is frustrating for embedded systems.</li>
<li>Wrap config sensitive symbols in #ifdef CONFIG_foo, as long as the
code does not get too ugly.</li>
<li>Repeat the name space analysis until you can live with with the
result.</li>
</ul></td><td class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="mi">5</span><span class="p">;</span>	<span class="c1"># at least perl 5</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Find</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$nm</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$ENV</span><span class="p">{</span><span class="s">&#39;NM&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="s">&quot;nm&quot;</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot; -p&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$objdump</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$ENV</span><span class="p">{</span><span class="s">&#39;OBJDUMP&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="s">&quot;objdump&quot;</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot; -s -j .comment&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$srctree</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$objtree</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="nv">$srctree</span> <span class="o">=</span> <span class="s">&quot;$ENV{&#39;srctree&#39;}/&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nb">exists</span><span class="p">(</span><span class="nv">$ENV</span><span class="p">{</span><span class="s">&#39;srctree&#39;</span><span class="p">}));</span>
<span class="nv">$objtree</span> <span class="o">=</span> <span class="s">&quot;$ENV{&#39;objtree&#39;}/&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nb">exists</span><span class="p">(</span><span class="nv">$ENV</span><span class="p">{</span><span class="s">&#39;objtree&#39;</span><span class="p">}));</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$#ARGV</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;usage: $0 takes no parameters\n&quot;</span><span class="p">;</span>
	<span class="nb">die</span><span class="p">(</span><span class="s">&quot;giving up\n&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">%nmdata</span> <span class="o">=</span> <span class="p">();</span>	<span class="c1"># nm data for each object</span>
<span class="k">my</span> <span class="nv">%def</span> <span class="o">=</span> <span class="p">();</span>		<span class="c1"># all definitions for each name</span>
<span class="k">my</span> <span class="nv">%ksymtab</span> <span class="o">=</span> <span class="p">();</span>	<span class="c1"># names that appear in __ksymtab_</span>
<span class="k">my</span> <span class="nv">%ref</span> <span class="o">=</span> <span class="p">();</span>		<span class="c1"># $ref{$name} exists if there is a true external reference to $name</span>
<span class="k">my</span> <span class="nv">%export</span> <span class="o">=</span> <span class="p">();</span>	<span class="c1"># $export{$name} exists if there is an EXPORT_... of $name</span>

<span class="k">my</span> <span class="nv">%nmexception</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;fs/ext3/bitmap&#39;</span>			<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;fs/ext4/bitmap&#39;</span>			<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;arch/x86/lib/thunk_32&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;arch/x86/lib/cmpxchg&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;arch/x86/vdso/vdso32/note&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;lib/irq_regs&#39;</span>			<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;usr/initramfs_data&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;drivers/scsi/aic94xx/aic94xx_dump&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;drivers/scsi/libsas/sas_dump&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;lib/dec_and_lock&#39;</span>			<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;drivers/ide/ide-probe-mini&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;usr/initramfs_data&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;drivers/acpi/acpia/exdump&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;drivers/acpi/acpia/rsdump&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;drivers/acpi/acpia/nsdumpdv&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;drivers/acpi/acpia/nsdump&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;arch/ia64/sn/kernel/sn2/io&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;arch/ia64/kernel/gate-data&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;security/capability&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;fs/ntfs/sysctl&#39;</span>			<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;fs/jfs/jfs_debug&#39;</span>			<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">);</span>

<span class="k">my</span> <span class="nv">%nameexception</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;mod_use_count_&#39;</span>	 <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;__initramfs_end&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;__initramfs_start&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;_einittext&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;_sinittext&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;kallsyms_names&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;kallsyms_num_syms&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;kallsyms_addresses&#39;</span><span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;__this_module&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;_etext&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;_edata&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;_end&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;__bss_start&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;_text&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;_stext&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;__gp&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;ia64_unw_start&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;ia64_unw_end&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;__init_begin&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;__init_end&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;__bss_stop&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;__nosave_begin&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;__nosave_end&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;pg0&#39;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;vdso_enabled&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;__stack_chk_fail&#39;</span>  <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;VDSO32_PRELINK&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;VDSO32_vsyscall&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;VDSO32_rt_sigreturn&#39;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;VDSO32_sigreturn&#39;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">);</span>


<span class="o">&amp;</span><span class="n">find</span><span class="p">(</span><span class="o">\&amp;</span><span class="n">linux_objects</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">);</span>	<span class="c1"># find the objects and do_nm on them</span>
<span class="o">&amp;</span><span class="n">list_multiply_defined</span><span class="p">();</span>
<span class="o">&amp;</span><span class="n">resolve_external_references</span><span class="p">();</span>
<span class="o">&amp;</span><span class="n">list_extra_externals</span><span class="p">();</span>

<span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="k">sub </span><span class="nf">linux_objects</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Select objects, ignoring objects which are only created by
merging other objects.  Also ignore all of modules, scripts
and compressed.  Most conglomerate objects are handled by do_nm,
this list only contains the special cases.  These include objects
that are linked from just one other object and objects for which
there is really no permanent source file.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="nv">$basename</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
	<span class="nv">$_</span> <span class="o">=</span> <span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">name</span><span class="p">;</span>
	<span class="n">s:</span><span class="o">^\./::</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="sr">/.*\.o$/</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span> <span class="p">(</span>
		<span class="n">m:</span><span class="o">/</span><span class="n">built</span><span class="o">-</span><span class="n">in</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:arch</span><span class="sr">/x86/</span><span class="n">vdso</span><span class="o">/</span><span class="p">:</span>
		<span class="o">||</span> <span class="n">m:arch</span><span class="sr">/x86/</span><span class="n">boot</span><span class="o">/</span><span class="p">:</span>
		<span class="o">||</span> <span class="n">m:arch</span><span class="sr">/ia64/i</span><span class="n">a32</span><span class="o">/</span><span class="n">ia32</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:arch</span><span class="sr">/ia64/</span><span class="n">kernel</span><span class="o">/</span><span class="n">gate</span><span class="o">-</span><span class="n">syms</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:arch</span><span class="sr">/ia64/</span><span class="n">lib</span><span class="o">/</span><span class="n">__divdi3</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:arch</span><span class="sr">/ia64/</span><span class="n">lib</span><span class="o">/</span><span class="n">__divsi3</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:arch</span><span class="sr">/ia64/</span><span class="n">lib</span><span class="o">/</span><span class="n">__moddi3</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:arch</span><span class="sr">/ia64/</span><span class="n">lib</span><span class="o">/</span><span class="n">__modsi3</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:arch</span><span class="sr">/ia64/</span><span class="n">lib</span><span class="o">/</span><span class="n">__udivdi3</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:arch</span><span class="sr">/ia64/</span><span class="n">lib</span><span class="o">/</span><span class="n">__udivsi3</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:arch</span><span class="sr">/ia64/</span><span class="n">lib</span><span class="o">/</span><span class="n">__umoddi3</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:arch</span><span class="sr">/ia64/</span><span class="n">lib</span><span class="o">/</span><span class="n">__umodsi3</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:arch</span><span class="sr">/ia64/sc</span><span class="n">ripts</span><span class="o">/</span><span class="n">check_gas_for_hint</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:arch</span><span class="sr">/ia64/s</span><span class="n">n</span><span class="sr">/kernel/x</span><span class="n">p</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:boot</span><span class="o">/</span><span class="n">bbootsect</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:boot</span><span class="o">/</span><span class="n">bsetup</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:</span><span class="o">/</span><span class="n">bootsect</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:</span><span class="sr">/boot/s</span><span class="n">etup</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:</span><span class="sr">/compressed/</span><span class="p">:</span>
		<span class="o">||</span> <span class="n">m:drivers</span><span class="sr">/cdrom/</span><span class="n">driver</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:drivers</span><span class="sr">/char/</span><span class="n">drm</span><span class="o">/</span><span class="n">tdfx_drv</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:drivers</span><span class="sr">/ide/i</span><span class="n">de</span><span class="o">-</span><span class="n">detect</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:drivers</span><span class="sr">/ide/</span><span class="n">pci</span><span class="o">/</span><span class="n">idedriver</span><span class="o">-</span><span class="n">pci</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:drivers</span><span class="sr">/media/m</span><span class="n">edia</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:drivers</span><span class="sr">/scsi/s</span><span class="n">d_mod</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:drivers</span><span class="sr">/video/</span><span class="n">video</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:fs</span><span class="sr">/devpts/</span><span class="n">devpts</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:fs</span><span class="sr">/exportfs/</span><span class="n">exportfs</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:fs</span><span class="sr">/hugetlbfs/</span><span class="n">hugetlbfs</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:fs</span><span class="sr">/msdos/ms</span><span class="n">dos</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:fs</span><span class="sr">/nls/</span><span class="n">nls</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:fs</span><span class="sr">/ramfs/</span><span class="n">ramfs</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:fs</span><span class="sr">/romfs/</span><span class="n">romfs</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:fs</span><span class="sr">/vfat/</span><span class="n">vfat</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:init</span><span class="o">/</span><span class="n">mounts</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:</span><span class="o">^</span><span class="n">modules</span><span class="o">/</span><span class="p">:</span>
		<span class="o">||</span> <span class="n">m:net</span><span class="sr">/netlink/</span><span class="n">netlink</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:net</span><span class="sr">/sched/sc</span><span class="n">hed</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:</span><span class="o">/</span><span class="n">piggy</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:</span><span class="o">^</span><span class="n">scripts</span><span class="o">/</span><span class="p">:</span>
		<span class="o">||</span> <span class="n">m:sound</span><span class="sr">/.*/s</span><span class="n">nd</span><span class="o">-</span><span class="p">:</span>
		<span class="o">||</span> <span class="n">m:</span><span class="o">^.*/\.</span><span class="n">tmp_:</span>
		<span class="o">||</span> <span class="n">m:</span><span class="o">^\.</span><span class="n">tmp_:</span>
		<span class="o">||</span> <span class="n">m:</span><span class="o">/</span><span class="n">vmlinux</span><span class="o">-</span><span class="n">obj</span><span class="o">.</span><span class="n">o</span><span class="nv">$:</span>
		<span class="o">||</span> <span class="n">m:</span><span class="o">^</span><span class="n">tools</span><span class="o">/</span><span class="p">:</span>
		<span class="p">)</span>
	<span class="p">)</span> <span class="p">{</span>
		<span class="n">do_nm</span><span class="p">(</span><span class="nv">$basename</span><span class="p">,</span> <span class="nv">$_</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="nv">$_</span> <span class="o">=</span> <span class="nv">$basename</span><span class="p">;</span>		<span class="c1"># File::Find expects $_ untouched (undocumented)</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">do_nm</span>
<span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$basename</span><span class="p">,</span> <span class="nv">$fullname</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nv">$type</span><span class="p">,</span> <span class="nv">$name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">-</span><span class="n">e</span> <span class="nv">$basename</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">printf</span> <span class="bp">STDERR</span> <span class="s">&quot;$basename does not exist\n&quot;</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$fullname</span> <span class="o">!~</span> <span class="sr">/\.o$/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">printf</span> <span class="bp">STDERR</span> <span class="s">&quot;$fullname is not an object file\n&quot;</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="nv">$source</span> <span class="o">=</span> <span class="nv">$basename</span><span class="p">)</span> <span class="o">=~</span> <span class="sr">s/\.o$//</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">e</span> <span class="s">&quot;$source.c&quot;</span> <span class="o">||</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;$source.S&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$source</span> <span class="o">=</span> <span class="s">&quot;$objtree$File::Find::dir/$source&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nv">$source</span> <span class="o">=</span> <span class="s">&quot;$srctree$File::Find::dir/$source&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;$source.c&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;$source.S&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>No obvious source, exclude the object if it is conglomerate</p></td><td class="code"><div class="highlight"><pre>	        <span class="nb">open</span><span class="p">(</span><span class="k">my</span> <span class="nv">$objdumpdata</span><span class="p">,</span> <span class="s">&quot;$objdump $basename|&quot;</span><span class="p">)</span>
		    <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;$objdump $fullname failed $!\n&quot;</span><span class="p">;</span>

		<span class="k">my</span> <span class="nv">$comment</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$objdumpdata&gt;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nb">chomp</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="sr">/^In archive/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Archives are always conglomerate</p></td><td class="code"><div class="highlight"><pre>				<span class="nv">$comment</span> <span class="o">=</span> <span class="s">&quot;GCC:GCC:&quot;</span><span class="p">;</span>
				<span class="k">last</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="sr">/^[ 0-9a-f]{5,} /</span><span class="p">);</span>
			<span class="nv">$comment</span> <span class="o">.=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$_</span><span class="p">,</span> <span class="mi">43</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="nb">close</span><span class="p">(</span><span class="nv">$objdumpdata</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$comment</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$comment</span> <span class="o">!~</span> <span class="sr">/GCC\:.*GCC\:/m</span><span class="p">)</span> <span class="p">{</span>
			<span class="nb">printf</span> <span class="bp">STDERR</span> <span class="s">&quot;No source file found for $fullname\n&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nb">open</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$nmdata</span><span class="p">,</span> <span class="s">&quot;$nm $basename|&quot;</span><span class="p">)</span>
	    <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;$nm $fullname failed $!\n&quot;</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">@nmdata</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$nmdata&gt;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">chop</span><span class="p">;</span>
		<span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nb">split</span><span class="p">(</span><span class="sr">/ +/</span><span class="p">,</span> <span class="nv">$_</span><span class="p">,</span> <span class="mi">3</span><span class="p">))[</span><span class="mi">1</span><span class="o">..</span><span class="mi">2</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Expected types
A absolute symbol
B weak external reference to data that has been resolved
C global variable, uninitialised
D global variable, initialised
G global variable, initialised, small data section
R global array, initialised
S global variable, uninitialised, small bss
T global label/procedure
U external reference
W weak external reference to text that has been resolved
V similar to W, but the value of the weak symbol becomes zero with no error.
a assembler equate
b static variable, uninitialised
d static variable, initialised
g static variable, initialised, small data section
r static array, initialised
s static variable, uninitialised, small bss
t static label/procedures
w weak external reference to text that has not been resolved
v similar to w
? undefined type, used a lot by modules</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="o">!~</span> <span class="sr">/^[ABCDGRSTUWVabdgrstwv?]$/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nb">printf</span> <span class="bp">STDERR</span> <span class="s">&quot;nm output for $fullname contains unknown type &#39;$_&#39;\n&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">elsif</span> <span class="p">(</span><span class="nv">$name</span> <span class="o">=~</span><span class="sr"> /\./</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>name with '.' is local static</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;R&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;?&#39;</span><span class="p">);</span>	<span class="c1"># binutils replaced ? with R at one point</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>binutils keeps changing the type for exported symbols, force it to R</p></td><td class="code"><div class="highlight"><pre>			<span class="nv">$type</span> <span class="o">=</span> <span class="s">&#39;R&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="o">=~</span><span class="sr"> /^__ksymtab/</span> <span class="o">||</span> <span class="nv">$name</span> <span class="o">=~</span><span class="sr"> /^__kstrtab/</span><span class="p">);</span>
			<span class="nv">$name</span> <span class="o">=~</span> <span class="sr">s/_R[a-f0-9]{8}$//</span><span class="p">;</span>	<span class="c1"># module versions adds this</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="o">=~</span><span class="sr"> /[ABCDGRSTWV]/</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="ow">ne</span> <span class="s">&#39;init_module&#39;</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="ow">ne</span> <span class="s">&#39;cleanup_module&#39;</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="ow">ne</span> <span class="s">&#39;Using_Versions&#39;</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^Version_[0-9]+$/</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__parm_/</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__kstrtab/</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__ksymtab/</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__kcrctab_/</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__exitcall_/</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__initcall_/</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__kdb_initcall_/</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__kdb_exitcall_/</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__module_/</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__mod_/</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__crc_/</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="ow">ne</span> <span class="s">&#39;__this_module&#39;</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$name</span> <span class="ow">ne</span> <span class="s">&#39;kernel_version&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">exists</span><span class="p">(</span><span class="nv">$def</span><span class="p">{</span><span class="nv">$name</span><span class="p">}))</span> <span class="p">{</span>
					<span class="nv">$def</span><span class="p">{</span><span class="nv">$name</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="nb">push</span><span class="p">(</span><span class="nv">@</span><span class="p">{</span><span class="nv">$def</span><span class="p">{</span><span class="nv">$name</span><span class="p">}},</span> <span class="nv">$fullname</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="nb">push</span><span class="p">(</span><span class="nv">@nmdata</span><span class="p">,</span> <span class="s">&quot;$type $name&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="o">=~</span><span class="sr"> /^__ksymtab_/</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$name</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">exists</span><span class="p">(</span><span class="nv">$ksymtab</span><span class="p">{</span><span class="nv">$name</span><span class="p">}))</span> <span class="p">{</span>
					<span class="nv">$ksymtab</span><span class="p">{</span><span class="nv">$name</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="nb">push</span><span class="p">(</span><span class="nv">@</span><span class="p">{</span><span class="nv">$ksymtab</span><span class="p">{</span><span class="nv">$name</span><span class="p">}},</span> <span class="nv">$fullname</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nb">close</span><span class="p">(</span><span class="nv">$nmdata</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$#nmdata</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nb">printf</span> <span class="s">&quot;No nm data for $fullname\n&quot;</span>
		<span class="k">unless</span> <span class="nv">$nmexception</span><span class="p">{</span><span class="nv">$fullname</span><span class="p">};</span>
	    <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nv">$nmdata</span><span class="p">{</span><span class="nv">$fullname</span><span class="p">}</span> <span class="o">=</span> <span class="o">\</span><span class="nv">@nmdata</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">drop_def</span>
<span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$object</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$nmdata</span> <span class="o">=</span> <span class="nv">$nmdata</span><span class="p">{</span><span class="nv">$object</span><span class="p">};</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$i</span><span class="p">,</span> <span class="nv">$j</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="nv">$#</span><span class="p">{</span><span class="nv">$nmdata</span><span class="p">};</span> <span class="o">++</span><span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="ow">eq</span> <span class="p">(</span><span class="nb">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="nv">$nmdata</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">],</span> <span class="mi">2</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="nb">splice</span><span class="p">(</span><span class="nv">@</span><span class="p">{</span><span class="nv">$nmdata</span><span class="p">{</span><span class="nv">$object</span><span class="p">}},</span> <span class="nv">$i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">my</span> <span class="nv">$def</span> <span class="o">=</span> <span class="nv">$def</span><span class="p">{</span><span class="nv">$name</span><span class="p">};</span>
			<span class="k">for</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$j</span> <span class="o">&lt;</span> <span class="nv">$#</span><span class="p">{</span><span class="nv">$def</span><span class="p">{</span><span class="nv">$name</span><span class="p">}};</span> <span class="o">++</span><span class="nv">$j</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$def</span><span class="p">{</span><span class="nv">$name</span><span class="p">}[</span><span class="nv">$j</span><span class="p">]</span> <span class="ow">eq</span> <span class="nv">$object</span><span class="p">)</span> <span class="p">{</span>
					<span class="nb">splice</span><span class="p">(</span><span class="nv">@</span><span class="p">{</span><span class="nv">$def</span><span class="p">{</span><span class="nv">$name</span><span class="p">}},</span> <span class="nv">$j</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">last</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">list_multiply_defined</span>
<span class="p">{</span>
	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$name</span> <span class="p">(</span><span class="nb">keys</span><span class="p">(</span><span class="nv">%def</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$#</span><span class="p">{</span><span class="nv">$def</span><span class="p">{</span><span class="nv">$name</span><span class="p">}}</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Special case for cond_syscall</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$#</span><span class="p">{</span><span class="nv">$def</span><span class="p">{</span><span class="nv">$name</span><span class="p">}}</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="nv">$name</span> <span class="o">=~</span><span class="sr"> /^sys_/</span> <span class="o">||</span> <span class="nv">$name</span> <span class="o">=~</span><span class="sr"> /^compat_sys_/</span> <span class="o">||</span>
			    <span class="nv">$name</span> <span class="o">=~</span><span class="sr"> /^sys32_/</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="nv">$def</span><span class="p">{</span><span class="nv">$name</span><span class="p">}[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">eq</span> <span class="s">&quot;kernel/sys_ni.o&quot;</span> <span class="o">||</span>
				   <span class="nv">$def</span><span class="p">{</span><span class="nv">$name</span><span class="p">}[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">eq</span> <span class="s">&quot;kernel/sys_ni.o&quot;</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">drop_def</span><span class="p">(</span><span class="s">&quot;kernel/sys_ni.o&quot;</span><span class="p">,</span> <span class="nv">$name</span><span class="p">);</span>
					<span class="k">next</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="nb">printf</span> <span class="s">&quot;$name is multiply defined in :-\n&quot;</span><span class="p">;</span>
			<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$module</span> <span class="p">(</span><span class="nv">@</span><span class="p">{</span><span class="nv">$def</span><span class="p">{</span><span class="nv">$name</span><span class="p">}})</span> <span class="p">{</span>
				<span class="nb">printf</span> <span class="s">&quot;\t$module\n&quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">resolve_external_references</span>
<span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$kstrtab</span><span class="p">,</span> <span class="nv">$ksymtab</span><span class="p">,</span> <span class="nv">$export</span><span class="p">);</span>

	<span class="nb">printf</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$object</span> <span class="p">(</span><span class="nb">keys</span><span class="p">(</span><span class="nv">%nmdata</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$nmdata</span> <span class="o">=</span> <span class="nv">$nmdata</span><span class="p">{</span><span class="nv">$object</span><span class="p">};</span>
		<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="nv">$#</span><span class="p">{</span><span class="nv">$nmdata</span><span class="p">};</span> <span class="o">++</span><span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="nv">$nmdata</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&quot;U&quot;</span> <span class="o">||</span> <span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nb">exists</span><span class="p">(</span><span class="nv">$def</span><span class="p">{</span><span class="nv">$name</span><span class="p">})</span> <span class="o">||</span> <span class="nb">exists</span><span class="p">(</span><span class="nv">$ksymtab</span><span class="p">{</span><span class="nv">$name</span><span class="p">}))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>add the owning object to the nmdata</p></td><td class="code"><div class="highlight"><pre>					<span class="nv">$nmdata</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;$type $name $object&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>only count as a reference if it is not EXPORT_...</p></td><td class="code"><div class="highlight"><pre>					<span class="nv">$kstrtab</span> <span class="o">=</span> <span class="s">&quot;R __kstrtab_$name&quot;</span><span class="p">;</span>
					<span class="nv">$ksymtab</span> <span class="o">=</span> <span class="s">&quot;R __ksymtab_$name&quot;</span><span class="p">;</span>
					<span class="nv">$export</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$j</span> <span class="o">&lt;=</span> <span class="nv">$#</span><span class="p">{</span><span class="nv">$nmdata</span><span class="p">};</span> <span class="o">++</span><span class="nv">$j</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="nv">$nmdata</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$j</span><span class="p">]</span> <span class="ow">eq</span> <span class="nv">$kstrtab</span> <span class="o">||</span>
						    <span class="nv">$nmdata</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$j</span><span class="p">]</span> <span class="ow">eq</span> <span class="nv">$ksymtab</span><span class="p">)</span> <span class="p">{</span>
							<span class="nv">$export</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="k">last</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$export</span><span class="p">)</span> <span class="p">{</span>
						<span class="nv">$export</span><span class="p">{</span><span class="nv">$name</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="nv">$ref</span><span class="p">{</span><span class="nv">$name</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">elsif</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$nameexception</span><span class="p">{</span><span class="nv">$name</span><span class="p">}</span>
					<span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__sched_text_/</span>
					<span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__start_/</span>
					<span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__end_/</span>
					<span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__stop_/</span>
					<span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__scheduling_functions_.*_here/</span>
					<span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__.*initcall_/</span>
					<span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__.*per_cpu_start/</span>
					<span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__.*per_cpu_end/</span>
					<span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__alt_instructions/</span>
					<span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__setup_/</span>
					<span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__mod_timer/</span>
					<span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^__mod_page_state/</span>
					<span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^init_module/</span>
					<span class="o">&amp;&amp;</span> <span class="nv">$name</span> <span class="o">!~</span> <span class="sr">/^cleanup_module/</span>
				<span class="p">)</span> <span class="p">{</span>
					<span class="nb">printf</span> <span class="s">&quot;Cannot resolve &quot;</span><span class="p">;</span>
					<span class="nb">printf</span> <span class="s">&quot;weak &quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&quot;w&quot;</span><span class="p">);</span>
					<span class="nb">printf</span> <span class="s">&quot;reference to $name from $object\n&quot;</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">list_extra_externals</span>
<span class="p">{</span>
	<span class="k">my</span> <span class="nv">%noref</span> <span class="o">=</span> <span class="p">();</span>

	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$name</span> <span class="p">(</span><span class="nb">keys</span><span class="p">(</span><span class="nv">%def</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">exists</span><span class="p">(</span><span class="nv">$ref</span><span class="p">{</span><span class="nv">$name</span><span class="p">}))</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">@module</span> <span class="o">=</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$def</span><span class="p">{</span><span class="nv">$name</span><span class="p">}};</span>
			<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$module</span> <span class="p">(</span><span class="nv">@module</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">exists</span><span class="p">(</span><span class="nv">$noref</span><span class="p">{</span><span class="nv">$module</span><span class="p">}))</span> <span class="p">{</span>
					<span class="nv">$noref</span><span class="p">{</span><span class="nv">$module</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="nb">push</span><span class="p">(</span><span class="nv">@</span><span class="p">{</span><span class="nv">$noref</span><span class="p">{</span><span class="nv">$module</span><span class="p">}},</span> <span class="nv">$name</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">%noref</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">printf</span> <span class="s">&quot;\nExternally defined symbols with no external references\n&quot;</span><span class="p">;</span>
		<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$module</span> <span class="p">(</span><span class="nb">sort</span><span class="p">(</span><span class="nb">keys</span><span class="p">(</span><span class="nv">%noref</span><span class="p">)))</span> <span class="p">{</span>
			<span class="nb">printf</span> <span class="s">&quot;  $module\n&quot;</span><span class="p">;</span>
			<span class="k">foreach</span> <span class="p">(</span><span class="nb">sort</span><span class="p">(</span><span class="nv">@</span><span class="p">{</span><span class="nv">$noref</span><span class="p">{</span><span class="nv">$module</span><span class="p">}}))</span> <span class="p">{</span>
			    <span class="k">my</span> <span class="nv">$export</span><span class="p">;</span>
			    <span class="k">if</span> <span class="p">(</span><span class="nb">exists</span><span class="p">(</span><span class="nv">$export</span><span class="p">{</span><span class="nv">$_</span><span class="p">}))</span> <span class="p">{</span>
				<span class="nv">$export</span> <span class="o">=</span> <span class="s">&quot; (export only)&quot;</span><span class="p">;</span>
			    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nv">$export</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
			    <span class="p">}</span>
			    <span class="nb">printf</span> <span class="s">&quot;    $_$export\n&quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
