<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › kconfig › menu.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>menu.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2002 Roman Zippel &lt;zippel@linux-m68k.org&gt;</span>
<span class="cm"> * Released under the terms of the GNU GPL v2.0.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;ctype.h&gt;</span>
<span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>

<span class="cp">#include &quot;lkc.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">nohelp_text</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;There is no help available for this option.&quot;</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">menu</span> <span class="n">rootmenu</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">**</span><span class="n">last_entry_ptr</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file_list</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">current_file</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">menu_warn</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s:%d:warning: &quot;</span><span class="p">,</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">lineno</span><span class="p">);</span>
	<span class="n">vfprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prop_warn</span><span class="p">(</span><span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="n">prop</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s:%d:warning: &quot;</span><span class="p">,</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">lineno</span><span class="p">);</span>
	<span class="n">vfprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">_menu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">current_entry</span> <span class="o">=</span> <span class="n">current_menu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rootmenu</span><span class="p">;</span>
	<span class="n">last_entry_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rootmenu</span><span class="p">.</span><span class="n">list</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">menu_add_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">;</span>

	<span class="n">menu</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">menu</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">menu</span><span class="p">));</span>
	<span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">=</span> <span class="n">sym</span><span class="p">;</span>
	<span class="n">menu</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">current_menu</span><span class="p">;</span>
	<span class="n">menu</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">current_file</span><span class="p">;</span>
	<span class="n">menu</span><span class="o">-&gt;</span><span class="n">lineno</span> <span class="o">=</span> <span class="n">zconf_lineno</span><span class="p">();</span>

	<span class="o">*</span><span class="n">last_entry_ptr</span> <span class="o">=</span> <span class="n">menu</span><span class="p">;</span>
	<span class="n">last_entry_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">current_entry</span> <span class="o">=</span> <span class="n">menu</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="p">)</span>
		<span class="n">menu_add_symbol</span><span class="p">(</span><span class="n">P_SYMBOL</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">menu_end_entry</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="nf">menu_add_menu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">menu_end_entry</span><span class="p">();</span>
	<span class="n">last_entry_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">current_menu</span> <span class="o">=</span> <span class="n">current_entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">menu_end_menu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">last_entry_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current_menu</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">current_menu</span> <span class="o">=</span> <span class="n">current_menu</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">expr</span> <span class="o">*</span><span class="nf">menu_check_dep</span><span class="p">(</span><span class="k">struct</span> <span class="n">expr</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">e</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">E_NOT</span>:
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">menu_check_dep</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">.</span><span class="n">expr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">E_OR</span>:
	<span class="k">case</span> <span class="n">E_AND</span>:
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">menu_check_dep</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">.</span><span class="n">expr</span><span class="p">);</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">menu_check_dep</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">.</span><span class="n">expr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">E_SYMBOL</span>:
		<span class="cm">/* change &#39;m&#39; into &#39;m&#39; &amp;&amp; MODULES */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">.</span><span class="n">sym</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">symbol_mod</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">expr_alloc_and</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">expr_alloc_symbol</span><span class="p">(</span><span class="n">modules_sym</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">menu_add_dep</span><span class="p">(</span><span class="k">struct</span> <span class="n">expr</span> <span class="o">*</span><span class="n">dep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">current_entry</span><span class="o">-&gt;</span><span class="n">dep</span> <span class="o">=</span> <span class="n">expr_alloc_and</span><span class="p">(</span><span class="n">current_entry</span><span class="o">-&gt;</span><span class="n">dep</span><span class="p">,</span> <span class="n">menu_check_dep</span><span class="p">(</span><span class="n">dep</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">menu_set_type</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span> <span class="o">=</span> <span class="n">current_entry</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">menu_warn</span><span class="p">(</span><span class="n">current_entry</span><span class="p">,</span> <span class="s">&quot;type of &#39;%s&#39; redefined from &#39;%s&#39; to &#39;%s&#39;&quot;</span><span class="p">,</span>
	    <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">?</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;&lt;choice&gt;&quot;</span><span class="p">,</span>
	    <span class="n">sym_type_name</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">),</span> <span class="n">sym_type_name</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="nf">menu_add_prop</span><span class="p">(</span><span class="k">enum</span> <span class="n">prop_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">expr</span> <span class="o">*</span><span class="n">expr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">expr</span> <span class="o">*</span><span class="n">dep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop_alloc</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">current_entry</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">);</span>

	<span class="n">prop</span><span class="o">-&gt;</span><span class="n">menu</span> <span class="o">=</span> <span class="n">current_entry</span><span class="p">;</span>
	<span class="n">prop</span><span class="o">-&gt;</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="p">;</span>
	<span class="n">prop</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">menu_check_dep</span><span class="p">(</span><span class="n">dep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">prompt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prop_warn</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;leading whitespace ignored&quot;</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">prompt</span><span class="p">))</span>
				<span class="n">prompt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_entry</span><span class="o">-&gt;</span><span class="n">prompt</span> <span class="o">&amp;&amp;</span> <span class="n">current_entry</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">rootmenu</span><span class="p">)</span>
			<span class="n">prop_warn</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;prompt redefined&quot;</span><span class="p">);</span>

		<span class="cm">/* Apply all upper menus&#39; visibilities to actual prompts. */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">P_PROMPT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span> <span class="o">=</span> <span class="n">current_entry</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">((</span><span class="n">menu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">visibility</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">prop</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">expr</span>
					<span class="o">=</span> <span class="n">expr_alloc_and</span><span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">expr</span><span class="p">,</span>
							 <span class="n">menu</span><span class="o">-&gt;</span><span class="n">visibility</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">current_entry</span><span class="o">-&gt;</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">prop</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">prop</span><span class="o">-&gt;</span><span class="n">text</span> <span class="o">=</span> <span class="n">prompt</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">prop</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="nf">menu_add_prompt</span><span class="p">(</span><span class="k">enum</span> <span class="n">prop_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">expr</span> <span class="o">*</span><span class="n">dep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">menu_add_prop</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dep</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">menu_add_visibility</span><span class="p">(</span><span class="k">struct</span> <span class="n">expr</span> <span class="o">*</span><span class="n">expr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">current_entry</span><span class="o">-&gt;</span><span class="n">visibility</span> <span class="o">=</span> <span class="n">expr_alloc_and</span><span class="p">(</span><span class="n">current_entry</span><span class="o">-&gt;</span><span class="n">visibility</span><span class="p">,</span>
	    <span class="n">expr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">menu_add_expr</span><span class="p">(</span><span class="k">enum</span> <span class="n">prop_type</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">expr</span> <span class="o">*</span><span class="n">expr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">expr</span> <span class="o">*</span><span class="n">dep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">menu_add_prop</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">dep</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">menu_add_symbol</span><span class="p">(</span><span class="k">enum</span> <span class="n">prop_type</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="k">struct</span> <span class="n">expr</span> <span class="o">*</span><span class="n">dep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">menu_add_prop</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">expr_alloc_symbol</span><span class="p">(</span><span class="n">sym</span><span class="p">),</span> <span class="n">dep</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">menu_add_option</span><span class="p">(</span><span class="kt">int</span> <span class="n">token</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">T_OPT_MODULES</span>:
		<span class="n">prop</span> <span class="o">=</span> <span class="n">prop_alloc</span><span class="p">(</span><span class="n">P_DEFAULT</span><span class="p">,</span> <span class="n">modules_sym</span><span class="p">);</span>
		<span class="n">prop</span><span class="o">-&gt;</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr_alloc_symbol</span><span class="p">(</span><span class="n">current_entry</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T_OPT_DEFCONFIG_LIST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sym_defconfig_list</span><span class="p">)</span>
			<span class="n">sym_defconfig_list</span> <span class="o">=</span> <span class="n">current_entry</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sym_defconfig_list</span> <span class="o">!=</span> <span class="n">current_entry</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">)</span>
			<span class="n">zconf_error</span><span class="p">(</span><span class="s">&quot;trying to redefine defconfig symbol&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T_OPT_ENV</span>:
		<span class="n">prop_add_env</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">menu_validate_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sym2</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_INT</span> <span class="o">||</span> <span class="n">sym2</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_HEX</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">sym2</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_UNKNOWN</span> <span class="o">&amp;&amp;</span> <span class="n">sym_string_valid</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">sym2</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sym_check_prop</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">prop</span><span class="p">;</span> <span class="n">prop</span><span class="p">;</span> <span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">P_DEFAULT</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_STRING</span> <span class="o">||</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_INT</span> <span class="o">||</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_HEX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">prop</span><span class="o">-&gt;</span><span class="n">expr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">E_SYMBOL</span><span class="p">)</span>
				<span class="n">prop_warn</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span>
				    <span class="s">&quot;default for config symbol &#39;%s&#39;&quot;</span>
				    <span class="s">&quot; must be a single symbol&quot;</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">expr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">E_SYMBOL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">sym2</span> <span class="o">=</span> <span class="n">prop_get_symbol</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_HEX</span> <span class="o">||</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_INT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">menu_validate_number</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">sym2</span><span class="p">))</span>
					<span class="n">prop_warn</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span>
					    <span class="s">&quot;&#39;%s&#39;: number is invalid&quot;</span><span class="p">,</span>
					    <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P_SELECT</span>:
			<span class="n">sym2</span> <span class="o">=</span> <span class="n">prop_get_symbol</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">S_BOOLEAN</span> <span class="o">&amp;&amp;</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">S_TRISTATE</span><span class="p">)</span>
				<span class="n">prop_warn</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span>
				    <span class="s">&quot;config symbol &#39;%s&#39; uses select, but is &quot;</span>
				    <span class="s">&quot;not boolean or tristate&quot;</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sym2</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">S_UNKNOWN</span> <span class="o">&amp;&amp;</span>
			         <span class="n">sym2</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">S_BOOLEAN</span> <span class="o">&amp;&amp;</span>
			         <span class="n">sym2</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">S_TRISTATE</span><span class="p">)</span>
				<span class="n">prop_warn</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span>
				    <span class="s">&quot;&#39;%s&#39; has wrong type. &#39;select&#39; only &quot;</span>
				    <span class="s">&quot;accept arguments of boolean and &quot;</span>
				    <span class="s">&quot;tristate type&quot;</span><span class="p">,</span> <span class="n">sym2</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P_RANGE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">S_INT</span> <span class="o">&amp;&amp;</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">S_HEX</span><span class="p">)</span>
				<span class="n">prop_warn</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;range is only allowed &quot;</span>
				                <span class="s">&quot;for int or hex symbols&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">menu_validate_number</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">expr</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">.</span><span class="n">sym</span><span class="p">)</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">menu_validate_number</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">expr</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">.</span><span class="n">sym</span><span class="p">))</span>
				<span class="n">prop_warn</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;range is invalid&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">menu_finalize</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">,</span> <span class="o">*</span><span class="n">last_menu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">expr</span> <span class="o">*</span><span class="n">parentdep</span><span class="p">,</span> <span class="o">*</span><span class="n">basedep</span><span class="p">,</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span> <span class="o">*</span><span class="n">dep2</span><span class="p">,</span> <span class="o">**</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">sym</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&amp;&amp;</span> <span class="n">sym_is_choice</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* find the first choice value to find out choice type */</span>
				<span class="n">current_entry</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">menu</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span> <span class="n">menu</span><span class="p">;</span> <span class="n">menu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">&amp;&amp;</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">S_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">menu_set_type</span><span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* set the type of the remaining choice values */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">menu</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span> <span class="n">menu</span><span class="p">;</span> <span class="n">menu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">current_entry</span> <span class="o">=</span> <span class="n">menu</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">&amp;&amp;</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_UNKNOWN</span><span class="p">)</span>
					<span class="n">menu_set_type</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">parentdep</span> <span class="o">=</span> <span class="n">expr_alloc_symbol</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="p">)</span>
			<span class="n">parentdep</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">expr</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">parentdep</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">dep</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">menu</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span> <span class="n">menu</span><span class="p">;</span> <span class="n">menu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">basedep</span> <span class="o">=</span> <span class="n">expr_transform</span><span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">dep</span><span class="p">);</span>
			<span class="n">basedep</span> <span class="o">=</span> <span class="n">expr_alloc_and</span><span class="p">(</span><span class="n">expr_copy</span><span class="p">(</span><span class="n">parentdep</span><span class="p">),</span> <span class="n">basedep</span><span class="p">);</span>
			<span class="n">basedep</span> <span class="o">=</span> <span class="n">expr_eliminate_dups</span><span class="p">(</span><span class="n">basedep</span><span class="p">);</span>
			<span class="n">menu</span><span class="o">-&gt;</span><span class="n">dep</span> <span class="o">=</span> <span class="n">basedep</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">)</span>
				<span class="n">prop</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">prop</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">prop</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">prop</span><span class="p">;</span> <span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">menu</span> <span class="o">!=</span> <span class="n">menu</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">dep</span> <span class="o">=</span> <span class="n">expr_transform</span><span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">expr</span><span class="p">);</span>
				<span class="n">dep</span> <span class="o">=</span> <span class="n">expr_alloc_and</span><span class="p">(</span><span class="n">expr_copy</span><span class="p">(</span><span class="n">basedep</span><span class="p">),</span> <span class="n">dep</span><span class="p">);</span>
				<span class="n">dep</span> <span class="o">=</span> <span class="n">expr_eliminate_dups</span><span class="p">(</span><span class="n">dep</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">&amp;&amp;</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">S_TRISTATE</span><span class="p">)</span>
					<span class="n">dep</span> <span class="o">=</span> <span class="n">expr_trans_bool</span><span class="p">(</span><span class="n">dep</span><span class="p">);</span>
				<span class="n">prop</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">dep</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">P_SELECT</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">prop_get_symbol</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span>
					<span class="n">es</span><span class="o">-&gt;</span><span class="n">rev_dep</span><span class="p">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr_alloc_or</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">rev_dep</span><span class="p">.</span><span class="n">expr</span><span class="p">,</span>
							<span class="n">expr_alloc_and</span><span class="p">(</span><span class="n">expr_alloc_symbol</span><span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">),</span> <span class="n">expr_copy</span><span class="p">(</span><span class="n">dep</span><span class="p">)));</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">menu</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span> <span class="n">menu</span><span class="p">;</span> <span class="n">menu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="n">menu_finalize</span><span class="p">(</span><span class="n">menu</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">basedep</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">prompt</span> <span class="o">?</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">expr</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">basedep</span> <span class="o">=</span> <span class="n">expr_trans_compare</span><span class="p">(</span><span class="n">basedep</span><span class="p">,</span> <span class="n">E_UNEQUAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symbol_no</span><span class="p">);</span>
		<span class="n">basedep</span> <span class="o">=</span> <span class="n">expr_eliminate_dups</span><span class="p">(</span><span class="n">expr_transform</span><span class="p">(</span><span class="n">basedep</span><span class="p">));</span>
		<span class="n">last_menu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">menu</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="n">menu</span><span class="p">;</span> <span class="n">menu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dep</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span> <span class="o">?</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">expr</span> <span class="o">:</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">dep</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">expr_contains_symbol</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">sym</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">expr_depends_symbol</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">sym</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
			<span class="n">dep</span> <span class="o">=</span> <span class="n">expr_trans_compare</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">E_UNEQUAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symbol_no</span><span class="p">);</span>
			<span class="n">dep</span> <span class="o">=</span> <span class="n">expr_eliminate_dups</span><span class="p">(</span><span class="n">expr_transform</span><span class="p">(</span><span class="n">dep</span><span class="p">));</span>
			<span class="n">dep2</span> <span class="o">=</span> <span class="n">expr_copy</span><span class="p">(</span><span class="n">basedep</span><span class="p">);</span>
			<span class="n">expr_eliminate_eq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dep2</span><span class="p">);</span>
			<span class="n">expr_free</span><span class="p">(</span><span class="n">dep</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">expr_is_yes</span><span class="p">(</span><span class="n">dep2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">expr_free</span><span class="p">(</span><span class="n">dep2</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">expr_free</span><span class="p">(</span><span class="n">dep2</span><span class="p">);</span>
		<span class="nl">next:</span>
			<span class="n">menu_finalize</span><span class="p">(</span><span class="n">menu</span><span class="p">);</span>
			<span class="n">menu</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
			<span class="n">last_menu</span> <span class="o">=</span> <span class="n">menu</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_menu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">last_menu</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">last_menu</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sym</span><span class="o">-&gt;</span><span class="n">dir_dep</span><span class="p">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr_alloc_or</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">dir_dep</span><span class="p">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">dep</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">menu</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span> <span class="n">menu</span><span class="p">;</span> <span class="n">menu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&amp;&amp;</span> <span class="n">sym_is_choice</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sym_is_choice_value</span><span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">current_entry</span> <span class="o">=</span> <span class="n">menu</span><span class="p">;</span>
			<span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SYMBOL_CHOICEVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="p">)</span>
				<span class="n">menu_warn</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="s">&quot;choice value must have a prompt&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">prop</span><span class="p">;</span> <span class="n">prop</span><span class="p">;</span> <span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">P_DEFAULT</span><span class="p">)</span>
					<span class="n">prop_warn</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;defaults for choice &quot;</span>
						  <span class="s">&quot;values not supported&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">menu</span> <span class="o">==</span> <span class="n">menu</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">P_PROMPT</span> <span class="o">&amp;&amp;</span>
				    <span class="n">prop</span><span class="o">-&gt;</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">!=</span> <span class="n">sym</span><span class="p">)</span>
					<span class="n">prop_warn</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;choice value used outside its choice group&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* Non-tristate choice values of tristate choices must</span>
<span class="cm">			 * depend on the choice being set to Y. The choice</span>
<span class="cm">			 * values&#39; dependencies were propagated to their</span>
<span class="cm">			 * properties above, so the change here must be re-</span>
<span class="cm">			 * propagated.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_TRISTATE</span> <span class="o">&amp;&amp;</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">S_TRISTATE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">basedep</span> <span class="o">=</span> <span class="n">expr_alloc_comp</span><span class="p">(</span><span class="n">E_EQUAL</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symbol_yes</span><span class="p">);</span>
				<span class="n">menu</span><span class="o">-&gt;</span><span class="n">dep</span> <span class="o">=</span> <span class="n">expr_alloc_and</span><span class="p">(</span><span class="n">basedep</span><span class="p">,</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">dep</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">prop</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">prop</span><span class="p">;</span> <span class="n">prop</span><span class="p">;</span> <span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">menu</span> <span class="o">!=</span> <span class="n">menu</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="n">prop</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr_alloc_and</span><span class="p">(</span><span class="n">expr_copy</span><span class="p">(</span><span class="n">basedep</span><span class="p">),</span>
									    <span class="n">prop</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">expr</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">menu_add_symbol</span><span class="p">(</span><span class="n">P_CHOICE</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">prop</span> <span class="o">=</span> <span class="n">sym_get_choice_prop</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">expr</span><span class="p">;</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span> <span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">.</span><span class="n">expr</span><span class="p">)</span>
				<span class="p">;</span>
			<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">expr_alloc_one</span><span class="p">(</span><span class="n">E_LIST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">.</span><span class="n">sym</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span> <span class="o">||</span> <span class="o">!</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">last_menu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span> <span class="p">;</span> <span class="n">last_menu</span> <span class="o">=</span> <span class="n">last_menu</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">last_menu</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last_menu</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">last_menu</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">menu</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span>
			<span class="n">menu</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SYMBOL_WARNED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_UNKNOWN</span><span class="p">)</span>
			<span class="n">menu_warn</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;config symbol defined without type&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sym_is_choice</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="p">)</span>
			<span class="n">menu_warn</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;choice must have a prompt&quot;</span><span class="p">);</span>

		<span class="cm">/* Check properties connected to this symbol */</span>
		<span class="n">sym_check_prop</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
		<span class="n">sym</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SYMBOL_WARNED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sym_is_optional</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sym</span><span class="o">-&gt;</span><span class="n">rev_dep</span><span class="p">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr_alloc_or</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">rev_dep</span><span class="p">.</span><span class="n">expr</span><span class="p">,</span>
				<span class="n">expr_alloc_and</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">expr</span><span class="p">,</span>
					<span class="n">expr_alloc_symbol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">symbol_mod</span><span class="p">)));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">menu_has_prompt</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">menu_is_visible</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
	<span class="n">tristate</span> <span class="n">visible</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">visibility</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">expr_calc_value</span><span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">visibility</span><span class="p">)</span> <span class="o">==</span> <span class="n">no</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">no</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sym</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sym_calc_value</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
		<span class="n">visible</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">tri</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">visible</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">tri</span> <span class="o">=</span> <span class="n">expr_calc_value</span><span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">expr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">visible</span> <span class="o">!=</span> <span class="n">no</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sym</span> <span class="o">||</span> <span class="n">sym_get_tristate_value</span><span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">)</span> <span class="o">==</span> <span class="n">no</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">child</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span> <span class="n">child</span><span class="p">;</span> <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">menu_is_visible</span><span class="p">(</span><span class="n">child</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="p">)</span>
				<span class="n">sym</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SYMBOL_DEF_USER</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">menu_get_prompt</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="nf">menu_get_root_menu</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">rootmenu</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="nf">menu_get_parent_menu</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">prop_type</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">menu</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">rootmenu</span><span class="p">;</span> <span class="n">menu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span> <span class="o">?</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">P_MENU</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">menu</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">menu_has_help</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">help</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">menu_get_help</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_prompt_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">gstr</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="n">prop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">submenu</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="o">*</span><span class="n">menu</span><span class="p">;</span>

	<span class="n">str_printf</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Prompt: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">));</span>
	<span class="n">str_printf</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;  Defined at %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">prop</span><span class="o">-&gt;</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">lineno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">expr_is_yes</span><span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">expr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">str_append</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;  Depends on: &quot;</span><span class="p">));</span>
		<span class="n">expr_gstr_print</span><span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">visible</span><span class="p">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="n">str_append</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">menu</span> <span class="o">=</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">menu</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">rootmenu</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">menu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">submenu</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">menu</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">str_printf</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;  Location:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">menu</span> <span class="o">=</span> <span class="n">submenu</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">str_printf</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;%*c-&gt; %s&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="n">menu_get_prompt</span><span class="p">(</span><span class="n">menu</span><span class="p">)));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">str_printf</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot; (%s [=%s])&quot;</span><span class="p">,</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">?</span>
					<span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;&lt;choice&gt;&quot;</span><span class="p">),</span>
					<span class="n">sym_get_string_value</span><span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">str_append</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">get_symbol_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">gstr</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">hit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&amp;&amp;</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">str_printf</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;Symbol: %s [=%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			   <span class="n">sym_get_string_value</span><span class="p">(</span><span class="n">sym</span><span class="p">));</span>
		<span class="n">str_printf</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;Type  : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sym_type_name</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_INT</span> <span class="o">||</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">S_HEX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prop</span> <span class="o">=</span> <span class="n">sym_get_range_prop</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">str_printf</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;Range : &quot;</span><span class="p">);</span>
				<span class="n">expr_gstr_print</span><span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">expr</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
				<span class="n">str_append</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">for_all_prompts</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>
		<span class="n">get_prompt_str</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">prop</span><span class="p">);</span>
	<span class="n">hit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">for_all_properties</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">P_SELECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">str_append</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;  Selects: &quot;</span><span class="p">);</span>
			<span class="n">hit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">str_printf</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot; &amp;&amp; &quot;</span><span class="p">);</span>
		<span class="n">expr_gstr_print</span><span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">expr</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hit</span><span class="p">)</span>
		<span class="n">str_append</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">rev_dep</span><span class="p">.</span><span class="n">expr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">str_append</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;  Selected by: &quot;</span><span class="p">));</span>
		<span class="n">expr_gstr_print</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">rev_dep</span><span class="p">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="n">str_append</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">str_append</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">gstr</span> <span class="nf">get_relations_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">**</span><span class="n">sym_arr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gstr</span> <span class="n">res</span> <span class="o">=</span> <span class="n">str_new</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sym_arr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sym</span> <span class="o">=</span> <span class="n">sym_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">get_symbol_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="n">sym</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
		<span class="n">str_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;No matches found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">menu_get_ext_help</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gstr</span> <span class="o">*</span><span class="n">help</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">help_text</span> <span class="o">=</span> <span class="n">nohelp_text</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">menu_has_help</span><span class="p">(</span><span class="n">menu</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
			<span class="n">str_printf</span><span class="p">(</span><span class="n">help</span><span class="p">,</span> <span class="s">&quot;%s%s:</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CONFIG_</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">help_text</span> <span class="o">=</span> <span class="n">menu_get_help</span><span class="p">(</span><span class="n">menu</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">str_printf</span><span class="p">(</span><span class="n">help</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="n">help_text</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="p">)</span>
		<span class="n">get_symbol_str</span><span class="p">(</span><span class="n">help</span><span class="p">,</span> <span class="n">sym</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
