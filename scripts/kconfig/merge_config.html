<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › kconfig › merge_config.sh

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>merge_config.sh</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/sh</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>merge_config.sh - Takes a list of config fragment values, and merges
 them one by one. Provides warnings on overridden values, and specified
 values that did not make it to the resulting .config file (due to missed
 dependencies or config symbol removal).</p>

<p>Portions reused from kconf<em>check and generate</em>cfg:
 http://git.yoctoproject.org/cgit/cgit.cgi/yocto-kernel-tools/tree/tools/kconf<em>check
 http://git.yoctoproject.org/cgit/cgit.cgi/yocto-kernel-tools/tree/tools/generate</em>cfg</p>

<p>Copyright (c) 2009-2010 Wind River Systems, Inc.
 Copyright 2011 Linaro</p>

<p>This program is free software; you can redistribute it and/or modify
 it under the terms of the GNU General Public License version 2 as
 published by the Free Software Foundation.</p>

<p>This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 See the GNU General Public License for more details.</p></td><td class="code"><div class="highlight"><pre>clean_up<span class="o">()</span> <span class="o">{</span>
	rm -f <span class="nv">$TMP_FILE</span>
	<span class="nb">exit</span>
<span class="o">}</span>
<span class="nb">trap </span>clean_up HUP INT TERM

usage<span class="o">()</span> <span class="o">{</span>
	<span class="nb">echo</span> <span class="s2">&quot;Usage: $0 [OPTIONS] [CONFIG [...]]&quot;</span>
	<span class="nb">echo</span> <span class="s2">&quot;  -h    display this help text&quot;</span>
	<span class="nb">echo</span> <span class="s2">&quot;  -m    only merge the fragments, do not execute the make command&quot;</span>
	<span class="nb">echo</span> <span class="s2">&quot;  -n    use allnoconfig instead of alldefconfig&quot;</span>
	<span class="nb">echo</span> <span class="s2">&quot;  -r    list redundant entries when merging fragments&quot;</span>
<span class="o">}</span>

<span class="nv">MAKE</span><span class="o">=</span><span class="nb">true</span>
<span class="nv">ALLTARGET</span><span class="o">=</span>alldefconfig
<span class="nv">WARNREDUN</span><span class="o">=</span><span class="nb">false</span>

<span class="k">while </span><span class="nb">true</span>; <span class="k">do</span>
<span class="k">	case</span> <span class="nv">$1</span> in
	<span class="s2">&quot;-n&quot;</span><span class="o">)</span>
		<span class="nv">ALLTARGET</span><span class="o">=</span>allnoconfig
		<span class="nb">shift</span>
<span class="nb">		</span><span class="k">continue</span>
		;;
	<span class="s2">&quot;-m&quot;</span><span class="o">)</span>
		<span class="nv">MAKE</span><span class="o">=</span><span class="nb">false</span>
<span class="nb">		shift</span>
<span class="nb">		</span><span class="k">continue</span>
		;;
	<span class="s2">&quot;-h&quot;</span><span class="o">)</span>
		usage
		<span class="nb">exit</span>
		;;
	<span class="s2">&quot;-r&quot;</span><span class="o">)</span>
		<span class="nv">WARNREDUN</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">		shift</span>
<span class="nb">		</span><span class="k">continue</span>
		;;
	*<span class="o">)</span>
		<span class="nb">break</span>
		;;
	<span class="k">esac</span>
<span class="k">done</span>

<span class="nv">INITFILE</span><span class="o">=</span><span class="nv">$1</span>
<span class="nb">shift</span>;

<span class="nv">MERGE_LIST</span><span class="o">=</span><span class="nv">$*</span>
<span class="nv">SED_CONFIG_EXP</span><span class="o">=</span><span class="s2">&quot;s/^\(# \)\{0,1\}\(CONFIG_[a-zA-Z0-9_]*\)[= ].*/\2/p&quot;</span>
<span class="nv">TMP_FILE</span><span class="o">=</span><span class="k">$(</span>mktemp ./.tmp.config.XXXXXXXXXX<span class="k">)</span>

<span class="nb">echo</span> <span class="s2">&quot;Using $INITFILE as base&quot;</span>
cat <span class="nv">$INITFILE</span> &gt; <span class="nv">$TMP_FILE</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Merge files, printing warnings on overrided values</p></td><td class="code"><div class="highlight"><pre><span class="k">for </span>MERGE_FILE in <span class="nv">$MERGE_LIST</span> ; <span class="k">do</span>
<span class="k">	</span><span class="nb">echo</span> <span class="s2">&quot;Merging $MERGE_FILE&quot;</span>
	<span class="nv">CFG_LIST</span><span class="o">=</span><span class="k">$(</span>sed -n <span class="s2">&quot;$SED_CONFIG_EXP&quot;</span> <span class="nv">$MERGE_FILE</span><span class="k">)</span>

	<span class="k">for </span>CFG in <span class="nv">$CFG_LIST</span> ; <span class="k">do</span>
<span class="k">		</span>grep -q -w <span class="nv">$CFG</span> <span class="nv">$TMP_FILE</span>
		<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq 0 <span class="o">]</span> ; <span class="k">then</span>
<span class="k">			</span><span class="nv">PREV_VAL</span><span class="o">=</span><span class="k">$(</span>grep -w <span class="nv">$CFG</span> <span class="nv">$TMP_FILE</span><span class="k">)</span>
			<span class="nv">NEW_VAL</span><span class="o">=</span><span class="k">$(</span>grep -w <span class="nv">$CFG</span> <span class="nv">$MERGE_FILE</span><span class="k">)</span>
			<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;x$PREV_VAL&quot;</span> !<span class="o">=</span> <span class="s2">&quot;x$NEW_VAL&quot;</span> <span class="o">]</span> ; <span class="k">then</span>
<span class="k">			</span><span class="nb">echo </span>Value of <span class="nv">$CFG</span> is redefined by fragment <span class="nv">$MERGE_FILE</span>:
			<span class="nb">echo </span>Previous  value: <span class="nv">$PREV_VAL</span>
			<span class="nb">echo </span>New value:       <span class="nv">$NEW_VAL</span>
			<span class="nb">echo</span>
<span class="nb">			</span><span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$WARNREDUN&quot;</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">			</span><span class="nb">echo </span>Value of <span class="nv">$CFG</span> is redundant by fragment <span class="nv">$MERGE_FILE</span>:
			<span class="k">fi</span>
<span class="k">			</span>sed -i <span class="s2">&quot;/$CFG[ =]/d&quot;</span> <span class="nv">$TMP_FILE</span>
		<span class="k">fi</span>
<span class="k">	done</span>
<span class="k">	</span>cat <span class="nv">$MERGE_FILE</span> &gt;&gt; <span class="nv">$TMP_FILE</span>
<span class="k">done</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$MAKE&quot;</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>cp <span class="nv">$TMP_FILE</span> .config
	<span class="nb">echo</span> <span class="s2">&quot;#&quot;</span>
	<span class="nb">echo</span> <span class="s2">&quot;# merged configuration written to .config (needs make)&quot;</span>
	<span class="nb">echo</span> <span class="s2">&quot;#&quot;</span>
	clean_up
	<span class="nb">exit</span>
<span class="k">fi</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Use the merged file as the starting point for:
alldefconfig: Fills in any missing symbols with Kconfig default
allnoconfig: Fills in any missing symbols with # CONFIG_* is not set</p></td><td class="code"><div class="highlight"><pre>make <span class="nv">KCONFIG_ALLCONFIG</span><span class="o">=</span><span class="nv">$TMP_FILE</span> <span class="nv">$ALLTARGET</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Check all specified config values took (might have missed-dependency issues)</p></td><td class="code"><div class="highlight"><pre><span class="k">for </span>CFG in <span class="k">$(</span>sed -n <span class="s2">&quot;$SED_CONFIG_EXP&quot;</span> <span class="nv">$TMP_FILE</span><span class="k">)</span>; <span class="k">do</span>

<span class="k">	</span><span class="nv">REQUESTED_VAL</span><span class="o">=</span><span class="k">$(</span>grep -w -e <span class="s2">&quot;$CFG&quot;</span> <span class="nv">$TMP_FILE</span><span class="k">)</span>
	<span class="nv">ACTUAL_VAL</span><span class="o">=</span><span class="k">$(</span>grep -w -e <span class="s2">&quot;$CFG&quot;</span> .config<span class="k">)</span>
	<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;x$REQUESTED_VAL&quot;</span> !<span class="o">=</span> <span class="s2">&quot;x$ACTUAL_VAL&quot;</span> <span class="o">]</span> ; <span class="k">then</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;Value requested for $CFG not in final .config&quot;</span>
		<span class="nb">echo</span> <span class="s2">&quot;Requested value:  $REQUESTED_VAL&quot;</span>
		<span class="nb">echo</span> <span class="s2">&quot;Actual value:     $ACTUAL_VAL&quot;</span>
		<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
	<span class="k">fi</span>
<span class="k">done</span>

clean_up

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
