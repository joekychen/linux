<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › kconfig › streamline_config.pl

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>streamline_config.pl</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c1">#!/usr/bin/perl -w</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Copyright 2005-2009 - Steven Rostedt
Licensed under the terms of the GNU GPL License version 2</p>

<p>It's simple enough to figure out how this works.
 If not, then you can ask me at stripconfig@goodmis.org</p>

<p>What it does?</p>

<p>If you have installed a Linux kernel from a distribution
  that turns on way too many modules than you need, and
  you only want the modules you use, then this program
  is perfect for you.</p>

<p>It gives you the ability to turn off all the modules that are
  not loaded on your system.</p>

<p>Howto:</p>

<ol>
<li>Boot up the kernel that you want to stream line the config on.</li>
<li>Change directory to the directory holding the source of the
  kernel that you just booted.</li>
<li>Copy the configuraton file to this directory as .config</li>
<li>Have all your devices that you need modules for connected and
 operational (make sure that their corresponding modules are loaded)</li>
<li>Run this script redirecting the output to some other file
  like config_strip.</li>
<li>Back up your old config (if you want too).</li>
<li>copy the config_strip file to .config</li>
<li><p>Run "make oldconfig"</p>

<p>Now your kernel is ready to be built with only the modules that
are loaded.</p></li>
</ol>

<p>Here's what I did with my Debian distribution.</p>

<p>cd /usr/src/linux-2.6.10
   cp /boot/config-2.6.10-1-686-smp .config
   ~/bin/streamline<em>config > config</em>strip
   mv .config config<em>sav
   mv config</em>strip .config
   make oldconfig</p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Long</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$config</span> <span class="o">=</span> <span class="s">&quot;.config&quot;</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$uname</span> <span class="o">=</span> <span class="sb">`uname -r`</span><span class="p">;</span>
<span class="nb">chomp</span> <span class="nv">$uname</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">@searchconfigs</span> <span class="o">=</span> <span class="p">(</span>
	<span class="p">{</span>
	    <span class="s">&quot;file&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;.config&quot;</span><span class="p">,</span>
	    <span class="s">&quot;exec&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;cat&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	    <span class="s">&quot;file&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/proc/config.gz&quot;</span><span class="p">,</span>
	    <span class="s">&quot;exec&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;zcat&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	    <span class="s">&quot;file&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/boot/config-$uname&quot;</span><span class="p">,</span>
	    <span class="s">&quot;exec&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;cat&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	    <span class="s">&quot;file&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/boot/vmlinuz-$uname&quot;</span><span class="p">,</span>
	    <span class="s">&quot;exec&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;scripts/extract-ikconfig&quot;</span><span class="p">,</span>
	    <span class="s">&quot;test&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;scripts/extract-ikconfig&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	    <span class="s">&quot;file&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;vmlinux&quot;</span><span class="p">,</span>
	    <span class="s">&quot;exec&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;scripts/extract-ikconfig&quot;</span><span class="p">,</span>
	    <span class="s">&quot;test&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;scripts/extract-ikconfig&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	    <span class="s">&quot;file&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/lib/modules/$uname/kernel/kernel/configs.ko&quot;</span><span class="p">,</span>
	    <span class="s">&quot;exec&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;scripts/extract-ikconfig&quot;</span><span class="p">,</span>
	    <span class="s">&quot;test&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;scripts/extract-ikconfig&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	    <span class="s">&quot;file&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;kernel/configs.ko&quot;</span><span class="p">,</span>
	    <span class="s">&quot;exec&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;scripts/extract-ikconfig&quot;</span><span class="p">,</span>
	    <span class="s">&quot;test&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;scripts/extract-ikconfig&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	    <span class="s">&quot;file&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;kernel/configs.o&quot;</span><span class="p">,</span>
	    <span class="s">&quot;exec&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;scripts/extract-ikconfig&quot;</span><span class="p">,</span>
	    <span class="s">&quot;test&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;scripts/extract-ikconfig&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">);</span>

<span class="k">sub </span><span class="nf">find_config</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$conf</span> <span class="p">(</span><span class="nv">@searchconfigs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$conf</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">};</span>

	<span class="k">next</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="o">-</span><span class="n">f</span> <span class="s">&quot;$file&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$conf</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;test&quot;</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="sb">`$conf-&gt;{&quot;test&quot;} $conf-&gt;{&quot;file&quot;} 2&gt;/dev/null`</span><span class="p">;</span>
	    <span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="vg">$?</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">my</span> <span class="nv">$exec</span> <span class="o">=</span> <span class="nv">$conf</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;exec&quot;</span><span class="p">};</span>

	<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;using config: &#39;$file&#39;\n&quot;</span><span class="p">;</span>

	<span class="nb">open</span><span class="p">(</span><span class="n">CIN</span><span class="p">,</span> <span class="s">&quot;$exec $file |&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nb">die</span> <span class="s">&quot;Failed to run $exec $file&quot;</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">die</span> <span class="s">&quot;No config file found&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">find_config</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Parse options</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$localmodconfig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$localyesconfig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">GetOptions</span><span class="p">(</span><span class="s">&quot;localmodconfig&quot;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$localmodconfig</span><span class="p">,</span>
	   <span class="s">&quot;localyesconfig&quot;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$localyesconfig</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Get the build source and top level Kconfig file (passed in)</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$ksource</span> <span class="o">=</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="k">my</span> <span class="nv">$kconfig</span> <span class="o">=</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="k">my</span> <span class="nv">$lsmod_file</span> <span class="o">=</span> <span class="nv">$ENV</span><span class="p">{</span><span class="s">&#39;LSMOD&#39;</span><span class="p">};</span>

<span class="k">my</span> <span class="nv">@makefiles</span> <span class="o">=</span> <span class="sb">`find $ksource -name Makefile 2&gt;/dev/null`</span><span class="p">;</span>
<span class="nb">chomp</span> <span class="nv">@makefiles</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">%depends</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%selects</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%prompts</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%objects</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$var</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$iflevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@ifdeps</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>prevent recursion</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">%read_kconfigs</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">read_kconfig</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$kconfig</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$state</span> <span class="o">=</span> <span class="s">&quot;NONE&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$config</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@kconfigs</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$cont</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$line</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$source</span> <span class="o">=</span> <span class="s">&quot;$ksource/$kconfig&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$last_source</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Check for any environment variables used</p></td><td class="code"><div class="highlight"><pre>    <span class="k">while</span> <span class="p">(</span><span class="nv">$source</span> <span class="o">=~</span><span class="sr"> /\$(\w+)/</span> <span class="o">&amp;&amp;</span> <span class="nv">$last_source</span> <span class="ow">ne</span> <span class="nv">$source</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$env</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="nv">$last_source</span> <span class="o">=</span> <span class="nv">$source</span><span class="p">;</span>
	<span class="nv">$source</span> <span class="o">=~</span> <span class="sr">s/\$$env/$ENV{$env}/</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nb">open</span><span class="p">(</span><span class="n">KIN</span><span class="p">,</span> <span class="s">&quot;$source&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nb">die</span> <span class="s">&quot;Can&#39;t open $kconfig&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;KIN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">chomp</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Make sure that lines ending with \ continue</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$cont</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$_</span> <span class="o">=</span> <span class="nv">$line</span> <span class="o">.</span> <span class="s">&quot; &quot;</span> <span class="o">.</span> <span class="nv">$_</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="sr">s/\\$//</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$cont</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="nv">$line</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
	    <span class="k">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nv">$cont</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>collect any Kconfig sources</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="sr">/^source\s*&quot;(.*)&quot;/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$kconfigs</span><span class="p">[</span><span class="nv">$#kconfigs</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>configs found</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="sr">/^\s*(menu)?config\s+(\S+)\s*$/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$state</span> <span class="o">=</span> <span class="s">&quot;NEW&quot;</span><span class="p">;</span>
	    <span class="nv">$config</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>

	    <span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$iflevel</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
		    <span class="nv">$depends</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="o">.=</span> <span class="s">&quot; &quot;</span> <span class="o">.</span> <span class="nv">$ifdeps</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="nv">$depends</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$ifdeps</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="nv">$state</span> <span class="o">=</span> <span class="s">&quot;DEP&quot;</span><span class="p">;</span>
	    <span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>collect the depends for the config</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$state</span> <span class="ow">eq</span> <span class="s">&quot;NEW&quot;</span> <span class="o">&amp;&amp;</span> <span class="sr">/^\s*depends\s+on\s+(.*)$/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$state</span> <span class="o">=</span> <span class="s">&quot;DEP&quot;</span><span class="p">;</span>
	    <span class="nv">$depends</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$state</span> <span class="ow">eq</span> <span class="s">&quot;DEP&quot;</span> <span class="o">&amp;&amp;</span> <span class="sr">/^\s*depends\s+on\s+(.*)$/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$depends</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="o">.=</span> <span class="s">&quot; &quot;</span> <span class="o">.</span> <span class="nv">$1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Get the configs that select this config</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$state</span> <span class="ow">ne</span> <span class="s">&quot;NONE&quot;</span> <span class="o">&amp;&amp;</span> <span class="sr">/^\s*select\s+(\S+)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$selects</span><span class="p">{</span><span class="nv">$1</span><span class="p">}))</span> <span class="p">{</span>
		<span class="nv">$selects</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">.=</span> <span class="s">&quot; &quot;</span> <span class="o">.</span> <span class="nv">$config</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nv">$selects</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">;</span>
	    <span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>configs without prompts must be selected</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$state</span> <span class="ow">ne</span> <span class="s">&quot;NONE&quot;</span> <span class="o">&amp;&amp;</span> <span class="sr">/^\s*tristate\s\S/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>note if the config has a prompt</p></td><td class="code"><div class="highlight"><pre>	    <span class="nv">$prompts</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Check for if statements</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^if\s+(.*\S)\s*$/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">my</span> <span class="nv">$deps</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>remove beginning and ending non text</p></td><td class="code"><div class="highlight"><pre>	    <span class="nv">$deps</span> <span class="o">=~</span> <span class="sr">s/^[^a-zA-Z0-9_]*//</span><span class="p">;</span>
	    <span class="nv">$deps</span> <span class="o">=~</span> <span class="sr">s/[^a-zA-Z0-9_]*$//</span><span class="p">;</span>

	    <span class="k">my</span> <span class="nv">@deps</span> <span class="o">=</span> <span class="nb">split</span> <span class="sr">/[^a-zA-Z0-9_]+/</span><span class="p">,</span> <span class="nv">$deps</span><span class="p">;</span>

	    <span class="nv">$ifdeps</span><span class="p">[</span><span class="nv">$iflevel</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nb">join</span> <span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="nv">@deps</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^endif/</span><span class="p">)</span> <span class="p">{</span>

	    <span class="nv">$iflevel</span><span class="o">--</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$iflevel</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>stop on "help"</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^\s*help\s*$/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$state</span> <span class="o">=</span> <span class="s">&quot;NONE&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">KIN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>read in any configs that were found.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">foreach</span> <span class="nv">$kconfig</span> <span class="p">(</span><span class="nv">@kconfigs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$read_kconfigs</span><span class="p">{</span><span class="nv">$kconfig</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="nv">$read_kconfigs</span><span class="p">{</span><span class="nv">$kconfig</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="n">read_kconfig</span><span class="p">(</span><span class="nv">$kconfig</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$kconfig</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">read_kconfig</span><span class="p">(</span><span class="nv">$kconfig</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">convert_vars</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="nv">%vars</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$process</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span> <span class="sr">s/^(.*?)(\$\((.*?)\))//</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$start</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$variable</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$var</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$vars</span><span class="p">{</span><span class="nv">$var</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="nv">$process</span> <span class="o">.=</span> <span class="nv">$start</span> <span class="o">.</span> <span class="nv">$vars</span><span class="p">{</span><span class="nv">$var</span><span class="p">};</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nv">$process</span> <span class="o">.=</span> <span class="nv">$start</span> <span class="o">.</span> <span class="nv">$variable</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="nv">$process</span> <span class="o">.=</span> <span class="nv">$line</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$process</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Read all Makefiles to map the configs to the objects</p></td><td class="code"><div class="highlight"><pre><span class="k">foreach</span> <span class="k">my</span> <span class="nv">$makefile</span> <span class="p">(</span><span class="nv">@makefiles</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">%make_vars</span><span class="p">;</span>

    <span class="nb">open</span><span class="p">(</span><span class="n">MIN</span><span class="p">,</span><span class="nv">$makefile</span><span class="p">)</span> <span class="o">||</span> <span class="nb">die</span> <span class="s">&quot;Can&#39;t open $makefile&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;MIN&gt;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>if this line ends with a backslash, continue</p></td><td class="code"><div class="highlight"><pre>	<span class="nb">chomp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="sr">/^(.*)\\$/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$line</span> <span class="o">.=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="k">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nv">$line</span> <span class="o">.=</span> <span class="nv">$_</span><span class="p">;</span>
	<span class="nv">$_</span> <span class="o">=</span> <span class="nv">$line</span><span class="p">;</span>
	<span class="nv">$line</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$objs</span><span class="p">;</span>

	<span class="nv">$_</span> <span class="o">=</span> <span class="n">convert_vars</span><span class="p">(</span><span class="nv">$_</span><span class="p">,</span> <span class="nv">%make_vars</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>collect objects after obj-$(CONFIG<em>FOO</em>BAR)</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="sr">/obj-\$\((CONFIG_[^\)]*)\)\s*[+:]?=\s*(.*)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$var</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="nv">$objs</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>check if variables are set</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^\s*(\S+)\s*[:]?=\s*(.*\S)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$make_vars</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$objs</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$obj</span> <span class="p">(</span><span class="nb">split</span> <span class="sr">/\s+/</span><span class="p">,</span><span class="nv">$objs</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$obj</span> <span class="o">=~</span> <span class="sr">s/-/_/g</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$obj</span> <span class="o">=~</span><span class="sr"> /(.*)\.o$/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Objects may be enabled by more than one config.
Store configs in an array.</p></td><td class="code"><div class="highlight"><pre>		    <span class="k">my</span> <span class="nv">@arr</span><span class="p">;</span>

		    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$objects</span><span class="p">{</span><span class="nv">$1</span><span class="p">}))</span> <span class="p">{</span>
			<span class="nv">@arr</span> <span class="o">=</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$objects</span><span class="p">{</span><span class="nv">$1</span><span class="p">}};</span>
		    <span class="p">}</span>

		    <span class="nv">$arr</span><span class="p">[</span><span class="nv">$#arr</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$var</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>The objects have a hash mapping to a reference
of an array of configs.</p></td><td class="code"><div class="highlight"><pre>		    <span class="nv">$objects</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">=</span> <span class="o">\</span><span class="nv">@arr</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">MIN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">%modules</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$lsmod_file</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="o">-</span><span class="n">f</span> <span class="nv">$lsmod_file</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">-</span><span class="n">f</span> <span class="nv">$ENV</span><span class="p">{</span><span class="s">&#39;objtree&#39;</span><span class="p">}</span><span class="o">.</span><span class="s">&quot;/&quot;</span><span class="o">.</span><span class="nv">$lsmod_file</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$lsmod_file</span> <span class="o">=</span> <span class="nv">$ENV</span><span class="p">{</span><span class="s">&#39;objtree&#39;</span><span class="p">}</span><span class="o">.</span><span class="s">&quot;/&quot;</span><span class="o">.</span><span class="nv">$lsmod_file</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nb">die</span> <span class="s">&quot;$lsmod_file not found&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">-</span><span class="n">x</span> <span class="nv">$lsmod_file</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>the file is executable, run it</p></td><td class="code"><div class="highlight"><pre>	<span class="nb">open</span><span class="p">(</span><span class="n">LIN</span><span class="p">,</span> <span class="s">&quot;$lsmod_file|&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Just read the contents</p></td><td class="code"><div class="highlight"><pre>	<span class="nb">open</span><span class="p">(</span><span class="n">LIN</span><span class="p">,</span> <span class="s">&quot;$lsmod_file&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>see what modules are loaded on this system</p></td><td class="code"><div class="highlight"><pre>    <span class="k">my</span> <span class="nv">$lsmod</span><span class="p">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$dir</span> <span class="p">(</span> <span class="p">(</span><span class="s">&quot;/sbin&quot;</span><span class="p">,</span> <span class="s">&quot;/bin&quot;</span><span class="p">,</span> <span class="s">&quot;/usr/sbin&quot;</span><span class="p">,</span> <span class="s">&quot;/usr/bin&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">-</span><span class="n">x</span> <span class="s">&quot;$dir/lsmod&quot;</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$lsmod</span> <span class="o">=</span> <span class="s">&quot;$dir/lsmod&quot;</span><span class="p">;</span>
	    <span class="k">last</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$lsmod</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>try just the path</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$lsmod</span> <span class="o">=</span> <span class="s">&quot;lsmod&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nb">open</span><span class="p">(</span><span class="n">LIN</span><span class="p">,</span><span class="s">&quot;$lsmod|&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nb">die</span> <span class="s">&quot;Can not call lsmod with $lsmod&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">while</span> <span class="p">(</span><span class="sr">&lt;LIN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="sr">/^Module/</span><span class="p">);</span>  <span class="c1"># Skip the first line.</span>
	<span class="k">if</span> <span class="p">(</span><span class="sr">/^(\S+)/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$modules</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="nb">close</span> <span class="p">(</span><span class="n">LIN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>add to the configs hash all configs that are needed to enable
a loaded module.</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">%configs</span><span class="p">;</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$module</span> <span class="p">(</span><span class="nb">keys</span><span class="p">(</span><span class="nv">%modules</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$objects</span><span class="p">{</span><span class="nv">$module</span><span class="p">}))</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">@arr</span> <span class="o">=</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$objects</span><span class="p">{</span><span class="nv">$module</span><span class="p">}};</span>
	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$conf</span> <span class="p">(</span><span class="nv">@arr</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$configs</span><span class="p">{</span><span class="nv">$conf</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$module</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Most likely, someone has a custom (binary?) module loaded.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;$module config not found!!\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$valid</span> <span class="o">=</span> <span class="s">&quot;A-Za-z_0-9&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$repeat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Note, we do not care about operands (like: &amp;&amp;, ||, !) we want to add any
config that is in the depend list of another config. This script does
not enable configs that are not already enabled. If we come across a
config A that depends on !B, we can still add B to the list of depends
to keep on. If A was on in the original config, B would not have been
and B would not be turned on by this script.</p></td><td class="code"><div class="highlight"><pre><span class="k">sub </span><span class="nf">parse_config_dep_select</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$p</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nv">$p</span> <span class="o">=~</span><span class="sr"> /[$valid]/</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$p</span> <span class="o">=~</span><span class="sr"> /^[^$valid]*([$valid]+)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">my</span> <span class="nv">$conf</span> <span class="o">=</span> <span class="s">&quot;CONFIG_&quot;</span> <span class="o">.</span> <span class="nv">$1</span><span class="p">;</span>

	    <span class="nv">$p</span> <span class="o">=~</span> <span class="sr">s/^[^$valid]*[$valid]+//</span><span class="p">;</span>

	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$configs</span><span class="p">{</span><span class="nv">$conf</span><span class="p">}))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>We must make sure that this config has its
dependencies met.</p></td><td class="code"><div class="highlight"><pre>		<span class="nv">$repeat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1"># do again</span>
		<span class="nv">$configs</span><span class="p">{</span><span class="nv">$conf</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">die</span> <span class="s">&quot;this should never happen&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">while</span> <span class="p">(</span><span class="nv">$repeat</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$repeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%configs</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$config</span> <span class="o">=~</span> <span class="sr">s/^CONFIG_//</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$depends</span><span class="p">{</span><span class="nv">$config</span><span class="p">}))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>This config has dependencies. Make sure they are also included</p></td><td class="code"><div class="highlight"><pre>	    <span class="n">parse_config_dep_select</span> <span class="nv">$depends</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$prompts</span><span class="p">{</span><span class="nv">$config</span><span class="p">})</span> <span class="o">||</span> <span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$selects</span><span class="p">{</span><span class="nv">$config</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="k">next</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>config has no prompt and must be selected.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">parse_config_dep_select</span> <span class="nv">$selects</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">%setconfigs</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Finally, read the .config file and turn off any module enabled that
we could not find a reason to keep enabled.</p></td><td class="code"><div class="highlight"><pre><span class="k">while</span><span class="p">(</span><span class="sr">&lt;CIN&gt;</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="sr">/CONFIG_IKCONFIG/</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="sr">/# CONFIG_IKCONFIG is not set/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>enable IKCONFIG at least as a module</p></td><td class="code"><div class="highlight"><pre>	    <span class="k">print</span> <span class="s">&quot;CONFIG_IKCONFIG=m\n&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>don't ask about PROC</p></td><td class="code"><div class="highlight"><pre>	    <span class="k">print</span> <span class="s">&quot;# CONFIG_IKCONFIG_PROC is not set\n&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">print</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">next</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="sr">/^(CONFIG.*)=(m|y)/</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$configs</span><span class="p">{</span><span class="nv">$1</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$localyesconfig</span><span class="p">)</span> <span class="p">{</span>
	        <span class="nv">$setconfigs</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">=</span> <span class="s">&#39;y&#39;</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	        <span class="nv">$setconfigs</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$2</span> <span class="ow">eq</span> <span class="s">&quot;m&quot;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">print</span> <span class="s">&quot;# $1 is not set\n&quot;</span><span class="p">;</span>
	    <span class="k">next</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">print</span><span class="p">;</span>
<span class="p">}</span>
<span class="nb">close</span><span class="p">(</span><span class="n">CIN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>Integrity check, make sure all modules that we want enabled do
indeed have their configs set.</p></td><td class="code"><div class="highlight"><pre><span class="n">loop:</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$module</span> <span class="p">(</span><span class="nb">keys</span><span class="p">(</span><span class="nv">%modules</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$objects</span><span class="p">{</span><span class="nv">$module</span><span class="p">}))</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">@arr</span> <span class="o">=</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$objects</span><span class="p">{</span><span class="nv">$module</span><span class="p">}};</span>
	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$conf</span> <span class="p">(</span><span class="nv">@arr</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$setconfigs</span><span class="p">{</span><span class="nv">$conf</span><span class="p">}))</span> <span class="p">{</span>
		<span class="k">next</span> <span class="n">loop</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;module $module did not have configs&quot;</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$conf</span> <span class="p">(</span><span class="nv">@arr</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot; &quot;</span> <span class="p">,</span> <span class="nv">$conf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
