<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › kconfig › nconf.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>nconf.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2008 Nir Tzachar &lt;nir.tzachar@gmail.com?</span>
<span class="cm"> * Released under the terms of the GNU GPL v2.0.</span>
<span class="cm"> *</span>
<span class="cm"> * Derived from menuconfig.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#define _GNU_SOURCE</span>
<span class="cp">#include &lt;string.h&gt;</span>

<span class="cp">#include &quot;lkc.h&quot;</span>
<span class="cp">#include &quot;nconf.h&quot;</span>
<span class="cp">#include &lt;ctype.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">nconf_readme</span><span class="p">[]</span> <span class="o">=</span> <span class="n">N_</span><span class="p">(</span>
<span class="s">&quot;Overview</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;--------</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;This interface let you select features and parameters for the build.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Features can either be built-in, modularized, or ignored. Parameters</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;must be entered in as decimal or hexadecimal numbers or text.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Menu items beginning with following braces represent features that</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  [ ] can be built in or removed</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt; &gt; can be built in, modularized or removed</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  { } can be built in or modularized (selected by other feature)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  - - are selected by other feature,</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  XXX cannot be selected. Use Symbol Info to find out why,</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;while *, M or whitespace inside braces means to build in, build as</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;a module or to exclude the feature respectively.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;To change any of these features, highlight it with the cursor</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;keys and press &lt;Y&gt; to build it in, &lt;M&gt; to make it a module or</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;&lt;N&gt; to removed it.  You may also press the &lt;Space Bar&gt; to cycle</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;through the available options (ie. Y-&gt;N-&gt;M-&gt;Y).</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Some additional keyboard hints:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Menus</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;----------</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o  Use the Up/Down arrow keys (cursor keys) to highlight the item</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;   you wish to change use &lt;Enter&gt; or &lt;Space&gt;. Goto submenu by </span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;   pressing &lt;Enter&gt; of &lt;right-arrow&gt;. Use &lt;Esc&gt; or &lt;left-arrow&gt; to go back.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;   Submenus are designated by </span><span class="se">\&quot;</span><span class="s">---&gt;</span><span class="se">\&quot;</span><span class="s">.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;   Searching: pressing &#39;/&#39; triggers interactive search mode.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;              nconfig performs a case insensitive search for the string</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;              in the menu prompts (no regex support).</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;              Pressing the up/down keys highlights the previous/next</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;              matching item. Backspace removes one character from the</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;              match string. Pressing either &#39;/&#39; again or ESC exits</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;              search mode. All other keys behave normally.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;   You may also use the &lt;PAGE UP&gt; and &lt;PAGE DOWN&gt; keys to scroll</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;   unseen options into view.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o  To exit a menu use the just press &lt;ESC&gt; &lt;F5&gt; &lt;F8&gt; or &lt;left-arrow&gt;.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o  To get help with an item, press &lt;F1&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;   Shortcut: Press &lt;h&gt; or &lt;?&gt;.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Radiolists  (Choice lists)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;-----------</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o  Use the cursor keys to select the option you wish to set and press</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;   &lt;S&gt; or the &lt;SPACE BAR&gt;.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;   Shortcut: Press the first letter of the option you wish to set then</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;             press &lt;S&gt; or &lt;SPACE BAR&gt;.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o  To see available help for the item, press &lt;F1&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;   Shortcut: Press &lt;H&gt; or &lt;?&gt;.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Data Entry</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;-----------</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o  Enter the requested information and press &lt;ENTER&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;   If you are entering hexadecimal values, it is not necessary to</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;   add the &#39;0x&#39; prefix to the entry.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o  For help, press &lt;F1&gt;.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Text Box    (Help Window)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;--------</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o  Use the cursor keys to scroll up/down/left/right.  The VI editor</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;   keys h,j,k,l function here as do &lt;SPACE BAR&gt; for those</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;   who are familiar with less and lynx.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o  Press &lt;Enter&gt;, &lt;F1&gt;, &lt;F5&gt;, &lt;F7&gt; or &lt;Esc&gt; to exit.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Alternate Configuration Files</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;-----------------------------</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;nconfig supports the use of alternate configuration files for</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;those who, for various reasons, find it necessary to switch</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;between different configurations.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;At the end of the main menu you will find two options.  One is</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;for saving the current configuration to a file of your choosing.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;The other option is for loading a previously saved alternate</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;configuration.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Even if you don&#39;t use alternate configuration files, but you</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;find during a nconfig session that you have completely messed</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;up your settings, you may use the </span><span class="se">\&quot;</span><span class="s">Load Alternate...</span><span class="se">\&quot;</span><span class="s"> option to</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;restore your previously saved settings from </span><span class="se">\&quot;</span><span class="s">.config</span><span class="se">\&quot;</span><span class="s"> without</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;restarting nconfig.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Other information</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;-----------------</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;If you use nconfig in an XTERM window make sure you have your</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;$TERM variable set to point to a xterm definition which supports color.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Otherwise, nconfig will look rather bad.  nconfig will not</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;display correctly in a RXVT window because rxvt displays only one</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;intensity of color, bright.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;nconfig will display larger menus on screens or xterms which are</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;set to display more than the standard 25 row by 80 column geometry.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;In order for this to work, the </span><span class="se">\&quot;</span><span class="s">stty size</span><span class="se">\&quot;</span><span class="s"> command must be able to</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;display the screen&#39;s current row and column geometry.  I STRONGLY</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;RECOMMEND that you make sure you do NOT have the shell variables</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;LINES and COLUMNS exported into your environment.  Some distributions</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;export those variables via /etc/profile.  Some ncurses programs can</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;become confused when those variables (LINES &amp; COLUMNS) don&#39;t reflect</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;the true screen size.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Optional personality available</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;------------------------------</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;If you prefer to have all of the options listed in a single menu, rather</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;than the default multimenu hierarchy, run the nconfig with NCONFIG_MODE</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;environment variable set to single_menu. Example:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;make NCONFIG_MODE=single_menu nconfig</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;&lt;Enter&gt; will then unroll the appropriate category, or enfold it if it</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;is already unrolled.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Note that this mode can eventually be a little more CPU expensive</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;(especially with a larger number of unrolled categories) than the</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;default mode.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
<span class="n">menu_no_f_instructions</span><span class="p">[]</span> <span class="o">=</span> <span class="n">N_</span><span class="p">(</span>
<span class="s">&quot; You do not have function keys support. Please follow the</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; following instructions:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; Arrow keys navigate the menu.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; &lt;Enter&gt; or &lt;right-arrow&gt; selects submenus ---&gt;.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; Capital Letters are hotkeys.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; Pressing &lt;Y&gt; includes, &lt;N&gt; excludes, &lt;M&gt; modularizes features.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; Pressing SpaceBar toggles between the above options.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; Press &lt;Esc&gt; or &lt;left-arrow&gt; to go back one menu,</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; &lt;?&gt; or &lt;h&gt; for Help, &lt;/&gt; for Search.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; &lt;1&gt; is interchangeable with &lt;F1&gt;, &lt;2&gt; with &lt;F2&gt;, etc.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; Legend: [*] built-in  [ ] excluded  &lt;M&gt; module  &lt; &gt; module capable.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; &lt;Esc&gt; always leaves the current window.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
<span class="n">menu_instructions</span><span class="p">[]</span> <span class="o">=</span> <span class="n">N_</span><span class="p">(</span>
<span class="s">&quot; Arrow keys navigate the menu.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; &lt;Enter&gt; or &lt;right-arrow&gt; selects submenus ---&gt;.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; Capital Letters are hotkeys.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; Pressing &lt;Y&gt; includes, &lt;N&gt; excludes, &lt;M&gt; modularizes features.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; Pressing SpaceBar toggles between the above options</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; Press &lt;Esc&gt;, &lt;F5&gt; or &lt;left-arrow&gt; to go back one menu,</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; &lt;?&gt;, &lt;F1&gt; or &lt;h&gt; for Help, &lt;/&gt; for Search.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; &lt;1&gt; is interchangeable with &lt;F1&gt;, &lt;2&gt; with &lt;F2&gt;, etc.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; Legend: [*] built-in  [ ] excluded  &lt;M&gt; module  &lt; &gt; module capable.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; &lt;Esc&gt; always leaves the current window</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
<span class="n">radiolist_instructions</span><span class="p">[]</span> <span class="o">=</span> <span class="n">N_</span><span class="p">(</span>
<span class="s">&quot; Use the arrow keys to navigate this window or</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; press the hotkey of the item you wish to select</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; followed by the &lt;SPACE BAR&gt;.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; Press &lt;?&gt;, &lt;F1&gt; or &lt;h&gt; for additional information about this option.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
<span class="n">inputbox_instructions_int</span><span class="p">[]</span> <span class="o">=</span> <span class="n">N_</span><span class="p">(</span>
<span class="s">&quot;Please enter a decimal value.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Fractions will not be accepted.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Press &lt;RETURN&gt; to accept, &lt;ESC&gt; to cancel.&quot;</span><span class="p">),</span>
<span class="n">inputbox_instructions_hex</span><span class="p">[]</span> <span class="o">=</span> <span class="n">N_</span><span class="p">(</span>
<span class="s">&quot;Please enter a hexadecimal value.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Press &lt;RETURN&gt; to accept, &lt;ESC&gt; to cancel.&quot;</span><span class="p">),</span>
<span class="n">inputbox_instructions_string</span><span class="p">[]</span> <span class="o">=</span> <span class="n">N_</span><span class="p">(</span>
<span class="s">&quot;Please enter a string value.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Press &lt;RETURN&gt; to accept, &lt;ESC&gt; to cancel.&quot;</span><span class="p">),</span>
<span class="n">setmod_text</span><span class="p">[]</span> <span class="o">=</span> <span class="n">N_</span><span class="p">(</span>
<span class="s">&quot;This feature depends on another which</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;has been configured as a module.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;As a result, this feature will be built as a module.&quot;</span><span class="p">),</span>
<span class="n">load_config_text</span><span class="p">[]</span> <span class="o">=</span> <span class="n">N_</span><span class="p">(</span>
<span class="s">&quot;Enter the name of the configuration file you wish to load.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Accept the name shown to restore the configuration you</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;last retrieved.  Leave blank to abort.&quot;</span><span class="p">),</span>
<span class="n">load_config_help</span><span class="p">[]</span> <span class="o">=</span> <span class="n">N_</span><span class="p">(</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;For various reasons, one may wish to keep several different</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;configurations available on a single machine.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;If you have saved a previous configuration in a file other than the</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;default one, entering its name here will allow you to modify that</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;configuration.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;If you are uncertain, then you have probably never used alternate</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;configuration files.  You should therefor leave this blank to abort.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
<span class="n">save_config_text</span><span class="p">[]</span> <span class="o">=</span> <span class="n">N_</span><span class="p">(</span>
<span class="s">&quot;Enter a filename to which this configuration should be saved</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;as an alternate.  Leave blank to abort.&quot;</span><span class="p">),</span>
<span class="n">save_config_help</span><span class="p">[]</span> <span class="o">=</span> <span class="n">N_</span><span class="p">(</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;For various reasons, one may wish to keep different configurations</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;available on a single machine.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Entering a file name here will allow you to later retrieve, modify</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;and use the current configuration as an alternate to whatever</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;configuration options you have selected at that time.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;If you are uncertain what all this means then you should probably</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;leave this blank.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
<span class="n">search_help</span><span class="p">[]</span> <span class="o">=</span> <span class="n">N_</span><span class="p">(</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Search for symbols and display their relations. Regular expressions</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;are allowed.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Example: search for </span><span class="se">\&quot;</span><span class="s">^FOO</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
<span class="s">&quot;Result:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;-----------------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Symbol: FOO [ = m]</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Prompt: Foo bus is used to drive the bar HW</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Defined at drivers/pci/Kconfig:47</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Depends on: X86_LOCAL_APIC &amp;&amp; X86_IO_APIC || IA64</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Location:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  -&gt; Bus options (PCI, PCMCIA, EISA, ISA)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    -&gt; PCI support (PCI [ = y])</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;      -&gt; PCI access mode (&lt;choice&gt; [ = y])</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Selects: LIBCRC32</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Selected by: BAR</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;-----------------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o The line &#39;Prompt:&#39; shows the text used in the menu structure for</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  this symbol</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o The &#39;Defined at&#39; line tell at what file / line number the symbol</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  is defined</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o The &#39;Depends on:&#39; line tell what symbols needs to be defined for</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  this symbol to be visible in the menu (selectable)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o The &#39;Location:&#39; lines tell where in the menu structure this symbol</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  is located</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    A location followed by a [ = y] indicate that this is a selectable</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    menu item - and current value is displayed inside brackets.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o The &#39;Selects:&#39; line tell what symbol will be automatically</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  selected if this symbol is selected (y or m)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o The &#39;Selected by&#39; line tell what symbol has selected this symbol</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Only relevant lines are shown.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span>
<span class="s">&quot;Search examples:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Examples: USB  =&gt; find all symbols containing USB</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;          ^USB =&gt; find all symbols starting with USB</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;          USB$ =&gt; find all symbols ending with USB</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">mitem</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">tag</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">usrptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_visible</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define MAX_MENU_ITEMS 4096</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">show_all_items</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">indent</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_menu</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">child_count</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">single_menu_mode</span><span class="p">;</span>
<span class="cm">/* the window in which all information appears */</span>
<span class="k">static</span> <span class="n">WINDOW</span> <span class="o">*</span><span class="n">main_window</span><span class="p">;</span>
<span class="cm">/* the largest size of the menu window */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mwin_max_lines</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mwin_max_cols</span><span class="p">;</span>
<span class="cm">/* the window in which we show option buttons */</span>
<span class="k">static</span> <span class="n">MENU</span> <span class="o">*</span><span class="n">curses_menu</span><span class="p">;</span>
<span class="k">static</span> <span class="n">ITEM</span> <span class="o">*</span><span class="n">curses_menu_items</span><span class="p">[</span><span class="n">MAX_MENU_ITEMS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mitem</span> <span class="n">k_menu_items</span><span class="p">[</span><span class="n">MAX_MENU_ITEMS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">items_num</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">global_exit</span><span class="p">;</span>
<span class="cm">/* the currently selected button */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">current_instructions</span> <span class="o">=</span> <span class="n">menu_instructions</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dialog_input_result</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dialog_input_result_len</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">conf_choice</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">conf_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">conf_load</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">conf_save</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">show_help</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">setup_windows</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">search_conf</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">function_key_handler_t</span><span class="p">)(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_f1</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_f2</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_f3</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_f4</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_f5</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_f6</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_f7</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_f8</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_f9</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">function_keys</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key_str</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="n">function_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">function_key_handler_t</span> <span class="n">handler</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">function_keys_num</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">function_keys</span> <span class="n">function_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">key_str</span> <span class="o">=</span> <span class="s">&quot;F1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="s">&quot;Help&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">F_HELP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handle_f1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">key_str</span> <span class="o">=</span> <span class="s">&quot;F2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="s">&quot;Sym Info&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">F_SYMBOL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handle_f2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">key_str</span> <span class="o">=</span> <span class="s">&quot;F3&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="s">&quot;Insts&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">F_INSTS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handle_f3</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">key_str</span> <span class="o">=</span> <span class="s">&quot;F4&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="s">&quot;Config&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">F_CONF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handle_f4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">key_str</span> <span class="o">=</span> <span class="s">&quot;F5&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="s">&quot;Back&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">F_BACK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handle_f5</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">key_str</span> <span class="o">=</span> <span class="s">&quot;F6&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="s">&quot;Save&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">F_SAVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handle_f6</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">key_str</span> <span class="o">=</span> <span class="s">&quot;F7&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="s">&quot;Load&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">F_LOAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handle_f7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">key_str</span> <span class="o">=</span> <span class="s">&quot;F8&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="s">&quot;Sym Search&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">F_SEARCH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handle_f8</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">key_str</span> <span class="o">=</span> <span class="s">&quot;F9&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="s">&quot;Exit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">F_EXIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handle_f9</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_function_line</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">function_keys_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">wattrset</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="n">FUNCTION_HIGHLIGHT</span><span class="p">]);</span>
		<span class="n">mvwprintw</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">LINES</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
				<span class="s">&quot;%s&quot;</span><span class="p">,</span>
				<span class="n">function_keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_str</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">wattrset</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="n">FUNCTION_TEXT</span><span class="p">]);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">function_keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_str</span><span class="p">);</span>
		<span class="n">mvwprintw</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">LINES</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span>
				<span class="n">offset</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
				<span class="n">function_keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">func</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">function_keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">func</span><span class="p">)</span> <span class="o">+</span> <span class="n">skip</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">wattrset</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="n">NORMAL</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* help */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_f1</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_scroll_win</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
			<span class="n">_</span><span class="p">(</span><span class="s">&quot;README&quot;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="n">nconf_readme</span><span class="p">));</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* symbole help */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_f2</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_help</span><span class="p">(</span><span class="n">current_item</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* instructions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_f3</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_scroll_win</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
			<span class="n">_</span><span class="p">(</span><span class="s">&quot;Instructions&quot;</span><span class="p">),</span>
			<span class="n">_</span><span class="p">(</span><span class="n">current_instructions</span><span class="p">));</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* config */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_f4</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">btn_dialog</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
			<span class="n">_</span><span class="p">(</span><span class="s">&quot;Show all symbols?&quot;</span><span class="p">),</span>
			<span class="mi">2</span><span class="p">,</span>
			<span class="s">&quot;   &lt;Show All&gt;   &quot;</span><span class="p">,</span>
			<span class="s">&quot;&lt;Don&#39;t show all&gt;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">show_all_items</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">show_all_items</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* back */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_f5</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">KEY_LEFT</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* save */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_f6</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">conf_save</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* load */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_f7</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">conf_load</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* search */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_f8</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">search_conf</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* exit */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_f9</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">current_item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_exit</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return != 0 to indicate the key was handles */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_special_keys</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">key</span> <span class="o">==</span> <span class="n">KEY_RESIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">setup_windows</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">function_keys_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">key</span> <span class="o">==</span> <span class="n">KEY_F</span><span class="p">(</span><span class="n">function_keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">*</span><span class="n">key</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="n">function_keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key</span><span class="p">){</span>
			<span class="n">function_keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handler</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">menu</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clean_items</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">curses_menu_items</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">free_item</span><span class="p">(</span><span class="n">curses_menu_items</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">bzero</span><span class="p">(</span><span class="n">curses_menu_items</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">curses_menu_items</span><span class="p">));</span>
	<span class="n">bzero</span><span class="p">(</span><span class="n">k_menu_items</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">k_menu_items</span><span class="p">));</span>
	<span class="n">items_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span><span class="n">MATCH_TINKER_PATTERN_UP</span><span class="p">,</span> <span class="n">MATCH_TINKER_PATTERN_DOWN</span><span class="p">,</span>
	<span class="n">FIND_NEXT_MATCH_DOWN</span><span class="p">,</span> <span class="n">FIND_NEXT_MATCH_UP</span><span class="p">}</span> <span class="n">match_f</span><span class="p">;</span>

<span class="cm">/* return the index of the matched item, or -1 if no such item exists */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_mext_match</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">match_str</span><span class="p">,</span> <span class="n">match_f</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">match_start</span> <span class="o">=</span> <span class="n">item_index</span><span class="p">(</span><span class="n">current_item</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">FIND_NEXT_MATCH_DOWN</span><span class="p">)</span>
		<span class="o">++</span><span class="n">match_start</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">FIND_NEXT_MATCH_UP</span><span class="p">)</span>
		<span class="o">--</span><span class="n">match_start</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">match_start</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">items_num</span><span class="p">)</span> <span class="o">%</span> <span class="n">items_num</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">k_menu_items</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">str</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcasestr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">match_str</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">FIND_NEXT_MATCH_UP</span> <span class="o">||</span>
		    <span class="n">flag</span> <span class="o">==</span> <span class="n">MATCH_TINKER_PATTERN_UP</span><span class="p">)</span>
			<span class="o">--</span><span class="n">index</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">++</span><span class="n">index</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">items_num</span><span class="p">)</span> <span class="o">%</span> <span class="n">items_num</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">match_start</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Make a new item. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">item_make</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">,</span> <span class="kt">char</span> <span class="n">tag</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">items_num</span> <span class="o">&gt;</span> <span class="n">MAX_MENU_ITEMS</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">k_menu_items</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">k_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">].</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">k_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">].</span><span class="n">usrptr</span> <span class="o">=</span> <span class="n">menu</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">menu</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">k_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">].</span><span class="n">is_visible</span> <span class="o">=</span>
			<span class="n">menu_is_visible</span><span class="p">(</span><span class="n">menu</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">k_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">].</span><span class="n">is_visible</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vsnprintf</span><span class="p">(</span><span class="n">k_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">].</span><span class="n">str</span><span class="p">,</span>
		  <span class="k">sizeof</span><span class="p">(</span><span class="n">k_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">].</span><span class="n">str</span><span class="p">),</span>
		  <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">k_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">].</span><span class="n">is_visible</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">k_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">].</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;XXX&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">curses_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_item</span><span class="p">(</span>
			<span class="n">k_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">].</span><span class="n">str</span><span class="p">,</span>
			<span class="n">k_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">].</span><span class="n">str</span><span class="p">);</span>
	<span class="n">set_item_userptr</span><span class="p">(</span><span class="n">curses_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">k_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">]);</span>
	<span class="cm">/*</span>
<span class="cm">	if (!k_menu_items[items_num].is_visible)</span>
<span class="cm">		item_opts_off(curses_menu_items[items_num], O_SELECTABLE);</span>
<span class="cm">	*/</span>

	<span class="n">items_num</span><span class="o">++</span><span class="p">;</span>
	<span class="n">curses_menu_items</span><span class="p">[</span><span class="n">items_num</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* very hackish. adds a string to the last item added */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">item_add_str</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">items_num</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">new_str</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">tmp_str</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vsnprintf</span><span class="p">(</span><span class="n">new_str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_str</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">tmp_str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp_str</span><span class="p">),</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span>
			<span class="n">k_menu_items</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">str</span><span class="p">,</span> <span class="n">new_str</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">k_menu_items</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">str</span><span class="p">,</span>
		<span class="n">tmp_str</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">k_menu_items</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">str</span><span class="p">));</span>

	<span class="n">free_item</span><span class="p">(</span><span class="n">curses_menu_items</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
	<span class="n">curses_menu_items</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_item</span><span class="p">(</span>
			<span class="n">k_menu_items</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">str</span><span class="p">,</span>
			<span class="n">k_menu_items</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">str</span><span class="p">);</span>
	<span class="n">set_item_userptr</span><span class="p">(</span><span class="n">curses_menu_items</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">k_menu_items</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* get the tag of the currently selected item */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="nf">item_tag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ITEM</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mitem</span> <span class="o">*</span><span class="n">mcur</span><span class="p">;</span>

	<span class="n">cur</span> <span class="o">=</span> <span class="n">current_item</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcur</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mitem</span> <span class="o">*</span><span class="p">)</span> <span class="n">item_userptr</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mcur</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">curses_item_index</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>  <span class="n">item_index</span><span class="p">(</span><span class="n">current_item</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">item_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ITEM</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mitem</span> <span class="o">*</span><span class="n">mcur</span><span class="p">;</span>

	<span class="n">cur</span> <span class="o">=</span> <span class="n">current_item</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mcur</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mitem</span> <span class="o">*</span><span class="p">)</span> <span class="n">item_userptr</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mcur</span><span class="o">-&gt;</span><span class="n">usrptr</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">item_is_tag</span><span class="p">(</span><span class="kt">char</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">item_tag</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">menu_backtitle</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="o">+</span><span class="mi">128</span><span class="p">];</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">set_config_filename</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">config_filename</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">menu_backtitle</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">menu_backtitle</span><span class="p">),</span>
			<span class="s">&quot;%s - %s&quot;</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">,</span> <span class="n">rootmenu</span><span class="p">.</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">menu_backtitle</span><span class="p">))</span>
		<span class="n">menu_backtitle</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">menu_backtitle</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
		<span class="n">filename</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">menu_backtitle</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return = 0 means we are successful.</span>
<span class="cm"> * -1 means go on doing what you were doing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf_get_changed</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">global_exit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">btn_dialog</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
			<span class="n">_</span><span class="p">(</span><span class="s">&quot;Do you wish to save your new configuration?</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;&lt;ESC&gt; to cancel and resume nconfig.&quot;</span><span class="p">),</span>
			<span class="mi">2</span><span class="p">,</span>
			<span class="s">&quot;   &lt;save&gt;   &quot;</span><span class="p">,</span>
			<span class="s">&quot;&lt;don&#39;t save&gt;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">KEY_EXIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">global_exit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if we got here, the user really wants to exit */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">conf_write</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="n">btn_dialog</span><span class="p">(</span>
				<span class="n">main_window</span><span class="p">,</span>
				<span class="n">_</span><span class="p">(</span><span class="s">&quot;Error during writing of configuration.</span><span class="se">\n</span><span class="s">&quot;</span>
				  <span class="s">&quot;Your configuration changes were NOT saved.&quot;</span><span class="p">),</span>
				  <span class="mi">1</span><span class="p">,</span>
				  <span class="s">&quot;&lt;OK&gt;&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">btn_dialog</span><span class="p">(</span>
			<span class="n">main_window</span><span class="p">,</span>
			<span class="n">_</span><span class="p">(</span><span class="s">&quot;Your configuration changes were NOT saved.&quot;</span><span class="p">),</span>
			<span class="mi">1</span><span class="p">,</span>
			<span class="s">&quot;&lt;OK&gt;&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">global_exit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">search_conf</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">**</span><span class="n">sym_arr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gstr</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dialog_input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dres</span><span class="p">;</span>
<span class="nl">again:</span>
	<span class="n">dres</span> <span class="o">=</span> <span class="n">dialog_inputbox</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
			<span class="n">_</span><span class="p">(</span><span class="s">&quot;Search Configuration Parameter&quot;</span><span class="p">),</span>
			<span class="n">_</span><span class="p">(</span><span class="s">&quot;Enter &quot;</span> <span class="n">CONFIG_</span> <span class="s">&quot; (sub)string to search for &quot;</span>
				<span class="s">&quot;(with or without </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="n">CONFIG_</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">)&quot;</span><span class="p">),</span>
			<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dialog_input_result</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dialog_input_result_len</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dres</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">show_scroll_win</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
				<span class="n">_</span><span class="p">(</span><span class="s">&quot;Search Configuration&quot;</span><span class="p">),</span> <span class="n">search_help</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* strip the prefix if necessary */</span>
	<span class="n">dialog_input</span> <span class="o">=</span> <span class="n">dialog_input_result</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncasecmp</span><span class="p">(</span><span class="n">dialog_input_result</span><span class="p">,</span> <span class="n">CONFIG_</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">CONFIG_</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dialog_input</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">CONFIG_</span><span class="p">);</span>

	<span class="n">sym_arr</span> <span class="o">=</span> <span class="n">sym_re_search</span><span class="p">(</span><span class="n">dialog_input</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">get_relations_str</span><span class="p">(</span><span class="n">sym_arr</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">sym_arr</span><span class="p">);</span>
	<span class="n">show_scroll_win</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
			<span class="n">_</span><span class="p">(</span><span class="s">&quot;Search Results&quot;</span><span class="p">),</span> <span class="n">str_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">));</span>
	<span class="n">str_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">doint</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">tristate</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">menu</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">show_all_items</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">menu_is_visible</span><span class="p">(</span><span class="n">menu</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sym</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">;</span>
	<span class="n">prop</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sym</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prop</span> <span class="o">&amp;&amp;</span> <span class="n">menu</span> <span class="o">!=</span> <span class="n">current_menu</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">menu_get_prompt</span><span class="p">(</span><span class="n">menu</span><span class="p">);</span>
			<span class="k">enum</span> <span class="n">prop_type</span> <span class="n">ptype</span><span class="p">;</span>
			<span class="n">ptype</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span> <span class="o">?</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">:</span> <span class="n">P_UNKNOWN</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ptype</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">P_MENU</span>:
				<span class="n">child_count</span><span class="o">++</span><span class="p">;</span>
				<span class="n">prompt</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="n">prompt</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">single_menu_mode</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="sc">&#39;m&#39;</span><span class="p">,</span>
						<span class="s">&quot;%s%*c%s&quot;</span><span class="p">,</span>
						<span class="n">menu</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">?</span> <span class="s">&quot;--&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot;++&gt;&quot;</span><span class="p">,</span>
						<span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="n">prompt</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="sc">&#39;m&#39;</span><span class="p">,</span>
						<span class="s">&quot;   %*c%s  ---&gt;&quot;</span><span class="p">,</span>
						<span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
						<span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="n">prompt</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">single_menu_mode</span> <span class="o">&amp;&amp;</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">conf_childs</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">P_COMMENT</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">child_count</span><span class="o">++</span><span class="p">;</span>
					<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">,</span>
						<span class="s">&quot;   %*c*** %s ***&quot;</span><span class="p">,</span>
						<span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
						<span class="n">_</span><span class="p">(</span><span class="n">prompt</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">child_count</span><span class="o">++</span><span class="p">;</span>
					<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">,</span> <span class="s">&quot;---%*c%s&quot;</span><span class="p">,</span>
						<span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
						<span class="n">_</span><span class="p">(</span><span class="n">prompt</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">doint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">conf_childs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">sym_get_type</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sym_is_choice</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">def_sym</span> <span class="o">=</span> <span class="n">sym_get_choice_value</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">def_menu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">child_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">child</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span> <span class="n">child</span><span class="p">;</span> <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">menu_is_visible</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">==</span> <span class="n">def_sym</span><span class="p">)</span>
				<span class="n">def_menu</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">sym_get_tristate_value</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sym_is_changable</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">S_BOOLEAN</span>:
				<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="s">&quot;[%c]&quot;</span><span class="p">,</span>
						<span class="n">val</span> <span class="o">==</span> <span class="n">no</span> <span class="o">?</span> <span class="sc">&#39; &#39;</span> <span class="o">:</span> <span class="sc">&#39;*&#39;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">S_TRISTATE</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">yes</span>:
					<span class="n">ch</span> <span class="o">=</span> <span class="sc">&#39;*&#39;</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">mod</span>:
					<span class="n">ch</span> <span class="o">=</span> <span class="sc">&#39;M&#39;</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">ch</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="s">&quot;&lt;%c&gt;&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="n">def_menu</span> <span class="o">?</span> <span class="sc">&#39;t&#39;</span> <span class="o">:</span> <span class="sc">&#39;:&#39;</span><span class="p">,</span> <span class="s">&quot;   &quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">item_add_str</span><span class="p">(</span><span class="s">&quot;%*c%s&quot;</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="n">menu_get_prompt</span><span class="p">(</span><span class="n">menu</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">yes</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">def_menu</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">item_add_str</span><span class="p">(</span><span class="s">&quot; (%s)&quot;</span><span class="p">,</span>
					<span class="n">_</span><span class="p">(</span><span class="n">menu_get_prompt</span><span class="p">(</span><span class="n">def_menu</span><span class="p">)));</span>
				<span class="n">item_add_str</span><span class="p">(</span><span class="s">&quot;  ---&gt;&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">def_menu</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">indent</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">build_conf</span><span class="p">(</span><span class="n">def_menu</span><span class="p">);</span>
					<span class="n">indent</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">menu</span> <span class="o">==</span> <span class="n">current_menu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">,</span>
				<span class="s">&quot;---%*c%s&quot;</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="n">menu_get_prompt</span><span class="p">(</span><span class="n">menu</span><span class="p">)));</span>
			<span class="k">goto</span> <span class="n">conf_childs</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">child_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">sym_get_tristate_value</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sym_is_choice_value</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">==</span> <span class="n">yes</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">,</span> <span class="s">&quot;   &quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">S_BOOLEAN</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">sym_is_changable</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span>
					<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="s">&quot;[%c]&quot;</span><span class="p">,</span>
						<span class="n">val</span> <span class="o">==</span> <span class="n">no</span> <span class="o">?</span> <span class="sc">&#39; &#39;</span> <span class="o">:</span> <span class="sc">&#39;*&#39;</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="s">&quot;-%c-&quot;</span><span class="p">,</span>
						<span class="n">val</span> <span class="o">==</span> <span class="n">no</span> <span class="o">?</span> <span class="sc">&#39; &#39;</span> <span class="o">:</span> <span class="sc">&#39;*&#39;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">S_TRISTATE</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">yes</span>:
					<span class="n">ch</span> <span class="o">=</span> <span class="sc">&#39;*&#39;</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">mod</span>:
					<span class="n">ch</span> <span class="o">=</span> <span class="sc">&#39;M&#39;</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">ch</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sym_is_changable</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">rev_dep</span><span class="p">.</span><span class="n">tri</span> <span class="o">==</span> <span class="n">mod</span><span class="p">)</span>
						<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span>
							<span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="s">&quot;{%c}&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span>
							<span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="s">&quot;&lt;%c&gt;&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="s">&quot;-%c-&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sym_get_string_value</span><span class="p">(</span><span class="n">sym</span><span class="p">));</span>
				<span class="n">item_make</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="sc">&#39;s&#39;</span><span class="p">,</span> <span class="s">&quot;    (%s)&quot;</span><span class="p">,</span>
						<span class="n">sym_get_string_value</span><span class="p">(</span><span class="n">sym</span><span class="p">));</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">-</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">item_add_str</span><span class="p">(</span><span class="s">&quot;%*c%s%s&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
						<span class="n">_</span><span class="p">(</span><span class="n">menu_get_prompt</span><span class="p">(</span><span class="n">menu</span><span class="p">)),</span>
						<span class="p">(</span><span class="n">sym_has_value</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">||</span>
						 <span class="o">!</span><span class="n">sym_is_changable</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span>
						<span class="n">_</span><span class="p">(</span><span class="s">&quot; (NEW)&quot;</span><span class="p">));</span>
				<span class="k">goto</span> <span class="n">conf_childs</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">item_add_str</span><span class="p">(</span><span class="s">&quot;%*c%s%s&quot;</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
				<span class="n">_</span><span class="p">(</span><span class="n">menu_get_prompt</span><span class="p">(</span><span class="n">menu</span><span class="p">)),</span>
				<span class="p">(</span><span class="n">sym_has_value</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">sym_is_changable</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span> <span class="o">?</span>
				<span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot; (NEW)&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span> <span class="o">&amp;&amp;</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">P_MENU</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">item_add_str</span><span class="p">(</span><span class="s">&quot;  ---&gt;&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">conf_childs:</span>
	<span class="n">indent</span> <span class="o">+=</span> <span class="n">doint</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">child</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span> <span class="n">child</span><span class="p">;</span> <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">build_conf</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="n">indent</span> <span class="o">-=</span> <span class="n">doint</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_menu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unpost_menu</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">);</span>
	<span class="n">clean_items</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* adjust the menu to show this item.</span>
<span class="cm"> * prefer not to scroll the menu if possible*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">center_item</span><span class="p">(</span><span class="kt">int</span> <span class="n">selected_index</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">last_top_row</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">toprow</span><span class="p">;</span>

	<span class="n">set_top_row</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="o">*</span><span class="n">last_top_row</span><span class="p">);</span>
	<span class="n">toprow</span> <span class="o">=</span> <span class="n">top_row</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">selected_index</span> <span class="o">&lt;</span> <span class="n">toprow</span> <span class="o">||</span>
	    <span class="n">selected_index</span> <span class="o">&gt;=</span> <span class="n">toprow</span><span class="o">+</span><span class="n">mwin_max_lines</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">toprow</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">selected_index</span><span class="o">-</span><span class="n">mwin_max_lines</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">toprow</span> <span class="o">&gt;=</span> <span class="n">item_count</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">)</span><span class="o">-</span><span class="n">mwin_max_lines</span><span class="p">)</span>
			<span class="n">toprow</span> <span class="o">=</span> <span class="n">item_count</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">)</span><span class="o">-</span><span class="n">mwin_max_lines</span><span class="p">;</span>
		<span class="n">set_top_row</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">toprow</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_current_item</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span>
			<span class="n">curses_menu_items</span><span class="p">[</span><span class="n">selected_index</span><span class="p">]);</span>
	<span class="o">*</span><span class="n">last_top_row</span> <span class="o">=</span> <span class="n">toprow</span><span class="p">;</span>
	<span class="n">post_menu</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">);</span>
	<span class="n">refresh_all_windows</span><span class="p">(</span><span class="n">main_window</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function assumes reset_menu has been called before */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_menu</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">instructions</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">selected_index</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">last_top_row</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">;</span>
	<span class="n">WINDOW</span> <span class="o">*</span><span class="n">menu_window</span><span class="p">;</span>

	<span class="n">current_instructions</span> <span class="o">=</span> <span class="n">instructions</span><span class="p">;</span>

	<span class="n">clear</span><span class="p">();</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">wattrset</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="n">NORMAL</span><span class="p">]);</span>
	<span class="n">print_in_middle</span><span class="p">(</span><span class="n">stdscr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">COLS</span><span class="p">,</span>
			<span class="n">menu_backtitle</span><span class="p">,</span>
			<span class="n">attributes</span><span class="p">[</span><span class="n">MAIN_HEADING</span><span class="p">]);</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">wattrset</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="n">MAIN_MENU_BOX</span><span class="p">]);</span>
	<span class="n">box</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">wattrset</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="n">MAIN_MENU_HEADING</span><span class="p">]);</span>
	<span class="n">mvwprintw</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot; %s &quot;</span><span class="p">,</span> <span class="n">prompt</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">wattrset</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="n">NORMAL</span><span class="p">]);</span>

	<span class="n">set_menu_items</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">curses_menu_items</span><span class="p">);</span>

	<span class="cm">/* position the menu at the middle of the screen */</span>
	<span class="n">scale_menu</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maxy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maxx</span><span class="p">);</span>
	<span class="n">maxx</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">maxx</span><span class="p">,</span> <span class="n">mwin_max_cols</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">maxy</span> <span class="o">=</span> <span class="n">mwin_max_lines</span><span class="p">;</span>
	<span class="n">menu_window</span> <span class="o">=</span> <span class="n">derwin</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
			<span class="n">maxy</span><span class="p">,</span>
			<span class="n">maxx</span><span class="p">,</span>
			<span class="mi">2</span><span class="p">,</span>
			<span class="p">(</span><span class="n">mwin_max_cols</span><span class="o">-</span><span class="n">maxx</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">keypad</span><span class="p">(</span><span class="n">menu_window</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
	<span class="n">set_menu_win</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">menu_window</span><span class="p">);</span>
	<span class="n">set_menu_sub</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">menu_window</span><span class="p">);</span>

	<span class="cm">/* must reassert this after changing items, otherwise returns to a</span>
<span class="cm">	 * default of 16</span>
<span class="cm">	 */</span>
	<span class="n">set_menu_format</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">center_item</span><span class="p">(</span><span class="n">selected_index</span><span class="p">,</span> <span class="n">last_top_row</span><span class="p">);</span>
	<span class="n">set_menu_format</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">print_function_line</span><span class="p">();</span>

	<span class="cm">/* Post the menu */</span>
	<span class="n">post_menu</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">);</span>
	<span class="n">refresh_all_windows</span><span class="p">(</span><span class="n">main_window</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">adj_match_dir</span><span class="p">(</span><span class="n">match_f</span> <span class="o">*</span><span class="n">match_direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">match_direction</span> <span class="o">==</span> <span class="n">FIND_NEXT_MATCH_DOWN</span><span class="p">)</span>
		<span class="o">*</span><span class="n">match_direction</span> <span class="o">=</span>
			<span class="n">MATCH_TINKER_PATTERN_DOWN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">match_direction</span> <span class="o">==</span> <span class="n">FIND_NEXT_MATCH_UP</span><span class="p">)</span>
		<span class="o">*</span><span class="n">match_direction</span> <span class="o">=</span>
			<span class="n">MATCH_TINKER_PATTERN_UP</span><span class="p">;</span>
	<span class="cm">/* else, do no change.. */</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">match_state</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">in_search</span><span class="p">;</span>
	<span class="n">match_f</span> <span class="n">match_direction</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">pattern</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Return 0 means I have handled the key. In such a case, ans should hold the</span>
<span class="cm"> * item to center, or -1 otherwise.</span>
<span class="cm"> * Else return -1 .</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_match</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">match_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ans</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">terminate_search</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ans</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">in_search</span> <span class="o">&amp;&amp;</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">27</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">move</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">refresh</span><span class="p">();</span>
		<span class="n">clrtoeol</span><span class="p">();</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">in_search</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">in_search</span><span class="p">;</span>
		<span class="n">bzero</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">));</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">match_direction</span> <span class="o">=</span> <span class="n">MATCH_TINKER_PATTERN_DOWN</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">in_search</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isalnum</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">||</span> <span class="n">isgraph</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">)]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">)]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">adj_match_dir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">match_direction</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ans</span> <span class="o">=</span> <span class="n">get_mext_match</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">,</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">match_direction</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">KEY_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">match_direction</span> <span class="o">=</span> <span class="n">FIND_NEXT_MATCH_DOWN</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ans</span> <span class="o">=</span> <span class="n">get_mext_match</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">,</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">match_direction</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">KEY_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">match_direction</span> <span class="o">=</span> <span class="n">FIND_NEXT_MATCH_UP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ans</span> <span class="o">=</span> <span class="n">get_mext_match</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">,</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">match_direction</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">KEY_BACKSPACE</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">adj_match_dir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">match_direction</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">terminate_search</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">terminate_search</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">in_search</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bzero</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">));</span>
		<span class="n">move</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">refresh</span><span class="p">();</span>
		<span class="n">clrtoeol</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">submenu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">menu_get_prompt</span><span class="p">(</span><span class="n">menu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">current_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_top_row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">match_state</span> <span class="n">match_state</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">in_search</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">match_direction</span> <span class="o">=</span> <span class="n">MATCH_TINKER_PATTERN_DOWN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">global_exit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_menu</span><span class="p">();</span>
		<span class="n">current_menu</span> <span class="o">=</span> <span class="n">menu</span><span class="p">;</span>
		<span class="n">build_conf</span><span class="p">(</span><span class="n">menu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child_count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">show_menu</span><span class="p">(</span><span class="n">prompt</span> <span class="o">?</span> <span class="n">_</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="o">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Main Menu&quot;</span><span class="p">),</span>
				<span class="n">_</span><span class="p">(</span><span class="n">menu_instructions</span><span class="p">),</span>
				<span class="n">current_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">last_top_row</span><span class="p">);</span>
		<span class="n">keypad</span><span class="p">((</span><span class="n">menu_win</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">)),</span> <span class="n">TRUE</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">global_exit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">match_state</span><span class="p">.</span><span class="n">in_search</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mvprintw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;searching: %s&quot;</span><span class="p">,</span> <span class="n">match_state</span><span class="p">.</span><span class="n">pattern</span><span class="p">);</span>
				<span class="n">clrtoeol</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="n">refresh_all_windows</span><span class="p">(</span><span class="n">main_window</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">wgetch</span><span class="p">(</span><span class="n">menu_win</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">do_match</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">current_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">center_item</span><span class="p">(</span><span class="n">current_index</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">last_top_row</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">process_special_keys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
						<span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="p">)</span> <span class="n">item_data</span><span class="p">()))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">KEY_DOWN</span>:
				<span class="n">menu_driver</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">REQ_DOWN_ITEM</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KEY_UP</span>:
				<span class="n">menu_driver</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">REQ_UP_ITEM</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KEY_NPAGE</span>:
				<span class="n">menu_driver</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">REQ_SCR_DPAGE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KEY_PPAGE</span>:
				<span class="n">menu_driver</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">REQ_SCR_UPAGE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KEY_HOME</span>:
				<span class="n">menu_driver</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">REQ_FIRST_ITEM</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KEY_END</span>:
				<span class="n">menu_driver</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">REQ_LAST_ITEM</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;h&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
				<span class="n">show_help</span><span class="p">((</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="p">)</span> <span class="n">item_data</span><span class="p">());</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">||</span> <span class="n">res</span> <span class="o">==</span> <span class="mi">27</span> <span class="o">||</span>
				<span class="n">res</span> <span class="o">==</span> <span class="mi">32</span> <span class="o">||</span> <span class="n">res</span> <span class="o">==</span> <span class="sc">&#39;n&#39;</span> <span class="o">||</span> <span class="n">res</span> <span class="o">==</span> <span class="sc">&#39;y&#39;</span> <span class="o">||</span>
				<span class="n">res</span> <span class="o">==</span> <span class="n">KEY_LEFT</span> <span class="o">||</span> <span class="n">res</span> <span class="o">==</span> <span class="n">KEY_RIGHT</span> <span class="o">||</span>
				<span class="n">res</span> <span class="o">==</span> <span class="sc">&#39;m&#39;</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">refresh_all_windows</span><span class="p">(</span><span class="n">main_window</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">refresh_all_windows</span><span class="p">(</span><span class="n">main_window</span><span class="p">);</span>
		<span class="cm">/* if ESC or left*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">27</span> <span class="o">||</span> <span class="p">(</span><span class="n">menu</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">rootmenu</span> <span class="o">&amp;&amp;</span> <span class="n">res</span> <span class="o">==</span> <span class="n">KEY_LEFT</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* remember location in the menu */</span>
		<span class="n">last_top_row</span> <span class="o">=</span> <span class="n">top_row</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">);</span>
		<span class="n">current_index</span> <span class="o">=</span> <span class="n">curses_item_index</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item_tag</span><span class="p">())</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">submenu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="p">)</span> <span class="n">item_data</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">submenu</span> <span class="o">||</span> <span class="o">!</span><span class="n">menu_is_visible</span><span class="p">(</span><span class="n">submenu</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sym</span> <span class="o">=</span> <span class="n">submenu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39; &#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">item_is_tag</span><span class="p">(</span><span class="sc">&#39;t&#39;</span><span class="p">))</span>
				<span class="n">sym_toggle_tristate_value</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">item_is_tag</span><span class="p">(</span><span class="sc">&#39;m&#39;</span><span class="p">))</span>
				<span class="n">conf</span><span class="p">(</span><span class="n">submenu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KEY_RIGHT</span>:
		<span class="k">case</span> <span class="mi">10</span>: <span class="cm">/* ENTER WAS PRESSED */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">item_tag</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">single_menu_mode</span><span class="p">)</span>
					<span class="n">submenu</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span>
						<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">!</span><span class="n">submenu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">conf</span><span class="p">(</span><span class="n">submenu</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;t&#39;</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">sym_is_choice</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">sym_get_tristate_value</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">==</span> <span class="n">yes</span><span class="p">)</span>
					<span class="n">conf_choice</span><span class="p">(</span><span class="n">submenu</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">submenu</span><span class="o">-&gt;</span><span class="n">prompt</span> <span class="o">&amp;&amp;</span>
					 <span class="n">submenu</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">P_MENU</span><span class="p">)</span>
					<span class="n">conf</span><span class="p">(</span><span class="n">submenu</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
					<span class="n">sym_toggle_tristate_value</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
				<span class="n">conf_string</span><span class="p">(</span><span class="n">submenu</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;y&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">item_is_tag</span><span class="p">(</span><span class="sc">&#39;t&#39;</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sym_set_tristate_value</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">yes</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sym_set_tristate_value</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">mod</span><span class="p">))</span>
					<span class="n">btn_dialog</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">setmod_text</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;n&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">item_is_tag</span><span class="p">(</span><span class="sc">&#39;t&#39;</span><span class="p">))</span>
				<span class="n">sym_set_tristate_value</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">no</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">item_is_tag</span><span class="p">(</span><span class="sc">&#39;t&#39;</span><span class="p">))</span>
				<span class="n">sym_set_tristate_value</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conf_message_callback</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>

	<span class="n">vsnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">btn_dialog</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;&lt;OK&gt;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_help</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gstr</span> <span class="n">help</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">menu</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">help</span> <span class="o">=</span> <span class="n">str_new</span><span class="p">();</span>
	<span class="n">menu_get_ext_help</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">help</span><span class="p">);</span>
	<span class="n">show_scroll_win</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="n">menu_get_prompt</span><span class="p">(</span><span class="n">menu</span><span class="p">)),</span> <span class="n">str_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">help</span><span class="p">));</span>
	<span class="n">str_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">help</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conf_choice</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="n">menu_get_prompt</span><span class="p">(</span><span class="n">menu</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">active</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">selected_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_top_row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">match_state</span> <span class="n">match_state</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">in_search</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">match_direction</span> <span class="o">=</span> <span class="n">MATCH_TINKER_PATTERN_DOWN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">active</span> <span class="o">=</span> <span class="n">sym_get_choice_value</span><span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">);</span>
	<span class="cm">/* this is mostly duplicated from the conf() function. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">global_exit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_menu</span><span class="p">();</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">child</span> <span class="o">=</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span> <span class="n">child</span><span class="p">;</span> <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">show_all_items</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">menu_is_visible</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">==</span> <span class="n">sym_get_choice_value</span><span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">))</span>
				<span class="n">item_make</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">,</span> <span class="s">&quot;&lt;X&gt; %s&quot;</span><span class="p">,</span>
						<span class="n">_</span><span class="p">(</span><span class="n">menu_get_prompt</span><span class="p">(</span><span class="n">child</span><span class="p">)));</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">)</span>
				<span class="n">item_make</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">,</span> <span class="s">&quot;    %s&quot;</span><span class="p">,</span>
						<span class="n">_</span><span class="p">(</span><span class="n">menu_get_prompt</span><span class="p">(</span><span class="n">child</span><span class="p">)));</span>
			<span class="k">else</span>
				<span class="n">item_make</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">,</span> <span class="s">&quot;*** %s ***&quot;</span><span class="p">,</span>
						<span class="n">_</span><span class="p">(</span><span class="n">menu_get_prompt</span><span class="p">(</span><span class="n">child</span><span class="p">)));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">==</span> <span class="n">active</span><span class="p">){</span>
				<span class="n">last_top_row</span> <span class="o">=</span> <span class="n">top_row</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">);</span>
				<span class="n">selected_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">show_menu</span><span class="p">(</span><span class="n">prompt</span> <span class="o">?</span> <span class="n">_</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="o">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Choice Menu&quot;</span><span class="p">),</span>
				<span class="n">_</span><span class="p">(</span><span class="n">radiolist_instructions</span><span class="p">),</span>
				<span class="n">selected_index</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">last_top_row</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">global_exit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">match_state</span><span class="p">.</span><span class="n">in_search</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mvprintw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;searching: %s&quot;</span><span class="p">,</span>
					 <span class="n">match_state</span><span class="p">.</span><span class="n">pattern</span><span class="p">);</span>
				<span class="n">clrtoeol</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="n">refresh_all_windows</span><span class="p">(</span><span class="n">main_window</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">wgetch</span><span class="p">(</span><span class="n">menu_win</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">do_match</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">selected_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">selected_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">center_item</span><span class="p">(</span><span class="n">selected_index</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">last_top_row</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">process_special_keys</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
						<span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="p">)</span> <span class="n">item_data</span><span class="p">()))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">KEY_DOWN</span>:
				<span class="n">menu_driver</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">REQ_DOWN_ITEM</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KEY_UP</span>:
				<span class="n">menu_driver</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">REQ_UP_ITEM</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KEY_NPAGE</span>:
				<span class="n">menu_driver</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">REQ_SCR_DPAGE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KEY_PPAGE</span>:
				<span class="n">menu_driver</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">REQ_SCR_UPAGE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KEY_HOME</span>:
				<span class="n">menu_driver</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">REQ_FIRST_ITEM</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KEY_END</span>:
				<span class="n">menu_driver</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">REQ_LAST_ITEM</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;h&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
				<span class="n">show_help</span><span class="p">((</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="p">)</span> <span class="n">item_data</span><span class="p">());</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">||</span> <span class="n">res</span> <span class="o">==</span> <span class="mi">27</span> <span class="o">||</span> <span class="n">res</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span>
					<span class="n">res</span> <span class="o">==</span> <span class="n">KEY_LEFT</span><span class="p">){</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">refresh_all_windows</span><span class="p">(</span><span class="n">main_window</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* if ESC or left */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">27</span> <span class="o">||</span> <span class="n">res</span> <span class="o">==</span> <span class="n">KEY_LEFT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">item_data</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child</span> <span class="o">||</span> <span class="o">!</span><span class="n">menu_is_visible</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39; &#39;</span>:
		<span class="k">case</span>  <span class="mi">10</span>:
		<span class="k">case</span> <span class="n">KEY_RIGHT</span>:
			<span class="n">sym_set_tristate_value</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">,</span> <span class="n">yes</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;h&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">show_help</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
			<span class="n">active</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KEY_EXIT</span>:
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conf_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">menu</span> <span class="o">*</span><span class="n">menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">menu_get_prompt</span><span class="p">(</span><span class="n">menu</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">heading</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sym_get_type</span><span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">S_INT</span>:
			<span class="n">heading</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="n">inputbox_instructions_int</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">S_HEX</span>:
			<span class="n">heading</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="n">inputbox_instructions_hex</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">S_STRING</span>:
			<span class="n">heading</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="n">inputbox_instructions_string</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">heading</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Internal nconf error!&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">dialog_inputbox</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
				<span class="n">prompt</span> <span class="o">?</span> <span class="n">_</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="o">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Main Menu&quot;</span><span class="p">),</span>
				<span class="n">heading</span><span class="p">,</span>
				<span class="n">sym_get_string_value</span><span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">dialog_input_result</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dialog_input_result_len</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sym_set_string_value</span><span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">,</span>
						<span class="n">dialog_input_result</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">btn_dialog</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
				<span class="n">_</span><span class="p">(</span><span class="s">&quot;You have made an invalid entry.&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">show_help</span><span class="p">(</span><span class="n">menu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KEY_EXIT</span>:
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conf_load</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">dialog_inputbox</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="n">load_config_text</span><span class="p">,</span>
				<span class="n">filename</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dialog_input_result</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dialog_input_result_len</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dialog_input_result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf_read</span><span class="p">(</span><span class="n">dialog_input_result</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">set_config_filename</span><span class="p">(</span><span class="n">dialog_input_result</span><span class="p">);</span>
				<span class="n">sym_set_change_count</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">btn_dialog</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;File does not exist!&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">show_scroll_win</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
					<span class="n">_</span><span class="p">(</span><span class="s">&quot;Load Alternate Configuration&quot;</span><span class="p">),</span>
					<span class="n">load_config_help</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KEY_EXIT</span>:
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conf_save</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">dialog_inputbox</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="n">save_config_text</span><span class="p">,</span>
				<span class="n">filename</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dialog_input_result</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dialog_input_result_len</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dialog_input_result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">conf_write</span><span class="p">(</span><span class="n">dialog_input_result</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_config_filename</span><span class="p">(</span><span class="n">dialog_input_result</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">btn_dialog</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Can&#39;t create file! &quot;</span>
				<span class="s">&quot;Probably a nonexistent directory.&quot;</span><span class="p">),</span>
				<span class="mi">1</span><span class="p">,</span> <span class="s">&quot;&lt;OK&gt;&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">show_scroll_win</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
				<span class="n">_</span><span class="p">(</span><span class="s">&quot;Save Alternate Configuration&quot;</span><span class="p">),</span>
				<span class="n">save_config_help</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KEY_EXIT</span>:
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setup_windows</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">main_window</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">delwin</span><span class="p">(</span><span class="n">main_window</span><span class="p">);</span>

	<span class="cm">/* set up the menu and menu window */</span>
	<span class="n">main_window</span> <span class="o">=</span> <span class="n">newwin</span><span class="p">(</span><span class="n">LINES</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">COLS</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">keypad</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
	<span class="n">mwin_max_lines</span> <span class="o">=</span> <span class="n">LINES</span><span class="o">-</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">mwin_max_cols</span> <span class="o">=</span> <span class="n">COLS</span><span class="o">-</span><span class="mi">6</span><span class="p">;</span>

	<span class="cm">/* panels order is from bottom to top */</span>
	<span class="n">new_panel</span><span class="p">(</span><span class="n">main_window</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">ac</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">av</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

	<span class="n">setlocale</span><span class="p">(</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">bindtextdomain</span><span class="p">(</span><span class="n">PACKAGE</span><span class="p">,</span> <span class="n">LOCALEDIR</span><span class="p">);</span>
	<span class="n">textdomain</span><span class="p">(</span><span class="n">PACKAGE</span><span class="p">);</span>

	<span class="n">conf_parse</span><span class="p">(</span><span class="n">av</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">conf_read</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;NCONFIG_MODE&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;single_menu&quot;</span><span class="p">))</span>
			<span class="n">single_menu_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize curses */</span>
	<span class="n">initscr</span><span class="p">();</span>
	<span class="cm">/* set color theme */</span>
	<span class="n">set_colors</span><span class="p">();</span>

	<span class="n">cbreak</span><span class="p">();</span>
	<span class="n">noecho</span><span class="p">();</span>
	<span class="n">keypad</span><span class="p">(</span><span class="n">stdscr</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
	<span class="n">curs_set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">COLS</span> <span class="o">&lt;</span> <span class="mi">75</span> <span class="o">||</span> <span class="n">LINES</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">endwin</span><span class="p">();</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Your terminal should have at &quot;</span>
			<span class="s">&quot;least 20 lines and 75 columns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">notimeout</span><span class="p">(</span><span class="n">stdscr</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
	<span class="n">ESCDELAY</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* set btns menu */</span>
	<span class="n">curses_menu</span> <span class="o">=</span> <span class="n">new_menu</span><span class="p">(</span><span class="n">curses_menu_items</span><span class="p">);</span>
	<span class="n">menu_opts_off</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">O_SHOWDESC</span><span class="p">);</span>
	<span class="n">menu_opts_on</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">O_SHOWMATCH</span><span class="p">);</span>
	<span class="n">menu_opts_on</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">O_ONEVALUE</span><span class="p">);</span>
	<span class="n">menu_opts_on</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">O_NONCYCLIC</span><span class="p">);</span>
	<span class="n">menu_opts_on</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">O_IGNORECASE</span><span class="p">);</span>
	<span class="n">set_menu_mark</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="n">set_menu_fore</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="n">MAIN_MENU_FORE</span><span class="p">]);</span>
	<span class="n">set_menu_back</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="n">MAIN_MENU_BACK</span><span class="p">]);</span>
	<span class="n">set_menu_grey</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="n">MAIN_MENU_GREY</span><span class="p">]);</span>

	<span class="n">set_config_filename</span><span class="p">(</span><span class="n">conf_get_configname</span><span class="p">());</span>
	<span class="n">setup_windows</span><span class="p">();</span>

	<span class="cm">/* check for KEY_FUNC(1) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_key</span><span class="p">(</span><span class="n">KEY_F</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">show_scroll_win</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span>
				<span class="n">_</span><span class="p">(</span><span class="s">&quot;Instructions&quot;</span><span class="p">),</span>
				<span class="n">_</span><span class="p">(</span><span class="n">menu_no_f_instructions</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">conf_set_message_callback</span><span class="p">(</span><span class="n">conf_message_callback</span><span class="p">);</span>
	<span class="cm">/* do the work */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">global_exit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rootmenu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">global_exit</span> <span class="o">&amp;&amp;</span> <span class="n">do_exit</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* ok, we are done */</span>
	<span class="n">unpost_menu</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">);</span>
	<span class="n">free_menu</span><span class="p">(</span><span class="n">curses_menu</span><span class="p">);</span>
	<span class="n">delwin</span><span class="p">(</span><span class="n">main_window</span><span class="p">);</span>
	<span class="n">clear</span><span class="p">();</span>
	<span class="n">refresh</span><span class="p">();</span>
	<span class="n">endwin</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
