<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › link-vmlinux.sh

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>link-vmlinux.sh</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/sh</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>link vmlinux</p>

<p>vmlinux is linked from the objects selected by $(KBUILD<em>VMLINUX</em>INIT) and
$(KBUILD<em>VMLINUX</em>MAIN). Most are built-in.o files from top-level directories
in the kernel tree, others are specified in arch/$(ARCH)/Makefile.
Ordering when linking is important, and $(KBUILD<em>VMLINUX</em>INIT) must be first.</p>

<p>vmlinux
  ^
  |
  +-&lt; $(KBUILD<em>VMLINUX</em>INIT)
  |   +--&lt; init/version.o + more
  |
  +--&lt; $(KBUILD<em>VMLINUX</em>MAIN)
  |    +--&lt; drivers/built-in.o mm/built-in.o + more
  |
  +-&lt; ${kallsymso} (see description in KALLSYMS section)</p>

<p>vmlinux version (uname -v) cannot be updated during normal
descending-into-subdirs phase since we do not yet know if we need to
update vmlinux.
Therefore this step is delayed until just before final link of vmlinux.</p>

<p>System.map is generated to document addresses of all kernel symbols</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Error out on error</p></td><td class="code"><div class="highlight"><pre><span class="nb">set</span> -e</pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Nice output in kbuild format
Will be supressed by "make -s"</p></td><td class="code"><div class="highlight"><pre>info<span class="o">()</span>
<span class="o">{</span>
	<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;${quiet}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;silent_&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nb">printf</span> <span class="s2">&quot;  %-7s %s\n&quot;</span> <span class="k">${</span><span class="nv">1</span><span class="k">}</span> <span class="k">${</span><span class="nv">2</span><span class="k">}</span>
	<span class="k">fi</span>
<span class="o">}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Link of vmlinux.o used for section mismatch analysis
${1} output file</p></td><td class="code"><div class="highlight"><pre>modpost_link<span class="o">()</span>
<span class="o">{</span>
	<span class="k">${</span><span class="nv">LD</span><span class="k">}</span> <span class="k">${</span><span class="nv">LDFLAGS</span><span class="k">}</span> -r -o <span class="k">${</span><span class="nv">1</span><span class="k">}</span> <span class="k">${</span><span class="nv">KBUILD_VMLINUX_INIT</span><span class="k">}</span>                   <span class="se">\</span>
		--start-group <span class="k">${</span><span class="nv">KBUILD_VMLINUX_MAIN</span><span class="k">}</span> --end-group
<span class="o">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Link of vmlinux
${1} - optional extra .o files
${2} - output file</p></td><td class="code"><div class="highlight"><pre>vmlinux_link<span class="o">()</span>
<span class="o">{</span>
	<span class="nb">local </span><span class="nv">lds</span><span class="o">=</span><span class="s2">&quot;${objtree}/${KBUILD_LDS}&quot;</span>

	<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;${SRCARCH}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;um&quot;</span> <span class="o">]</span>; <span class="k">then</span>
		<span class="k">${</span><span class="nv">LD</span><span class="k">}</span> <span class="k">${</span><span class="nv">LDFLAGS</span><span class="k">}</span> <span class="k">${</span><span class="nv">LDFLAGS_vmlinux</span><span class="k">}</span> -o <span class="k">${</span><span class="nv">2</span><span class="k">}</span>                  <span class="se">\</span>
			-T <span class="k">${</span><span class="nv">lds</span><span class="k">}</span> <span class="k">${</span><span class="nv">KBUILD_VMLINUX_INIT</span><span class="k">}</span>                     <span class="se">\</span>
			--start-group <span class="k">${</span><span class="nv">KBUILD_VMLINUX_MAIN</span><span class="k">}</span> --end-group <span class="k">${</span><span class="nv">1</span><span class="k">}</span>
	<span class="k">else</span>
		<span class="k">${</span><span class="nv">CC</span><span class="k">}</span> <span class="k">${</span><span class="nv">CFLAGS_vmlinux</span><span class="k">}</span> -o <span class="k">${</span><span class="nv">2</span><span class="k">}</span>                              <span class="se">\</span>
			-Wl,-T,<span class="k">${</span><span class="nv">lds</span><span class="k">}</span> <span class="k">${</span><span class="nv">KBUILD_VMLINUX_INIT</span><span class="k">}</span>                 <span class="se">\</span>
			-Wl,--start-group                                    <span class="se">\</span>
				 <span class="k">${</span><span class="nv">KBUILD_VMLINUX_MAIN</span><span class="k">}</span>                      <span class="se">\</span>
			-Wl,--end-group                                      <span class="se">\</span>
			-lutil <span class="k">${</span><span class="nv">1</span><span class="k">}</span>
		rm -f linux
	<span class="k">fi</span>
<span class="o">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Create ${2} .o file with all symbols from the ${1} object file</p></td><td class="code"><div class="highlight"><pre>kallsyms<span class="o">()</span>
<span class="o">{</span>
	info KSYM <span class="k">${</span><span class="nv">2</span><span class="k">}</span>
	<span class="nb">local </span>kallsymopt;

	<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;${CONFIG_KALLSYMS_ALL}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">kallsymopt</span><span class="o">=</span>--all-symbols
	<span class="k">fi</span>

<span class="k">	</span><span class="nb">local </span><span class="nv">aflags</span><span class="o">=</span><span class="s2">&quot;${KBUILD_AFLAGS} ${KBUILD_AFLAGS_KERNEL}               \</span>
<span class="s2">		      ${NOSTDINC_FLAGS} ${LINUXINCLUDE} ${KBUILD_CPPFLAGS}&quot;</span>

	<span class="k">${</span><span class="nv">NM</span><span class="k">}</span> -n <span class="k">${</span><span class="nv">1</span><span class="k">}</span> | <span class="se">\</span>
		scripts/kallsyms <span class="k">${</span><span class="nv">kallsymopt</span><span class="k">}</span> | <span class="se">\</span>
		<span class="k">${</span><span class="nv">CC</span><span class="k">}</span> <span class="k">${</span><span class="nv">aflags</span><span class="k">}</span> -c -o <span class="k">${</span><span class="nv">2</span><span class="k">}</span> -x assembler-with-cpp -
<span class="o">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Create map file with all symbols from ${1}
See mksymap for additional details</p></td><td class="code"><div class="highlight"><pre>mksysmap<span class="o">()</span>
<span class="o">{</span>
	<span class="k">${</span><span class="nv">CONFIG_SHELL</span><span class="k">}</span> <span class="s2">&quot;${srctree}/scripts/mksysmap&quot;</span> <span class="k">${</span><span class="nv">1</span><span class="k">}</span> <span class="k">${</span><span class="nv">2</span><span class="k">}</span>
<span class="o">}</span>

sortextable<span class="o">()</span>
<span class="o">{</span>
	<span class="k">${</span><span class="nv">objtree</span><span class="k">}</span>/scripts/sortextable <span class="k">${</span><span class="nv">1</span><span class="k">}</span>
<span class="o">}</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Delete output files in case of error</p></td><td class="code"><div class="highlight"><pre><span class="nb">trap </span>cleanup SIGHUP SIGINT SIGQUIT SIGTERM ERR
cleanup<span class="o">()</span>
<span class="o">{</span>
	rm -f .old_version
	rm -f .tmp_System.map
	rm -f .tmp_kallsyms*
	rm -f .tmp_version
	rm -f .tmp_vmlinux*
	rm -f System.map
	rm -f vmlinux
	rm -f vmlinux.o
<span class="o">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Use "make V=1" to debug this script</p></td><td class="code"><div class="highlight"><pre><span class="k">case</span> <span class="s2">&quot;${KBUILD_VERBOSE}&quot;</span> in
*1*<span class="o">)</span>
	<span class="nb">set</span> -x
	;;
<span class="k">esac</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$1&quot;</span> <span class="o">=</span> <span class="s2">&quot;clean&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>cleanup
	<span class="nb">exit </span>0
<span class="k">fi</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>We need access to CONFIG_ symbols</p></td><td class="code"><div class="highlight"><pre>. ./.config</pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>link vmlinux.o</p></td><td class="code"><div class="highlight"><pre>info LD vmlinux.o
modpost_link vmlinux.o</pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>modpost vmlinux.o to check for section mismatches</p></td><td class="code"><div class="highlight"><pre><span class="k">${</span><span class="nv">MAKE</span><span class="k">}</span> -f <span class="s2">&quot;${srctree}/scripts/Makefile.modpost&quot;</span> vmlinux.o</pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Update version</p></td><td class="code"><div class="highlight"><pre>info GEN .version
<span class="k">if</span> <span class="o">[</span> ! -r .version <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>rm -f .version;
	<span class="nb">echo </span>1 &gt;.version;
<span class="k">else</span>
<span class="k">	</span>mv .version .old_version;
	expr 0<span class="k">$(</span>cat .old_version<span class="k">)</span> + 1 &gt;.version;
<span class="k">fi</span>;</pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>final build of init/</p></td><td class="code"><div class="highlight"><pre><span class="k">${</span><span class="nv">MAKE</span><span class="k">}</span> -f <span class="s2">&quot;${srctree}/scripts/Makefile.build&quot;</span> <span class="nv">obj</span><span class="o">=</span>init

<span class="nv">kallsymso</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">kallsyms_vmlinux</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;${CONFIG_KALLSYMS}&quot;</span> <span class="o">]</span>; <span class="k">then</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>kallsyms support
Generate section listing all symbols and add it into vmlinux
It's a three step process:
1)  Link .tmp<em>vmlinux1 so it has all symbols and sections,
    but _</em>kallsyms is empty.
    Running kallsyms on that gives us .tmp<em>kallsyms1.o with
    the right size
2)  Link .tmp</em>vmlinux2 so it now has a <em>_kallsyms section of
    the right size, but due to the added section, some
    addresses have shifted.
    From here, we generate a correct .tmp</em>kallsyms2.o
2a) We may use an extra pass as this has been necessary to
    woraround some alignment related bugs.
    KALLSYMS<em>EXTRA</em>PASS=1 is used to trigger this.
3)  The correct ${kallsymso} is linked into the final vmlinux.</p>

<p>a)  Verify that the System.map from vmlinux matches the map from
    ${kallsymso}.</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">kallsymso</span><span class="o">=</span>.tmp_kallsyms2.o
	<span class="nv">kallsyms_vmlinux</span><span class="o">=</span>.tmp_vmlinux2</pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>step 1</p></td><td class="code"><div class="highlight"><pre>	vmlinux_link <span class="s2">&quot;&quot;</span> .tmp_vmlinux1
	kallsyms .tmp_vmlinux1 .tmp_kallsyms1.o</pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>step 2</p></td><td class="code"><div class="highlight"><pre>	vmlinux_link .tmp_kallsyms1.o .tmp_vmlinux2
	kallsyms .tmp_vmlinux2 .tmp_kallsyms2.o</pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>step 2a</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;${KALLSYMS_EXTRA_PASS}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">kallsymso</span><span class="o">=</span>.tmp_kallsyms3.o
		<span class="nv">kallsyms_vmlinux</span><span class="o">=</span>.tmp_vmlinux3

		vmlinux_link .tmp_kallsyms2.o .tmp_vmlinux3

		kallsyms .tmp_vmlinux3 .tmp_kallsyms3.o
	<span class="k">fi</span>
<span class="k">fi</span>

info LD vmlinux
vmlinux_link <span class="s2">&quot;${kallsymso}&quot;</span> vmlinux

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;${CONFIG_BUILDTIME_EXTABLE_SORT}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>info SORTEX vmlinux
	sortextable vmlinux
<span class="k">fi</span>

info SYSMAP System.map
mksysmap vmlinux System.map</pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>step a (see comment above)</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;${CONFIG_KALLSYMS}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>mksysmap <span class="k">${</span><span class="nv">kallsyms_vmlinux</span><span class="k">}</span> .tmp_System.map

	<span class="k">if</span> ! cmp -s System.map .tmp_System.map; <span class="k">then</span>
<span class="k">		</span><span class="nb">echo </span>Inconsistent kallsyms data
		<span class="nb">echo echo </span>Try <span class="s2">&quot;make KALLSYMS_EXTRA_PASS=1&quot;</span> as a workaround
		cleanup
		<span class="nb">exit </span>1
	<span class="k">fi</span>
<span class="k">fi</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>We made a new kernel - delete old version file</p></td><td class="code"><div class="highlight"><pre>rm -f .old_version

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
