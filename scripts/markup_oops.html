<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › markup_oops.pl

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>markup_oops.pl</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c1">#!/usr/bin/perl</span>

<span class="k">use</span> <span class="nn">File::</span><span class="n">Basename</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Math::</span><span class="n">BigInt</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Long</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Copyright 2008, Intel Corporation</p>

<p>This file is part of the Linux kernel</p>

<p>This program file is free software; you can redistribute it and/or modify it
under the terms of the GNU General Public License as published by the
Free Software Foundation; version 2 of the License.</p>

<p>Authors:
    Arjan van de Ven <a href="&#x6D;&#97;&#105;&#x6C;&#116;&#x6F;:&#x61;&#114;&#x6A;&#x61;n&#64;&#108;&#105;&#x6E;&#x75;&#x78;&#x2E;&#x69;nt&#x65;&#108;&#x2E;c&#x6F;&#109;">&#x61;&#114;&#x6A;&#x61;n&#64;&#108;&#105;&#x6E;&#x75;&#x78;&#x2E;&#x69;nt&#x65;&#108;&#x2E;c&#x6F;&#109;</a></p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$cross_compile</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$vmlinux_name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$modulefile</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Get options</p></td><td class="code"><div class="highlight"><pre><span class="nn">Getopt::Long::</span><span class="n">GetOptions</span><span class="p">(</span>
	<span class="s">&#39;cross-compile|c=s&#39;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$cross_compile</span><span class="p">,</span>
	<span class="s">&#39;module|m=s&#39;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$modulefile</span><span class="p">,</span>
	<span class="s">&#39;help|h&#39;</span>		<span class="o">=&gt;</span> <span class="o">\&amp;</span><span class="n">usage</span><span class="p">,</span>
<span class="p">)</span> <span class="o">||</span> <span class="n">usage</span> <span class="p">();</span>
<span class="k">my</span> <span class="nv">$vmlinux_name</span> <span class="o">=</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$vmlinux_name</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$kerver</span> <span class="o">=</span> <span class="sb">`uname -r`</span><span class="p">;</span>
	<span class="nb">chomp</span><span class="p">(</span><span class="nv">$kerver</span><span class="p">);</span>
	<span class="nv">$vmlinux_name</span> <span class="o">=</span> <span class="s">&quot;/lib/modules/$kerver/build/vmlinux&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;No vmlinux specified, assuming $vmlinux_name\n&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$vmlinux_name</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Parse the oops to find the EIP value</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$target</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$function</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$module</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$func_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$vmaoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">%regs</span><span class="p">;</span>


<span class="k">sub </span><span class="nf">parse_x86_regs</span>
<span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$line</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /EAX: ([0-9a-f]+) EBX: ([0-9a-f]+) ECX: ([0-9a-f]+) EDX: ([0-9a-f]+)/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%eax&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%ebx&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%ecx&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%edx&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /ESI: ([0-9a-f]+) EDI: ([0-9a-f]+) EBP: ([0-9a-f]+) ESP: ([0-9a-f]+)/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%esi&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%edi&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%esp&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /RAX: ([0-9a-f]+) RBX: ([0-9a-f]+) RCX: ([0-9a-f]+)/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%eax&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%ebx&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%ecx&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /RDX: ([0-9a-f]+) RSI: ([0-9a-f]+) RDI: ([0-9a-f]+)/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%edx&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%esi&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%edi&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /RBP: ([0-9a-f]+) R08: ([0-9a-f]+) R09: ([0-9a-f]+)/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%r08&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%r09&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /R10: ([0-9a-f]+) R11: ([0-9a-f]+) R12: ([0-9a-f]+)/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%r10&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%r11&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%r12&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /R13: ([0-9a-f]+) R14: ([0-9a-f]+) R15: ([0-9a-f]+)/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%r13&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%r14&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
		<span class="nv">$regs</span><span class="p">{</span><span class="s">&quot;%r15&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">reg_name</span>
<span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$reg</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
	<span class="nv">$reg</span> <span class="o">=~</span> <span class="sr">s/r(.)x/e\1x/</span><span class="p">;</span>
	<span class="nv">$reg</span> <span class="o">=~</span> <span class="sr">s/r(.)i/e\1i/</span><span class="p">;</span>
	<span class="nv">$reg</span> <span class="o">=~</span> <span class="sr">s/r(.)p/e\1p/</span><span class="p">;</span>
	<span class="k">return</span> <span class="nv">$reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">process_x86_regs</span>
<span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="nv">$cntr</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$str</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nv">$line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span> <span class="c1"># not an asm istruction</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>find the arguments to the instruction</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /([0-9a-zA-Z\,\%\(\)\-\+]+)$/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$lastword</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>we need to find the registers that get clobbered,
since their value is no longer relevant for previous
instructions in the stream.</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$clobber</span> <span class="o">=</span> <span class="nv">$lastword</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>first, remove all memory operands, they're read only</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$clobber</span> <span class="o">=~</span> <span class="sr">s/\([a-z0-9\%\,]+\)//g</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>then, remove everything before the comma, thats the read part</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$clobber</span> <span class="o">=~</span> <span class="sr">s/.*\,//g</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>if this is the instruction that faulted, we haven't actually done
the write yet... nothing is clobbered.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$cntr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$clobber</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">foreach</span> <span class="nv">$reg</span> <span class="p">(</span><span class="nb">keys</span><span class="p">(</span><span class="nv">%regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$clobberprime</span> <span class="o">=</span> <span class="n">reg_name</span><span class="p">(</span><span class="nv">$clobber</span><span class="p">);</span>
		<span class="k">my</span> <span class="nv">$lastwordprime</span> <span class="o">=</span> <span class="n">reg_name</span><span class="p">(</span><span class="nv">$lastword</span><span class="p">);</span>
		<span class="k">my</span> <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$regs</span><span class="p">{</span><span class="nv">$reg</span><span class="p">};</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$val</span> <span class="o">=~</span><span class="sr"> /^[0]+$/</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$val</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nv">$val</span> <span class="o">=~</span> <span class="sr">s/^0*//</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>first check if we're clobbering this register; if we do
we print it with a =>, and then delete its value</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$clobber</span> <span class="o">=~</span><span class="sr"> /$reg/</span> <span class="o">||</span> <span class="nv">$clobberprime</span> <span class="o">=~</span><span class="sr"> /$reg/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nv">$val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$str</span> <span class="o">=</span> <span class="nv">$str</span> <span class="o">.</span> <span class="s">&quot; $reg =&gt; $val &quot;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="nv">$regs</span><span class="p">{</span><span class="nv">$reg</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
			<span class="nv">$val</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>now check if we're reading this register</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$lastword</span> <span class="o">=~</span><span class="sr"> /$reg/</span> <span class="o">||</span> <span class="nv">$lastwordprime</span> <span class="o">=~</span><span class="sr"> /$reg/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nv">$val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$str</span> <span class="o">=</span> <span class="nv">$str</span> <span class="o">.</span> <span class="s">&quot; $reg = $val &quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nv">$str</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>parse the oops</p></td><td class="code"><div class="highlight"><pre><span class="k">while</span> <span class="p">(</span><span class="sr">&lt;STDIN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /EIP: 0060:\[\&lt;([a-z0-9]+)\&gt;\]/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$target</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /RIP: 0010:\[\&lt;([a-z0-9]+)\&gt;\]/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$target</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /EIP is at ([a-zA-Z0-9\_]+)\+0x([0-9a-f]+)\/0x[a-f0-9]/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$function</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="nv">$func_offset</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /RIP: 0010:\[\&lt;[0-9a-f]+\&gt;\]  \[\&lt;[0-9a-f]+\&gt;\] ([a-zA-Z0-9\_]+)\+0x([0-9a-f]+)\/0x[a-f0-9]/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$function</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="nv">$func_offset</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>check if it's a module</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /EIP is at ([a-zA-Z0-9\_]+)\+(0x[0-9a-f]+)\/0x[a-f0-9]+\W\[([a-zA-Z0-9\_\-]+)\]/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$module</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /RIP: 0010:\[\&lt;[0-9a-f]+\&gt;\]  \[\&lt;[0-9a-f]+\&gt;\] ([a-zA-Z0-9\_]+)\+(0x[0-9a-f]+)\/0x[a-f0-9]+\W\[([a-zA-Z0-9\_\-]+)\]/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$module</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">parse_x86_regs</span><span class="p">(</span><span class="nv">$line</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$decodestart</span> <span class="o">=</span> <span class="nn">Math::</span><span class="n">BigInt</span><span class="o">-&gt;</span><span class="n">from_hex</span><span class="p">(</span><span class="s">&quot;0x$target&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="nn">Math::</span><span class="n">BigInt</span><span class="o">-&gt;</span><span class="n">from_hex</span><span class="p">(</span><span class="s">&quot;0x$func_offset&quot;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$decodestop</span> <span class="o">=</span> <span class="nn">Math::</span><span class="n">BigInt</span><span class="o">-&gt;</span><span class="n">from_hex</span><span class="p">(</span><span class="s">&quot;0x$target&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8192</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$target</span> <span class="ow">eq</span> <span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="s">&quot;No oops found!\n&quot;</span><span class="p">;</span>
	<span class="n">usage</span><span class="p">();</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>if it's a module, we need to find the .ko file and calculate a load offset</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nv">$module</span> <span class="ow">ne</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$modulefile</span> <span class="ow">eq</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$modulefile</span> <span class="o">=</span> <span class="sb">`modinfo -F filename $module`</span><span class="p">;</span>
		<span class="nb">chomp</span><span class="p">(</span><span class="nv">$modulefile</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$modulefile</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$filename</span> <span class="ow">eq</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">print</span> <span class="s">&quot;Module .ko file for $module not found. Aborting\n&quot;</span><span class="p">;</span>
		<span class="nb">exit</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>ok so we found the module, now we need to calculate the vma offset</p></td><td class="code"><div class="highlight"><pre>	<span class="nb">open</span><span class="p">(</span><span class="n">FILE</span><span class="p">,</span> <span class="nv">$cross_compile</span><span class="o">.</span><span class="s">&quot;objdump -dS $filename |&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nb">die</span> <span class="s">&quot;Cannot start objdump&quot;</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="sr">&lt;FILE&gt;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^([0-9a-f]+) \&lt;$function\&gt;\:/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$fu</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="nv">$vmaoffset</span> <span class="o">=</span> <span class="nn">Math::</span><span class="n">BigInt</span><span class="o">-&gt;</span><span class="n">from_hex</span><span class="p">(</span><span class="s">&quot;0x$target&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="nn">Math::</span><span class="n">BigInt</span><span class="o">-&gt;</span><span class="n">from_hex</span><span class="p">(</span><span class="s">&quot;0x$fu&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="nn">Math::</span><span class="n">BigInt</span><span class="o">-&gt;</span><span class="n">from_hex</span><span class="p">(</span><span class="s">&quot;0x$func_offset&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nb">close</span><span class="p">(</span><span class="n">FILE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$state</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$center</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@lines</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@reglines</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">InRange</span> <span class="p">{</span>
	<span class="k">my</span> <span class="p">(</span><span class="nv">$address</span><span class="p">,</span> <span class="nv">$target</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$ad</span> <span class="o">=</span> <span class="s">&quot;0x&quot;</span><span class="o">.</span><span class="nv">$address</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$ta</span> <span class="o">=</span> <span class="s">&quot;0x&quot;</span><span class="o">.</span><span class="nv">$target</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$delta</span> <span class="o">=</span> <span class="nn">Math::</span><span class="n">BigInt</span><span class="o">-&gt;</span><span class="n">from_hex</span><span class="p">(</span><span class="nv">$ad</span><span class="p">)</span> <span class="o">-</span> <span class="nn">Math::</span><span class="n">BigInt</span><span class="o">-&gt;</span><span class="n">from_hex</span><span class="p">(</span><span class="nv">$ta</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="nv">$delta</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">4096</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$delta</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>first, parse the input into the lines array, but to keep size down,
we only do this for 4Kb around the sweet spot</p></td><td class="code"><div class="highlight"><pre><span class="nb">open</span><span class="p">(</span><span class="n">FILE</span><span class="p">,</span> <span class="nv">$cross_compile</span><span class="o">.</span><span class="s">&quot;objdump -dS --adjust-vma=$vmaoffset --start-address=$decodestart --stop-address=$decodestop $filename |&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nb">die</span> <span class="s">&quot;Cannot start objdump&quot;</span><span class="p">;</span>

<span class="k">while</span> <span class="p">(</span><span class="sr">&lt;FILE&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
	<span class="nb">chomp</span><span class="p">(</span><span class="nv">$line</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^([a-f0-9]+)\:/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">InRange</span><span class="p">(</span><span class="nv">$1</span><span class="p">,</span> <span class="nv">$target</span><span class="p">))</span> <span class="p">{</span>
				<span class="nv">$state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^([a-f0-9][a-f0-9][a-f0-9][a-f0-9][a-f0-9][a-f0-9]+)\:/</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">InRange</span><span class="p">(</span><span class="nv">$val</span><span class="p">,</span> <span class="nv">$target</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">last</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$val</span> <span class="ow">eq</span> <span class="nv">$target</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$center</span> <span class="o">=</span> <span class="nv">$counter</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="nv">$lines</span><span class="p">[</span><span class="nv">$counter</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$line</span><span class="p">;</span>

		<span class="nv">$counter</span> <span class="o">=</span> <span class="nv">$counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="nb">close</span><span class="p">(</span><span class="n">FILE</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="s">&quot;No matching code found \n&quot;</span><span class="p">;</span>
	<span class="nb">exit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$center</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="s">&quot;No matching code found \n&quot;</span><span class="p">;</span>
	<span class="nb">exit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$start</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$finish</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$codelines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$binarylines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>now we go up and down in the array to find how much we want to print</p></td><td class="code"><div class="highlight"><pre><span class="nv">$start</span> <span class="o">=</span> <span class="nv">$center</span><span class="p">;</span>

<span class="k">while</span> <span class="p">(</span><span class="nv">$start</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$start</span> <span class="o">=</span> <span class="nv">$start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$start</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^([a-f0-9]+)\:/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$binarylines</span> <span class="o">=</span> <span class="nv">$binarylines</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nv">$codelines</span> <span class="o">=</span> <span class="nv">$codelines</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$codelines</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">last</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$binarylines</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">last</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="nv">$finish</span> <span class="o">=</span> <span class="nv">$center</span><span class="p">;</span>
<span class="nv">$codelines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nv">$binarylines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$finish</span> <span class="o">&lt;</span> <span class="nv">$counter</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$finish</span> <span class="o">=</span> <span class="nv">$finish</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$finish</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^([a-f0-9]+)\:/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$binarylines</span> <span class="o">=</span> <span class="nv">$binarylines</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nv">$codelines</span> <span class="o">=</span> <span class="nv">$codelines</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$codelines</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">last</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$binarylines</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">last</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">my</span> <span class="nv">$i</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>start annotating the registers in the asm.
this goes from the oopsing point back, so that the annotator
can track (opportunistically) which registers got written and
whos value no longer is relevant.</p></td><td class="code"><div class="highlight"><pre><span class="nv">$i</span> <span class="o">=</span> <span class="nv">$center</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">&gt;=</span> <span class="nv">$start</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$reglines</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_x86_regs</span><span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="nv">$i</span><span class="p">],</span> <span class="nv">$center</span> <span class="o">-</span> <span class="nv">$i</span><span class="p">);</span>
	<span class="nv">$i</span> <span class="o">=</span> <span class="nv">$i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$i</span> <span class="o">=</span> <span class="nv">$start</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$finish</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$line</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">==</span> <span class="nv">$center</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$line</span> <span class="o">=</span>  <span class="s">&quot;*$lines[$i] &quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nv">$line</span> <span class="o">=</span>  <span class="s">&quot; $lines[$i] &quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">print</span> <span class="nv">$line</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$reglines</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$reglines</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$c</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">-</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$line</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="nv">$c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">print</span> <span class="s">&quot; &quot;</span><span class="p">;</span> <span class="nv">$c</span> <span class="o">=</span> <span class="nv">$c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="p">};</span>
		<span class="k">print</span> <span class="s">&quot;| $reglines[$i]&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">==</span> <span class="nv">$center</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">print</span> <span class="s">&quot;&lt;--- faulting instruction&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">print</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
	<span class="nv">$i</span> <span class="o">=</span> <span class="nv">$i</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">usage</span> <span class="p">{</span>
	<span class="k">print</span> <span class="s">&lt;&lt;EOT;</span>
<span class="s">Usage:</span>
<span class="s">  dmesg | perl $0 [OPTION] [VMLINUX]</span>

<span class="s">OPTION:</span>
<span class="s">  -c, --cross-compile CROSS_COMPILE	Specify the prefix used for toolchain.</span>
<span class="s">  -m, --module MODULE_DIRNAME		Specify the module filename.</span>
<span class="s">  -h, --help				Help.</span>
<span class="s">EOT</span>
	<span class="nb">exit</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
