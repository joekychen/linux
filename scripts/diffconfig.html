<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › diffconfig

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>diffconfig</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>diffconfig - a tool to compare .config files.</p>

<p>originally written in 2006 by Matt Mackall
 (at least, this was in his bloatwatch source code)
last worked on 2008 by Tim Bird</p></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">usage</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&quot;&quot;&quot;Usage: diffconfig [-h] [-m] [&lt;config1&gt; &lt;config2&gt;]</span>

<span class="s">Diffconfig is a simple utility for comparing two .config files.</span>
<span class="s">Using standard diff to compare .config files often includes extraneous and</span>
<span class="s">distracting information.  This utility produces sorted output with only the</span>
<span class="s">changes in configuration values between the two files.</span>

<span class="s">Added and removed items are shown with a leading plus or minus, respectively.</span>
<span class="s">Changed items show the old and new values on a single line.</span>

<span class="s">If -m is specified, then output will be in &quot;merge&quot; style, which has the</span>
<span class="s">changed and new values in kernel config option format.</span>

<span class="s">If no config files are specified, .config and .config.old are used.</span>

<span class="s">Example usage:</span>
<span class="s"> $ diffconfig .config config-with-some-changes</span>
<span class="s">-EXT2_FS_XATTR  n</span>
<span class="s">-EXT2_FS_XIP  n</span>
<span class="s"> CRAMFS  n -&gt; y</span>
<span class="s"> EXT2_FS  y -&gt; n</span>
<span class="s"> LOG_BUF_SHIFT  14 -&gt; 16</span>
<span class="s"> PRINTK_TIME  n -&gt; y</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div></td><td class="code"><div class="highlight shebang"><pre><span>#!/usr/bin/python
</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>returns a dictionary of name/value pairs for config items in the file</p></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">readconfig</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;CONFIG_&quot;</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">11</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&quot; is not set&quot;</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="o">-</span><span class="mi">11</span><span class="p">]]</span> <span class="o">=</span> <span class="s">&quot;n&quot;</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">print_config</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">merge_style</span>

    <span class="k">if</span> <span class="n">merge_style</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">new_value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_value</span><span class="o">==</span><span class="s">&quot;n&quot;</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;# CONFIG_</span><span class="si">%s</span><span class="s"> is not set&quot;</span> <span class="o">%</span> <span class="n">config</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;CONFIG_</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op</span><span class="o">==</span><span class="s">&quot;-&quot;</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;-</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">op</span><span class="o">==</span><span class="s">&quot;+&quot;</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;+</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot; </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> -&gt; </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">merge_style</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>parse command line args</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="s">&quot;-h&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="ow">or</span> <span class="s">&quot;--help&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">):</span>
	<span class="n">usage</span><span class="p">()</span>

    <span class="n">merge_style</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="s">&quot;-m&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
        <span class="n">merge_style</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;-m&quot;</span><span class="p">)</span>

    <span class="n">argc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">argc</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;Error: incorrect number of arguments or unrecognized option&quot;</span>
        <span class="n">usage</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>if no filenames given, assume .config and .config.old</p></td><td class="code"><div class="highlight"><pre>        <span class="n">build_dir</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;KBUILD_OUTPUT&quot;</span><span class="p">):</span>
            <span class="n">build_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;KBUILD_OUTPUT&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;/&quot;</span>

        <span class="n">configa_filename</span> <span class="o">=</span> <span class="n">build_dir</span> <span class="o">+</span> <span class="s">&quot;.config.old&quot;</span>
        <span class="n">configb_filename</span> <span class="o">=</span> <span class="n">build_dir</span> <span class="o">+</span> <span class="s">&quot;.config&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">configa_filename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">configb_filename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">readconfig</span><span class="p">(</span><span class="nb">file</span><span class="p">(</span><span class="n">configa_filename</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">readconfig</span><span class="p">(</span><span class="nb">file</span><span class="p">(</span><span class="n">configb_filename</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>print items in a but not b (accumulate, sort and print)</p></td><td class="code"><div class="highlight"><pre>    <span class="n">old</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
            <span class="n">old</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">old</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">old</span><span class="p">:</span>
        <span class="n">print_config</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">config</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">a</span><span class="p">[</span><span class="n">config</span><span class="p">]</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>print items that changed (accumulate, sort, and print)</p></td><td class="code"><div class="highlight"><pre>    <span class="n">changed</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="n">config</span><span class="p">]</span> <span class="o">!=</span> <span class="n">b</span><span class="p">[</span><span class="n">config</span><span class="p">]:</span>
            <span class="n">changed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">b</span><span class="p">[</span><span class="n">config</span><span class="p">]</span>
    <span class="n">changed</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">changed</span><span class="p">:</span>
        <span class="n">print_config</span><span class="p">(</span><span class="s">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">config</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">config</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">b</span><span class="p">[</span><span class="n">config</span><span class="p">]</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>now print items in b but not in a
(items from b that were in a were removed above)</p></td><td class="code"><div class="highlight"><pre>    <span class="n">new</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">new</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">new</span><span class="p">:</span>
        <span class="n">print_config</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="n">config</span><span class="p">])</span>

<span class="n">main</span><span class="p">()</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
