<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › pnmtologo.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>pnmtologo.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Convert a logo in ASCII PNM format to C source suitable for inclusion in</span>
<span class="cm"> *  the Linux kernel</span>
<span class="cm"> *</span>
<span class="cm"> *  (C) Copyright 2001-2003 by Geert Uytterhoeven &lt;geert@linux-m68k.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  --------------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> *  This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> *  License. See the file COPYING in the main directory of the Linux</span>
<span class="cm"> *  distribution for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;ctype.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">programname</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">logoname</span> <span class="o">=</span> <span class="s">&quot;linux_logo&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outputname</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">out</span><span class="p">;</span>


<span class="cp">#define LINUX_LOGO_MONO		1	</span><span class="cm">/* monochrome black/white */</span><span class="cp"></span>
<span class="cp">#define LINUX_LOGO_VGA16	2	</span><span class="cm">/* 16 colors VGA text palette */</span><span class="cp"></span>
<span class="cp">#define LINUX_LOGO_CLUT224	3	</span><span class="cm">/* 224 colors */</span><span class="cp"></span>
<span class="cp">#define LINUX_LOGO_GRAY256	4	</span><span class="cm">/* 256 levels grayscale */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">logo_types</span><span class="p">[</span><span class="n">LINUX_LOGO_GRAY256</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">LINUX_LOGO_MONO</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;LINUX_LOGO_MONO&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="n">LINUX_LOGO_VGA16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;LINUX_LOGO_VGA16&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="n">LINUX_LOGO_CLUT224</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;LINUX_LOGO_CLUT224&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="n">LINUX_LOGO_GRAY256</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;LINUX_LOGO_GRAY256&quot;</span>
<span class="p">};</span>

<span class="cp">#define MAX_LINUX_LOGO_COLORS	224</span>

<span class="k">struct</span> <span class="n">color</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">red</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">green</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">blue</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color</span> <span class="n">clut_vga16</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xaa</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xaa</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x55</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x55</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x55</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x55</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">logo_type</span> <span class="o">=</span> <span class="n">LINUX_LOGO_CLUT224</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">logo_width</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">logo_height</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">color</span> <span class="o">**</span><span class="n">logo_data</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">color</span> <span class="n">logo_clut</span><span class="p">[</span><span class="n">MAX_LINUX_LOGO_COLORS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">logo_clutsize</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">die</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
    <span class="n">__attribute__</span> <span class="p">((</span><span class="n">noreturn</span><span class="p">))</span> <span class="n">__attribute</span> <span class="p">((</span><span class="n">format</span> <span class="p">(</span><span class="n">printf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)));</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">usage</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">__attribute</span> <span class="p">((</span><span class="n">noreturn</span><span class="p">));</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_number</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

    <span class="cm">/* Skip leading whitespace */</span>
    <span class="k">do</span> <span class="p">{</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
	    <span class="n">die</span><span class="p">(</span><span class="s">&quot;%s: end of file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="cm">/* Ignore comments &#39;till end of line */</span>
	    <span class="k">do</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
		    <span class="n">die</span><span class="p">(</span><span class="s">&quot;%s: end of file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
	    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>

    <span class="cm">/* Parse decimal number */</span>
    <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">val</span><span class="o">+</span><span class="n">c</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
	    <span class="n">die</span><span class="p">(</span><span class="s">&quot;%s: end of file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_number255</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxval</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">get_number</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">val</span><span class="o">+</span><span class="n">maxval</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">maxval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_image</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">magic</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxval</span><span class="p">;</span>

    <span class="cm">/* open image file */</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
	<span class="n">die</span><span class="p">(</span><span class="s">&quot;Cannot open file %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

    <span class="cm">/* check file type and read file header */</span>
    <span class="n">magic</span> <span class="o">=</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">magic</span> <span class="o">!=</span> <span class="sc">&#39;P&#39;</span><span class="p">)</span>
	<span class="n">die</span><span class="p">(</span><span class="s">&quot;%s is not a PNM file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
    <span class="n">magic</span> <span class="o">=</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">magic</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
	<span class="k">case</span> <span class="sc">&#39;2&#39;</span>:
	<span class="k">case</span> <span class="sc">&#39;3&#39;</span>:
	    <span class="cm">/* Plain PBM/PGM/PPM */</span>
	    <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;4&#39;</span>:
	<span class="k">case</span> <span class="sc">&#39;5&#39;</span>:
	<span class="k">case</span> <span class="sc">&#39;6&#39;</span>:
	    <span class="cm">/* Binary PBM/PGM/PPM */</span>
	    <span class="n">die</span><span class="p">(</span><span class="s">&quot;%s: Binary PNM is not supported</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;Use pnmnoraw(1) to convert it to ASCII PNM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>

	<span class="nl">default:</span>
	    <span class="n">die</span><span class="p">(</span><span class="s">&quot;%s is not a PNM file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">logo_width</span> <span class="o">=</span> <span class="n">get_number</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="n">logo_height</span> <span class="o">=</span> <span class="n">get_number</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

    <span class="cm">/* allocate image data */</span>
    <span class="n">logo_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">color</span> <span class="o">**</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">logo_height</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">color</span> <span class="o">*</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">logo_data</span><span class="p">)</span>
	<span class="n">die</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo_height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">logo_width</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">color</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
	    <span class="n">die</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="cm">/* read image data */</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">magic</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
	    <span class="cm">/* Plain PBM */</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo_height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo_width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		    <span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">red</span> <span class="o">=</span> <span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">green</span> <span class="o">=</span>
			<span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">blue</span> <span class="o">=</span> <span class="mi">255</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">get_number</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>
	    <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;2&#39;</span>:
	    <span class="cm">/* Plain PGM */</span>
	    <span class="n">maxval</span> <span class="o">=</span> <span class="n">get_number</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo_height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo_width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		    <span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">red</span> <span class="o">=</span> <span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">green</span> <span class="o">=</span>
			<span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">blue</span> <span class="o">=</span> <span class="n">get_number255</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">maxval</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;3&#39;</span>:
	    <span class="cm">/* Plain PPM */</span>
	    <span class="n">maxval</span> <span class="o">=</span> <span class="n">get_number</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo_height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo_width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">red</span> <span class="o">=</span> <span class="n">get_number255</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">maxval</span><span class="p">);</span>
		    <span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">green</span> <span class="o">=</span> <span class="n">get_number255</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">maxval</span><span class="p">);</span>
		    <span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">blue</span> <span class="o">=</span> <span class="n">get_number255</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">maxval</span><span class="p">);</span>
		<span class="p">}</span>
	    <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* close file */</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_black</span><span class="p">(</span><span class="k">struct</span> <span class="n">color</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">.</span><span class="n">red</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="p">.</span><span class="n">green</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="p">.</span><span class="n">blue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_white</span><span class="p">(</span><span class="k">struct</span> <span class="n">color</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">.</span><span class="n">red</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="p">.</span><span class="n">green</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="p">.</span><span class="n">blue</span> <span class="o">==</span> <span class="mi">255</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_gray</span><span class="p">(</span><span class="k">struct</span> <span class="n">color</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">.</span><span class="n">red</span> <span class="o">==</span> <span class="n">c</span><span class="p">.</span><span class="n">green</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="p">.</span><span class="n">red</span> <span class="o">==</span> <span class="n">c</span><span class="p">.</span><span class="n">blue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_equal</span><span class="p">(</span><span class="k">struct</span> <span class="n">color</span> <span class="n">c1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">color</span> <span class="n">c2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">c1</span><span class="p">.</span><span class="n">red</span> <span class="o">==</span> <span class="n">c2</span><span class="p">.</span><span class="n">red</span> <span class="o">&amp;&amp;</span> <span class="n">c1</span><span class="p">.</span><span class="n">green</span> <span class="o">==</span> <span class="n">c2</span><span class="p">.</span><span class="n">green</span> <span class="o">&amp;&amp;</span> <span class="n">c1</span><span class="p">.</span><span class="n">blue</span> <span class="o">==</span> <span class="n">c2</span><span class="p">.</span><span class="n">blue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_header</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* open logo file */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">outputname</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">out</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">outputname</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out</span><span class="p">)</span>
	    <span class="n">die</span><span class="p">(</span><span class="s">&quot;Cannot create file %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">outputname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">out</span> <span class="o">=</span> <span class="n">stdout</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">fputs</span><span class="p">(</span><span class="s">&quot;/*</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
    <span class="n">fputs</span><span class="p">(</span><span class="s">&quot; *  DO NOT EDIT THIS FILE!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
    <span class="n">fputs</span><span class="p">(</span><span class="s">&quot; *</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot; *  It was automatically generated from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
    <span class="n">fputs</span><span class="p">(</span><span class="s">&quot; *</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot; *  Linux logo %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">logoname</span><span class="p">);</span>
    <span class="n">fputs</span><span class="p">(</span><span class="s">&quot; */</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
    <span class="n">fputs</span><span class="p">(</span><span class="s">&quot;#include &lt;linux/linux_logo.h&gt;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;static unsigned char %s_data[] __initdata = {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">logoname</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_footer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">fputs</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">};</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;const struct linux_logo %s __initconst = {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">logoname</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.type</span><span class="se">\t\t</span><span class="s">= %s,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">logo_types</span><span class="p">[</span><span class="n">logo_type</span><span class="p">]);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.width</span><span class="se">\t\t</span><span class="s">= %d,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">logo_width</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.height</span><span class="se">\t\t</span><span class="s">= %d,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">logo_height</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">logo_type</span> <span class="o">==</span> <span class="n">LINUX_LOGO_CLUT224</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.clutsize</span><span class="se">\t</span><span class="s">= %d,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">logo_clutsize</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.clut</span><span class="se">\t\t</span><span class="s">= %s_clut,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">logoname</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.data</span><span class="se">\t\t</span><span class="s">= %s_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">logoname</span><span class="p">);</span>
    <span class="n">fputs</span><span class="p">(</span><span class="s">&quot;};</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>

    <span class="cm">/* close logo file */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">outputname</span><span class="p">)</span>
	<span class="n">fclose</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">write_hex_cnt</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_hex</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">write_hex_cnt</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;, 0x%02x&quot;</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">write_hex_cnt</span><span class="p">)</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;,</span><span class="se">\n\t</span><span class="s">0x%02x&quot;</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
    <span class="k">else</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">0x%02x&quot;</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
    <span class="n">write_hex_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_logo_mono</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">,</span> <span class="n">bit</span><span class="p">;</span>

    <span class="cm">/* validate image */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo_height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo_width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_black</span><span class="p">(</span><span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_white</span><span class="p">(</span><span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Image must be monochrome</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="cm">/* write file header */</span>
    <span class="n">write_header</span><span class="p">();</span>

    <span class="cm">/* write logo data */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo_height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo_width</span><span class="p">;)</span> <span class="p">{</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bit</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo_width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">bit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">red</span><span class="p">)</span>
		    <span class="n">val</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
	    <span class="n">write_hex</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* write logo structure and file footer */</span>
    <span class="n">write_footer</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_logo_vga16</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

    <span class="cm">/* validate image */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo_height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo_width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_equal</span><span class="p">(</span><span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">clut_vga16</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
		    <span class="k">break</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Image must use the 16 console colors only</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;Use ppmquant(1) -map clut_vga16.ppm to reduce the number &quot;</span>
		    <span class="s">&quot;of colors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

    <span class="cm">/* write file header */</span>
    <span class="n">write_header</span><span class="p">();</span>

    <span class="cm">/* write logo data */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo_height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo_width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_equal</span><span class="p">(</span><span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">clut_vga16</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
		    <span class="k">break</span><span class="p">;</span>
	    <span class="n">val</span> <span class="o">=</span> <span class="n">k</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo_width</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">is_equal</span><span class="p">(</span><span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">clut_vga16</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">k</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">write_hex</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

    <span class="cm">/* write logo structure and file footer */</span>
    <span class="n">write_footer</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_logo_clut224</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

    <span class="cm">/* validate image */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo_height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo_width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">logo_clutsize</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_equal</span><span class="p">(</span><span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">logo_clut</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
		    <span class="k">break</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">logo_clutsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">logo_clutsize</span> <span class="o">==</span> <span class="n">MAX_LINUX_LOGO_COLORS</span><span class="p">)</span>
		    <span class="n">die</span><span class="p">(</span><span class="s">&quot;Image has more than %d colors</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;Use ppmquant(1) to reduce the number of colors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">MAX_LINUX_LOGO_COLORS</span><span class="p">);</span>
		<span class="n">logo_clut</span><span class="p">[</span><span class="n">logo_clutsize</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
	    <span class="p">}</span>
	<span class="p">}</span>

    <span class="cm">/* write file header */</span>
    <span class="n">write_header</span><span class="p">();</span>

    <span class="cm">/* write logo data */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo_height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo_width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">logo_clutsize</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_equal</span><span class="p">(</span><span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">logo_clut</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
		    <span class="k">break</span><span class="p">;</span>
	    <span class="n">write_hex</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">32</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="n">fputs</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">};</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>

    <span class="cm">/* write logo clut */</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;static unsigned char %s_clut[] __initdata = {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">logoname</span><span class="p">);</span>
    <span class="n">write_hex_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo_clutsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">write_hex</span><span class="p">(</span><span class="n">logo_clut</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">red</span><span class="p">);</span>
	<span class="n">write_hex</span><span class="p">(</span><span class="n">logo_clut</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">green</span><span class="p">);</span>
	<span class="n">write_hex</span><span class="p">(</span><span class="n">logo_clut</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blue</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* write logo structure and file footer */</span>
    <span class="n">write_footer</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_logo_gray256</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

    <span class="cm">/* validate image */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo_height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo_width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_gray</span><span class="p">(</span><span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Image must be grayscale</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="cm">/* write file header */</span>
    <span class="n">write_header</span><span class="p">();</span>

    <span class="cm">/* write logo data */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo_height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo_width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
	    <span class="n">write_hex</span><span class="p">(</span><span class="n">logo_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">red</span><span class="p">);</span>

    <span class="cm">/* write logo structure and file footer */</span>
    <span class="n">write_footer</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">die</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
    <span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>

    <span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
    <span class="n">vfprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
    <span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usage</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">die</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Usage: %s [options] &lt;filename&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Valid options:</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;    -h          : display this usage information</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;    -n &lt;name&gt;   : specify logo name (default: linux_logo)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;    -o &lt;output&gt; : output to file &lt;output&gt; instead of stdout</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;    -t &lt;type&gt;   : specify logo type, one of</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;                      mono    : monochrome black/white</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;                      vga16   : 16 colors VGA text palette</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;                      clut224 : 224 colors (default)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;                      gray256 : 256 levels grayscale</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">programname</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">opt</span><span class="p">;</span>

    <span class="n">programname</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="n">opterr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">opt</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;hn:o:t:&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	    <span class="k">break</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="sc">&#39;h&#39;</span>:
		<span class="n">usage</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>

	    <span class="k">case</span> <span class="sc">&#39;n&#39;</span>:
		<span class="n">logoname</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	    <span class="k">case</span> <span class="sc">&#39;o&#39;</span>:
		<span class="n">outputname</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	    <span class="k">case</span> <span class="sc">&#39;t&#39;</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="s">&quot;mono&quot;</span><span class="p">))</span>
		    <span class="n">logo_type</span> <span class="o">=</span> <span class="n">LINUX_LOGO_MONO</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="s">&quot;vga16&quot;</span><span class="p">))</span>
		    <span class="n">logo_type</span> <span class="o">=</span> <span class="n">LINUX_LOGO_VGA16</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="s">&quot;clut224&quot;</span><span class="p">))</span>
		    <span class="n">logo_type</span> <span class="o">=</span> <span class="n">LINUX_LOGO_CLUT224</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="s">&quot;gray256&quot;</span><span class="p">))</span>
		    <span class="n">logo_type</span> <span class="o">=</span> <span class="n">LINUX_LOGO_GRAY256</span><span class="p">;</span>
		<span class="k">else</span>
		    <span class="n">usage</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>

	    <span class="nl">default:</span>
		<span class="n">usage</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">!=</span> <span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">usage</span><span class="p">();</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">];</span>

    <span class="n">read_image</span><span class="p">();</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">logo_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LINUX_LOGO_MONO</span>:
	    <span class="n">write_logo_mono</span><span class="p">();</span>
	    <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINUX_LOGO_VGA16</span>:
	    <span class="n">write_logo_vga16</span><span class="p">();</span>
	    <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINUX_LOGO_CLUT224</span>:
	    <span class="n">write_logo_clut224</span><span class="p">();</span>
	    <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINUX_LOGO_GRAY256</span>:
	    <span class="n">write_logo_gray256</span><span class="p">();</span>
	    <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
