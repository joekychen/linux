<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › mkcompile_h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>mkcompile_h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>If compile.h exists already and we don't own autoconf.h
(i.e. we're not the same user who did make *config), don't
modify compile.h
So "sudo make install" won't change the "compiled by <user>"
do "compiled by root"</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="o">[</span> -r <span class="nv">$TARGET</span> -a ! -O include/generated/autoconf.h <span class="o">]</span>; <span class="k">then</span>
<span class="k">  </span>vecho <span class="s2">&quot;  SKIPPED $TARGET&quot;</span>
  <span class="nb">exit </span>0
<span class="k">fi</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div></td><td class="code"><div class="highlight shebang"><pre><span>#!/bin/sh

TARGET=$1
ARCH=$2
SMP=$3
PREEMPT=$4
CC=$5

vecho()</span> <span>{</span> <span>[</span> <span>"${quiet}"</span> <span>=</span> <span>"silent_"</span> <span>]</span> <span>||</span> <span>echo</span> <span>"$@"</span> <span>;</span> <span>}

</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Do not expand names</p></td><td class="code"><div class="highlight"><pre><span class="nb">set</span> -f</pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Fix the language to get consistent output</p></td><td class="code"><div class="highlight"><pre><span class="nv">LC_ALL</span><span class="o">=</span>C
<span class="nb">export </span>LC_ALL

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$KBUILD_BUILD_VERSION&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	if</span> <span class="o">[</span> -r .version <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">VERSION</span><span class="o">=</span><span class="sb">`</span>cat .version<span class="sb">`</span>
	<span class="k">else</span>
<span class="k">		</span><span class="nv">VERSION</span><span class="o">=</span>0
		<span class="nb">echo </span>0 &gt; .version
	<span class="k">fi</span>
<span class="k">else</span>
<span class="k">	</span><span class="nv">VERSION</span><span class="o">=</span><span class="nv">$KBUILD_BUILD_VERSION</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$KBUILD_BUILD_TIMESTAMP&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span><span class="nv">TIMESTAMP</span><span class="o">=</span><span class="sb">`</span>date<span class="sb">`</span>
<span class="k">else</span>
<span class="k">	</span><span class="nv">TIMESTAMP</span><span class="o">=</span><span class="nv">$KBUILD_BUILD_TIMESTAMP</span>
<span class="k">fi</span>
<span class="k">if </span><span class="nb">test</span> -z <span class="s2">&quot;$KBUILD_BUILD_USER&quot;</span>; <span class="k">then</span>
<span class="k">	</span><span class="nv">LINUX_COMPILE_BY</span><span class="o">=</span><span class="k">$(</span>whoami | sed <span class="s1">&#39;s/\\/\\\\/&#39;</span><span class="k">)</span>
<span class="k">else</span>
<span class="k">	</span><span class="nv">LINUX_COMPILE_BY</span><span class="o">=</span><span class="nv">$KBUILD_BUILD_USER</span>
<span class="k">fi</span>
<span class="k">if </span><span class="nb">test</span> -z <span class="s2">&quot;$KBUILD_BUILD_HOST&quot;</span>; <span class="k">then</span>
<span class="k">	</span><span class="nv">LINUX_COMPILE_HOST</span><span class="o">=</span><span class="sb">`</span>hostname<span class="sb">`</span>
<span class="k">else</span>
<span class="k">	</span><span class="nv">LINUX_COMPILE_HOST</span><span class="o">=</span><span class="nv">$KBUILD_BUILD_HOST</span>
<span class="k">fi</span>

<span class="nv">UTS_VERSION</span><span class="o">=</span><span class="s2">&quot;#$VERSION&quot;</span>
<span class="nv">CONFIG_FLAGS</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$SMP&quot;</span> <span class="o">]</span> ; <span class="k">then </span><span class="nv">CONFIG_FLAGS</span><span class="o">=</span><span class="s2">&quot;SMP&quot;</span>; <span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$PREEMPT&quot;</span> <span class="o">]</span> ; <span class="k">then </span><span class="nv">CONFIG_FLAGS</span><span class="o">=</span><span class="s2">&quot;$CONFIG_FLAGS PREEMPT&quot;</span>; <span class="k">fi</span>
<span class="nv">UTS_VERSION</span><span class="o">=</span><span class="s2">&quot;$UTS_VERSION $CONFIG_FLAGS $TIMESTAMP&quot;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Truncate to maximum length</p></td><td class="code"><div class="highlight"><pre><span class="nv">UTS_LEN</span><span class="o">=</span>64
<span class="nv">UTS_TRUNCATE</span><span class="o">=</span><span class="s2">&quot;cut -b -$UTS_LEN&quot;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Generate a temporary compile.h</p></td><td class="code"><div class="highlight"><pre><span class="o">(</span> <span class="nb">echo</span> /<span class="se">\*</span> This file is auto generated, version <span class="nv">$VERSION</span> <span class="se">\*</span>/
  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$CONFIG_FLAGS&quot;</span> <span class="o">]</span> ; <span class="k">then </span><span class="nb">echo</span> <span class="s2">&quot;/* $CONFIG_FLAGS */&quot;</span>; <span class="k">fi</span>
<span class="k">  </span>
<span class="k">  </span><span class="nb">echo</span> <span class="se">\#</span>define UTS_MACHINE <span class="se">\&quot;</span><span class="nv">$ARCH</span><span class="se">\&quot;</span>

  <span class="nb">echo</span> <span class="se">\#</span>define UTS_VERSION <span class="se">\&quot;</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$UTS_VERSION</span> | <span class="nv">$UTS_TRUNCATE</span><span class="sb">`</span><span class="se">\&quot;</span>

  <span class="nb">echo</span> <span class="se">\#</span>define LINUX_COMPILE_BY <span class="se">\&quot;</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$LINUX_COMPILE_BY</span> | <span class="nv">$UTS_TRUNCATE</span><span class="sb">`</span><span class="se">\&quot;</span>
  <span class="nb">echo</span> <span class="se">\#</span>define LINUX_COMPILE_HOST <span class="se">\&quot;</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$LINUX_COMPILE_HOST</span> | <span class="nv">$UTS_TRUNCATE</span><span class="sb">`</span><span class="se">\&quot;</span>

  <span class="nb">echo</span> <span class="se">\#</span>define LINUX_COMPILER <span class="se">\&quot;</span><span class="sb">`</span><span class="nv">$CC</span> -v 2&gt;&amp;1 | tail -n 1<span class="sb">`</span><span class="se">\&quot;</span>
<span class="o">)</span> &gt; .tmpcompile</pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Only replace the real compile.h if the new one is different,
in order to preserve the timestamp and avoid unnecessary
recompilations.
We don't consider the file changed if only the date/time changed.
A kernel config change will increase the generation number, thus
causing compile.h to be updated (including date/time) due to the 
changed comment in the
first line.</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="o">[</span> -r <span class="nv">$TARGET</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
      grep -v <span class="s1">&#39;UTS_VERSION&#39;</span> <span class="nv">$TARGET</span> &gt; .tmpver.1 <span class="o">&amp;&amp;</span> <span class="se">\</span>
      grep -v <span class="s1">&#39;UTS_VERSION&#39;</span> .tmpcompile &gt; .tmpver.2 <span class="o">&amp;&amp;</span> <span class="se">\</span>
      cmp -s .tmpver.1 .tmpver.2; <span class="k">then</span>
<span class="k">   </span>rm -f .tmpcompile
<span class="k">else</span>
<span class="k">   </span>vecho <span class="s2">&quot;  UPD     $TARGET&quot;</span>
   mv -f .tmpcompile <span class="nv">$TARGET</span>
<span class="k">fi</span>
rm -f .tmpver.1 .tmpver.2

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
