<!DOCTYPE html>
<html><head><title>joekychen/linux » scripts › patch-kernel

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>patch-kernel</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>! /bin/sh
Script to apply kernel patches.
  usage: patch-kernel [ sourcedir [ patchdir [ stopversion ] [ -acxx ] ] ]
    The source directory defaults to /usr/src/linux, and the patch
    directory defaults to the current directory.
e.g.
  scripts/patch-kernel . ..
     Update the kernel tree in the current directory using patches in the
     directory above to the latest Linus kernel
  scripts/patch-kernel . .. -ac
     Get the latest Linux kernel and patch it with the latest ac patch
  scripts/patch-kernel . .. 2.4.9
     Gets standard kernel 2.4.9
  scripts/patch-kernel . .. 2.4.9 -ac
     Gets 2.4.9 with latest ac patches
  scripts/patch-kernel . .. 2.4.9 -ac11
     Gets 2.4.9 with ac patch ac11
  Note: It uses the patches relative to the Linus kernels, not the
  ac to ac relative patches</p>

<p>It determines the current kernel version from the top-level Makefile.
It then looks for patches for the next sublevel in the patch directory.
This is applied using "patch -p1 -s" from within the kernel directory.
A check is then made for "<em>.rej" files to see if the patch was
successful.  If it is, then all of the "</em>.orig" files are removed.</p>

<pre><code>  Nick Holloway &lt;Nick.Holloway@alfie.demon.co.uk&gt;, 2nd January 1995.
</code></pre>

<p>Added support for handling multiple types of compression. What includes
gzip, bzip, bzip2, zip, compress, and plaintext. </p>

<pre><code>  Adam Sulmicki &lt;adam@cfar.umd.edu&gt;, 1st January 1997.
</code></pre>

<p>Added ability to stop at a given version number
Put the full version number (i.e. 2.3.31) as the last parameter
      Dave Gilbert <a href="&#x6D;&#97;&#105;&#x6C;&#x74;&#x6F;:&#x6C;&#x69;&#x6E;&#x75;&#120;&#64;&#x74;&#114;&#x65;&#x62;&#x6C;&#x69;&#x67;.&#x6F;&#114;&#103;">&#x6C;&#x69;&#x6E;&#x75;&#120;&#64;&#x74;&#114;&#x65;&#x62;&#x6C;&#x69;&#x67;.&#x6F;&#114;&#103;</a>, 11th December 1999.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Fixed previous patch so that if we are already at the correct version
not to patch up.</p>

<p>Added -ac option, use -ac or -ac9 (say) to stop at a particular version
      Dave Gilbert <a href="&#109;&#97;&#x69;&#x6C;&#116;&#111;:&#108;&#x69;&#x6E;&#x75;&#120;&#x40;&#116;&#x72;&#x65;&#98;&#108;&#x69;&#x67;&#x2E;&#x6F;&#x72;&#103;">&#108;&#x69;&#x6E;&#x75;&#120;&#x40;&#116;&#x72;&#x65;&#98;&#108;&#x69;&#x67;&#x2E;&#x6F;&#x72;&#103;</a>, 29th September 2001.</p>

<p>Add support for (use of) EXTRAVERSION (to support 2.6.8.x, e.g.);
update usage message;
fix some whitespace damage;
be smarter about stopping when current version is larger than requested;
Randy Dunlap <a href="&#x6D;&#x61;&#105;&#108;&#116;&#x6F;:&#114;&#x64;u&#110;l&#x61;&#x70;&#x40;&#x78;&#101;&#x6E;&#111;&#116;i&#109;&#x65;&#46;&#110;&#101;t">&#114;&#x64;u&#110;l&#x61;&#x70;&#x40;&#x78;&#101;&#x6E;&#111;&#116;i&#109;&#x65;&#46;&#110;&#101;t</a>, 2004-AUG-18.</p>

<p>Add better support for (non-incremental) 2.6.x.y patches;
If an ending version number if not specified, the script automatically
increments the SUBLEVEL (x in 2.6.x.y) until no more patch files are found;
however, EXTRAVERSION (y in 2.6.x.y) is never automatically incremented
but must be specified fully.</p>

<p>patch-kernel does not normally support reverse patching, but does so when
applying EXTRAVERSION (x.y) patches, so that moving from 2.6.11.y to 2.6.11.z
is easy and handled by the script (reverse 2.6.11.y and apply 2.6.11.z).
Randy Dunlap <a href="&#109;&#x61;&#x69;&#108;&#116;&#111;:&#114;d&#117;&#x6E;&#108;&#97;&#x70;&#64;x&#101;&#x6E;&#111;&#116;&#105;&#109;&#101;&#46;&#110;&#101;&#116;">&#114;d&#117;&#x6E;&#108;&#97;&#x70;&#64;x&#101;&#x6E;&#111;&#116;&#105;&#109;&#101;&#46;&#110;&#101;&#116;</a>, 2005-APR-08.</p></td><td class="code"><div class="highlight"><pre><span class="nv">PNAME</span><span class="o">=</span>patch-kernel</pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Set directories from arguments, or use defaults.</p></td><td class="code"><div class="highlight"><pre><span class="nv">sourcedir</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="p">-/usr/src/linux</span><span class="k">}</span>
<span class="nv">patchdir</span><span class="o">=</span><span class="k">${</span><span class="nv">2</span><span class="p">-.</span><span class="k">}</span>
<span class="nv">stopvers</span><span class="o">=</span><span class="k">${</span><span class="nv">3</span><span class="p">-default</span><span class="k">}</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$1&quot;</span> <span class="o">=</span> -h -o <span class="s2">&quot;$1&quot;</span> <span class="o">=</span> --help -o ! -r <span class="s2">&quot;$sourcedir/Makefile&quot;</span> <span class="o">]</span>; <span class="k">then</span>
cat <span class="s">&lt;&lt; USAGE</span>
<span class="s">usage: $PNAME [-h] [ sourcedir [ patchdir [ stopversion ] [ -acxx ] ] ]</span>
<span class="s">  source directory defaults to /usr/src/linux,</span>
<span class="s">  patch directory defaults to the current directory,</span>
<span class="s">  stopversion defaults to &lt;all in patchdir&gt;.</span>
<span class="s">USAGE</span>
<span class="nb">exit </span>1
<span class="k">fi</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>See if we have any -ac options</p></td><td class="code"><div class="highlight"><pre><span class="k">for </span>PARM in <span class="nv">$*</span>
<span class="k">do</span>
<span class="k">  case</span> <span class="nv">$PARM</span> in
	  -ac*<span class="o">)</span>
		  <span class="nv">gotac</span><span class="o">=</span><span class="nv">$PARM</span>;

	<span class="k">esac</span>;
<span class="k">done</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><hr />

<p>arg1 is filename</p></td><td class="code"><div class="highlight"><pre>noFile <span class="o">()</span> <span class="o">{</span>
	<span class="nb">echo</span> <span class="s2">&quot;cannot find patch file: ${patch}&quot;</span>
	<span class="nb">exit </span>1
<span class="o">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre>backwards <span class="o">()</span> <span class="o">{</span>
	<span class="nb">echo</span> <span class="s2">&quot;$PNAME does not support reverse patching&quot;</span>
	<span class="nb">exit </span>1
<span class="o">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><hr />

<p>Find a file, first parameter is basename of file
it tries many compression mechanisms and sets variables to say how to get it</p></td><td class="code"><div class="highlight"><pre>findFile <span class="o">()</span> <span class="o">{</span>
  <span class="nv">filebase</span><span class="o">=</span><span class="nv">$1</span>;

  <span class="k">if</span> <span class="o">[</span> -r <span class="k">${</span><span class="nv">filebase</span><span class="k">}</span>.gz <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">ext</span><span class="o">=</span><span class="s2">&quot;.gz&quot;</span>
		<span class="nv">name</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span>
		<span class="nv">uncomp</span><span class="o">=</span><span class="s2">&quot;gunzip -dc&quot;</span>
  <span class="k">elif</span> <span class="o">[</span> -r <span class="k">${</span><span class="nv">filebase</span><span class="k">}</span>.bz  <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">ext</span><span class="o">=</span><span class="s2">&quot;.bz&quot;</span>
		<span class="nv">name</span><span class="o">=</span><span class="s2">&quot;bzip&quot;</span>
		<span class="nv">uncomp</span><span class="o">=</span><span class="s2">&quot;bunzip -dc&quot;</span>
  <span class="k">elif</span> <span class="o">[</span> -r <span class="k">${</span><span class="nv">filebase</span><span class="k">}</span>.bz2 <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">ext</span><span class="o">=</span><span class="s2">&quot;.bz2&quot;</span>
		<span class="nv">name</span><span class="o">=</span><span class="s2">&quot;bzip2&quot;</span>
		<span class="nv">uncomp</span><span class="o">=</span><span class="s2">&quot;bunzip2 -dc&quot;</span>
  <span class="k">elif</span> <span class="o">[</span> -r <span class="k">${</span><span class="nv">filebase</span><span class="k">}</span>.xz <span class="o">]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">ext</span><span class="o">=</span><span class="s2">&quot;.xz&quot;</span>
                <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;xz&quot;</span>
                <span class="nv">uncomp</span><span class="o">=</span><span class="s2">&quot;xz -dc&quot;</span>
  <span class="k">elif</span> <span class="o">[</span> -r <span class="k">${</span><span class="nv">filebase</span><span class="k">}</span>.zip <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">ext</span><span class="o">=</span><span class="s2">&quot;.zip&quot;</span>
		<span class="nv">name</span><span class="o">=</span><span class="s2">&quot;zip&quot;</span>
		<span class="nv">uncomp</span><span class="o">=</span><span class="s2">&quot;unzip -d&quot;</span>
  <span class="k">elif</span> <span class="o">[</span> -r <span class="k">${</span><span class="nv">filebase</span><span class="k">}</span>.Z <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">ext</span><span class="o">=</span><span class="s2">&quot;.Z&quot;</span>
		<span class="nv">name</span><span class="o">=</span><span class="s2">&quot;uncompress&quot;</span>
		<span class="nv">uncomp</span><span class="o">=</span><span class="s2">&quot;uncompress -c&quot;</span>
  <span class="k">elif</span> <span class="o">[</span> -r <span class="k">${</span><span class="nv">filebase</span><span class="k">}</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">ext</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
		<span class="nv">name</span><span class="o">=</span><span class="s2">&quot;plaintext&quot;</span>
		<span class="nv">uncomp</span><span class="o">=</span><span class="s2">&quot;cat&quot;</span>
  <span class="k">else</span>
<span class="k">	return </span>1;
  <span class="k">fi</span>

<span class="k">  return </span>0;
<span class="o">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><hr />

<p>Apply a patch and check it goes in cleanly
First param is patch name (e.g. patch-2.4.9-ac5) - without path or extension</p></td><td class="code"><div class="highlight"><pre>applyPatch <span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;Applying $1 (${name})... &quot;</span>
  <span class="k">if</span> <span class="nv">$uncomp</span> <span class="k">${</span><span class="nv">patchdir</span><span class="k">}</span>/<span class="nv">$1</span><span class="k">${</span><span class="nv">ext</span><span class="k">}</span> | patch -p1 -s -N -E -d <span class="nv">$sourcedir</span>
  <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;done.&quot;</span>
  <span class="k">else</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;failed.  Clean up yourself.&quot;</span>
    <span class="k">return </span>1;
  <span class="k">fi</span>
<span class="k">  if</span> <span class="o">[</span> <span class="s2">&quot;`find $sourcedir/ &#39;(&#39; -name &#39;*.rej&#39; -o -name &#39;.*.rej&#39; &#39;)&#39; -print`&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Aborting.  Reject files found.&quot;</span>
    <span class="k">return </span>1;
  <span class="k">fi</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Remove backup files</p></td><td class="code"><div class="highlight"><pre>  find <span class="nv">$sourcedir</span>/ <span class="s1">&#39;(&#39;</span> -name <span class="s1">&#39;*.orig&#39;</span> -o -name <span class="s1">&#39;.*.orig&#39;</span> <span class="s1">&#39;)&#39;</span> -exec rm -f <span class="o">{}</span> <span class="se">\;</span>
 
  <span class="k">return </span>0;
<span class="o">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><hr />

<p>arg1 is patch filename</p></td><td class="code"><div class="highlight"><pre>reversePatch <span class="o">()</span> <span class="o">{</span>
	<span class="nb">echo</span> -n <span class="s2">&quot;Reversing $1 (${name}) ... &quot;</span>
	<span class="k">if</span> <span class="nv">$uncomp</span> <span class="k">${</span><span class="nv">patchdir</span><span class="k">}</span>/<span class="s2">&quot;$1&quot;</span><span class="k">${</span><span class="nv">ext</span><span class="k">}</span> | patch -p1 -Rs -N -E -d <span class="nv">$sourcedir</span>
	<span class="k">then</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;done.&quot;</span>
	<span class="k">else</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;failed.  Clean it up.&quot;</span>
		<span class="nb">exit </span>1
	<span class="k">fi</span>
<span class="k">	if</span> <span class="o">[</span> <span class="s2">&quot;`find $sourcedir/ &#39;(&#39; -name &#39;*.rej&#39; -o -name &#39;.*.rej&#39; &#39;)&#39; -print`&quot;</span> <span class="o">]</span>
	<span class="k">then</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;Aborting.  Reject files found.&quot;</span>
		<span class="k">return </span>1
	<span class="k">fi</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Remove backup files</p></td><td class="code"><div class="highlight"><pre>	find <span class="nv">$sourcedir</span>/ <span class="s1">&#39;(&#39;</span> -name <span class="s1">&#39;*.orig&#39;</span> -o -name <span class="s1">&#39;.*.orig&#39;</span> <span class="s1">&#39;)&#39;</span> -exec rm -f <span class="o">{}</span> <span class="se">\;</span>

	<span class="k">return </span>0
<span class="o">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>set current VERSION, PATCHLEVEL, SUBLEVEL, EXTRAVERSION
force $TMPFILEs below to be in local directory: a slash character prevents
the dot command from using the search path.</p></td><td class="code"><div class="highlight"><pre><span class="nv">TMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp ./.tmpver.XXXXXX<span class="sb">`</span> <span class="o">||</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;cannot make temp file&quot;</span> ; <span class="nb">exit </span>1; <span class="o">}</span>
grep -E <span class="s2">&quot;^(VERSION|PATCHLEVEL|SUBLEVEL|EXTRAVERSION)&quot;</span> <span class="nv">$sourcedir</span>/Makefile &gt; <span class="nv">$TMPFILE</span>
tr -d <span class="o">[</span>:blank:<span class="o">]</span> &lt; <span class="nv">$TMPFILE</span> &gt; <span class="nv">$TMPFILE</span>.1
. <span class="nv">$TMPFILE</span>.1
rm -f <span class="nv">$TMPFILE</span>*
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$VERSION&quot;</span> -o -z <span class="s2">&quot;$PATCHLEVEL&quot;</span> -o -z <span class="s2">&quot;$SUBLEVEL&quot;</span> <span class="o">]</span>
<span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;unable to determine current kernel version&quot;</span> &gt;&amp;2
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="nv">NAME</span><span class="o">=</span><span class="sb">`</span>grep ^NAME <span class="nv">$sourcedir</span>/Makefile<span class="sb">`</span>
<span class="nv">NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">NAME</span><span class="p">##*=</span><span class="k">}</span>

<span class="nb">echo</span> <span class="s2">&quot;Current kernel version is $VERSION.$PATCHLEVEL.$SUBLEVEL${EXTRAVERSION} ($NAME)&quot;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>strip EXTRAVERSION to just a number (drop leading '.' and trailing additions)</p></td><td class="code"><div class="highlight"><pre><span class="nv">EXTRAVER</span><span class="o">=</span>
<span class="k">if</span> <span class="o">[</span> x<span class="nv">$EXTRAVERSION</span> !<span class="o">=</span> <span class="s2">&quot;x&quot;</span> <span class="o">]</span>
<span class="k">then</span>
<span class="k">	</span><span class="nv">EXTRAVER</span><span class="o">=</span><span class="k">${</span><span class="nv">EXTRAVERSION</span><span class="p">#.</span><span class="k">}</span>
	<span class="nv">EXTRAVER</span><span class="o">=</span><span class="k">${</span><span class="nv">EXTRAVER</span><span class="p">%%[[:</span><span class="nv">punct</span><span class="p">:]]*</span><span class="k">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>echo "$PNAME: changing EXTRAVERSION from $EXTRAVERSION to $EXTRAVER"</p></td><td class="code"><div class="highlight"><pre><span class="k">fi</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>echo "stopvers=$stopvers"</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="o">[</span> <span class="nv">$stopvers</span> !<span class="o">=</span> <span class="s2">&quot;default&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span><span class="nv">STOPSUBLEVEL</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$stopvers</span> | cut -d. -f3<span class="sb">`</span>
	<span class="nv">STOPEXTRA</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$stopvers</span> | cut -d. -f4<span class="sb">`</span>
	<span class="nv">STOPFULLVERSION</span><span class="o">=</span><span class="k">${</span><span class="nv">stopvers</span><span class="p">%%.</span><span class="nv">$STOPEXTRA</span><span class="k">}</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>echo "#<em>_</em>STOPSUBLEVEL=/$STOPSUBLEVEL/, STOPEXTRA=/$STOPEXTRA/"</p></td><td class="code"><div class="highlight"><pre><span class="k">else</span>
<span class="k">	</span><span class="nv">STOPSUBLEVEL</span><span class="o">=</span>9999
	<span class="nv">STOPEXTRA</span><span class="o">=</span>9999
<span class="k">fi</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>This all assumes a 2.6.x[.y] kernel tree.
Don't allow backwards/reverse patching.</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="o">[</span> <span class="nv">$STOPSUBLEVEL</span> -lt <span class="nv">$SUBLEVEL</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>backwards
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> x<span class="nv">$EXTRAVER</span> !<span class="o">=</span> <span class="s2">&quot;x&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span><span class="nv">CURRENTFULLVERSION</span><span class="o">=</span><span class="s2">&quot;$VERSION.$PATCHLEVEL.$SUBLEVEL.$EXTRAVER&quot;</span>
<span class="k">else</span>
<span class="k">	</span><span class="nv">CURRENTFULLVERSION</span><span class="o">=</span><span class="s2">&quot;$VERSION.$PATCHLEVEL.$SUBLEVEL&quot;</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> x<span class="nv">$EXTRAVER</span> !<span class="o">=</span> <span class="s2">&quot;x&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span><span class="nb">echo</span> <span class="s2">&quot;backing up to: $VERSION.$PATCHLEVEL.$SUBLEVEL&quot;</span>
	<span class="nv">patch</span><span class="o">=</span><span class="s2">&quot;patch-${CURRENTFULLVERSION}&quot;</span>
	findFile <span class="nv">$patchdir</span>/<span class="k">${</span><span class="nv">patch</span><span class="k">}</span> <span class="o">||</span> noFile <span class="k">${</span><span class="nv">patch</span><span class="k">}</span>
	reversePatch <span class="k">${</span><span class="nv">patch</span><span class="k">}</span> <span class="o">||</span> <span class="nb">exit </span>1
<span class="k">fi</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>now current is 2.6.x, with no EXTRA applied,
so update to target SUBLEVEL (2.6.SUBLEVEL)
and then to target EXTRAVER (2.6.SUB.EXTRAVER) if requested.
If not ending sublevel is specified, it is incremented until
no further sublevels are found.</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="o">[</span> <span class="nv">$STOPSUBLEVEL</span> -gt <span class="nv">$SUBLEVEL</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">while</span> :				<span class="c"># incrementing SUBLEVEL (s in v.p.s)</span>
<span class="k">do</span>
<span class="k">    </span><span class="nv">CURRENTFULLVERSION</span><span class="o">=</span><span class="s2">&quot;$VERSION.$PATCHLEVEL.$SUBLEVEL&quot;</span>
    <span class="nv">EXTRAVER</span><span class="o">=</span>
    <span class="k">if</span> <span class="o">[</span> x<span class="nv">$STOPFULLVERSION</span> <span class="o">=</span> x<span class="nv">$CURRENTFULLVERSION</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Stopping at $CURRENTFULLVERSION base as requested.&quot;</span>
        <span class="nb">break</span>
<span class="nb">    </span><span class="k">fi</span>

<span class="k">    </span><span class="nv">SUBLEVEL</span><span class="o">=</span><span class="k">$((</span><span class="nv">$SUBLEVEL</span> <span class="o">+</span> <span class="m">1</span><span class="k">))</span>
    <span class="nv">FULLVERSION</span><span class="o">=</span><span class="s2">&quot;$VERSION.$PATCHLEVEL.$SUBLEVEL&quot;</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>echo "#<strong>_ trying $FULLVERSION _</strong>"</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="o">[</span> <span class="k">$((</span><span class="nv">$SUBLEVEL</span><span class="k">))</span> -gt <span class="k">$((</span><span class="nv">$STOPSUBLEVEL</span><span class="k">))</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span><span class="nb">echo</span> <span class="s2">&quot;Stopping since sublevel ($SUBLEVEL) is beyond stop-sublevel ($STOPSUBLEVEL)&quot;</span>
	<span class="nb">exit </span>1
    <span class="k">fi</span>

<span class="k">    </span><span class="nv">patch</span><span class="o">=</span>patch-<span class="nv">$FULLVERSION</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>See if the file exists and find extension</p></td><td class="code"><div class="highlight"><pre>    findFile <span class="nv">$patchdir</span>/<span class="k">${</span><span class="nv">patch</span><span class="k">}</span> <span class="o">||</span> noFile <span class="k">${</span><span class="nv">patch</span><span class="k">}</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Apply the patch and check all is OK</p></td><td class="code"><div class="highlight"><pre>    applyPatch <span class="nv">$patch</span> <span class="o">||</span> <span class="nb">break</span>
<span class="k">done</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>echo "#<em>_</em>sublevel all done"</p></td><td class="code"><div class="highlight"><pre><span class="k">fi</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>There is no incremental searching for extraversion...</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$STOPEXTRA&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">while</span> :				<span class="c"># just to allow break</span>
<span class="k">do</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>apply STOPEXTRA directly (not incrementally) (x in v.p.s.x)</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">FULLVERSION</span><span class="o">=</span><span class="s2">&quot;$VERSION.$PATCHLEVEL.$SUBLEVEL.$STOPEXTRA&quot;</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>echo "#... trying $FULLVERSION ..."</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">patch</span><span class="o">=</span>patch-<span class="nv">$FULLVERSION</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>See if the file exists and find extension</p></td><td class="code"><div class="highlight"><pre>	findFile <span class="nv">$patchdir</span>/<span class="k">${</span><span class="nv">patch</span><span class="k">}</span> <span class="o">||</span> noFile <span class="k">${</span><span class="nv">patch</span><span class="k">}</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Apply the patch and check all is OK</p></td><td class="code"><div class="highlight"><pre>	applyPatch <span class="nv">$patch</span> <span class="o">||</span> <span class="nb">break</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>echo "#<em>_</em>extraver all done"</p></td><td class="code"><div class="highlight"><pre>	<span class="nb">break</span>
<span class="k">done</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> x<span class="nv">$gotac</span> !<span class="o">=</span> x <span class="o">]</span>; <span class="k">then</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Out great user wants the -ac patches
They could have done -ac (get latest) or -acxx where xx=version they want</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="o">[</span> <span class="nv">$gotac</span> <span class="o">=</span> <span class="s2">&quot;-ac&quot;</span> <span class="o">]</span>; <span class="k">then</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>They want the latest version</p></td><td class="code"><div class="highlight"><pre>		<span class="nv">HIGHESTPATCH</span><span class="o">=</span>0
		<span class="k">for </span>PATCHNAMES in <span class="nv">$patchdir</span>/patch-<span class="k">${</span><span class="nv">CURRENTFULLVERSION</span><span class="k">}</span>-ac*<span class="se">\.</span>*
		<span class="k">do</span>
<span class="k">			</span><span class="nv">ACVALUE</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$PATCHNAMES</span> | sed -e <span class="s1">&#39;s/^.*patch-[0-9.]*-ac\([0-9]*\).*/\1/&#39;</span><span class="sb">`</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Check it is actually a recognised patch type</p></td><td class="code"><div class="highlight"><pre>			findFile <span class="nv">$patchdir</span>/patch-<span class="k">${</span><span class="nv">CURRENTFULLVERSION</span><span class="k">}</span>-ac<span class="k">${</span><span class="nv">ACVALUE</span><span class="k">}</span> <span class="o">||</span> <span class="nb">break</span>

<span class="nb">		  </span><span class="k">if</span> <span class="o">[</span> <span class="nv">$ACVALUE</span> -gt <span class="nv">$HIGHESTPATCH</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">			  </span><span class="nv">HIGHESTPATCH</span><span class="o">=</span><span class="nv">$ACVALUE</span>
		  <span class="k">fi</span>
<span class="k">		done</span>

<span class="k">		if</span> <span class="o">[</span> <span class="nv">$HIGHESTPATCH</span> -ne 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">			</span>findFile <span class="nv">$patchdir</span>/patch-<span class="k">${</span><span class="nv">CURRENTFULLVERSION</span><span class="k">}</span>-ac<span class="k">${</span><span class="nv">HIGHESTPATCH</span><span class="k">}</span> <span class="o">||</span> <span class="nb">break</span>
<span class="nb">			</span>applyPatch patch-<span class="k">${</span><span class="nv">CURRENTFULLVERSION</span><span class="k">}</span>-ac<span class="k">${</span><span class="nv">HIGHESTPATCH</span><span class="k">}</span>
		<span class="k">else</span>
<span class="k">		  </span><span class="nb">echo</span> <span class="s2">&quot;No -ac patches found&quot;</span>
		<span class="k">fi</span>
<span class="k">	else</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>They want an exact version</p></td><td class="code"><div class="highlight"><pre>		findFile <span class="nv">$patchdir</span>/patch-<span class="k">${</span><span class="nv">CURRENTFULLVERSION</span><span class="k">}${</span><span class="nv">gotac</span><span class="k">}</span> <span class="o">||</span> <span class="o">{</span>
		  <span class="nb">echo</span> <span class="s2">&quot;Sorry, I couldn&#39;t find the $gotac patch for $CURRENTFULLVERSION.  Hohum.&quot;</span>
			<span class="nb">exit </span>1
		<span class="o">}</span>
		applyPatch patch-<span class="k">${</span><span class="nv">CURRENTFULLVERSION</span><span class="k">}${</span><span class="nv">gotac</span><span class="k">}</span>
	<span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
