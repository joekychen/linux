<!DOCTYPE html>
<html><head><title>joekychen/linux » virt › kvm › assigned-dev.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>assigned-dev.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Kernel-based Virtual Machine - device assignment support</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Red Hat, Inc. and/or its affiliates.</span>
<span class="cm"> *</span>
<span class="cm"> * This work is licensed under the terms of the GNU GPL, version 2.  See</span>
<span class="cm"> * the COPYING file in the top-level directory.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kvm_host.h&gt;</span>
<span class="cp">#include &lt;linux/kvm.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &quot;irq.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="nf">kvm_find_assigned_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
						      <span class="kt">int</span> <span class="n">assigned_dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">match</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">assigned_dev_id</span> <span class="o">==</span> <span class="n">assigned_dev_id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">match</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_index_from_host_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span>
				    <span class="o">*</span><span class="n">assigned_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="o">*</span><span class="n">host_msix_entries</span><span class="p">;</span>

	<span class="n">host_msix_entries</span> <span class="o">=</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">host_msix_entries</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">entries_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="n">host_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Fail to find correlated MSI-X entry!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">kvm_assigned_dev_intx</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">assigned_dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">intx_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_check_and_mask_intx</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">host_irq_disabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_WAKE_THREAD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">intx_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">kvm_assigned_dev_raise_guest_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">assigned_dev</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">vector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">irq_requested_type</span> <span class="o">&amp;</span>
		     <span class="n">KVM_DEV_IRQ_GUEST_INTX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">intx_mask_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_ASSIGN_MASK_INTX</span><span class="p">))</span>
			<span class="n">kvm_set_irq</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span>
				    <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">irq_source_id</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">intx_mask_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">kvm_set_irq</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">irq_source_id</span><span class="p">,</span>
			    <span class="n">vector</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">kvm_assigned_dev_thread_intx</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">assigned_dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_ASSIGN_PCI_2_3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">intx_lock</span><span class="p">);</span>
		<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">host_irq_disabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">intx_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kvm_assigned_dev_raise_guest_irq</span><span class="p">(</span><span class="n">assigned_dev</span><span class="p">,</span>
					 <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">guest_irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef __KVM_HAVE_MSI</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">kvm_assigned_dev_thread_msi</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">assigned_dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">kvm_assigned_dev_raise_guest_irq</span><span class="p">(</span><span class="n">assigned_dev</span><span class="p">,</span>
					 <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">guest_irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef __KVM_HAVE_MSIX</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">kvm_assigned_dev_thread_msix</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">assigned_dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">find_index_from_host_irq</span><span class="p">(</span><span class="n">assigned_dev</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">vector</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vector</span> <span class="o">=</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">guest_msix_entries</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
		<span class="n">kvm_assigned_dev_raise_guest_irq</span><span class="p">(</span><span class="n">assigned_dev</span><span class="p">,</span> <span class="n">vector</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Ack the irq line for an assigned device */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_assigned_dev_ack_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_irq_ack_notifier</span> <span class="o">*</span><span class="n">kian</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">kian</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span><span class="p">,</span>
			     <span class="n">ack_notifier</span><span class="p">);</span>

	<span class="n">kvm_set_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_source_id</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">guest_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intx_mask_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_ASSIGN_MASK_INTX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">reassert</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intx_lock</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * The guest IRQ may be shared so this ack can come from an</span>
<span class="cm">		 * IRQ for another guest device.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_irq_disabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_ASSIGN_PCI_2_3</span><span class="p">))</span>
				<span class="n">enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_irq</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_check_and_unmask_intx</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">reassert</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_irq_disabled</span> <span class="o">=</span> <span class="n">reassert</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intx_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reassert</span><span class="p">)</span>
			<span class="n">kvm_set_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_source_id</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">guest_irq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intx_mask_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">deassign_guest_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">assigned_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">ack_notifier</span><span class="p">.</span><span class="n">gsi</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">kvm_unregister_irq_ack_notifier</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">ack_notifier</span><span class="p">);</span>

	<span class="n">kvm_set_irq</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">irq_source_id</span><span class="p">,</span>
		    <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">guest_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">irq_source_id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">kvm_free_irq_source_id</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">irq_source_id</span><span class="p">);</span>
	<span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">irq_source_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">irq_requested_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">KVM_DEV_IRQ_GUEST_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The function implicit hold kvm-&gt;lock mutex due to cancel_work_sync() */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">deassign_host_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">assigned_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We disable irq here to prevent further events.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Notice this maybe result in nested disable if the interrupt type is</span>
<span class="cm">	 * INTx, but it&#39;s OK for we are going to free it.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If this function is a part of VM destroy, please ensure that till</span>
<span class="cm">	 * now, the kvm state is still legal for probably we also have to wait</span>
<span class="cm">	 * on a currently running IRQ handler.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">irq_requested_type</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_IRQ_HOST_MSIX</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">entries_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">disable_irq</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">host_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">entries_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">host_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
				 <span class="n">assigned_dev</span><span class="p">);</span>

		<span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">entries_nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">host_msix_entries</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">guest_msix_entries</span><span class="p">);</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Deal with MSI and INTx */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">irq_requested_type</span> <span class="o">&amp;</span>
		     <span class="n">KVM_DEV_IRQ_HOST_INTX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_ASSIGN_PCI_2_3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">intx_lock</span><span class="p">);</span>
			<span class="n">pci_intx</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">intx_lock</span><span class="p">);</span>
			<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">host_irq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">disable_irq</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">host_irq</span><span class="p">);</span>

		<span class="n">free_irq</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">host_irq</span><span class="p">,</span> <span class="n">assigned_dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">irq_requested_type</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_IRQ_HOST_MSI</span><span class="p">)</span>
			<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">irq_requested_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">KVM_DEV_IRQ_HOST_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_deassign_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">assigned_dev</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_requested_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">guest_irq_type</span><span class="p">,</span> <span class="n">host_irq_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqchip_in_kernel</span><span class="p">(</span><span class="n">kvm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* no irq assignment to deassign */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">irq_requested_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">host_irq_type</span> <span class="o">=</span> <span class="n">irq_requested_type</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_IRQ_HOST_MASK</span><span class="p">;</span>
	<span class="n">guest_irq_type</span> <span class="o">=</span> <span class="n">irq_requested_type</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_IRQ_GUEST_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host_irq_type</span><span class="p">)</span>
		<span class="n">deassign_host_irq</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">assigned_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">guest_irq_type</span><span class="p">)</span>
		<span class="n">deassign_guest_irq</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">assigned_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_free_assigned_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">assigned_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kvm_deassign_irq</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">assigned_dev</span><span class="p">,</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">irq_requested_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_free_assigned_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span>
				     <span class="o">*</span><span class="n">assigned_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kvm_free_assigned_irq</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">assigned_dev</span><span class="p">);</span>

	<span class="n">pci_reset_function</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_load_and_free_saved_state</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">pci_saved_state</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Couldn&#39;t reload %s saved state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_DEV_FLAGS_ASSIGNED</span><span class="p">;</span>

	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">assigned_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_free_all_assigned_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">assigned_dev</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">assigned_dev_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">assigned_dev</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span><span class="p">,</span>
					  <span class="n">list</span><span class="p">);</span>

		<span class="n">kvm_free_assigned_device</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">assigned_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">assigned_device_enable_host_intx</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irq_handler_t</span> <span class="n">irq_handler</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can only share the IRQ line with other host devices if we are</span>
<span class="cm">	 * able to disable the IRQ source at device-level - independently of</span>
<span class="cm">	 * the guest driver. Otherwise host devices may suffer from unbounded</span>
<span class="cm">	 * IRQ latencies when the guest keeps the line asserted.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_ASSIGN_PCI_2_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_handler</span> <span class="o">=</span> <span class="n">kvm_assigned_dev_intx</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">irq_handler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">IRQF_ONESHOT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_irq</span><span class="p">,</span> <span class="n">irq_handler</span><span class="p">,</span>
				 <span class="n">kvm_assigned_dev_thread_intx</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_ASSIGN_PCI_2_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intx_lock</span><span class="p">);</span>
		<span class="n">pci_intx</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intx_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef __KVM_HAVE_MSI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">assigned_device_enable_host_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				 <span class="n">kvm_assigned_dev_thread_msi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef __KVM_HAVE_MSIX</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">assigned_device_enable_host_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* host_msix_entries and guest_msix_entries should have been</span>
<span class="cm">	 * initialized */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entries_nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_msix_entries</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">entries_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">entries_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
					 <span class="nb">NULL</span><span class="p">,</span> <span class="n">kvm_assigned_dev_thread_msix</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">assigned_device_enable_guest_intx</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">kvm_assigned_irq</span> <span class="o">*</span><span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">guest_irq</span> <span class="o">=</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">guest_irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ack_notifier</span><span class="p">.</span><span class="n">gsi</span> <span class="o">=</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">guest_irq</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef __KVM_HAVE_MSI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">assigned_device_enable_guest_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">kvm_assigned_irq</span> <span class="o">*</span><span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">guest_irq</span> <span class="o">=</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">guest_irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ack_notifier</span><span class="p">.</span><span class="n">gsi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef __KVM_HAVE_MSIX</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">assigned_device_enable_guest_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">kvm_assigned_irq</span> <span class="o">*</span><span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">guest_irq</span> <span class="o">=</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">guest_irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ack_notifier</span><span class="p">.</span><span class="n">gsi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">assign_host_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="n">__u32</span> <span class="n">host_irq_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_requested_type</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_IRQ_HOST_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">),</span> <span class="s">&quot;kvm:%s&quot;</span><span class="p">,</span>
		 <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">host_irq_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KVM_DEV_IRQ_HOST_INTX</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">assigned_device_enable_host_intx</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef __KVM_HAVE_MSI</span>
	<span class="k">case</span> <span class="n">KVM_DEV_IRQ_HOST_MSI</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">assigned_device_enable_host_msi</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef __KVM_HAVE_MSIX</span>
	<span class="k">case</span> <span class="n">KVM_DEV_IRQ_HOST_MSIX</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">assigned_device_enable_host_msix</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_irq_disabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_requested_type</span> <span class="o">|=</span> <span class="n">host_irq_type</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">assign_guest_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">kvm_assigned_irq</span> <span class="o">*</span><span class="n">irq</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">guest_irq_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_requested_type</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_IRQ_GUEST_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">kvm_request_irq_source_id</span><span class="p">(</span><span class="n">kvm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_source_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">guest_irq_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KVM_DEV_IRQ_GUEST_INTX</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">assigned_device_enable_guest_intx</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef __KVM_HAVE_MSI</span>
	<span class="k">case</span> <span class="n">KVM_DEV_IRQ_GUEST_MSI</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">assigned_device_enable_guest_msi</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef __KVM_HAVE_MSIX</span>
	<span class="k">case</span> <span class="n">KVM_DEV_IRQ_GUEST_MSIX</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">assigned_device_enable_guest_msix</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_requested_type</span> <span class="o">|=</span> <span class="n">guest_irq_type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ack_notifier</span><span class="p">.</span><span class="n">gsi</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">kvm_register_irq_ack_notifier</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ack_notifier</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">kvm_free_irq_source_id</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_source_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TODO Deal with KVM_DEV_IRQ_ASSIGNED_MASK_MSIX */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_vm_ioctl_assign_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">kvm_assigned_irq</span> <span class="o">*</span><span class="n">assigned_irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">host_irq_type</span><span class="p">,</span> <span class="n">guest_irq_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqchip_in_kernel</span><span class="p">(</span><span class="n">kvm</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">match</span> <span class="o">=</span> <span class="n">kvm_find_assigned_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">assigned_dev_head</span><span class="p">,</span>
				      <span class="n">assigned_irq</span><span class="o">-&gt;</span><span class="n">assigned_dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">host_irq_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">assigned_irq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_IRQ_HOST_MASK</span><span class="p">);</span>
	<span class="n">guest_irq_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">assigned_irq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_IRQ_GUEST_MASK</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* can only assign one type at a time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hweight_long</span><span class="p">(</span><span class="n">host_irq_type</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hweight_long</span><span class="p">(</span><span class="n">guest_irq_type</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host_irq_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">guest_irq_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host_irq_type</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">assign_host_irq</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">host_irq_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">guest_irq_type</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">assign_guest_irq</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">assigned_irq</span><span class="p">,</span> <span class="n">guest_irq_type</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_vm_ioctl_deassign_dev_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">kvm_assigned_irq</span>
					 <span class="o">*</span><span class="n">assigned_irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_type</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">kvm_find_assigned_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">assigned_dev_head</span><span class="p">,</span>
				      <span class="n">assigned_irq</span><span class="o">-&gt;</span><span class="n">assigned_dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">irq_type</span> <span class="o">=</span> <span class="n">assigned_irq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">KVM_DEV_IRQ_HOST_MASK</span> <span class="o">|</span>
					  <span class="n">KVM_DEV_IRQ_GUEST_MASK</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_deassign_irq</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">irq_type</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We want to test whether the caller has been granted permissions to</span>
<span class="cm"> * use this device.  To be able to configure and control the device,</span>
<span class="cm"> * the user needs access to PCI configuration space and BAR resources.</span>
<span class="cm"> * These are accessed through PCI sysfs.  PCI config space is often</span>
<span class="cm"> * passed to the process calling this ioctl via file descriptor, so we</span>
<span class="cm"> * can&#39;t rely on access to that file.  We can check for permissions</span>
<span class="cm"> * on each of the BAR resource files, which is a pretty clear</span>
<span class="cm"> * indicator that the user has been granted access to the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">probe_sysfs_permissions</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SYSFS</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bar_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">PCI_STD_RESOURCES</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">PCI_STD_RESOURCE_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">kpath</span><span class="p">,</span> <span class="o">*</span><span class="n">syspath</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">path</span> <span class="n">path</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">kpath</span> <span class="o">=</span> <span class="n">kobject_get_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kpath</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="cm">/* Per sysfs-rules, sysfs is always at /sys */</span>
		<span class="n">syspath</span> <span class="o">=</span> <span class="n">kasprintf</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="s">&quot;/sys%s/resource%d&quot;</span><span class="p">,</span> <span class="n">kpath</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">kpath</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">syspath</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">kern_path</span><span class="p">(</span><span class="n">syspath</span><span class="p">,</span> <span class="n">LOOKUP_FOLLOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">syspath</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

		<span class="n">inode</span> <span class="o">=</span> <span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">inode_permission</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">MAY_READ</span> <span class="o">|</span> <span class="n">MAY_WRITE</span> <span class="o">|</span> <span class="n">MAY_ACCESS</span><span class="p">);</span>
		<span class="n">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

		<span class="n">bar_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If no resources, probably something special */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bar_found</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* No way to control the device without sysfs */</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_vm_ioctl_assign_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">kvm_assigned_pci_dev</span> <span class="o">*</span><span class="n">assigned_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_ASSIGN_ENABLE_IOMMU</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">srcu_read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">srcu</span><span class="p">);</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">kvm_find_assigned_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">assigned_dev_head</span><span class="p">,</span>
				      <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">assigned_dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* device already assigned */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Couldn&#39;t allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_domain_bus_and_slot</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">segnr</span><span class="p">,</span>
				   <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">busnr</span><span class="p">,</span>
				   <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: host device not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Don&#39;t allow bridges to be assigned */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span> <span class="o">!=</span> <span class="n">PCI_HEADER_TYPE_NORMAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">probe_sysfs_permissions</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Could not enable PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;kvm_assigned_device&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Could not get access to device regions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_reset_function</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">match</span><span class="o">-&gt;</span><span class="n">pci_saved_state</span> <span class="o">=</span> <span class="n">pci_store_saved_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">pci_saved_state</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Couldn&#39;t store %s saved state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_intx_mask_supported</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">KVM_DEV_ASSIGN_PCI_2_3</span><span class="p">;</span>

	<span class="n">match</span><span class="o">-&gt;</span><span class="n">assigned_dev_id</span> <span class="o">=</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">assigned_dev_id</span><span class="p">;</span>
	<span class="n">match</span><span class="o">-&gt;</span><span class="n">host_segnr</span> <span class="o">=</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">segnr</span><span class="p">;</span>
	<span class="n">match</span><span class="o">-&gt;</span><span class="n">host_busnr</span> <span class="o">=</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">busnr</span><span class="p">;</span>
	<span class="n">match</span><span class="o">-&gt;</span><span class="n">host_devfn</span> <span class="o">=</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>
	<span class="n">match</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">match</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">intx_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">intx_mask_lock</span><span class="p">);</span>
	<span class="n">match</span><span class="o">-&gt;</span><span class="n">irq_source_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">match</span><span class="o">-&gt;</span><span class="n">kvm</span> <span class="o">=</span> <span class="n">kvm</span><span class="p">;</span>
	<span class="n">match</span><span class="o">-&gt;</span><span class="n">ack_notifier</span><span class="p">.</span><span class="n">irq_acked</span> <span class="o">=</span> <span class="n">kvm_assigned_dev_ack_irq</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">assigned_dev_head</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">iommu_domain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_iommu_map_guest</span><span class="p">(</span><span class="n">kvm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_list_del</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_assign_device</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">match</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_list_del</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">srcu_read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">srcu</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="nl">out_list_del:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_load_and_free_saved_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">pci_saved_state</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Couldn&#39;t reload %s saved state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out_disable:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out_put:</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">match</span><span class="p">);</span>
	<span class="n">srcu_read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">srcu</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_vm_ioctl_deassign_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">kvm_assigned_pci_dev</span> <span class="o">*</span><span class="n">assigned_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">kvm_find_assigned_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">assigned_dev_head</span><span class="p">,</span>
				      <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">assigned_dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: device hasn&#39;t been assigned before, &quot;</span>
		  <span class="s">&quot;so cannot be deassigned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kvm_deassign_device</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">match</span><span class="p">);</span>

	<span class="n">kvm_free_assigned_device</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">match</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef __KVM_HAVE_MSIX</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_vm_ioctl_set_msix_nr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">kvm_assigned_msix_nr</span> <span class="o">*</span><span class="n">entry_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">adev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">adev</span> <span class="o">=</span> <span class="n">kvm_find_assigned_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">assigned_dev_head</span><span class="p">,</span>
				      <span class="n">entry_nr</span><span class="o">-&gt;</span><span class="n">assigned_dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">msix_nr_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">entries_nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">entries_nr</span> <span class="o">=</span> <span class="n">entry_nr</span><span class="o">-&gt;</span><span class="n">entry_nr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">entries_nr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">adev</span><span class="o">-&gt;</span><span class="n">entries_nr</span> <span class="o">&gt;</span> <span class="n">KVM_MAX_MSIX_PER_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">msix_nr_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">host_msix_entries</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msix_entry</span><span class="p">)</span> <span class="o">*</span>
						<span class="n">entry_nr</span><span class="o">-&gt;</span><span class="n">entry_nr</span><span class="p">,</span>
						<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">host_msix_entries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">msix_nr_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">guest_msix_entries</span> <span class="o">=</span>
			<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msix_entry</span><span class="p">)</span> <span class="o">*</span> <span class="n">entry_nr</span><span class="o">-&gt;</span><span class="n">entry_nr</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">guest_msix_entries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">host_msix_entries</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">msix_nr_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* Not allowed set MSI-X number twice */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">msix_nr_out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_vm_ioctl_set_msix_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">kvm_assigned_msix_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">adev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">adev</span> <span class="o">=</span> <span class="n">kvm_find_assigned_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">assigned_dev_head</span><span class="p">,</span>
				      <span class="n">entry</span><span class="o">-&gt;</span><span class="n">assigned_dev_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">msix_entry_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">entries_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">guest_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">adev</span><span class="o">-&gt;</span><span class="n">guest_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">==</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">guest_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">;</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">guest_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">gsi</span><span class="p">;</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">host_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">entries_nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">msix_entry_out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">msix_entry_out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_vm_ioctl_set_pci_irq_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">kvm_assigned_pci_dev</span> <span class="o">*</span><span class="n">assigned_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_assigned_dev_kernel</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">kvm_find_assigned_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">assigned_dev_head</span><span class="p">,</span>
				      <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">assigned_dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">intx_mask_lock</span><span class="p">);</span>

	<span class="n">match</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">KVM_DEV_ASSIGN_MASK_INTX</span><span class="p">;</span>
	<span class="n">match</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_ASSIGN_MASK_INTX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">irq_requested_type</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_IRQ_GUEST_INTX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_ASSIGN_MASK_INTX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kvm_set_irq</span><span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">irq_source_id</span><span class="p">,</span>
				    <span class="n">match</span><span class="o">-&gt;</span><span class="n">guest_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Masking at hardware-level is performed on demand,</span>
<span class="cm">			 * i.e. when an IRQ actually arrives at the host.</span>
<span class="cm">			 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">assigned_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_DEV_ASSIGN_PCI_2_3</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Unmask the IRQ line if required. Unmasking at</span>
<span class="cm">			 * device level will be performed by user space.</span>
<span class="cm">			 */</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">intx_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">host_irq_disabled</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">enable_irq</span><span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">host_irq</span><span class="p">);</span>
				<span class="n">match</span><span class="o">-&gt;</span><span class="n">host_irq_disabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">intx_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">intx_mask_lock</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">kvm_vm_ioctl_assigned_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ioctl</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KVM_ASSIGN_PCI_DEVICE</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_assigned_pci_dev</span> <span class="n">assigned_dev</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_dev</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">assigned_dev</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vm_ioctl_assign_device</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">assigned_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">KVM_ASSIGN_IRQ</span>: <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">KVM_ASSIGN_DEV_IRQ</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_assigned_irq</span> <span class="n">assigned_irq</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_irq</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">assigned_irq</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vm_ioctl_assign_irq</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">assigned_irq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">KVM_DEASSIGN_DEV_IRQ</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_assigned_irq</span> <span class="n">assigned_irq</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_irq</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">assigned_irq</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vm_ioctl_deassign_dev_irq</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">assigned_irq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">KVM_DEASSIGN_PCI_DEVICE</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_assigned_pci_dev</span> <span class="n">assigned_dev</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_dev</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">assigned_dev</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vm_ioctl_deassign_device</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">assigned_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef KVM_CAP_IRQ_ROUTING</span>
	<span class="k">case</span> <span class="n">KVM_SET_GSI_ROUTING</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_irq_routing</span> <span class="n">routing</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">kvm_irq_routing</span> <span class="n">__user</span> <span class="o">*</span><span class="n">urouting</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">kvm_irq_routing_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">routing</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">routing</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">routing</span><span class="p">.</span><span class="n">nr</span> <span class="o">&gt;=</span> <span class="n">KVM_MAX_IRQ_ROUTES</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">routing</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">entries</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">routing</span><span class="p">.</span><span class="n">nr</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entries</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">urouting</span> <span class="o">=</span> <span class="n">argp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">urouting</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span>
				   <span class="n">routing</span><span class="p">.</span><span class="n">nr</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out_free_irq_routing</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_set_irq_routing</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">routing</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span>
					<span class="n">routing</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="nl">out_free_irq_routing:</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">entries</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* KVM_CAP_IRQ_ROUTING */</span><span class="cp"></span>
<span class="cp">#ifdef __KVM_HAVE_MSIX</span>
	<span class="k">case</span> <span class="n">KVM_ASSIGN_SET_MSIX_NR</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_assigned_msix_nr</span> <span class="n">entry_nr</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry_nr</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">entry_nr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vm_ioctl_set_msix_nr</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry_nr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">KVM_ASSIGN_SET_MSIX_ENTRY</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_assigned_msix_entry</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">entry</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vm_ioctl_set_msix_entry</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">KVM_ASSIGN_SET_INTX_MASK</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_assigned_pci_dev</span> <span class="n">assigned_dev</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assigned_dev</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">assigned_dev</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vm_ioctl_set_pci_irq_mask</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">assigned_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
