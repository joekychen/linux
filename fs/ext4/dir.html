<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › ext4 › dir.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dir.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/fs/ext4/dir.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1992, 1993, 1994, 1995</span>
<span class="cm"> * Remy Card (card@masi.ibp.fr)</span>
<span class="cm"> * Laboratoire MASI - Institut Blaise Pascal</span>
<span class="cm"> * Universite Pierre et Marie Curie (Paris VI)</span>
<span class="cm"> *</span>
<span class="cm"> *  from</span>
<span class="cm"> *</span>
<span class="cm"> *  linux/fs/minix/dir.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1991, 1992  Linus Torvalds</span>
<span class="cm"> *</span>
<span class="cm"> *  ext4 directory handling functions</span>
<span class="cm"> *</span>
<span class="cm"> *  Big-endian to little-endian byte-swapping/bitmaps by</span>
<span class="cm"> *        David S. Miller (davem@caip.rutgers.edu), 1995</span>
<span class="cm"> *</span>
<span class="cm"> * Hash Tree Directory indexing (c) 2001  Daniel Phillips</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/jbd2.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/rbtree.h&gt;</span>
<span class="cp">#include &quot;ext4.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ext4_filetype_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DT_UNKNOWN</span><span class="p">,</span> <span class="n">DT_REG</span><span class="p">,</span> <span class="n">DT_DIR</span><span class="p">,</span> <span class="n">DT_CHR</span><span class="p">,</span> <span class="n">DT_BLK</span><span class="p">,</span> <span class="n">DT_FIFO</span><span class="p">,</span> <span class="n">DT_SOCK</span><span class="p">,</span> <span class="n">DT_LNK</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_dx_readdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">dirent</span><span class="p">,</span> <span class="n">filldir_t</span> <span class="n">filldir</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">get_dtype</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">filetype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_FILETYPE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">filetype</span> <span class="o">&gt;=</span> <span class="n">EXT4_FT_MAX</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">DT_UNKNOWN</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ext4_filetype_table</span><span class="p">[</span><span class="n">filetype</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Check if the given dir-inode refers to an htree-indexed directory</span>
<span class="cm"> * (or a directory which chould potentially get coverted to use htree</span>
<span class="cm"> * indexing).</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 if it is a dx dir, 0 if not</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_dx_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_COMPAT_FEATURE</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span>
		     <span class="n">EXT4_FEATURE_COMPAT_DIR_INDEX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">ext4_test_inode_flag</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">EXT4_INODE_INDEX</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">((</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&gt;&gt;</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return 0 if the directory entry is OK, and 1 if there is a problem</span>
<span class="cm"> *</span>
<span class="cm"> * Note: this is the opposite of what ext2 and ext3 historically returned...</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__ext4_check_dir_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ext4_dir_entry_2</span> <span class="o">*</span><span class="n">de</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">rlen</span> <span class="o">=</span> <span class="n">ext4_rec_len_from_disk</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">rec_len</span><span class="p">,</span>
						<span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rlen</span> <span class="o">&lt;</span> <span class="n">EXT4_DIR_REC_LEN</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
		<span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;rec_len is smaller than minimal&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rlen</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;rec_len % 4 != 0&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rlen</span> <span class="o">&lt;</span> <span class="n">EXT4_DIR_REC_LEN</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">)))</span>
		<span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;rec_len is too small for name_len&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">de</span> <span class="o">-</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">)</span> <span class="o">+</span> <span class="n">rlen</span> <span class="o">&gt;</span>
			  <span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">))</span>
		<span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;directory entry across blocks&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">)</span> <span class="o">&gt;</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_inodes_count</span><span class="p">)))</span>
		<span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;inode out of bounds&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="p">)</span>
		<span class="n">ext4_error_file</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">,</span>
				<span class="s">&quot;bad entry in directory: %s - offset=%u(%u), &quot;</span>
				<span class="s">&quot;inode=%u, rec_len=%d, name_len=%d&quot;</span><span class="p">,</span>
				<span class="n">error_msg</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">),</span>
				<span class="n">offset</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">),</span>
				<span class="n">rlen</span><span class="p">,</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ext4_error_inode</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">,</span>
				<span class="s">&quot;bad entry in directory: %s - offset=%u(%u), &quot;</span>
				<span class="s">&quot;inode=%u, rec_len=%d, name_len=%d&quot;</span><span class="p">,</span>
				<span class="n">error_msg</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">),</span>
				<span class="n">offset</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">),</span>
				<span class="n">rlen</span><span class="p">,</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_readdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">dirent</span><span class="p">,</span> <span class="n">filldir_t</span> <span class="n">filldir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">stored</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_dir_entry_2</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir_has_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_dx_dir</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_dx_readdir</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">dirent</span><span class="p">,</span> <span class="n">filldir</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">ERR_BAD_DX_DIR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * We don&#39;t set the inode dirty flag since it&#39;s not</span>
<span class="cm">		 * critical that it get flushed back to the disk.</span>
<span class="cm">		 */</span>
		<span class="n">ext4_clear_inode_flag</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span>
				      <span class="n">EXT4_INODE_INDEX</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">stored</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">stored</span> <span class="o">&amp;&amp;</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">&lt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ext4_map_blocks</span> <span class="n">map</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">map</span><span class="p">.</span><span class="n">m_lblk</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">&gt;&gt;</span> <span class="n">EXT4_BLOCK_SIZE_BITS</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">map</span><span class="p">.</span><span class="n">m_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_map_blocks</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pgoff_t</span> <span class="n">index</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">m_pblk</span> <span class="o">&gt;&gt;</span>
					<span class="p">(</span><span class="n">PAGE_CACHE_SHIFT</span> <span class="o">-</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ra_has_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_ra</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
				<span class="n">page_cache_sync_readahead</span><span class="p">(</span>
					<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_ra</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span>
					<span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_ra</span><span class="p">.</span><span class="n">prev_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
			<span class="n">bh</span> <span class="o">=</span> <span class="n">ext4_bread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">map</span><span class="p">.</span><span class="n">m_lblk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * We ignore I/O errors on directories so users have a chance</span>
<span class="cm">		 * of recovering data when there&#39;s a bad sector</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir_has_error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">EXT4_ERROR_FILE</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="s">&quot;directory contains a &quot;</span>
						<span class="s">&quot;hole at offset %llu&quot;</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">);</span>
				<span class="n">dir_has_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* corrupt size?  Maybe no more blocks to read */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">&gt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blocks</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">+=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check the checksum */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_verified</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">ext4_dirent_csum_verify</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ext4_dir_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">EXT4_ERROR_FILE</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;directory fails checksum &quot;</span>
					<span class="s">&quot;at offset %llu&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">);</span>
			<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">+=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_buffer_verified</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>

<span class="nl">revalidate:</span>
		<span class="cm">/* If the dir block has changed since the last call to</span>
<span class="cm">		 * readdir(2), then we might be pointing to an invalid</span>
<span class="cm">		 * dirent right now.  Scan from the start of the block</span>
<span class="cm">		 * to make sure. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_version</span> <span class="o">!=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_version</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">offset</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">de</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext4_dir_entry_2</span> <span class="o">*</span><span class="p">)</span>
					<span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
				<span class="cm">/* It&#39;s too expensive to do a full</span>
<span class="cm">				 * dirent test each time round this</span>
<span class="cm">				 * loop, but we do have to test at</span>
<span class="cm">				 * least that it is non-zero.  A</span>
<span class="cm">				 * failure will be detected in the</span>
<span class="cm">				 * dirent test below. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ext4_rec_len_from_disk</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">rec_len</span><span class="p">,</span>
					<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">EXT4_DIR_REC_LEN</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">i</span> <span class="o">+=</span> <span class="n">ext4_rec_len_from_disk</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">rec_len</span><span class="p">,</span>
							    <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
				<span class="o">|</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_version</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_version</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">&lt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span>
		       <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">de</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext4_dir_entry_2</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ext4_check_dir_entry</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span>
						 <span class="n">bh</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * On error, skip the f_pos to the next block</span>
<span class="cm">				 */</span>
				<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">|</span>
						<span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">stored</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">ext4_rec_len_from_disk</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">rec_len</span><span class="p">,</span>
					<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* We might block in the next section</span>
<span class="cm">				 * if the data destination is</span>
<span class="cm">				 * currently swapped out.  So, use a</span>
<span class="cm">				 * version stamp to detect whether or</span>
<span class="cm">				 * not the directory has been modified</span>
<span class="cm">				 * during the copy operation.</span>
<span class="cm">				 */</span>
				<span class="n">u64</span> <span class="n">version</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_version</span><span class="p">;</span>

				<span class="n">error</span> <span class="o">=</span> <span class="n">filldir</span><span class="p">(</span><span class="n">dirent</span><span class="p">,</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						<span class="n">de</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">,</span>
						<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">,</span>
						<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">),</span>
						<span class="n">get_dtype</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">file_type</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">!=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_version</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">revalidate</span><span class="p">;</span>
				<span class="n">stored</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">+=</span> <span class="n">ext4_rec_len_from_disk</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">rec_len</span><span class="p">,</span>
						<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_32bit_api</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="k">return</span> <span class="n">is_compat_task</span><span class="p">();</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">==</span> <span class="mi">32</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * These functions convert from the major/minor hash to an f_pos</span>
<span class="cm"> * value for dx directories</span>
<span class="cm"> *</span>
<span class="cm"> * Upper layer (for example NFS) should specify FMODE_32BITHASH or</span>
<span class="cm"> * FMODE_64BITHASH explicitly. On the other hand, we allow ext4 to be mounted</span>
<span class="cm"> * directly on both 32-bit and 64-bit nodes, under such case, neither</span>
<span class="cm"> * FMODE_32BITHASH nor FMODE_64BITHASH is specified.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">loff_t</span> <span class="nf">hash2pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">major</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_32BITHASH</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_64BITHASH</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_32bit_api</span><span class="p">()))</span>
		<span class="k">return</span> <span class="n">major</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">__u64</span><span class="p">)(</span><span class="n">major</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">minor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u32</span> <span class="nf">pos2maj_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_32BITHASH</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_64BITHASH</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_32bit_api</span><span class="p">()))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u32</span> <span class="nf">pos2min_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_32BITHASH</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_64BITHASH</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_32bit_api</span><span class="p">()))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return 32- or 64-bit end-of-file for dx directories</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">loff_t</span> <span class="nf">ext4_get_htree_eof</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_32BITHASH</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_64BITHASH</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_32bit_api</span><span class="p">()))</span>
		<span class="k">return</span> <span class="n">EXT4_HTREE_EOF_32BIT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">EXT4_HTREE_EOF_64BIT</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * ext4_dir_llseek() based on generic_file_llseek() to handle both</span>
<span class="cm"> * non-htree and htree directories, where the &quot;offset&quot; is in terms</span>
<span class="cm"> * of the filename hash value instead of the byte offset.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: offsets obtained *before* ext4_set_inode_flag(dir, EXT4_INODE_INDEX)</span>
<span class="cm"> *       will be invalid once the directory was converted into a dx directory</span>
<span class="cm"> */</span>
<span class="n">loff_t</span> <span class="nf">ext4_dir_llseek</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">origin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dx_dir</span> <span class="o">=</span> <span class="n">is_dx_dir</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>

	<span class="cm">/* NOTE: relative offsets with dx directories might not work</span>
<span class="cm">	 *       as expected, as it is difficult to figure out the</span>
<span class="cm">	 *       correct offset between dx hashes */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">origin</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEEK_END</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span> <span class="cm">/* not supported for directories */</span>

		<span class="cm">/* so only negative offsets are left, does that have a</span>
<span class="cm">		 * meaning for directories at all? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dx_dir</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">ext4_get_htree_eof</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEEK_CUR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Here we special-case the lseek(fd, 0, SEEK_CUR)</span>
<span class="cm">		 * position-querying operation.  Avoid rewriting the &quot;same&quot;</span>
<span class="cm">		 * f_pos value back to the file because a concurrent read(),</span>
<span class="cm">		 * write() or lseek() might have altered it</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_ok</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dx_dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_maxbytes</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">ext4_get_htree_eof</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="cm">/* Special lock needed here? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_ok:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
<span class="nl">out_err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This structure holds the nodes of the red-black tree used to store</span>
<span class="cm"> * the directory entry in hash order.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fname</span> <span class="p">{</span>
	<span class="n">__u32</span>		<span class="n">hash</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">minor_hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span>	<span class="n">rb_hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fname</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">inode</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">name_len</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">file_type</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This functoin implements a non-recursive way of freeing all of the</span>
<span class="cm"> * nodes in the red-black tree.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_rb_tree_fname</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span>	<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span>	<span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fname</span>	<span class="o">*</span><span class="n">fname</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Do the node&#39;s children first */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * The node has no children; free it, and then zero</span>
<span class="cm">		 * out parent&#39;s link to it.  Finally go to the</span>
<span class="cm">		 * beginning of the loop and try to free the parent</span>
<span class="cm">		 * node.</span>
<span class="cm">		 */</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">rb_parent</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
		<span class="n">fname</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fname</span><span class="p">,</span> <span class="n">rb_hash</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">fname</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="n">fname</span><span class="p">;</span>
			<span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parent</span><span class="p">)</span>
			<span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rb_left</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">rb_left</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rb_right</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">rb_right</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">dir_private_info</span> <span class="o">*</span><span class="nf">ext4_htree_create_dir_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
							   <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dir_private_info</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dir_private_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">curr_hash</span> <span class="o">=</span> <span class="n">pos2maj_hash</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">curr_minor_hash</span> <span class="o">=</span> <span class="n">pos2min_hash</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_htree_free_dir_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">dir_private_info</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_rb_tree_fname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Given a directory entry, enter it into the fname rb tree.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ext4_htree_store_dirent</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">dir_file</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">hash</span><span class="p">,</span>
			     <span class="n">__u32</span> <span class="n">minor_hash</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ext4_dir_entry_2</span> <span class="o">*</span><span class="n">dirent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fname</span> <span class="o">*</span><span class="n">fname</span><span class="p">,</span> <span class="o">*</span><span class="n">new_fn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dir_private_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">dir_file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>

	<span class="cm">/* Create and allocate the fname structure */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fname</span><span class="p">)</span> <span class="o">+</span> <span class="n">dirent</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">new_fn</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_fn</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span><span class="p">;</span>
	<span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">minor_hash</span> <span class="o">=</span> <span class="n">minor_hash</span><span class="p">;</span>
	<span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">inode</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dirent</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">=</span> <span class="n">dirent</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">;</span>
	<span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">file_type</span> <span class="o">=</span> <span class="n">dirent</span><span class="o">-&gt;</span><span class="n">file_type</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dirent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dirent</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">);</span>
	<span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">dirent</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">fname</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fname</span><span class="p">,</span> <span class="n">rb_hash</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the hash and minor hash match up, then we put</span>
<span class="cm">		 * them on a linked list.  This rarely happens...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">==</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">minor_hash</span> <span class="o">==</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">minor_hash</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">fname</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">new_fn</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&lt;</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&gt;</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">minor_hash</span> <span class="o">&lt;</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">minor_hash</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="cm">/* if (new_fn-&gt;minor_hash &gt; fname-&gt;minor_hash) */</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">rb_hash</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_fn</span><span class="o">-&gt;</span><span class="n">rb_hash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * This is a helper function for ext4_dx_readdir.  It calls filldir</span>
<span class="cm"> * for all entres on the fname linked list.  (Normally there is only</span>
<span class="cm"> * one entry on the linked list, unless there are 62 bit hash collisions.)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">call_filldir</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dirent</span><span class="p">,</span>
			<span class="n">filldir_t</span> <span class="n">filldir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fname</span> <span class="o">*</span><span class="n">fname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dir_private_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">loff_t</span>	<span class="n">curr_pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;%s:%d: inode #%lu: comm %s: &quot;</span>
			 <span class="s">&quot;called with null fname?!?&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			 <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">curr_pos</span> <span class="o">=</span> <span class="n">hash2pos</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">minor_hash</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">filldir</span><span class="p">(</span><span class="n">dirent</span><span class="p">,</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">fname</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">,</span> <span class="n">curr_pos</span><span class="p">,</span>
				<span class="n">fname</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span>
				<span class="n">get_dtype</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">file_type</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">curr_pos</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">extra_fname</span> <span class="o">=</span> <span class="n">fname</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_dx_readdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">dirent</span><span class="p">,</span> <span class="n">filldir_t</span> <span class="n">filldir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dir_private_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fname</span> <span class="o">*</span><span class="n">fname</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">ext4_htree_create_dir_info</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">==</span> <span class="n">ext4_get_htree_eof</span><span class="p">(</span><span class="n">filp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* EOF */</span>

	<span class="cm">/* Some one has messed with f_pos; reset the world */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">last_pos</span> <span class="o">!=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_rb_tree_fname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">extra_fname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_hash</span> <span class="o">=</span> <span class="n">pos2maj_hash</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_minor_hash</span> <span class="o">=</span> <span class="n">pos2min_hash</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there are any leftover names on the hash collision</span>
<span class="cm">	 * chain, return them first.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">extra_fname</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call_filldir</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">dirent</span><span class="p">,</span> <span class="n">filldir</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">extra_fname</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">extra_fname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">next_node</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_node</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_node</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Fill the rbtree if we have no more entries,</span>
<span class="cm">		 * or the inode has changed since we last read in the</span>
<span class="cm">		 * cached entries.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_node</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_version</span> <span class="o">!=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_version</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">free_rb_tree_fname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">);</span>
			<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_version</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_version</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_htree_fill_tree</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_hash</span><span class="p">,</span>
						   <span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_minor_hash</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">next_hash</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">ext4_get_htree_eof</span><span class="p">(</span><span class="n">filp</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_node</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">fname</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fname</span><span class="p">,</span> <span class="n">rb_hash</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_hash</span> <span class="o">=</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_minor_hash</span> <span class="o">=</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">minor_hash</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call_filldir</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">dirent</span><span class="p">,</span> <span class="n">filldir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="nl">next_node:</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_node</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fname</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fname</span><span class="p">,</span>
					 <span class="n">rb_hash</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_hash</span> <span class="o">=</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_minor_hash</span> <span class="o">=</span> <span class="n">fname</span><span class="o">-&gt;</span><span class="n">minor_hash</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">next_hash</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">ext4_get_htree_eof</span><span class="p">(</span><span class="n">filp</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_hash</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_hash</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">curr_minor_hash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">finished:</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_pos</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_release_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span>
		<span class="n">ext4_htree_free_dir_info</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ext4_dir_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">ext4_dir_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">generic_read_dir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readdir</span>	<span class="o">=</span> <span class="n">ext4_readdir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">ext4_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span>	<span class="o">=</span> <span class="n">ext4_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">fsync</span>		<span class="o">=</span> <span class="n">ext4_sync_file</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">ext4_release_dir</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
