<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › ext4 › super.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>super.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/fs/ext4/super.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1992, 1993, 1994, 1995</span>
<span class="cm"> * Remy Card (card@masi.ibp.fr)</span>
<span class="cm"> * Laboratoire MASI - Institut Blaise Pascal</span>
<span class="cm"> * Universite Pierre et Marie Curie (Paris VI)</span>
<span class="cm"> *</span>
<span class="cm"> *  from</span>
<span class="cm"> *</span>
<span class="cm"> *  linux/fs/minix/inode.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1991, 1992  Linus Torvalds</span>
<span class="cm"> *</span>
<span class="cm"> *  Big-endian to little-endian byte-swapping/bitmaps by</span>
<span class="cm"> *        David S. Miller (davem@caip.rutgers.edu), 1995</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/jbd2.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/parser.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/exportfs.h&gt;</span>
<span class="cp">#include &lt;linux/vfs.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/quotaops.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>
<span class="cp">#include &lt;linux/crc16.h&gt;</span>
<span class="cp">#include &lt;linux/cleancache.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>

<span class="cp">#include &quot;ext4.h&quot;</span>
<span class="cp">#include &quot;ext4_extents.h&quot;</span>
<span class="cp">#include &quot;ext4_jbd2.h&quot;</span>
<span class="cp">#include &quot;xattr.h&quot;</span>
<span class="cp">#include &quot;acl.h&quot;</span>
<span class="cp">#include &quot;mballoc.h&quot;</span>

<span class="cp">#define CREATE_TRACE_POINTS</span>
<span class="cp">#include &lt;trace/events/ext4.h&gt;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">ext4_proc_root</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kset</span> <span class="o">*</span><span class="n">ext4_kset</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ext4_lazy_init</span> <span class="o">*</span><span class="n">ext4_li_info</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">ext4_li_mtx</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ext4_features</span> <span class="o">*</span><span class="n">ext4_feat</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_load_journal</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">journal_devnum</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_show_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_commit_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sync</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ext4_mark_recovery_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ext4_clear_journal_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_sync_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ext4_decode_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">errno</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="n">nbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_remount</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_unfreeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ext4_write_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ext4_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">ext2_feature_set_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">ext3_feature_set_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_feature_set_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">readonly</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ext4_destroy_lazyinit_thread</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ext4_unregister_li_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ext4_clear_request_list</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#if !defined(CONFIG_EXT2_FS) &amp;&amp; !defined(CONFIG_EXT2_FS_MODULE) &amp;&amp; defined(CONFIG_EXT4_USE_FOR_EXT23)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">ext2_fs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ext2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>		<span class="o">=</span> <span class="n">ext4_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>	<span class="o">=</span> <span class="n">kill_block_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fs_flags</span>	<span class="o">=</span> <span class="n">FS_REQUIRES_DEV</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define IS_EXT2_SB(sb) ((sb)-&gt;s_bdev-&gt;bd_holder == &amp;ext2_fs_type)</span>
<span class="cp">#else</span>
<span class="cp">#define IS_EXT2_SB(sb) (0)</span>
<span class="cp">#endif</span>


<span class="cp">#if !defined(CONFIG_EXT3_FS) &amp;&amp; !defined(CONFIG_EXT3_FS_MODULE) &amp;&amp; defined(CONFIG_EXT4_USE_FOR_EXT23)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">ext3_fs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ext3&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>		<span class="o">=</span> <span class="n">ext4_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>	<span class="o">=</span> <span class="n">kill_block_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fs_flags</span>	<span class="o">=</span> <span class="n">FS_REQUIRES_DEV</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define IS_EXT3_SB(sb) ((sb)-&gt;s_bdev-&gt;bd_holder == &amp;ext3_fs_type)</span>
<span class="cp">#else</span>
<span class="cp">#define IS_EXT3_SB(sb) (0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_verify_csum_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
					<span class="n">EXT4_FEATURE_RO_COMPAT_METADATA_CSUM</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">s_checksum_type</span> <span class="o">==</span> <span class="n">EXT4_CRC32C_CHKSUM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__le32</span> <span class="nf">ext4_superblock_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_super_block</span><span class="p">,</span> <span class="n">s_checksum</span><span class="p">);</span>
	<span class="n">__u32</span> <span class="n">csum</span><span class="p">;</span>

	<span class="n">csum</span> <span class="o">=</span> <span class="n">ext4_chksum</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">es</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">csum</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ext4_superblock_csum_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
				       <span class="n">EXT4_FEATURE_RO_COMPAT_METADATA_CSUM</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">s_checksum</span> <span class="o">==</span> <span class="n">ext4_superblock_csum</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_superblock_csum_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
		<span class="n">EXT4_FEATURE_RO_COMPAT_METADATA_CSUM</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_checksum</span> <span class="o">=</span> <span class="n">ext4_superblock_csum</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">ext4_kvmalloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__vmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">PAGE_KERNEL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">ext4_kvzalloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__vmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">,</span> <span class="n">PAGE_KERNEL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_kvfree</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_vmalloc_addr</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>

<span class="p">}</span>

<span class="n">ext4_fsblk_t</span> <span class="nf">ext4_block_bitmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">bg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_block_bitmap_lo</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span> <span class="o">?</span>
		 <span class="p">(</span><span class="n">ext4_fsblk_t</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_block_bitmap_hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">ext4_fsblk_t</span> <span class="nf">ext4_inode_bitmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">bg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_inode_bitmap_lo</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span> <span class="o">?</span>
		 <span class="p">(</span><span class="n">ext4_fsblk_t</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_inode_bitmap_hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">ext4_fsblk_t</span> <span class="nf">ext4_inode_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">bg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_inode_table_lo</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span> <span class="o">?</span>
		 <span class="p">(</span><span class="n">ext4_fsblk_t</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_inode_table_hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__u32</span> <span class="nf">ext4_free_group_clusters</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">bg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_free_blocks_count_lo</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span> <span class="o">?</span>
		 <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_free_blocks_count_hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__u32</span> <span class="nf">ext4_free_inodes_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">bg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_free_inodes_count_lo</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span> <span class="o">?</span>
		 <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_free_inodes_count_hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__u32</span> <span class="nf">ext4_used_dirs_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">bg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_used_dirs_count_lo</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span> <span class="o">?</span>
		 <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_used_dirs_count_hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__u32</span> <span class="nf">ext4_itable_unused_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">bg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_itable_unused_lo</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span> <span class="o">?</span>
		 <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_itable_unused_hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_block_bitmap_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">bg</span><span class="p">,</span> <span class="n">ext4_fsblk_t</span> <span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_block_bitmap_lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">blk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span><span class="p">)</span>
		<span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_block_bitmap_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">blk</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_inode_bitmap_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">bg</span><span class="p">,</span> <span class="n">ext4_fsblk_t</span> <span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_inode_bitmap_lo</span>  <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">blk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span><span class="p">)</span>
		<span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_inode_bitmap_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">blk</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_inode_table_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">bg</span><span class="p">,</span> <span class="n">ext4_fsblk_t</span> <span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_inode_table_lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">blk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span><span class="p">)</span>
		<span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_inode_table_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">blk</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_free_group_clusters_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">bg</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_free_blocks_count_lo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span><span class="p">)</span>
		<span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_free_blocks_count_hi</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_free_inodes_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">bg</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_free_inodes_count_lo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span><span class="p">)</span>
		<span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_free_inodes_count_hi</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_used_dirs_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">bg</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_used_dirs_count_lo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span><span class="p">)</span>
		<span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_used_dirs_count_hi</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_itable_unused_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">bg</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_itable_unused_lo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span><span class="p">)</span>
		<span class="n">bg</span><span class="o">-&gt;</span><span class="n">bg_itable_unused_hi</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Just increment the non-pointer handle value */</span>
<span class="k">static</span> <span class="n">handle_t</span> <span class="o">*</span><span class="nf">ext4_get_nojournal</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">journal_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ref_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ref_cnt</span> <span class="o">&gt;=</span> <span class="n">EXT4_NOJOURNAL_MAX_REF_COUNT</span><span class="p">);</span>

	<span class="n">ref_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="p">(</span><span class="n">handle_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ref_cnt</span><span class="p">;</span>

	<span class="n">current</span><span class="o">-&gt;</span><span class="n">journal_info</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">handle</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Decrement the non-pointer handle value */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_put_nojournal</span><span class="p">(</span><span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ref_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ref_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ref_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="p">(</span><span class="n">handle_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ref_cnt</span><span class="p">;</span>

	<span class="n">current</span><span class="o">-&gt;</span><span class="n">journal_info</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wrappers for jbd2_journal_start/end.</span>
<span class="cm"> *</span>
<span class="cm"> * The only special thing we need to do here is to make sure that all</span>
<span class="cm"> * journal_end calls result in the superblock being marked dirty, so</span>
<span class="cm"> * that sync() will call the filesystem&#39;s write_super callback if</span>
<span class="cm"> * appropriate.</span>
<span class="cm"> *</span>
<span class="cm"> * To avoid j_barrier hold in userspace when a user calls freeze(),</span>
<span class="cm"> * ext4 prevents a new handle from being started by s_frozen, which</span>
<span class="cm"> * is in an upper layer.</span>
<span class="cm"> */</span>
<span class="n">handle_t</span> <span class="o">*</span><span class="nf">ext4_journal_start_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nblocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>
	<span class="n">handle_t</span>  <span class="o">*</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">trace_ext4_journal_start</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">,</span> <span class="n">_RET_IP_</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EROFS</span><span class="p">);</span>

	<span class="n">journal</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">;</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">ext4_journal_current_handle</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * If a handle has been started, it should be allowed to</span>
<span class="cm">	 * finish, otherwise deadlock could happen between freeze</span>
<span class="cm">	 * and others(e.g. truncate) due to the restart of the</span>
<span class="cm">	 * journal handle if the filesystem is forzen and active</span>
<span class="cm">	 * handles are not stopped.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span>
		<span class="n">vfs_check_frozen</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">SB_FREEZE_TRANS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">journal</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ext4_get_nojournal</span><span class="p">();</span>
	<span class="cm">/*</span>
<span class="cm">	 * Special case here: if the journal has aborted behind our</span>
<span class="cm">	 * backs (eg. EIO in the commit thread), then we still need to</span>
<span class="cm">	 * take the FS itself readonly cleanly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_journal_aborted</span><span class="p">(</span><span class="n">journal</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_abort</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Detected aborted journal&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EROFS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">jbd2_journal_start</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The only special thing we need to do here is to make sure that all</span>
<span class="cm"> * jbd2_journal_stop calls result in the superblock being marked dirty, so</span>
<span class="cm"> * that sync() will call the filesystem&#39;s write_super callback if</span>
<span class="cm"> * appropriate.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__ext4_journal_stop</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">where</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_handle_valid</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_put_nojournal</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sb</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">h_transaction</span><span class="o">-&gt;</span><span class="n">t_journal</span><span class="o">-&gt;</span><span class="n">j_private</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">h_err</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">jbd2_journal_stop</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">__ext4_std_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_journal_abort_handle</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">caller</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_fn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span>
			       <span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">nbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span> <span class="o">=</span> <span class="n">ext4_decode_error</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">nbuf</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ext4_handle_valid</span><span class="p">(</span><span class="n">handle</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bh</span><span class="p">)</span>
		<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="s">&quot;abort&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">h_err</span><span class="p">)</span>
		<span class="n">handle</span><span class="o">-&gt;</span><span class="n">h_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_handle_aborted</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;EXT4-fs: %s:%d: aborting transaction: %s in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">caller</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">errstr</span><span class="p">,</span> <span class="n">err_fn</span><span class="p">);</span>

	<span class="n">jbd2_journal_abort_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__save_error_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>

	<span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">|=</span> <span class="n">EXT4_ERROR_FS</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT4_ERROR_FS</span><span class="p">);</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">get_seconds</span><span class="p">());</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_func</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_func</span><span class="p">));</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_line</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_time</span> <span class="o">=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_time</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_func</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_func</span><span class="p">));</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_line</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_ino</span> <span class="o">=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_ino</span><span class="p">;</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_block</span> <span class="o">=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_block</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Start the daily error reporting function if it hasn&#39;t been</span>
<span class="cm">	 * started already</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_error_count</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_err_report</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_error_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_error_count</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">save_error_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__save_error_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">ext4_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The del_gendisk() function uninitializes the disk-specific data</span>
<span class="cm"> * structures, including the bdi structure, without telling anyone</span>
<span class="cm"> * else.  Once this happens, any attempt to call mark_buffer_dirty()</span>
<span class="cm"> * (for example, by ext4_commit_super), will cause a kernel OOPS.</span>
<span class="cm"> * This is a kludge to prevent these oops until we can put in a proper</span>
<span class="cm"> * hook in del_gendisk() to inform the VFS and file system layers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">block_device_ejected</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">bd_inode</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">backing_dev_info</span> <span class="o">*</span><span class="n">bdi</span> <span class="o">=</span> <span class="n">bd_inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bdi</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_journal_commit_callback</span><span class="p">(</span><span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">,</span> <span class="n">transaction_t</span> <span class="o">*</span><span class="n">txn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span>		<span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span>		<span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">int</span>				<span class="n">error</span> <span class="o">=</span> <span class="n">is_journal_aborted</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_journal_cb_entry</span>	<span class="o">*</span><span class="n">jce</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_md_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">jce</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txn</span><span class="o">-&gt;</span><span class="n">t_private_list</span><span class="p">,</span> <span class="n">jce_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jce</span><span class="o">-&gt;</span><span class="n">jce_list</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_md_lock</span><span class="p">);</span>
		<span class="n">jce</span><span class="o">-&gt;</span><span class="n">jce_func</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">jce</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_md_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_md_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Deal with the reporting of failure conditions on a filesystem such as</span>
<span class="cm"> * inconsistencies detected or read IO failures.</span>
<span class="cm"> *</span>
<span class="cm"> * On ext2, we can store the error state of the filesystem in the</span>
<span class="cm"> * superblock.  That is not possible on ext4, because we may have other</span>
<span class="cm"> * write ordering constraints on the superblock which prevent us from</span>
<span class="cm"> * writing it out straight away; and given that the journal is about to</span>
<span class="cm"> * be aborted, we can&#39;t rely on the current, or future, transactions to</span>
<span class="cm"> * write out the superblock safely.</span>
<span class="cm"> *</span>
<span class="cm"> * We&#39;ll just use the jbd2_journal_abort() error code to record an error in</span>
<span class="cm"> * the journal instead.  On recovery, the journal will complain about</span>
<span class="cm"> * that error until we&#39;ve noted it down and cleared it.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_handle_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_CONT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">;</span>

		<span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_flags</span> <span class="o">|=</span> <span class="n">EXT4_MF_FS_ABORTED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">journal</span><span class="p">)</span>
			<span class="n">jbd2_journal_abort</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_RO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_CRIT</span><span class="p">,</span> <span class="s">&quot;Remounting filesystem read-only&quot;</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_PANIC</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;EXT4-fs (device %s): panic forced after error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__ext4_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;EXT4-fs error (device %s): %s:%d: comm %s: %pV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="n">save_error_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>

	<span class="n">ext4_handle_error</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_error_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="n">ext4_fsblk_t</span> <span class="n">block</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>

	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_ino</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_block</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
	<span class="n">save_error_info</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;EXT4-fs error (device %s): %s:%d: &quot;</span>
		       <span class="s">&quot;inode #%lu: block %llu: comm %s: %pV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span>
		       <span class="n">block</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;EXT4-fs error (device %s): %s:%d: &quot;</span>
		       <span class="s">&quot;inode #%lu: comm %s: %pV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span>
		       <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="n">ext4_handle_error</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_error_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="n">ext4_fsblk_t</span> <span class="n">block</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">pathname</span><span class="p">[</span><span class="mi">80</span><span class="p">],</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>

	<span class="n">es</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_ino</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
	<span class="n">save_error_info</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">path</span> <span class="o">=</span> <span class="n">d_path</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">),</span> <span class="n">pathname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pathname</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
		<span class="n">path</span> <span class="o">=</span> <span class="s">&quot;(unknown)&quot;</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span>
		       <span class="s">&quot;EXT4-fs error (device %s): %s:%d: inode #%lu: &quot;</span>
		       <span class="s">&quot;block %llu: comm %s: path %s: %pV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span>
		       <span class="n">block</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span>
		       <span class="s">&quot;EXT4-fs error (device %s): %s:%d: inode #%lu: &quot;</span>
		       <span class="s">&quot;comm %s: path %s: %pV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span>
		       <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="n">ext4_handle_error</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ext4_decode_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">errno</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="n">nbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EIO</span>:
		<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;IO failure&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
		<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EROFS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb</span> <span class="o">||</span> <span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span> <span class="o">&amp;&amp;</span>
			    <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="o">-&gt;</span><span class="n">j_flags</span> <span class="o">&amp;</span> <span class="n">JBD2_ABORT</span><span class="p">))</span>
			<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;Journal has aborted&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;Readonly filesystem&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* If the caller passed in an extra buffer for unknown</span>
<span class="cm">		 * errors, textualise them now.  Else we just return</span>
<span class="cm">		 * NULL. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check for truncated error codes... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snprintf</span><span class="p">(</span><span class="n">nbuf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;error %d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">errno</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">errstr</span> <span class="o">=</span> <span class="n">nbuf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">errstr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* __ext4_std_error decodes expected errors from journaling functions</span>
<span class="cm"> * automatically and invokes the appropriate error response.  */</span>

<span class="kt">void</span> <span class="nf">__ext4_std_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">errno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">nbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span><span class="p">;</span>

	<span class="cm">/* Special case: if the error is EROFS, and we&#39;re not already</span>
<span class="cm">	 * inside a transaction, then there&#39;s really no point in logging</span>
<span class="cm">	 * an error. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="o">-</span><span class="n">EROFS</span> <span class="o">&amp;&amp;</span> <span class="n">journal_current_handle</span><span class="p">()</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">errstr</span> <span class="o">=</span> <span class="n">ext4_decode_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">errno</span><span class="p">,</span> <span class="n">nbuf</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;EXT4-fs error (device %s) in %s:%d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">errstr</span><span class="p">);</span>
	<span class="n">save_error_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>

	<span class="n">ext4_handle_error</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ext4_abort is a much stronger failure handler than ext4_error.  The</span>
<span class="cm"> * abort function may be used to deal with unrecoverable failures such</span>
<span class="cm"> * as journal IO errors or ENOMEM at a critical moment in log management.</span>
<span class="cm"> *</span>
<span class="cm"> * We unconditionally force the filesystem into an ABORT|READONLY state,</span>
<span class="cm"> * unless the error response on the fs has been set to panic in which</span>
<span class="cm"> * case we take the easy way out and panic immediately.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">__ext4_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">save_error_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;EXT4-fs error (device %s): %s:%d: &quot;</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span>
	       <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">vprintk</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_CRIT</span><span class="p">,</span> <span class="s">&quot;Remounting filesystem read-only&quot;</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
		<span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_flags</span> <span class="o">|=</span> <span class="n">EXT4_MF_FS_ABORTED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">)</span>
			<span class="n">jbd2_journal_abort</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="n">save_error_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_PANIC</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;EXT4-fs panic from previous error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sEXT4-fs (%s): %pV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__ext4_warning</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;EXT4-fs warning (device %s): %s:%d: %pV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__ext4_grp_locked_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="n">ext4_group_t</span> <span class="n">grp</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ino</span><span class="p">,</span> <span class="n">ext4_fsblk_t</span> <span class="n">block</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">bitlock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">bitlock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>

	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_ino</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ino</span><span class="p">);</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_block</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
	<span class="n">__save_error_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;EXT4-fs error (device %s): %s:%d: group %u, &quot;</span><span class="p">,</span>
	       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">grp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ino</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;inode %lu: &quot;</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;block %llu:&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">block</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%pV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_CONT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">grp</span><span class="p">);</span>
	<span class="n">ext4_handle_error</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We only get here in the ERRORS_RO case; relocking the group</span>
<span class="cm">	 * may be dangerous, but nothing bad will happen since the</span>
<span class="cm">	 * filesystem will have already been marked read/only and the</span>
<span class="cm">	 * journal has been aborted.  We return 1 as a hint to callers</span>
<span class="cm">	 * who might what to use the return value from</span>
<span class="cm">	 * ext4_grp_locked_error() to distinguish between the</span>
<span class="cm">	 * ERRORS_CONT and ERRORS_RO case, and perhaps return more</span>
<span class="cm">	 * aggressively from the ext4 function in question, with a</span>
<span class="cm">	 * more appropriate error code.</span>
<span class="cm">	 */</span>
	<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">grp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_update_dynamic_rev</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_rev_level</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">EXT4_GOOD_OLD_REV</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ext4_warning</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
		     <span class="s">&quot;updating to rev %d because of new feature flag, &quot;</span>
		     <span class="s">&quot;running e2fsck is recommended&quot;</span><span class="p">,</span>
		     <span class="n">EXT4_DYNAMIC_REV</span><span class="p">);</span>

	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_ino</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">EXT4_GOOD_OLD_FIRST_INO</span><span class="p">);</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_inode_size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT4_GOOD_OLD_INODE_SIZE</span><span class="p">);</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_rev_level</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">EXT4_DYNAMIC_REV</span><span class="p">);</span>
	<span class="cm">/* leave es-&gt;s_feature_*compat flags alone */</span>
	<span class="cm">/* es-&gt;s_uuid will be set by e2fsck if empty */</span>

	<span class="cm">/*</span>
<span class="cm">	 * The rest of the superblock fields should be zero, and if not it</span>
<span class="cm">	 * means they are likely already in use, so leave them alone.  We</span>
<span class="cm">	 * can leave it up to e2fsck to clean up any inconsistencies there.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Open the external journal device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="nf">ext4_blkdev_get</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>

	<span class="n">bdev</span> <span class="o">=</span> <span class="n">blkdev_get_by_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="o">|</span><span class="n">FMODE_EXCL</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bdev</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;failed to open journal device %s: %ld&quot;</span><span class="p">,</span>
			<span class="n">__bdevname</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release the journal device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_blkdev_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">blkdev_put</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="o">|</span><span class="n">FMODE_EXCL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_blkdev_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">bdev</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">journal_bdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_blkdev_put</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">journal_bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">orphan_list_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">list_entry</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_inode_info</span><span class="p">,</span> <span class="n">i_orphan</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_orphan_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>

	<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;sb orphan head is %d&quot;</span><span class="p">,</span>
		 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sb_info orphan list:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_orphan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">orphan_list_entry</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;  &quot;</span>
		       <span class="s">&quot;inode %s:%lu at %p: mode %o, nlink %d, next %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span>
		       <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">,</span>
		       <span class="n">NEXT_ORPHAN</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_put_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ext4_unregister_li_request</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">dquot_disable</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">DQUOT_USAGE_ENABLED</span> <span class="o">|</span> <span class="n">DQUOT_LIMITS_ENABLED</span><span class="p">);</span>

	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">dio_unwritten_wq</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">dio_unwritten_wq</span><span class="p">);</span>

	<span class="n">lock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">jbd2_journal_destroy</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ext4_abort</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t clean up the journal&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_err_report</span><span class="p">);</span>
	<span class="n">ext4_release_system_zone</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">ext4_mb_release</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">ext4_ext_release</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">ext4_xattr_put_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXT4_CLEAR_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_RECOVER</span><span class="p">);</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_dirt</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span>
		<span class="n">ext4_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_proc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;options&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_proc</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">ext4_proc_root</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kobject_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_kobj</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_gdb_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">ext4_kvfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span><span class="p">);</span>
	<span class="n">ext4_kvfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_flex_groups</span><span class="p">);</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeclusters_counter</span><span class="p">);</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeinodes_counter</span><span class="p">);</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirs_counter</span><span class="p">);</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirtyclusters_counter</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sbh</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Debugging code just in case the in-memory inode orphan list</span>
<span class="cm">	 * isn&#39;t empty.  The on-disk one can be non-empty if we&#39;ve</span>
<span class="cm">	 * detected an error and taken the fs readonly, but the</span>
<span class="cm">	 * in-memory list had better be clean by this point. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_orphan</span><span class="p">))</span>
		<span class="n">dump_orphan_list</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">sbi</span><span class="p">);</span>
	<span class="n">J_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_orphan</span><span class="p">));</span>

	<span class="n">invalidate_bdev</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">journal_bdev</span> <span class="o">&amp;&amp;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">journal_bdev</span> <span class="o">!=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Invalidate the journal device&#39;s buffers.  We don&#39;t want them</span>
<span class="cm">		 * floating about in memory - the physical journal device may</span>
<span class="cm">		 * hotswapped, and it breaks the `ro-after&#39; testing code.</span>
<span class="cm">		 */</span>
		<span class="n">sync_blockdev</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">journal_bdev</span><span class="p">);</span>
		<span class="n">invalidate_bdev</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">journal_bdev</span><span class="p">);</span>
		<span class="n">ext4_blkdev_remove</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mmp_tsk</span><span class="p">)</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mmp_tsk</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now that we are completely done shutting down the</span>
<span class="cm">	 * superblock, we need to actually destroy the kobject.</span>
<span class="cm">	 */</span>
	<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_kobj</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_kobj_unregister</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_chksum_driver</span><span class="p">)</span>
		<span class="n">crypto_free_shash</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_chksum_driver</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blockgroup_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">ext4_inode_cachep</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Called inside transaction, so use GFP_NOFS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">ext4_alloc_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_inode_info</span> <span class="o">*</span><span class="n">ei</span><span class="p">;</span>

	<span class="n">ei</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">ext4_inode_cachep</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ei</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ei</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ei</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_data</span><span class="p">.</span><span class="n">writeback_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_cached_extent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_ext_cache</span><span class="p">));</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_lock</span><span class="p">);</span>
	<span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_reserved_data_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_reserved_meta_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_allocated_meta_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_da_metadata_calc_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_block_reservation_lock</span><span class="p">));</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_reserved_quota</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">ei</span><span class="o">-&gt;</span><span class="n">jinode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_completed_io_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_completed_io_lock</span><span class="p">);</span>
	<span class="n">ei</span><span class="o">-&gt;</span><span class="n">cur_aio_dio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_sync_tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_datasync_tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_ioend_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_aiodio_unwritten</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_drop_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drop</span> <span class="o">=</span> <span class="n">generic_drop_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">trace_ext4_drop_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">drop</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">drop</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_i_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span><span class="p">,</span> <span class="n">i_rcu</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ext4_inode_cachep</span><span class="p">,</span> <span class="n">EXT4_I</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_destroy_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">EXT4_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_orphan</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			 <span class="s">&quot;Inode %lu (%p): orphan list check failed!&quot;</span><span class="p">,</span>
			 <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">EXT4_I</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
		<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				<span class="n">EXT4_I</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_inode_info</span><span class="p">),</span>
				<span class="nb">true</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rcu</span><span class="p">,</span> <span class="n">ext4_i_callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_once</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">foo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_inode_info</span> <span class="o">*</span><span class="n">ei</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext4_inode_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">foo</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_orphan</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_EXT4_FS_XATTR</span>
	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_data_sem</span><span class="p">);</span>
	<span class="n">inode_init_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_inodecache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_inode_cachep</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;ext4_inode_cache&quot;</span><span class="p">,</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_inode_info</span><span class="p">),</span>
					     <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">SLAB_RECLAIM_ACCOUNT</span><span class="o">|</span>
						<span class="n">SLAB_MEM_SPREAD</span><span class="p">),</span>
					     <span class="n">init_once</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext4_inode_cachep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_inodecache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">ext4_inode_cachep</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_clear_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">invalidate_inode_buffers</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">clear_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">dquot_drop</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">ext4_discard_preallocations</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">jinode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jbd2_journal_release_jbd_inode</span><span class="p">(</span><span class="n">EXT4_JOURNAL</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
					       <span class="n">EXT4_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">jinode</span><span class="p">);</span>
		<span class="n">jbd2_free_inode</span><span class="p">(</span><span class="n">EXT4_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">jinode</span><span class="p">);</span>
		<span class="n">EXT4_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">jinode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">ext4_nfs_get_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
					<span class="n">u64</span> <span class="n">ino</span><span class="p">,</span> <span class="n">u32</span> <span class="n">generation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ino</span> <span class="o">&lt;</span> <span class="n">EXT4_FIRST_INO</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ino</span> <span class="o">!=</span> <span class="n">EXT4_ROOT_INO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ino</span> <span class="o">&gt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_inodes_count</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">);</span>

	<span class="cm">/* iget isn&#39;t really right if the inode is currently unallocated!!</span>
<span class="cm">	 *</span>
<span class="cm">	 * ext4_read_inode will return a bad_inode if the inode had been</span>
<span class="cm">	 * deleted, so we should be safe.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Currently we don&#39;t know the generation for parent directory, so</span>
<span class="cm">	 * a generation of 0 means &quot;accept any&quot;</span>
<span class="cm">	 */</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">ext4_iget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">generation</span> <span class="o">&amp;&amp;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_generation</span> <span class="o">!=</span> <span class="n">generation</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">ext4_fh_to_dentry</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">fh_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fh_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">generic_fh_to_dentry</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">fh_len</span><span class="p">,</span> <span class="n">fh_type</span><span class="p">,</span>
				    <span class="n">ext4_nfs_get_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">ext4_fh_to_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">fh_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fh_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">generic_fh_to_parent</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">fh_len</span><span class="p">,</span> <span class="n">fh_type</span><span class="p">,</span>
				    <span class="n">ext4_nfs_get_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try to release metadata pages (indirect blocks, directories) which are</span>
<span class="cm"> * mapped via the block device.  Since these pages could have journal heads</span>
<span class="cm"> * which would prevent try_to_free_buffers() from freeing them, we must use</span>
<span class="cm"> * jbd2 layer&#39;s try_to_free_buffers() function to release them.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bdev_try_to_free_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
				 <span class="n">gfp_t</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">PageChecked</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page_has_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">journal</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">jbd2_journal_try_to_free_buffers</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span>
							<span class="n">wait</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">__GFP_WAIT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">try_to_free_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
<span class="cp">#define QTYPE2NAME(t) ((t) == USRQUOTA ? &quot;user&quot; : &quot;group&quot;)</span>
<span class="cp">#define QTYPE2MOPT(on, t) ((t) == USRQUOTA?((on)##USRJQUOTA):((on)##GRPJQUOTA))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_write_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_acquire_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_release_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_mark_dquot_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_write_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_quota_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format_id</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_quota_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext4_quota_on_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ext4_quota_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ext4_quota_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dquot_operations</span> <span class="n">ext4_quota_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_reserved_space</span> <span class="o">=</span> <span class="n">ext4_get_reserved_space</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_dquot</span>	<span class="o">=</span> <span class="n">ext4_write_dquot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">acquire_dquot</span>	<span class="o">=</span> <span class="n">ext4_acquire_dquot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_dquot</span>	<span class="o">=</span> <span class="n">ext4_release_dquot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mark_dirty</span>	<span class="o">=</span> <span class="n">ext4_mark_dquot_dirty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_info</span>	<span class="o">=</span> <span class="n">ext4_write_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_dquot</span>	<span class="o">=</span> <span class="n">dquot_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_dquot</span>	<span class="o">=</span> <span class="n">dquot_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">quotactl_ops</span> <span class="n">ext4_qctl_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quota_on</span>	<span class="o">=</span> <span class="n">ext4_quota_on</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quota_off</span>	<span class="o">=</span> <span class="n">ext4_quota_off</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quota_sync</span>	<span class="o">=</span> <span class="n">dquot_quota_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_info</span>	<span class="o">=</span> <span class="n">dquot_get_dqinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_info</span>	<span class="o">=</span> <span class="n">dquot_set_dqinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_dqblk</span>	<span class="o">=</span> <span class="n">dquot_get_dqblk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dqblk</span>	<span class="o">=</span> <span class="n">dquot_set_dqblk</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">super_operations</span> <span class="n">ext4_sops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc_inode</span>	<span class="o">=</span> <span class="n">ext4_alloc_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_inode</span>	<span class="o">=</span> <span class="n">ext4_destroy_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_inode</span>	<span class="o">=</span> <span class="n">ext4_write_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dirty_inode</span>	<span class="o">=</span> <span class="n">ext4_dirty_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drop_inode</span>	<span class="o">=</span> <span class="n">ext4_drop_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">evict_inode</span>	<span class="o">=</span> <span class="n">ext4_evict_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_super</span>	<span class="o">=</span> <span class="n">ext4_put_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_fs</span>	<span class="o">=</span> <span class="n">ext4_sync_fs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze_fs</span>	<span class="o">=</span> <span class="n">ext4_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unfreeze_fs</span>	<span class="o">=</span> <span class="n">ext4_unfreeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">statfs</span>		<span class="o">=</span> <span class="n">ext4_statfs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remount_fs</span>	<span class="o">=</span> <span class="n">ext4_remount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_options</span>	<span class="o">=</span> <span class="n">ext4_show_options</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="p">.</span><span class="n">quota_read</span>	<span class="o">=</span> <span class="n">ext4_quota_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quota_write</span>	<span class="o">=</span> <span class="n">ext4_quota_write</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">bdev_try_to_free_page</span> <span class="o">=</span> <span class="n">bdev_try_to_free_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">super_operations</span> <span class="n">ext4_nojournal_sops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc_inode</span>	<span class="o">=</span> <span class="n">ext4_alloc_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_inode</span>	<span class="o">=</span> <span class="n">ext4_destroy_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_inode</span>	<span class="o">=</span> <span class="n">ext4_write_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dirty_inode</span>	<span class="o">=</span> <span class="n">ext4_dirty_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drop_inode</span>	<span class="o">=</span> <span class="n">ext4_drop_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">evict_inode</span>	<span class="o">=</span> <span class="n">ext4_evict_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_super</span>	<span class="o">=</span> <span class="n">ext4_write_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_super</span>	<span class="o">=</span> <span class="n">ext4_put_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">statfs</span>		<span class="o">=</span> <span class="n">ext4_statfs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remount_fs</span>	<span class="o">=</span> <span class="n">ext4_remount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_options</span>	<span class="o">=</span> <span class="n">ext4_show_options</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="p">.</span><span class="n">quota_read</span>	<span class="o">=</span> <span class="n">ext4_quota_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quota_write</span>	<span class="o">=</span> <span class="n">ext4_quota_write</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">bdev_try_to_free_page</span> <span class="o">=</span> <span class="n">bdev_try_to_free_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">export_operations</span> <span class="n">ext4_export_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fh_to_dentry</span> <span class="o">=</span> <span class="n">ext4_fh_to_dentry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fh_to_parent</span> <span class="o">=</span> <span class="n">ext4_fh_to_parent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_parent</span> <span class="o">=</span> <span class="n">ext4_get_parent</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">Opt_bsd_df</span><span class="p">,</span> <span class="n">Opt_minix_df</span><span class="p">,</span> <span class="n">Opt_grpid</span><span class="p">,</span> <span class="n">Opt_nogrpid</span><span class="p">,</span>
	<span class="n">Opt_resgid</span><span class="p">,</span> <span class="n">Opt_resuid</span><span class="p">,</span> <span class="n">Opt_sb</span><span class="p">,</span> <span class="n">Opt_err_cont</span><span class="p">,</span> <span class="n">Opt_err_panic</span><span class="p">,</span> <span class="n">Opt_err_ro</span><span class="p">,</span>
	<span class="n">Opt_nouid32</span><span class="p">,</span> <span class="n">Opt_debug</span><span class="p">,</span> <span class="n">Opt_removed</span><span class="p">,</span>
	<span class="n">Opt_user_xattr</span><span class="p">,</span> <span class="n">Opt_nouser_xattr</span><span class="p">,</span> <span class="n">Opt_acl</span><span class="p">,</span> <span class="n">Opt_noacl</span><span class="p">,</span>
	<span class="n">Opt_auto_da_alloc</span><span class="p">,</span> <span class="n">Opt_noauto_da_alloc</span><span class="p">,</span> <span class="n">Opt_noload</span><span class="p">,</span>
	<span class="n">Opt_commit</span><span class="p">,</span> <span class="n">Opt_min_batch_time</span><span class="p">,</span> <span class="n">Opt_max_batch_time</span><span class="p">,</span>
	<span class="n">Opt_journal_dev</span><span class="p">,</span> <span class="n">Opt_journal_checksum</span><span class="p">,</span> <span class="n">Opt_journal_async_commit</span><span class="p">,</span>
	<span class="n">Opt_abort</span><span class="p">,</span> <span class="n">Opt_data_journal</span><span class="p">,</span> <span class="n">Opt_data_ordered</span><span class="p">,</span> <span class="n">Opt_data_writeback</span><span class="p">,</span>
	<span class="n">Opt_data_err_abort</span><span class="p">,</span> <span class="n">Opt_data_err_ignore</span><span class="p">,</span>
	<span class="n">Opt_usrjquota</span><span class="p">,</span> <span class="n">Opt_grpjquota</span><span class="p">,</span> <span class="n">Opt_offusrjquota</span><span class="p">,</span> <span class="n">Opt_offgrpjquota</span><span class="p">,</span>
	<span class="n">Opt_jqfmt_vfsold</span><span class="p">,</span> <span class="n">Opt_jqfmt_vfsv0</span><span class="p">,</span> <span class="n">Opt_jqfmt_vfsv1</span><span class="p">,</span> <span class="n">Opt_quota</span><span class="p">,</span>
	<span class="n">Opt_noquota</span><span class="p">,</span> <span class="n">Opt_barrier</span><span class="p">,</span> <span class="n">Opt_nobarrier</span><span class="p">,</span> <span class="n">Opt_err</span><span class="p">,</span>
	<span class="n">Opt_usrquota</span><span class="p">,</span> <span class="n">Opt_grpquota</span><span class="p">,</span> <span class="n">Opt_i_version</span><span class="p">,</span>
	<span class="n">Opt_stripe</span><span class="p">,</span> <span class="n">Opt_delalloc</span><span class="p">,</span> <span class="n">Opt_nodelalloc</span><span class="p">,</span> <span class="n">Opt_mblk_io_submit</span><span class="p">,</span>
	<span class="n">Opt_nomblk_io_submit</span><span class="p">,</span> <span class="n">Opt_block_validity</span><span class="p">,</span> <span class="n">Opt_noblock_validity</span><span class="p">,</span>
	<span class="n">Opt_inode_readahead_blks</span><span class="p">,</span> <span class="n">Opt_journal_ioprio</span><span class="p">,</span>
	<span class="n">Opt_dioread_nolock</span><span class="p">,</span> <span class="n">Opt_dioread_lock</span><span class="p">,</span>
	<span class="n">Opt_discard</span><span class="p">,</span> <span class="n">Opt_nodiscard</span><span class="p">,</span> <span class="n">Opt_init_itable</span><span class="p">,</span> <span class="n">Opt_noinit_itable</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">Opt_bsd_df</span><span class="p">,</span> <span class="s">&quot;bsddf&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_minix_df</span><span class="p">,</span> <span class="s">&quot;minixdf&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_grpid</span><span class="p">,</span> <span class="s">&quot;grpid&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_grpid</span><span class="p">,</span> <span class="s">&quot;bsdgroups&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nogrpid</span><span class="p">,</span> <span class="s">&quot;nogrpid&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nogrpid</span><span class="p">,</span> <span class="s">&quot;sysvgroups&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_resgid</span><span class="p">,</span> <span class="s">&quot;resgid=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_resuid</span><span class="p">,</span> <span class="s">&quot;resuid=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_sb</span><span class="p">,</span> <span class="s">&quot;sb=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err_cont</span><span class="p">,</span> <span class="s">&quot;errors=continue&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err_panic</span><span class="p">,</span> <span class="s">&quot;errors=panic&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err_ro</span><span class="p">,</span> <span class="s">&quot;errors=remount-ro&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nouid32</span><span class="p">,</span> <span class="s">&quot;nouid32&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_debug</span><span class="p">,</span> <span class="s">&quot;debug&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_removed</span><span class="p">,</span> <span class="s">&quot;oldalloc&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_removed</span><span class="p">,</span> <span class="s">&quot;orlov&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_user_xattr</span><span class="p">,</span> <span class="s">&quot;user_xattr&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nouser_xattr</span><span class="p">,</span> <span class="s">&quot;nouser_xattr&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_acl</span><span class="p">,</span> <span class="s">&quot;acl&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noacl</span><span class="p">,</span> <span class="s">&quot;noacl&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noload</span><span class="p">,</span> <span class="s">&quot;norecovery&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noload</span><span class="p">,</span> <span class="s">&quot;noload&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_removed</span><span class="p">,</span> <span class="s">&quot;nobh&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_removed</span><span class="p">,</span> <span class="s">&quot;bh&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_commit</span><span class="p">,</span> <span class="s">&quot;commit=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_min_batch_time</span><span class="p">,</span> <span class="s">&quot;min_batch_time=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_max_batch_time</span><span class="p">,</span> <span class="s">&quot;max_batch_time=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_journal_dev</span><span class="p">,</span> <span class="s">&quot;journal_dev=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_journal_checksum</span><span class="p">,</span> <span class="s">&quot;journal_checksum&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_journal_async_commit</span><span class="p">,</span> <span class="s">&quot;journal_async_commit&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_abort</span><span class="p">,</span> <span class="s">&quot;abort&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_journal</span><span class="p">,</span> <span class="s">&quot;data=journal&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_ordered</span><span class="p">,</span> <span class="s">&quot;data=ordered&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_writeback</span><span class="p">,</span> <span class="s">&quot;data=writeback&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_err_abort</span><span class="p">,</span> <span class="s">&quot;data_err=abort&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_err_ignore</span><span class="p">,</span> <span class="s">&quot;data_err=ignore&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_offusrjquota</span><span class="p">,</span> <span class="s">&quot;usrjquota=&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_usrjquota</span><span class="p">,</span> <span class="s">&quot;usrjquota=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_offgrpjquota</span><span class="p">,</span> <span class="s">&quot;grpjquota=&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_grpjquota</span><span class="p">,</span> <span class="s">&quot;grpjquota=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_jqfmt_vfsold</span><span class="p">,</span> <span class="s">&quot;jqfmt=vfsold&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_jqfmt_vfsv0</span><span class="p">,</span> <span class="s">&quot;jqfmt=vfsv0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_jqfmt_vfsv1</span><span class="p">,</span> <span class="s">&quot;jqfmt=vfsv1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_grpquota</span><span class="p">,</span> <span class="s">&quot;grpquota&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noquota</span><span class="p">,</span> <span class="s">&quot;noquota&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_quota</span><span class="p">,</span> <span class="s">&quot;quota&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_usrquota</span><span class="p">,</span> <span class="s">&quot;usrquota&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_barrier</span><span class="p">,</span> <span class="s">&quot;barrier=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_barrier</span><span class="p">,</span> <span class="s">&quot;barrier&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nobarrier</span><span class="p">,</span> <span class="s">&quot;nobarrier&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_i_version</span><span class="p">,</span> <span class="s">&quot;i_version&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_stripe</span><span class="p">,</span> <span class="s">&quot;stripe=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_delalloc</span><span class="p">,</span> <span class="s">&quot;delalloc&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nodelalloc</span><span class="p">,</span> <span class="s">&quot;nodelalloc&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_mblk_io_submit</span><span class="p">,</span> <span class="s">&quot;mblk_io_submit&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nomblk_io_submit</span><span class="p">,</span> <span class="s">&quot;nomblk_io_submit&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_block_validity</span><span class="p">,</span> <span class="s">&quot;block_validity&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noblock_validity</span><span class="p">,</span> <span class="s">&quot;noblock_validity&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_inode_readahead_blks</span><span class="p">,</span> <span class="s">&quot;inode_readahead_blks=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_journal_ioprio</span><span class="p">,</span> <span class="s">&quot;journal_ioprio=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_auto_da_alloc</span><span class="p">,</span> <span class="s">&quot;auto_da_alloc=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_auto_da_alloc</span><span class="p">,</span> <span class="s">&quot;auto_da_alloc&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noauto_da_alloc</span><span class="p">,</span> <span class="s">&quot;noauto_da_alloc&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_dioread_nolock</span><span class="p">,</span> <span class="s">&quot;dioread_nolock&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_dioread_lock</span><span class="p">,</span> <span class="s">&quot;dioread_lock&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_discard</span><span class="p">,</span> <span class="s">&quot;discard&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nodiscard</span><span class="p">,</span> <span class="s">&quot;nodiscard&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_init_itable</span><span class="p">,</span> <span class="s">&quot;init_itable=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_init_itable</span><span class="p">,</span> <span class="s">&quot;init_itable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noinit_itable</span><span class="p">,</span> <span class="s">&quot;noinit_itable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_removed</span><span class="p">,</span> <span class="s">&quot;check=none&quot;</span><span class="p">},</span>	<span class="cm">/* mount option from ext2/3 */</span>
	<span class="p">{</span><span class="n">Opt_removed</span><span class="p">,</span> <span class="s">&quot;nocheck&quot;</span><span class="p">},</span>	<span class="cm">/* mount option from ext2/3 */</span>
	<span class="p">{</span><span class="n">Opt_removed</span><span class="p">,</span> <span class="s">&quot;reservation&quot;</span><span class="p">},</span>	<span class="cm">/* mount option from ext2/3 */</span>
	<span class="p">{</span><span class="n">Opt_removed</span><span class="p">,</span> <span class="s">&quot;noreservation&quot;</span><span class="p">},</span> <span class="cm">/* mount option from ext2/3 */</span>
	<span class="p">{</span><span class="n">Opt_removed</span><span class="p">,</span> <span class="s">&quot;journal=%u&quot;</span><span class="p">},</span>	<span class="cm">/* mount option from ext2/3 */</span>
	<span class="p">{</span><span class="n">Opt_err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ext4_fsblk_t</span> <span class="nf">get_sb_block</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_fsblk_t</span>	<span class="n">sb_block</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;sb=&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Default location */</span>

	<span class="n">options</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="cm">/* TODO: use simple_strtoll with &gt;32bit ext4 */</span>
	<span class="n">sb_block</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">options</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">options</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;EXT4-fs: Invalid sb specification: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">options</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
		<span class="n">options</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">options</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sb_block</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DEFAULT_JOURNAL_IOPRIO (IOPRIO_PRIO_VALUE(IOPRIO_CLASS_BE, 3))</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">deprecated_msg</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Mount option </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> will be removed by %s</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Contact linux-ext4@vger.kernel.org if you think we should keep it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_qf_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qtype</span><span class="p">,</span> <span class="n">substring_t</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">qname</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb_any_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;Cannot change journaled &quot;</span>
			<span class="s">&quot;quota options when quota turned on&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qname</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;Not enough memory for storing quotafile name&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		<span class="n">strcmp</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">],</span> <span class="n">qname</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s quota file already specified&quot;</span><span class="p">,</span> <span class="n">QTYPE2NAME</span><span class="p">(</span><span class="n">qtype</span><span class="p">));</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qname</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]</span> <span class="o">=</span> <span class="n">qname</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">],</span> <span class="sc">&#39;/&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;quotafile must be on filesystem root&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">QUOTA</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clear_qf_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qtype</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb_any_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Cannot change journaled quota options&quot;</span>
			<span class="s">&quot; when quota turned on&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * The space will be released later when all options are confirmed</span>
<span class="cm">	 * to be correct</span>
<span class="cm">	 */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define MOPT_SET	0x0001</span>
<span class="cp">#define MOPT_CLEAR	0x0002</span>
<span class="cp">#define MOPT_NOSUPPORT	0x0004</span>
<span class="cp">#define MOPT_EXPLICIT	0x0008</span>
<span class="cp">#define MOPT_CLEAR_ERR	0x0010</span>
<span class="cp">#define MOPT_GTE0	0x0020</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
<span class="cp">#define MOPT_Q		0</span>
<span class="cp">#define MOPT_QFMT	0x0040</span>
<span class="cp">#else</span>
<span class="cp">#define MOPT_Q		MOPT_NOSUPPORT</span>
<span class="cp">#define MOPT_QFMT	MOPT_NOSUPPORT</span>
<span class="cp">#endif</span>
<span class="cp">#define MOPT_DATAJ	0x0080</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mount_opts</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">token</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">mount_opt</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ext4_mount_opts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">Opt_minix_df</span><span class="p">,</span> <span class="n">EXT4_MOUNT_MINIX_DF</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_bsd_df</span><span class="p">,</span> <span class="n">EXT4_MOUNT_MINIX_DF</span><span class="p">,</span> <span class="n">MOPT_CLEAR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_grpid</span><span class="p">,</span> <span class="n">EXT4_MOUNT_GRPID</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nogrpid</span><span class="p">,</span> <span class="n">EXT4_MOUNT_GRPID</span><span class="p">,</span> <span class="n">MOPT_CLEAR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_mblk_io_submit</span><span class="p">,</span> <span class="n">EXT4_MOUNT_MBLK_IO_SUBMIT</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nomblk_io_submit</span><span class="p">,</span> <span class="n">EXT4_MOUNT_MBLK_IO_SUBMIT</span><span class="p">,</span> <span class="n">MOPT_CLEAR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_block_validity</span><span class="p">,</span> <span class="n">EXT4_MOUNT_BLOCK_VALIDITY</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noblock_validity</span><span class="p">,</span> <span class="n">EXT4_MOUNT_BLOCK_VALIDITY</span><span class="p">,</span> <span class="n">MOPT_CLEAR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_dioread_nolock</span><span class="p">,</span> <span class="n">EXT4_MOUNT_DIOREAD_NOLOCK</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_dioread_lock</span><span class="p">,</span> <span class="n">EXT4_MOUNT_DIOREAD_NOLOCK</span><span class="p">,</span> <span class="n">MOPT_CLEAR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_discard</span><span class="p">,</span> <span class="n">EXT4_MOUNT_DISCARD</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nodiscard</span><span class="p">,</span> <span class="n">EXT4_MOUNT_DISCARD</span><span class="p">,</span> <span class="n">MOPT_CLEAR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_delalloc</span><span class="p">,</span> <span class="n">EXT4_MOUNT_DELALLOC</span><span class="p">,</span> <span class="n">MOPT_SET</span> <span class="o">|</span> <span class="n">MOPT_EXPLICIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nodelalloc</span><span class="p">,</span> <span class="n">EXT4_MOUNT_DELALLOC</span><span class="p">,</span> <span class="n">MOPT_CLEAR</span> <span class="o">|</span> <span class="n">MOPT_EXPLICIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_journal_checksum</span><span class="p">,</span> <span class="n">EXT4_MOUNT_JOURNAL_CHECKSUM</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_journal_async_commit</span><span class="p">,</span> <span class="p">(</span><span class="n">EXT4_MOUNT_JOURNAL_ASYNC_COMMIT</span> <span class="o">|</span>
				    <span class="n">EXT4_MOUNT_JOURNAL_CHECKSUM</span><span class="p">),</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noload</span><span class="p">,</span> <span class="n">EXT4_MOUNT_NOLOAD</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err_panic</span><span class="p">,</span> <span class="n">EXT4_MOUNT_ERRORS_PANIC</span><span class="p">,</span> <span class="n">MOPT_SET</span> <span class="o">|</span> <span class="n">MOPT_CLEAR_ERR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err_ro</span><span class="p">,</span> <span class="n">EXT4_MOUNT_ERRORS_RO</span><span class="p">,</span> <span class="n">MOPT_SET</span> <span class="o">|</span> <span class="n">MOPT_CLEAR_ERR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err_cont</span><span class="p">,</span> <span class="n">EXT4_MOUNT_ERRORS_CONT</span><span class="p">,</span> <span class="n">MOPT_SET</span> <span class="o">|</span> <span class="n">MOPT_CLEAR_ERR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_err_abort</span><span class="p">,</span> <span class="n">EXT4_MOUNT_DATA_ERR_ABORT</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_err_ignore</span><span class="p">,</span> <span class="n">EXT4_MOUNT_DATA_ERR_ABORT</span><span class="p">,</span> <span class="n">MOPT_CLEAR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_barrier</span><span class="p">,</span> <span class="n">EXT4_MOUNT_BARRIER</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nobarrier</span><span class="p">,</span> <span class="n">EXT4_MOUNT_BARRIER</span><span class="p">,</span> <span class="n">MOPT_CLEAR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noauto_da_alloc</span><span class="p">,</span> <span class="n">EXT4_MOUNT_NO_AUTO_DA_ALLOC</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_auto_da_alloc</span><span class="p">,</span> <span class="n">EXT4_MOUNT_NO_AUTO_DA_ALLOC</span><span class="p">,</span> <span class="n">MOPT_CLEAR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noinit_itable</span><span class="p">,</span> <span class="n">EXT4_MOUNT_INIT_INODE_TABLE</span><span class="p">,</span> <span class="n">MOPT_CLEAR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_commit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOPT_GTE0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_max_batch_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOPT_GTE0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_min_batch_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOPT_GTE0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_inode_readahead_blks</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOPT_GTE0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_init_itable</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOPT_GTE0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_stripe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOPT_GTE0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_journal</span><span class="p">,</span> <span class="n">EXT4_MOUNT_JOURNAL_DATA</span><span class="p">,</span> <span class="n">MOPT_DATAJ</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_ordered</span><span class="p">,</span> <span class="n">EXT4_MOUNT_ORDERED_DATA</span><span class="p">,</span> <span class="n">MOPT_DATAJ</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_writeback</span><span class="p">,</span> <span class="n">EXT4_MOUNT_WRITEBACK_DATA</span><span class="p">,</span> <span class="n">MOPT_DATAJ</span><span class="p">},</span>
<span class="cp">#ifdef CONFIG_EXT4_FS_XATTR</span>
	<span class="p">{</span><span class="n">Opt_user_xattr</span><span class="p">,</span> <span class="n">EXT4_MOUNT_XATTR_USER</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nouser_xattr</span><span class="p">,</span> <span class="n">EXT4_MOUNT_XATTR_USER</span><span class="p">,</span> <span class="n">MOPT_CLEAR</span><span class="p">},</span>
<span class="cp">#else</span>
	<span class="p">{</span><span class="n">Opt_user_xattr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOPT_NOSUPPORT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nouser_xattr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOPT_NOSUPPORT</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_EXT4_FS_POSIX_ACL</span>
	<span class="p">{</span><span class="n">Opt_acl</span><span class="p">,</span> <span class="n">EXT4_MOUNT_POSIX_ACL</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noacl</span><span class="p">,</span> <span class="n">EXT4_MOUNT_POSIX_ACL</span><span class="p">,</span> <span class="n">MOPT_CLEAR</span><span class="p">},</span>
<span class="cp">#else</span>
	<span class="p">{</span><span class="n">Opt_acl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOPT_NOSUPPORT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noacl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOPT_NOSUPPORT</span><span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span><span class="n">Opt_nouid32</span><span class="p">,</span> <span class="n">EXT4_MOUNT_NO_UID32</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_debug</span><span class="p">,</span> <span class="n">EXT4_MOUNT_DEBUG</span><span class="p">,</span> <span class="n">MOPT_SET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_quota</span><span class="p">,</span> <span class="n">EXT4_MOUNT_QUOTA</span> <span class="o">|</span> <span class="n">EXT4_MOUNT_USRQUOTA</span><span class="p">,</span> <span class="n">MOPT_SET</span> <span class="o">|</span> <span class="n">MOPT_Q</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_usrquota</span><span class="p">,</span> <span class="n">EXT4_MOUNT_QUOTA</span> <span class="o">|</span> <span class="n">EXT4_MOUNT_USRQUOTA</span><span class="p">,</span>
							<span class="n">MOPT_SET</span> <span class="o">|</span> <span class="n">MOPT_Q</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_grpquota</span><span class="p">,</span> <span class="n">EXT4_MOUNT_QUOTA</span> <span class="o">|</span> <span class="n">EXT4_MOUNT_GRPQUOTA</span><span class="p">,</span>
							<span class="n">MOPT_SET</span> <span class="o">|</span> <span class="n">MOPT_Q</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noquota</span><span class="p">,</span> <span class="p">(</span><span class="n">EXT4_MOUNT_QUOTA</span> <span class="o">|</span> <span class="n">EXT4_MOUNT_USRQUOTA</span> <span class="o">|</span>
		       <span class="n">EXT4_MOUNT_GRPQUOTA</span><span class="p">),</span> <span class="n">MOPT_CLEAR</span> <span class="o">|</span> <span class="n">MOPT_Q</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_usrjquota</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOPT_Q</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_grpjquota</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOPT_Q</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_offusrjquota</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOPT_Q</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_offgrpjquota</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOPT_Q</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_jqfmt_vfsold</span><span class="p">,</span> <span class="n">QFMT_VFS_OLD</span><span class="p">,</span> <span class="n">MOPT_QFMT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_jqfmt_vfsv0</span><span class="p">,</span> <span class="n">QFMT_VFS_V0</span><span class="p">,</span> <span class="n">MOPT_QFMT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_jqfmt_vfsv1</span><span class="p">,</span> <span class="n">QFMT_VFS_V1</span><span class="p">,</span> <span class="n">MOPT_QFMT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_mount_opt</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">token</span><span class="p">,</span>
			    <span class="n">substring_t</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">journal_devnum</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">journal_ioprio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_remount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mount_opts</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="n">kuid_t</span> <span class="n">uid</span><span class="p">;</span>
	<span class="n">kgid_t</span> <span class="n">gid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="n">Opt_usrjquota</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">set_qf_name</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="n">Opt_grpjquota</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">set_qf_name</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="n">Opt_offusrjquota</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">clear_qf_name</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="n">Opt_offgrpjquota</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">clear_qf_name</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">&amp;&amp;</span> <span class="n">match_int</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Opt_noacl</span>:
	<span class="k">case</span> <span class="n">Opt_nouser_xattr</span>:
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">deprecated_msg</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="s">&quot;3.5&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sb</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* handled by get_sb_block() */</span>
	<span class="k">case</span> <span class="n">Opt_removed</span>:
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
			 <span class="s">&quot;Ignoring removed %s option&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_resuid</span>:
		<span class="n">uid</span> <span class="o">=</span> <span class="n">make_kuid</span><span class="p">(</span><span class="n">current_user_ns</span><span class="p">(),</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uid_valid</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Invalid uid value %d&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resuid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_resgid</span>:
		<span class="n">gid</span> <span class="o">=</span> <span class="n">make_kgid</span><span class="p">(</span><span class="n">current_user_ns</span><span class="p">(),</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gid_valid</span><span class="p">(</span><span class="n">gid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Invalid gid value %d&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resgid</span> <span class="o">=</span> <span class="n">gid</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_abort</span>:
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_flags</span> <span class="o">|=</span> <span class="n">EXT4_MF_FS_ABORTED</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_i_version</span>:
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_I_VERSION</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_journal_dev</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_remount</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				 <span class="s">&quot;Cannot specify journal on remount&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">journal_devnum</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_journal_ioprio</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">arg</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">journal_ioprio</span> <span class="o">=</span> <span class="n">IOPRIO_PRIO_VALUE</span><span class="p">(</span><span class="n">IOPRIO_CLASS_BE</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">ext4_mount_opts</span><span class="p">;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">!=</span> <span class="n">Opt_err</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">!=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MOPT_GTE0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MOPT_EXPLICIT</span><span class="p">)</span>
			<span class="n">set_opt2</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXPLICIT_DELALLOC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MOPT_CLEAR_ERR</span><span class="p">)</span>
			<span class="n">clear_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="n">Opt_noquota</span> <span class="o">&amp;&amp;</span> <span class="n">sb_any_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Cannot change quota &quot;</span>
				 <span class="s">&quot;options when quota turned on&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MOPT_NOSUPPORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;%s option not supported&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="n">Opt_commit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="n">JBD2_DEFAULT_MAX_COMMIT_AGE</span><span class="p">;</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_commit_interval</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">arg</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="n">Opt_max_batch_time</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="n">EXT4_DEF_MAX_BATCH_TIME</span><span class="p">;</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_max_batch_time</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="n">Opt_min_batch_time</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_min_batch_time</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="n">Opt_inode_readahead_blks</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
					 <span class="s">&quot;EXT4-fs: inode_readahead_blks&quot;</span>
					 <span class="s">&quot; must be a power of 2&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_readahead_blks</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="n">Opt_init_itable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">INIT_INODE_TABLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">)</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="n">EXT4_DEF_LI_WAIT_MULT</span><span class="p">;</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_li_wait_mult</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="n">Opt_stripe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MOPT_DATAJ</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_remount</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">)</span>
					<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Remounting file system with no journal so ignoring journalled data option&quot;</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_FLAGS</span><span class="p">)</span> <span class="o">!=</span>
					 <span class="n">m</span><span class="o">-&gt;</span><span class="n">mount_opt</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
					 <span class="s">&quot;Cannot change data mode on remount&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">clear_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_FLAGS</span><span class="p">);</span>
				<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">|=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mount_opt</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MOPT_QFMT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sb_any_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span> <span class="o">!=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mount_opt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Cannot &quot;</span>
					 <span class="s">&quot;change journaled quota options &quot;</span>
					 <span class="s">&quot;when quota turned on&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mount_opt</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">)</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MOPT_CLEAR</span><span class="p">)</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="o">!</span><span class="n">arg</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MOPT_SET</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
					 <span class="s">&quot;buggy handling of option %s&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
				<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">|=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mount_opt</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mount_opt</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Unrecognized mount option </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> &quot;</span>
		 <span class="s">&quot;or missing value&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_options</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">journal_devnum</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">journal_ioprio</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">is_remount</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">token</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">p</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Initialize args struct so we know whether arg was</span>
<span class="cm">		 * found; some options take optional arguments.</span>
<span class="cm">		 */</span>
		<span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">to</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">handle_mount_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">journal_devnum</span><span class="p">,</span>
				     <span class="n">journal_ioprio</span><span class="p">,</span> <span class="n">is_remount</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">]</span> <span class="o">||</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">])</span>
			<span class="n">clear_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">])</span>
			<span class="n">clear_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">)</span> <span class="o">||</span> <span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;old and new quota &quot;</span>
					<span class="s">&quot;format mixing&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;journaled quota format &quot;</span>
					<span class="s">&quot;not specified&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;journaled quota format &quot;</span>
					<span class="s">&quot;specified with no journaling &quot;</span>
					<span class="s">&quot;enabled&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ext4_show_quota_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_QUOTA)</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">fmtname</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QFMT_VFS_OLD</span>:
			<span class="n">fmtname</span> <span class="o">=</span> <span class="s">&quot;vfsold&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QFMT_VFS_V0</span>:
			<span class="n">fmtname</span> <span class="o">=</span> <span class="s">&quot;vfsv0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QFMT_VFS_V1</span>:
			<span class="n">fmtname</span> <span class="o">=</span> <span class="s">&quot;vfsv1&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,jqfmt=%s&quot;</span><span class="p">,</span> <span class="n">fmtname</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">])</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,usrjquota=%s&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">])</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,grpjquota=%s&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,usrquota&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,grpquota&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">token2str</span><span class="p">(</span><span class="kt">int</span> <span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">match_token</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">!=</span> <span class="n">Opt_err</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">token</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strchr</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Show an option if</span>
<span class="cm"> *  - it&#39;s set to a non-default value OR</span>
<span class="cm"> *  - if the per-sb default is different from the global default</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_ext4_show_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">nodefs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">def_errors</span><span class="p">,</span> <span class="n">def_mount_opt</span> <span class="o">=</span> <span class="n">nodefs</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_def_mount_opt</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mount_opts</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">sep</span> <span class="o">=</span> <span class="n">nodefs</span> <span class="o">?</span> <span class="sc">&#39;\n&#39;</span> <span class="o">:</span> <span class="sc">&#39;,&#39;</span><span class="p">;</span>

<span class="cp">#define SEQ_OPTS_PUTS(str) seq_printf(seq, &quot;%c&quot; str, sep)</span>
<span class="cp">#define SEQ_OPTS_PRINT(str, arg) seq_printf(seq, &quot;%c&quot; str, sep, arg)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sb_block</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">SEQ_OPTS_PRINT</span><span class="p">(</span><span class="s">&quot;sb=%llu&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sb_block</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">ext4_mount_opts</span><span class="p">;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">!=</span> <span class="n">Opt_err</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">want_set</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MOPT_SET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MOPT_SET</span><span class="o">|</span><span class="n">MOPT_CLEAR</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MOPT_CLEAR_ERR</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mount_opt</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">^</span> <span class="n">def_mount_opt</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* skip if same as the default */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">want_set</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mount_opt</span><span class="p">)</span> <span class="o">!=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mount_opt</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">want_set</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mount_opt</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* select Opt_noFoo vs Opt_Foo */</span>
		<span class="n">SEQ_OPTS_PRINT</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">token2str</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nodefs</span> <span class="o">||</span> <span class="o">!</span><span class="n">uid_eq</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resuid</span><span class="p">,</span> <span class="n">make_kuid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">EXT4_DEF_RESUID</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_def_resuid</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EXT4_DEF_RESUID</span><span class="p">)</span>
		<span class="n">SEQ_OPTS_PRINT</span><span class="p">(</span><span class="s">&quot;resuid=%u&quot;</span><span class="p">,</span>
				<span class="n">from_kuid_munged</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resuid</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nodefs</span> <span class="o">||</span> <span class="o">!</span><span class="n">gid_eq</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resgid</span><span class="p">,</span> <span class="n">make_kgid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">EXT4_DEF_RESGID</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_def_resgid</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EXT4_DEF_RESGID</span><span class="p">)</span>
		<span class="n">SEQ_OPTS_PRINT</span><span class="p">(</span><span class="s">&quot;resgid=%u&quot;</span><span class="p">,</span>
				<span class="n">from_kgid_munged</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resgid</span><span class="p">));</span>
	<span class="n">def_errors</span> <span class="o">=</span> <span class="n">nodefs</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_errors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_RO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">def_errors</span> <span class="o">!=</span> <span class="n">EXT4_ERRORS_RO</span><span class="p">)</span>
		<span class="n">SEQ_OPTS_PUTS</span><span class="p">(</span><span class="s">&quot;errors=remount-ro&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_CONT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">def_errors</span> <span class="o">!=</span> <span class="n">EXT4_ERRORS_CONTINUE</span><span class="p">)</span>
		<span class="n">SEQ_OPTS_PUTS</span><span class="p">(</span><span class="s">&quot;errors=continue&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_PANIC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">def_errors</span> <span class="o">!=</span> <span class="n">EXT4_ERRORS_PANIC</span><span class="p">)</span>
		<span class="n">SEQ_OPTS_PUTS</span><span class="p">(</span><span class="s">&quot;errors=panic&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nodefs</span> <span class="o">||</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_commit_interval</span> <span class="o">!=</span> <span class="n">JBD2_DEFAULT_MAX_COMMIT_AGE</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span>
		<span class="n">SEQ_OPTS_PRINT</span><span class="p">(</span><span class="s">&quot;commit=%lu&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_commit_interval</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nodefs</span> <span class="o">||</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_min_batch_time</span> <span class="o">!=</span> <span class="n">EXT4_DEF_MIN_BATCH_TIME</span><span class="p">)</span>
		<span class="n">SEQ_OPTS_PRINT</span><span class="p">(</span><span class="s">&quot;min_batch_time=%u&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_min_batch_time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nodefs</span> <span class="o">||</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_max_batch_time</span> <span class="o">!=</span> <span class="n">EXT4_DEF_MAX_BATCH_TIME</span><span class="p">)</span>
		<span class="n">SEQ_OPTS_PRINT</span><span class="p">(</span><span class="s">&quot;max_batch_time=%u&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_max_batch_time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_I_VERSION</span><span class="p">)</span>
		<span class="n">SEQ_OPTS_PUTS</span><span class="p">(</span><span class="s">&quot;i_version&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nodefs</span> <span class="o">||</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span><span class="p">)</span>
		<span class="n">SEQ_OPTS_PRINT</span><span class="p">(</span><span class="s">&quot;stripe=%lu&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_MOUNT_DATA_FLAGS</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">^</span> <span class="n">def_mount_opt</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_FLAGS</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT4_MOUNT_JOURNAL_DATA</span><span class="p">)</span>
			<span class="n">SEQ_OPTS_PUTS</span><span class="p">(</span><span class="s">&quot;data=journal&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_FLAGS</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT4_MOUNT_ORDERED_DATA</span><span class="p">)</span>
			<span class="n">SEQ_OPTS_PUTS</span><span class="p">(</span><span class="s">&quot;data=ordered&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_FLAGS</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT4_MOUNT_WRITEBACK_DATA</span><span class="p">)</span>
			<span class="n">SEQ_OPTS_PUTS</span><span class="p">(</span><span class="s">&quot;data=writeback&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nodefs</span> <span class="o">||</span>
	    <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_readahead_blks</span> <span class="o">!=</span> <span class="n">EXT4_DEF_INODE_READAHEAD_BLKS</span><span class="p">)</span>
		<span class="n">SEQ_OPTS_PRINT</span><span class="p">(</span><span class="s">&quot;inode_readahead_blks=%u&quot;</span><span class="p">,</span>
			       <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_readahead_blks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nodefs</span> <span class="o">||</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">INIT_INODE_TABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_li_wait_mult</span> <span class="o">!=</span> <span class="n">EXT4_DEF_LI_WAIT_MULT</span><span class="p">)))</span>
		<span class="n">SEQ_OPTS_PRINT</span><span class="p">(</span><span class="s">&quot;init_itable=%u&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_li_wait_mult</span><span class="p">);</span>

	<span class="n">ext4_show_quota_options</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_show_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_ext4_show_options</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">options_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ro&quot;</span> <span class="o">:</span> <span class="s">&quot;rw&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">_ext4_show_options</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">options_open_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">options_seq_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ext4_seq_options_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">options_open_fs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_setup_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">read_only</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_rev_level</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">EXT4_MAX_SUPP_REV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;revision level too high, &quot;</span>
			 <span class="s">&quot;forcing read-only mode&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_only</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">&amp;</span> <span class="n">EXT4_VALID_FS</span><span class="p">))</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;warning: mounting unchecked fs, &quot;</span>
			 <span class="s">&quot;running e2fsck is recommended&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">&amp;</span> <span class="n">EXT4_ERROR_FS</span><span class="p">))</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
			 <span class="s">&quot;warning: mounting fs with errors, &quot;</span>
			 <span class="s">&quot;running e2fsck is recommended&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">__s16</span><span class="p">)</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_max_mnt_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_mnt_count</span><span class="p">)</span> <span class="o">&gt;=</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="p">(</span><span class="n">__s16</span><span class="p">)</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_max_mnt_count</span><span class="p">))</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
			 <span class="s">&quot;warning: maximal mount count reached, &quot;</span>
			 <span class="s">&quot;running e2fsck is recommended&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_checkinterval</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_lastcheck</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_checkinterval</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">get_seconds</span><span class="p">()))</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
			 <span class="s">&quot;warning: checktime reached, &quot;</span>
			 <span class="s">&quot;running e2fsck is recommended&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">)</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">~</span><span class="n">EXT4_VALID_FS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__s16</span><span class="p">)</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_max_mnt_count</span><span class="p">))</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_max_mnt_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT4_DFL_MAX_MNT_COUNT</span><span class="p">);</span>
	<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_mnt_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_mtime</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">get_seconds</span><span class="p">());</span>
	<span class="n">ext4_update_dynamic_rev</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">)</span>
		<span class="n">EXT4_SET_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_RECOVER</span><span class="p">);</span>

	<span class="n">ext4_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DEBUG</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;[EXT4 FS bs=%lu, gc=%u, &quot;</span>
				<span class="s">&quot;bpg=%lu, ipg=%lu, mo=%04x, mo2=%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">,</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">,</span>
			<span class="n">EXT4_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span>
			<span class="n">EXT4_INODES_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt2</span><span class="p">);</span>

	<span class="n">cleancache_init_fs</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_fill_flex_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">gdp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">flex_group_count</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">flex_group</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">groups_per_flex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_log_groups_per_flex</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_log_groups_per_flex</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_log_groups_per_flex</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_log_groups_per_flex</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_log_groups_per_flex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">groups_per_flex</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_log_groups_per_flex</span><span class="p">;</span>

	<span class="cm">/* We allocate both existing and potentially added groups */</span>
	<span class="n">flex_group_count</span> <span class="o">=</span> <span class="p">((</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span> <span class="o">+</span> <span class="n">groups_per_flex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_reserved_gdt_blocks</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			      <span class="n">EXT4_DESC_PER_BLOCK_BITS</span><span class="p">(</span><span class="n">sb</span><span class="p">)))</span> <span class="o">/</span> <span class="n">groups_per_flex</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">flex_group_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">flex_groups</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_flex_groups</span> <span class="o">=</span> <span class="n">ext4_kvzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_flex_groups</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;not enough memory for %u flex groups&quot;</span><span class="p">,</span>
			 <span class="n">flex_group_count</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gdp</span> <span class="o">=</span> <span class="n">ext4_get_group_desc</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">flex_group</span> <span class="o">=</span> <span class="n">ext4_flex_group</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">ext4_free_inodes_count</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">),</span>
			   <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_flex_groups</span><span class="p">[</span><span class="n">flex_group</span><span class="p">].</span><span class="n">free_inodes</span><span class="p">);</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">ext4_free_group_clusters</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">),</span>
			   <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_flex_groups</span><span class="p">[</span><span class="n">flex_group</span><span class="p">].</span><span class="n">free_clusters</span><span class="p">);</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">ext4_used_dirs_count</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">),</span>
			   <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_flex_groups</span><span class="p">[</span><span class="n">flex_group</span><span class="p">].</span><span class="n">used_dirs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">failed:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__le16</span> <span class="nf">ext4_group_desc_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">block_group</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">gdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">le_group</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">block_group</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_feature_ro_compat</span> <span class="o">&amp;</span>
	     <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">EXT4_FEATURE_RO_COMPAT_METADATA_CSUM</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Use new metadata_csum algorithm */</span>
		<span class="n">__u16</span> <span class="n">old_csum</span><span class="p">;</span>
		<span class="n">__u32</span> <span class="n">csum32</span><span class="p">;</span>

		<span class="n">old_csum</span> <span class="o">=</span> <span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_checksum</span><span class="p">;</span>
		<span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">csum32</span> <span class="o">=</span> <span class="n">ext4_chksum</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_csum_seed</span><span class="p">,</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">le_group</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">le_group</span><span class="p">));</span>
		<span class="n">csum32</span> <span class="o">=</span> <span class="n">ext4_chksum</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">csum32</span><span class="p">,</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">gdp</span><span class="p">,</span>
				     <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_desc_size</span><span class="p">);</span>
		<span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_checksum</span> <span class="o">=</span> <span class="n">old_csum</span><span class="p">;</span>

		<span class="n">crc</span> <span class="o">=</span> <span class="n">csum32</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* old crc16 code */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_group_desc</span><span class="p">,</span> <span class="n">bg_checksum</span><span class="p">);</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc16</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">));</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc16</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">le_group</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">le_group</span><span class="p">));</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc16</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">gdp</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_checksum</span><span class="p">);</span> <span class="cm">/* skip checksum */</span>
	<span class="cm">/* for checksum of struct ext4_group_desc do the rest...*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_feature_incompat</span> <span class="o">&amp;</span>
	     <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">EXT4_FEATURE_INCOMPAT_64BIT</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_desc_size</span><span class="p">))</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">crc16</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">gdp</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_desc_size</span><span class="p">)</span> <span class="o">-</span>
				<span class="n">offset</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">crc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ext4_group_desc_csum_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">block_group</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">gdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext4_has_group_desc_csum</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_checksum</span> <span class="o">!=</span> <span class="n">ext4_group_desc_csum</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span>
						      <span class="n">block_group</span><span class="p">,</span> <span class="n">gdp</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_group_desc_csum_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">block_group</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">gdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_has_group_desc_csum</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_checksum</span> <span class="o">=</span> <span class="n">ext4_group_desc_csum</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span> <span class="n">block_group</span><span class="p">,</span> <span class="n">gdp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called at mount-time, super-block is locked */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_check_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				  <span class="n">ext4_group_t</span> <span class="o">*</span><span class="n">first_not_zeroed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">first_block</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_first_data_block</span><span class="p">);</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">last_block</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">block_bitmap</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">inode_bitmap</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">inode_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flexbg_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">grp</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_FLEX_BG</span><span class="p">))</span>
		<span class="n">flexbg_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;Checking group descriptors&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">gdp</span> <span class="o">=</span> <span class="n">ext4_get_group_desc</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">flexbg_flag</span><span class="p">)</span>
			<span class="n">last_block</span> <span class="o">=</span> <span class="n">ext4_blocks_count</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">last_block</span> <span class="o">=</span> <span class="n">first_block</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">EXT4_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">grp</span> <span class="o">==</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_flags</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT4_BG_INODE_ZEROED</span><span class="p">)))</span>
			<span class="n">grp</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">block_bitmap</span> <span class="o">=</span> <span class="n">ext4_block_bitmap</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">block_bitmap</span> <span class="o">&lt;</span> <span class="n">first_block</span> <span class="o">||</span> <span class="n">block_bitmap</span> <span class="o">&gt;</span> <span class="n">last_block</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;ext4_check_descriptors: &quot;</span>
			       <span class="s">&quot;Block bitmap for group %u not in group &quot;</span>
			       <span class="s">&quot;(block %llu)!&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">block_bitmap</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">inode_bitmap</span> <span class="o">=</span> <span class="n">ext4_inode_bitmap</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inode_bitmap</span> <span class="o">&lt;</span> <span class="n">first_block</span> <span class="o">||</span> <span class="n">inode_bitmap</span> <span class="o">&gt;</span> <span class="n">last_block</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;ext4_check_descriptors: &quot;</span>
			       <span class="s">&quot;Inode bitmap for group %u not in group &quot;</span>
			       <span class="s">&quot;(block %llu)!&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">inode_bitmap</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">inode_table</span> <span class="o">=</span> <span class="n">ext4_inode_table</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inode_table</span> <span class="o">&lt;</span> <span class="n">first_block</span> <span class="o">||</span>
		    <span class="n">inode_table</span> <span class="o">+</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_itb_per_group</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">last_block</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;ext4_check_descriptors: &quot;</span>
			       <span class="s">&quot;Inode table for group %u not in group &quot;</span>
			       <span class="s">&quot;(block %llu)!&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">inode_table</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_group_desc_csum_verify</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gdp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;ext4_check_descriptors: &quot;</span>
				 <span class="s">&quot;Checksum for group %u failed (%u!=%u)&quot;</span><span class="p">,</span>
				 <span class="n">i</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ext4_group_desc_csum</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				     <span class="n">gdp</span><span class="p">)),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_checksum</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flexbg_flag</span><span class="p">)</span>
			<span class="n">first_block</span> <span class="o">+=</span> <span class="n">EXT4_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">first_not_zeroed</span><span class="p">)</span>
		<span class="o">*</span><span class="n">first_not_zeroed</span> <span class="o">=</span> <span class="n">grp</span><span class="p">;</span>

	<span class="n">ext4_free_blocks_count_set</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">,</span>
				   <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">ext4_count_free_clusters</span><span class="p">(</span><span class="n">sb</span><span class="p">)));</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_free_inodes_count</span> <span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ext4_count_free_inodes</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ext4_orphan_cleanup() walks a singly-linked list of inodes (starting at</span>
<span class="cm"> * the superblock) which were deleted from all directories, but held open by</span>
<span class="cm"> * a process at the time of a crash.  We walk the list and try to delete these</span>
<span class="cm"> * inodes at recovery time (only with a read-write filesystem).</span>
<span class="cm"> *</span>
<span class="cm"> * In order to keep the orphan inode chain consistent during traversal (in</span>
<span class="cm"> * case of crash during recovery), we link each inode into the superblock</span>
<span class="cm"> * orphan list_head and handle it the same way as an inode deletion during</span>
<span class="cm"> * normal operation (which journals the operations for us).</span>
<span class="cm"> *</span>
<span class="cm"> * We only do an iget() and an iput() on each inode, which is very safe if we</span>
<span class="cm"> * accidentally point at an in-use or already deleted inode.  The worst that</span>
<span class="cm"> * can happen in this case is that we get a &quot;bit already cleared&quot; message from</span>
<span class="cm"> * ext4_free_inode().  The only reason we would point at a wrong inode is if</span>
<span class="cm"> * e2fsck was run on this filesystem, and it must have already done the orphan</span>
<span class="cm"> * inode cleanup for us, so we can safely abort without any further action.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_orphan_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">s_flags</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_orphans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_truncates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jbd_debug</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;no orphan inodes to clean up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bdev_read_only</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;write access &quot;</span>
			<span class="s">&quot;unavailable, skipping orphan cleanup&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if feature set would not allow a r/w mount */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_feature_set_ok</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Skipping orphan cleanup due to &quot;</span>
			 <span class="s">&quot;unknown ROCOMPAT features&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">&amp;</span> <span class="n">EXT4_ERROR_FS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span><span class="p">)</span>
			<span class="n">jbd_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Errors on filesystem, &quot;</span>
				  <span class="s">&quot;clearing orphan list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">jbd_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Skipping orphan recovery on fs with errors.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;orphan cleanup on readonly fs&quot;</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="cm">/* Needed for iput() to work correctly and not trash data */</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_ACTIVE</span><span class="p">;</span>
	<span class="cm">/* Turn on quotas so that they are updated correctly */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_quota_on_mount</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
					<span class="s">&quot;Cannot turn on journaled &quot;</span>
					<span class="s">&quot;quota: error %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>

		<span class="n">inode</span> <span class="o">=</span> <span class="n">ext4_orphan_get</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EXT4_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_orphan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_orphan</span><span class="p">);</span>
		<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span>
				<span class="s">&quot;%s: truncating inode %lu to %lld bytes&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">);</span>
			<span class="n">jbd_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;truncating inode %lu to %lld bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">);</span>
			<span class="n">ext4_truncate</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
			<span class="n">nr_truncates</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span>
				<span class="s">&quot;%s: deleting unreferenced inode %lu&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
			<span class="n">jbd_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;deleting unreferenced inode %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
			<span class="n">nr_orphans</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>  <span class="cm">/* The delete magic happens here! */</span>
	<span class="p">}</span>

<span class="cp">#define PLURAL(x) (x), ((x) == 1) ? &quot;&quot; : &quot;s&quot;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_orphans</span><span class="p">)</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;%d orphan inode%s deleted&quot;</span><span class="p">,</span>
		       <span class="n">PLURAL</span><span class="p">(</span><span class="n">nr_orphans</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_truncates</span><span class="p">)</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;%d truncate%s cleaned up&quot;</span><span class="p">,</span>
		       <span class="n">PLURAL</span><span class="p">(</span><span class="n">nr_truncates</span><span class="p">));</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="cm">/* Turn quotas off */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">dquot_quota_off</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">=</span> <span class="n">s_flags</span><span class="p">;</span> <span class="cm">/* Restore MS_RDONLY status */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Maximal extent format file size.</span>
<span class="cm"> * Resulting logical blkno at s_maxbytes must fit in our on-disk</span>
<span class="cm"> * extent format containers, within a sector_t, and within i_blocks</span>
<span class="cm"> * in the vfs.  ext4 inode has 48 bits of i_block in fsblock units,</span>
<span class="cm"> * so that won&#39;t be a limiting factor.</span>
<span class="cm"> *</span>
<span class="cm"> * However there is other limiting factor. We do store extents in the form</span>
<span class="cm"> * of starting block and length, hence the resulting length of the extent</span>
<span class="cm"> * covering maximum file size must fit into on-disk format containers as</span>
<span class="cm"> * well. Given that length is always by 1 unit bigger than max unit (because</span>
<span class="cm"> * we count 0 as well) we have to lower the s_maxbytes by one fs block.</span>
<span class="cm"> *</span>
<span class="cm"> * Note, this does *not* consider any metadata overhead for vfs i_blocks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">loff_t</span> <span class="nf">ext4_max_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">blkbits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">has_huge_files</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loff_t</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">upper_limit</span> <span class="o">=</span> <span class="n">MAX_LFS_FILESIZE</span><span class="p">;</span>

	<span class="cm">/* small i_blocks in vfs inode? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_huge_files</span> <span class="o">||</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">blkcnt_t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * CONFIG_LBDAF is not enabled implies the inode</span>
<span class="cm">		 * i_block represent total blocks in 512 bytes</span>
<span class="cm">		 * 32 == size of vfs inode i_blocks * 8</span>
<span class="cm">		 */</span>
		<span class="n">upper_limit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* total blocks in file system block size */</span>
		<span class="n">upper_limit</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="n">blkbits</span> <span class="o">-</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">upper_limit</span> <span class="o">&lt;&lt;=</span> <span class="n">blkbits</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * 32-bit extent-start container, ee_block. We lower the maxbytes</span>
<span class="cm">	 * by one fs block, so ee_len can cover the extent of maximum file</span>
<span class="cm">	 * size</span>
<span class="cm">	 */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">&lt;&lt;=</span> <span class="n">blkbits</span><span class="p">;</span>

	<span class="cm">/* Sanity check against vm- &amp; vfs- imposed limits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="n">upper_limit</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">upper_limit</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Maximal bitmap file size.  There is a direct, and {,double-,triple-}indirect</span>
<span class="cm"> * block limit, and also a limit of (2^48 - 1) 512-byte sectors in i_blocks.</span>
<span class="cm"> * We need to be 1 filesystem block less than the 2^48 sector limit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">loff_t</span> <span class="nf">ext4_max_bitmap_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">has_huge_files</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loff_t</span> <span class="n">res</span> <span class="o">=</span> <span class="n">EXT4_NDIR_BLOCKS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">meta_blocks</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">upper_limit</span><span class="p">;</span>
	<span class="cm">/* This is calculated to be the largest file size for a dense, block</span>
<span class="cm">	 * mapped file such that the file&#39;s total number of 512-byte sectors,</span>
<span class="cm">	 * including data and all indirect blocks, does not exceed (2^48 - 1).</span>
<span class="cm">	 *</span>
<span class="cm">	 * __u32 i_blocks_lo and _u16 i_blocks_high represent the total</span>
<span class="cm">	 * number of 512-byte sectors of the file.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_huge_files</span> <span class="o">||</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">blkcnt_t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * !has_huge_files or CONFIG_LBDAF not enabled implies that</span>
<span class="cm">		 * the inode i_block field represents total file blocks in</span>
<span class="cm">		 * 2^32 512-byte sectors == size of vfs inode i_blocks * 8</span>
<span class="cm">		 */</span>
		<span class="n">upper_limit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* total blocks in file system block size */</span>
		<span class="n">upper_limit</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">9</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We use 48 bit ext4_inode i_blocks</span>
<span class="cm">		 * With EXT4_HUGE_FILE_FL set the i_blocks</span>
<span class="cm">		 * represent total number of blocks in</span>
<span class="cm">		 * file system block size</span>
<span class="cm">		 */</span>
		<span class="n">upper_limit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* indirect blocks */</span>
	<span class="n">meta_blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* double indirect blocks */</span>
	<span class="n">meta_blocks</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bits</span><span class="o">-</span><span class="mi">2</span><span class="p">));</span>
	<span class="cm">/* tripple indirect blocks */</span>
	<span class="n">meta_blocks</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bits</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">bits</span><span class="o">-</span><span class="mi">2</span><span class="p">)));</span>

	<span class="n">upper_limit</span> <span class="o">-=</span> <span class="n">meta_blocks</span><span class="p">;</span>
	<span class="n">upper_limit</span> <span class="o">&lt;&lt;=</span> <span class="n">bits</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">+=</span> <span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bits</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">+=</span> <span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">bits</span><span class="o">-</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">res</span> <span class="o">+=</span> <span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">bits</span><span class="o">-</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">res</span> <span class="o">&lt;&lt;=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="n">upper_limit</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">upper_limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="n">MAX_LFS_FILESIZE</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">MAX_LFS_FILESIZE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ext4_fsblk_t</span> <span class="nf">descriptor_loc</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				   <span class="n">ext4_fsblk_t</span> <span class="n">logical_sb_block</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">ext4_group_t</span> <span class="n">bg</span><span class="p">,</span> <span class="n">first_meta_bg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">has_super</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">first_meta_bg</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_first_meta_bg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_META_BG</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nr</span> <span class="o">&lt;</span> <span class="n">first_meta_bg</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">logical_sb_block</span> <span class="o">+</span> <span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bg</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_desc_per_block</span> <span class="o">*</span> <span class="n">nr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext4_bg_has_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">bg</span><span class="p">))</span>
		<span class="n">has_super</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">has_super</span> <span class="o">+</span> <span class="n">ext4_group_first_block_no</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">bg</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ext4_get_stripe_size: Get the stripe size.</span>
<span class="cm"> * @sbi: In memory super block info</span>
<span class="cm"> *</span>
<span class="cm"> * If we have specified it via mount option, then</span>
<span class="cm"> * use the mount option value. If the value specified at mount time is</span>
<span class="cm"> * greater than the blocks per group use the super block value.</span>
<span class="cm"> * If the super block value is greater than blocks per group return 0.</span>
<span class="cm"> * Allocator needs it be less than blocks per group.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">ext4_get_stripe_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stride</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_raid_stride</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stripe_width</span> <span class="o">=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_raid_stripe_width</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span> <span class="o">&amp;&amp;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span> <span class="o">&lt;=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_per_group</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stripe_width</span> <span class="o">&lt;=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_per_group</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">stripe_width</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stride</span> <span class="o">&lt;=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_per_group</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">stride</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the stripe width is 1, this makes no sense and</span>
<span class="cm">	 * we set it to 0 to turn off stripe handling code.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sysfs supprt */</span>

<span class="k">struct</span> <span class="n">ext4_attr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">attribute</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ext4_attr</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">store</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ext4_attr</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_strtoul</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">skip_spaces</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">endp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">endp</span> <span class="o">=</span> <span class="n">skip_spaces</span><span class="p">(</span><span class="n">endp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">endp</span> <span class="o">||</span> <span class="o">*</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">delayed_allocation_blocks_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_attr</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">,</span>
					      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">s64</span><span class="p">)</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span>
			<span class="n">percpu_counter_sum</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirtyclusters_counter</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">session_write_kbytes_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_attr</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_buddy_cache</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_part</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">part_stat_read</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_part</span><span class="p">,</span> <span class="n">sectors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>
			 <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sectors_written_start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">lifetime_write_kbytes_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_attr</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_buddy_cache</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_part</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_kbytes_written</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">part_stat_read</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_part</span><span class="p">,</span> <span class="n">sectors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>
			  <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_sectors_written_start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">inode_readahead_blks_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_attr</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_readahead_blks</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sbi_ui_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_attr</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ui</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">sbi</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ui</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sbi_ui_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_attr</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ui</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">sbi</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ui</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">trigger_test_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_attr</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="n">ext4_error</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sb</span><span class="p">,</span> <span class="s">&quot;%.*s&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define EXT4_ATTR_OFFSET(_name,_mode,_show,_store,_elname) \</span>
<span class="cp">static struct ext4_attr ext4_attr_##_name = {			\</span>
<span class="cp">	.attr = {.name = __stringify(_name), .mode = _mode },	\</span>
<span class="cp">	.show	= _show,					\</span>
<span class="cp">	.store	= _store,					\</span>
<span class="cp">	.offset = offsetof(struct ext4_sb_info, _elname),	\</span>
<span class="cp">}</span>
<span class="cp">#define EXT4_ATTR(name, mode, show, store) \</span>
<span class="cp">static struct ext4_attr ext4_attr_##name = __ATTR(name, mode, show, store)</span>

<span class="cp">#define EXT4_INFO_ATTR(name) EXT4_ATTR(name, 0444, NULL, NULL)</span>
<span class="cp">#define EXT4_RO_ATTR(name) EXT4_ATTR(name, 0444, name##_show, NULL)</span>
<span class="cp">#define EXT4_RW_ATTR(name) EXT4_ATTR(name, 0644, name##_show, name##_store)</span>
<span class="cp">#define EXT4_RW_ATTR_SBI_UI(name, elname)	\</span>
<span class="cp">	EXT4_ATTR_OFFSET(name, 0644, sbi_ui_show, sbi_ui_store, elname)</span>
<span class="cp">#define ATTR_LIST(name) &amp;ext4_attr_##name.attr</span>

<span class="n">EXT4_RO_ATTR</span><span class="p">(</span><span class="n">delayed_allocation_blocks</span><span class="p">);</span>
<span class="n">EXT4_RO_ATTR</span><span class="p">(</span><span class="n">session_write_kbytes</span><span class="p">);</span>
<span class="n">EXT4_RO_ATTR</span><span class="p">(</span><span class="n">lifetime_write_kbytes</span><span class="p">);</span>
<span class="n">EXT4_ATTR_OFFSET</span><span class="p">(</span><span class="n">inode_readahead_blks</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">sbi_ui_show</span><span class="p">,</span>
		 <span class="n">inode_readahead_blks_store</span><span class="p">,</span> <span class="n">s_inode_readahead_blks</span><span class="p">);</span>
<span class="n">EXT4_RW_ATTR_SBI_UI</span><span class="p">(</span><span class="n">inode_goal</span><span class="p">,</span> <span class="n">s_inode_goal</span><span class="p">);</span>
<span class="n">EXT4_RW_ATTR_SBI_UI</span><span class="p">(</span><span class="n">mb_stats</span><span class="p">,</span> <span class="n">s_mb_stats</span><span class="p">);</span>
<span class="n">EXT4_RW_ATTR_SBI_UI</span><span class="p">(</span><span class="n">mb_max_to_scan</span><span class="p">,</span> <span class="n">s_mb_max_to_scan</span><span class="p">);</span>
<span class="n">EXT4_RW_ATTR_SBI_UI</span><span class="p">(</span><span class="n">mb_min_to_scan</span><span class="p">,</span> <span class="n">s_mb_min_to_scan</span><span class="p">);</span>
<span class="n">EXT4_RW_ATTR_SBI_UI</span><span class="p">(</span><span class="n">mb_order2_req</span><span class="p">,</span> <span class="n">s_mb_order2_reqs</span><span class="p">);</span>
<span class="n">EXT4_RW_ATTR_SBI_UI</span><span class="p">(</span><span class="n">mb_stream_req</span><span class="p">,</span> <span class="n">s_mb_stream_request</span><span class="p">);</span>
<span class="n">EXT4_RW_ATTR_SBI_UI</span><span class="p">(</span><span class="n">mb_group_prealloc</span><span class="p">,</span> <span class="n">s_mb_group_prealloc</span><span class="p">);</span>
<span class="n">EXT4_RW_ATTR_SBI_UI</span><span class="p">(</span><span class="n">max_writeback_mb_bump</span><span class="p">,</span> <span class="n">s_max_writeback_mb_bump</span><span class="p">);</span>
<span class="n">EXT4_ATTR</span><span class="p">(</span><span class="n">trigger_fs_error</span><span class="p">,</span> <span class="mo">0200</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">trigger_test_error</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">ext4_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">delayed_allocation_blocks</span><span class="p">),</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">session_write_kbytes</span><span class="p">),</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">lifetime_write_kbytes</span><span class="p">),</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">inode_readahead_blks</span><span class="p">),</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">inode_goal</span><span class="p">),</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">mb_stats</span><span class="p">),</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">mb_max_to_scan</span><span class="p">),</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">mb_min_to_scan</span><span class="p">),</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">mb_order2_req</span><span class="p">),</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">mb_stream_req</span><span class="p">),</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">mb_group_prealloc</span><span class="p">),</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">max_writeback_mb_bump</span><span class="p">),</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">trigger_fs_error</span><span class="p">),</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Features this copy of ext4 supports */</span>
<span class="n">EXT4_INFO_ATTR</span><span class="p">(</span><span class="n">lazy_itable_init</span><span class="p">);</span>
<span class="n">EXT4_INFO_ATTR</span><span class="p">(</span><span class="n">batched_discard</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">ext4_feat_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">lazy_itable_init</span><span class="p">),</span>
	<span class="n">ATTR_LIST</span><span class="p">(</span><span class="n">batched_discard</span><span class="p">),</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ext4_attr_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_sb_info</span><span class="p">,</span>
						<span class="n">s_kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_attr</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_attr</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">show</span> <span class="o">?</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sbi</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ext4_attr_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_sb_info</span><span class="p">,</span>
						<span class="n">s_kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_attr</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_attr</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">store</span> <span class="o">?</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sbi</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_sb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_sb_info</span><span class="p">,</span>
						<span class="n">s_kobj</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_kobj_unregister</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sysfs_ops</span> <span class="n">ext4_attr_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">ext4_attr_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span>	<span class="o">=</span> <span class="n">ext4_attr_store</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">ext4_ktype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">default_attrs</span>	<span class="o">=</span> <span class="n">ext4_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysfs_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ext4_attr_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">ext4_sb_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_feat_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_feat</span><span class="o">-&gt;</span><span class="n">f_kobj_unregister</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">ext4_feat_ktype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">default_attrs</span>	<span class="o">=</span> <span class="n">ext4_feat_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysfs_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ext4_attr_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">ext4_feat_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Check whether this filesystem can be mounted based on</span>
<span class="cm"> * the features present and the RDONLY/RDWR mount requested.</span>
<span class="cm"> * Returns 1 if this filesystem can be mounted as requested,</span>
<span class="cm"> * 0 if it cannot be.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_feature_set_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">readonly</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="n">EXT4_FEATURE_INCOMPAT_SUPP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;Couldn&#39;t mount because of &quot;</span>
			<span class="s">&quot;unsupported optional features (%x)&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_feature_incompat</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="n">EXT4_FEATURE_INCOMPAT_SUPP</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">readonly</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Check that feature set is OK for a read-write mount */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="n">EXT4_FEATURE_RO_COMPAT_SUPP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t mount RDWR because of &quot;</span>
			 <span class="s">&quot;unsupported optional features (%x)&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_feature_ro_compat</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="n">EXT4_FEATURE_RO_COMPAT_SUPP</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Large file size enabled file system can only be mounted</span>
<span class="cm">	 * read-write on 32-bit systems if kernel is built with CONFIG_LBDAF</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_RO_COMPAT_HUGE_FILE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">blkcnt_t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Filesystem with huge files &quot;</span>
				 <span class="s">&quot;cannot be mounted RDWR without &quot;</span>
				 <span class="s">&quot;CONFIG_LBDAF&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_RO_COMPAT_BIGALLOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_EXTENTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			 <span class="s">&quot;Can&#39;t support bigalloc feature without &quot;</span>
			 <span class="s">&quot;extents feature</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called once a day if we have errors logged</span>
<span class="cm"> * on the file system</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_daily_error_info</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">;</span>

	<span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">es</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_error_count</span><span class="p">)</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="s">&quot;error count: %u&quot;</span><span class="p">,</span>
			 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_error_count</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;EXT4-fs (%s): initial error at %u: %.*s:%d&quot;</span><span class="p">,</span>
		       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_time</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_func</span><span class="p">),</span>
		       <span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_func</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_line</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_ino</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;: inode %u&quot;</span><span class="p">,</span>
			       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_ino</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_block</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;: block %llu&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			       <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_error_block</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;EXT4-fs (%s): last error at %u: %.*s:%d&quot;</span><span class="p">,</span>
		       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_time</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_func</span><span class="p">),</span>
		       <span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_func</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_line</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_ino</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;: inode %u&quot;</span><span class="p">,</span>
			       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_ino</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_block</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;: block %llu&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			       <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_error_block</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_err_report</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>  <span class="cm">/* Once a day */</span>
<span class="p">}</span>

<span class="cm">/* Find next suitable group and run ext4_init_inode_table */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_run_li_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_li_request</span> <span class="o">*</span><span class="n">elr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">gdp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">,</span> <span class="n">ngroups</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_super</span><span class="p">;</span>
	<span class="n">ngroups</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">group</span> <span class="o">=</span> <span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_next_group</span><span class="p">;</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="n">ngroups</span><span class="p">;</span> <span class="n">group</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gdp</span> <span class="o">=</span> <span class="n">ext4_get_group_desc</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_flags</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT4_BG_INODE_ZEROED</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">==</span> <span class="n">ngroups</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_init_inode_table</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span>
					    <span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_timeout</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">timeout</span><span class="p">)</span> <span class="o">*</span>
				  <span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_sbi</span><span class="o">-&gt;</span><span class="n">s_li_wait_mult</span><span class="p">;</span>
			<span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_next_sched</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_timeout</span><span class="p">;</span>
		<span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_next_group</span> <span class="o">=</span> <span class="n">group</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove lr_request from the list_request and free the</span>
<span class="cm"> * request structure. Should be called with li_list_mtx held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_remove_li_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_li_request</span> <span class="o">*</span><span class="n">elr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">elr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sbi</span> <span class="o">=</span> <span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_sbi</span><span class="p">;</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_request</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_li_request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">elr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_unregister_li_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_li_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_mtx</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_info</span><span class="o">-&gt;</span><span class="n">li_list_mtx</span><span class="p">);</span>
	<span class="n">ext4_remove_li_request</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_li_request</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_info</span><span class="o">-&gt;</span><span class="n">li_list_mtx</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">ext4_lazyinit_task</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This is the function where ext4lazyinit thread lives. It walks</span>
<span class="cm"> * through the request list searching for next scheduled filesystem.</span>
<span class="cm"> * When such a fs is found, run the lazy initialization request</span>
<span class="cm"> * (ext4_rn_li_request) and keep track of the time spend in this</span>
<span class="cm"> * function. Based on that time we compute next schedule time of</span>
<span class="cm"> * the request. When walking through the list is complete, compute</span>
<span class="cm"> * next waking time and put itself into sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_lazyinit_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_lazy_init</span> <span class="o">*</span><span class="n">eli</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext4_lazy_init</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_li_request</span> <span class="o">*</span><span class="n">elr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_wakeup</span><span class="p">,</span> <span class="n">cur</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">eli</span><span class="p">);</span>

<span class="nl">cont_thread:</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next_wakeup</span> <span class="o">=</span> <span class="n">MAX_JIFFY_OFFSET</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eli</span><span class="o">-&gt;</span><span class="n">li_list_mtx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eli</span><span class="o">-&gt;</span><span class="n">li_request_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eli</span><span class="o">-&gt;</span><span class="n">li_list_mtx</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit_thread</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eli</span><span class="o">-&gt;</span><span class="n">li_request_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">elr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_li_request</span><span class="p">,</span>
					 <span class="n">lr_request</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_next_sched</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ext4_run_li_request</span><span class="p">(</span><span class="n">elr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* error, remove the lazy_init job */</span>
					<span class="n">ext4_remove_li_request</span><span class="p">(</span><span class="n">elr</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_next_sched</span><span class="p">,</span> <span class="n">next_wakeup</span><span class="p">))</span>
				<span class="n">next_wakeup</span> <span class="o">=</span> <span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_next_sched</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eli</span><span class="o">-&gt;</span><span class="n">li_list_mtx</span><span class="p">);</span>

		<span class="n">try_to_freeze</span><span class="p">();</span>

		<span class="n">cur</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">next_wakeup</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">MAX_JIFFY_OFFSET</span> <span class="o">==</span> <span class="n">next_wakeup</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cond_resched</span><span class="p">();</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">next_wakeup</span> <span class="o">-</span> <span class="n">cur</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">ext4_clear_request_list</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">exit_thread</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">exit_thread:</span>
	<span class="cm">/*</span>
<span class="cm">	 * It looks like the request list is empty, but we need</span>
<span class="cm">	 * to check it under the li_list_mtx lock, to prevent any</span>
<span class="cm">	 * additions into it, and of course we should lock ext4_li_mtx</span>
<span class="cm">	 * to atomically free the list and ext4_li_info, because at</span>
<span class="cm">	 * this point another ext4 filesystem could be registering</span>
<span class="cm">	 * new one.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_mtx</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eli</span><span class="o">-&gt;</span><span class="n">li_list_mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eli</span><span class="o">-&gt;</span><span class="n">li_request_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eli</span><span class="o">-&gt;</span><span class="n">li_list_mtx</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_mtx</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cont_thread</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eli</span><span class="o">-&gt;</span><span class="n">li_list_mtx</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ext4_li_info</span><span class="p">);</span>
	<span class="n">ext4_li_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_clear_request_list</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_li_request</span> <span class="o">*</span><span class="n">elr</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_info</span><span class="o">-&gt;</span><span class="n">li_list_mtx</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext4_li_info</span><span class="o">-&gt;</span><span class="n">li_request_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">elr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_li_request</span><span class="p">,</span>
				 <span class="n">lr_request</span><span class="p">);</span>
		<span class="n">ext4_remove_li_request</span><span class="p">(</span><span class="n">elr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_info</span><span class="o">-&gt;</span><span class="n">li_list_mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_run_lazyinit_thread</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_lazyinit_task</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">ext4_lazyinit_thread</span><span class="p">,</span>
					 <span class="n">ext4_li_info</span><span class="p">,</span> <span class="s">&quot;ext4lazyinit&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ext4_lazyinit_task</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ext4_lazyinit_task</span><span class="p">);</span>
		<span class="n">ext4_clear_request_list</span><span class="p">();</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ext4_li_info</span><span class="p">);</span>
		<span class="n">ext4_li_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;EXT4-fs: error %d creating inode table &quot;</span>
				 <span class="s">&quot;initialization thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ext4_li_info</span><span class="o">-&gt;</span><span class="n">li_state</span> <span class="o">|=</span> <span class="n">EXT4_LAZYINIT_RUNNING</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check whether it make sense to run itable init. thread or not.</span>
<span class="cm"> * If there is at least one uninitialized inode table, return</span>
<span class="cm"> * corresponding group number, else the loop goes through all</span>
<span class="cm"> * groups and return total number of groups.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">ext4_group_t</span> <span class="nf">ext4_has_uninit_itable</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">,</span> <span class="n">ngroups</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">gdp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="n">ngroups</span><span class="p">;</span> <span class="n">group</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gdp</span> <span class="o">=</span> <span class="n">ext4_get_group_desc</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdp</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_flags</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT4_BG_INODE_ZEROED</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">group</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_li_info_new</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_lazy_init</span> <span class="o">*</span><span class="n">eli</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">eli</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eli</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eli</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eli</span><span class="o">-&gt;</span><span class="n">li_request_list</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eli</span><span class="o">-&gt;</span><span class="n">li_list_mtx</span><span class="p">);</span>

	<span class="n">eli</span><span class="o">-&gt;</span><span class="n">li_state</span> <span class="o">|=</span> <span class="n">EXT4_LAZYINIT_QUIT</span><span class="p">;</span>

	<span class="n">ext4_li_info</span> <span class="o">=</span> <span class="n">eli</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ext4_li_request</span> <span class="o">*</span><span class="nf">ext4_li_request_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
					    <span class="n">ext4_group_t</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_li_request</span> <span class="o">*</span><span class="n">elr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rnd</span><span class="p">;</span>

	<span class="n">elr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">elr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">elr</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_super</span> <span class="o">=</span> <span class="n">sb</span><span class="p">;</span>
	<span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_sbi</span> <span class="o">=</span> <span class="n">sbi</span><span class="p">;</span>
	<span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_next_group</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Randomize first schedule time of the request to</span>
<span class="cm">	 * spread the inode table initialization requests</span>
<span class="cm">	 * better.</span>
<span class="cm">	 */</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rnd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rnd</span><span class="p">));</span>
	<span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_next_sched</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rnd</span> <span class="o">%</span>
			     <span class="p">(</span><span class="n">EXT4_DEF_LI_MAX_START_DELAY</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">elr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_register_li_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				    <span class="n">ext4_group_t</span> <span class="n">first_not_zeroed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_li_request</span> <span class="o">*</span><span class="n">elr</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">ngroups</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_li_request</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Reset timeout so it can be computed again, because</span>
<span class="cm">		 * s_li_wait_mult might have changed.</span>
<span class="cm">		 */</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_li_request</span><span class="o">-&gt;</span><span class="n">lr_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first_not_zeroed</span> <span class="o">==</span> <span class="n">ngroups</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">INIT_INODE_TABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">elr</span> <span class="o">=</span> <span class="n">ext4_li_request_new</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">first_not_zeroed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">elr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">ext4_li_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_li_info_new</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_info</span><span class="o">-&gt;</span><span class="n">li_list_mtx</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">elr</span><span class="o">-&gt;</span><span class="n">lr_request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext4_li_info</span><span class="o">-&gt;</span><span class="n">li_request_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_info</span><span class="o">-&gt;</span><span class="n">li_list_mtx</span><span class="p">);</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_li_request</span> <span class="o">=</span> <span class="n">elr</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * set elr to NULL here since it has been inserted to</span>
<span class="cm">	 * the request_list and the removal and free of it is</span>
<span class="cm">	 * handled by ext4_clear_request_list from now on.</span>
<span class="cm">	 */</span>
	<span class="n">elr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ext4_li_info</span><span class="o">-&gt;</span><span class="n">li_state</span> <span class="o">&amp;</span> <span class="n">EXT4_LAZYINIT_RUNNING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_run_lazyinit_thread</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">elr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We do not need to lock anything since this is called on</span>
<span class="cm"> * module unload.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_destroy_lazyinit_thread</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If thread exited earlier</span>
<span class="cm">	 * there&#39;s nothing to be done.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_li_info</span> <span class="o">||</span> <span class="o">!</span><span class="n">ext4_lazyinit_task</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">ext4_lazyinit_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_journal_csum_feature_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">compat</span><span class="p">,</span> <span class="n">incompat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
				       <span class="n">EXT4_FEATURE_RO_COMPAT_METADATA_CSUM</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* journal checksum v2 */</span>
		<span class="n">compat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">incompat</span> <span class="o">=</span> <span class="n">JBD2_FEATURE_INCOMPAT_CSUM_V2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* journal checksum v1 */</span>
		<span class="n">compat</span> <span class="o">=</span> <span class="n">JBD2_FEATURE_COMPAT_CHECKSUM</span><span class="p">;</span>
		<span class="n">incompat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">JOURNAL_ASYNC_COMMIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">jbd2_journal_set_features</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span>
				<span class="n">compat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">JBD2_FEATURE_INCOMPAT_ASYNC_COMMIT</span> <span class="o">|</span>
				<span class="n">incompat</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">JOURNAL_CHECKSUM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">jbd2_journal_set_features</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span>
				<span class="n">compat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">incompat</span><span class="p">);</span>
		<span class="n">jbd2_journal_clear_features</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">JBD2_FEATURE_INCOMPAT_ASYNC_COMMIT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">jbd2_journal_clear_features</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span>
				<span class="n">JBD2_FEATURE_COMPAT_CHECKSUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">JBD2_FEATURE_INCOMPAT_ASYNC_COMMIT</span> <span class="o">|</span>
				<span class="n">JBD2_FEATURE_INCOMPAT_CSUM_V2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_fill_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">silent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">orig_data</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">block</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">sb_block</span> <span class="o">=</span> <span class="n">get_sb_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">logical_sb_block</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">journal_devnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">def_mount_opts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">clustersize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">db_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">needs_recovery</span><span class="p">,</span> <span class="n">has_huge_files</span><span class="p">,</span> <span class="n">has_bigalloc</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">blocks_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">journal_ioprio</span> <span class="o">=</span> <span class="n">DEFAULT_JOURNAL_IOPRIO</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">first_not_zeroed</span><span class="p">;</span>

	<span class="n">sbi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sbi</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_orig</span><span class="p">;</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blockgroup_lock</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">blockgroup_lock</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blockgroup_lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_orig</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="n">sbi</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sb</span> <span class="o">=</span> <span class="n">sb</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resuid</span> <span class="o">=</span> <span class="n">make_kuid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">EXT4_DEF_RESUID</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resgid</span> <span class="o">=</span> <span class="n">make_kgid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">EXT4_DEF_RESGID</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_readahead_blks</span> <span class="o">=</span> <span class="n">EXT4_DEF_INODE_READAHEAD_BLKS</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sb_block</span> <span class="o">=</span> <span class="n">sb_block</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_part</span><span class="p">)</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sectors_written_start</span> <span class="o">=</span>
			<span class="n">part_stat_read</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_part</span><span class="p">,</span> <span class="n">sectors</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* Cleanup superblock name */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cp</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">;</span> <span class="p">(</span><span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">));)</span>
		<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="sc">&#39;!&#39;</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">blocksize</span> <span class="o">=</span> <span class="n">sb_min_blocksize</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_MIN_BLOCK_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blocksize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;unable to set blocksize&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The ext4 superblock will not be buffer aligned for other than 1kB</span>
<span class="cm">	 * block sizes.  We need to calculate the offset from buffer start.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blocksize</span> <span class="o">!=</span> <span class="n">EXT4_MIN_BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">logical_sb_block</span> <span class="o">=</span> <span class="n">sb_block</span> <span class="o">*</span> <span class="n">EXT4_MIN_BLOCK_SIZE</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">logical_sb_block</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">logical_sb_block</span> <span class="o">=</span> <span class="n">sb_block</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bh</span> <span class="o">=</span> <span class="n">sb_bread</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">logical_sb_block</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;unable to read superblock&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Note: s_es must be initialized as soon as possible because</span>
<span class="cm">	 *       some ext4 macro-instructions depend on its value</span>
<span class="cm">	 */</span>
	<span class="n">es</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span> <span class="o">=</span> <span class="n">es</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_magic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">!=</span> <span class="n">EXT4_SUPER_MAGIC</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cantfind_ext4</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_kbytes_written</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_kbytes_written</span><span class="p">);</span>

	<span class="cm">/* Warn if metadata_csum and gdt_csum are both set. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
				       <span class="n">EXT4_FEATURE_RO_COMPAT_METADATA_CSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_RO_COMPAT_GDT_CSUM</span><span class="p">))</span>
		<span class="n">ext4_warning</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;metadata_csum and uninit_bg are &quot;</span>
			     <span class="s">&quot;redundant flags; please run fsck.&quot;</span><span class="p">);</span>

	<span class="cm">/* Check for a known checksum algorithm */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_verify_csum_type</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;VFS: Found ext4 filesystem with &quot;</span>
			 <span class="s">&quot;unknown checksum algorithm.&quot;</span><span class="p">);</span>
		<span class="n">silent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cantfind_ext4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Load the checksum driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
				       <span class="n">EXT4_FEATURE_RO_COMPAT_METADATA_CSUM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_chksum_driver</span> <span class="o">=</span> <span class="n">crypto_alloc_shash</span><span class="p">(</span><span class="s">&quot;crc32c&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_chksum_driver</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Cannot load crc32c driver.&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_chksum_driver</span><span class="p">);</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_chksum_driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check superblock checksum */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_superblock_csum_verify</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;VFS: Found ext4 filesystem with &quot;</span>
			 <span class="s">&quot;invalid superblock checksum.  Run e2fsck?&quot;</span><span class="p">);</span>
		<span class="n">silent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cantfind_ext4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Precompute checksum seed for all metadata */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
			<span class="n">EXT4_FEATURE_RO_COMPAT_METADATA_CSUM</span><span class="p">))</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_csum_seed</span> <span class="o">=</span> <span class="n">ext4_chksum</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">,</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">));</span>

	<span class="cm">/* Set defaults before we parse the mount options */</span>
	<span class="n">def_mount_opts</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_default_mount_opts</span><span class="p">);</span>
	<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">INIT_INODE_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT4_DEFM_DEBUG</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DEBUG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT4_DEFM_BSDGROUPS</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">GRPID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT4_DEFM_UID16</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">NO_UID32</span><span class="p">);</span>
	<span class="cm">/* xattr user namespace &amp; acls are now defaulted on */</span>
<span class="cp">#ifdef CONFIG_EXT4_FS_XATTR</span>
	<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">XATTR_USER</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_EXT4_FS_POSIX_ACL</span>
	<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">POSIX_ACL</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">MBLK_IO_SUBMIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT4_DEFM_JMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT4_DEFM_JMODE_DATA</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">JOURNAL_DATA</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT4_DEFM_JMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT4_DEFM_JMODE_ORDERED</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ORDERED_DATA</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT4_DEFM_JMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT4_DEFM_JMODE_WBACK</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">WRITEBACK_DATA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_errors</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT4_ERRORS_PANIC</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_PANIC</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_errors</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT4_ERRORS_CONTINUE</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_CONT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_RO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT4_DEFM_BLOCK_VALIDITY</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">BLOCK_VALIDITY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT4_DEFM_DISCARD</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DISCARD</span><span class="p">);</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resuid</span> <span class="o">=</span> <span class="n">make_kuid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_def_resuid</span><span class="p">));</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resgid</span> <span class="o">=</span> <span class="n">make_kgid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_def_resgid</span><span class="p">));</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_commit_interval</span> <span class="o">=</span> <span class="n">JBD2_DEFAULT_MAX_COMMIT_AGE</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_min_batch_time</span> <span class="o">=</span> <span class="n">EXT4_DEF_MIN_BATCH_TIME</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_max_batch_time</span> <span class="o">=</span> <span class="n">EXT4_DEF_MAX_BATCH_TIME</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT4_DEFM_NOBARRIER</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">BARRIER</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * enable delayed allocation by default</span>
<span class="cm">	 * Use -o nodelalloc to turn it off</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT4_DEFM_NODELALLOC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DELALLOC</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set default s_li_wait_mult for lazyinit, for the case there is</span>
<span class="cm">	 * no mount option specified.</span>
<span class="cm">	 */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_li_wait_mult</span> <span class="o">=</span> <span class="n">EXT4_DEF_LI_WAIT_MULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parse_options</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_mount_opts</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">journal_devnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">journal_ioprio</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
			 <span class="s">&quot;failed to parse options in superblock: %s&quot;</span><span class="p">,</span>
			 <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_mount_opts</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_def_mount_opt</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parse_options</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">journal_devnum</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">journal_ioprio</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_FLAGS</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT4_MOUNT_JOURNAL_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk_once</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;EXT4-fs: Warning: mounting &quot;</span>
			    <span class="s">&quot;with data=journal disables delayed &quot;</span>
			    <span class="s">&quot;allocation and O_DIRECT support!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_opt2</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXPLICIT_DELALLOC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;can&#39;t mount with &quot;</span>
				 <span class="s">&quot;both data=journal and delalloc&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DIOREAD_NOLOCK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;can&#39;t mount with &quot;</span>
				 <span class="s">&quot;both data=journal and delalloc&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DELALLOC</span><span class="p">))</span>
			<span class="n">clear_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DELALLOC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">blocksize</span> <span class="o">=</span> <span class="n">BLOCK_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_log_block_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DIOREAD_NOLOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blocksize</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;can&#39;t mount with &quot;</span>
				 <span class="s">&quot;dioread_nolock if block size != PAGE_SIZE&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MS_POSIXACL</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">POSIX_ACL</span><span class="p">)</span> <span class="o">?</span> <span class="n">MS_POSIXACL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_rev_level</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT4_GOOD_OLD_REV</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">EXT4_HAS_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="mi">0U</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="mi">0U</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="mi">0U</span><span class="p">)))</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
		       <span class="s">&quot;feature flags set on rev 0 fs, &quot;</span>
		       <span class="s">&quot;running e2fsck is recommended&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_EXT2_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext2_feature_set_ok</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;mounting ext2 file system &quot;</span>
				 <span class="s">&quot;using the ext4 subsystem&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t mount as ext2 due &quot;</span>
				 <span class="s">&quot;to feature incompatibilities&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext3_feature_set_ok</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;mounting ext3 file system &quot;</span>
				 <span class="s">&quot;using the ext4 subsystem&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t mount as ext3 due &quot;</span>
				 <span class="s">&quot;to feature incompatibilities&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check feature flags regardless of the revision level, since we</span>
<span class="cm">	 * previously didn&#39;t change the revision level when setting the flags,</span>
<span class="cm">	 * so there is a chance incompat flags are set on a rev 0 filesystem.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_feature_set_ok</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blocksize</span> <span class="o">&lt;</span> <span class="n">EXT4_MIN_BLOCK_SIZE</span> <span class="o">||</span>
	    <span class="n">blocksize</span> <span class="o">&gt;</span> <span class="n">EXT4_MAX_BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
		       <span class="s">&quot;Unsupported filesystem blocksize %d&quot;</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">!=</span> <span class="n">blocksize</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Validate the filesystem blocksize */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_set_blocksize</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;bad block size %d&quot;</span><span class="p">,</span>
					<span class="n">blocksize</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">logical_sb_block</span> <span class="o">=</span> <span class="n">sb_block</span> <span class="o">*</span> <span class="n">EXT4_MIN_BLOCK_SIZE</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">logical_sb_block</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">sb_bread</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">logical_sb_block</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			       <span class="s">&quot;Can&#39;t read superblock on 2nd try&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">es</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="p">)(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span> <span class="o">=</span> <span class="n">es</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT4_SUPER_MAGIC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			       <span class="s">&quot;Magic mismatch, very weird!&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">has_huge_files</span> <span class="o">=</span> <span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
				<span class="n">EXT4_FEATURE_RO_COMPAT_HUGE_FILE</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bitmap_maxbytes</span> <span class="o">=</span> <span class="n">ext4_max_bitmap_size</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">,</span>
						      <span class="n">has_huge_files</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_maxbytes</span> <span class="o">=</span> <span class="n">ext4_max_size</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">,</span> <span class="n">has_huge_files</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_rev_level</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT4_GOOD_OLD_REV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span> <span class="o">=</span> <span class="n">EXT4_GOOD_OLD_INODE_SIZE</span><span class="p">;</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_first_ino</span> <span class="o">=</span> <span class="n">EXT4_GOOD_OLD_FIRST_INO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_inode_size</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_first_ino</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_ino</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span> <span class="o">&lt;</span> <span class="n">EXT4_GOOD_OLD_INODE_SIZE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span> <span class="o">&gt;</span> <span class="n">blocksize</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			       <span class="s">&quot;unsupported inode size: %d&quot;</span><span class="p">,</span>
			       <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span> <span class="o">&gt;</span> <span class="n">EXT4_GOOD_OLD_INODE_SIZE</span><span class="p">)</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_time_gran</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">EXT4_EPOCH_BITS</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_desc_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_desc_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_64BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_desc_size</span> <span class="o">&lt;</span> <span class="n">EXT4_MIN_DESC_SIZE_64BIT</span> <span class="o">||</span>
		    <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_desc_size</span> <span class="o">&gt;</span> <span class="n">EXT4_MAX_DESC_SIZE</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_desc_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			       <span class="s">&quot;unsupported descriptor size %lu&quot;</span><span class="p">,</span>
			       <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_desc_size</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_desc_size</span> <span class="o">=</span> <span class="n">EXT4_MIN_DESC_SIZE</span><span class="p">;</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_per_group</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_blocks_per_group</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inodes_per_group</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_inodes_per_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_INODE_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">EXT4_INODES_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cantfind_ext4</span><span class="p">;</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inodes_per_block</span> <span class="o">=</span> <span class="n">blocksize</span> <span class="o">/</span> <span class="n">EXT4_INODE_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inodes_per_block</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cantfind_ext4</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_itb_per_group</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inodes_per_group</span> <span class="o">/</span>
					<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inodes_per_block</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_desc_per_block</span> <span class="o">=</span> <span class="n">blocksize</span> <span class="o">/</span> <span class="n">EXT4_DESC_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sbh</span> <span class="o">=</span> <span class="n">bh</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_addr_per_block_bits</span> <span class="o">=</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">EXT4_ADDR_PER_BLOCK</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_desc_per_block_bits</span> <span class="o">=</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">EXT4_DESC_PER_BLOCK</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_hash_seed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_hash_seed</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_def_hash_version</span> <span class="o">=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">s_def_hash_version</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">EXT2_FLAGS_UNSIGNED_HASH</span><span class="p">)</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_hash_unsigned</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">EXT2_FLAGS_SIGNED_HASH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef __CHAR_UNSIGNED__</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">EXT2_FLAGS_UNSIGNED_HASH</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_hash_unsigned</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">EXT2_FLAGS_SIGNED_HASH</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Handle clustersize */</span>
	<span class="n">clustersize</span> <span class="o">=</span> <span class="n">BLOCK_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_log_cluster_size</span><span class="p">);</span>
	<span class="n">has_bigalloc</span> <span class="o">=</span> <span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
				<span class="n">EXT4_FEATURE_RO_COMPAT_BIGALLOC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_bigalloc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clustersize</span> <span class="o">&lt;</span> <span class="n">blocksize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				 <span class="s">&quot;cluster size (%d) smaller than &quot;</span>
				 <span class="s">&quot;block size (%d)&quot;</span><span class="p">,</span> <span class="n">clustersize</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_cluster_bits</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_log_cluster_size</span><span class="p">)</span> <span class="o">-</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_log_block_size</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_clusters_per_group</span> <span class="o">=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_clusters_per_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_clusters_per_group</span> <span class="o">&gt;</span> <span class="n">blocksize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				 <span class="s">&quot;#clusters per group too big: %lu&quot;</span><span class="p">,</span>
				 <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_clusters_per_group</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_per_group</span> <span class="o">!=</span>
		    <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_clusters_per_group</span> <span class="o">*</span> <span class="p">(</span><span class="n">clustersize</span> <span class="o">/</span> <span class="n">blocksize</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;blocks per group (%lu) and &quot;</span>
				 <span class="s">&quot;clusters per group (%lu) inconsistent&quot;</span><span class="p">,</span>
				 <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_per_group</span><span class="p">,</span>
				 <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_clusters_per_group</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clustersize</span> <span class="o">!=</span> <span class="n">blocksize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_warning</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;fragment/cluster size (%d) != &quot;</span>
				     <span class="s">&quot;block size (%d)&quot;</span><span class="p">,</span> <span class="n">clustersize</span><span class="p">,</span>
				     <span class="n">blocksize</span><span class="p">);</span>
			<span class="n">clustersize</span> <span class="o">=</span> <span class="n">blocksize</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_per_group</span> <span class="o">&gt;</span> <span class="n">blocksize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				 <span class="s">&quot;#blocks per group too big: %lu&quot;</span><span class="p">,</span>
				 <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_per_group</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_clusters_per_group</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_per_group</span><span class="p">;</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_cluster_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_cluster_ratio</span> <span class="o">=</span> <span class="n">clustersize</span> <span class="o">/</span> <span class="n">blocksize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inodes_per_group</span> <span class="o">&gt;</span> <span class="n">blocksize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
		       <span class="s">&quot;#inodes per group too big: %lu&quot;</span><span class="p">,</span>
		       <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inodes_per_group</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Test whether we have more sectors than will fit in sector_t,</span>
<span class="cm">	 * and whether the max offset is addressable by the page cache.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">generic_check_addressable</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">,</span>
					<span class="n">ext4_blocks_count</span><span class="p">(</span><span class="n">es</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;filesystem&quot;</span>
			 <span class="s">&quot; too large to mount safely on this system&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sector_t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;CONFIG_LBDAF not enabled&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cantfind_ext4</span><span class="p">;</span>

	<span class="cm">/* check blocks count against device size */</span>
	<span class="n">blocks_count</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&gt;&gt;</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blocks_count</span> <span class="o">&amp;&amp;</span> <span class="n">ext4_blocks_count</span><span class="p">(</span><span class="n">es</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">blocks_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;bad geometry: block count %llu &quot;</span>
		       <span class="s">&quot;exceeds size of device (%llu blocks)&quot;</span><span class="p">,</span>
		       <span class="n">ext4_blocks_count</span><span class="p">(</span><span class="n">es</span><span class="p">),</span> <span class="n">blocks_count</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * It makes no sense for the first data block to be beyond the end</span>
<span class="cm">	 * of the filesystem.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_data_block</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ext4_blocks_count</span><span class="p">(</span><span class="n">es</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;bad geometry: first data &quot;</span>
			 <span class="s">&quot;block %u is beyond end of filesystem (%llu)&quot;</span><span class="p">,</span>
			 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_data_block</span><span class="p">),</span>
			 <span class="n">ext4_blocks_count</span><span class="p">(</span><span class="n">es</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">blocks_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">ext4_blocks_count</span><span class="p">(</span><span class="n">es</span><span class="p">)</span> <span class="o">-</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_data_block</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">EXT4_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">blocks_count</span><span class="p">,</span> <span class="n">EXT4_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blocks_count</span> <span class="o">&gt;</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="n">EXT4_DESC_PER_BLOCK</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;groups count too large: %u &quot;</span>
		       <span class="s">&quot;(block count %llu, first data block %u, &quot;</span>
		       <span class="s">&quot;blocks per group %lu)&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">,</span>
		       <span class="n">ext4_blocks_count</span><span class="p">(</span><span class="n">es</span><span class="p">),</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_data_block</span><span class="p">),</span>
		       <span class="n">EXT4_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span> <span class="o">=</span> <span class="n">blocks_count</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blockfile_groups</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">ext4_group_t</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">,</span>
			<span class="p">(</span><span class="n">EXT4_MAX_BLOCK_FILE_PHYS</span> <span class="o">/</span> <span class="n">EXT4_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)));</span>
	<span class="n">db_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span> <span class="o">+</span> <span class="n">EXT4_DESC_PER_BLOCK</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span>
		   <span class="n">EXT4_DESC_PER_BLOCK</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span> <span class="o">=</span> <span class="n">ext4_kvmalloc</span><span class="p">(</span><span class="n">db_count</span> <span class="o">*</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="p">),</span>
					  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;not enough memory&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext4_proc_root</span><span class="p">)</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_proc</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">ext4_proc_root</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_proc</span><span class="p">)</span>
		<span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;options&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_proc</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">ext4_seq_options_fops</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>

	<span class="n">bgl_lock_init</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blockgroup_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">db_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">descriptor_loc</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">logical_sb_block</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sb_bread</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			       <span class="s">&quot;can&#39;t read group descriptor %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">db_count</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">failed_mount2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_check_descriptors</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first_not_zeroed</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;group descriptors corrupted!&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_FLEX_BG</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_fill_flex_info</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			       <span class="s">&quot;unable to initialize &quot;</span>
			       <span class="s">&quot;flex_bg meta info!&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount2</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_gdb_count</span> <span class="o">=</span> <span class="n">db_count</span><span class="p">;</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_next_generation</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_next_gen_lock</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_err_report</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_err_report</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">print_daily_error_info</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_err_report</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sb</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">percpu_counter_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeclusters_counter</span><span class="p">,</span>
			<span class="n">ext4_count_free_clusters</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">percpu_counter_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeinodes_counter</span><span class="p">,</span>
				<span class="n">ext4_count_free_inodes</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">percpu_counter_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirs_counter</span><span class="p">,</span>
				<span class="n">ext4_count_dirs</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">percpu_counter_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirtyclusters_counter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;insufficient memory&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_mount3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span> <span class="o">=</span> <span class="n">ext4_get_stripe_size</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_max_writeback_mb_bump</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set up enough so that it can read an inode</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">NOLOAD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">EXT4_HAS_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_COMPAT_HAS_JOURNAL</span><span class="p">))</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ext4_sops</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ext4_nojournal_sops</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_export_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ext4_export_ops</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_xattr</span> <span class="o">=</span> <span class="n">ext4_xattr_handlers</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_qcop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ext4_qctl_operations</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">dq_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ext4_quota_operations</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">));</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_orphan</span><span class="p">);</span> <span class="cm">/* unlinked but open files */</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_orphan_lock</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resize_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">needs_recovery</span> <span class="o">=</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
			  <span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
				    <span class="n">EXT4_FEATURE_INCOMPAT_RECOVER</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_MMP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext4_multi_mount_protect</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_mmp_block</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">failed_mount3</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The first inode we look at is the journal inode.  Don&#39;t try</span>
<span class="cm">	 * root first: it may be modified in the journal!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">NOLOAD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">EXT4_HAS_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_COMPAT_HAS_JOURNAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext4_load_journal</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">journal_devnum</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">failed_mount3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">NOLOAD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_RECOVER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;required journal recovery &quot;</span>
		       <span class="s">&quot;suppressed and not mounted read-only&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount_wq</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clear_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_FLAGS</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">needs_recovery</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_journal</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_64BIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">jbd2_journal_set_features</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">JBD2_FEATURE_INCOMPAT_64BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Failed to set 64-bit journal feature&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount_wq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_journal_csum_feature_set</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Failed to set journal checksum &quot;</span>
			 <span class="s">&quot;feature set&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount_wq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We have now updated the journal if required, so we can</span>
<span class="cm">	 * validate the data journaling mode. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_FLAGS</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* No mode set, assume a default based on the journal</span>
<span class="cm">		 * capabilities: ORDERED_DATA if the journal can</span>
<span class="cm">		 * cope, else JOURNAL_DATA</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jbd2_journal_check_available_features</span>
		    <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">JBD2_FEATURE_INCOMPAT_REVOKE</span><span class="p">))</span>
			<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ORDERED_DATA</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">JOURNAL_DATA</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EXT4_MOUNT_ORDERED_DATA</span>:
	<span class="k">case</span> <span class="n">EXT4_MOUNT_WRITEBACK_DATA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jbd2_journal_check_available_features</span>
		    <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">JBD2_FEATURE_INCOMPAT_REVOKE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Journal does not support &quot;</span>
			       <span class="s">&quot;requested data journaling mode&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount_wq</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_task_ioprio</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="o">-&gt;</span><span class="n">j_task</span><span class="p">,</span> <span class="n">journal_ioprio</span><span class="p">);</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="o">-&gt;</span><span class="n">j_commit_callback</span> <span class="o">=</span> <span class="n">ext4_journal_commit_callback</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The journal may have updated the bg summary counts, so we</span>
<span class="cm">	 * need to update the global counters.</span>
<span class="cm">	 */</span>
	<span class="n">percpu_counter_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeclusters_counter</span><span class="p">,</span>
			   <span class="n">ext4_count_free_clusters</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="n">percpu_counter_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeinodes_counter</span><span class="p">,</span>
			   <span class="n">ext4_count_free_inodes</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="n">percpu_counter_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirs_counter</span><span class="p">,</span>
			   <span class="n">ext4_count_dirs</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="n">percpu_counter_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirtyclusters_counter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">no_journal:</span>
	<span class="cm">/*</span>
<span class="cm">	 * The maximum number of concurrent works can be high and</span>
<span class="cm">	 * concurrency isn&#39;t really necessary.  Limit it to 1.</span>
<span class="cm">	 */</span>
	<span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_unwritten_wq</span> <span class="o">=</span>
		<span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;ext4-dio-unwritten&quot;</span><span class="p">,</span> <span class="n">WQ_MEM_RECLAIM</span> <span class="o">|</span> <span class="n">WQ_UNBOUND</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_unwritten_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;EXT4-fs: failed to create DIO workqueue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount_wq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The jbd2_journal_load will have done any necessary log recovery,</span>
<span class="cm">	 * so we can safely mount the rest of the filesystem now.</span>
<span class="cm">	 */</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">ext4_iget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_ROOT_INO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">root</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;get root inode failed&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="n">root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_mount4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">i_blocks</span> <span class="o">||</span> <span class="o">!</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;corrupt root inode, run e2fsck&quot;</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="n">d_make_root</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;get root dentry failed&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_mount4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext4_setup_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>

	<span class="cm">/* determine the minimum size of new large inodes, if present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span> <span class="o">&gt;</span> <span class="n">EXT4_GOOD_OLD_INODE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_want_extra_isize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_inode</span><span class="p">)</span> <span class="o">-</span>
						     <span class="n">EXT4_GOOD_OLD_INODE_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
				       <span class="n">EXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_want_extra_isize</span> <span class="o">&lt;</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_want_extra_isize</span><span class="p">))</span>
				<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_want_extra_isize</span> <span class="o">=</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_want_extra_isize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_want_extra_isize</span> <span class="o">&lt;</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_min_extra_isize</span><span class="p">))</span>
				<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_want_extra_isize</span> <span class="o">=</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_min_extra_isize</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Check if enough inode space is available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_GOOD_OLD_INODE_SIZE</span> <span class="o">+</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_want_extra_isize</span> <span class="o">&gt;</span>
							<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_want_extra_isize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_inode</span><span class="p">)</span> <span class="o">-</span>
						       <span class="n">EXT4_GOOD_OLD_INODE_SIZE</span><span class="p">;</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;required extra inode space not&quot;</span>
			 <span class="s">&quot;available&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_setup_system_zone</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;failed to initialize system &quot;</span>
			 <span class="s">&quot;zone (%d)&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount4a</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ext4_ext_init</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_mb_init</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;failed to initialize mballoc (%d)&quot;</span><span class="p">,</span>
			 <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_register_li_request</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">first_not_zeroed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_mount6</span><span class="p">;</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_kobj</span><span class="p">.</span><span class="n">kset</span> <span class="o">=</span> <span class="n">ext4_kset</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_kobj_unregister</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">kobject_init_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext4_ktype</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_mount7</span><span class="p">;</span>

	<span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">|=</span> <span class="n">EXT4_ORPHAN_FS</span><span class="p">;</span>
	<span class="n">ext4_orphan_cleanup</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
	<span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EXT4_ORPHAN_FS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">needs_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;recovery complete&quot;</span><span class="p">);</span>
		<span class="n">ext4_mark_recovery_complete</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_FLAGS</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT4_MOUNT_JOURNAL_DATA</span><span class="p">)</span>
			<span class="n">descr</span> <span class="o">=</span> <span class="s">&quot; journalled data mode&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_FLAGS</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT4_MOUNT_ORDERED_DATA</span><span class="p">)</span>
			<span class="n">descr</span> <span class="o">=</span> <span class="s">&quot; ordered data mode&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">descr</span> <span class="o">=</span> <span class="s">&quot; writeback data mode&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">descr</span> <span class="o">=</span> <span class="s">&quot;out journal&quot;</span><span class="p">;</span>

	<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;mounted filesystem with%s. &quot;</span>
		 <span class="s">&quot;Opts: %s%s%s&quot;</span><span class="p">,</span> <span class="n">descr</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_mount_opts</span><span class="p">,</span>
		 <span class="o">*</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_mount_opts</span> <span class="o">?</span> <span class="s">&quot;; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">orig_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_error_count</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_err_report</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">300</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span> <span class="cm">/* 5 minutes */</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">orig_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cantfind_ext4:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;VFS: Can&#39;t find ext4 filesystem&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>

<span class="nl">failed_mount7:</span>
	<span class="n">ext4_unregister_li_request</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="nl">failed_mount6:</span>
	<span class="n">ext4_mb_release</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="nl">failed_mount5:</span>
	<span class="n">ext4_ext_release</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">ext4_release_system_zone</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="nl">failed_mount4a:</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">failed_mount4:</span>
	<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;mount failed&quot;</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_unwritten_wq</span><span class="p">);</span>
<span class="nl">failed_mount_wq:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jbd2_journal_destroy</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">failed_mount3:</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_err_report</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_flex_groups</span><span class="p">)</span>
		<span class="n">ext4_kvfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_flex_groups</span><span class="p">);</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeclusters_counter</span><span class="p">);</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeinodes_counter</span><span class="p">);</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirs_counter</span><span class="p">);</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirtyclusters_counter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mmp_tsk</span><span class="p">)</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mmp_tsk</span><span class="p">);</span>
<span class="nl">failed_mount2:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">db_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">ext4_kvfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span><span class="p">);</span>
<span class="nl">failed_mount:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_chksum_driver</span><span class="p">)</span>
		<span class="n">crypto_free_shash</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_chksum_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_proc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;options&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_proc</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">ext4_proc_root</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="n">ext4_blkdev_remove</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
<span class="nl">out_fail:</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blockgroup_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
<span class="nl">out_free_orig:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">orig_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup any per-fs journal parameters now.  We&#39;ll do this both on</span>
<span class="cm"> * initial mount, once the journal has been initialised but before we&#39;ve</span>
<span class="cm"> * done any recovery; and again on any subsequent remount.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_init_journal_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_commit_interval</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_commit_interval</span><span class="p">;</span>
	<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_min_batch_time</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_min_batch_time</span><span class="p">;</span>
	<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_max_batch_time</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_max_batch_time</span><span class="p">;</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_state_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">BARRIER</span><span class="p">))</span>
		<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_flags</span> <span class="o">|=</span> <span class="n">JBD2_BARRIER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">JBD2_BARRIER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_ERR_ABORT</span><span class="p">))</span>
		<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_flags</span> <span class="o">|=</span> <span class="n">JBD2_ABORT_ON_SYNCDATA_ERR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">JBD2_ABORT_ON_SYNCDATA_ERR</span><span class="p">;</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_state_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">journal_t</span> <span class="o">*</span><span class="nf">ext4_get_journal</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">journal_inum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">journal_inode</span><span class="p">;</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">EXT4_HAS_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_COMPAT_HAS_JOURNAL</span><span class="p">));</span>

	<span class="cm">/* First, test for the existence of a valid inode on disk.  Bad</span>
<span class="cm">	 * things happen if we iget() an unused inode, as the subsequent</span>
<span class="cm">	 * iput() will try to delete it. */</span>

	<span class="n">journal_inode</span> <span class="o">=</span> <span class="n">ext4_iget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">journal_inum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">journal_inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;no journal found&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">journal_inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">make_bad_inode</span><span class="p">(</span><span class="n">journal_inode</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">journal_inode</span><span class="p">);</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;journal inode is deleted&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">jbd_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Journal inode found at %p: %lld bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">journal_inode</span><span class="p">,</span> <span class="n">journal_inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">journal_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;invalid journal inode&quot;</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">journal_inode</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">journal</span> <span class="o">=</span> <span class="n">jbd2_journal_init_inode</span><span class="p">(</span><span class="n">journal_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">journal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Could not load journal inode&quot;</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">journal_inode</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_private</span> <span class="o">=</span> <span class="n">sb</span><span class="p">;</span>
	<span class="n">ext4_init_journal_params</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">journal</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">journal</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">journal_t</span> <span class="o">*</span><span class="nf">ext4_get_dev_journal</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				       <span class="n">dev_t</span> <span class="n">j_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hblock</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">sb_block</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">EXT4_HAS_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_COMPAT_HAS_JOURNAL</span><span class="p">));</span>

	<span class="n">bdev</span> <span class="o">=</span> <span class="n">ext4_blkdev_get</span><span class="p">(</span><span class="n">j_dev</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">blocksize</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="n">hblock</span> <span class="o">=</span> <span class="n">bdev_logical_block_size</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blocksize</span> <span class="o">&lt;</span> <span class="n">hblock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;blocksize too small for journal device&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_bdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sb_block</span> <span class="o">=</span> <span class="n">EXT4_MIN_BLOCK_SIZE</span> <span class="o">/</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">EXT4_MIN_BLOCK_SIZE</span> <span class="o">%</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="n">set_blocksize</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bh</span> <span class="o">=</span> <span class="n">__bread</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">sb_block</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t read superblock of &quot;</span>
		       <span class="s">&quot;external journal&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_bdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">es</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_magic</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EXT4_SUPER_MAGIC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_feature_incompat</span><span class="p">)</span> <span class="o">&amp;</span>
	      <span class="n">EXT4_FEATURE_INCOMPAT_JOURNAL_DEV</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;external journal has &quot;</span>
					<span class="s">&quot;bad superblock&quot;</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_bdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_journal_uuid</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;journal UUID does not match&quot;</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_bdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">ext4_blocks_count</span><span class="p">(</span><span class="n">es</span><span class="p">);</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">sb_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>	<span class="cm">/* we&#39;re done with the superblock */</span>

	<span class="n">journal</span> <span class="o">=</span> <span class="n">jbd2_journal_init_dev</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">,</span>
					<span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">journal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;failed to create device journal&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_bdev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_private</span> <span class="o">=</span> <span class="n">sb</span><span class="p">;</span>
	<span class="n">ll_rw_block</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_sb_buffer</span><span class="p">);</span>
	<span class="n">wait_on_buffer</span><span class="p">(</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_sb_buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_uptodate</span><span class="p">(</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_sb_buffer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;I/O error on journal device&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_journal</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_superblock</span><span class="o">-&gt;</span><span class="n">s_nr_users</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;External journal has more than one &quot;</span>
					<span class="s">&quot;user (unsupported) - %d&quot;</span><span class="p">,</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_superblock</span><span class="o">-&gt;</span><span class="n">s_nr_users</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_journal</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">journal_bdev</span> <span class="o">=</span> <span class="n">bdev</span><span class="p">;</span>
	<span class="n">ext4_init_journal_params</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">journal</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">journal</span><span class="p">;</span>

<span class="nl">out_journal:</span>
	<span class="n">jbd2_journal_destroy</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
<span class="nl">out_bdev:</span>
	<span class="n">ext4_blkdev_put</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_load_journal</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">journal_devnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">journal_inum</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_journal_inum</span><span class="p">);</span>
	<span class="n">dev_t</span> <span class="n">journal_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">really_read_only</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">EXT4_HAS_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_COMPAT_HAS_JOURNAL</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">journal_devnum</span> <span class="o">&amp;&amp;</span>
	    <span class="n">journal_devnum</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_journal_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;external journal device major/minor &quot;</span>
			<span class="s">&quot;numbers have changed&quot;</span><span class="p">);</span>
		<span class="n">journal_dev</span> <span class="o">=</span> <span class="n">new_decode_dev</span><span class="p">(</span><span class="n">journal_devnum</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">journal_dev</span> <span class="o">=</span> <span class="n">new_decode_dev</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_journal_dev</span><span class="p">));</span>

	<span class="n">really_read_only</span> <span class="o">=</span> <span class="n">bdev_read_only</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Are we loading a blank journal or performing recovery after a</span>
<span class="cm">	 * crash?  For recovery, we need to check in advance whether we</span>
<span class="cm">	 * can get read-write access to the device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_RECOVER</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;INFO: recovery &quot;</span>
					<span class="s">&quot;required on readonly filesystem&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">really_read_only</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;write access &quot;</span>
					<span class="s">&quot;unavailable, cannot proceed&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;write access will &quot;</span>
			       <span class="s">&quot;be enabled during recovery&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">journal_inum</span> <span class="o">&amp;&amp;</span> <span class="n">journal_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;filesystem has both journal &quot;</span>
		       <span class="s">&quot;and inode journals!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">journal_inum</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">journal</span> <span class="o">=</span> <span class="n">ext4_get_journal</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">journal_inum</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">journal</span> <span class="o">=</span> <span class="n">ext4_get_dev_journal</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">journal_dev</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_flags</span> <span class="o">&amp;</span> <span class="n">JBD2_BARRIER</span><span class="p">))</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;barriers disabled&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_RECOVER</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">jbd2_journal_wipe</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="o">!</span><span class="n">really_read_only</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">save</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">EXT4_S_ERR_LEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">save</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">es</span><span class="p">)</span> <span class="o">+</span>
			       <span class="n">EXT4_S_ERR_START</span><span class="p">,</span> <span class="n">EXT4_S_ERR_LEN</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">jbd2_journal_load</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">save</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">es</span><span class="p">)</span> <span class="o">+</span> <span class="n">EXT4_S_ERR_START</span><span class="p">,</span>
			       <span class="n">save</span><span class="p">,</span> <span class="n">EXT4_S_ERR_LEN</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">save</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error loading journal&quot;</span><span class="p">);</span>
		<span class="n">jbd2_journal_destroy</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span> <span class="o">=</span> <span class="n">journal</span><span class="p">;</span>
	<span class="n">ext4_clear_journal_err</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">really_read_only</span> <span class="o">&amp;&amp;</span> <span class="n">journal_devnum</span> <span class="o">&amp;&amp;</span>
	    <span class="n">journal_devnum</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_journal_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_journal_dev</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">journal_devnum</span><span class="p">);</span>

		<span class="cm">/* Make sure we flush the recovery flag to disk. */</span>
		<span class="n">ext4_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_commit_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">sbh</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_sbh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbh</span> <span class="o">||</span> <span class="n">block_device_ejected</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_write_io_error</span><span class="p">(</span><span class="n">sbh</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Oh, dear.  A previous attempt to write the</span>
<span class="cm">		 * superblock failed.  This could happen because the</span>
<span class="cm">		 * USB device was yanked out.  Or it could happen to</span>
<span class="cm">		 * be a transient write error and maybe the block will</span>
<span class="cm">		 * be remapped.  Nothing we can do but to retry the</span>
<span class="cm">		 * write and hope for the best.</span>
<span class="cm">		 */</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;previous I/O error to &quot;</span>
		       <span class="s">&quot;superblock detected&quot;</span><span class="p">);</span>
		<span class="n">clear_buffer_write_io_error</span><span class="p">(</span><span class="n">sbh</span><span class="p">);</span>
		<span class="n">set_buffer_uptodate</span><span class="p">(</span><span class="n">sbh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the file system is mounted read-only, don&#39;t update the</span>
<span class="cm">	 * superblock write time.  This avoids updating the superblock</span>
<span class="cm">	 * write time when we are mounting the root file system</span>
<span class="cm">	 * read/only but we need to replay the journal; at that point,</span>
<span class="cm">	 * for people who are east of GMT and who make their clock</span>
<span class="cm">	 * tick in localtime for Windows bug-for-bug compatibility,</span>
<span class="cm">	 * the clock is set in the future, and this will cause e2fsck</span>
<span class="cm">	 * to complain and force a full file system check.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_wtime</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">get_seconds</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_part</span><span class="p">)</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_kbytes_written</span> <span class="o">=</span>
			<span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_kbytes_written</span> <span class="o">+</span>
			    <span class="p">((</span><span class="n">part_stat_read</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_part</span><span class="p">,</span> <span class="n">sectors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>
			      <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_sectors_written_start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_kbytes_written</span> <span class="o">=</span>
			<span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_kbytes_written</span><span class="p">);</span>
	<span class="n">ext4_free_blocks_count_set</span><span class="p">(</span><span class="n">es</span><span class="p">,</span>
			<span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span> <span class="n">percpu_counter_sum_positive</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_freeclusters_counter</span><span class="p">)));</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_free_inodes_count</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">percpu_counter_sum_positive</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_freeinodes_counter</span><span class="p">));</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_dirt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">sbh</span><span class="p">,</span> <span class="s">&quot;marking dirty&quot;</span><span class="p">);</span>
	<span class="n">ext4_superblock_csum_set</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
	<span class="n">mark_buffer_dirty</span><span class="p">(</span><span class="n">sbh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">sync_dirty_buffer</span><span class="p">(</span><span class="n">sbh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">buffer_write_io_error</span><span class="p">(</span><span class="n">sbh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;I/O error while writing &quot;</span>
			       <span class="s">&quot;superblock&quot;</span><span class="p">);</span>
			<span class="n">clear_buffer_write_io_error</span><span class="p">(</span><span class="n">sbh</span><span class="p">);</span>
			<span class="n">set_buffer_uptodate</span><span class="p">(</span><span class="n">sbh</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Have we just finished recovery?  If so, and if we are mounting (or</span>
<span class="cm"> * remounting) the filesystem readonly, then we will end up with a</span>
<span class="cm"> * consistent fs on disk.  Record that fact.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mark_recovery_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EXT4_HAS_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_COMPAT_HAS_JOURNAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">journal</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">jbd2_journal_lock_updates</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jbd2_journal_flush</span><span class="p">(</span><span class="n">journal</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_RECOVER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXT4_CLEAR_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_RECOVER</span><span class="p">);</span>
		<span class="n">ext4_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">jbd2_journal_unlock_updates</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If we are mounting (or read-write remounting) a filesystem whose journal</span>
<span class="cm"> * has recorded an error from a previous lifetime, move that error to the</span>
<span class="cm"> * main filesystem now.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_clear_journal_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j_errno</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">EXT4_HAS_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_COMPAT_HAS_JOURNAL</span><span class="p">));</span>

	<span class="n">journal</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now check for any error status which may have been recorded in the</span>
<span class="cm">	 * journal by a prior ext4_error() or ext4_abort()</span>
<span class="cm">	 */</span>

	<span class="n">j_errno</span> <span class="o">=</span> <span class="n">jbd2_journal_errno</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j_errno</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">nbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

		<span class="n">errstr</span> <span class="o">=</span> <span class="n">ext4_decode_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">j_errno</span><span class="p">,</span> <span class="n">nbuf</span><span class="p">);</span>
		<span class="n">ext4_warning</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Filesystem error recorded &quot;</span>
			     <span class="s">&quot;from previous mount: %s&quot;</span><span class="p">,</span> <span class="n">errstr</span><span class="p">);</span>
		<span class="n">ext4_warning</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Marking fs in need of filesystem check.&quot;</span><span class="p">);</span>

		<span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">|=</span> <span class="n">EXT4_ERROR_FS</span><span class="p">;</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT4_ERROR_FS</span><span class="p">);</span>
		<span class="n">ext4_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">jbd2_journal_clear_err</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Force the running and committing transactions to commit,</span>
<span class="cm"> * and wait on the commit.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ext4_force_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">journal</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">journal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfs_check_frozen</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">SB_FREEZE_TRANS</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_journal_force_commit</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_write_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">ext4_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_sync_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tid_t</span> <span class="n">target</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">trace_ext4_sync_fs</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">dio_unwritten_wq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jbd2_journal_start_commit</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span>
			<span class="n">jbd2_log_wait_commit</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LVM calls this function before a (read-only) snapshot is created.  This</span>
<span class="cm"> * gives us a chance to flush the journal completely and mark the fs clean.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that only this function cannot bring a filesystem to be in a clean</span>
<span class="cm"> * state independently, because ext4 prevents a new handle from being started</span>
<span class="cm"> * by @sb-&gt;s_frozen, which stays in an upper layer.  It thus needs help from</span>
<span class="cm"> * the upper layer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">journal</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">;</span>

	<span class="cm">/* Now we set up the journal barrier. */</span>
	<span class="n">jbd2_journal_lock_updates</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t clear the needs_recovery flag if we failed to flush</span>
<span class="cm">	 * the journal.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">jbd2_journal_flush</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Journal blocked and flushed, clear needs_recovery flag. */</span>
	<span class="n">EXT4_CLEAR_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_RECOVER</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ext4_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="cm">/* we rely on s_frozen to stop further updates */</span>
	<span class="n">jbd2_journal_unlock_updates</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by LVM after the snapshot is done.  We need to reset the RECOVER</span>
<span class="cm"> * flag here, even though the filesystem is not technically dirty yet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_unfreeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="cm">/* Reset the needs_recovery flag before the fs is unlocked. */</span>
	<span class="n">EXT4_SET_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_INCOMPAT_RECOVER</span><span class="p">);</span>
	<span class="n">ext4_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Structure to save mount options for ext4_remount&#39;s benefit</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ext4_mount_options</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s_mount_opt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s_mount_opt2</span><span class="p">;</span>
	<span class="n">kuid_t</span> <span class="n">s_resuid</span><span class="p">;</span>
	<span class="n">kgid_t</span> <span class="n">s_resgid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s_commit_interval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">s_min_batch_time</span><span class="p">,</span> <span class="n">s_max_batch_time</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="kt">int</span> <span class="n">s_jquota_fmt</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_remount</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_sb_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_mount_options</span> <span class="n">old_opts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable_quota</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">g</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">journal_ioprio</span> <span class="o">=</span> <span class="n">DEFAULT_JOURNAL_IOPRIO</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">orig_data</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="cm">/* Store the original options */</span>
	<span class="n">lock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">old_sb_flags</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">;</span>
	<span class="n">old_opts</span><span class="p">.</span><span class="n">s_mount_opt</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">;</span>
	<span class="n">old_opts</span><span class="p">.</span><span class="n">s_mount_opt2</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt2</span><span class="p">;</span>
	<span class="n">old_opts</span><span class="p">.</span><span class="n">s_resuid</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resuid</span><span class="p">;</span>
	<span class="n">old_opts</span><span class="p">.</span><span class="n">s_resgid</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resgid</span><span class="p">;</span>
	<span class="n">old_opts</span><span class="p">.</span><span class="n">s_commit_interval</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_commit_interval</span><span class="p">;</span>
	<span class="n">old_opts</span><span class="p">.</span><span class="n">s_min_batch_time</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_min_batch_time</span><span class="p">;</span>
	<span class="n">old_opts</span><span class="p">.</span><span class="n">s_max_batch_time</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_max_batch_time</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="n">old_opts</span><span class="p">.</span><span class="n">s_jquota_fmt</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">old_opts</span><span class="p">.</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span> <span class="o">&amp;&amp;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="o">-&gt;</span><span class="n">j_task</span><span class="o">-&gt;</span><span class="n">io_context</span><span class="p">)</span>
		<span class="n">journal_ioprio</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="o">-&gt;</span><span class="n">j_task</span><span class="o">-&gt;</span><span class="n">io_context</span><span class="o">-&gt;</span><span class="n">ioprio</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allow the &quot;check&quot; option to be passed as a remount option.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parse_options</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">journal_ioprio</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">restore_opts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MF_FS_ABORTED</span><span class="p">)</span>
		<span class="n">ext4_abort</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Abort forced by user&quot;</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MS_POSIXACL</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">POSIX_ACL</span><span class="p">)</span> <span class="o">?</span> <span class="n">MS_POSIXACL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">es</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_init_journal_params</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">);</span>
		<span class="n">set_task_ioprio</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="o">-&gt;</span><span class="n">j_task</span><span class="p">,</span> <span class="n">journal_ioprio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MF_FS_ABORTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">restore_opts</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dquot_suspend</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">restore_opts</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * First of all, the unconditional stuff we have to do</span>
<span class="cm">			 * to disable replay of the journal when we next remount</span>
<span class="cm">			 */</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * OK, test if we are remounting a valid rw partition</span>
<span class="cm">			 * readonly, and if so set the rdonly flag and then</span>
<span class="cm">			 * mark the partition as valid again.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT4_VALID_FS</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">&amp;</span> <span class="n">EXT4_VALID_FS</span><span class="p">))</span>
				<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">)</span>
				<span class="n">ext4_mark_recovery_complete</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Make sure we can mount this feature set readwrite */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_feature_set_ok</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">restore_opts</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Make sure the group descriptor checksums</span>
<span class="cm">			 * are sane.  If they aren&#39;t, refuse to remount r/w.</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">g</span> <span class="o">&lt;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">;</span> <span class="n">g</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">gdp</span> <span class="o">=</span>
					<span class="n">ext4_get_group_desc</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_group_desc_csum_verify</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">gdp</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
	       <span class="s">&quot;ext4_remount: Checksum for group %u failed (%u!=%u)&quot;</span><span class="p">,</span>
		<span class="n">g</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ext4_group_desc_csum</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">gdp</span><span class="p">)),</span>
					       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_checksum</span><span class="p">));</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">restore_opts</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * If we have an unprocessed orphan list hanging</span>
<span class="cm">			 * around from a previously readonly bdev mount,</span>
<span class="cm">			 * require a full umount/remount for now.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t &quot;</span>
				       <span class="s">&quot;remount RDWR because of unprocessed &quot;</span>
				       <span class="s">&quot;orphan inode list.  Please &quot;</span>
				       <span class="s">&quot;umount/remount instead&quot;</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">restore_opts</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Mounting a RDONLY partition read-write, so reread</span>
<span class="cm">			 * and store the current valid flag.  (It may have</span>
<span class="cm">			 * been changed by e2fsck since we originally mounted</span>
<span class="cm">			 * the partition.)</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">)</span>
				<span class="n">ext4_clear_journal_err</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_setup_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_RDONLY</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
						     <span class="n">EXT4_FEATURE_INCOMPAT_MMP</span><span class="p">))</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ext4_multi_mount_protect</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
						<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_mmp_block</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">restore_opts</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="n">enable_quota</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reinitialize lazy itable initialization thread based on</span>
<span class="cm">	 * current settings</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">INIT_INODE_TABLE</span><span class="p">))</span>
		<span class="n">ext4_unregister_li_request</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ext4_group_t</span> <span class="n">first_not_zeroed</span><span class="p">;</span>
		<span class="n">first_not_zeroed</span> <span class="o">=</span> <span class="n">ext4_has_uninit_itable</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">ext4_register_li_request</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">first_not_zeroed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ext4_setup_system_zone</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ext4_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="cm">/* Release old quota file names */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_opts</span><span class="p">.</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">old_opts</span><span class="p">.</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">old_opts</span><span class="p">.</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_quota</span><span class="p">)</span>
		<span class="n">dquot_resume</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;re-mounted. Opts: %s&quot;</span><span class="p">,</span> <span class="n">orig_data</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">orig_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">restore_opts:</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">=</span> <span class="n">old_sb_flags</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_mount_opt</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt2</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_mount_opt2</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resuid</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_resuid</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resgid</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_resgid</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_commit_interval</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_commit_interval</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_min_batch_time</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_min_batch_time</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_max_batch_time</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_max_batch_time</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_jquota_fmt</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">old_opts</span><span class="p">.</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">orig_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Note: calculating the overhead so we can be compatible with</span>
<span class="cm"> * historical BSD practice is quite difficult in the face of</span>
<span class="cm"> * clusters/bigalloc.  This is because multiple metadata blocks from</span>
<span class="cm"> * different block group can end up in the same allocation cluster.</span>
<span class="cm"> * Calculating the exact overhead in the face of clustered allocation</span>
<span class="cm"> * requires either O(all block bitmaps) in memory or O(number of block</span>
<span class="cm"> * groups**2) in time.  We will still calculate the superblock for</span>
<span class="cm"> * older file systems --- and if we come across with a bigalloc file</span>
<span class="cm"> * system with zero in s_overhead_clusters the estimate will be close to</span>
<span class="cm"> * correct especially for very large cluster sizes --- but for newer</span>
<span class="cm"> * file systems, it&#39;s better to calculate this figure once at mkfs</span>
<span class="cm"> * time, and store it in the superblock.  If the superblock value is</span>
<span class="cm"> * present (even for non-bigalloc file systems), we will use it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">gdp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fsid</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">bfree</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">MINIX_DF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_overhead_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_overhead_clusters</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_overhead_last</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_overhead_clusters</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_last</span> <span class="o">!=</span> <span class="n">ext4_blocks_count</span><span class="p">(</span><span class="n">es</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_group_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">ngroups</span> <span class="o">=</span> <span class="n">ext4_get_groups_count</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">ext4_fsblk_t</span> <span class="n">overhead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Compute the overhead (FS structures).  This is constant</span>
<span class="cm">		 * for a given filesystem unless the number of block groups</span>
<span class="cm">		 * changes so we cache the previous value until it does.</span>
<span class="cm">		 */</span>

		<span class="cm">/*</span>
<span class="cm">		 * All of the blocks before first_data_block are</span>
<span class="cm">		 * overhead</span>
<span class="cm">		 */</span>
		<span class="n">overhead</span> <span class="o">=</span> <span class="n">EXT4_B2C</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_data_block</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * Add the overhead found in each block group</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ngroups</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gdp</span> <span class="o">=</span> <span class="n">ext4_get_group_desc</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">overhead</span> <span class="o">+=</span> <span class="n">ext4_num_overhead_clusters</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gdp</span><span class="p">);</span>
			<span class="n">cond_resched</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_overhead_last</span> <span class="o">=</span> <span class="n">overhead</span><span class="p">;</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_last</span> <span class="o">=</span> <span class="n">ext4_blocks_count</span><span class="p">(</span><span class="n">es</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_type</span> <span class="o">=</span> <span class="n">EXT4_SUPER_MAGIC</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bsize</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">ext4_blocks_count</span><span class="p">(</span><span class="n">es</span><span class="p">)</span> <span class="o">-</span>
			 <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_overhead_last</span><span class="p">));</span>
	<span class="n">bfree</span> <span class="o">=</span> <span class="n">percpu_counter_sum_positive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeclusters_counter</span><span class="p">)</span> <span class="o">-</span>
		<span class="n">percpu_counter_sum_positive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirtyclusters_counter</span><span class="p">);</span>
	<span class="cm">/* prevent underflow in case that few free space is available */</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">=</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">max_t</span><span class="p">(</span><span class="n">s64</span><span class="p">,</span> <span class="n">bfree</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bavail</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">-</span> <span class="n">ext4_r_blocks_count</span><span class="p">(</span><span class="n">es</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">&lt;</span> <span class="n">ext4_r_blocks_count</span><span class="p">(</span><span class="n">es</span><span class="p">))</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bavail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_files</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_inodes_count</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_ffree</span> <span class="o">=</span> <span class="n">percpu_counter_sum_positive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeinodes_counter</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_namelen</span> <span class="o">=</span> <span class="n">EXT4_NAME_LEN</span><span class="p">;</span>
	<span class="n">fsid</span> <span class="o">=</span> <span class="n">le64_to_cpup</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">)</span> <span class="o">^</span>
	       <span class="n">le64_to_cpup</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_uuid</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_fsid</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fsid</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_fsid</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fsid</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Helper function for writing quotas on sync - we need to start transaction</span>
<span class="cm"> * before quota file is locked for write. Otherwise the are possible deadlocks:</span>
<span class="cm"> * Process 1                         Process 2</span>
<span class="cm"> * ext4_create()                     quota_sync()</span>
<span class="cm"> *   jbd2_journal_start()                  write_dquot()</span>
<span class="cm"> *   dquot_initialize()                         down(dqio_mutex)</span>
<span class="cm"> *     down(dqio_mutex)                    jbd2_journal_start()</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">dquot_to_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_write_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>

	<span class="n">inode</span> <span class="o">=</span> <span class="n">dquot_to_inode</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">ext4_journal_start</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span>
				    <span class="n">EXT4_QUOTA_TRANS_BLOCKS</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dquot_commit</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_journal_stop</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_acquire_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">ext4_journal_start</span><span class="p">(</span><span class="n">dquot_to_inode</span><span class="p">(</span><span class="n">dquot</span><span class="p">),</span>
				    <span class="n">EXT4_QUOTA_INIT_BLOCKS</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dquot_acquire</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_journal_stop</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_release_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">ext4_journal_start</span><span class="p">(</span><span class="n">dquot_to_inode</span><span class="p">(</span><span class="n">dquot</span><span class="p">),</span>
				    <span class="n">EXT4_QUOTA_DEL_BLOCKS</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Release dquot anyway to avoid endless cycle in dqput() */</span>
		<span class="n">dquot_release</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dquot_release</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_journal_stop</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_mark_dquot_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Are we journaling quotas? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">]</span> <span class="o">||</span>
	    <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dquot_mark_dquot_dirty</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ext4_write_dquot</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">dquot_mark_dquot_dirty</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_write_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>

	<span class="cm">/* Data block + inode block */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">ext4_journal_start</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dquot_commit_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_journal_stop</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Turn on quotas during mount time - we need to find</span>
<span class="cm"> * the quota file and such...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_quota_on_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dquot_quota_on_mount</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">type</span><span class="p">],</span>
					<span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Standard function to be called on quota_on</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_quota_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format_id</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">QUOTA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Quotafile not on the same filesystem? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span> <span class="o">!=</span> <span class="n">sb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EXDEV</span><span class="p">;</span>
	<span class="cm">/* Journaling quota? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">type</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* Quotafile not in fs root? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span> <span class="o">!=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">)</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
				<span class="s">&quot;Quota file not on filesystem root. &quot;</span>
				<span class="s">&quot;Journaled quota will not work&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * When we journal data on quota file, we have to flush journal to see</span>
<span class="cm">	 * all updates to the file when we bypass pagecache...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ext4_should_journal_data</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We don&#39;t need to lock updates but journal_flush() could</span>
<span class="cm">		 * otherwise be livelocked...</span>
<span class="cm">		 */</span>
		<span class="n">jbd2_journal_lock_updates</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">jbd2_journal_flush</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">);</span>
		<span class="n">jbd2_journal_unlock_updates</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dquot_quota_on</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">format_id</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_quota_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>

	<span class="cm">/* Force all delayed allocation blocks to be allocated.</span>
<span class="cm">	 * Caller already holds s_umount sem */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DELALLOC</span><span class="p">))</span>
		<span class="n">sync_filesystem</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Update modification times of quota files when userspace can</span>
<span class="cm">	 * start looking at them */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">ext4_journal_start</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">ext4_mark_inode_dirty</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
	<span class="n">ext4_journal_stop</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">dquot_quota_off</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read data from quotafile - avoid pagecache and such because we cannot afford</span>
<span class="cm"> * acquiring the locks... As quota files are never truncated and quota code</span>
<span class="cm"> * itself serializes the operations (and no one else should touch the files)</span>
<span class="cm"> * we don&#39;t have to be afraid of races */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ext4_quota_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="n">ext4_lblk_t</span> <span class="n">blk</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">EXT4_BLOCK_SIZE_BITS</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tocopy</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">toread</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">i_size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="n">i_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span><span class="o">+</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">i_size</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">i_size</span><span class="o">-</span><span class="n">off</span><span class="p">;</span>
	<span class="n">toread</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">toread</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tocopy</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">toread</span> <span class="o">?</span>
				<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">:</span> <span class="n">toread</span><span class="p">;</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">ext4_bread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span>	<span class="cm">/* A hole? */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tocopy</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="n">tocopy</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">toread</span> <span class="o">-=</span> <span class="n">tocopy</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">tocopy</span><span class="p">;</span>
		<span class="n">blk</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write to quotafile (we know the transaction is already started and has</span>
<span class="cm"> * enough credits) */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ext4_quota_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="n">ext4_lblk_t</span> <span class="n">blk</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">EXT4_BLOCK_SIZE_BITS</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">journal_current_handle</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Quota write (off=%llu, len=%llu)&quot;</span>
			<span class="s">&quot; cancelled because transaction is not started&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">off</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Since we account only one data block in transaction credits,</span>
<span class="cm">	 * then it is impossible to cross a block boundary.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Quota write (off=%llu, len=%llu)&quot;</span>
			<span class="s">&quot; cancelled because not block aligned&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">off</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">ext4_bread</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_journal_get_write_access</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_page</span><span class="p">);</span>
	<span class="n">unlock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_handle_dirty_metadata</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&lt;</span> <span class="n">off</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i_size_write</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">off</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">EXT4_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_disksize</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">;</span>
		<span class="n">ext4_mark_inode_dirty</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">ext4_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mount_bdev</span><span class="p">(</span><span class="n">fs_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ext4_fill_super</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if !defined(CONFIG_EXT2_FS) &amp;&amp; !defined(CONFIG_EXT2_FS_MODULE) &amp;&amp; defined(CONFIG_EXT4_USE_FOR_EXT23)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">register_as_ext2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">register_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext2_fs_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;EXT4-fs: Unable to register as ext2 (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">unregister_as_ext2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext2_fs_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ext2_feature_set_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="n">EXT2_FEATURE_INCOMPAT_SUPP</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="n">EXT2_FEATURE_RO_COMPAT_SUPP</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;ext2&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">register_as_ext2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">unregister_as_ext2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ext2_feature_set_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(CONFIG_EXT3_FS) &amp;&amp; !defined(CONFIG_EXT3_FS_MODULE) &amp;&amp; defined(CONFIG_EXT4_USE_FOR_EXT23)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">register_as_ext3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">register_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext3_fs_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;EXT4-fs: Unable to register as ext3 (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">unregister_as_ext3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext3_fs_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ext3_feature_set_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="n">EXT3_FEATURE_INCOMPAT_SUPP</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EXT4_HAS_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT4_FEATURE_COMPAT_HAS_JOURNAL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="n">EXT3_FEATURE_RO_COMPAT_SUPP</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;ext3&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">register_as_ext3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">unregister_as_ext3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ext3_feature_set_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">ext4_fs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ext4&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>		<span class="o">=</span> <span class="n">ext4_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>	<span class="o">=</span> <span class="n">kill_block_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fs_flags</span>	<span class="o">=</span> <span class="n">FS_REQUIRES_DEV</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ext4_init_feat_adverts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_features</span> <span class="o">*</span><span class="n">ef</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ef</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_features</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ef</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ef</span><span class="o">-&gt;</span><span class="n">f_kobj</span><span class="p">.</span><span class="n">kset</span> <span class="o">=</span> <span class="n">ext4_kset</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ef</span><span class="o">-&gt;</span><span class="n">f_kobj_unregister</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">kobject_init_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ef</span><span class="o">-&gt;</span><span class="n">f_kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext4_feat_ktype</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="s">&quot;features&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ef</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ext4_feat</span> <span class="o">=</span> <span class="n">ef</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_exit_feat_adverts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_feat</span><span class="o">-&gt;</span><span class="n">f_kobj</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_feat</span><span class="o">-&gt;</span><span class="n">f_kobj_unregister</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ext4_feat</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Shared across all ext4 file systems */</span>
<span class="n">wait_queue_head_t</span> <span class="n">ext4__ioend_wq</span><span class="p">[</span><span class="n">EXT4_WQ_HASH_SZ</span><span class="p">];</span>
<span class="k">struct</span> <span class="n">mutex</span> <span class="n">ext4__aio_mutex</span><span class="p">[</span><span class="n">EXT4_WQ_HASH_SZ</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ext4_init_fs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ext4_li_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_li_mtx</span><span class="p">);</span>

	<span class="n">ext4_check_flag_values</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EXT4_WQ_HASH_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4__aio_mutex</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4__ioend_wq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_init_pageio</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_init_system_zone</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out6</span><span class="p">;</span>
	<span class="n">ext4_kset</span> <span class="o">=</span> <span class="n">kset_create_and_add</span><span class="p">(</span><span class="s">&quot;ext4&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">fs_kobj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_kset</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out5</span><span class="p">;</span>
	<span class="n">ext4_proc_root</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;fs/ext4&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_init_feat_adverts</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out4</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_init_mballoc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_init_xattr</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">init_inodecache</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="n">register_as_ext3</span><span class="p">();</span>
	<span class="n">register_as_ext2</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_fs_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">unregister_as_ext2</span><span class="p">();</span>
	<span class="n">unregister_as_ext3</span><span class="p">();</span>
	<span class="n">destroy_inodecache</span><span class="p">();</span>
<span class="nl">out1:</span>
	<span class="n">ext4_exit_xattr</span><span class="p">();</span>
<span class="nl">out2:</span>
	<span class="n">ext4_exit_mballoc</span><span class="p">();</span>
<span class="nl">out3:</span>
	<span class="n">ext4_exit_feat_adverts</span><span class="p">();</span>
<span class="nl">out4:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext4_proc_root</span><span class="p">)</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;fs/ext4&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kset_unregister</span><span class="p">(</span><span class="n">ext4_kset</span><span class="p">);</span>
<span class="nl">out5:</span>
	<span class="n">ext4_exit_system_zone</span><span class="p">();</span>
<span class="nl">out6:</span>
	<span class="n">ext4_exit_pageio</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ext4_exit_fs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_destroy_lazyinit_thread</span><span class="p">();</span>
	<span class="n">unregister_as_ext2</span><span class="p">();</span>
	<span class="n">unregister_as_ext3</span><span class="p">();</span>
	<span class="n">unregister_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_fs_type</span><span class="p">);</span>
	<span class="n">destroy_inodecache</span><span class="p">();</span>
	<span class="n">ext4_exit_xattr</span><span class="p">();</span>
	<span class="n">ext4_exit_mballoc</span><span class="p">();</span>
	<span class="n">ext4_exit_feat_adverts</span><span class="p">();</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;fs/ext4&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kset_unregister</span><span class="p">(</span><span class="n">ext4_kset</span><span class="p">);</span>
	<span class="n">ext4_exit_system_zone</span><span class="p">();</span>
	<span class="n">ext4_exit_pageio</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Remy Card, Stephen Tweedie, Andrew Morton, Andreas Dilger, Theodore Ts&#39;o and others&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Fourth Extended Filesystem&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">ext4_init_fs</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ext4_exit_fs</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
