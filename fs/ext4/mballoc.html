<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › ext4 › mballoc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>mballoc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2003-2006, Cluster File Systems, Inc, info@clusterfs.com</span>
<span class="cm"> * Written by Alex Tomas &lt;alex@clusterfs.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public Licens</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-</span>
<span class="cm"> */</span>


<span class="cm">/*</span>
<span class="cm"> * mballoc.c contains the multiblocks allocation routines</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;ext4_jbd2.h&quot;</span>
<span class="cp">#include &quot;mballoc.h&quot;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;trace/events/ext4.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * MUSTDO:</span>
<span class="cm"> *   - test ext4_ext_search_left() and ext4_ext_search_right()</span>
<span class="cm"> *   - search for metadata in few groups</span>
<span class="cm"> *</span>
<span class="cm"> * TODO v4:</span>
<span class="cm"> *   - normalization should take into account whether file is still open</span>
<span class="cm"> *   - discard preallocations if no free space left (policy?)</span>
<span class="cm"> *   - don&#39;t normalize tails</span>
<span class="cm"> *   - quota</span>
<span class="cm"> *   - reservation for superuser</span>
<span class="cm"> *</span>
<span class="cm"> * TODO v3:</span>
<span class="cm"> *   - bitmap read-ahead (proposed by Oleg Drokin aka green)</span>
<span class="cm"> *   - track min/max extents in each group for better group selection</span>
<span class="cm"> *   - mb_mark_used() may allocate chunk right after splitting buddy</span>
<span class="cm"> *   - tree of groups sorted by number of free blocks</span>
<span class="cm"> *   - error handling</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The allocation request involve request for multiple number of blocks</span>
<span class="cm"> * near to the goal(block) value specified.</span>
<span class="cm"> *</span>
<span class="cm"> * During initialization phase of the allocator we decide to use the</span>
<span class="cm"> * group preallocation or inode preallocation depending on the size of</span>
<span class="cm"> * the file. The size of the file could be the resulting file size we</span>
<span class="cm"> * would have after allocation, or the current file size, which ever</span>
<span class="cm"> * is larger. If the size is less than sbi-&gt;s_mb_stream_request we</span>
<span class="cm"> * select to use the group preallocation. The default value of</span>
<span class="cm"> * s_mb_stream_request is 16 blocks. This can also be tuned via</span>
<span class="cm"> * /sys/fs/ext4/&lt;partition&gt;/mb_stream_req. The value is represented in</span>
<span class="cm"> * terms of number of blocks.</span>
<span class="cm"> *</span>
<span class="cm"> * The main motivation for having small file use group preallocation is to</span>
<span class="cm"> * ensure that we have small files closer together on the disk.</span>
<span class="cm"> *</span>
<span class="cm"> * First stage the allocator looks at the inode prealloc list,</span>
<span class="cm"> * ext4_inode_info-&gt;i_prealloc_list, which contains list of prealloc</span>
<span class="cm"> * spaces for this particular inode. The inode prealloc space is</span>
<span class="cm"> * represented as:</span>
<span class="cm"> *</span>
<span class="cm"> * pa_lstart -&gt; the logical start block for this prealloc space</span>
<span class="cm"> * pa_pstart -&gt; the physical start block for this prealloc space</span>
<span class="cm"> * pa_len    -&gt; length for this prealloc space (in clusters)</span>
<span class="cm"> * pa_free   -&gt;  free space available in this prealloc space (in clusters)</span>
<span class="cm"> *</span>
<span class="cm"> * The inode preallocation space is used looking at the _logical_ start</span>
<span class="cm"> * block. If only the logical file block falls within the range of prealloc</span>
<span class="cm"> * space we will consume the particular prealloc space. This makes sure that</span>
<span class="cm"> * we have contiguous physical blocks representing the file blocks</span>
<span class="cm"> *</span>
<span class="cm"> * The important thing to be noted in case of inode prealloc space is that</span>
<span class="cm"> * we don&#39;t modify the values associated to inode prealloc space except</span>
<span class="cm"> * pa_free.</span>
<span class="cm"> *</span>
<span class="cm"> * If we are not able to find blocks in the inode prealloc space and if we</span>
<span class="cm"> * have the group allocation flag set then we look at the locality group</span>
<span class="cm"> * prealloc space. These are per CPU prealloc list represented as</span>
<span class="cm"> *</span>
<span class="cm"> * ext4_sb_info.s_locality_groups[smp_processor_id()]</span>
<span class="cm"> *</span>
<span class="cm"> * The reason for having a per cpu locality group is to reduce the contention</span>
<span class="cm"> * between CPUs. It is possible to get scheduled at this point.</span>
<span class="cm"> *</span>
<span class="cm"> * The locality group prealloc space is used looking at whether we have</span>
<span class="cm"> * enough free space (pa_free) within the prealloc space.</span>
<span class="cm"> *</span>
<span class="cm"> * If we can&#39;t allocate blocks via inode prealloc or/and locality group</span>
<span class="cm"> * prealloc then we look at the buddy cache. The buddy cache is represented</span>
<span class="cm"> * by ext4_sb_info.s_buddy_cache (struct inode) whose file offset gets</span>
<span class="cm"> * mapped to the buddy and bitmap information regarding different</span>
<span class="cm"> * groups. The buddy information is attached to buddy cache inode so that</span>
<span class="cm"> * we can access them through the page cache. The information regarding</span>
<span class="cm"> * each group is loaded via ext4_mb_load_buddy.  The information involve</span>
<span class="cm"> * block bitmap and buddy information. The information are stored in the</span>
<span class="cm"> * inode as:</span>
<span class="cm"> *</span>
<span class="cm"> *  {                        page                        }</span>
<span class="cm"> *  [ group 0 bitmap][ group 0 buddy] [group 1][ group 1]...</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * one block each for bitmap and buddy information.  So for each group we</span>
<span class="cm"> * take up 2 blocks. A page can contain blocks_per_page (PAGE_CACHE_SIZE /</span>
<span class="cm"> * blocksize) blocks.  So it can have information regarding groups_per_page</span>
<span class="cm"> * which is blocks_per_page/2</span>
<span class="cm"> *</span>
<span class="cm"> * The buddy cache inode is not stored on disk. The inode is thrown</span>
<span class="cm"> * away when the filesystem is unmounted.</span>
<span class="cm"> *</span>
<span class="cm"> * We look for count number of blocks in the buddy cache. If we were able</span>
<span class="cm"> * to locate that many free blocks we return with additional information</span>
<span class="cm"> * regarding rest of the contiguous physical block available</span>
<span class="cm"> *</span>
<span class="cm"> * Before allocating blocks via buddy cache we normalize the request</span>
<span class="cm"> * blocks. This ensure we ask for more blocks that we needed. The extra</span>
<span class="cm"> * blocks that we get after allocation is added to the respective prealloc</span>
<span class="cm"> * list. In case of inode preallocation we follow a list of heuristics</span>
<span class="cm"> * based on file size. This can be found in ext4_mb_normalize_request. If</span>
<span class="cm"> * we are doing a group prealloc we try to normalize the request to</span>
<span class="cm"> * sbi-&gt;s_mb_group_prealloc.  The default value of s_mb_group_prealloc is</span>
<span class="cm"> * dependent on the cluster size; for non-bigalloc file systems, it is</span>
<span class="cm"> * 512 blocks. This can be tuned via</span>
<span class="cm"> * /sys/fs/ext4/&lt;partition&gt;/mb_group_prealloc. The value is represented in</span>
<span class="cm"> * terms of number of blocks. If we have mounted the file system with -O</span>
<span class="cm"> * stripe=&lt;value&gt; option the group prealloc request is normalized to the</span>
<span class="cm"> * the smallest multiple of the stripe value (sbi-&gt;s_stripe) which is</span>
<span class="cm"> * greater than the default mb_group_prealloc.</span>
<span class="cm"> *</span>
<span class="cm"> * The regular allocator (using the buddy cache) supports a few tunables.</span>
<span class="cm"> *</span>
<span class="cm"> * /sys/fs/ext4/&lt;partition&gt;/mb_min_to_scan</span>
<span class="cm"> * /sys/fs/ext4/&lt;partition&gt;/mb_max_to_scan</span>
<span class="cm"> * /sys/fs/ext4/&lt;partition&gt;/mb_order2_req</span>
<span class="cm"> *</span>
<span class="cm"> * The regular allocator uses buddy scan only if the request len is power of</span>
<span class="cm"> * 2 blocks and the order of allocation is &gt;= sbi-&gt;s_mb_order2_reqs. The</span>
<span class="cm"> * value of s_mb_order2_reqs can be tuned via</span>
<span class="cm"> * /sys/fs/ext4/&lt;partition&gt;/mb_order2_req.  If the request len is equal to</span>
<span class="cm"> * stripe size (sbi-&gt;s_stripe), we try to search for contiguous block in</span>
<span class="cm"> * stripe size. This should result in better allocation on RAID setups. If</span>
<span class="cm"> * not, we search in the specific group using bitmap for best extents. The</span>
<span class="cm"> * tunable min_to_scan and max_to_scan control the behaviour here.</span>
<span class="cm"> * min_to_scan indicate how long the mballoc __must__ look for a best</span>
<span class="cm"> * extent and max_to_scan indicates how long the mballoc __can__ look for a</span>
<span class="cm"> * best extent in the found extents. Searching for the blocks starts with</span>
<span class="cm"> * the group specified as the goal value in allocation context via</span>
<span class="cm"> * ac_g_ex. Each group is first checked based on the criteria whether it</span>
<span class="cm"> * can be used for allocation. ext4_mb_good_group explains how the groups are</span>
<span class="cm"> * checked.</span>
<span class="cm"> *</span>
<span class="cm"> * Both the prealloc space are getting populated as above. So for the first</span>
<span class="cm"> * request we will hit the buddy cache which will result in this prealloc</span>
<span class="cm"> * space getting filled. The prealloc space is then later used for the</span>
<span class="cm"> * subsequent request.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * mballoc operates on the following data:</span>
<span class="cm"> *  - on-disk bitmap</span>
<span class="cm"> *  - in-core buddy (actually includes buddy and bitmap)</span>
<span class="cm"> *  - preallocation descriptors (PAs)</span>
<span class="cm"> *</span>
<span class="cm"> * there are two types of preallocations:</span>
<span class="cm"> *  - inode</span>
<span class="cm"> *    assiged to specific inode and can be used for this inode only.</span>
<span class="cm"> *    it describes part of inode&#39;s space preallocated to specific</span>
<span class="cm"> *    physical blocks. any block from that preallocated can be used</span>
<span class="cm"> *    independent. the descriptor just tracks number of blocks left</span>
<span class="cm"> *    unused. so, before taking some block from descriptor, one must</span>
<span class="cm"> *    make sure corresponded logical block isn&#39;t allocated yet. this</span>
<span class="cm"> *    also means that freeing any block within descriptor&#39;s range</span>
<span class="cm"> *    must discard all preallocated blocks.</span>
<span class="cm"> *  - locality group</span>
<span class="cm"> *    assigned to specific locality group which does not translate to</span>
<span class="cm"> *    permanent set of inodes: inode can join and leave group. space</span>
<span class="cm"> *    from this type of preallocation can be used for any inode. thus</span>
<span class="cm"> *    it&#39;s consumed from the beginning to the end.</span>
<span class="cm"> *</span>
<span class="cm"> * relation between them can be expressed as:</span>
<span class="cm"> *    in-core buddy = on-disk bitmap + preallocation descriptors</span>
<span class="cm"> *</span>
<span class="cm"> * this mean blocks mballoc considers used are:</span>
<span class="cm"> *  - allocated blocks (persistent)</span>
<span class="cm"> *  - preallocated blocks (non-persistent)</span>
<span class="cm"> *</span>
<span class="cm"> * consistency in mballoc world means that at any time a block is either</span>
<span class="cm"> * free or used in ALL structures. notice: &quot;any time&quot; should not be read</span>
<span class="cm"> * literally -- time is discrete and delimited by locks.</span>
<span class="cm"> *</span>
<span class="cm"> *  to keep it simple, we don&#39;t use block numbers, instead we count number of</span>
<span class="cm"> *  blocks: how many blocks marked used/free in on-disk bitmap, buddy and PA.</span>
<span class="cm"> *</span>
<span class="cm"> * all operations can be expressed as:</span>
<span class="cm"> *  - init buddy:			buddy = on-disk + PAs</span>
<span class="cm"> *  - new PA:				buddy += N; PA = N</span>
<span class="cm"> *  - use inode PA:			on-disk += N; PA -= N</span>
<span class="cm"> *  - discard inode PA			buddy -= on-disk - PA; PA = 0</span>
<span class="cm"> *  - use locality group PA		on-disk += N; PA -= N</span>
<span class="cm"> *  - discard locality group PA		buddy -= PA; PA = 0</span>
<span class="cm"> *  note: &#39;buddy -= on-disk - PA&#39; is used to show that on-disk bitmap</span>
<span class="cm"> *        is used in real operation because we can&#39;t know actual used</span>
<span class="cm"> *        bits from PA, only from on-disk bitmap</span>
<span class="cm"> *</span>
<span class="cm"> * if we follow this strict logic, then all operations above should be atomic.</span>
<span class="cm"> * given some of them can block, we&#39;d have to use something like semaphores</span>
<span class="cm"> * killing performance on high-end SMP hardware. let&#39;s try to relax it using</span>
<span class="cm"> * the following knowledge:</span>
<span class="cm"> *  1) if buddy is referenced, it&#39;s already initialized</span>
<span class="cm"> *  2) while block is used in buddy and the buddy is referenced,</span>
<span class="cm"> *     nobody can re-allocate that block</span>
<span class="cm"> *  3) we work on bitmaps and &#39;+&#39; actually means &#39;set bits&#39;. if on-disk has</span>
<span class="cm"> *     bit set and PA claims same block, it&#39;s OK. IOW, one can set bit in</span>
<span class="cm"> *     on-disk bitmap if buddy has same bit set or/and PA covers corresponded</span>
<span class="cm"> *     block</span>
<span class="cm"> *</span>
<span class="cm"> * so, now we&#39;re building a concurrency table:</span>
<span class="cm"> *  - init buddy vs.</span>
<span class="cm"> *    - new PA</span>
<span class="cm"> *      blocks for PA are allocated in the buddy, buddy must be referenced</span>
<span class="cm"> *      until PA is linked to allocation group to avoid concurrent buddy init</span>
<span class="cm"> *    - use inode PA</span>
<span class="cm"> *      we need to make sure that either on-disk bitmap or PA has uptodate data</span>
<span class="cm"> *      given (3) we care that PA-=N operation doesn&#39;t interfere with init</span>
<span class="cm"> *    - discard inode PA</span>
<span class="cm"> *      the simplest way would be to have buddy initialized by the discard</span>
<span class="cm"> *    - use locality group PA</span>
<span class="cm"> *      again PA-=N must be serialized with init</span>
<span class="cm"> *    - discard locality group PA</span>
<span class="cm"> *      the simplest way would be to have buddy initialized by the discard</span>
<span class="cm"> *  - new PA vs.</span>
<span class="cm"> *    - use inode PA</span>
<span class="cm"> *      i_data_sem serializes them</span>
<span class="cm"> *    - discard inode PA</span>
<span class="cm"> *      discard process must wait until PA isn&#39;t used by another process</span>
<span class="cm"> *    - use locality group PA</span>
<span class="cm"> *      some mutex should serialize them</span>
<span class="cm"> *    - discard locality group PA</span>
<span class="cm"> *      discard process must wait until PA isn&#39;t used by another process</span>
<span class="cm"> *  - use inode PA</span>
<span class="cm"> *    - use inode PA</span>
<span class="cm"> *      i_data_sem or another mutex should serializes them</span>
<span class="cm"> *    - discard inode PA</span>
<span class="cm"> *      discard process must wait until PA isn&#39;t used by another process</span>
<span class="cm"> *    - use locality group PA</span>
<span class="cm"> *      nothing wrong here -- they&#39;re different PAs covering different blocks</span>
<span class="cm"> *    - discard locality group PA</span>
<span class="cm"> *      discard process must wait until PA isn&#39;t used by another process</span>
<span class="cm"> *</span>
<span class="cm"> * now we&#39;re ready to make few consequences:</span>
<span class="cm"> *  - PA is referenced and while it is no discard is possible</span>
<span class="cm"> *  - PA is referenced until block isn&#39;t marked in on-disk bitmap</span>
<span class="cm"> *  - PA changes only after on-disk bitmap</span>
<span class="cm"> *  - discard must not compete with init. either init is done before</span>
<span class="cm"> *    any discard or they&#39;re serialized somehow</span>
<span class="cm"> *  - buddy init as sum of on-disk bitmap and PAs is done atomically</span>
<span class="cm"> *</span>
<span class="cm"> * a special case when we&#39;ve used PA to emptiness. no need to modify buddy</span>
<span class="cm"> * in this case, but we should care about concurrent init</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

 <span class="cm">/*</span>
<span class="cm"> * Logic in few words:</span>
<span class="cm"> *</span>
<span class="cm"> *  - allocation:</span>
<span class="cm"> *    load group</span>
<span class="cm"> *    find blocks</span>
<span class="cm"> *    mark bits in on-disk bitmap</span>
<span class="cm"> *    release group</span>
<span class="cm"> *</span>
<span class="cm"> *  - use preallocation:</span>
<span class="cm"> *    find proper PA (per-inode or group)</span>
<span class="cm"> *    load group</span>
<span class="cm"> *    mark bits in on-disk bitmap</span>
<span class="cm"> *    release group</span>
<span class="cm"> *    release PA</span>
<span class="cm"> *</span>
<span class="cm"> *  - free:</span>
<span class="cm"> *    load group</span>
<span class="cm"> *    mark bits in on-disk bitmap</span>
<span class="cm"> *    release group</span>
<span class="cm"> *</span>
<span class="cm"> *  - discard preallocations in group:</span>
<span class="cm"> *    mark PAs deleted</span>
<span class="cm"> *    move them onto local list</span>
<span class="cm"> *    load on-disk bitmap</span>
<span class="cm"> *    load group</span>
<span class="cm"> *    remove PA from object (inode or locality group)</span>
<span class="cm"> *    mark free blocks in-core</span>
<span class="cm"> *</span>
<span class="cm"> *  - discard inode&#39;s preallocations:</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Locking rules</span>
<span class="cm"> *</span>
<span class="cm"> * Locks:</span>
<span class="cm"> *  - bitlock on a group	(group)</span>
<span class="cm"> *  - object (inode/locality)	(object)</span>
<span class="cm"> *  - per-pa lock		(pa)</span>
<span class="cm"> *</span>
<span class="cm"> * Paths:</span>
<span class="cm"> *  - new pa</span>
<span class="cm"> *    object</span>
<span class="cm"> *    group</span>
<span class="cm"> *</span>
<span class="cm"> *  - find and use pa:</span>
<span class="cm"> *    pa</span>
<span class="cm"> *</span>
<span class="cm"> *  - release consumed pa:</span>
<span class="cm"> *    pa</span>
<span class="cm"> *    group</span>
<span class="cm"> *    object</span>
<span class="cm"> *</span>
<span class="cm"> *  - generate in-core bitmap:</span>
<span class="cm"> *    group</span>
<span class="cm"> *        pa</span>
<span class="cm"> *</span>
<span class="cm"> *  - discard all for given object (inode, locality group):</span>
<span class="cm"> *    object</span>
<span class="cm"> *        pa</span>
<span class="cm"> *    group</span>
<span class="cm"> *</span>
<span class="cm"> *  - discard all for given group:</span>
<span class="cm"> *    group</span>
<span class="cm"> *        pa</span>
<span class="cm"> *    group</span>
<span class="cm"> *        object</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">ext4_pspace_cachep</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">ext4_ac_cachep</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">ext4_free_data_cachep</span><span class="p">;</span>

<span class="cm">/* We create slab caches for groupinfo data structures based on the</span>
<span class="cm"> * superblock block size.  There will be one per mounted filesystem for</span>
<span class="cm"> * each unique s_blocksize_bits */</span>
<span class="cp">#define NR_GRPINFO_CACHES 8</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">ext4_groupinfo_caches</span><span class="p">[</span><span class="n">NR_GRPINFO_CACHES</span><span class="p">];</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ext4_groupinfo_slab_names</span><span class="p">[</span><span class="n">NR_GRPINFO_CACHES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;ext4_groupinfo_1k&quot;</span><span class="p">,</span> <span class="s">&quot;ext4_groupinfo_2k&quot;</span><span class="p">,</span> <span class="s">&quot;ext4_groupinfo_4k&quot;</span><span class="p">,</span>
	<span class="s">&quot;ext4_groupinfo_8k&quot;</span><span class="p">,</span> <span class="s">&quot;ext4_groupinfo_16k&quot;</span><span class="p">,</span> <span class="s">&quot;ext4_groupinfo_32k&quot;</span><span class="p">,</span>
	<span class="s">&quot;ext4_groupinfo_64k&quot;</span><span class="p">,</span> <span class="s">&quot;ext4_groupinfo_128k&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ext4_mb_generate_from_pa</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span>
					<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ext4_mb_generate_from_freelist</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span>
						<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ext4_free_data_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ext4_journal_cb_entry</span> <span class="o">*</span><span class="n">jce</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rc</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">mb_correct_addr_and_bit</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">bit</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if BITS_PER_LONG == 64</span>
	<span class="o">*</span><span class="n">bit</span> <span class="o">+=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">7UL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7UL</span><span class="p">);</span>
<span class="cp">#elif BITS_PER_LONG == 32</span>
	<span class="o">*</span><span class="n">bit</span> <span class="o">+=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3UL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3UL</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;how many bits you are?!&quot;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mb_test_bit</span><span class="p">(</span><span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * ext4_test_bit on architecture like powerpc</span>
<span class="cm">	 * needs unsigned long aligned address</span>
<span class="cm">	 */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">mb_correct_addr_and_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bit</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ext4_test_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mb_set_bit</span><span class="p">(</span><span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">mb_correct_addr_and_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bit</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">ext4_set_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mb_clear_bit</span><span class="p">(</span><span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">mb_correct_addr_and_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bit</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">ext4_clear_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mb_find_next_zero_bit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">tmpmax</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">mb_correct_addr_and_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fix</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">tmpmax</span> <span class="o">=</span> <span class="n">max</span> <span class="o">+</span> <span class="n">fix</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">+=</span> <span class="n">fix</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_find_next_zero_bit</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">tmpmax</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span> <span class="o">-</span> <span class="n">fix</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mb_find_next_bit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">tmpmax</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">mb_correct_addr_and_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fix</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">tmpmax</span> <span class="o">=</span> <span class="n">max</span> <span class="o">+</span> <span class="n">fix</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">+=</span> <span class="n">fix</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_find_next_bit</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">tmpmax</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span> <span class="o">-</span> <span class="n">fix</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">mb_find_buddy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">order</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bb</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span> <span class="o">==</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">max</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">&gt;</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_blkbits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* at order 0 we see each particular block */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_blkbits</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bb</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy</span> <span class="o">+</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mb_offsets</span><span class="p">[</span><span class="n">order</span><span class="p">];</span>
	<span class="o">*</span><span class="n">max</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mb_maxs</span><span class="p">[</span><span class="n">order</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">bb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DOUBLE_CHECK</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mb_free_blocks_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_bitmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">assert_spin_locked</span><span class="p">(</span><span class="n">ext4_group_lock_ptr</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_bitmap</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_fsblk_t</span> <span class="n">blocknr</span><span class="p">;</span>

			<span class="n">blocknr</span> <span class="o">=</span> <span class="n">ext4_group_first_block_no</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">);</span>
			<span class="n">blocknr</span> <span class="o">+=</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span> <span class="n">first</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ext4_grp_locked_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">,</span>
					      <span class="n">inode</span> <span class="o">?</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="n">blocknr</span><span class="p">,</span>
					      <span class="s">&quot;freeing block already freed &quot;</span>
					      <span class="s">&quot;(bit %u)&quot;</span><span class="p">,</span>
					      <span class="n">first</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mb_clear_bit</span><span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_bitmap</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mb_mark_used_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_bitmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">assert_spin_locked</span><span class="p">(</span><span class="n">ext4_group_lock_ptr</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_bitmap</span><span class="p">));</span>
		<span class="n">mb_set_bit</span><span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_bitmap</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mb_cmp_bitmaps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_bitmap</span><span class="p">,</span> <span class="n">bitmap</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b1</span><span class="p">,</span> <span class="o">*</span><span class="n">b2</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">b1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_bitmap</span><span class="p">;</span>
		<span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">bitmap</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">b2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">ext4_msg</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
					 <span class="s">&quot;corruption in group %u &quot;</span>
					 <span class="s">&quot;at byte %u(%u): %x in copy != %x &quot;</span>
					 <span class="s">&quot;on disk/prealloc&quot;</span><span class="p">,</span>
					 <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">b2</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">BUG</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mb_free_blocks_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mb_mark_used_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mb_cmp_bitmaps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef AGGRESSIVE_CHECK</span>

<span class="cp">#define MB_CHECK_ASSERT(assert)						\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (!(assert)) {						\</span>
<span class="cp">		printk(KERN_EMERG					\</span>
<span class="cp">			&quot;Assertion failure in %s() at %s:%d: \&quot;%s\&quot;\n&quot;,	\</span>
<span class="cp">			function, file, line, # assert);		\</span>
<span class="cp">		BUG();							\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__mb_check_buddy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">order</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_blkbits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fragments</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fstart</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buddy</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buddy2</span><span class="p">;</span>

	<span class="p">{</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">mb_check_counter</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mb_check_counter</span><span class="o">++</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">order</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buddy</span> <span class="o">=</span> <span class="n">mb_find_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>
		<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span><span class="n">buddy</span><span class="p">);</span>
		<span class="n">buddy2</span> <span class="o">=</span> <span class="n">mb_find_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">order</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max2</span><span class="p">);</span>
		<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span><span class="n">buddy2</span><span class="p">);</span>
		<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span><span class="n">buddy</span> <span class="o">!=</span> <span class="n">buddy2</span><span class="p">);</span>
		<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span><span class="n">max</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">max2</span><span class="p">);</span>

		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">buddy</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* only single bit in buddy2 may be 1 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buddy2</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span>
						<span class="n">mb_test_bit</span><span class="p">((</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">buddy2</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mb_test_bit</span><span class="p">((</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buddy2</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span>
						<span class="n">mb_test_bit</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buddy2</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* both bits in buddy2 must be 1 */</span>
			<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buddy2</span><span class="p">));</span>
			<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span><span class="n">mb_test_bit</span><span class="p">((</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buddy2</span><span class="p">));</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">))</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
				<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span>
					<span class="o">!</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">[</span><span class="n">order</span><span class="p">]</span> <span class="o">==</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">order</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fstart</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">buddy</span> <span class="o">=</span> <span class="n">mb_find_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">buddy</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_first_free</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fstart</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fragments</span><span class="o">++</span><span class="p">;</span>
				<span class="n">fstart</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fstart</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* check used bits only */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_blkbits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buddy2</span> <span class="o">=</span> <span class="n">mb_find_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max2</span><span class="p">);</span>
			<span class="n">k</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="n">j</span><span class="p">;</span>
			<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">max2</span><span class="p">);</span>
			<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">buddy2</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">EXT4_MB_GRP_NEED_INIT</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="p">));</span>
	<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_fragments</span> <span class="o">==</span> <span class="n">fragments</span><span class="p">);</span>

	<span class="n">grp</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_prealloc_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_group_t</span> <span class="n">groupnr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">;</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_prealloc_space</span><span class="p">,</span> <span class="n">pa_group_list</span><span class="p">);</span>
		<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">groupnr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">k</span><span class="p">);</span>
		<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span><span class="n">groupnr</span> <span class="o">==</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">MB_CHECK_ASSERT</span><span class="p">(</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">buddy</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#undef MB_CHECK_ASSERT</span>
<span class="cp">#define mb_check_buddy(e4b) __mb_check_buddy(e4b,	\</span>
<span class="cp">					__FILE__, __func__, __LINE__)</span>
<span class="cp">#else</span>
<span class="cp">#define mb_check_buddy(e4b)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Divide blocks started from @first with length @len into</span>
<span class="cm"> * smaller chunks with power of 2 blocks.</span>
<span class="cm"> * Clear the bits in bitmap which the blocks of the chunk(s) covered,</span>
<span class="cm"> * then increase bb_counters[] for corresponded chunk size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_mark_free_simple</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">buddy</span><span class="p">,</span> <span class="n">ext4_grpblk_t</span> <span class="n">first</span><span class="p">,</span> <span class="n">ext4_grpblk_t</span> <span class="n">len</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">min</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">chunk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">border</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">EXT4_CLUSTERS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>

	<span class="n">border</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* find how many blocks can be covered since this position */</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">first</span> <span class="o">|</span> <span class="n">border</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* find how many blocks of power 2 we need to mark */</span>
		<span class="n">min</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span>
			<span class="n">min</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
		<span class="n">chunk</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">min</span><span class="p">;</span>

		<span class="cm">/* mark multiblock chunks only */</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">[</span><span class="n">min</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">min</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mb_clear_bit</span><span class="p">(</span><span class="n">first</span> <span class="o">&gt;&gt;</span> <span class="n">min</span><span class="p">,</span>
				     <span class="n">buddy</span> <span class="o">+</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_offsets</span><span class="p">[</span><span class="n">min</span><span class="p">]);</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">chunk</span><span class="p">;</span>
		<span class="n">first</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cache the order of the largest free extent we have available in this block</span>
<span class="cm"> * group.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mb_set_largest_free_order</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_largest_free_order</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* uninit */</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_largest_free_order</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">void</span> <span class="nf">ext4_mb_generate_buddy</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">buddy</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">max</span> <span class="o">=</span> <span class="n">EXT4_CLUSTERS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">first</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">fragments</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">period</span> <span class="o">=</span> <span class="n">get_cycles</span><span class="p">();</span>

	<span class="cm">/* initialize buddy from bitmap which is aggregation</span>
<span class="cm">	 * of on-disk bitmap and preallocations */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">mb_find_next_zero_bit</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_first_free</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fragments</span><span class="o">++</span><span class="p">;</span>
		<span class="n">first</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">mb_find_next_bit</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">first</span><span class="p">;</span>
		<span class="n">free</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ext4_mb_mark_free_simple</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">buddy</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">grp</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">mb_find_next_zero_bit</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_fragments</span> <span class="o">=</span> <span class="n">fragments</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">free</span> <span class="o">!=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_free</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_grp_locked_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="s">&quot;%u clusters in bitmap, %u in gd&quot;</span><span class="p">,</span>
				      <span class="n">free</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_free</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we intent to continue, we consider group descritor</span>
<span class="cm">		 * corrupt and update bb_free using bitmap value</span>
<span class="cm">		 */</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_free</span> <span class="o">=</span> <span class="n">free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mb_set_largest_free_order</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">grp</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">EXT4_GROUP_INFO_NEED_INIT_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_state</span><span class="p">));</span>

	<span class="n">period</span> <span class="o">=</span> <span class="n">get_cycles</span><span class="p">()</span> <span class="o">-</span> <span class="n">period</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_bal_lock</span><span class="p">);</span>
	<span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mb_buddies_generated</span><span class="o">++</span><span class="p">;</span>
	<span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mb_generation_time</span> <span class="o">+=</span> <span class="n">period</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_bal_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The buddy information is attached the buddy cache inode</span>
<span class="cm"> * for convenience. The information regarding each group</span>
<span class="cm"> * is loaded via ext4_mb_load_buddy. The information involve</span>
<span class="cm"> * block bitmap and buddy information. The information are</span>
<span class="cm"> * stored in the inode as</span>
<span class="cm"> *</span>
<span class="cm"> * {                        page                        }</span>
<span class="cm"> * [ group 0 bitmap][ group 0 buddy] [group 1][ group 1]...</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * one block each for bitmap and buddy information.</span>
<span class="cm"> * So for each group we take up 2 blocks. A page can</span>
<span class="cm"> * contain blocks_per_page (PAGE_CACHE_SIZE / blocksize)  blocks.</span>
<span class="cm"> * So it can have information regarding groups_per_page which</span>
<span class="cm"> * is blocks_per_page/2</span>
<span class="cm"> *</span>
<span class="cm"> * Locking note:  This routine takes the block group lock of all groups</span>
<span class="cm"> * for this page; do not hold this lock when calling this routine!</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_mb_init_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">incore</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_group_t</span> <span class="n">ngroups</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blocks_per_page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">groups_per_page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">first_group</span><span class="p">,</span> <span class="n">group</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first_block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bhs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">**</span><span class="n">bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grinfo</span><span class="p">;</span>

	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;init page %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="n">inode</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="n">ngroups</span> <span class="o">=</span> <span class="n">ext4_get_groups_count</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">blocksize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">;</span>
	<span class="n">blocks_per_page</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">/</span> <span class="n">blocksize</span><span class="p">;</span>

	<span class="n">groups_per_page</span> <span class="o">=</span> <span class="n">blocks_per_page</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">groups_per_page</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">groups_per_page</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* allocate buffer_heads to read bitmaps */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">groups_per_page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">groups_per_page</span><span class="p">;</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bhs</span><span class="p">;</span>

	<span class="n">first_group</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">*</span> <span class="n">blocks_per_page</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* read all groups the page covers into the cache */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="n">first_group</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">groups_per_page</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">group</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">&gt;=</span> <span class="n">ngroups</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">grinfo</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If page is uptodate then we came here after online resize</span>
<span class="cm">		 * which added some new uninitialized group info structs, so</span>
<span class="cm">		 * we must skip all initialized uptodate buddies on the page,</span>
<span class="cm">		 * which may be currently in use by an allocating task.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">EXT4_MB_GRP_NEED_INIT</span><span class="p">(</span><span class="n">grinfo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext4_read_block_bitmap_nowait</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;read bitmap for group %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* wait for I/O completion */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="n">first_group</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">groups_per_page</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">group</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ext4_wait_block_bitmap</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">bh</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">first_block</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">*</span> <span class="n">blocks_per_page</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">blocks_per_page</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">group</span><span class="p">;</span>

		<span class="n">group</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_block</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">&gt;=</span> <span class="n">ngroups</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">[</span><span class="n">group</span> <span class="o">-</span> <span class="n">first_group</span><span class="p">])</span>
			<span class="cm">/* skip initialized uptodate buddy */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * data carry information regarding this</span>
<span class="cm">		 * particular group in the format specified</span>
<span class="cm">		 * above</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">blocksize</span><span class="p">);</span>
		<span class="n">bitmap</span> <span class="o">=</span> <span class="n">bh</span><span class="p">[</span><span class="n">group</span> <span class="o">-</span> <span class="n">first_group</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * We place the buddy block and bitmap block</span>
<span class="cm">		 * close together</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">first_block</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* this is block of buddy */</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">incore</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;put buddy for group %u in page %lu/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">group</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">blocksize</span><span class="p">);</span>
			<span class="n">trace_ext4_mb_buddy_bitmap_load</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
			<span class="n">grinfo</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
			<span class="n">grinfo</span><span class="o">-&gt;</span><span class="n">bb_fragments</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">grinfo</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">grinfo</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">)</span> <span class="o">*</span>
				<span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="o">+</span><span class="mi">2</span><span class="p">));</span>
			<span class="cm">/*</span>
<span class="cm">			 * incore got set to the group block bitmap below</span>
<span class="cm">			 */</span>
			<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
			<span class="cm">/* init the buddy */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
			<span class="n">ext4_mb_generate_buddy</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">incore</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
			<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
			<span class="n">incore</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* this is block of bitmap */</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">incore</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;put bitmap for group %u in page %lu/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">group</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">blocksize</span><span class="p">);</span>
			<span class="n">trace_ext4_mb_bitmap_load</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>

			<span class="cm">/* see comments in ext4_mb_put_pa() */</span>
			<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bitmap</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>

			<span class="cm">/* mark all preallocated blks used in in-core bitmap */</span>
			<span class="n">ext4_mb_generate_from_pa</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
			<span class="n">ext4_mb_generate_from_freelist</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
			<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>

			<span class="cm">/* set incore so that the buddy information can be</span>
<span class="cm">			 * generated using this</span>
<span class="cm">			 */</span>
			<span class="n">incore</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">groups_per_page</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bh</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">bhs</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Lock the buddy and bitmap pages. This make sure other parallel init_group</span>
<span class="cm"> * on the same buddy page doesn&#39;t happen whild holding the buddy page lock.</span>
<span class="cm"> * Return locked buddy and bitmap pages on e4b struct. If buddy and bitmap</span>
<span class="cm"> * are on the same page e4b-&gt;bd_buddy_page is NULL and return value is 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_mb_get_buddy_page_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
		<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_buddy_cache</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">block</span><span class="p">,</span> <span class="n">pnum</span><span class="p">,</span> <span class="n">poff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blocks_per_page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">blocks_per_page</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">/</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * the buddy cache inode stores the block bitmap</span>
<span class="cm">	 * and buddy information in consecutive blocks.</span>
<span class="cm">	 * So for each group we need two blocks.</span>
<span class="cm">	 */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">group</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">pnum</span> <span class="o">=</span> <span class="n">block</span> <span class="o">/</span> <span class="n">blocks_per_page</span><span class="p">;</span>
	<span class="n">poff</span> <span class="o">=</span> <span class="n">block</span> <span class="o">%</span> <span class="n">blocks_per_page</span><span class="p">;</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">find_or_create_page</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span> <span class="n">pnum</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">!=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">);</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">poff</span> <span class="o">*</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blocks_per_page</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* buddy and bitmap are on the same page */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">block</span><span class="o">++</span><span class="p">;</span>
	<span class="n">pnum</span> <span class="o">=</span> <span class="n">block</span> <span class="o">/</span> <span class="n">blocks_per_page</span><span class="p">;</span>
	<span class="n">poff</span> <span class="o">=</span> <span class="n">block</span> <span class="o">%</span> <span class="n">blocks_per_page</span><span class="p">;</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">find_or_create_page</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span> <span class="n">pnum</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">!=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">);</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_put_buddy_page_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unlock_page</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span><span class="p">);</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unlock_page</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span><span class="p">);</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Locking note:  This routine calls ext4_mb_init_cache(), which takes the</span>
<span class="cm"> * block group lock of all groups for this page; do not hold the BG lock when</span>
<span class="cm"> * calling this routine!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">int</span> <span class="nf">ext4_mb_init_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">this_grp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="n">e4b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;init group %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="n">this_grp</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * This ensures that we don&#39;t reinit the buddy cache</span>
<span class="cm">	 * page which map to the group from which we are already</span>
<span class="cm">	 * allocating. If we are looking at the buddy cache we would</span>
<span class="cm">	 * have taken a reference using ext4_mb_load_buddy and that</span>
<span class="cm">	 * would have pinned buddy page to page cache.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_mb_get_buddy_page_lock</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="o">!</span><span class="n">EXT4_MB_GRP_NEED_INIT</span><span class="p">(</span><span class="n">this_grp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * somebody initialized the group</span>
<span class="cm">		 * return without doing anything</span>
<span class="cm">		 */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">e4b</span><span class="p">.</span><span class="n">bd_bitmap_page</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_mb_init_cache</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mark_page_accessed</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e4b</span><span class="p">.</span><span class="n">bd_buddy_page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If both the bitmap and buddy are in</span>
<span class="cm">		 * the same page we don&#39;t need to force</span>
<span class="cm">		 * init the buddy</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* init buddy cache */</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">e4b</span><span class="p">.</span><span class="n">bd_buddy_page</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_mb_init_cache</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">e4b</span><span class="p">.</span><span class="n">bd_bitmap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mark_page_accessed</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">ext4_mb_put_buddy_page_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Locking note:  This routine calls ext4_mb_init_cache(), which takes the</span>
<span class="cm"> * block group lock of all groups for this page; do not hold the BG lock when</span>
<span class="cm"> * calling this routine!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span>
<span class="nf">ext4_mb_load_buddy</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">blocks_per_page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">block</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pnum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">poff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_buddy_cache</span><span class="p">;</span>

	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;load group %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>

	<span class="n">blocks_per_page</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">/</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="n">grp</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>

	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_blkbits</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">;</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span> <span class="o">=</span> <span class="n">grp</span><span class="p">;</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span> <span class="o">=</span> <span class="n">sb</span><span class="p">;</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span> <span class="o">=</span> <span class="n">group</span><span class="p">;</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">EXT4_MB_GRP_NEED_INIT</span><span class="p">(</span><span class="n">grp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * we need full data about the group</span>
<span class="cm">		 * to make a good selection</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_mb_init_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * the buddy cache inode stores the block bitmap</span>
<span class="cm">	 * and buddy information in consecutive blocks.</span>
<span class="cm">	 * So for each group we need two blocks.</span>
<span class="cm">	 */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">group</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">pnum</span> <span class="o">=</span> <span class="n">block</span> <span class="o">/</span> <span class="n">blocks_per_page</span><span class="p">;</span>
	<span class="n">poff</span> <span class="o">=</span> <span class="n">block</span> <span class="o">%</span> <span class="n">blocks_per_page</span><span class="p">;</span>

	<span class="cm">/* we could use find_or_create_page(), but it locks page</span>
<span class="cm">	 * what we&#39;d like to avoid in fast path ... */</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">find_get_page</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span> <span class="n">pnum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * drop the page reference and try</span>
<span class="cm">			 * to get the page with lock. If we</span>
<span class="cm">			 * are not uptodate that implies</span>
<span class="cm">			 * somebody just created the page but</span>
<span class="cm">			 * is yet to initialize the same. So</span>
<span class="cm">			 * wait for it to initialize.</span>
<span class="cm">			 */</span>
			<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">find_or_create_page</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span> <span class="n">pnum</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">!=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_mb_init_cache</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">mb_cmp_bitmaps</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span>
					       <span class="p">(</span><span class="n">poff</span> <span class="o">*</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">poff</span> <span class="o">*</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
	<span class="n">mark_page_accessed</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="n">block</span><span class="o">++</span><span class="p">;</span>
	<span class="n">pnum</span> <span class="o">=</span> <span class="n">block</span> <span class="o">/</span> <span class="n">blocks_per_page</span><span class="p">;</span>
	<span class="n">poff</span> <span class="o">=</span> <span class="n">block</span> <span class="o">%</span> <span class="n">blocks_per_page</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">find_get_page</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span> <span class="n">pnum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span>
			<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">find_or_create_page</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span> <span class="n">pnum</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">!=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_mb_init_cache</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">poff</span> <span class="o">*</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
	<span class="n">mark_page_accessed</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span><span class="p">)</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span><span class="p">)</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span><span class="p">);</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_unload_buddy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span><span class="p">)</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span><span class="p">)</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mb_find_order_for_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">bb</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span> <span class="o">==</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">block</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_blkbits</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)));</span>

	<span class="n">bb</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">order</span> <span class="o">&lt;=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_blkbits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">bb</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* this block is part of buddy of order &#39;order&#39; */</span>
			<span class="k">return</span> <span class="n">order</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bb</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_blkbits</span> <span class="o">-</span> <span class="n">order</span><span class="p">);</span>
		<span class="n">order</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mb_clear_bits</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cur</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cur</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">cur</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* fast path: clear whole word at once */</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">bm</span> <span class="o">+</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cur</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mb_clear_bit</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bm</span><span class="p">);</span>
		<span class="n">cur</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_set_bits</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cur</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cur</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">cur</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* fast path: set whole word at once */</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">bm</span> <span class="o">+</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
			<span class="n">cur</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mb_set_bit</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bm</span><span class="p">);</span>
		<span class="n">cur</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mb_free_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">order</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buddy</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buddy2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="n">assert_spin_locked</span><span class="p">(</span><span class="n">ext4_group_lock_ptr</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">));</span>
	<span class="n">mb_check_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">);</span>
	<span class="n">mb_free_blocks_double</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">e4b</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_free</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">&lt;</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_first_free</span><span class="p">)</span>
		<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_first_free</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>

	<span class="cm">/* let&#39;s maintain fragments counter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">block</span> <span class="o">=</span> <span class="o">!</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">first</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mb_maxs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">max</span> <span class="o">=</span> <span class="o">!</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">&amp;&amp;</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_fragments</span><span class="o">--</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">block</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">max</span><span class="p">)</span>
		<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_fragments</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* let&#39;s maintain buddy itself */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">first</span><span class="o">++</span><span class="p">;</span>
		<span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_fsblk_t</span> <span class="n">blocknr</span><span class="p">;</span>

			<span class="n">blocknr</span> <span class="o">=</span> <span class="n">ext4_group_first_block_no</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">);</span>
			<span class="n">blocknr</span> <span class="o">+=</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span> <span class="n">block</span><span class="p">);</span>
			<span class="n">ext4_grp_locked_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">,</span>
					      <span class="n">inode</span> <span class="o">?</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="n">blocknr</span><span class="p">,</span>
					      <span class="s">&quot;freeing already freed block &quot;</span>
					      <span class="s">&quot;(bit %u)&quot;</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mb_clear_bit</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span><span class="p">);</span>
		<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* start of the buddy */</span>
		<span class="n">buddy</span> <span class="o">=</span> <span class="n">mb_find_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">block</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1UL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">buddy</span><span class="p">)</span> <span class="o">||</span>
					<span class="n">mb_test_bit</span><span class="p">(</span><span class="n">block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buddy</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* both the buddies are free, try to coalesce them */</span>
			<span class="n">buddy2</span> <span class="o">=</span> <span class="n">mb_find_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buddy2</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* for special purposes, we don&#39;t set</span>
<span class="cm">				 * free bits in bitmap */</span>
				<span class="n">mb_set_bit</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">buddy</span><span class="p">);</span>
				<span class="n">mb_set_bit</span><span class="p">(</span><span class="n">block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buddy</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
			<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>

			<span class="n">block</span> <span class="o">=</span> <span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">order</span><span class="o">++</span><span class="p">;</span>
			<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

			<span class="n">mb_clear_bit</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">buddy2</span><span class="p">);</span>
			<span class="n">buddy</span> <span class="o">=</span> <span class="n">buddy2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mb_set_largest_free_order</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="p">);</span>
	<span class="n">mb_check_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mb_find_extent</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">order</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">needed</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_free_extent</span> <span class="o">*</span><span class="n">ex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buddy</span><span class="p">;</span>

	<span class="n">assert_spin_locked</span><span class="p">(</span><span class="n">ext4_group_lock_ptr</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ex</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">buddy</span> <span class="o">=</span> <span class="n">mb_find_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buddy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">block</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">buddy</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME dorp order completely ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">order</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* find actual order */</span>
		<span class="n">order</span> <span class="o">=</span> <span class="n">mb_find_order_for_block</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="n">order</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">;</span>
	<span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_start</span> <span class="o">=</span> <span class="n">block</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">;</span>
	<span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_group</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">;</span>

	<span class="cm">/* calc difference from given start */</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">next</span> <span class="o">-</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_start</span><span class="p">;</span>
	<span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">-=</span> <span class="n">next</span><span class="p">;</span>
	<span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_start</span> <span class="o">+=</span> <span class="n">next</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">needed</span> <span class="o">&gt;</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">buddy</span> <span class="o">=</span> <span class="n">mb_find_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">)))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">order</span> <span class="o">=</span> <span class="n">mb_find_order_for_block</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>

		<span class="n">block</span> <span class="o">=</span> <span class="n">next</span> <span class="o">&gt;&gt;</span> <span class="n">order</span><span class="p">;</span>
		<span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_start</span> <span class="o">+</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_blkbits</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)));</span>
	<span class="k">return</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mb_mark_used</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_free_extent</span> <span class="o">*</span><span class="n">ex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ord</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len0</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buddy</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span> <span class="o">!=</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_group</span><span class="p">);</span>
	<span class="n">assert_spin_locked</span><span class="p">(</span><span class="n">ext4_group_lock_ptr</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">));</span>
	<span class="n">mb_check_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">);</span>
	<span class="n">mb_mark_used_double</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_free</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_first_free</span> <span class="o">==</span> <span class="n">start</span><span class="p">)</span>
		<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_first_free</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* let&#39;s maintain fragments counter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mlen</span> <span class="o">=</span> <span class="o">!</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mb_maxs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">max</span> <span class="o">=</span> <span class="o">!</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlen</span> <span class="o">&amp;&amp;</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_fragments</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlen</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">max</span><span class="p">)</span>
		<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_fragments</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/* let&#39;s maintain buddy itself */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ord</span> <span class="o">=</span> <span class="n">mb_find_order_for_block</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="n">ord</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ord</span><span class="p">)</span> <span class="o">==</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ord</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* the whole chunk may be allocated at once! */</span>
			<span class="n">mlen</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ord</span><span class="p">;</span>
			<span class="n">buddy</span> <span class="o">=</span> <span class="n">mb_find_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">ord</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">((</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="n">ord</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="p">);</span>
			<span class="n">mb_set_bit</span><span class="p">(</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="n">ord</span><span class="p">,</span> <span class="n">buddy</span><span class="p">);</span>
			<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">[</span><span class="n">ord</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
			<span class="n">start</span> <span class="o">+=</span> <span class="n">mlen</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">mlen</span><span class="p">;</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* store for history */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">len</span> <span class="o">|</span> <span class="p">(</span><span class="n">ord</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="cm">/* we have to split large buddy */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ord</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">buddy</span> <span class="o">=</span> <span class="n">mb_find_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">ord</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>
		<span class="n">mb_set_bit</span><span class="p">(</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="n">ord</span><span class="p">,</span> <span class="n">buddy</span><span class="p">);</span>
		<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">[</span><span class="n">ord</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>

		<span class="n">ord</span><span class="o">--</span><span class="p">;</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="n">ord</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1U</span><span class="p">;</span>
		<span class="n">buddy</span> <span class="o">=</span> <span class="n">mb_find_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">ord</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>
		<span class="n">mb_clear_bit</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">buddy</span><span class="p">);</span>
		<span class="n">mb_clear_bit</span><span class="p">(</span><span class="n">cur</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buddy</span><span class="p">);</span>
		<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">[</span><span class="n">ord</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">[</span><span class="n">ord</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mb_set_largest_free_order</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="p">);</span>

	<span class="n">ext4_set_bits</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span><span class="p">,</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_start</span><span class="p">,</span> <span class="n">len0</span><span class="p">);</span>
	<span class="n">mb_check_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Must be called under group lock!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_use_best_found</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span> <span class="o">!=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">==</span> <span class="n">AC_STATUS_FOUND</span><span class="p">);</span>

	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_logical</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mb_mark_used</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">);</span>

	<span class="cm">/* preallocation can change ac_b_ex, thus we store actually</span>
<span class="cm">	 * allocated blocks for history */</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_f_ex</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">;</span>

	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">=</span> <span class="n">AC_STATUS_FOUND</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_tail</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_buddy</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * take the page reference. We want the page to be pinned</span>
<span class="cm">	 * so that we don&#39;t get a ext4_mb_init_cache_call for this</span>
<span class="cm">	 * group until we update the bitmap. That would mean we</span>
<span class="cm">	 * double allocate blocks. The reference is dropped</span>
<span class="cm">	 * in ext4_mb_release_context</span>
<span class="cm">	 */</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_bitmap_page</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span><span class="p">;</span>
	<span class="n">get_page</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_bitmap_page</span><span class="p">);</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_buddy_page</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span><span class="p">;</span>
	<span class="n">get_page</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_buddy_page</span><span class="p">);</span>
	<span class="cm">/* store last allocated for subsequent stream allocation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_STREAM_ALLOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_md_lock</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_last_group</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_f_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">;</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_last_start</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_f_ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_md_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * regular allocator, for general purposes allocation</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_check_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">finish_group</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_free_extent</span> <span class="o">*</span><span class="n">bex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_free_extent</span> <span class="o">*</span><span class="n">gex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_free_extent</span> <span class="n">ex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">==</span> <span class="n">AC_STATUS_FOUND</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t want to scan for a whole year</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_found</span> <span class="o">&gt;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_max_to_scan</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_FIRST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">=</span> <span class="n">AC_STATUS_BREAK</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Haven&#39;t found good chunk so far, let&#39;s continue</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">&lt;</span> <span class="n">gex</span><span class="o">-&gt;</span><span class="n">fe_len</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">finish_group</span> <span class="o">||</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_found</span> <span class="o">&gt;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_min_to_scan</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="n">bex</span><span class="o">-&gt;</span><span class="n">fe_group</span> <span class="o">==</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* recheck chunk&#39;s availability - we don&#39;t know</span>
<span class="cm">		 * when it was found (within this lock-unlock</span>
<span class="cm">		 * period or not) */</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">mb_find_extent</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bex</span><span class="o">-&gt;</span><span class="n">fe_start</span><span class="p">,</span> <span class="n">gex</span><span class="o">-&gt;</span><span class="n">fe_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&gt;=</span> <span class="n">gex</span><span class="o">-&gt;</span><span class="n">fe_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_mb_use_best_found</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">e4b</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The routine checks whether found extent is good enough. If it is,</span>
<span class="cm"> * then the extent gets marked used and flag is set to the context</span>
<span class="cm"> * to stop scanning. Otherwise, the extent is compared with the</span>
<span class="cm"> * previous found extent and if new one is better, then it&#39;s stored</span>
<span class="cm"> * in the context. Later, the best found extent will be used, if</span>
<span class="cm"> * mballoc can&#39;t find good enough extent.</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: real allocation policy is to be designed yet!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_measure_extent</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ext4_free_extent</span> <span class="o">*</span><span class="n">ex</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_free_extent</span> <span class="o">*</span><span class="n">bex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_free_extent</span> <span class="o">*</span><span class="n">gex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">&gt;</span> <span class="n">EXT4_CLUSTERS_PER_GROUP</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_start</span> <span class="o">&gt;=</span> <span class="n">EXT4_CLUSTERS_PER_GROUP</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">!=</span> <span class="n">AC_STATUS_CONTINUE</span><span class="p">);</span>

	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_found</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The special case - take what you catch first</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_FIRST</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">bex</span> <span class="o">=</span> <span class="o">*</span><span class="n">ex</span><span class="p">;</span>
		<span class="n">ext4_mb_use_best_found</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">e4b</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Let&#39;s check whether the chuck is good enough</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">==</span> <span class="n">gex</span><span class="o">-&gt;</span><span class="n">fe_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">bex</span> <span class="o">=</span> <span class="o">*</span><span class="n">ex</span><span class="p">;</span>
		<span class="n">ext4_mb_use_best_found</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">e4b</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this is first found extent, just store it in the context</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">bex</span> <span class="o">=</span> <span class="o">*</span><span class="n">ex</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If new found extent is better, store it in the context</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">&lt;</span> <span class="n">gex</span><span class="o">-&gt;</span><span class="n">fe_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if the request isn&#39;t satisfied, any found extent</span>
<span class="cm">		 * larger than previous best one is better */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">&gt;</span> <span class="n">bex</span><span class="o">-&gt;</span><span class="n">fe_len</span><span class="p">)</span>
			<span class="o">*</span><span class="n">bex</span> <span class="o">=</span> <span class="o">*</span><span class="n">ex</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">&gt;</span> <span class="n">gex</span><span class="o">-&gt;</span><span class="n">fe_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if the request is satisfied, then we try to find</span>
<span class="cm">		 * an extent that still satisfy the request, but is</span>
<span class="cm">		 * smaller than previous one */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">fe_len</span> <span class="o">&lt;</span> <span class="n">bex</span><span class="o">-&gt;</span><span class="n">fe_len</span><span class="p">)</span>
			<span class="o">*</span><span class="n">bex</span> <span class="o">=</span> <span class="o">*</span><span class="n">ex</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ext4_mb_check_limits</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">e4b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">int</span> <span class="nf">ext4_mb_try_best_found</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_free_extent</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">group</span> <span class="o">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_mb_load_buddy</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">e4b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">mb_find_extent</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span> <span class="o">=</span> <span class="n">ex</span><span class="p">;</span>
		<span class="n">ext4_mb_use_best_found</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">e4b</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="n">ext4_mb_unload_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">int</span> <span class="nf">ext4_mb_find_by_goal</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_group_t</span> <span class="n">group</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_free_extent</span> <span class="n">ex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_TRY_GOAL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_mb_load_buddy</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">e4b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">mb_find_extent</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">,</span>
			     <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&gt;=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">==</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_fsblk_t</span> <span class="n">start</span><span class="p">;</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">ext4_group_first_block_no</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">;</span>
		<span class="cm">/* use do_div to get remainder (would be 64-bit modulo) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_div</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_found</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span> <span class="o">=</span> <span class="n">ex</span><span class="p">;</span>
			<span class="n">ext4_mb_use_best_found</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">e4b</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&gt;=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">fe_group</span> <span class="o">!=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">fe_start</span> <span class="o">!=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">);</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_found</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span> <span class="o">=</span> <span class="n">ex</span><span class="p">;</span>
		<span class="n">ext4_mb_use_best_found</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">e4b</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_MERGE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Sometimes, caller may want to merge even small</span>
<span class="cm">		 * number of blocks to an existing extent */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">fe_group</span> <span class="o">!=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">fe_start</span> <span class="o">!=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">);</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_found</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span> <span class="o">=</span> <span class="n">ex</span><span class="p">;</span>
		<span class="n">ext4_mb_use_best_found</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">e4b</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="n">ext4_mb_unload_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The routine scans buddy structures (not bitmap!) from given order</span>
<span class="cm"> * to max order and tries to find big enough chunk to satisfy the req</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">void</span> <span class="nf">ext4_mb_simple_scan_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buddy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_2order</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_2order</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_counters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">buddy</span> <span class="o">=</span> <span class="n">mb_find_buddy</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buddy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">k</span> <span class="o">=</span> <span class="n">mb_find_next_zero_bit</span><span class="p">(</span><span class="n">buddy</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="p">);</span>

		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_found</span><span class="o">++</span><span class="p">;</span>

		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_start</span> <span class="o">=</span> <span class="n">k</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">;</span>

		<span class="n">ext4_mb_use_best_found</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">e4b</span><span class="p">);</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">!=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mb_stats</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_bal_2orders</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The routine scans the group and measures all found extents.</span>
<span class="cm"> * In order to optimize scanning, caller must pass number of</span>
<span class="cm"> * free blocks in the group, so the routine can know upper limit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">void</span> <span class="nf">ext4_mb_complex_scan_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_free_extent</span> <span class="n">ex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free</span><span class="p">;</span>

	<span class="n">free</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_free</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">free</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_first_free</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">free</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">==</span> <span class="n">AC_STATUS_CONTINUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">mb_find_next_zero_bit</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span>
						<span class="n">EXT4_CLUSTERS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">EXT4_CLUSTERS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * IF we have corrupt bitmap, we won&#39;t find any</span>
<span class="cm">			 * free blocks even though group info says we</span>
<span class="cm">			 * we have free blocks</span>
<span class="cm">			 */</span>
			<span class="n">ext4_grp_locked_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;%d free clusters as per &quot;</span>
					<span class="s">&quot;group info. But bitmap says 0&quot;</span><span class="p">,</span>
					<span class="n">free</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mb_find_extent</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">free</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_grp_locked_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;%d free clusters as per &quot;</span>
					<span class="s">&quot;group info. But got %d blocks&quot;</span><span class="p">,</span>
					<span class="n">free</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * The number of free blocks differs. This mostly</span>
<span class="cm">			 * indicate that the bitmap is corrupt. So exit</span>
<span class="cm">			 * without claiming the space.</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ext4_mb_measure_extent</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">,</span> <span class="n">e4b</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">;</span>
		<span class="n">free</span> <span class="o">-=</span> <span class="n">ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ext4_mb_check_limits</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">e4b</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is a special case for storages like raid5</span>
<span class="cm"> * we try to find stripe-aligned chunks for stripe-size-multiple requests</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">void</span> <span class="nf">ext4_mb_scan_aligned</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_free_extent</span> <span class="n">ex</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">first_group_block</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">a</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* find first stripe-aligned block in group */</span>
	<span class="n">first_group_block</span> <span class="o">=</span> <span class="n">ext4_group_first_block_no</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">);</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">first_group_block</span> <span class="o">+</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span><span class="p">)</span> <span class="o">-</span> <span class="n">first_group_block</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">EXT4_CLUSTERS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">bitmap</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">max</span> <span class="o">=</span> <span class="n">mb_find_extent</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&gt;=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_found</span><span class="o">++</span><span class="p">;</span>
				<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span> <span class="o">=</span> <span class="n">ex</span><span class="p">;</span>
				<span class="n">ext4_mb_use_best_found</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">e4b</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* This is now called BEFORE we load the buddy bitmap. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_mb_good_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
				<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">free</span><span class="p">,</span> <span class="n">fragments</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flex_size</span> <span class="o">=</span> <span class="n">ext4_flex_bg_size</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">cr</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cr</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* We only do this if the grp has never been initialized */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">EXT4_MB_GRP_NEED_INIT</span><span class="p">(</span><span class="n">grp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_mb_init_group</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free</span> <span class="o">=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_free</span><span class="p">;</span>
	<span class="n">fragments</span> <span class="o">=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_fragments</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fragments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_2order</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_largest_free_order</span> <span class="o">&lt;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_2order</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Avoid using the first bg of a flexgroup for data files */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_DATA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">flex_size</span> <span class="o">&gt;=</span> <span class="n">EXT4_FLEX_SIZE_DIR_ALLOC_SCHEME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">group</span> <span class="o">%</span> <span class="n">flex_size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">free</span> <span class="o">/</span> <span class="n">fragments</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">free</span> <span class="o">&gt;=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span>
<span class="nf">ext4_mb_regular_allocator</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_group_t</span> <span class="n">ngroups</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="n">e4b</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">;</span>
	<span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">ngroups</span> <span class="o">=</span> <span class="n">ext4_get_groups_count</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="cm">/* non-extent files are limited to low blocks/groups */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ext4_test_inode_flag</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_inode</span><span class="p">,</span> <span class="n">EXT4_INODE_EXTENTS</span><span class="p">)))</span>
		<span class="n">ngroups</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blockfile_groups</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">==</span> <span class="n">AC_STATUS_FOUND</span><span class="p">);</span>

	<span class="cm">/* first, try the goal */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_mb_find_by_goal</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">==</span> <span class="n">AC_STATUS_FOUND</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_GOAL_ONLY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ac-&gt;ac2_order is set only if the fe_len is a power of 2</span>
<span class="cm">	 * if ac2_order is set we also set criteria to 0 so that we</span>
<span class="cm">	 * try exact allocation using buddy.</span>
<span class="cm">	 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_2order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We search using buddy data only if the order of the request</span>
<span class="cm">	 * is greater than equal to the sbi_s_mb_order2_reqs</span>
<span class="cm">	 * You can tune it via /sys/fs/ext4/&lt;partition&gt;/mb_order2_req</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_order2_reqs</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This should tell if fe_len is exactly power of 2</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_2order</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if stream allocation is enabled, use global goal */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_STREAM_ALLOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TBD: may be hot point */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_md_lock</span><span class="p">);</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_group</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_last_group</span><span class="p">;</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_start</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_last_start</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_md_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Let&#39;s just scan groups to find more-less suitable blocks */</span>
	<span class="n">cr</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_2order</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * cr == 0 try to get exact allocation,</span>
<span class="cm">	 * cr == 3  try to get anything</span>
<span class="cm">	 */</span>
<span class="nl">repeat:</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">cr</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">==</span> <span class="n">AC_STATUS_CONTINUE</span><span class="p">;</span> <span class="n">cr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_criteria</span> <span class="o">=</span> <span class="n">cr</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * searching for the right group start</span>
<span class="cm">		 * from the goal value specified</span>
<span class="cm">		 */</span>
		<span class="n">group</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ngroups</span><span class="p">;</span> <span class="n">group</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">==</span> <span class="n">ngroups</span><span class="p">)</span>
				<span class="n">group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* This now checks without needing the buddy page */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_mb_good_group</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">cr</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_mb_load_buddy</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * We need to check again after locking the</span>
<span class="cm">			 * block group</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_mb_good_group</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">cr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
				<span class="n">ext4_mb_unload_buddy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_groups_scanned</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ext4_mb_simple_scan_group</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">%</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span><span class="p">))</span>
				<span class="n">ext4_mb_scan_aligned</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ext4_mb_complex_scan_group</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>

			<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
			<span class="n">ext4_mb_unload_buddy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">!=</span> <span class="n">AC_STATUS_CONTINUE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">!=</span> <span class="n">AC_STATUS_FOUND</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_FIRST</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We&#39;ve been searching too long. Let&#39;s try to allocate</span>
<span class="cm">		 * the best chunk we&#39;ve found so far</span>
<span class="cm">		 */</span>

		<span class="n">ext4_mb_try_best_found</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">!=</span> <span class="n">AC_STATUS_FOUND</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Someone more lucky has already allocated it.</span>
<span class="cm">			 * The only thing we can do is just take first</span>
<span class="cm">			 * found block(s)</span>
<span class="cm">			printk(KERN_DEBUG &quot;EXT4-fs: someone won our chunk\n&quot;);</span>
<span class="cm">			 */</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">=</span> <span class="n">AC_STATUS_CONTINUE</span><span class="p">;</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">|=</span> <span class="n">EXT4_MB_HINT_FIRST</span><span class="p">;</span>
			<span class="n">cr</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_lost_chunks</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ext4_mb_seq_groups_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">ext4_get_groups_count</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">group</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">group</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ext4_mb_seq_groups_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">;</span>

	<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">ext4_get_groups_count</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">group</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">group</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_mb_seq_groups_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">group</span> <span class="o">=</span> <span class="p">(</span><span class="n">ext4_group_t</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">v</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="n">e4b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sg</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="n">info</span><span class="p">;</span>
		<span class="n">ext4_grpblk_t</span> <span class="n">counters</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">sg</span><span class="p">;</span>

	<span class="n">group</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;#%-5s: %-5s %-5s %-5s &quot;</span>
				<span class="s">&quot;[ %-5s %-5s %-5s %-5s %-5s %-5s %-5s &quot;</span>
				  <span class="s">&quot;%-5s %-5s %-5s %-5s %-5s %-5s %-5s ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;group&quot;</span><span class="p">,</span> <span class="s">&quot;free&quot;</span><span class="p">,</span> <span class="s">&quot;frags&quot;</span><span class="p">,</span> <span class="s">&quot;first&quot;</span><span class="p">,</span>
			   <span class="s">&quot;2^0&quot;</span><span class="p">,</span> <span class="s">&quot;2^1&quot;</span><span class="p">,</span> <span class="s">&quot;2^2&quot;</span><span class="p">,</span> <span class="s">&quot;2^3&quot;</span><span class="p">,</span> <span class="s">&quot;2^4&quot;</span><span class="p">,</span> <span class="s">&quot;2^5&quot;</span><span class="p">,</span> <span class="s">&quot;2^6&quot;</span><span class="p">,</span>
			   <span class="s">&quot;2^7&quot;</span><span class="p">,</span> <span class="s">&quot;2^8&quot;</span><span class="p">,</span> <span class="s">&quot;2^9&quot;</span><span class="p">,</span> <span class="s">&quot;2^10&quot;</span><span class="p">,</span> <span class="s">&quot;2^11&quot;</span><span class="p">,</span> <span class="s">&quot;2^12&quot;</span><span class="p">,</span> <span class="s">&quot;2^13&quot;</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sg</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">bb_counters</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_group_info</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_mb_load_buddy</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;#%-5u: I/O error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="n">ext4_mb_unload_buddy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;#%-5u: %-5u %-5u %-5u [&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">sg</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">bb_free</span><span class="p">,</span>
			<span class="n">sg</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">bb_fragments</span><span class="p">,</span> <span class="n">sg</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">bb_first_free</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">13</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %-5u&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">?</span>
				<span class="n">sg</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">bb_counters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_seq_groups_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">ext4_mb_seq_groups_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="n">ext4_mb_seq_groups_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>   <span class="o">=</span> <span class="n">ext4_mb_seq_groups_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>   <span class="o">=</span> <span class="n">ext4_mb_seq_groups_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>   <span class="o">=</span> <span class="n">ext4_mb_seq_groups_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_mb_seq_groups_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext4_mb_seq_groups_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">sb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ext4_mb_seq_groups_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ext4_mb_seq_groups_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="nf">get_groupinfo_cache</span><span class="p">(</span><span class="kt">int</span> <span class="n">blocksize_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cache_index</span> <span class="o">=</span> <span class="n">blocksize_bits</span> <span class="o">-</span> <span class="n">EXT4_MIN_BLOCK_LOG_SIZE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">cachep</span> <span class="o">=</span> <span class="n">ext4_groupinfo_caches</span><span class="p">[</span><span class="n">cache_index</span><span class="p">];</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cachep</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cachep</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Create and initialize ext4_group_info data for the given group. */</span>
<span class="kt">int</span> <span class="nf">ext4_mb_add_groupinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">metalen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">**</span><span class="n">meta_group_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">cachep</span> <span class="o">=</span> <span class="n">get_groupinfo_cache</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * First check if this group is the first of a reserved block.</span>
<span class="cm">	 * If it&#39;s true, we have to allocate a new table of pointers</span>
<span class="cm">	 * to ext4_group_info structures</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">%</span> <span class="n">EXT4_DESC_PER_BLOCK</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">metalen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">meta_group_info</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">EXT4_DESC_PER_BLOCK_BITS</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">meta_group_info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">metalen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">meta_group_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate mem &quot;</span>
				 <span class="s">&quot;for a buddy group&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit_meta_group_info</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_info</span><span class="p">[</span><span class="n">group</span> <span class="o">&gt;&gt;</span> <span class="n">EXT4_DESC_PER_BLOCK_BITS</span><span class="p">(</span><span class="n">sb</span><span class="p">)]</span> <span class="o">=</span>
			<span class="n">meta_group_info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">meta_group_info</span> <span class="o">=</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_info</span><span class="p">[</span><span class="n">group</span> <span class="o">&gt;&gt;</span> <span class="n">EXT4_DESC_PER_BLOCK_BITS</span><span class="p">(</span><span class="n">sb</span><span class="p">)];</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">group</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EXT4_DESC_PER_BLOCK</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">meta_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">cachep</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">meta_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate buddy mem&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_group_info</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">meta_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kmem_cache_size</span><span class="p">(</span><span class="n">cachep</span><span class="p">));</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">EXT4_GROUP_INFO_NEED_INIT_BIT</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="p">(</span><span class="n">meta_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bb_state</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize bb_free to be able to skip</span>
<span class="cm">	 * empty groups without initialization</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bg_flags</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT4_BG_BLOCK_UNINIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">meta_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bb_free</span> <span class="o">=</span>
			<span class="n">ext4_free_clusters_after_init</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">meta_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bb_free</span> <span class="o">=</span>
			<span class="n">ext4_free_group_clusters</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bb_prealloc_list</span><span class="p">);</span>
	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">alloc_sem</span><span class="p">);</span>
	<span class="n">meta_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bb_free_root</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
	<span class="n">meta_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bb_largest_free_order</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  <span class="cm">/* uninit */</span>

<span class="cp">#ifdef DOUBLE_CHECK</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
		<span class="n">meta_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bb_bitmap</span> <span class="o">=</span>
			<span class="n">kmalloc</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">meta_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bb_bitmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">ext4_read_block_bitmap</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">meta_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bb_bitmap</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
		<span class="n">put_bh</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_group_info:</span>
	<span class="cm">/* If a meta_group_info table has been allocated, release it now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">%</span> <span class="n">EXT4_DESC_PER_BLOCK</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_info</span><span class="p">[</span><span class="n">group</span> <span class="o">&gt;&gt;</span> <span class="n">EXT4_DESC_PER_BLOCK_BITS</span><span class="p">(</span><span class="n">sb</span><span class="p">)]);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_info</span><span class="p">[</span><span class="n">group</span> <span class="o">&gt;&gt;</span> <span class="n">EXT4_DESC_PER_BLOCK_BITS</span><span class="p">(</span><span class="n">sb</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">exit_meta_group_info:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* ext4_mb_add_groupinfo */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_mb_init_backend</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_group_t</span> <span class="n">ngroups</span> <span class="o">=</span> <span class="n">ext4_get_groups_count</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">ext4_group_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_meta_group_infos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_meta_group_infos_max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">array_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">cachep</span><span class="p">;</span>

	<span class="cm">/* This is the number of blocks used by GDT */</span>
	<span class="n">num_meta_group_infos</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngroups</span> <span class="o">+</span> <span class="n">EXT4_DESC_PER_BLOCK</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">-</span>
				<span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">EXT4_DESC_PER_BLOCK_BITS</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is the total number of blocks used by GDT including</span>
<span class="cm">	 * the number of reserved blocks for GDT.</span>
<span class="cm">	 * The s_group_info array is allocated with this value</span>
<span class="cm">	 * to allow a clean online resize without a complex</span>
<span class="cm">	 * manipulation of pointer.</span>
<span class="cm">	 * The drawback is the unused memory when no resize</span>
<span class="cm">	 * occurs but it&#39;s very low in terms of pages</span>
<span class="cm">	 * (see comments below)</span>
<span class="cm">	 * Need to handle this properly when META_BG resizing is allowed</span>
<span class="cm">	 */</span>
	<span class="n">num_meta_group_infos_max</span> <span class="o">=</span> <span class="n">num_meta_group_infos</span> <span class="o">+</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_reserved_gdt_blocks</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * array_size is the size of s_group_info array. We round it</span>
<span class="cm">	 * to the next power of two because this approximation is done</span>
<span class="cm">	 * internally by kmalloc so we can have some more memory</span>
<span class="cm">	 * for free here (e.g. may be used for META_BG resize).</span>
<span class="cm">	 */</span>
	<span class="n">array_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">array_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_info</span><span class="p">)</span> <span class="o">*</span>
	       <span class="n">num_meta_group_infos_max</span><span class="p">)</span>
		<span class="n">array_size</span> <span class="o">=</span> <span class="n">array_size</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* An 8TB filesystem with 64-bit pointers requires a 4096 byte</span>
<span class="cm">	 * kmalloc. A 128kb malloc should suffice for a 256TB filesystem.</span>
<span class="cm">	 * So a two level scheme suffices for now. */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_info</span> <span class="o">=</span> <span class="n">ext4_kvzalloc</span><span class="p">(</span><span class="n">array_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate buddy meta group&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_buddy_cache</span> <span class="o">=</span> <span class="n">new_inode</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_buddy_cache</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;can&#39;t get new inode&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_freesgi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* To avoid potentially colliding with an valid on-disk inode number,</span>
<span class="cm">	 * use EXT4_BAD_INO for the buddy cache inode number.  This inode is</span>
<span class="cm">	 * not in the inode hash, so it should never be found by iget(), but</span>
<span class="cm">	 * this will avoid confusion if it ever shows up during debugging. */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_buddy_cache</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">=</span> <span class="n">EXT4_BAD_INO</span><span class="p">;</span>
	<span class="n">EXT4_I</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_buddy_cache</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_disksize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ngroups</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">ext4_get_group_desc</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;can&#39;t read descriptor %u&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_freebuddy</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext4_mb_add_groupinfo</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_freebuddy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_freebuddy:</span>
	<span class="n">cachep</span> <span class="o">=</span> <span class="n">get_groupinfo_cache</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">cachep</span><span class="p">,</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">num_meta_group_infos</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">iput</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_buddy_cache</span><span class="p">);</span>
<span class="nl">err_freesgi:</span>
	<span class="n">ext4_kvfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_groupinfo_destroy_slabs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_GRPINFO_CACHES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext4_groupinfo_caches</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">ext4_groupinfo_caches</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">ext4_groupinfo_caches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_groupinfo_create_slab</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">ext4_grpinfo_slab_create_mutex</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">slab_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blocksize_bits</span> <span class="o">=</span> <span class="n">order_base_2</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cache_index</span> <span class="o">=</span> <span class="n">blocksize_bits</span> <span class="o">-</span> <span class="n">EXT4_MIN_BLOCK_LOG_SIZE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">cachep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cache_index</span> <span class="o">&gt;=</span> <span class="n">NR_GRPINFO_CACHES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cache_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">cache_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_grpinfo_slab_create_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext4_groupinfo_caches</span><span class="p">[</span><span class="n">cache_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_grpinfo_slab_create_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Already created */</span>
	<span class="p">}</span>

	<span class="n">slab_size</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_group_info</span><span class="p">,</span>
				<span class="n">bb_counters</span><span class="p">[</span><span class="n">blocksize_bits</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>

	<span class="n">cachep</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="n">ext4_groupinfo_slab_names</span><span class="p">[</span><span class="n">cache_index</span><span class="p">],</span>
					<span class="n">slab_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SLAB_RECLAIM_ACCOUNT</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ext4_groupinfo_caches</span><span class="p">[</span><span class="n">cache_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cachep</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext4_grpinfo_slab_create_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cachep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span>
		       <span class="s">&quot;EXT4-fs: no memory for groupinfo slab cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ext4_mb_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_offsets</span><span class="p">);</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_offsets</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_offsets</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_maxs</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_maxs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_maxs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_groupinfo_create_slab</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* order 0 is regular bitmap */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_maxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_maxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">max</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_md_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bal_lock</span><span class="p">);</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_max_to_scan</span> <span class="o">=</span> <span class="n">MB_DEFAULT_MAX_TO_SCAN</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_min_to_scan</span> <span class="o">=</span> <span class="n">MB_DEFAULT_MIN_TO_SCAN</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_stats</span> <span class="o">=</span> <span class="n">MB_DEFAULT_STATS</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_stream_request</span> <span class="o">=</span> <span class="n">MB_DEFAULT_STREAM_THRESHOLD</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_order2_reqs</span> <span class="o">=</span> <span class="n">MB_DEFAULT_ORDER2_REQS</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The default group preallocation is 512, which for 4k block</span>
<span class="cm">	 * sizes translates to 2 megabytes.  However for bigalloc file</span>
<span class="cm">	 * systems, this is probably too big (i.e, if the cluster size</span>
<span class="cm">	 * is 1 megabyte, then group preallocation size becomes half a</span>
<span class="cm">	 * gigabyte!).  As a default, we will keep a two megabyte</span>
<span class="cm">	 * group pralloc size for cluster sizes up to 64k, and after</span>
<span class="cm">	 * that, we will force a minimum group preallocation size of</span>
<span class="cm">	 * 32 clusters.  This translates to 8 megs when the cluster</span>
<span class="cm">	 * size is 256k, and 32 megs when the cluster size is 1 meg,</span>
<span class="cm">	 * which seems reasonable as a default.</span>
<span class="cm">	 */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_group_prealloc</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">MB_DEFAULT_GROUP_PREALLOC</span> <span class="o">&gt;&gt;</span>
				       <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_cluster_bits</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If there is a s_stripe &gt; 1, then we set the s_mb_group_prealloc</span>
<span class="cm">	 * to the lowest multiple of s_stripe which is bigger than</span>
<span class="cm">	 * the s_mb_group_prealloc as determined above. We want</span>
<span class="cm">	 * the preallocation size to be an exact multiple of the</span>
<span class="cm">	 * RAID stripe size so that preallocations don&#39;t fragment</span>
<span class="cm">	 * the stripes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_group_prealloc</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_group_prealloc</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_stripe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_locality_groups</span> <span class="o">=</span> <span class="n">alloc_percpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_locality_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_locality_groups</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_groupinfo_slab</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ext4_locality_group</span> <span class="o">*</span><span class="n">lg</span><span class="p">;</span>
		<span class="n">lg</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_locality_groups</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">lg_mutex</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">PREALLOC_TB_SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">lg_prealloc_list</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">lg_prealloc_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* init file for buddy data */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_mb_init_backend</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_locality_groups</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_proc</span><span class="p">)</span>
		<span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;mb_groups&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_proc</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">ext4_mb_seq_groups_fops</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_locality_groups:</span>
	<span class="n">free_percpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_locality_groups</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_locality_groups</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out_free_groupinfo_slab:</span>
	<span class="n">ext4_groupinfo_destroy_slabs</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_offsets</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_offsets</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_maxs</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_maxs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* need to called with the ext4 group lock held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_cleanup_pa</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">cur</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_prealloc_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_prealloc_space</span><span class="p">,</span> <span class="n">pa_group_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_group_list</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ext4_pspace_cachep</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
		<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mballoc: %u PAs left</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ext4_mb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_group_t</span> <span class="n">ngroups</span> <span class="o">=</span> <span class="n">ext4_get_groups_count</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">ext4_group_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_meta_group_infos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">cachep</span> <span class="o">=</span> <span class="n">get_groupinfo_cache</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_proc</span><span class="p">)</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;mb_groups&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_proc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ngroups</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">grinfo</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="cp">#ifdef DOUBLE_CHECK</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">grinfo</span><span class="o">-&gt;</span><span class="n">bb_bitmap</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ext4_mb_cleanup_pa</span><span class="p">(</span><span class="n">grinfo</span><span class="p">);</span>
			<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">cachep</span><span class="p">,</span> <span class="n">grinfo</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">num_meta_group_infos</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngroups</span> <span class="o">+</span>
				<span class="n">EXT4_DESC_PER_BLOCK</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">EXT4_DESC_PER_BLOCK_BITS</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_meta_group_infos</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">ext4_kvfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_offsets</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_maxs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_buddy_cache</span><span class="p">)</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_buddy_cache</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span>
		       <span class="s">&quot;mballoc: %u blocks %u reqs (%u success)&quot;</span><span class="p">,</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bal_allocated</span><span class="p">),</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bal_reqs</span><span class="p">),</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bal_success</span><span class="p">));</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span>
		      <span class="s">&quot;mballoc: %u extents scanned, %u goal hits, &quot;</span>
				<span class="s">&quot;%u 2^N hits, %u breaks, %u lost&quot;</span><span class="p">,</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bal_ex_scanned</span><span class="p">),</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bal_goals</span><span class="p">),</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bal_2orders</span><span class="p">),</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bal_breaks</span><span class="p">),</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_lost_chunks</span><span class="p">));</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span>
		       <span class="s">&quot;mballoc: %lu generated and it took %Lu&quot;</span><span class="p">,</span>
				<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_buddies_generated</span><span class="p">,</span>
				<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_generation_time</span><span class="p">);</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span>
		       <span class="s">&quot;mballoc: %u preallocated, %u discarded&quot;</span><span class="p">,</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_preallocated</span><span class="p">),</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_discarded</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">free_percpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_locality_groups</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ext4_issue_discard</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
		<span class="n">ext4_group_t</span> <span class="n">block_group</span><span class="p">,</span> <span class="n">ext4_grpblk_t</span> <span class="n">cluster</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">discard_block</span><span class="p">;</span>

	<span class="n">discard_block</span> <span class="o">=</span> <span class="p">(</span><span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span> <span class="n">cluster</span><span class="p">)</span> <span class="o">+</span>
			 <span class="n">ext4_group_first_block_no</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">));</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">trace_ext4_discard_blocks</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">discard_block</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sb_issue_discard</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">discard_block</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called by the jbd2 layer once the commit has finished,</span>
<span class="cm"> * so we know we can free the blocks that were released with that commit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_free_data_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ext4_journal_cb_entry</span> <span class="o">*</span><span class="n">jce</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_free_data</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext4_free_data</span> <span class="o">*</span><span class="p">)</span><span class="n">jce</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="n">e4b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">db</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;gonna free %u blocks in group %u (0x%p):&quot;</span><span class="p">,</span>
		 <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_count</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_group</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DISCARD</span><span class="p">))</span>
		<span class="n">ext4_issue_discard</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_group</span><span class="p">,</span>
				   <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_start_cluster</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_count</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_mb_load_buddy</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
	<span class="cm">/* we expect to find existing buddy because it&#39;s pinned */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>


	<span class="n">db</span> <span class="o">=</span> <span class="n">e4b</span><span class="p">.</span><span class="n">bd_info</span><span class="p">;</span>
	<span class="cm">/* there are blocks to put in buddy to make them really free */</span>
	<span class="n">count</span> <span class="o">+=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_count</span><span class="p">;</span>
	<span class="n">count2</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_group</span><span class="p">);</span>
	<span class="cm">/* Take it out of per group rb tree */</span>
	<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">bb_free_root</span><span class="p">));</span>
	<span class="n">mb_free_blocks</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_start_cluster</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_count</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the trimmed flag for the group so that the next</span>
<span class="cm">	 * ext4_trim_fs can trim it.</span>
<span class="cm">	 * If the volume is mounted with -o discard, online discard</span>
<span class="cm">	 * is supported and the free blocks will be trimmed online.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DISCARD</span><span class="p">))</span>
		<span class="n">EXT4_MB_GRP_CLEAR_TRIMMED</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">bb_free_root</span><span class="p">.</span><span class="n">rb_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No more items in the per group rb tree</span>
<span class="cm">		 * balance refcounts from ext4_mb_free_metadata()</span>
<span class="cm">		 */</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">e4b</span><span class="p">.</span><span class="n">bd_buddy_page</span><span class="p">);</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">e4b</span><span class="p">.</span><span class="n">bd_bitmap_page</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_group</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ext4_free_data_cachep</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
	<span class="n">ext4_mb_unload_buddy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>

	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;freed %u blocks in %u structures</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">count2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_EXT4_DEBUG</span>
<span class="n">u8</span> <span class="n">mb_enable_debug</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debugfs_dir</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debugfs_debug</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ext4_create_debugfs_entry</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;ext4&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugfs_dir</span><span class="p">)</span>
		<span class="n">debugfs_debug</span> <span class="o">=</span> <span class="n">debugfs_create_u8</span><span class="p">(</span><span class="s">&quot;mballoc-debug&quot;</span><span class="p">,</span>
						  <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
						  <span class="n">debugfs_dir</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">mb_enable_debug</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_remove_debugfs_entry</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">debugfs_debug</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">debugfs_dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ext4_create_debugfs_entry</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_remove_debugfs_entry</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">ext4_init_mballoc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_pspace_cachep</span> <span class="o">=</span> <span class="n">KMEM_CACHE</span><span class="p">(</span><span class="n">ext4_prealloc_space</span><span class="p">,</span>
					<span class="n">SLAB_RECLAIM_ACCOUNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext4_pspace_cachep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ext4_ac_cachep</span> <span class="o">=</span> <span class="n">KMEM_CACHE</span><span class="p">(</span><span class="n">ext4_allocation_context</span><span class="p">,</span>
				    <span class="n">SLAB_RECLAIM_ACCOUNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext4_ac_cachep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">ext4_pspace_cachep</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ext4_free_data_cachep</span> <span class="o">=</span> <span class="n">KMEM_CACHE</span><span class="p">(</span><span class="n">ext4_free_data</span><span class="p">,</span>
					   <span class="n">SLAB_RECLAIM_ACCOUNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext4_free_data_cachep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">ext4_pspace_cachep</span><span class="p">);</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">ext4_ac_cachep</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ext4_create_debugfs_entry</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext4_exit_mballoc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Wait for completion of call_rcu()&#39;s on ext4_pspace_cachep</span>
<span class="cm">	 * before destroying the slab cache.</span>
<span class="cm">	 */</span>
	<span class="n">rcu_barrier</span><span class="p">();</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">ext4_pspace_cachep</span><span class="p">);</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">ext4_ac_cachep</span><span class="p">);</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">ext4_free_data_cachep</span><span class="p">);</span>
	<span class="n">ext4_groupinfo_destroy_slabs</span><span class="p">();</span>
	<span class="n">ext4_remove_debugfs_entry</span><span class="p">();</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Check quota and mark chosen space (ac-&gt;ac_b_ex) non-free in bitmaps</span>
<span class="cm"> * Returns 0 if success or error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span>
<span class="nf">ext4_mb_mark_diskspace_used</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
				<span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reserv_clstrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bitmap_bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">gdp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">gdp_bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">block</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">!=</span> <span class="n">AC_STATUS_FOUND</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">;</span>
	<span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">bitmap_bh</span> <span class="o">=</span> <span class="n">ext4_read_block_bitmap</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap_bh</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_journal_get_write_access</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">bitmap_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">gdp</span> <span class="o">=</span> <span class="n">ext4_get_group_desc</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdp_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;using block group %u(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">,</span>
			<span class="n">ext4_free_group_clusters</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_journal_get_write_access</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">gdp_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">ext4_grp_offs_to_block</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_data_block_valid</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Allocating blocks %llu-%llu which overlap &quot;</span>
			   <span class="s">&quot;fs metadata&quot;</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">block</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
		<span class="cm">/* File system mounted not to panic on error</span>
<span class="cm">		 * Fix the bitmap and repeat the block allocation</span>
<span class="cm">		 * We leak some of the blocks here.</span>
<span class="cm">		 */</span>
		<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">);</span>
		<span class="n">ext4_set_bits</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">,</span>
			      <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
		<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_handle_dirty_metadata</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bitmap_bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">);</span>
<span class="cp">#ifdef AGGRESSIVE_CHECK</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
						<span class="n">bitmap_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">ext4_set_bits</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">,</span>
		      <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_flags</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT4_BG_BLOCK_UNINIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_flags</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">~</span><span class="n">EXT4_BG_BLOCK_UNINIT</span><span class="p">);</span>
		<span class="n">ext4_free_group_clusters_set</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">,</span>
					     <span class="n">ext4_free_clusters_after_init</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
						<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">,</span> <span class="n">gdp</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ext4_free_group_clusters</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">)</span> <span class="o">-</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">;</span>
	<span class="n">ext4_free_group_clusters_set</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">ext4_block_bitmap_csum_set</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">,</span> <span class="n">gdp</span><span class="p">,</span> <span class="n">bitmap_bh</span><span class="p">,</span>
				   <span class="n">EXT4_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ext4_group_desc_csum_set</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">,</span> <span class="n">gdp</span><span class="p">);</span>

	<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">);</span>
	<span class="n">percpu_counter_sub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeclusters_counter</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now reduce the dirty block count also. Should not go negative</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_DELALLOC_RESERVED</span><span class="p">))</span>
		<span class="cm">/* release all the reserved blocks if non delalloc */</span>
		<span class="n">percpu_counter_sub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirtyclusters_counter</span><span class="p">,</span>
				   <span class="n">reserv_clstrs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_log_groups_per_flex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_group_t</span> <span class="n">flex_group</span> <span class="o">=</span> <span class="n">ext4_flex_group</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span>
							  <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">);</span>
		<span class="n">atomic_sub</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_flex_groups</span><span class="p">[</span><span class="n">flex_group</span><span class="p">].</span><span class="n">free_clusters</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_handle_dirty_metadata</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bitmap_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_handle_dirty_metadata</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">gdp_bh</span><span class="p">);</span>

<span class="nl">out_err:</span>
	<span class="n">ext4_mark_super_dirty</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * here we normalize request for locality group</span>
<span class="cm"> * Group request are normalized to s_mb_group_prealloc, which goes to</span>
<span class="cm"> * s_strip if we set the same via mount option.</span>
<span class="cm"> * s_mb_group_prealloc can be configured via</span>
<span class="cm"> * /sys/fs/ext4/&lt;partition&gt;/mb_group_prealloc</span>
<span class="cm"> *</span>
<span class="cm"> * XXX: should we try to preallocate more than the group has now?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_normalize_group_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_locality_group</span> <span class="o">*</span><span class="n">lg</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_lg</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mb_group_prealloc</span><span class="p">;</span>
	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;#%u: goal %u blocks for locality group</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Normalization means making request better in terms of</span>
<span class="cm"> * size and alignment</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">void</span>
<span class="nf">ext4_mb_normalize_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ext4_allocation_request</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bsbits</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">ext4_lblk_t</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">start_off</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">orig_size</span> <span class="n">__maybe_unused</span><span class="p">;</span>
	<span class="n">ext4_lblk_t</span> <span class="n">start</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_inode_info</span> <span class="o">*</span><span class="n">ei</span> <span class="o">=</span> <span class="n">EXT4_I</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">;</span>

	<span class="cm">/* do normalize only data requests, metadata requests</span>
<span class="cm">	   do not need preallocation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_DATA</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* sometime caller may want exact blocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_GOAL_ONLY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* caller may indicate that preallocation isn&#39;t</span>
<span class="cm">	 * required (it&#39;s a tail, for example) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_NOPREALLOC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_GROUP_ALLOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_mb_normalize_group_request</span><span class="p">(</span><span class="n">ac</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bsbits</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">;</span>

	<span class="cm">/* first, let&#39;s learn actual file size</span>
<span class="cm">	 * given current request is allocated */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">+</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="n">bsbits</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_inode</span><span class="p">))</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_inode</span><span class="p">);</span>
	<span class="n">orig_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* max size of free chunks */</span>
	<span class="n">max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">bsbits</span><span class="p">;</span>

<span class="cp">#define NRL_CHECK_SIZE(req, size, max, chunk_size)	\</span>
<span class="cp">		(req &lt;= (size) || max &lt;= (chunk_size))</span>

	<span class="cm">/* first, try to predict filesize */</span>
	<span class="cm">/* XXX: should this table be tunable? */</span>
	<span class="n">start_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NRL_CHECK_SIZE</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">start_off</span> <span class="o">=</span> <span class="p">((</span><span class="n">loff_t</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">&gt;&gt;</span>
						<span class="p">(</span><span class="mi">21</span> <span class="o">-</span> <span class="n">bsbits</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NRL_CHECK_SIZE</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">start_off</span> <span class="o">=</span> <span class="p">((</span><span class="n">loff_t</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">&gt;&gt;</span>
							<span class="p">(</span><span class="mi">22</span> <span class="o">-</span> <span class="n">bsbits</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NRL_CHECK_SIZE</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">,</span>
					<span class="p">(</span><span class="mi">8</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="n">bsbits</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">start_off</span> <span class="o">=</span> <span class="p">((</span><span class="n">loff_t</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">&gt;&gt;</span>
							<span class="p">(</span><span class="mi">23</span> <span class="o">-</span> <span class="n">bsbits</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">start_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">&lt;&lt;</span> <span class="n">bsbits</span><span class="p">;</span>
		<span class="n">size</span>	  <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&lt;&lt;</span> <span class="n">bsbits</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">bsbits</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">start_off</span> <span class="o">&gt;&gt;</span> <span class="n">bsbits</span><span class="p">;</span>

	<span class="cm">/* don&#39;t cover already allocated blocks in selected range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">pleft</span> <span class="o">&amp;&amp;</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">lleft</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">lleft</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">lleft</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">pright</span> <span class="o">&amp;&amp;</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">lright</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">lright</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* check we don&#39;t cross already preallocated blocks */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_list</span><span class="p">,</span> <span class="n">pa_inode_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_lblk_t</span> <span class="n">pa_end</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pa_end</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span> <span class="o">+</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">),</span>
						  <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">);</span>

		<span class="cm">/* PA must not overlap original request */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">&gt;=</span> <span class="n">pa_end</span> <span class="o">||</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">&lt;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span><span class="p">));</span>

		<span class="cm">/* skip PAs this normalized request doesn&#39;t overlap with */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span> <span class="o">&gt;=</span> <span class="n">end</span> <span class="o">||</span> <span class="n">pa_end</span> <span class="o">&lt;=</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span> <span class="o">&lt;=</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">pa_end</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">);</span>

		<span class="cm">/* adjust start or end to be adjacent to this pa */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pa_end</span> <span class="o">&lt;=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pa_end</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">);</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">pa_end</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span> <span class="o">&gt;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">);</span>
			<span class="n">end</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>

	<span class="cm">/* XXX: extra loop to check we really don&#39;t overlap preallocations */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_list</span><span class="p">,</span> <span class="n">pa_inode_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_lblk_t</span> <span class="n">pa_end</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pa_end</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span> <span class="o">+</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">),</span>
							  <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">pa_end</span> <span class="o">||</span> <span class="n">end</span> <span class="o">&lt;=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">&amp;&amp;</span>
			<span class="n">start</span> <span class="o">&gt;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			 <span class="s">&quot;start %lu, size %lu, fe_logical %lu&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">size</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">&amp;&amp;</span>
			<span class="n">start</span> <span class="o">&gt;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">EXT4_CLUSTERS_PER_GROUP</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">));</span>

	<span class="cm">/* now prepare goal request */</span>

	<span class="cm">/* XXX: is it better to align blocks WRT to logical</span>
<span class="cm">	 * placement or satisfy big request as is */</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">=</span> <span class="n">EXT4_NUM_B2C</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/* define goal start in order to merge */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">pright</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lright</span> <span class="o">==</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* merge to the right */</span>
		<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">pright</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_f_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_f_ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">);</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">|=</span> <span class="n">EXT4_MB_HINT_TRY_GOAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">pleft</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lleft</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">start</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* merge to the left */</span>
		<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">pleft</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_f_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_f_ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">);</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">|=</span> <span class="n">EXT4_MB_HINT_TRY_GOAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;goal: %u(was %u) blocks at %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">size</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">orig_size</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_collect_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_stats</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bal_reqs</span><span class="p">);</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bal_allocated</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&gt;=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bal_success</span><span class="p">);</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_found</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bal_ex_scanned</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_start</span> <span class="o">==</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_start</span> <span class="o">&amp;&amp;</span>
				<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_group</span> <span class="o">==</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bal_goals</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_found</span> <span class="o">&gt;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_max_to_scan</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bal_breaks</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_op</span> <span class="o">==</span> <span class="n">EXT4_MB_HISTORY_ALLOC</span><span class="p">)</span>
		<span class="n">trace_ext4_mballoc_alloc</span><span class="p">(</span><span class="n">ac</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">trace_ext4_mballoc_prealloc</span><span class="p">(</span><span class="n">ac</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called on failure; free up any blocks from the inode PA for this</span>
<span class="cm"> * context.  We don&#39;t need this for MB_GROUP_PA because we only change</span>
<span class="cm"> * pa_free in ext4_mb_release_context(), but on failure, we&#39;ve already</span>
<span class="cm"> * zeroed out ac-&gt;ac_b_ex.fe_len, so group_pa-&gt;pa_free is not changed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_discard_allocated_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_pa</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pa</span> <span class="o">&amp;&amp;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_type</span> <span class="o">==</span> <span class="n">MB_INODE_PA</span><span class="p">)</span>
		<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span> <span class="o">+=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * use blocks preallocated to inode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_use_inode_pa</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">);</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* found preallocated blocks, use them */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span> <span class="o">+</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">-</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span> <span class="o">+</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">),</span>
		  <span class="n">start</span> <span class="o">+</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">EXT4_NUM_B2C</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
	<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">);</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">=</span> <span class="n">AC_STATUS_FOUND</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_pa</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span> <span class="o">+</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;use %llu/%u from inode pa %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * use blocks preallocated to locality group</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_use_group_pa</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">;</span>

	<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">);</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">=</span> <span class="n">AC_STATUS_FOUND</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_pa</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>

	<span class="cm">/* we don&#39;t correct pa_pstart or pa_plen here to avoid</span>
<span class="cm">	 * possible race when the group is being loaded concurrently</span>
<span class="cm">	 * instead we correct pa later, after blocks are marked</span>
<span class="cm">	 * in on-disk bitmap -- see ext4_mb_release_context()</span>
<span class="cm">	 * Other CPUs are prevented from allocating from this pa by lg_mutex</span>
<span class="cm">	 */</span>
	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;use %u/%u from group pa %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return the prealloc space that have minimal distance</span>
<span class="cm"> * from the goal block. @cpa is the prealloc</span>
<span class="cm"> * space that is having currently known minimal distance</span>
<span class="cm"> * from the goal block.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span>
<span class="nf">ext4_mb_check_group_pa</span><span class="p">(</span><span class="n">ext4_fsblk_t</span> <span class="n">goal_block</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">cpa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">cur_distance</span><span class="p">,</span> <span class="n">new_distance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpa</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">pa</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cur_distance</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">goal_block</span> <span class="o">-</span> <span class="n">cpa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">);</span>
	<span class="n">new_distance</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">goal_block</span> <span class="o">-</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur_distance</span> <span class="o">&lt;=</span> <span class="n">new_distance</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cpa</span><span class="p">;</span>

	<span class="cm">/* drop the previous reference */</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpa</span><span class="o">-&gt;</span><span class="n">pa_count</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pa</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * search goal blocks in preallocated space</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span>
<span class="nf">ext4_mb_use_preallocated</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">order</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_inode_info</span> <span class="o">*</span><span class="n">ei</span> <span class="o">=</span> <span class="n">EXT4_I</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_locality_group</span> <span class="o">*</span><span class="n">lg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">,</span> <span class="o">*</span><span class="n">cpa</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">goal_block</span><span class="p">;</span>

	<span class="cm">/* only data can be preallocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* first, try per-file preallocation */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_list</span><span class="p">,</span> <span class="n">pa_inode_list</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* all fields in this condition don&#39;t change,</span>
<span class="cm">		 * so we can skip locking for them */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">&lt;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span> <span class="o">||</span>
		    <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span> <span class="o">+</span>
					       <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* non-extent files can&#39;t have physical blocks past 2^32 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ext4_test_inode_flag</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_inode</span><span class="p">,</span> <span class="n">EXT4_INODE_EXTENTS</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span> <span class="o">+</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">)</span> <span class="o">&gt;</span>
		     <span class="n">EXT4_MAX_BLOCK_FILE_PHYS</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* found preallocated blocks, use them */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_count</span><span class="p">);</span>
			<span class="n">ext4_mb_use_inode_pa</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_criteria</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="cm">/* can we use group allocation? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_GROUP_ALLOC</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* inode may have no locality group for some reason */</span>
	<span class="n">lg</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_lg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">order</span>  <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">&gt;</span> <span class="n">PREALLOC_TB_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="cm">/* The max size of hash table is PREALLOC_TB_SIZE */</span>
		<span class="n">order</span> <span class="o">=</span> <span class="n">PREALLOC_TB_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">goal_block</span> <span class="o">=</span> <span class="n">ext4_grp_offs_to_block</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * search for the prealloc space that is having</span>
<span class="cm">	 * minimal distance from the goal block.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">order</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PREALLOC_TB_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">lg_prealloc_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">pa_inode_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
					<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span> <span class="o">&gt;=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">cpa</span> <span class="o">=</span> <span class="n">ext4_mb_check_group_pa</span><span class="p">(</span><span class="n">goal_block</span><span class="p">,</span>
								<span class="n">pa</span><span class="p">,</span> <span class="n">cpa</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_mb_use_group_pa</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">cpa</span><span class="p">);</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_criteria</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * the function goes through all block freed in the group</span>
<span class="cm"> * but not yet committed and marks them used in in-core bitmap.</span>
<span class="cm"> * buddy must be generated from this bitmap</span>
<span class="cm"> * Need to be called with the ext4 group lock held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_generate_from_freelist</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span>
						<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_free_data</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">grp</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_free_root</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_free_data</span><span class="p">,</span> <span class="n">efd_node</span><span class="p">);</span>
		<span class="n">ext4_set_bits</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_start_cluster</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_count</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * the function goes through all preallocation in this group and marks them</span>
<span class="cm"> * used in in-core bitmap. buddy must be generated from this bitmap</span>
<span class="cm"> * Need to be called with ext4 group lock held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">void</span> <span class="nf">ext4_mb_generate_from_pa</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span>
					<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">groupnr</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">preallocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* all form of preallocation discards first load group,</span>
<span class="cm">	 * so the only competing code is preallocation use.</span>
<span class="cm">	 * we don&#39;t need any locking here</span>
<span class="cm">	 * notice we do NOT ignore preallocations with pa_deleted</span>
<span class="cm">	 * otherwise we could leave used blocks available for</span>
<span class="cm">	 * allocation in buddy when concurrent ext4_mb_put_pa()</span>
<span class="cm">	 * is dropping preallocation</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_prealloc_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_prealloc_space</span><span class="p">,</span> <span class="n">pa_group_list</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
		<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">groupnr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">groupnr</span> <span class="o">!=</span> <span class="n">group</span><span class="p">);</span>
		<span class="n">ext4_set_bits</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">preallocated</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;prellocated %u for group %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">preallocated</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_pa_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">;</span>
	<span class="n">pa</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_prealloc_space</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">pa_rcu</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ext4_pspace_cachep</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * drops a reference to preallocated space descriptor</span>
<span class="cm"> * if this was the last reference and the space is consumed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_put_pa</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_group_t</span> <span class="n">grp</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">grp_blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_count</span><span class="p">)</span> <span class="o">||</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* in this short window concurrent discard can set pa_deleted */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>

	<span class="n">grp_blk</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If doing group-based preallocation, pa_pstart may be in the</span>
<span class="cm">	 * next group when pa is used up</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_type</span> <span class="o">==</span> <span class="n">MB_GROUP_PA</span><span class="p">)</span>
		<span class="n">grp_blk</span><span class="o">--</span><span class="p">;</span>

	<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">grp_blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * possible race:</span>
<span class="cm">	 *</span>
<span class="cm">	 *  P1 (buddy init)			P2 (regular allocation)</span>
<span class="cm">	 *					find block B in PA</span>
<span class="cm">	 *  copy on-disk bitmap to buddy</span>
<span class="cm">	 *  					mark B in on-disk bitmap</span>
<span class="cm">	 *					drop PA from group</span>
<span class="cm">	 *  mark all PAs in buddy</span>
<span class="cm">	 *</span>
<span class="cm">	 * thus, P1 initializes buddy with B available. to prevent this</span>
<span class="cm">	 * we make &quot;copy&quot; and &quot;mark all PAs&quot; atomic and serialize &quot;drop PA&quot;</span>
<span class="cm">	 * against that pair</span>
<span class="cm">	 */</span>
	<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">grp</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_group_list</span><span class="p">);</span>
	<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">grp</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_obj_lock</span><span class="p">);</span>
	<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_inode_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_obj_lock</span><span class="p">);</span>

	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pa_rcu</span><span class="p">,</span> <span class="n">ext4_mb_pa_callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * creates new preallocated space for given inode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span>
<span class="nf">ext4_mb_new_inode_pa</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_inode_info</span> <span class="o">*</span><span class="n">ei</span><span class="p">;</span>

	<span class="cm">/* preallocate only when found space is larger then requested */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&gt;=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">!=</span> <span class="n">AC_STATUS_FOUND</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">));</span>

	<span class="n">pa</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">ext4_pspace_cachep</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pa</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&lt;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">winl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">wins</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">win</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">offs</span><span class="p">;</span>

		<span class="cm">/* we can&#39;t allocate as much as normalizer wants.</span>
<span class="cm">		 * so, found space must get proper lstart</span>
<span class="cm">		 * to cover original request */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">&gt;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&lt;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>

		<span class="cm">/* we&#39;re limited by original request in that</span>
<span class="cm">		 * logical block must be covered any way</span>
<span class="cm">		 * winl is window we can move our chunk within */</span>
		<span class="n">winl</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">-</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_logical</span><span class="p">;</span>

		<span class="cm">/* also, we should cover whole original request */</span>
		<span class="n">wins</span> <span class="o">=</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">-</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>

		<span class="cm">/* the smallest one defines real window */</span>
		<span class="n">win</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">winl</span><span class="p">,</span> <span class="n">wins</span><span class="p">);</span>

		<span class="n">offs</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">%</span>
			<span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offs</span> <span class="o">&amp;&amp;</span> <span class="n">offs</span> <span class="o">&lt;</span> <span class="n">win</span><span class="p">)</span>
			<span class="n">win</span> <span class="o">=</span> <span class="n">offs</span><span class="p">;</span>

		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">-</span>
			<span class="n">EXT4_B2C</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">win</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">&lt;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_logical</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&gt;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* preallocation can change ac_b_ex, thus we store actually</span>
<span class="cm">	 * allocated blocks for history */</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_f_ex</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">;</span>

	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_logical</span><span class="p">;</span>
	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span> <span class="o">=</span> <span class="n">ext4_grp_offs_to_block</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">);</span>
	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">;</span>
	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_inode_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_group_list</span><span class="p">);</span>
	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_type</span> <span class="o">=</span> <span class="n">MB_INODE_PA</span><span class="p">;</span>

	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;new inode pa %p: %llu/%u for %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span>
			<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span><span class="p">);</span>
	<span class="n">trace_ext4_mb_new_inode_pa</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>

	<span class="n">ext4_mb_use_inode_pa</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_preallocated</span><span class="p">);</span>

	<span class="n">ei</span> <span class="o">=</span> <span class="n">EXT4_I</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_inode</span><span class="p">);</span>
	<span class="n">grp</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">);</span>

	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_obj_lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_lock</span><span class="p">;</span>
	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_inode</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_inode</span><span class="p">;</span>

	<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_group_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_prealloc_list</span><span class="p">);</span>
	<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_obj_lock</span><span class="p">);</span>
	<span class="n">list_add_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_inode_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_obj_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * creates new preallocated space for locality group inodes belongs to</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span>
<span class="nf">ext4_mb_new_group_pa</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_locality_group</span> <span class="o">*</span><span class="n">lg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>

	<span class="cm">/* preallocate only when found space is larger then requested */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&gt;=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">!=</span> <span class="n">AC_STATUS_FOUND</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">));</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ext4_pspace_cachep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pa</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">ext4_pspace_cachep</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pa</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* preallocation can change ac_b_ex, thus we store actually</span>
<span class="cm">	 * allocated blocks for history */</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_f_ex</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">;</span>

	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span> <span class="o">=</span> <span class="n">ext4_grp_offs_to_block</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">);</span>
	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">;</span>
	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">;</span>
	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_inode_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_group_list</span><span class="p">);</span>
	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_type</span> <span class="o">=</span> <span class="n">MB_GROUP_PA</span><span class="p">;</span>

	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;new group pa %p: %llu/%u for %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span>
			<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span><span class="p">);</span>
	<span class="n">trace_ext4_mb_new_group_pa</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>

	<span class="n">ext4_mb_use_group_pa</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mb_preallocated</span><span class="p">);</span>

	<span class="n">grp</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">);</span>
	<span class="n">lg</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_lg</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_obj_lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">lg_prealloc_lock</span><span class="p">;</span>
	<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_inode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_group_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_prealloc_list</span><span class="p">);</span>
	<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We will later add the new pa to the right bucket</span>
<span class="cm">	 * after updating the pa_free in ext4_mb_release_context</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_mb_new_preallocation</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_GROUP_ALLOC</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_mb_new_group_pa</span><span class="p">(</span><span class="n">ac</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_mb_new_inode_pa</span><span class="p">(</span><span class="n">ac</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * finds all unused blocks in on-disk bitmap, frees them in</span>
<span class="cm"> * in-core bitmap and buddy.</span>
<span class="cm"> * @pa must be unlinked from inode and group lists, so that</span>
<span class="cm"> * nobody else can find/use it.</span>
<span class="cm"> * the caller MUST hold group/inode locks.</span>
<span class="cm"> * TODO: optimize the case when there are no in-core structures yet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span>
<span class="nf">ext4_mb_release_inode_pa</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bitmap_bh</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">bit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">grp_blk_start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bit</span><span class="p">);</span>
	<span class="n">grp_blk_start</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span> <span class="o">-</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">group</span> <span class="o">!=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span> <span class="o">&amp;&amp;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">bit</span> <span class="o">+</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">mb_find_next_zero_bit</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">mb_find_next_bit</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
		<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;    free preallocated %u/%u in group %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">ext4_group_first_block_no</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span> <span class="o">+</span> <span class="n">bit</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">next</span> <span class="o">-</span> <span class="n">bit</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">group</span><span class="p">);</span>
		<span class="n">free</span> <span class="o">+=</span> <span class="n">next</span> <span class="o">-</span> <span class="n">bit</span><span class="p">;</span>

		<span class="n">trace_ext4_mballoc_discard</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">next</span> <span class="o">-</span> <span class="n">bit</span><span class="p">);</span>
		<span class="n">trace_ext4_mb_release_inode_pa</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="p">(</span><span class="n">grp_blk_start</span> <span class="o">+</span>
						    <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">bit</span><span class="p">)),</span>
					       <span class="n">next</span> <span class="o">-</span> <span class="n">bit</span><span class="p">);</span>
		<span class="n">mb_free_blocks</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_inode</span><span class="p">,</span> <span class="n">e4b</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">next</span> <span class="o">-</span> <span class="n">bit</span><span class="p">);</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">next</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free</span> <span class="o">!=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_msg</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">,</span> <span class="n">KERN_CRIT</span><span class="p">,</span>
			 <span class="s">&quot;pa %p: logic %lu, phys. %lu, len %lu&quot;</span><span class="p">,</span>
			 <span class="n">pa</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">);</span>
		<span class="n">ext4_grp_locked_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;free %u, pa_free %u&quot;</span><span class="p">,</span>
					<span class="n">free</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * pa is already deleted so we use the value obtained</span>
<span class="cm">		 * from the bitmap and continue.</span>
<span class="cm">		 */</span>
	<span class="p">}</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">free</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_discarded</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span>
<span class="nf">ext4_mb_release_group_pa</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">bit</span><span class="p">;</span>

	<span class="n">trace_ext4_mb_release_group_pa</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bit</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">group</span> <span class="o">!=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span> <span class="o">&amp;&amp;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mb_free_blocks</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_inode</span><span class="p">,</span> <span class="n">e4b</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">);</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mb_discarded</span><span class="p">);</span>
	<span class="n">trace_ext4_mballoc_discard</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * releases all preallocations in given group</span>
<span class="cm"> *</span>
<span class="cm"> * first, we need to decide discard policy:</span>
<span class="cm"> * - when do we discard</span>
<span class="cm"> *   1) ENOSPC</span>
<span class="cm"> * - how many do we discard</span>
<span class="cm"> *   1) how many requested</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span>
<span class="nf">ext4_mb_discard_group_preallocations</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
					<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">,</span> <span class="kt">int</span> <span class="n">needed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bitmap_bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="n">e4b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;discard preallocation for group %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_prealloc_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bitmap_bh</span> <span class="o">=</span> <span class="n">ext4_read_block_bitmap</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap_bh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Error reading block bitmap for %u&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_mb_load_buddy</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Error loading buddy information for %u&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="n">put_bh</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">needed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">needed</span> <span class="o">=</span> <span class="n">EXT4_CLUSTERS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
<span class="nl">repeat:</span>
	<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_prealloc_list</span><span class="p">,</span> <span class="n">pa_group_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
			<span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* seems this one can be freed ... */</span>
		<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* we can trust pa_free ... */</span>
		<span class="n">free</span> <span class="o">+=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span><span class="p">;</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_group_list</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pa_tmp_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* if we still need more blocks and some PAs were used, try again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free</span> <span class="o">&lt;</span> <span class="n">needed</span> <span class="o">&amp;&amp;</span> <span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Yield the CPU here so that we don&#39;t get soft lockup</span>
<span class="cm">		 * in non preempt case.</span>
<span class="cm">		 */</span>
		<span class="n">yield</span><span class="p">();</span>
		<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* found anything to free? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">free</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* now free all selected PAs */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">pa_tmp_list</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* remove from object (inode or locality group) */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_obj_lock</span><span class="p">);</span>
		<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_inode_list</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_obj_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_type</span> <span class="o">==</span> <span class="n">MB_GROUP_PA</span><span class="p">)</span>
			<span class="n">ext4_mb_release_group_pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ext4_mb_release_inode_pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">,</span> <span class="n">bitmap_bh</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pa_tmp_list</span><span class="p">);</span>
		<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pa_rcu</span><span class="p">,</span> <span class="n">ext4_mb_pa_callback</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="n">ext4_mb_unload_buddy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
	<span class="n">put_bh</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">free</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * releases all non-used preallocated blocks for given inode</span>
<span class="cm"> *</span>
<span class="cm"> * It&#39;s important to discard preallocations under i_data_sem</span>
<span class="cm"> * We don&#39;t want another block to be served from the prealloc</span>
<span class="cm"> * space when we are discarding the inode prealloc space.</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME!! Make sure it is valid at all the call sites</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ext4_discard_preallocations</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_inode_info</span> <span class="o">*</span><span class="n">ei</span> <span class="o">=</span> <span class="n">EXT4_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bitmap_bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="n">e4b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*BUG_ON(!list_empty(&amp;ei-&gt;i_prealloc_list));*/</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;discard preallocation for inode %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
	<span class="n">trace_ext4_discard_preallocations</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>

<span class="nl">repeat:</span>
	<span class="cm">/* first, collect all pa&#39;s in the inode */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ext4_prealloc_space</span><span class="p">,</span> <span class="n">pa_inode_list</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_obj_lock</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_lock</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* this shouldn&#39;t happen often - nobody should</span>
<span class="cm">			 * use preallocation while we&#39;re discarding it */</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_lock</span><span class="p">);</span>
			<span class="n">ext4_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				 <span class="s">&quot;uh-oh! used pa while discarding&quot;</span><span class="p">);</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
			<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_inode_list</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pa_tmp_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* someone is deleting pa right now */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_lock</span><span class="p">);</span>

		<span class="cm">/* we have to wait here because pa_deleted</span>
<span class="cm">		 * doesn&#39;t mean pa is already unlinked from</span>
<span class="cm">		 * the list. as we might be called from</span>
<span class="cm">		 * -&gt;clear_inode() the inode will get freed</span>
<span class="cm">		 * and concurrent thread which is unlinking</span>
<span class="cm">		 * pa from inode&#39;s list may access already</span>
<span class="cm">		 * freed memory, bad-bad-bad */</span>

		<span class="cm">/* XXX: if this happens too often, we can</span>
<span class="cm">		 * add a flag to force wait only in case</span>
<span class="cm">		 * of -&gt;clear_inode(), but not in case of</span>
<span class="cm">		 * regular truncate */</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">pa_tmp_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_type</span> <span class="o">!=</span> <span class="n">MB_INODE_PA</span><span class="p">);</span>
		<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">group</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_mb_load_buddy</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Error loading buddy information for %u&quot;</span><span class="p">,</span>
					<span class="n">group</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bitmap_bh</span> <span class="o">=</span> <span class="n">ext4_read_block_bitmap</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitmap_bh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Error reading block bitmap for %u&quot;</span><span class="p">,</span>
					<span class="n">group</span><span class="p">);</span>
			<span class="n">ext4_mb_unload_buddy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_group_list</span><span class="p">);</span>
		<span class="n">ext4_mb_release_inode_pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">,</span> <span class="n">bitmap_bh</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
		<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>

		<span class="n">ext4_mb_unload_buddy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
		<span class="n">put_bh</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pa_tmp_list</span><span class="p">);</span>
		<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pa_rcu</span><span class="p">,</span> <span class="n">ext4_mb_pa_callback</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_EXT4_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_show_ac</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">ngroups</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mb_enable_debug</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MF_FS_ABORTED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ext4_msg</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Can&#39;t allocate:&quot;</span>
			<span class="s">&quot; Allocation context details:&quot;</span><span class="p">);</span>
	<span class="n">ext4_msg</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;status %d flags %d&quot;</span><span class="p">,</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span><span class="p">);</span>
	<span class="n">ext4_msg</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;orig %lu/%lu/%lu@%lu, &quot;</span>
		 	<span class="s">&quot;goal %lu/%lu/%lu@%lu, &quot;</span>
			<span class="s">&quot;best %lu/%lu/%lu@%lu cr %d&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span><span class="p">.</span><span class="n">fe_logical</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_start</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_logical</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_criteria</span><span class="p">);</span>
	<span class="n">ext4_msg</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;%lu scanned, %d found&quot;</span><span class="p">,</span>
		 <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_ex_scanned</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_found</span><span class="p">);</span>
	<span class="n">ext4_msg</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;groups: &quot;</span><span class="p">);</span>
	<span class="n">ngroups</span> <span class="o">=</span> <span class="n">ext4_get_groups_count</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ngroups</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">;</span>
		<span class="n">ext4_grpblk_t</span> <span class="n">start</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
		<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">list_for_each</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_prealloc_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pa</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_prealloc_space</span><span class="p">,</span>
					<span class="n">pa_group_list</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
			<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">,</span>
						     <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PA:%u:%d:%u </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			       <span class="n">start</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_free</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%u: %d/%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_free</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_fragments</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ext4_mb_show_ac</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * We use locality group preallocation for small size file. The size of the</span>
<span class="cm"> * file is determined by the current size or the resulting size after</span>
<span class="cm"> * allocation which ever is larger</span>
<span class="cm"> *</span>
<span class="cm"> * One can tune this size via /sys/fs/ext4/&lt;partition&gt;/mb_stream_req</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_group_or_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bsbits</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">isize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_DATA</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_GOAL_ONLY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">+</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
	<span class="n">isize</span> <span class="o">=</span> <span class="p">(</span><span class="n">i_size_read</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_inode</span><span class="p">)</span> <span class="o">+</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">&gt;&gt;</span> <span class="n">bsbits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">==</span> <span class="n">isize</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ext4_fs_is_busy</span><span class="p">(</span><span class="n">sbi</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_inode</span><span class="o">-&gt;</span><span class="n">i_writecount</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">|=</span> <span class="n">EXT4_MB_HINT_NOPREALLOC</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_group_prealloc</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">|=</span> <span class="n">EXT4_MB_STREAM_ALLOC</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* don&#39;t use group allocation for large files */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">isize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mb_stream_request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">|=</span> <span class="n">EXT4_MB_STREAM_ALLOC</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_lg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * locality group prealloc space are per cpu. The reason for having</span>
<span class="cm">	 * per cpu locality group is to reduce the contention between block</span>
<span class="cm">	 * request from multiple CPUs.</span>
<span class="cm">	 */</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_lg</span> <span class="o">=</span> <span class="n">__this_cpu_ptr</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_locality_groups</span><span class="p">);</span>

	<span class="cm">/* we&#39;re going to use group allocation */</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">|=</span> <span class="n">EXT4_MB_HINT_GROUP_ALLOC</span><span class="p">;</span>

	<span class="cm">/* serialize all allocations in the group */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_lg</span><span class="o">-&gt;</span><span class="n">lg_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span>
<span class="nf">ext4_mb_initialize_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ext4_allocation_request</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">goal</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">block</span><span class="p">;</span>

	<span class="cm">/* we can&#39;t allocate &gt; group size */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* just a dirty hack to filter too big requests  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">EXT4_CLUSTERS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">EXT4_CLUSTERS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>

	<span class="cm">/* start searching from the goal */</span>
	<span class="n">goal</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_data_block</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">goal</span> <span class="o">&gt;=</span> <span class="n">ext4_blocks_count</span><span class="p">(</span><span class="n">es</span><span class="p">))</span>
		<span class="n">goal</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_data_block</span><span class="p">);</span>
	<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">);</span>

	<span class="cm">/* set up allocation goals */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span><span class="p">));</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">logical</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_cluster_ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">=</span> <span class="n">AC_STATUS_CONTINUE</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span> <span class="o">=</span> <span class="n">sb</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_inode</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_logical</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_logical</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_group</span> <span class="o">=</span> <span class="n">group</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_start</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_g_ex</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">;</span>
	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* we have to define context: we&#39;ll we work with a file or</span>
<span class="cm">	 * locality group. this is a policy, actually */</span>
	<span class="n">ext4_mb_group_or_file</span><span class="p">(</span><span class="n">ac</span><span class="p">);</span>

	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;init ac: %u blocks @ %u, goal %u, flags %x, 2^%d, &quot;</span>
			<span class="s">&quot;left: %u/%u, right %u/%u to %swritable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">logical</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_2order</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">lleft</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">pleft</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">lright</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">pright</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_writecount</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;non-&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">void</span>
<span class="nf">ext4_mb_discard_lg_preallocations</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ext4_locality_group</span> <span class="o">*</span><span class="n">lg</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">order</span><span class="p">,</span> <span class="kt">int</span> <span class="n">total_entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_group_t</span> <span class="n">group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="n">e4b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">discard_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">mb_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;discard locality group preallocation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">discard_list</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">lg_prealloc_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">lg_prealloc_list</span><span class="p">[</span><span class="n">order</span><span class="p">],</span>
						<span class="n">pa_inode_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * This is the pa that we just used</span>
<span class="cm">			 * for block allocation. So don&#39;t</span>
<span class="cm">			 * free that</span>
<span class="cm">			 */</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* only lg prealloc space */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_type</span> <span class="o">!=</span> <span class="n">MB_GROUP_PA</span><span class="p">);</span>

		<span class="cm">/* seems this one can be freed ... */</span>
		<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>

		<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_inode_list</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pa_tmp_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">discard_list</span><span class="p">);</span>

		<span class="n">total_entries</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total_entries</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * we want to keep only 5 entries</span>
<span class="cm">			 * allowing it to grow to 8. This</span>
<span class="cm">			 * mak sure we don&#39;t call discard</span>
<span class="cm">			 * soon for this list.</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">lg_prealloc_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">discard_list</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">pa_tmp_list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">group</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext4_mb_load_buddy</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Error loading buddy information for %u&quot;</span><span class="p">,</span>
					<span class="n">group</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_group_list</span><span class="p">);</span>
		<span class="n">ext4_mb_release_group_pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
		<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>

		<span class="n">ext4_mb_unload_buddy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pa_tmp_list</span><span class="p">);</span>
		<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pa_rcu</span><span class="p">,</span> <span class="n">ext4_mb_pa_callback</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We have incremented pa_count. So it cannot be freed at this</span>
<span class="cm"> * point. Also we hold lg_mutex. So no parallel allocation is</span>
<span class="cm"> * possible from this lg. That means pa_free cannot be updated.</span>
<span class="cm"> *</span>
<span class="cm"> * A parallel ext4_mb_discard_group_preallocations is possible.</span>
<span class="cm"> * which can cause the lg_prealloc_list to be updated.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_mb_add_n_trim</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">order</span><span class="p">,</span> <span class="n">added</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lg_prealloc_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_locality_group</span> <span class="o">*</span><span class="n">lg</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_lg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">tmp_pa</span><span class="p">,</span> <span class="o">*</span><span class="n">pa</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_pa</span><span class="p">;</span>

	<span class="n">order</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">&gt;</span> <span class="n">PREALLOC_TB_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="cm">/* The max size of hash table is PREALLOC_TB_SIZE */</span>
		<span class="n">order</span> <span class="o">=</span> <span class="n">PREALLOC_TB_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Add the prealloc space to lg */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">tmp_pa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">lg_prealloc_list</span><span class="p">[</span><span class="n">order</span><span class="p">],</span>
						<span class="n">pa_inode_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_pa</span><span class="o">-&gt;</span><span class="n">pa_deleted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">added</span> <span class="o">&amp;&amp;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span> <span class="o">&lt;</span> <span class="n">tmp_pa</span><span class="o">-&gt;</span><span class="n">pa_free</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Add to the tail of the previous entry */</span>
			<span class="n">list_add_tail_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_inode_list</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">tmp_pa</span><span class="o">-&gt;</span><span class="n">pa_inode_list</span><span class="p">);</span>
			<span class="n">added</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * we want to count the total</span>
<span class="cm">			 * number of entries in the list</span>
<span class="cm">			 */</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
		<span class="n">lg_prealloc_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">added</span><span class="p">)</span>
		<span class="n">list_add_tail_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_inode_list</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">lg_prealloc_list</span><span class="p">[</span><span class="n">order</span><span class="p">]);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="cm">/* Now trim the list to be not more than 8 elements */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lg_prealloc_count</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_mb_discard_lg_preallocations</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">lg</span><span class="p">,</span>
						<span class="n">order</span><span class="p">,</span> <span class="n">lg_prealloc_count</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * release all resource we used in allocation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_mb_release_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_prealloc_space</span> <span class="o">*</span><span class="n">pa</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_pa</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_type</span> <span class="o">==</span> <span class="n">MB_GROUP_PA</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* see comment in ext4_mb_use_group_pa() */</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
			<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_pstart</span> <span class="o">+=</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
			<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lstart</span> <span class="o">+=</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
			<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span> <span class="o">-=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">;</span>
			<span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_len</span> <span class="o">-=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We want to add the pa to the right bucket.</span>
<span class="cm">		 * Remove it from the list and while adding</span>
<span class="cm">		 * make sure the list to which we are adding</span>
<span class="cm">		 * doesn&#39;t grow big.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_type</span> <span class="o">==</span> <span class="n">MB_GROUP_PA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">likely</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_free</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_obj_lock</span><span class="p">);</span>
			<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_inode_list</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">pa_obj_lock</span><span class="p">);</span>
			<span class="n">ext4_mb_add_n_trim</span><span class="p">(</span><span class="n">ac</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ext4_mb_put_pa</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_sb</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_bitmap_page</span><span class="p">)</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_bitmap_page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_buddy_page</span><span class="p">)</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_buddy_page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_HINT_GROUP_ALLOC</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_lg</span><span class="o">-&gt;</span><span class="n">lg_mutex</span><span class="p">);</span>
	<span class="n">ext4_mb_collect_stats</span><span class="p">(</span><span class="n">ac</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext4_mb_discard_preallocations</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">needed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_group_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">ngroups</span> <span class="o">=</span> <span class="n">ext4_get_groups_count</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">freed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">trace_ext4_mb_discard_preallocations</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">needed</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ngroups</span> <span class="o">&amp;&amp;</span> <span class="n">needed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_mb_discard_group_preallocations</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">needed</span><span class="p">);</span>
		<span class="n">freed</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">needed</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">freed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Main entry point into mballoc to allocate blocks</span>
<span class="cm"> * it tries to use preallocation first, then falls back</span>
<span class="cm"> * to usual allocation</span>
<span class="cm"> */</span>
<span class="n">ext4_fsblk_t</span> <span class="nf">ext4_mb_new_blocks</span><span class="p">(</span><span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ext4_allocation_request</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">freed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_allocation_context</span> <span class="o">*</span><span class="n">ac</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inquota</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reserv_clstrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">trace_ext4_request_blocks</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="cm">/* Allow to use superuser reservation for quota file */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_NOQUOTA</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">))</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EXT4_MB_USE_ROOT_BLOCKS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For delayed allocation, we could skip the ENOSPC and</span>
<span class="cm">	 * EDQUOT check, as blocks and quotas have been already</span>
<span class="cm">	 * reserved when data being copied into pagecache.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext4_test_inode_state</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="n">EXT4_STATE_DELALLOC_RESERVED</span><span class="p">))</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EXT4_MB_DELALLOC_RESERVED</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Without delayed allocation we need to verify</span>
<span class="cm">		 * there is enough free blocks to do block allocation</span>
<span class="cm">		 * and verify allocation doesn&#39;t exceed the quota limits.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;&amp;</span>
			<span class="n">ext4_claim_free_clusters</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* let others to free the space */</span>
			<span class="n">yield</span><span class="p">();</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reserv_clstrs</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EXT4_MB_USE_ROOT_BLOCKS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dquot_alloc_block_nofail</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span>
						 <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;&amp;</span>
				<span class="n">dquot_alloc_block</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span>
						  <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)))</span> <span class="p">{</span>

				<span class="n">ar</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EXT4_MB_HINT_NOPREALLOC</span><span class="p">;</span>
				<span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">inquota</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="o">-</span><span class="n">EDQUOT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ac</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">ext4_ac_cachep</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="n">ext4_mb_initialize_context</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">errp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_op</span> <span class="o">=</span> <span class="n">EXT4_MB_HISTORY_PREALLOC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_mb_use_preallocated</span><span class="p">(</span><span class="n">ac</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_op</span> <span class="o">=</span> <span class="n">EXT4_MB_HISTORY_ALLOC</span><span class="p">;</span>
		<span class="n">ext4_mb_normalize_request</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">ar</span><span class="p">);</span>
<span class="nl">repeat:</span>
		<span class="cm">/* allocate space in core */</span>
		<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="n">ext4_mb_regular_allocator</span><span class="p">(</span><span class="n">ac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">errp</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

		<span class="cm">/* as we&#39;ve just preallocated more space than</span>
<span class="cm">		 * user requested orinally, we store allocated</span>
<span class="cm">		 * space in a special descriptor */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">==</span> <span class="n">AC_STATUS_FOUND</span> <span class="o">&amp;&amp;</span>
				<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">&lt;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">)</span>
			<span class="n">ext4_mb_new_preallocation</span><span class="p">(</span><span class="n">ac</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">==</span> <span class="n">AC_STATUS_FOUND</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="n">ext4_mb_mark_diskspace_used</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">reserv_clstrs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">errp</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * drop the reference that we took</span>
<span class="cm">			 * in ext4_mb_use_best_found</span>
<span class="cm">			 */</span>
			<span class="n">ext4_mb_release_context</span><span class="p">(</span><span class="n">ac</span><span class="p">);</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_status</span> <span class="o">=</span> <span class="n">AC_STATUS_CONTINUE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">errp</span><span class="p">)</span>
		<span class="nl">errout:</span>
			<span class="n">ext4_discard_allocated_blocks</span><span class="p">(</span><span class="n">ac</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">block</span> <span class="o">=</span> <span class="n">ext4_grp_offs_to_block</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">);</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">freed</span>  <span class="o">=</span> <span class="n">ext4_mb_discard_preallocations</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_o_ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freed</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
		<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">errp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ac_b_ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ext4_mb_show_ac</span><span class="p">(</span><span class="n">ac</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ext4_mb_release_context</span><span class="p">(</span><span class="n">ac</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="p">)</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ext4_ac_cachep</span><span class="p">,</span> <span class="n">ac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inquota</span> <span class="o">&amp;&amp;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">inquota</span><span class="p">)</span>
		<span class="n">dquot_free_block</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">inquota</span> <span class="o">-</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_test_inode_state</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span>
					   <span class="n">EXT4_STATE_DELALLOC_RESERVED</span><span class="p">))</span>
			<span class="cm">/* release all the reserved blocks if non delalloc */</span>
			<span class="n">percpu_counter_sub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirtyclusters_counter</span><span class="p">,</span>
						<span class="n">reserv_clstrs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">trace_ext4_allocate_blocks</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">block</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">block</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We can merge two free data extents only if the physical blocks</span>
<span class="cm"> * are contiguous, AND the extents were freed by the same transaction,</span>
<span class="cm"> * AND the blocks are associated with the same group.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">can_merge</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_free_data</span> <span class="o">*</span><span class="n">entry1</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ext4_free_data</span> <span class="o">*</span><span class="n">entry2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">entry1</span><span class="o">-&gt;</span><span class="n">efd_tid</span> <span class="o">==</span> <span class="n">entry2</span><span class="o">-&gt;</span><span class="n">efd_tid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">entry1</span><span class="o">-&gt;</span><span class="n">efd_group</span> <span class="o">==</span> <span class="n">entry2</span><span class="o">-&gt;</span><span class="n">efd_group</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">entry1</span><span class="o">-&gt;</span><span class="n">efd_start_cluster</span> <span class="o">+</span> <span class="n">entry1</span><span class="o">-&gt;</span><span class="n">efd_count</span><span class="p">)</span> <span class="o">==</span> <span class="n">entry2</span><span class="o">-&gt;</span><span class="n">efd_start_cluster</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span>
<span class="nf">ext4_mb_free_metadata</span><span class="p">(</span><span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ext4_free_data</span> <span class="o">*</span><span class="n">new_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_group_t</span> <span class="n">group</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_group</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">cluster</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_free_data</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">n</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">bb_free_root</span><span class="p">.</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">new_node</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ext4_handle_valid</span><span class="p">(</span><span class="n">handle</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">new_node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">efd_node</span><span class="p">;</span>
	<span class="n">cluster</span> <span class="o">=</span> <span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">efd_start_cluster</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* first free block exent. We need to</span>
<span class="cm">		   protect buddy cache from being freed,</span>
<span class="cm">		 * otherwise we&#39;ll refresh it from</span>
<span class="cm">		 * on-disk bitmap and lose not-yet-available</span>
<span class="cm">		 * blocks */</span>
		<span class="n">page_cache_get</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_buddy_page</span><span class="p">);</span>
		<span class="n">page_cache_get</span><span class="p">(</span><span class="n">e4b</span><span class="o">-&gt;</span><span class="n">bd_bitmap_page</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_free_data</span><span class="p">,</span> <span class="n">efd_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cluster</span> <span class="o">&lt;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_start_cluster</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cluster</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_start_cluster</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_count</span><span class="p">))</span>
			<span class="n">n</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ext4_grp_locked_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">ext4_group_first_block_no</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">cluster</span><span class="p">),</span>
				<span class="s">&quot;Block already on to-be-freed list&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">bb_free_root</span><span class="p">);</span>

	<span class="cm">/* Now try to see the extent can be merged to left and right */</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">rb_prev</span><span class="p">(</span><span class="n">new_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_free_data</span><span class="p">,</span> <span class="n">efd_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">can_merge</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">new_entry</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">efd_start_cluster</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_start_cluster</span><span class="p">;</span>
			<span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">efd_count</span> <span class="o">+=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_count</span><span class="p">;</span>
			<span class="n">rb_erase</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">bb_free_root</span><span class="p">));</span>
			<span class="n">ext4_journal_callback_del</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_jce</span><span class="p">);</span>
			<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ext4_free_data_cachep</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">new_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_free_data</span><span class="p">,</span> <span class="n">efd_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">can_merge</span><span class="p">(</span><span class="n">new_entry</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">efd_count</span> <span class="o">+=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_count</span><span class="p">;</span>
			<span class="n">rb_erase</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">bb_free_root</span><span class="p">));</span>
			<span class="n">ext4_journal_callback_del</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">efd_jce</span><span class="p">);</span>
			<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ext4_free_data_cachep</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Add the extent to transaction&#39;s private list */</span>
	<span class="n">ext4_journal_callback_add</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ext4_free_data_callback</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">efd_jce</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ext4_free_blocks() -- Free given blocks and update quota</span>
<span class="cm"> * @handle:		handle for this transaction</span>
<span class="cm"> * @inode:		inode</span>
<span class="cm"> * @block:		start physical block to free</span>
<span class="cm"> * @count:		number of blocks to count</span>
<span class="cm"> * @flags:		flags used by ext4_free_blocks</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ext4_free_blocks</span><span class="p">(</span><span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="n">ext4_fsblk_t</span> <span class="n">block</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bitmap_bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">gdp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">overflow</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">gd_bh</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">block_group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="n">e4b</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count_clusters</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">)</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">block</span> <span class="o">!=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">block</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EXT4_FREE_BLOCKS_VALIDATED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ext4_data_block_valid</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Freeing blocks not in datazone - &quot;</span>
			   <span class="s">&quot;block = %llu, count = %lu&quot;</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;freeing block %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
	<span class="n">trace_ext4_free_blocks</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EXT4_FREE_BLOCKS_FORGET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">tbh</span> <span class="o">=</span> <span class="n">bh</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bh</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span>
				<span class="n">tbh</span> <span class="o">=</span> <span class="n">sb_find_get_block</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span>
							<span class="n">block</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">tbh</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">ext4_forget</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EXT4_FREE_BLOCKS_METADATA</span><span class="p">,</span>
				    <span class="n">inode</span><span class="p">,</span> <span class="n">tbh</span><span class="p">,</span> <span class="n">block</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to make sure we don&#39;t reuse the freed block until</span>
<span class="cm">	 * after the transaction is committed, which we can do by</span>
<span class="cm">	 * treating the block as metadata, below.  We make an</span>
<span class="cm">	 * exception if the inode is to be written in writeback mode</span>
<span class="cm">	 * since writeback mode has weak data consistency guarantees.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext4_should_writeback_data</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">EXT4_FREE_BLOCKS_METADATA</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the extent to be freed does not begin on a cluster</span>
<span class="cm">	 * boundary, we need to deal with partial clusters at the</span>
<span class="cm">	 * beginning and end of the extent.  Normally we will free</span>
<span class="cm">	 * blocks at the beginning or the end unless we are explicitly</span>
<span class="cm">	 * requested to avoid doing so.</span>
<span class="cm">	 */</span>
	<span class="n">overflow</span> <span class="o">=</span> <span class="n">block</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_cluster_ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">overflow</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">overflow</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_cluster_ratio</span> <span class="o">-</span> <span class="n">overflow</span><span class="p">;</span>
			<span class="n">block</span> <span class="o">+=</span> <span class="n">overflow</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">overflow</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">-=</span> <span class="n">overflow</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">block</span> <span class="o">-=</span> <span class="n">overflow</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">overflow</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">overflow</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_cluster_ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">overflow</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">overflow</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">-=</span> <span class="n">overflow</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_cluster_ratio</span> <span class="o">-</span> <span class="n">overflow</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">do_more:</span>
	<span class="n">overflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bit</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check to see if we are freeing blocks across a group</span>
<span class="cm">	 * boundary.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">bit</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">EXT4_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">overflow</span> <span class="o">=</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">bit</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span>
			<span class="n">EXT4_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">overflow</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count_clusters</span> <span class="o">=</span> <span class="n">EXT4_B2C</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">bitmap_bh</span> <span class="o">=</span> <span class="n">ext4_read_block_bitmap</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap_bh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gdp</span> <span class="o">=</span> <span class="n">ext4_get_group_desc</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gd_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_range</span><span class="p">(</span><span class="n">ext4_block_bitmap</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">),</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">in_range</span><span class="p">(</span><span class="n">ext4_inode_bitmap</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">),</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">in_range</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">ext4_inode_table</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">),</span>
		     <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_itb_per_group</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">in_range</span><span class="p">(</span><span class="n">block</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ext4_inode_table</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">),</span>
		     <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_itb_per_group</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">ext4_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Freeing blocks in system zone - &quot;</span>
			   <span class="s">&quot;Block = %llu, count = %lu&quot;</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="cm">/* err = 0. ext4_std_error should be a no op */</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="p">,</span> <span class="s">&quot;getting write access&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_journal_get_write_access</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">bitmap_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are about to modify some metadata.  Call the journal APIs</span>
<span class="cm">	 * to unshare -&gt;b_data if a currently-committing transaction is</span>
<span class="cm">	 * using it</span>
<span class="cm">	 */</span>
	<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">gd_bh</span><span class="p">,</span> <span class="s">&quot;get_write_access&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_journal_get_write_access</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">gd_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
<span class="cp">#ifdef AGGRESSIVE_CHECK</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count_clusters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">bit</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">bitmap_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">trace_ext4_mballoc_free</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">block_group</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">count_clusters</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_mb_load_buddy</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EXT4_FREE_BLOCKS_METADATA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ext4_handle_valid</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ext4_free_data</span> <span class="o">*</span><span class="n">new_entry</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * blocks being freed are metadata. these blocks shouldn&#39;t</span>
<span class="cm">		 * be used until this transaction is committed</span>
<span class="cm">		 */</span>
		<span class="n">new_entry</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">ext4_free_data_cachep</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_mb_unload_buddy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">efd_start_cluster</span> <span class="o">=</span> <span class="n">bit</span><span class="p">;</span>
		<span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">efd_group</span> <span class="o">=</span> <span class="n">block_group</span><span class="p">;</span>
		<span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">efd_count</span> <span class="o">=</span> <span class="n">count_clusters</span><span class="p">;</span>
		<span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">efd_tid</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">h_transaction</span><span class="o">-&gt;</span><span class="n">t_tid</span><span class="p">;</span>

		<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">);</span>
		<span class="n">mb_clear_bits</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">count_clusters</span><span class="p">);</span>
		<span class="n">ext4_mb_free_metadata</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">,</span> <span class="n">new_entry</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* need to update group_info-&gt;bb_free and bitmap</span>
<span class="cm">		 * with group lock held. generate_buddy look at</span>
<span class="cm">		 * them with group lock_held</span>
<span class="cm">		 */</span>
		<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">);</span>
		<span class="n">mb_clear_bits</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">count_clusters</span><span class="p">);</span>
		<span class="n">mb_free_blocks</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">count_clusters</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_free_group_clusters</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">)</span> <span class="o">+</span> <span class="n">count_clusters</span><span class="p">;</span>
	<span class="n">ext4_free_group_clusters_set</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">gdp</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">ext4_block_bitmap_csum_set</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">,</span> <span class="n">gdp</span><span class="p">,</span> <span class="n">bitmap_bh</span><span class="p">,</span>
				   <span class="n">EXT4_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ext4_group_desc_csum_set</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">,</span> <span class="n">gdp</span><span class="p">);</span>
	<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">);</span>
	<span class="n">percpu_counter_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeclusters_counter</span><span class="p">,</span> <span class="n">count_clusters</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_log_groups_per_flex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_group_t</span> <span class="n">flex_group</span> <span class="o">=</span> <span class="n">ext4_flex_group</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">block_group</span><span class="p">);</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">count_clusters</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_flex_groups</span><span class="p">[</span><span class="n">flex_group</span><span class="p">].</span><span class="n">free_clusters</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ext4_mb_unload_buddy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>

	<span class="n">freed</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EXT4_FREE_BLOCKS_NO_QUOT_UPDATE</span><span class="p">))</span>
		<span class="n">dquot_free_block</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">EXT4_C2B</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">count_clusters</span><span class="p">));</span>

	<span class="cm">/* We dirtied the bitmap block */</span>
	<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="p">,</span> <span class="s">&quot;dirtied bitmap block&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_handle_dirty_metadata</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bitmap_bh</span><span class="p">);</span>

	<span class="cm">/* And the group descriptor block */</span>
	<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">gd_bh</span><span class="p">,</span> <span class="s">&quot;dirtied group descriptor block&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_handle_dirty_metadata</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">gd_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overflow</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">block</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">overflow</span><span class="p">;</span>
		<span class="n">put_bh</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">do_more</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ext4_mark_super_dirty</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="nl">error_return:</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="p">);</span>
	<span class="n">ext4_std_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ext4_group_add_blocks() -- Add given blocks to an existing group</span>
<span class="cm"> * @handle:			handle to this transaction</span>
<span class="cm"> * @sb:				super block</span>
<span class="cm"> * @block:			start physcial block to add to the block group</span>
<span class="cm"> * @count:			number of blocks to free</span>
<span class="cm"> *</span>
<span class="cm"> * This marks the blocks as free in the bitmap and buddy.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ext4_group_add_blocks</span><span class="p">(</span><span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			 <span class="n">ext4_fsblk_t</span> <span class="n">block</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bitmap_bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">gd_bh</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">block_group</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">bit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_group_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="n">e4b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">blk_free_count</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">blocks_freed</span><span class="p">;</span>

	<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;Adding block(s) %llu-%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">block</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bit</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check to see if we are freeing blocks across a group</span>
<span class="cm">	 * boundary.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">EXT4_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_warning</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;too much blocks added to group %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">block_group</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bitmap_bh</span> <span class="o">=</span> <span class="n">ext4_read_block_bitmap</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap_bh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">ext4_get_group_desc</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gd_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_range</span><span class="p">(</span><span class="n">ext4_block_bitmap</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">desc</span><span class="p">),</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">in_range</span><span class="p">(</span><span class="n">ext4_inode_bitmap</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">desc</span><span class="p">),</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">in_range</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">ext4_inode_table</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">desc</span><span class="p">),</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_itb_per_group</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">in_range</span><span class="p">(</span><span class="n">block</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ext4_inode_table</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">desc</span><span class="p">),</span>
		     <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_itb_per_group</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Adding blocks in system zones - &quot;</span>
			   <span class="s">&quot;Block = %llu, count = %lu&quot;</span><span class="p">,</span>
			   <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="p">,</span> <span class="s">&quot;getting write access&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_journal_get_write_access</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">bitmap_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are about to modify some metadata.  Call the journal APIs</span>
<span class="cm">	 * to unshare -&gt;b_data if a currently-committing transaction is</span>
<span class="cm">	 * using it</span>
<span class="cm">	 */</span>
	<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">gd_bh</span><span class="p">,</span> <span class="s">&quot;get_write_access&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_journal_get_write_access</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">gd_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blocks_freed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="p">,</span> <span class="s">&quot;clear bit&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mb_test_bit</span><span class="p">(</span><span class="n">bit</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">bitmap_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext4_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;bit already cleared for block %llu&quot;</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">ext4_fsblk_t</span><span class="p">)(</span><span class="n">block</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
			<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="p">,</span> <span class="s">&quot;bit already cleared&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">blocks_freed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_mb_load_buddy</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * need to update group_info-&gt;bb_free and bitmap</span>
<span class="cm">	 * with group lock held. generate_buddy look at</span>
<span class="cm">	 * them with group lock_held</span>
<span class="cm">	 */</span>
	<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">);</span>
	<span class="n">mb_clear_bits</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">mb_free_blocks</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">blk_free_count</span> <span class="o">=</span> <span class="n">blocks_freed</span> <span class="o">+</span> <span class="n">ext4_free_group_clusters</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="n">ext4_free_group_clusters_set</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">blk_free_count</span><span class="p">);</span>
	<span class="n">ext4_block_bitmap_csum_set</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">bitmap_bh</span><span class="p">,</span>
				   <span class="n">EXT4_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ext4_group_desc_csum_set</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_group</span><span class="p">);</span>
	<span class="n">percpu_counter_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeclusters_counter</span><span class="p">,</span>
			   <span class="n">EXT4_B2C</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">blocks_freed</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_log_groups_per_flex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_group_t</span> <span class="n">flex_group</span> <span class="o">=</span> <span class="n">ext4_flex_group</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">block_group</span><span class="p">);</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">EXT4_B2C</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">blocks_freed</span><span class="p">),</span>
			   <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_flex_groups</span><span class="p">[</span><span class="n">flex_group</span><span class="p">].</span><span class="n">free_clusters</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ext4_mb_unload_buddy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>

	<span class="cm">/* We dirtied the bitmap block */</span>
	<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="p">,</span> <span class="s">&quot;dirtied bitmap block&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext4_handle_dirty_metadata</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bitmap_bh</span><span class="p">);</span>

	<span class="cm">/* And the group descriptor block */</span>
	<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">gd_bh</span><span class="p">,</span> <span class="s">&quot;dirtied group descriptor block&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_handle_dirty_metadata</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">gd_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">error_return:</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bitmap_bh</span><span class="p">);</span>
	<span class="n">ext4_std_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ext4_trim_extent -- function to TRIM one single free extent in the group</span>
<span class="cm"> * @sb:		super block for the file system</span>
<span class="cm"> * @start:	starting block of the free extent in the alloc. group</span>
<span class="cm"> * @count:	number of blocks to TRIM</span>
<span class="cm"> * @group:	alloc. group we are working with</span>
<span class="cm"> * @e4b:	ext4 buddy for the group</span>
<span class="cm"> *</span>
<span class="cm"> * Trim &quot;count&quot; blocks starting at &quot;start&quot; in the &quot;group&quot;. To assure that no</span>
<span class="cm"> * one will allocate those blocks, mark it as used in buddy bitmap. This must</span>
<span class="cm"> * be called with under the group lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext4_trim_extent</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
			     <span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="o">*</span><span class="n">e4b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_free_extent</span> <span class="n">ex</span><span class="p">;</span>

	<span class="n">trace_ext4_trim_extent</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">assert_spin_locked</span><span class="p">(</span><span class="n">ext4_group_lock_ptr</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">));</span>

	<span class="n">ex</span><span class="p">.</span><span class="n">fe_start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">ex</span><span class="p">.</span><span class="n">fe_group</span> <span class="o">=</span> <span class="n">group</span><span class="p">;</span>
	<span class="n">ex</span><span class="p">.</span><span class="n">fe_len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mark blocks used, so no one can reuse them while</span>
<span class="cm">	 * being trimmed.</span>
<span class="cm">	 */</span>
	<span class="n">mb_mark_used</span><span class="p">(</span><span class="n">e4b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">);</span>
	<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="n">ext4_issue_discard</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="n">mb_free_blocks</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">e4b</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">fe_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ext4_trim_all_free -- function to trim all free space in alloc. group</span>
<span class="cm"> * @sb:			super block for file system</span>
<span class="cm"> * @group:		group to be trimmed</span>
<span class="cm"> * @start:		first group block to examine</span>
<span class="cm"> * @max:		last group block to examine</span>
<span class="cm"> * @minblocks:		minimum extent block count</span>
<span class="cm"> *</span>
<span class="cm"> * ext4_trim_all_free walks through group&#39;s buddy bitmap searching for free</span>
<span class="cm"> * extents. When the free block is found, ext4_trim_extent is called to TRIM</span>
<span class="cm"> * the extent.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * ext4_trim_all_free walks through group&#39;s block bitmap searching for free</span>
<span class="cm"> * extents. When the free extent is found, mark it as used in group buddy</span>
<span class="cm"> * bitmap. Then issue a TRIM command on this extent and free the extent in</span>
<span class="cm"> * the group buddy bitmap. This is done until whole group is scanned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">ext4_grpblk_t</span>
<span class="nf">ext4_trim_all_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">,</span>
		   <span class="n">ext4_grpblk_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">ext4_grpblk_t</span> <span class="n">max</span><span class="p">,</span>
		   <span class="n">ext4_grpblk_t</span> <span class="n">minblocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">next</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">free_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_buddy</span> <span class="n">e4b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">trace_ext4_trim_all_free</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_mb_load_buddy</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Error in loading buddy &quot;</span>
				<span class="s">&quot;information for %u&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bitmap</span> <span class="o">=</span> <span class="n">e4b</span><span class="p">.</span><span class="n">bd_bitmap</span><span class="p">;</span>

	<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT4_MB_GRP_WAS_TRIMMED</span><span class="p">(</span><span class="n">e4b</span><span class="p">.</span><span class="n">bd_info</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">minblocks</span> <span class="o">&gt;=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_last_trim_minblks</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">e4b</span><span class="p">.</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_first_free</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">e4b</span><span class="p">.</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_first_free</span> <span class="o">:</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">mb_find_next_zero_bit</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">mb_find_next_bit</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">next</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">minblocks</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_trim_extent</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span>
					 <span class="n">next</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">next</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">free_count</span> <span class="o">+=</span> <span class="n">next</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">next</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fatal_signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
			<span class="n">cond_resched</span><span class="p">();</span>
			<span class="n">ext4_lock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">e4b</span><span class="p">.</span><span class="n">bd_info</span><span class="o">-&gt;</span><span class="n">bb_free</span> <span class="o">-</span> <span class="n">free_count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minblocks</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">EXT4_MB_GRP_SET_TRIMMED</span><span class="p">(</span><span class="n">e4b</span><span class="p">.</span><span class="n">bd_info</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">ext4_unlock_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="n">ext4_mb_unload_buddy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e4b</span><span class="p">);</span>

	<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;trimmed %d blocks in the group %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">count</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ext4_trim_fs() -- trim ioctl handle function</span>
<span class="cm"> * @sb:			superblock for filesystem</span>
<span class="cm"> * @range:		fstrim_range structure</span>
<span class="cm"> *</span>
<span class="cm"> * start:	First Byte to trim</span>
<span class="cm"> * len:		number of Bytes to trim from start</span>
<span class="cm"> * minlen:	minimum extent length in Bytes</span>
<span class="cm"> * ext4_trim_fs goes through all allocation groups containing Bytes from</span>
<span class="cm"> * start to start+len. For each such a group ext4_trim_all_free function</span>
<span class="cm"> * is invoked to trim all free space.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ext4_trim_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fstrim_range</span> <span class="o">*</span><span class="n">range</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_group_info</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>
	<span class="n">ext4_group_t</span> <span class="n">group</span><span class="p">,</span> <span class="n">first_group</span><span class="p">,</span> <span class="n">last_group</span><span class="p">;</span>
	<span class="n">ext4_grpblk_t</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">first_cluster</span><span class="p">,</span> <span class="n">last_cluster</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">minlen</span><span class="p">,</span> <span class="n">trimmed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">first_data_blk</span> <span class="o">=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_first_data_block</span><span class="p">);</span>
	<span class="n">ext4_fsblk_t</span> <span class="n">max_blks</span> <span class="o">=</span> <span class="n">ext4_blocks_count</span><span class="p">(</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">minlen</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">minlen</span> <span class="o">&gt;&gt;</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">minlen</span> <span class="o">&gt;</span> <span class="n">EXT4_CLUSTERS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">unlikely</span><span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">max_blks</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;=</span> <span class="n">max_blks</span><span class="p">)</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">max_blks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">first_data_blk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">first_data_blk</span><span class="p">)</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">first_data_blk</span><span class="p">;</span>

	<span class="cm">/* Determine first and last group to examine based on start and end */</span>
	<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="p">(</span><span class="n">ext4_fsblk_t</span><span class="p">)</span> <span class="n">start</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">first_group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first_cluster</span><span class="p">);</span>
	<span class="n">ext4_get_group_no_and_offset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="p">(</span><span class="n">ext4_fsblk_t</span><span class="p">)</span> <span class="n">end</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">last_group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">last_cluster</span><span class="p">);</span>

	<span class="cm">/* end now represents the last cluster to discard in this group */</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">EXT4_CLUSTERS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">group</span> <span class="o">=</span> <span class="n">first_group</span><span class="p">;</span> <span class="n">group</span> <span class="o">&lt;=</span> <span class="n">last_group</span><span class="p">;</span> <span class="n">group</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">grp</span> <span class="o">=</span> <span class="n">ext4_get_group_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="cm">/* We only do this if the grp has never been initialized */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">EXT4_MB_GRP_NEED_INIT</span><span class="p">(</span><span class="n">grp</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_mb_init_group</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * For all the groups except the last one, last cluster will</span>
<span class="cm">		 * always be EXT4_CLUSTERS_PER_GROUP(sb)-1, so we only need to</span>
<span class="cm">		 * change it for the last group, note that last_cluster is</span>
<span class="cm">		 * already computed earlier by ext4_get_group_no_and_offset()</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">==</span> <span class="n">last_group</span><span class="p">)</span>
			<span class="n">end</span> <span class="o">=</span> <span class="n">last_cluster</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">bb_free</span> <span class="o">&gt;=</span> <span class="n">minlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">ext4_trim_all_free</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">first_cluster</span><span class="p">,</span>
						<span class="n">end</span><span class="p">,</span> <span class="n">minlen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">trimmed</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * For every group except the first one, we are sure</span>
<span class="cm">		 * that the first cluster to discard will be cluster #0.</span>
<span class="cm">		 */</span>
		<span class="n">first_cluster</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EXT4_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_last_trim_minblks</span><span class="p">,</span> <span class="n">minlen</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">trimmed</span> <span class="o">*</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
