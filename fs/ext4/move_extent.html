<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › ext4 › move_extent.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>move_extent.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2008,2009 NEC Software Tohoku, Ltd.</span>
<span class="cm"> * Written by Takashi Sato &lt;t-sato@yk.jp.nec.com&gt;</span>
<span class="cm"> *            Akira Fujita &lt;a-fujita@rs.jp.nec.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2.1 of the GNU Lesser General Public License</span>
<span class="cm"> * as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/quotaops.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;ext4_jbd2.h&quot;</span>
<span class="cp">#include &quot;ext4.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * get_ext_path - Find an extent path for designated logical block number.</span>
<span class="cm"> *</span>
<span class="cm"> * @inode:	an inode which is searched</span>
<span class="cm"> * @lblock:	logical block number to find an extent path</span>
<span class="cm"> * @path:	pointer to an extent path pointer (for output)</span>
<span class="cm"> *</span>
<span class="cm"> * ext4_ext_find_extent wrapper. Return 0 on success, or a negative error value</span>
<span class="cm"> * on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">get_ext_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">ext4_lblk_t</span> <span class="n">lblock</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ext4_ext_path</span> <span class="o">**</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="n">ext4_ext_find_extent</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">);</span>
		<span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">path</span><span class="p">)[</span><span class="n">ext_depth</span><span class="p">(</span><span class="n">inode</span><span class="p">)].</span><span class="n">p_ext</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * copy_extent_status - Copy the extent&#39;s initialization status</span>
<span class="cm"> *</span>
<span class="cm"> * @src:	an extent for getting initialize status</span>
<span class="cm"> * @dest:	an extent to be set the status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">copy_extent_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext4_ext_is_uninitialized</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
		<span class="n">ext4_ext_mark_uninitialized</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dest</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="n">dest</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mext_next_extent - Search for the next extent and set it to &quot;extent&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * @inode:	inode which is searched</span>
<span class="cm"> * @path:	this will obtain data for the next extent</span>
<span class="cm"> * @extent:	pointer to the next extent we have just gotten</span>
<span class="cm"> *</span>
<span class="cm"> * Search the next extent in the array of ext4_ext_path structure (@path)</span>
<span class="cm"> * and set it to ext4_extent structure (@extent). In addition, the member of</span>
<span class="cm"> * @path (-&gt;p_ext) also points the next extent. Return 0 on success, 1 if</span>
<span class="cm"> * ext4_ext_path structure refers to the last extent, or a negative error</span>
<span class="cm"> * value on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mext_next_extent</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_ext_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">**</span><span class="n">extent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_extent_header</span> <span class="o">*</span><span class="n">eh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">leaf_ppos</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">p_depth</span><span class="p">;</span>

	<span class="n">ppos</span> <span class="o">=</span> <span class="n">leaf_ppos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT_LAST_EXTENT</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="p">].</span><span class="n">p_hdr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="p">].</span><span class="n">p_ext</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* leaf block */</span>
		<span class="o">*</span><span class="n">extent</span> <span class="o">=</span> <span class="o">++</span><span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="p">].</span><span class="n">p_ext</span><span class="p">;</span>
		<span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="p">].</span><span class="n">p_block</span> <span class="o">=</span> <span class="n">ext4_ext_pblock</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="p">].</span><span class="n">p_ext</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">ppos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">EXT_LAST_INDEX</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="p">].</span><span class="n">p_hdr</span><span class="p">)</span> <span class="o">&gt;</span>
		    <span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="p">].</span><span class="n">p_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">cur_ppos</span> <span class="o">=</span> <span class="n">ppos</span><span class="p">;</span>

			<span class="cm">/* index block */</span>
			<span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="p">].</span><span class="n">p_idx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="p">].</span><span class="n">p_block</span> <span class="o">=</span> <span class="n">ext4_idx_pblock</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="p">].</span><span class="n">p_idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">p_bh</span><span class="p">)</span>
				<span class="n">brelse</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">p_bh</span><span class="p">);</span>
			<span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">p_bh</span> <span class="o">=</span>
				<span class="n">sb_bread</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="p">].</span><span class="n">p_block</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">p_bh</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">p_hdr</span> <span class="o">=</span>
				<span class="n">ext_block_hdr</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">ppos</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">p_bh</span><span class="p">);</span>

			<span class="cm">/* Halfway index block */</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">cur_ppos</span> <span class="o">&lt;</span> <span class="n">leaf_ppos</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">path</span><span class="p">[</span><span class="n">cur_ppos</span><span class="p">].</span><span class="n">p_idx</span> <span class="o">=</span>
					<span class="n">EXT_FIRST_INDEX</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">cur_ppos</span><span class="p">].</span><span class="n">p_hdr</span><span class="p">);</span>
				<span class="n">path</span><span class="p">[</span><span class="n">cur_ppos</span><span class="p">].</span><span class="n">p_block</span> <span class="o">=</span>
					<span class="n">ext4_idx_pblock</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">cur_ppos</span><span class="p">].</span><span class="n">p_idx</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">cur_ppos</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">p_bh</span><span class="p">)</span>
					<span class="n">brelse</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">cur_ppos</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">p_bh</span><span class="p">);</span>
				<span class="n">path</span><span class="p">[</span><span class="n">cur_ppos</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">p_bh</span> <span class="o">=</span> <span class="n">sb_bread</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span>
					<span class="n">path</span><span class="p">[</span><span class="n">cur_ppos</span><span class="p">].</span><span class="n">p_block</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">[</span><span class="n">cur_ppos</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">p_bh</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="n">path</span><span class="p">[</span><span class="n">cur_ppos</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">p_hdr</span> <span class="o">=</span>
					<span class="n">ext_block_hdr</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">cur_ppos</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">p_bh</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">path</span><span class="p">[</span><span class="n">leaf_ppos</span><span class="p">].</span><span class="n">p_ext</span> <span class="o">=</span> <span class="o">*</span><span class="n">extent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">eh</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">leaf_ppos</span><span class="p">].</span><span class="n">p_hdr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">eh_entries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* empty leaf is found */</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>

			<span class="cm">/* leaf block */</span>
			<span class="n">path</span><span class="p">[</span><span class="n">leaf_ppos</span><span class="p">].</span><span class="n">p_ext</span> <span class="o">=</span> <span class="o">*</span><span class="n">extent</span> <span class="o">=</span>
				<span class="n">EXT_FIRST_EXTENT</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">leaf_ppos</span><span class="p">].</span><span class="n">p_hdr</span><span class="p">);</span>
			<span class="n">path</span><span class="p">[</span><span class="n">leaf_ppos</span><span class="p">].</span><span class="n">p_block</span> <span class="o">=</span>
					<span class="n">ext4_ext_pblock</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">leaf_ppos</span><span class="p">].</span><span class="n">p_ext</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* We found the last extent */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mext_check_null_inode - NULL check for two inodes</span>
<span class="cm"> *</span>
<span class="cm"> * If inode1 or inode2 is NULL, return -EIO. Otherwise, return 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mext_check_null_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode2</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode1</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__ext4_error</span><span class="p">(</span><span class="n">inode2</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
			<span class="s">&quot;Both inodes should not be NULL: &quot;</span>
			<span class="s">&quot;inode1 NULL inode2 %lu&quot;</span><span class="p">,</span> <span class="n">inode2</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inode2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__ext4_error</span><span class="p">(</span><span class="n">inode1</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
			<span class="s">&quot;Both inodes should not be NULL: &quot;</span>
			<span class="s">&quot;inode1 %lu inode2 NULL&quot;</span><span class="p">,</span> <span class="n">inode1</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * double_down_write_data_sem - Acquire two inodes&#39; write lock of i_data_sem</span>
<span class="cm"> *</span>
<span class="cm"> * @orig_inode:		original inode structure</span>
<span class="cm"> * @donor_inode:	donor inode structure</span>
<span class="cm"> * Acquire write lock of i_data_sem of the two inodes (orig and donor) by</span>
<span class="cm"> * i_ino order.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">double_down_write_data_sem</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">orig_inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">donor_inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="n">orig_inode</span><span class="p">,</span> <span class="o">*</span><span class="n">second</span> <span class="o">=</span> <span class="n">donor_inode</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use the inode number to provide the stable locking order instead</span>
<span class="cm">	 * of its address, because the C language doesn&#39;t guarantee you can</span>
<span class="cm">	 * compare pointers that don&#39;t come from the same array.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">&lt;</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">first</span> <span class="o">=</span> <span class="n">donor_inode</span><span class="p">;</span>
		<span class="n">second</span> <span class="o">=</span> <span class="n">orig_inode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EXT4_I</span><span class="p">(</span><span class="n">first</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_data_sem</span><span class="p">);</span>
	<span class="n">down_write_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EXT4_I</span><span class="p">(</span><span class="n">second</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_data_sem</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * double_up_write_data_sem - Release two inodes&#39; write lock of i_data_sem</span>
<span class="cm"> *</span>
<span class="cm"> * @orig_inode:		original inode structure to be released its lock first</span>
<span class="cm"> * @donor_inode:	donor inode structure to be released its lock second</span>
<span class="cm"> * Release write lock of i_data_sem of two inodes (orig and donor).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">double_up_write_data_sem</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">orig_inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">donor_inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EXT4_I</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_data_sem</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EXT4_I</span><span class="p">(</span><span class="n">donor_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_data_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mext_insert_across_blocks - Insert extents across leaf block</span>
<span class="cm"> *</span>
<span class="cm"> * @handle:		journal handle</span>
<span class="cm"> * @orig_inode:		original inode</span>
<span class="cm"> * @o_start:		first original extent to be changed</span>
<span class="cm"> * @o_end:		last original extent to be changed</span>
<span class="cm"> * @start_ext:		first new extent to be inserted</span>
<span class="cm"> * @new_ext:		middle of new extent to be inserted</span>
<span class="cm"> * @end_ext:		last new extent to be inserted</span>
<span class="cm"> *</span>
<span class="cm"> * Allocate a new leaf block and insert extents into it. Return 0 on success,</span>
<span class="cm"> * or a negative error value on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mext_insert_across_blocks</span><span class="p">(</span><span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">orig_inode</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">o_start</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">o_end</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">start_ext</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">new_ext</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">end_ext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_ext_path</span> <span class="o">*</span><span class="n">orig_path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ext4_lblk_t</span> <span class="n">eblock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">&amp;&amp;</span> <span class="n">new_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">&amp;&amp;</span> <span class="n">end_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">o_start</span> <span class="o">==</span> <span class="n">o_end</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/*       start_ext   new_ext    end_ext</span>
<span class="cm">			 * donor |---------|-----------|--------|</span>
<span class="cm">			 * orig  |------------------------------|</span>
<span class="cm">			 */</span>
			<span class="n">end_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="cm">/*       start_ext   new_ext   end_ext</span>
<span class="cm">			 * donor |---------|----------|---------|</span>
<span class="cm">			 * orig  |---------------|--------------|</span>
<span class="cm">			 */</span>
			<span class="n">o_end</span><span class="o">-&gt;</span><span class="n">ee_block</span> <span class="o">=</span> <span class="n">end_ext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">;</span>
			<span class="n">o_end</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">=</span> <span class="n">end_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span><span class="p">;</span>
			<span class="n">ext4_ext_store_pblock</span><span class="p">(</span><span class="n">o_end</span><span class="p">,</span> <span class="n">ext4_ext_pblock</span><span class="p">(</span><span class="n">end_ext</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">o_start</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">=</span> <span class="n">start_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span><span class="p">;</span>
		<span class="n">eblock</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">start_ext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">);</span>
		<span class="n">new_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">start_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">&amp;&amp;</span> <span class="n">new_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">end_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">&amp;&amp;</span> <span class="n">o_start</span> <span class="o">==</span> <span class="n">o_end</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*	 start_ext	new_ext</span>
<span class="cm">		 * donor |--------------|---------------|</span>
<span class="cm">		 * orig  |------------------------------|</span>
<span class="cm">		 */</span>
		<span class="n">o_start</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">=</span> <span class="n">start_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span><span class="p">;</span>
		<span class="n">eblock</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">start_ext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">);</span>
		<span class="n">new_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">start_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">&amp;&amp;</span> <span class="n">new_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">&amp;&amp;</span>
		   <span class="n">end_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">&amp;&amp;</span> <span class="n">o_start</span> <span class="o">==</span> <span class="n">o_end</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*	  new_ext	end_ext</span>
<span class="cm">		 * donor |--------------|---------------|</span>
<span class="cm">		 * orig  |------------------------------|</span>
<span class="cm">		 */</span>
		<span class="n">o_end</span><span class="o">-&gt;</span><span class="n">ee_block</span> <span class="o">=</span> <span class="n">end_ext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">;</span>
		<span class="n">o_end</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">=</span> <span class="n">end_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span><span class="p">;</span>
		<span class="n">ext4_ext_store_pblock</span><span class="p">(</span><span class="n">o_end</span><span class="p">,</span> <span class="n">ext4_ext_pblock</span><span class="p">(</span><span class="n">end_ext</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set 0 to the extent block if new_ext was</span>
<span class="cm">		 * the first block.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_ext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span>
			<span class="n">eblock</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">new_ext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">);</span>

		<span class="n">new_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: Unexpected insert case</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_ext_path</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">eblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ext4_ext_insert_extent</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">orig_inode</span><span class="p">,</span>
					<span class="n">orig_path</span><span class="p">,</span> <span class="n">new_ext</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_ext_path</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">end_ext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ext4_ext_insert_extent</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">orig_inode</span><span class="p">,</span>
					   <span class="n">orig_path</span><span class="p">,</span> <span class="n">end_ext</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">orig_path</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_ext_drop_refs</span><span class="p">(</span><span class="n">orig_path</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">orig_path</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mext_insert_inside_block - Insert new extent to the extent block</span>
<span class="cm"> *</span>
<span class="cm"> * @o_start:		first original extent to be moved</span>
<span class="cm"> * @o_end:		last original extent to be moved</span>
<span class="cm"> * @start_ext:		first new extent to be inserted</span>
<span class="cm"> * @new_ext:		middle of new extent to be inserted</span>
<span class="cm"> * @end_ext:		last new extent to be inserted</span>
<span class="cm"> * @eh:			extent header of target leaf block</span>
<span class="cm"> * @range_to_move:	used to decide how to insert extent</span>
<span class="cm"> *</span>
<span class="cm"> * Insert extents into the leaf block. The extent (@o_start) is overwritten</span>
<span class="cm"> * by inserted extents.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mext_insert_inside_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">o_start</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">o_end</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">start_ext</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">new_ext</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">end_ext</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ext4_extent_header</span> <span class="o">*</span><span class="n">eh</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">range_to_move</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Move the existing extents */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">range_to_move</span> <span class="o">&amp;&amp;</span> <span class="n">o_end</span> <span class="o">&lt;</span> <span class="n">EXT_LAST_EXTENT</span><span class="p">(</span><span class="n">eh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">EXT_LAST_EXTENT</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">o_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">o_end</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">range_to_move</span><span class="p">,</span> <span class="n">o_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Insert start entry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span><span class="p">)</span>
		<span class="n">o_start</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">ee_len</span> <span class="o">=</span> <span class="n">start_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span><span class="p">;</span>

	<span class="cm">/* Insert new entry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">o_start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">new_ext</span><span class="p">;</span>
		<span class="n">ext4_ext_store_pblock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">o_start</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">],</span> <span class="n">ext4_ext_pblock</span><span class="p">(</span><span class="n">new_ext</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Insert end entry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span><span class="p">)</span>
		<span class="n">o_start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">end_ext</span><span class="p">;</span>

	<span class="cm">/* Increment the total entries counter on the extent block */</span>
	<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">eh_entries</span><span class="p">,</span> <span class="n">range_to_move</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mext_insert_extents - Insert new extent</span>
<span class="cm"> *</span>
<span class="cm"> * @handle:	journal handle</span>
<span class="cm"> * @orig_inode:	original inode</span>
<span class="cm"> * @orig_path:	path indicates first extent to be changed</span>
<span class="cm"> * @o_start:	first original extent to be changed</span>
<span class="cm"> * @o_end:	last original extent to be changed</span>
<span class="cm"> * @start_ext:	first new extent to be inserted</span>
<span class="cm"> * @new_ext:	middle of new extent to be inserted</span>
<span class="cm"> * @end_ext:	last new extent to be inserted</span>
<span class="cm"> *</span>
<span class="cm"> * Call the function to insert extents. If we cannot add more extents into</span>
<span class="cm"> * the leaf block, we call mext_insert_across_blocks() to create a</span>
<span class="cm"> * new leaf block. Otherwise call mext_insert_inside_block(). Return 0</span>
<span class="cm"> * on success, or a negative error value on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mext_insert_extents</span><span class="p">(</span><span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">orig_inode</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ext4_ext_path</span> <span class="o">*</span><span class="n">orig_path</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">o_start</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">o_end</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">start_ext</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">new_ext</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">end_ext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>  <span class="n">ext4_extent_header</span> <span class="o">*</span><span class="n">eh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">need_slots</span><span class="p">,</span> <span class="n">slots_range</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">range_to_move</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The extents need to be inserted</span>
<span class="cm">	 * start_extent + new_extent + end_extent.</span>
<span class="cm">	 */</span>
	<span class="n">need_slots</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">end_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">new_ext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* The number of slots between start and end */</span>
	<span class="n">slots_range</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">o_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">o_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_extent</span><span class="p">);</span>

	<span class="cm">/* Range to move the end of extent */</span>
	<span class="n">range_to_move</span> <span class="o">=</span> <span class="n">need_slots</span> <span class="o">-</span> <span class="n">slots_range</span><span class="p">;</span>
	<span class="n">depth</span> <span class="o">=</span> <span class="n">orig_path</span><span class="o">-&gt;</span><span class="n">p_depth</span><span class="p">;</span>
	<span class="n">orig_path</span> <span class="o">+=</span> <span class="n">depth</span><span class="p">;</span>
	<span class="n">eh</span> <span class="o">=</span> <span class="n">orig_path</span><span class="o">-&gt;</span><span class="n">p_hdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Register to journal */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_journal_get_write_access</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">orig_path</span><span class="o">-&gt;</span><span class="n">p_bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Expansion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">range_to_move</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">range_to_move</span> <span class="o">&gt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">eh_max</span><span class="p">)</span>
			<span class="o">-</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">eh_entries</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">mext_insert_across_blocks</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">orig_inode</span><span class="p">,</span> <span class="n">o_start</span><span class="p">,</span>
					<span class="n">o_end</span><span class="p">,</span> <span class="n">start_ext</span><span class="p">,</span> <span class="n">new_ext</span><span class="p">,</span> <span class="n">end_ext</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mext_insert_inside_block</span><span class="p">(</span><span class="n">o_start</span><span class="p">,</span> <span class="n">o_end</span><span class="p">,</span> <span class="n">start_ext</span><span class="p">,</span> <span class="n">new_ext</span><span class="p">,</span>
						<span class="n">end_ext</span><span class="p">,</span> <span class="n">eh</span><span class="p">,</span> <span class="n">range_to_move</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_handle_dirty_metadata</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">orig_inode</span><span class="p">,</span>
						 <span class="n">orig_path</span><span class="o">-&gt;</span><span class="n">p_bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ext4_mark_inode_dirty</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">orig_inode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mext_leaf_block - Move one leaf extent block into the inode.</span>
<span class="cm"> *</span>
<span class="cm"> * @handle:		journal handle</span>
<span class="cm"> * @orig_inode:		original inode</span>
<span class="cm"> * @orig_path:		path indicates first extent to be changed</span>
<span class="cm"> * @dext:		donor extent</span>
<span class="cm"> * @from:		start offset on the target file</span>
<span class="cm"> *</span>
<span class="cm"> * In order to insert extents into the leaf block, we must divide the extent</span>
<span class="cm"> * in the leaf block into three extents. The one is located to be inserted</span>
<span class="cm"> * extents, and the others are located around it.</span>
<span class="cm"> *</span>
<span class="cm"> * Therefore, this function creates structures to save extents of the leaf</span>
<span class="cm"> * block, and inserts extents by calling mext_insert_extents() with</span>
<span class="cm"> * created extents. Return 0 on success, or a negative error value on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mext_leaf_block</span><span class="p">(</span><span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">orig_inode</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">ext4_ext_path</span> <span class="o">*</span><span class="n">orig_path</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">dext</span><span class="p">,</span>
		     <span class="n">ext4_lblk_t</span> <span class="o">*</span><span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">oext</span><span class="p">,</span> <span class="o">*</span><span class="n">o_start</span><span class="p">,</span> <span class="o">*</span><span class="n">o_end</span><span class="p">,</span> <span class="o">*</span><span class="n">prev_ext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_extent</span> <span class="n">new_ext</span><span class="p">,</span> <span class="n">start_ext</span><span class="p">,</span> <span class="n">end_ext</span><span class="p">;</span>
	<span class="n">ext4_lblk_t</span> <span class="n">new_ext_end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oext_alen</span><span class="p">,</span> <span class="n">new_ext_alen</span><span class="p">,</span> <span class="n">end_ext_alen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">ext_depth</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">start_ext</span><span class="p">.</span><span class="n">ee_block</span> <span class="o">=</span> <span class="n">end_ext</span><span class="p">.</span><span class="n">ee_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">o_start</span> <span class="o">=</span> <span class="n">o_end</span> <span class="o">=</span> <span class="n">oext</span> <span class="o">=</span> <span class="n">orig_path</span><span class="p">[</span><span class="n">depth</span><span class="p">].</span><span class="n">p_ext</span><span class="p">;</span>
	<span class="n">oext_alen</span> <span class="o">=</span> <span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="n">oext</span><span class="p">);</span>
	<span class="n">start_ext</span><span class="p">.</span><span class="n">ee_len</span> <span class="o">=</span> <span class="n">end_ext</span><span class="p">.</span><span class="n">ee_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">new_ext</span><span class="p">.</span><span class="n">ee_block</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="n">from</span><span class="p">);</span>
	<span class="n">ext4_ext_store_pblock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_ext</span><span class="p">,</span> <span class="n">ext4_ext_pblock</span><span class="p">(</span><span class="n">dext</span><span class="p">));</span>
	<span class="n">new_ext</span><span class="p">.</span><span class="n">ee_len</span> <span class="o">=</span> <span class="n">dext</span><span class="o">-&gt;</span><span class="n">ee_len</span><span class="p">;</span>
	<span class="n">new_ext_alen</span> <span class="o">=</span> <span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_ext</span><span class="p">);</span>
	<span class="n">new_ext_end</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">new_ext</span><span class="p">.</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">+</span> <span class="n">new_ext_alen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Case: original extent is first</span>
<span class="cm">	 * oext      |--------|</span>
<span class="cm">	 * new_ext      |--|</span>
<span class="cm">	 * start_ext |--|</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">oext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">new_ext</span><span class="p">.</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">new_ext</span><span class="p">.</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">&lt;</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">oext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">+</span> <span class="n">oext_alen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start_ext</span><span class="p">.</span><span class="n">ee_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">new_ext</span><span class="p">.</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">-</span>
					       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">oext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">));</span>
		<span class="n">start_ext</span><span class="p">.</span><span class="n">ee_block</span> <span class="o">=</span> <span class="n">oext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">;</span>
		<span class="n">copy_extent_status</span><span class="p">(</span><span class="n">oext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start_ext</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">oext</span> <span class="o">&gt;</span> <span class="n">EXT_FIRST_EXTENT</span><span class="p">(</span><span class="n">orig_path</span><span class="p">[</span><span class="n">depth</span><span class="p">].</span><span class="n">p_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prev_ext</span> <span class="o">=</span> <span class="n">oext</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * We can merge new_ext into previous extent,</span>
<span class="cm">		 * if these are contiguous and same extent type.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext4_can_extents_be_merged</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">prev_ext</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">new_ext</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">o_start</span> <span class="o">=</span> <span class="n">prev_ext</span><span class="p">;</span>
			<span class="n">start_ext</span><span class="p">.</span><span class="n">ee_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
				<span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="n">prev_ext</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">new_ext_alen</span><span class="p">);</span>
			<span class="n">start_ext</span><span class="p">.</span><span class="n">ee_block</span> <span class="o">=</span> <span class="n">oext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">;</span>
			<span class="n">copy_extent_status</span><span class="p">(</span><span class="n">prev_ext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start_ext</span><span class="p">);</span>
			<span class="n">new_ext</span><span class="p">.</span><span class="n">ee_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Case: new_ext_end must be less than oext</span>
<span class="cm">	 * oext      |-----------|</span>
<span class="cm">	 * new_ext       |-------|</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">oext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">+</span> <span class="n">oext_alen</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">new_ext_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXT4_ERROR_INODE</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span>
			<span class="s">&quot;new_ext_end(%u) should be less than or equal to &quot;</span>
			<span class="s">&quot;oext-&gt;ee_block(%u) + oext_alen(%d) - 1&quot;</span><span class="p">,</span>
			<span class="n">new_ext_end</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">oext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">),</span>
			<span class="n">oext_alen</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Case: new_ext is smaller than original extent</span>
<span class="cm">	 * oext    |---------------|</span>
<span class="cm">	 * new_ext |-----------|</span>
<span class="cm">	 * end_ext             |---|</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">oext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">new_ext_end</span> <span class="o">&amp;&amp;</span>
		<span class="n">new_ext_end</span> <span class="o">&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">oext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">+</span> <span class="n">oext_alen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">end_ext</span><span class="p">.</span><span class="n">ee_len</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">oext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">oext_alen</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">new_ext_end</span><span class="p">);</span>
		<span class="n">copy_extent_status</span><span class="p">(</span><span class="n">oext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end_ext</span><span class="p">);</span>
		<span class="n">end_ext_alen</span> <span class="o">=</span> <span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end_ext</span><span class="p">);</span>
		<span class="n">ext4_ext_store_pblock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end_ext</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ext4_ext_pblock</span><span class="p">(</span><span class="n">o_end</span><span class="p">)</span> <span class="o">+</span> <span class="n">oext_alen</span> <span class="o">-</span> <span class="n">end_ext_alen</span><span class="p">));</span>
		<span class="n">end_ext</span><span class="p">.</span><span class="n">ee_block</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">o_end</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">oext_alen</span> <span class="o">-</span> <span class="n">end_ext_alen</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mext_insert_extents</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">orig_inode</span><span class="p">,</span> <span class="n">orig_path</span><span class="p">,</span> <span class="n">o_start</span><span class="p">,</span>
				<span class="n">o_end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start_ext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_ext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end_ext</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mext_calc_swap_extents - Calculate extents for extent swapping.</span>
<span class="cm"> *</span>
<span class="cm"> * @tmp_dext:		the extent that will belong to the original inode</span>
<span class="cm"> * @tmp_oext:		the extent that will belong to the donor inode</span>
<span class="cm"> * @orig_off:		block offset of original inode</span>
<span class="cm"> * @donor_off:		block offset of donor inode</span>
<span class="cm"> * @max_count:		the maximum length of extents</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success, or a negative error value on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mext_calc_swap_extents</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">tmp_dext</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">tmp_oext</span><span class="p">,</span>
			      <span class="n">ext4_lblk_t</span> <span class="n">orig_off</span><span class="p">,</span> <span class="n">ext4_lblk_t</span> <span class="n">donor_off</span><span class="p">,</span>
			      <span class="n">ext4_lblk_t</span> <span class="n">max_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_lblk_t</span> <span class="n">diff</span><span class="p">,</span> <span class="n">orig_diff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_extent</span> <span class="n">dext_old</span><span class="p">,</span> <span class="n">oext_old</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">orig_off</span> <span class="o">!=</span> <span class="n">donor_off</span><span class="p">);</span>

	<span class="cm">/* original and donor extents have to cover the same block offset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">orig_off</span> <span class="o">&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tmp_oext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tmp_oext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="n">tmp_oext</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">orig_off</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orig_off</span> <span class="o">&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tmp_dext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tmp_dext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="n">tmp_dext</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">orig_off</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>

	<span class="n">dext_old</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp_dext</span><span class="p">;</span>
	<span class="n">oext_old</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp_oext</span><span class="p">;</span>

	<span class="cm">/* When tmp_dext is too large, pick up the target range. */</span>
	<span class="n">diff</span> <span class="o">=</span> <span class="n">donor_off</span> <span class="o">-</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tmp_dext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">);</span>

	<span class="n">ext4_ext_store_pblock</span><span class="p">(</span><span class="n">tmp_dext</span><span class="p">,</span> <span class="n">ext4_ext_pblock</span><span class="p">(</span><span class="n">tmp_dext</span><span class="p">)</span> <span class="o">+</span> <span class="n">diff</span><span class="p">);</span>
	<span class="n">tmp_dext</span><span class="o">-&gt;</span><span class="n">ee_block</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tmp_dext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">+</span> <span class="n">diff</span><span class="p">);</span>
	<span class="n">tmp_dext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tmp_dext</span><span class="o">-&gt;</span><span class="n">ee_len</span><span class="p">)</span> <span class="o">-</span> <span class="n">diff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_count</span> <span class="o">&lt;</span> <span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="n">tmp_dext</span><span class="p">))</span>
		<span class="n">tmp_dext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">max_count</span><span class="p">);</span>

	<span class="n">orig_diff</span> <span class="o">=</span> <span class="n">orig_off</span> <span class="o">-</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tmp_oext</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">);</span>
	<span class="n">ext4_ext_store_pblock</span><span class="p">(</span><span class="n">tmp_oext</span><span class="p">,</span> <span class="n">ext4_ext_pblock</span><span class="p">(</span><span class="n">tmp_oext</span><span class="p">)</span> <span class="o">+</span> <span class="n">orig_diff</span><span class="p">);</span>

	<span class="cm">/* Adjust extent length if donor extent is larger than orig */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="n">tmp_dext</span><span class="p">)</span> <span class="o">&gt;</span>
	    <span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="n">tmp_oext</span><span class="p">)</span> <span class="o">-</span> <span class="n">orig_diff</span><span class="p">)</span>
		<span class="n">tmp_dext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tmp_oext</span><span class="o">-&gt;</span><span class="n">ee_len</span><span class="p">)</span> <span class="o">-</span>
						<span class="n">orig_diff</span><span class="p">);</span>

	<span class="n">tmp_oext</span><span class="o">-&gt;</span><span class="n">ee_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="n">tmp_dext</span><span class="p">));</span>

	<span class="n">copy_extent_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oext_old</span><span class="p">,</span> <span class="n">tmp_dext</span><span class="p">);</span>
	<span class="n">copy_extent_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dext_old</span><span class="p">,</span> <span class="n">tmp_oext</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mext_replace_branches - Replace original extents with new extents</span>
<span class="cm"> *</span>
<span class="cm"> * @handle:		journal handle</span>
<span class="cm"> * @orig_inode:		original inode</span>
<span class="cm"> * @donor_inode:	donor inode</span>
<span class="cm"> * @from:		block offset of orig_inode</span>
<span class="cm"> * @count:		block count to be replaced</span>
<span class="cm"> * @err:		pointer to save return value</span>
<span class="cm"> *</span>
<span class="cm"> * Replace original inode extents and donor inode extents page by page.</span>
<span class="cm"> * We implement this replacement in the following three steps:</span>
<span class="cm"> * 1. Save the block information of original and donor inodes into</span>
<span class="cm"> *    dummy extents.</span>
<span class="cm"> * 2. Change the block information of original inode to point at the</span>
<span class="cm"> *    donor inode blocks.</span>
<span class="cm"> * 3. Change the block information of donor inode to point at the saved</span>
<span class="cm"> *    original inode blocks in the dummy extents.</span>
<span class="cm"> *</span>
<span class="cm"> * Return replaced block count.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mext_replace_branches</span><span class="p">(</span><span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">orig_inode</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">donor_inode</span><span class="p">,</span> <span class="n">ext4_lblk_t</span> <span class="n">from</span><span class="p">,</span>
			   <span class="n">ext4_lblk_t</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext4_ext_path</span> <span class="o">*</span><span class="n">orig_path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_ext_path</span> <span class="o">*</span><span class="n">donor_path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">oext</span><span class="p">,</span> <span class="o">*</span><span class="n">dext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_extent</span> <span class="n">tmp_dext</span><span class="p">,</span> <span class="n">tmp_oext</span><span class="p">;</span>
	<span class="n">ext4_lblk_t</span> <span class="n">orig_off</span> <span class="o">=</span> <span class="n">from</span><span class="p">,</span> <span class="n">donor_off</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">depth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">replaced_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dext_alen</span><span class="p">;</span>

	<span class="cm">/* Protect extent trees against block allocations via delalloc */</span>
	<span class="n">double_down_write_data_sem</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">donor_inode</span><span class="p">);</span>

	<span class="cm">/* Get the original extent for the block &quot;orig_off&quot; */</span>
	<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">get_ext_path</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">orig_off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Get the donor extent for the head */</span>
	<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">get_ext_path</span><span class="p">(</span><span class="n">donor_inode</span><span class="p">,</span> <span class="n">donor_off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">donor_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">depth</span> <span class="o">=</span> <span class="n">ext_depth</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">);</span>
	<span class="n">oext</span> <span class="o">=</span> <span class="n">orig_path</span><span class="p">[</span><span class="n">depth</span><span class="p">].</span><span class="n">p_ext</span><span class="p">;</span>
	<span class="n">tmp_oext</span> <span class="o">=</span> <span class="o">*</span><span class="n">oext</span><span class="p">;</span>

	<span class="n">depth</span> <span class="o">=</span> <span class="n">ext_depth</span><span class="p">(</span><span class="n">donor_inode</span><span class="p">);</span>
	<span class="n">dext</span> <span class="o">=</span> <span class="n">donor_path</span><span class="p">[</span><span class="n">depth</span><span class="p">].</span><span class="n">p_ext</span><span class="p">;</span>
	<span class="n">tmp_dext</span> <span class="o">=</span> <span class="o">*</span><span class="n">dext</span><span class="p">;</span>

	<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">mext_calc_swap_extents</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_dext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_oext</span><span class="p">,</span> <span class="n">orig_off</span><span class="p">,</span>
				      <span class="n">donor_off</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Loop for the donor extents */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The extent for donor must be found. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dext</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">EXT4_ERROR_INODE</span><span class="p">(</span><span class="n">donor_inode</span><span class="p">,</span>
				   <span class="s">&quot;The extent for donor must be found&quot;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">donor_off</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tmp_dext</span><span class="p">.</span><span class="n">ee_block</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">EXT4_ERROR_INODE</span><span class="p">(</span><span class="n">donor_inode</span><span class="p">,</span>
				<span class="s">&quot;Donor offset(%u) and the first block of donor &quot;</span>
				<span class="s">&quot;extent(%u) should be equal&quot;</span><span class="p">,</span>
				<span class="n">donor_off</span><span class="p">,</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tmp_dext</span><span class="p">.</span><span class="n">ee_block</span><span class="p">));</span>
			<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Set donor extent to orig extent */</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">mext_leaf_block</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">orig_inode</span><span class="p">,</span>
					   <span class="n">orig_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_dext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_off</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* Set orig extent to donor extent */</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">mext_leaf_block</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">donor_inode</span><span class="p">,</span>
					   <span class="n">donor_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_oext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">donor_off</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">dext_alen</span> <span class="o">=</span> <span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_dext</span><span class="p">);</span>
		<span class="n">replaced_count</span> <span class="o">+=</span> <span class="n">dext_alen</span><span class="p">;</span>
		<span class="n">donor_off</span> <span class="o">+=</span> <span class="n">dext_alen</span><span class="p">;</span>
		<span class="n">orig_off</span> <span class="o">+=</span> <span class="n">dext_alen</span><span class="p">;</span>

		<span class="cm">/* Already moved the expected blocks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">replaced_count</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">orig_path</span><span class="p">)</span>
			<span class="n">ext4_ext_drop_refs</span><span class="p">(</span><span class="n">orig_path</span><span class="p">);</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">get_ext_path</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">orig_off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">ext_depth</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">);</span>
		<span class="n">oext</span> <span class="o">=</span> <span class="n">orig_path</span><span class="p">[</span><span class="n">depth</span><span class="p">].</span><span class="n">p_ext</span><span class="p">;</span>
		<span class="n">tmp_oext</span> <span class="o">=</span> <span class="o">*</span><span class="n">oext</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">donor_path</span><span class="p">)</span>
			<span class="n">ext4_ext_drop_refs</span><span class="p">(</span><span class="n">donor_path</span><span class="p">);</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">get_ext_path</span><span class="p">(</span><span class="n">donor_inode</span><span class="p">,</span> <span class="n">donor_off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">donor_path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">ext_depth</span><span class="p">(</span><span class="n">donor_inode</span><span class="p">);</span>
		<span class="n">dext</span> <span class="o">=</span> <span class="n">donor_path</span><span class="p">[</span><span class="n">depth</span><span class="p">].</span><span class="n">p_ext</span><span class="p">;</span>
		<span class="n">tmp_dext</span> <span class="o">=</span> <span class="o">*</span><span class="n">dext</span><span class="p">;</span>

		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">mext_calc_swap_extents</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_dext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_oext</span><span class="p">,</span> <span class="n">orig_off</span><span class="p">,</span>
					   <span class="n">donor_off</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">replaced_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">orig_path</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_ext_drop_refs</span><span class="p">(</span><span class="n">orig_path</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">orig_path</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">donor_path</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_ext_drop_refs</span><span class="p">(</span><span class="n">donor_path</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">donor_path</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ext4_ext_invalidate_cache</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">);</span>
	<span class="n">ext4_ext_invalidate_cache</span><span class="p">(</span><span class="n">donor_inode</span><span class="p">);</span>

	<span class="n">double_up_write_data_sem</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">donor_inode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">replaced_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * move_extent_per_page - Move extent data per page</span>
<span class="cm"> *</span>
<span class="cm"> * @o_filp:			file structure of original file</span>
<span class="cm"> * @donor_inode:		donor inode</span>
<span class="cm"> * @orig_page_offset:		page index on original file</span>
<span class="cm"> * @data_offset_in_page:	block index where data swapping starts</span>
<span class="cm"> * @block_len_in_page:		the number of blocks to be swapped</span>
<span class="cm"> * @uninit:			orig extent is uninitialized or not</span>
<span class="cm"> * @err:			pointer to save return value</span>
<span class="cm"> *</span>
<span class="cm"> * Save the data in original inode blocks and replace original inode extents</span>
<span class="cm"> * with donor inode extents by calling mext_replace_branches().</span>
<span class="cm"> * Finally, write out the saved data in new original inode blocks. Return</span>
<span class="cm"> * replaced block count.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">move_extent_per_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">o_filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">donor_inode</span><span class="p">,</span>
		  <span class="n">pgoff_t</span> <span class="n">orig_page_offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_offset_in_page</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">block_len_in_page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">uninit</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">orig_inode</span> <span class="o">=</span> <span class="n">o_filp</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">address_space_operations</span> <span class="o">*</span><span class="n">a_ops</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="p">;</span>
	<span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">ext4_lblk_t</span> <span class="n">orig_blk_offset</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">long</span> <span class="n">offs</span> <span class="o">=</span> <span class="n">orig_page_offset</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">blocksize</span> <span class="o">=</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">w_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp_data_size</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">replaced_size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fsdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">jblocks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">replaced_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blocks_per_page</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * It needs twice the amount of ordinary journal buffers because</span>
<span class="cm">	 * inode and donor_inode may change each different metadata blocks.</span>
<span class="cm">	 */</span>
	<span class="n">jblocks</span> <span class="o">=</span> <span class="n">ext4_writepage_trans_blocks</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">ext4_journal_start</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">jblocks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">segment_eq</span><span class="p">(</span><span class="n">get_fs</span><span class="p">(),</span> <span class="n">KERNEL_DS</span><span class="p">))</span>
		<span class="n">w_flags</span> <span class="o">|=</span> <span class="n">AOP_FLAG_UNINTERRUPTIBLE</span><span class="p">;</span>

	<span class="n">orig_blk_offset</span> <span class="o">=</span> <span class="n">orig_page_offset</span> <span class="o">*</span> <span class="n">blocks_per_page</span> <span class="o">+</span>
		<span class="n">data_offset_in_page</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If orig extent is uninitialized one,</span>
<span class="cm">	 * it&#39;s not necessary force the page into memory</span>
<span class="cm">	 * and then force it to be written out again.</span>
<span class="cm">	 * Just swap data blocks between orig and donor.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uninit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">replaced_count</span> <span class="o">=</span> <span class="n">mext_replace_branches</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">orig_inode</span><span class="p">,</span>
						<span class="n">donor_inode</span><span class="p">,</span> <span class="n">orig_blk_offset</span><span class="p">,</span>
						<span class="n">block_len_in_page</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">orig_blk_offset</span> <span class="o">&lt;&lt;</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">;</span>

	<span class="cm">/* Calculate data_size */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">orig_blk_offset</span> <span class="o">+</span> <span class="n">block_len_in_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span>
	    <span class="p">((</span><span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Replace the last block */</span>
		<span class="n">tmp_data_size</span> <span class="o">=</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If data_size equal zero, it shows data_size is multiples of</span>
<span class="cm">		 * blocksize. So we set appropriate value.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_data_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tmp_data_size</span> <span class="o">=</span> <span class="n">blocksize</span><span class="p">;</span>

		<span class="n">data_size</span> <span class="o">=</span> <span class="n">tmp_data_size</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">block_len_in_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">data_size</span> <span class="o">=</span> <span class="n">block_len_in_page</span> <span class="o">&lt;&lt;</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">;</span>

	<span class="n">replaced_size</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>

	<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">write_begin</span><span class="p">(</span><span class="n">o_filp</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">w_flags</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">page</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">readpage</span><span class="p">(</span><span class="n">o_filp</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="n">lock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * try_to_release_page() doesn&#39;t call releasepage in writeback mode.</span>
<span class="cm">	 * We should care about the order of writing to the same file</span>
<span class="cm">	 * by multiple move extent processes.</span>
<span class="cm">	 * It needs to call wait_on_page_writeback() to wait for the</span>
<span class="cm">	 * writeback of the page.</span>
<span class="cm">	 */</span>
	<span class="n">wait_on_page_writeback</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="cm">/* Release old bh and drop refs */</span>
	<span class="n">try_to_release_page</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">replaced_count</span> <span class="o">=</span> <span class="n">mext_replace_branches</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">orig_inode</span><span class="p">,</span> <span class="n">donor_inode</span><span class="p">,</span>
					<span class="n">orig_blk_offset</span><span class="p">,</span> <span class="n">block_len_in_page</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">err2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">replaced_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">block_len_in_page</span> <span class="o">=</span> <span class="n">replaced_count</span><span class="p">;</span>
			<span class="n">replaced_size</span> <span class="o">=</span>
				<span class="n">block_len_in_page</span> <span class="o">&lt;&lt;</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page_has_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">create_empty_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_offset_in_page</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_this_page</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">block_len_in_page</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">ext4_get_block</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span>
				<span class="p">(</span><span class="n">sector_t</span><span class="p">)(</span><span class="n">orig_blk_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_this_page</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">bh</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_this_page</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">write_end</span><span class="p">(</span><span class="n">o_filp</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">replaced_size</span><span class="p">,</span>
			       <span class="n">page</span><span class="p">,</span> <span class="n">fsdata</span><span class="p">);</span>
	<span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PageLocked</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">ext4_journal_stop</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out2:</span>
	<span class="n">ext4_journal_stop</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err2</span><span class="p">)</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">err2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">replaced_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mext_check_arguments - Check whether move extent can be done</span>
<span class="cm"> *</span>
<span class="cm"> * @orig_inode:		original inode</span>
<span class="cm"> * @donor_inode:	donor inode</span>
<span class="cm"> * @orig_start:		logical start offset in block for orig</span>
<span class="cm"> * @donor_start:	logical start offset in block for donor</span>
<span class="cm"> * @len:		the number of blocks to be moved</span>
<span class="cm"> *</span>
<span class="cm"> * Check the arguments of ext4_move_extents() whether the files can be</span>
<span class="cm"> * exchanged with each other.</span>
<span class="cm"> * Return 0 on success, or a negative error value on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mext_check_arguments</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">orig_inode</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">donor_inode</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">orig_start</span><span class="p">,</span>
		     <span class="n">__u64</span> <span class="n">donor_start</span><span class="p">,</span> <span class="n">__u64</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext4_lblk_t</span> <span class="n">orig_blocks</span><span class="p">,</span> <span class="n">donor_blocks</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blkbits</span> <span class="o">=</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">blkbits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">S_ISUID</span><span class="o">|</span><span class="n">S_ISGID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: suid or sgid is set&quot;</span>
			   <span class="s">&quot; to donor file [ino:orig %lu, donor %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IMMUTABLE</span><span class="p">(</span><span class="n">donor_inode</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_APPEND</span><span class="p">(</span><span class="n">donor_inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* Ext4 move extent does not support swapfile */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_SWAPFILE</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_SWAPFILE</span><span class="p">(</span><span class="n">donor_inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: The argument files should &quot;</span>
			<span class="s">&quot;not be swapfile [ino:orig %lu, donor %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Files should be in the same ext4 FS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_sb</span> <span class="o">!=</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: The argument files &quot;</span>
			<span class="s">&quot;should be in same FS [ino:orig %lu, donor %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ext4 move extent supports only extent based file */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ext4_test_inode_flag</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">EXT4_INODE_EXTENTS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: orig file is not extents &quot;</span>
			<span class="s">&quot;based file [ino:orig %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ext4_test_inode_flag</span><span class="p">(</span><span class="n">donor_inode</span><span class="p">,</span> <span class="n">EXT4_INODE_EXTENTS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: donor file is not extents &quot;</span>
			<span class="s">&quot;based file [ino:donor %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: File size is 0 byte</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start offset should be same */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">orig_start</span> <span class="o">!=</span> <span class="n">donor_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: orig and donor&#39;s start &quot;</span>
			<span class="s">&quot;offset are not same [ino:orig %lu, donor %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">orig_start</span> <span class="o">&gt;=</span> <span class="n">EXT_MAX_BLOCKS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">donor_start</span> <span class="o">&gt;=</span> <span class="n">EXT_MAX_BLOCKS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">EXT_MAX_BLOCKS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">orig_start</span> <span class="o">+</span> <span class="o">*</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">EXT_MAX_BLOCKS</span><span class="p">))</span>  <span class="p">{</span>
		<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: Can&#39;t handle over [%u] blocks &quot;</span>
			<span class="s">&quot;[ino:orig %lu, donor %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">EXT_MAX_BLOCKS</span><span class="p">,</span>
			<span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&gt;</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">donor_blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">+</span> <span class="n">blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">blkbits</span><span class="p">;</span>
		<span class="cm">/* TODO: eliminate this artificial restriction */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orig_start</span> <span class="o">&gt;=</span> <span class="n">donor_blocks</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: orig start offset &quot;</span>
			<span class="s">&quot;[%llu] should be less than donor file blocks &quot;</span>
			<span class="s">&quot;[%u] [ino:orig %lu, donor %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">orig_start</span><span class="p">,</span> <span class="n">donor_blocks</span><span class="p">,</span>
			<span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* TODO: eliminate this artificial restriction */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orig_start</span> <span class="o">+</span> <span class="o">*</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">donor_blocks</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: End offset [%llu] should &quot;</span>
				<span class="s">&quot;be less than donor file blocks [%u].&quot;</span>
				<span class="s">&quot;So adjust length from %llu to %llu &quot;</span>
				<span class="s">&quot;[ino:orig %lu, donor %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">orig_start</span> <span class="o">+</span> <span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="n">donor_blocks</span><span class="p">,</span>
				<span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="n">donor_blocks</span> <span class="o">-</span> <span class="n">orig_start</span><span class="p">,</span>
				<span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
			<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">donor_blocks</span> <span class="o">-</span> <span class="n">orig_start</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">orig_blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">+</span> <span class="n">blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">blkbits</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orig_start</span> <span class="o">&gt;=</span> <span class="n">orig_blocks</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: start offset [%llu] &quot;</span>
				<span class="s">&quot;should be less than original file blocks &quot;</span>
				<span class="s">&quot;[%u] [ino:orig %lu, donor %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">orig_start</span><span class="p">,</span> <span class="n">orig_blocks</span><span class="p">,</span>
				<span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">orig_start</span> <span class="o">+</span> <span class="o">*</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">orig_blocks</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: Adjust length &quot;</span>
				<span class="s">&quot;from %llu to %llu. Because it should be &quot;</span>
				<span class="s">&quot;less than original file blocks &quot;</span>
				<span class="s">&quot;[ino:orig %lu, donor %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="n">orig_blocks</span> <span class="o">-</span> <span class="n">orig_start</span><span class="p">,</span>
				<span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
			<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">orig_blocks</span> <span class="o">-</span> <span class="n">orig_start</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: len should not be 0 &quot;</span>
			<span class="s">&quot;[ino:orig %lu, donor %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span>
			<span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mext_inode_double_lock - Lock i_mutex on both @inode1 and @inode2</span>
<span class="cm"> *</span>
<span class="cm"> * @inode1:	the inode structure</span>
<span class="cm"> * @inode2:	the inode structure</span>
<span class="cm"> *</span>
<span class="cm"> * Lock two inodes&#39; i_mutex by i_ino order.</span>
<span class="cm"> * If inode1 or inode2 is NULL, return -EIO. Otherwise, return 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mext_inode_double_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">inode1</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">inode2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mext_check_null_inode</span><span class="p">(</span><span class="n">inode1</span><span class="p">,</span> <span class="n">inode2</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode1</span> <span class="o">==</span> <span class="n">inode2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode1</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode1</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">&lt;</span> <span class="n">inode2</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode1</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">,</span> <span class="n">I_MUTEX_PARENT</span><span class="p">);</span>
		<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode2</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">,</span> <span class="n">I_MUTEX_CHILD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode2</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">,</span> <span class="n">I_MUTEX_PARENT</span><span class="p">);</span>
		<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode1</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">,</span> <span class="n">I_MUTEX_CHILD</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mext_inode_double_unlock - Release i_mutex on both @inode1 and @inode2</span>
<span class="cm"> *</span>
<span class="cm"> * @inode1:     the inode that is released first</span>
<span class="cm"> * @inode2:     the inode that is released second</span>
<span class="cm"> *</span>
<span class="cm"> * If inode1 or inode2 is NULL, return -EIO. Otherwise, return 0.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mext_inode_double_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">inode1</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">inode2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mext_check_null_inode</span><span class="p">(</span><span class="n">inode1</span><span class="p">,</span> <span class="n">inode2</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode1</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode1</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode2</span> <span class="o">&amp;&amp;</span> <span class="n">inode2</span> <span class="o">!=</span> <span class="n">inode1</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode2</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ext4_move_extents - Exchange the specified range of a file</span>
<span class="cm"> *</span>
<span class="cm"> * @o_filp:		file structure of the original file</span>
<span class="cm"> * @d_filp:		file structure of the donor file</span>
<span class="cm"> * @orig_start:		start offset in block for orig</span>
<span class="cm"> * @donor_start:	start offset in block for donor</span>
<span class="cm"> * @len:		the number of blocks to be moved</span>
<span class="cm"> * @moved_len:		moved block length</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns 0 and moved block length is set in moved_len</span>
<span class="cm"> * if succeed, otherwise returns error value.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: ext4_move_extents() proceeds the following order.</span>
<span class="cm"> * 1:ext4_move_extents() calculates the last block number of moving extent</span>
<span class="cm"> *   function by the start block number (orig_start) and the number of blocks</span>
<span class="cm"> *   to be moved (len) specified as arguments.</span>
<span class="cm"> *   If the {orig, donor}_start points a hole, the extent&#39;s start offset</span>
<span class="cm"> *   pointed by ext_cur (current extent), holecheck_path, orig_path are set</span>
<span class="cm"> *   after hole behind.</span>
<span class="cm"> * 2:Continue step 3 to step 5, until the holecheck_path points to last_extent</span>
<span class="cm"> *   or the ext_cur exceeds the block_end which is last logical block number.</span>
<span class="cm"> * 3:To get the length of continues area, call mext_next_extent()</span>
<span class="cm"> *   specified with the ext_cur (initial value is holecheck_path) re-cursive,</span>
<span class="cm"> *   until find un-continuous extent, the start logical block number exceeds</span>
<span class="cm"> *   the block_end or the extent points to the last extent.</span>
<span class="cm"> * 4:Exchange the original inode data with donor inode data</span>
<span class="cm"> *   from orig_page_offset to seq_end_page.</span>
<span class="cm"> *   The start indexes of data are specified as arguments.</span>
<span class="cm"> *   That of the original inode is orig_page_offset,</span>
<span class="cm"> *   and the donor inode is also orig_page_offset</span>
<span class="cm"> *   (To easily handle blocksize != pagesize case, the offset for the</span>
<span class="cm"> *   donor inode is block unit).</span>
<span class="cm"> * 5:Update holecheck_path and orig_path to points a next proceeding extent,</span>
<span class="cm"> *   then returns to step 2.</span>
<span class="cm"> * 6:Release holecheck_path, orig_path and set the len to moved_len</span>
<span class="cm"> *   which shows the number of moved blocks.</span>
<span class="cm"> *   The moved_len is useful for the command to calculate the file offset</span>
<span class="cm"> *   for starting next move extent ioctl.</span>
<span class="cm"> * 7:Return 0 on success, or a negative error value on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ext4_move_extents</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">o_filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">d_filp</span><span class="p">,</span>
		 <span class="n">__u64</span> <span class="n">orig_start</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">donor_start</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">len</span><span class="p">,</span>
		 <span class="n">__u64</span> <span class="o">*</span><span class="n">moved_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">orig_inode</span> <span class="o">=</span> <span class="n">o_filp</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">donor_inode</span> <span class="o">=</span> <span class="n">d_filp</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_ext_path</span> <span class="o">*</span><span class="n">orig_path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">holecheck_path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext4_extent</span> <span class="o">*</span><span class="n">ext_prev</span><span class="p">,</span> <span class="o">*</span><span class="n">ext_cur</span><span class="p">,</span> <span class="o">*</span><span class="n">ext_dummy</span><span class="p">;</span>
	<span class="n">ext4_lblk_t</span> <span class="n">block_start</span> <span class="o">=</span> <span class="n">orig_start</span><span class="p">;</span>
	<span class="n">ext4_lblk_t</span> <span class="n">block_end</span><span class="p">,</span> <span class="n">seq_start</span><span class="p">,</span> <span class="n">add_blocks</span><span class="p">,</span> <span class="n">file_end</span><span class="p">,</span> <span class="n">seq_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ext4_lblk_t</span> <span class="n">rest_blocks</span><span class="p">;</span>
	<span class="n">pgoff_t</span> <span class="n">orig_page_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">seq_end_page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret1</span><span class="p">,</span> <span class="n">ret2</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">last_extent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blocks_per_page</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_offset_in_page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">block_len_in_page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uninit</span><span class="p">;</span>

	<span class="cm">/* orig and donor should be different file */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">==</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: The argument files should not &quot;</span>
			<span class="s">&quot;be same file [ino:orig %lu, donor %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Regular file check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: The argument files should be &quot;</span>
			<span class="s">&quot;regular file [ino:orig %lu, donor %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">donor_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Protect orig and donor inodes against a truncate */</span>
	<span class="n">ret1</span> <span class="o">=</span> <span class="n">mext_inode_double_lock</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">donor_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret1</span><span class="p">;</span>

	<span class="cm">/* Protect extent tree against block allocations via delalloc */</span>
	<span class="n">double_down_write_data_sem</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">donor_inode</span><span class="p">);</span>
	<span class="cm">/* Check the filesystem environment whether move_extent can be done */</span>
	<span class="n">ret1</span> <span class="o">=</span> <span class="n">mext_check_arguments</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">donor_inode</span><span class="p">,</span> <span class="n">orig_start</span><span class="p">,</span>
				    <span class="n">donor_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">file_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">i_size_read</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">;</span>
	<span class="n">block_end</span> <span class="o">=</span> <span class="n">block_start</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file_end</span> <span class="o">&lt;</span> <span class="n">block_end</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">block_end</span> <span class="o">-</span> <span class="n">file_end</span><span class="p">;</span>

	<span class="n">ret1</span> <span class="o">=</span> <span class="n">get_ext_path</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">block_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Get path structure to check the hole */</span>
	<span class="n">ret1</span> <span class="o">=</span> <span class="n">get_ext_path</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">block_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">holecheck_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">depth</span> <span class="o">=</span> <span class="n">ext_depth</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">);</span>
	<span class="n">ext_cur</span> <span class="o">=</span> <span class="n">holecheck_path</span><span class="p">[</span><span class="n">depth</span><span class="p">].</span><span class="n">p_ext</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get proper starting location of block replacement if block_start was</span>
<span class="cm">	 * within the hole.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ext_cur</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="n">ext_cur</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">block_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The hole exists between extents or the tail of</span>
<span class="cm">		 * original file.</span>
<span class="cm">		 */</span>
		<span class="n">last_extent</span> <span class="o">=</span> <span class="n">mext_next_extent</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span>
					<span class="n">holecheck_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext_cur</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_extent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret1</span> <span class="o">=</span> <span class="n">last_extent</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">last_extent</span> <span class="o">=</span> <span class="n">mext_next_extent</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">orig_path</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">ext_dummy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_extent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret1</span> <span class="o">=</span> <span class="n">last_extent</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">seq_start</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ext_cur</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ext_cur</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">block_start</span><span class="p">)</span>
		<span class="cm">/* The hole exists at the beginning of original file. */</span>
		<span class="n">seq_start</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ext_cur</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seq_start</span> <span class="o">=</span> <span class="n">block_start</span><span class="p">;</span>

	<span class="cm">/* No blocks within the specified range. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ext_cur</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">block_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_debug</span><span class="p">(</span><span class="s">&quot;ext4 move extent: The specified range of file &quot;</span>
							<span class="s">&quot;may be the hole</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret1</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Adjust start blocks */</span>
	<span class="n">add_blocks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ext_cur</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">+</span>
			 <span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="n">ext_cur</span><span class="p">),</span> <span class="n">block_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
		     <span class="n">max</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ext_cur</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">),</span> <span class="n">block_start</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">last_extent</span> <span class="o">&amp;&amp;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ext_cur</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">block_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_blocks</span> <span class="o">+=</span> <span class="n">add_blocks</span><span class="p">;</span>

		<span class="cm">/* Adjust tail blocks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seq_start</span> <span class="o">+</span> <span class="n">seq_blocks</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">block_end</span><span class="p">)</span>
			<span class="n">seq_blocks</span> <span class="o">=</span> <span class="n">block_end</span> <span class="o">-</span> <span class="n">seq_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ext_prev</span> <span class="o">=</span> <span class="n">ext_cur</span><span class="p">;</span>
		<span class="n">last_extent</span> <span class="o">=</span> <span class="n">mext_next_extent</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">holecheck_path</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ext_cur</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_extent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret1</span> <span class="o">=</span> <span class="n">last_extent</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">add_blocks</span> <span class="o">=</span> <span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="n">ext_cur</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Extend the length of contiguous block (seq_blocks)</span>
<span class="cm">		 * if extents are contiguous.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext4_can_extents_be_merged</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span>
					       <span class="n">ext_prev</span><span class="p">,</span> <span class="n">ext_cur</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">block_end</span> <span class="o">&gt;=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ext_cur</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">last_extent</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Is original extent is uninitialized */</span>
		<span class="n">uninit</span> <span class="o">=</span> <span class="n">ext4_ext_is_uninitialized</span><span class="p">(</span><span class="n">ext_prev</span><span class="p">);</span>

		<span class="n">data_offset_in_page</span> <span class="o">=</span> <span class="n">seq_start</span> <span class="o">%</span> <span class="n">blocks_per_page</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Calculate data blocks count that should be swapped</span>
<span class="cm">		 * at the first page.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_offset_in_page</span> <span class="o">+</span> <span class="n">seq_blocks</span> <span class="o">&gt;</span> <span class="n">blocks_per_page</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Swapped blocks are across pages */</span>
			<span class="n">block_len_in_page</span> <span class="o">=</span>
					<span class="n">blocks_per_page</span> <span class="o">-</span> <span class="n">data_offset_in_page</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Swapped blocks are in a page */</span>
			<span class="n">block_len_in_page</span> <span class="o">=</span> <span class="n">seq_blocks</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">orig_page_offset</span> <span class="o">=</span> <span class="n">seq_start</span> <span class="o">&gt;&gt;</span>
				<span class="p">(</span><span class="n">PAGE_CACHE_SHIFT</span> <span class="o">-</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">);</span>
		<span class="n">seq_end_page</span> <span class="o">=</span> <span class="p">(</span><span class="n">seq_start</span> <span class="o">+</span> <span class="n">seq_blocks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="p">(</span><span class="n">PAGE_CACHE_SHIFT</span> <span class="o">-</span> <span class="n">orig_inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">);</span>
		<span class="n">seq_start</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ext_cur</span><span class="o">-&gt;</span><span class="n">ee_block</span><span class="p">);</span>
		<span class="n">rest_blocks</span> <span class="o">=</span> <span class="n">seq_blocks</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Up semaphore to avoid following problems:</span>
<span class="cm">		 * a. transaction deadlock among ext4_journal_start,</span>
<span class="cm">		 *    -&gt;write_begin via pagefault, and jbd2_journal_commit</span>
<span class="cm">		 * b. racing with -&gt;readpage, -&gt;write_begin, and ext4_get_block</span>
<span class="cm">		 *    in move_extent_per_page</span>
<span class="cm">		 */</span>
		<span class="n">double_up_write_data_sem</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">donor_inode</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">orig_page_offset</span> <span class="o">&lt;=</span> <span class="n">seq_end_page</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Swap original branches with new branches */</span>
			<span class="n">block_len_in_page</span> <span class="o">=</span> <span class="n">move_extent_per_page</span><span class="p">(</span>
						<span class="n">o_filp</span><span class="p">,</span> <span class="n">donor_inode</span><span class="p">,</span>
						<span class="n">orig_page_offset</span><span class="p">,</span>
						<span class="n">data_offset_in_page</span><span class="p">,</span>
						<span class="n">block_len_in_page</span><span class="p">,</span> <span class="n">uninit</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ret1</span><span class="p">);</span>

			<span class="cm">/* Count how many blocks we have exchanged */</span>
			<span class="o">*</span><span class="n">moved_len</span> <span class="o">+=</span> <span class="n">block_len_in_page</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">moved_len</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">EXT4_ERROR_INODE</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span>
					<span class="s">&quot;We replaced blocks too much! &quot;</span>
					<span class="s">&quot;sum of replaced: %llu requested: %llu&quot;</span><span class="p">,</span>
					<span class="o">*</span><span class="n">moved_len</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">ret1</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">orig_page_offset</span><span class="o">++</span><span class="p">;</span>
			<span class="n">data_offset_in_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rest_blocks</span> <span class="o">-=</span> <span class="n">block_len_in_page</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rest_blocks</span> <span class="o">&gt;</span> <span class="n">blocks_per_page</span><span class="p">)</span>
				<span class="n">block_len_in_page</span> <span class="o">=</span> <span class="n">blocks_per_page</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">block_len_in_page</span> <span class="o">=</span> <span class="n">rest_blocks</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">double_down_write_data_sem</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">donor_inode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Decrease buffer counter */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">holecheck_path</span><span class="p">)</span>
			<span class="n">ext4_ext_drop_refs</span><span class="p">(</span><span class="n">holecheck_path</span><span class="p">);</span>
		<span class="n">ret1</span> <span class="o">=</span> <span class="n">get_ext_path</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">seq_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">holecheck_path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">holecheck_path</span><span class="o">-&gt;</span><span class="n">p_depth</span><span class="p">;</span>

		<span class="cm">/* Decrease buffer counter */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orig_path</span><span class="p">)</span>
			<span class="n">ext4_ext_drop_refs</span><span class="p">(</span><span class="n">orig_path</span><span class="p">);</span>
		<span class="n">ret1</span> <span class="o">=</span> <span class="n">get_ext_path</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">seq_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ext_cur</span> <span class="o">=</span> <span class="n">holecheck_path</span><span class="p">[</span><span class="n">depth</span><span class="p">].</span><span class="n">p_ext</span><span class="p">;</span>
		<span class="n">add_blocks</span> <span class="o">=</span> <span class="n">ext4_ext_get_actual_len</span><span class="p">(</span><span class="n">ext_cur</span><span class="p">);</span>
		<span class="n">seq_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">moved_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_discard_preallocations</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">);</span>
		<span class="n">ext4_discard_preallocations</span><span class="p">(</span><span class="n">donor_inode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orig_path</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_ext_drop_refs</span><span class="p">(</span><span class="n">orig_path</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">orig_path</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">holecheck_path</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext4_ext_drop_refs</span><span class="p">(</span><span class="n">holecheck_path</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">holecheck_path</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">double_up_write_data_sem</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">donor_inode</span><span class="p">);</span>
	<span class="n">ret2</span> <span class="o">=</span> <span class="n">mext_inode_double_unlock</span><span class="p">(</span><span class="n">orig_inode</span><span class="p">,</span> <span class="n">donor_inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
