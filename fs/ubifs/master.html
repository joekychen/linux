<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › ubifs › master.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>master.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is part of UBIFS.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006-2008 Nokia Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 51</span>
<span class="cm"> * Franklin St, Fifth Floor, Boston, MA 02110-1301 USA</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Artem Bityutskiy (Битюцкий Артём)</span>
<span class="cm"> *          Adrian Hunter</span>
<span class="cm"> */</span>

<span class="cm">/* This file implements reading and writing the master node */</span>

<span class="cp">#include &quot;ubifs.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * scan_for_master - search the valid master node.</span>
<span class="cm"> * @c: UBIFS file-system description object</span>
<span class="cm"> *</span>
<span class="cm"> * This function scans the master node LEBs and search for the latest master</span>
<span class="cm"> * node. Returns zero in case of success, %-EUCLEAN if there master area is</span>
<span class="cm"> * corrupted and requires recovery, and a negative error code in case of</span>
<span class="cm"> * failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scan_for_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">ubifs_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ubifs_scan_leb</span> <span class="o">*</span><span class="n">sleb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ubifs_scan_node</span> <span class="o">*</span><span class="n">snod</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lnum</span><span class="p">,</span> <span class="n">offs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nodes_cnt</span><span class="p">;</span>

	<span class="n">lnum</span> <span class="o">=</span> <span class="n">UBIFS_MST_LNUM</span><span class="p">;</span>

	<span class="n">sleb</span> <span class="o">=</span> <span class="n">ubifs_scan</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">lnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sleb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">sleb</span><span class="p">);</span>
	<span class="n">nodes_cnt</span> <span class="o">=</span> <span class="n">sleb</span><span class="o">-&gt;</span><span class="n">nodes_cnt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nodes_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snod</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">sleb</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ubifs_scan_node</span><span class="p">,</span>
				  <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snod</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">UBIFS_MST_NODE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_dump</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="p">,</span> <span class="n">snod</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">snod</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">offs</span> <span class="o">=</span> <span class="n">snod</span><span class="o">-&gt;</span><span class="n">offs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ubifs_scan_destroy</span><span class="p">(</span><span class="n">sleb</span><span class="p">);</span>

	<span class="n">lnum</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sleb</span> <span class="o">=</span> <span class="n">ubifs_scan</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">lnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sleb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">sleb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sleb</span><span class="o">-&gt;</span><span class="n">nodes_cnt</span> <span class="o">!=</span> <span class="n">nodes_cnt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sleb</span><span class="o">-&gt;</span><span class="n">nodes_cnt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">snod</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">sleb</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ubifs_scan_node</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snod</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">UBIFS_MST_NODE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_dump</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snod</span><span class="o">-&gt;</span><span class="n">offs</span> <span class="o">!=</span> <span class="n">offs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span> <span class="o">+</span> <span class="n">UBIFS_CH_SZ</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">snod</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">+</span> <span class="n">UBIFS_CH_SZ</span><span class="p">,</span>
		   <span class="n">UBIFS_MST_NODE_SZ</span> <span class="o">-</span> <span class="n">UBIFS_CH_SZ</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_offs</span> <span class="o">=</span> <span class="n">offs</span><span class="p">;</span>
	<span class="n">ubifs_scan_destroy</span><span class="p">(</span><span class="n">sleb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">ubifs_scan_destroy</span><span class="p">(</span><span class="n">sleb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EUCLEAN</span><span class="p">;</span>

<span class="nl">out_dump:</span>
	<span class="n">ubifs_err</span><span class="p">(</span><span class="s">&quot;unexpected node type %d master LEB %d:%d&quot;</span><span class="p">,</span>
		  <span class="n">snod</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">lnum</span><span class="p">,</span> <span class="n">snod</span><span class="o">-&gt;</span><span class="n">offs</span><span class="p">);</span>
	<span class="n">ubifs_scan_destroy</span><span class="p">(</span><span class="n">sleb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * validate_master - validate master node.</span>
<span class="cm"> * @c: UBIFS file-system description object</span>
<span class="cm"> *</span>
<span class="cm"> * This function validates data which was read from master node. Returns zero</span>
<span class="cm"> * if the data is all right and %-EINVAL if not.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_master</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ubifs_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="kt">long</span> <span class="n">main_sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max_sqnum</span> <span class="o">&gt;=</span> <span class="n">SQNUM_WATERMARK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cmt_no</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">max_sqnum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_inum</span> <span class="o">&gt;=</span> <span class="n">INUM_WATERMARK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lhead_lnum</span> <span class="o">&lt;</span> <span class="n">UBIFS_LOG_LNUM</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lhead_lnum</span> <span class="o">&gt;=</span> <span class="n">UBIFS_LOG_LNUM</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">log_lebs</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lhead_offs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lhead_offs</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_size</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lhead_offs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">min_io_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">zroot</span><span class="p">.</span><span class="n">lnum</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_cnt</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">zroot</span><span class="p">.</span><span class="n">lnum</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">main_first</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">zroot</span><span class="p">.</span><span class="n">offs</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_size</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">zroot</span><span class="p">.</span><span class="n">offs</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">zroot</span><span class="p">.</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="n">UBIFS_IDX_NODE</span><span class="p">].</span><span class="n">min_len</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">zroot</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="n">UBIFS_IDX_NODE</span><span class="p">].</span><span class="n">max_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">gc_lnum</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_cnt</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">gc_lnum</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">main_first</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">ihead_lnum</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_cnt</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">ihead_lnum</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">main_first</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">ihead_offs</span> <span class="o">%</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">min_io_size</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">ihead_offs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">ihead_offs</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_size</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">ihead_offs</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">main_sz</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">main_lebs</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bi</span><span class="p">.</span><span class="n">old_idx_sz</span> <span class="o">&amp;</span> <span class="mi">7</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bi</span><span class="p">.</span><span class="n">old_idx_sz</span> <span class="o">&gt;=</span> <span class="n">main_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lpt_lnum</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpt_first</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpt_lnum</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpt_last</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpt_offs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpt_offs</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nnode_sz</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">nhead_lnum</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpt_first</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nhead_lnum</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpt_last</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">nhead_offs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nhead_offs</span> <span class="o">%</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">min_io_size</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">nhead_offs</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">ltab_lnum</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpt_first</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">ltab_lnum</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpt_last</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">ltab_offs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">ltab_offs</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">ltab_sz</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">big_lpt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lsave_lnum</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpt_first</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lsave_lnum</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpt_last</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lsave_offs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lsave_offs</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lsave_sz</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lscan_lnum</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">main_first</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lscan_lnum</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">empty_lebs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">empty_lebs</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">main_lebs</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">idx_lebs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">idx_lebs</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">main_lebs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_free</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_free</span> <span class="o">&gt;</span> <span class="n">main_sz</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_free</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dirty</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dirty</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_used</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_used</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_free</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dirty</span> <span class="o">+</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_used</span> <span class="o">&gt;</span> <span class="n">main_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dead</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dark</span> <span class="o">+</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_used</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bi</span><span class="p">.</span><span class="n">old_idx_sz</span> <span class="o">&gt;</span> <span class="n">main_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dead</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dead</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_free</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dirty</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dead</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dark</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dark</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_free</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dirty</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dark</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">ubifs_err</span><span class="p">(</span><span class="s">&quot;bad master node at offset %d error %d&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_offs</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">ubifs_dump_node</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ubifs_read_master - read master node.</span>
<span class="cm"> * @c: UBIFS file-system description object</span>
<span class="cm"> *</span>
<span class="cm"> * This function finds and reads the master node during file-system mount. If</span>
<span class="cm"> * the flash is empty, it creates default master node as well. Returns zero in</span>
<span class="cm"> * case of success and a negative error code in case of failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ubifs_read_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">ubifs_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">old_leb_cnt</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node_alsz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">scan_for_master</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EUCLEAN</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ubifs_recover_master_node</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * Note, we do not free &#39;c-&gt;mst_node&#39; here because the</span>
<span class="cm">			 * unmount routine will take care of this.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure that the recovery flag is clear */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">UBIFS_MST_RCVRY</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">max_sqnum</span>       <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">sqnum</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_inum</span>    <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">highest_inum</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmt_no</span>          <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">cmt_no</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">zroot</span><span class="p">.</span><span class="n">lnum</span>      <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">root_lnum</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">zroot</span><span class="p">.</span><span class="n">offs</span>      <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">root_offs</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">zroot</span><span class="p">.</span><span class="n">len</span>       <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">root_len</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lhead_lnum</span>      <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">log_lnum</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">gc_lnum</span>         <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">gc_lnum</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ihead_lnum</span>      <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">ihead_lnum</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ihead_offs</span>      <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">ihead_offs</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">bi</span><span class="p">.</span><span class="n">old_idx_sz</span>   <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">index_size</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lpt_lnum</span>        <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">lpt_lnum</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lpt_offs</span>        <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">lpt_offs</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">nhead_lnum</span>      <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">nhead_lnum</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">nhead_offs</span>      <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">nhead_offs</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ltab_lnum</span>       <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">ltab_lnum</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ltab_offs</span>       <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">ltab_offs</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lsave_lnum</span>      <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">lsave_lnum</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lsave_offs</span>      <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">lsave_offs</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lscan_lnum</span>      <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">lscan_lnum</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">empty_lebs</span>  <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">empty_lebs</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">idx_lebs</span>    <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">idx_lebs</span><span class="p">);</span>
	<span class="n">old_leb_cnt</span>        <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">leb_cnt</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_free</span>  <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">total_free</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dirty</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">total_dirty</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_used</span>  <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">total_used</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dead</span>  <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">total_dead</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dark</span>  <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">total_dark</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">calc_idx_sz</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bi</span><span class="p">.</span><span class="n">old_idx_sz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">UBIFS_MST_NO_ORPHS</span><span class="p">))</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">no_orphs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_leb_cnt</span> <span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The file system has been resized */</span>
		<span class="kt">int</span> <span class="n">growth</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_cnt</span> <span class="o">-</span> <span class="n">old_leb_cnt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_cnt</span> <span class="o">&lt;</span> <span class="n">old_leb_cnt</span> <span class="o">||</span>
		    <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_cnt</span> <span class="o">&lt;</span> <span class="n">UBIFS_MIN_LEB_CNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ubifs_err</span><span class="p">(</span><span class="s">&quot;bad leb_cnt on master node&quot;</span><span class="p">);</span>
			<span class="n">ubifs_dump_node</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dbg_mnt</span><span class="p">(</span><span class="s">&quot;Auto resizing (master) from %d LEBs to %d LEBs&quot;</span><span class="p">,</span>
			<span class="n">old_leb_cnt</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_cnt</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">empty_lebs</span> <span class="o">+=</span> <span class="n">growth</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_free</span> <span class="o">+=</span> <span class="n">growth</span> <span class="o">*</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_size</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dark</span> <span class="o">+=</span> <span class="n">growth</span> <span class="o">*</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dark_wm</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Reflect changes back onto the master node. N.B. the master</span>
<span class="cm">		 * node gets written immediately whenever mounting (or</span>
<span class="cm">		 * remounting) in read-write mode, so we do not need to write it</span>
<span class="cm">		 * here.</span>
<span class="cm">		 */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">leb_cnt</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_cnt</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">empty_lebs</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">empty_lebs</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">total_free</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_free</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">total_dark</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">.</span><span class="n">total_dark</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">validate_master</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dbg_old_index_check_init</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">zroot</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ubifs_write_master - write master node.</span>
<span class="cm"> * @c: UBIFS file-system description object</span>
<span class="cm"> *</span>
<span class="cm"> * This function writes the master node. The caller has to take the</span>
<span class="cm"> * @c-&gt;mst_mutex lock before calling this function. Returns zero in case of</span>
<span class="cm"> * success and a negative error code in case of failure. The master node is</span>
<span class="cm"> * written twice to enable recovery.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ubifs_write_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">ubifs_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">lnum</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">ubifs_assert</span><span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">ro_media</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">ro_mount</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">ro_error</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>

	<span class="n">lnum</span> <span class="o">=</span> <span class="n">UBIFS_MST_LNUM</span><span class="p">;</span>
	<span class="n">offs</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_offs</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node_alsz</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">UBIFS_MST_NODE_SZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offs</span> <span class="o">+</span> <span class="n">UBIFS_MST_NODE_SZ</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">leb_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ubifs_leb_unmap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">lnum</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">offs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_offs</span> <span class="o">=</span> <span class="n">offs</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="o">-&gt;</span><span class="n">highest_inum</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_inum</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ubifs_write_node</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">lnum</span><span class="p">,</span> <span class="n">offs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">lnum</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ubifs_leb_unmap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">lnum</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ubifs_write_node</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mst_node</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">lnum</span><span class="p">,</span> <span class="n">offs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
