<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › exofs › super.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>super.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2005, 2006</span>
<span class="cm"> * Avishay Traeger (avishay@gmail.com)</span>
<span class="cm"> * Copyright (C) 2008, 2009</span>
<span class="cm"> * Boaz Harrosh &lt;bharrosh@panasas.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyrights for code taken from ext2:</span>
<span class="cm"> *     Copyright (C) 1992, 1993, 1994, 1995</span>
<span class="cm"> *     Remy Card (card@masi.ibp.fr)</span>
<span class="cm"> *     Laboratoire MASI - Institut Blaise Pascal</span>
<span class="cm"> *     Universite Pierre et Marie Curie (Paris VI)</span>
<span class="cm"> *     from</span>
<span class="cm"> *     linux/fs/minix/inode.c</span>
<span class="cm"> *     Copyright (C) 1991, 1992  Linus Torvalds</span>
<span class="cm"> *</span>
<span class="cm"> * This file is part of exofs.</span>
<span class="cm"> *</span>
<span class="cm"> * exofs is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation.  Since it is based on ext2, and the only</span>
<span class="cm"> * valid version of GPL for the Linux kernel is version 2, the only valid</span>
<span class="cm"> * version of GPL for exofs is version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * exofs is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with exofs; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/parser.h&gt;</span>
<span class="cp">#include &lt;linux/vfs.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/exportfs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;exofs.h&quot;</span>

<span class="cp">#define EXOFS_DBGMSG2(M...) do {} while (0)</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * MOUNT OPTIONS</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * struct to hold what we get from mount options</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">exofs_mountopt</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">is_osdname</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">pid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * exofs-specific mount-time options.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span> <span class="n">Opt_name</span><span class="p">,</span> <span class="n">Opt_pid</span><span class="p">,</span> <span class="n">Opt_to</span><span class="p">,</span> <span class="n">Opt_err</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Our mount-time options.  These should ideally be 64-bit unsigned, but the</span>
<span class="cm"> * kernel&#39;s parsing functions do not currently support that.  32-bit should be</span>
<span class="cm"> * sufficient for most applications now.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">match_table_t</span> <span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">Opt_name</span><span class="p">,</span> <span class="s">&quot;osdname=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_pid</span><span class="p">,</span> <span class="s">&quot;pid=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_to</span><span class="p">,</span> <span class="s">&quot;to=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The main option parsing method.  Also makes sure that all of the mandatory</span>
<span class="cm"> * mount options were set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_options</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span> <span class="k">struct</span> <span class="n">exofs_mountopt</span> <span class="o">*</span><span class="n">opts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">option</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">s_pid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;parse_options %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
	<span class="cm">/* defaults */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">opts</span><span class="p">));</span>
	<span class="n">opts</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">BLK_DEFAULT_SG_TIMEOUT</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">token</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">p</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">Opt_name</span>:
			<span class="n">opts</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">opts</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;Error allocating dev_name&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">opts</span><span class="o">-&gt;</span><span class="n">is_osdname</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_pid</span>:
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">match_strlcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">opts</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">simple_strtoull</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opts</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="n">EXOFS_MIN_PID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;Partition ID must be &gt;= %u&quot;</span><span class="p">,</span>
					  <span class="n">EXOFS_MIN_PID</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">s_pid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_to</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;Timout must be &gt; 0&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">opts</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">option</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s_pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;Need to specify the following options:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;    -o pid=pid_no_to_use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * INODE CACHE</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Our inode cache.  Isn&#39;t it pretty?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">exofs_inode_cachep</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate an inode in the cache</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">exofs_alloc_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span><span class="p">;</span>

	<span class="n">oi</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">exofs_inode_cachep</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oi</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">exofs_i_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span><span class="p">,</span> <span class="n">i_rcu</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">exofs_inode_cachep</span><span class="p">,</span> <span class="n">exofs_i</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove an inode from the cache</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">exofs_destroy_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rcu</span><span class="p">,</span> <span class="n">exofs_i_callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the inode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">exofs_init_once</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">foo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">foo</span><span class="p">;</span>

	<span class="n">inode_init_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create and initialize the inode cache</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_inodecache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">exofs_inode_cachep</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;exofs_inode_cache&quot;</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">exofs_i_info</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">SLAB_RECLAIM_ACCOUNT</span> <span class="o">|</span> <span class="n">SLAB_MEM_SPREAD</span><span class="p">,</span>
				<span class="n">exofs_init_once</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exofs_inode_cachep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Destroy the inode cache</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_inodecache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">exofs_inode_cachep</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * Some osd helpers</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">exofs_make_credential</span><span class="p">(</span><span class="n">u8</span> <span class="n">cred_a</span><span class="p">[</span><span class="n">OSD_CAP_LEN</span><span class="p">],</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">osd_sec_init_nosec_doall_caps</span><span class="p">(</span><span class="n">cred_a</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exofs_read_kern</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_dev</span> <span class="o">*</span><span class="n">od</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
		    <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span> <span class="o">=</span> <span class="n">osd_start_request</span><span class="p">(</span><span class="n">od</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="cm">/*	struct osd_sense_info osi = {.key = 0};*/</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;%s: osd_start_request failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">osd_req_read_kern</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;%s: osd_req_read_kern failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">osd_finalize_request</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;Failed to osd_finalize_request() =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">osd_execute_request</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;osd_execute_request() =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="cm">/* osd_req_decode_sense(or, ret); */</span>

<span class="nl">out:</span>
	<span class="n">osd_end_request</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
	<span class="n">EXOFS_DBGMSG2</span><span class="p">(</span><span class="s">&quot;read_kern(0x%llx) offset=0x%llx &quot;</span>
		      <span class="s">&quot;length=0x%llx dev=%p ret=&gt;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">_LLU</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">),</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">length</span><span class="p">),</span> <span class="n">od</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">osd_attr</span> <span class="n">g_attr_sb_stats</span> <span class="o">=</span> <span class="n">ATTR_DEF</span><span class="p">(</span>
	<span class="n">EXOFS_APAGE_SB_DATA</span><span class="p">,</span>
	<span class="n">EXOFS_ATTR_SB_STATS</span><span class="p">,</span>
	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">exofs_sb_stats</span><span class="p">));</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__sbi_read_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_attr</span> <span class="n">attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">g_attr_sb_stats</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_get_io_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: ore_get_io_state failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">in_attr</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">in_attr_len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">attrs</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_read</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;Error reading super_block stats =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">extract_attr_from_ios</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: extract_attr of sb_stats failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">exofs_sb_stats</span> <span class="o">*</span><span class="n">ess</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ess</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: Wrong version of exofs_sb_stats &quot;</span>
				  <span class="s">&quot;size(%d) != expected(%zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ess</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ess</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">;</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_nextid</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">ess</span><span class="o">-&gt;</span><span class="n">s_nextid</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_numfiles</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ess</span><span class="o">-&gt;</span><span class="n">s_numfiles</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">ore_put_io_state</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stats_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ore_put_io_state</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="cm">/* Good thanks nothing to do anymore */</span>
<span class="p">}</span>

<span class="cm">/* Asynchronously write the stats attribute */</span>
<span class="kt">int</span> <span class="nf">exofs_sbi_write_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_attr</span> <span class="n">attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">g_attr_sb_stats</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_get_io_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: ore_get_io_state failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ess</span><span class="p">.</span><span class="n">s_nextid</span>   <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_nextid</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ess</span><span class="p">.</span><span class="n">s_numfiles</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_numfiles</span><span class="p">);</span>
	<span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">val_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ess</span><span class="p">;</span>


	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">stats_done</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">sbi</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">out_attr</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">out_attr_len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">attrs</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_write</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: ore_write failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ore_put_io_state</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * SUPERBLOCK FUNCTIONS</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">super_operations</span> <span class="n">exofs_sops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">export_operations</span> <span class="n">exofs_export_ops</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Write the superblock to the OSD</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">exofs_sync_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_fscb</span> <span class="o">*</span><span class="n">fscb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ore_comp</span> <span class="n">one_comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ore_components</span> <span class="n">oc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">fscb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fscb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">fscb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sbi</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>

	<span class="cm">/* NOTE: We no longer dirty the super_block anywhere in exofs. The</span>
<span class="cm">	 * reason we write the fscb here on unmount is so we can stay backwards</span>
<span class="cm">	 * compatible with fscb-&gt;s_version == 1. (What we are not compatible</span>
<span class="cm">	 * with is if a new version FS crashed and then we try to mount an old</span>
<span class="cm">	 * version). Otherwise the exofs_fscb is read-only from mkfs time. All</span>
<span class="cm">	 * the writeable info is set in exofs_sbi_write_stats() above.</span>
<span class="cm">	 */</span>

	<span class="n">exofs_init_comps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">one_comp</span><span class="p">,</span> <span class="n">sbi</span><span class="p">,</span> <span class="n">EXOFS_SUPER_ID</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_get_io_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">lock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">exofs_fscb</span><span class="p">,</span> <span class="n">s_dev_table_oid</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fscb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">fscb</span><span class="o">-&gt;</span><span class="n">s_nextid</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_nextid</span><span class="p">);</span>
	<span class="n">fscb</span><span class="o">-&gt;</span><span class="n">s_numfiles</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_numfiles</span><span class="p">);</span>
	<span class="n">fscb</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_magic</span><span class="p">);</span>
	<span class="n">fscb</span><span class="o">-&gt;</span><span class="n">s_newfs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fscb</span><span class="o">-&gt;</span><span class="n">s_version</span> <span class="o">=</span> <span class="n">EXOFS_FSCB_VER</span><span class="p">;</span>

	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">kern_buff</span> <span class="o">=</span> <span class="n">fscb</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_write</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: ore_write failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_dirt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;s_nextid=0x%llx ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_nextid</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">ore_put_io_state</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fscb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">exofs_write_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span>
		<span class="n">exofs_sync_fs</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_dirt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_exofs_print_device</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_path</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">osd_dev</span> <span class="o">*</span><span class="n">od</span><span class="p">,</span> <span class="n">u64</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_dev_info</span> <span class="o">*</span><span class="n">odi</span> <span class="o">=</span> <span class="n">osduld_device_info</span><span class="p">(</span><span class="n">od</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;exofs: %s %s osd_name-%s pid-0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">msg</span><span class="p">,</span> <span class="n">dev_path</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">odi</span><span class="o">-&gt;</span><span class="n">osdname</span><span class="p">,</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">pid</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">exofs_free_sbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">numdevs</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">.</span><span class="n">numdevs</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">numdevs</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="o">--</span><span class="n">numdevs</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">osd_dev</span> <span class="o">*</span><span class="n">od</span> <span class="o">=</span> <span class="n">ore_comp_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">od</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ore_comp_set_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">osduld_put_device</span><span class="p">(</span><span class="n">od</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">.</span><span class="n">ods</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called when the vfs is freeing the superblock.  We just</span>
<span class="cm"> * need to free our own part.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">exofs_put_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_pend</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>

	<span class="cm">/* make sure there are no pending commands */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">num_pend</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_curr_pending</span><span class="p">);</span> <span class="n">num_pend</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">num_pend</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_curr_pending</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wait_queue_head_t</span> <span class="n">wq</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: !!Pending operations in flight. &quot;</span>
		       <span class="s">&quot;This is a BUG. please report to osd-dev@open-osd.org</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="p">);</span>
		<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_curr_pending</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
				  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">_exofs_print_device</span><span class="p">(</span><span class="s">&quot;Unmounting&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ore_comp_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			    <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">one_comp</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">partition</span><span class="p">);</span>

	<span class="n">exofs_sysfs_sb_del</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
	<span class="n">bdi_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="p">);</span>
	<span class="n">exofs_free_sbi</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_read_and_match_data_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">numdevs</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">exofs_device_table</span> <span class="o">*</span><span class="n">dt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">stripe_unit</span> <span class="o">=</span>
				<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">dt_data_map</span><span class="p">.</span><span class="n">cb_stripe_unit</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">group_width</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">dt_data_map</span><span class="p">.</span><span class="n">cb_group_width</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">group_depth</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">dt_data_map</span><span class="p">.</span><span class="n">cb_group_depth</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">mirrors_p1</span>  <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">dt_data_map</span><span class="p">.</span><span class="n">cb_mirror_cnt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">raid_algorithm</span>  <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">dt_data_map</span><span class="p">.</span><span class="n">cb_raid_algorithm</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_verify_layout</span><span class="p">(</span><span class="n">numdevs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">);</span>

	<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;exofs: layout: &quot;</span>
		<span class="s">&quot;num_comps=%u stripe_unit=0x%x group_width=%u &quot;</span>
		<span class="s">&quot;group_depth=0x%llx mirrors_p1=%u raid_algorithm=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">numdevs</span><span class="p">,</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">stripe_unit</span><span class="p">,</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">group_width</span><span class="p">,</span>
		<span class="n">_LLU</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">group_depth</span><span class="p">),</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">mirrors_p1</span><span class="p">,</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">raid_algorithm</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">__ra_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">_MIN_RA</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="cm">/* min 128K read-ahead */</span>
	<span class="kt">unsigned</span> <span class="n">ra_pages</span> <span class="o">=</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span> <span class="o">*</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">stripe_unit</span> <span class="o">/</span>
				<span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">max_io_pages</span> <span class="o">=</span> <span class="n">exofs_max_io_pages</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">ra_pages</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* two stripes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ra_pages</span> <span class="o">&lt;</span> <span class="n">_MIN_RA</span><span class="p">)</span>
		<span class="n">ra_pages</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">_MIN_RA</span><span class="p">,</span> <span class="n">ra_pages</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ra_pages</span> <span class="o">&gt;</span> <span class="n">max_io_pages</span><span class="p">)</span>
		<span class="n">ra_pages</span> <span class="o">=</span> <span class="n">max_io_pages</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ra_pages</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* @odi is valid only as long as @fscb_dev is valid */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">exofs_devs_2_odi</span><span class="p">(</span><span class="k">struct</span> <span class="n">exofs_dt_device_info</span> <span class="o">*</span><span class="n">dt_dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">osd_dev_info</span> <span class="o">*</span><span class="n">odi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">odi</span><span class="o">-&gt;</span><span class="n">systemid_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dt_dev</span><span class="o">-&gt;</span><span class="n">systemid_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">odi</span><span class="o">-&gt;</span><span class="n">systemid_len</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">odi</span><span class="o">-&gt;</span><span class="n">systemid</span><span class="p">,</span> <span class="n">dt_dev</span><span class="o">-&gt;</span><span class="n">systemid</span><span class="p">,</span> <span class="n">OSD_SYSTEMID_LEN</span><span class="p">);</span>

	<span class="n">odi</span><span class="o">-&gt;</span><span class="n">osdname_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dt_dev</span><span class="o">-&gt;</span><span class="n">osdname_len</span><span class="p">);</span>
	<span class="n">odi</span><span class="o">-&gt;</span><span class="n">osdname</span> <span class="o">=</span> <span class="n">dt_dev</span><span class="o">-&gt;</span><span class="n">osdname</span><span class="p">;</span>

	<span class="cm">/* FIXME support long names. Will need a _put function */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dt_dev</span><span class="o">-&gt;</span><span class="n">long_name_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Make sure osdname is printable!</span>
<span class="cm">	 * mkexofs should give us space for a null-terminator else the</span>
<span class="cm">	 * device-table is invalid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">odi</span><span class="o">-&gt;</span><span class="n">osdname_len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dt_dev</span><span class="o">-&gt;</span><span class="n">osdname</span><span class="p">)))</span>
		<span class="n">odi</span><span class="o">-&gt;</span><span class="n">osdname_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dt_dev</span><span class="o">-&gt;</span><span class="n">osdname</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dt_dev</span><span class="o">-&gt;</span><span class="n">osdname</span><span class="p">[</span><span class="n">odi</span><span class="o">-&gt;</span><span class="n">osdname_len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If it&#39;s all zeros something is bad we read past end-of-obj */</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">odi</span><span class="o">-&gt;</span><span class="n">systemid_len</span> <span class="o">||</span> <span class="n">odi</span><span class="o">-&gt;</span><span class="n">osdname_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__alloc_dev_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">numdevs</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">exofs_dev</span> <span class="o">**</span><span class="n">peds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__alloc_ore_devs_and_exofs_devs</span> <span class="p">{</span>
		<span class="cm">/* Twice bigger table: See exofs_init_comps() and comment at</span>
<span class="cm">		 * exofs_read_lookup_dev_table()</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">ore_dev</span> <span class="o">*</span><span class="n">oreds</span><span class="p">[</span><span class="n">numdevs</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">exofs_dev</span> <span class="n">eds</span><span class="p">[</span><span class="n">numdevs</span><span class="p">];</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">aoded</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_dev</span> <span class="o">*</span><span class="n">eds</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">aoded</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">aoded</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">aoded</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;ERROR: failed allocating Device array[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">numdevs</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">.</span><span class="n">ods</span> <span class="o">=</span> <span class="n">aoded</span><span class="o">-&gt;</span><span class="n">oreds</span><span class="p">;</span>
	<span class="o">*</span><span class="n">peds</span> <span class="o">=</span> <span class="n">eds</span> <span class="o">=</span> <span class="n">aoded</span><span class="o">-&gt;</span><span class="n">eds</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numdevs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">aoded</span><span class="o">-&gt;</span><span class="n">oreds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ored</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exofs_read_lookup_dev_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">osd_dev</span> <span class="o">*</span><span class="n">fscb_od</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="n">table_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ore_comp</span> <span class="n">comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_device_table</span> <span class="o">*</span><span class="n">dt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_dev</span> <span class="o">*</span><span class="n">eds</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">table_bytes</span> <span class="o">=</span> <span class="n">table_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">dt_dev_table</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dt</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">numdevs</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dt</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">table_bytes</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">dt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;ERROR: allocating %x bytes for device table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">table_bytes</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">.</span><span class="n">numdevs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">comp</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">partition</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">one_comp</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">partition</span><span class="p">;</span>
	<span class="n">comp</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">EXOFS_DEVTABLE_ID</span><span class="p">;</span>
	<span class="n">exofs_make_credential</span><span class="p">(</span><span class="n">comp</span><span class="p">.</span><span class="n">cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp</span><span class="p">.</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">exofs_read_kern</span><span class="p">(</span><span class="n">fscb_od</span><span class="p">,</span> <span class="n">comp</span><span class="p">.</span><span class="n">cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp</span><span class="p">.</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span>
			      <span class="n">table_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;ERROR: reading device table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">numdevs</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">dt_num_devices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">numdevs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">table_count</span> <span class="o">!=</span> <span class="n">numdevs</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_read_and_match_data_map</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">numdevs</span><span class="p">,</span> <span class="n">dt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__alloc_dev_table</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">numdevs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eds</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* exofs round-robins the device table view according to inode</span>
<span class="cm">	 * number. We hold a: twice bigger table hence inodes can point</span>
<span class="cm">	 * to any device and have a sequential view of the table</span>
<span class="cm">	 * starting at this device. See exofs_init_comps()</span>
<span class="cm">	 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">.</span><span class="n">ods</span><span class="p">[</span><span class="n">numdevs</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">.</span><span class="n">ods</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="p">(</span><span class="n">numdevs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">.</span><span class="n">ods</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="cm">/* create sysfs subdir under which we put the device table</span>
<span class="cm">	 * And cluster layout. A Superblock is identified by the string:</span>
<span class="cm">	 *	&quot;dev[0].osdname&quot;_&quot;pid&quot;</span>
<span class="cm">	 */</span>
	<span class="n">exofs_sysfs_sb_add</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">dt_dev_table</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numdevs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">exofs_fscb</span> <span class="n">fscb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">osd_dev_info</span> <span class="n">odi</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">osd_dev</span> <span class="o">*</span><span class="n">od</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">exofs_devs_2_odi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">dt_dev_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">odi</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;ERROR: Read all-zeros device entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Add device[%d]: osd_name-%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">odi</span><span class="p">.</span><span class="n">osdname</span><span class="p">);</span>

		<span class="cm">/* the exofs id is currently the table index */</span>
		<span class="n">eds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">did</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* On all devices the device table is identical. The user can</span>
<span class="cm">		 * specify any one of the participating devices on the command</span>
<span class="cm">		 * line. We always keep them in device-table order.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fscb_od</span> <span class="o">&amp;&amp;</span> <span class="n">osduld_device_same</span><span class="p">(</span><span class="n">fscb_od</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">odi</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">eds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ored</span><span class="p">.</span><span class="n">od</span> <span class="o">=</span> <span class="n">fscb_od</span><span class="p">;</span>
			<span class="o">++</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">.</span><span class="n">numdevs</span><span class="p">;</span>
			<span class="n">fscb_od</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">exofs_sysfs_odev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sbi</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">od</span> <span class="o">=</span> <span class="n">osduld_info_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">odi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">od</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">od</span><span class="p">);</span>
			<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;ERROR: device requested is not found &quot;</span>
				  <span class="s">&quot;osd_name-%s =&gt;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">odi</span><span class="p">.</span><span class="n">osdname</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">eds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ored</span><span class="p">.</span><span class="n">od</span> <span class="o">=</span> <span class="n">od</span><span class="p">;</span>
		<span class="o">++</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">.</span><span class="n">numdevs</span><span class="p">;</span>

		<span class="cm">/* Read the fscb of the other devices to make sure the FS</span>
<span class="cm">		 * partition is there.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">exofs_read_kern</span><span class="p">(</span><span class="n">od</span><span class="p">,</span> <span class="n">comp</span><span class="p">.</span><span class="n">cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp</span><span class="p">.</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fscb</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="n">fscb</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;ERROR: Malformed participating device &quot;</span>
				  <span class="s">&quot;error reading fscb osd_name-%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">odi</span><span class="p">.</span><span class="n">osdname</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">exofs_sysfs_odev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sbi</span><span class="p">);</span>

		<span class="cm">/* TODO: verify other information is correct and FS-uuid</span>
<span class="cm">		 *	 matches. Benny what did you say about device table</span>
<span class="cm">		 *	 generation and old devices?</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">fscb_od</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;ERROR: Bad device-table container device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">osduld_put_device</span><span class="p">(</span><span class="n">fscb_od</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the superblock from the OSD and fill in the fields</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">exofs_fill_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">silent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_mountopt</span> <span class="o">*</span><span class="n">opts</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">;</span>	<span class="cm">/*extended info                  */</span>
	<span class="k">struct</span> <span class="n">osd_dev</span> <span class="o">*</span><span class="n">od</span><span class="p">;</span>		<span class="cm">/* Master device                 */</span>
	<span class="k">struct</span> <span class="n">exofs_fscb</span> <span class="n">fscb</span><span class="p">;</span>		<span class="cm">/*on-disk superblock info        */</span>
	<span class="k">struct</span> <span class="n">ore_comp</span> <span class="n">comp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">table_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sbi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sbi</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* use mount options to fill superblock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span><span class="o">-&gt;</span><span class="n">is_osdname</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osd_dev_info</span> <span class="n">odi</span> <span class="o">=</span> <span class="p">{.</span><span class="n">systemid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">};</span>

		<span class="n">odi</span><span class="p">.</span><span class="n">osdname_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">opts</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
		<span class="n">odi</span><span class="p">.</span><span class="n">osdname</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">opts</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">;</span>
		<span class="n">od</span> <span class="o">=</span> <span class="n">osduld_info_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">odi</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">opts</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
		<span class="n">opts</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">od</span> <span class="o">=</span> <span class="n">osduld_path_lookup</span><span class="p">(</span><span class="n">opts</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">od</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_sbi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Default layout in case we do not have a device-table */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">stripe_unit</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">mirrors_p1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">group_width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">group_depth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">group_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_timeout</span> <span class="o">=</span> <span class="n">opts</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">one_comp</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">partition</span> <span class="o">=</span> <span class="n">opts</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">one_comp</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">exofs_make_credential</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">one_comp</span><span class="p">.</span><span class="n">cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">one_comp</span><span class="p">.</span><span class="n">obj</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">.</span><span class="n">single_comp</span> <span class="o">=</span> <span class="n">EC_SINGLE_COMP</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">.</span><span class="n">comps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">one_comp</span><span class="p">;</span>

	<span class="cm">/* fill in some other data by hand */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="s">&quot;exofs&quot;</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">=</span> <span class="n">EXOFS_BLKSIZE</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span> <span class="o">=</span> <span class="n">EXOFS_BLKSHIFT</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_maxbytes</span> <span class="o">=</span> <span class="n">MAX_LFS_FILESIZE</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_max_links</span> <span class="o">=</span> <span class="n">EXOFS_LINK_MAX</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_curr_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">comp</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">partition</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">one_comp</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">partition</span><span class="p">;</span>
	<span class="n">comp</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">EXOFS_SUPER_ID</span><span class="p">;</span>
	<span class="n">exofs_make_credential</span><span class="p">(</span><span class="n">comp</span><span class="p">.</span><span class="n">cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp</span><span class="p">.</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">exofs_read_kern</span><span class="p">(</span><span class="n">od</span><span class="p">,</span> <span class="n">comp</span><span class="p">.</span><span class="n">cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp</span><span class="p">.</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fscb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fscb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_sbi</span><span class="p">;</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fscb</span><span class="p">.</span><span class="n">s_magic</span><span class="p">);</span>
	<span class="cm">/* NOTE: we read below to be backward compatible with old versions */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_nextid</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">fscb</span><span class="p">.</span><span class="n">s_nextid</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_numfiles</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fscb</span><span class="p">.</span><span class="n">s_numfiles</span><span class="p">);</span>

	<span class="cm">/* make sure what we read from the object store is correct */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">!=</span> <span class="n">EXOFS_SUPER_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
			<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;ERROR: Bad magic value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_sbi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fscb</span><span class="p">.</span><span class="n">s_version</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">EXOFS_FSCB_VER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;ERROR: Bad FSCB version expected-%d got-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">EXOFS_FSCB_VER</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fscb</span><span class="p">.</span><span class="n">s_version</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_sbi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* start generation numbers from a random point */</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_next_generation</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_next_gen_lock</span><span class="p">);</span>

	<span class="n">table_count</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">fscb</span><span class="p">.</span><span class="n">s_dev_table_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">exofs_read_lookup_dev_table</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="n">od</span><span class="p">,</span> <span class="n">table_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free_sbi</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">exofs_dev</span> <span class="o">*</span><span class="n">eds</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">__alloc_dev_table</span><span class="p">(</span><span class="n">sbi</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eds</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free_sbi</span><span class="p">;</span>

		<span class="n">ore_comp_set_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">od</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">.</span><span class="n">numdevs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__sbi_read_stats</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>

	<span class="cm">/* set up operation vectors */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="p">.</span><span class="n">ra_pages</span> <span class="o">=</span> <span class="n">__ra_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="n">sbi</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">exofs_sops</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_export_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">exofs_export_ops</span><span class="p">;</span>
	<span class="n">root</span> <span class="o">=</span> <span class="n">exofs_iget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXOFS_ROOT_ID</span> <span class="o">-</span> <span class="n">EXOFS_OBJ_OFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">root</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;ERROR: exofs_iget failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_sbi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="n">d_make_root</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;ERROR: get root inode failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_sbi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;ERROR: corrupt root inode (mode = %hd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">root</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_sbi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bdi_setup_and_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="p">,</span> <span class="s">&quot;exofs&quot;</span><span class="p">,</span> <span class="n">BDI_CAP_MAP_COPY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;Failed to bdi_setup_and_register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_sbi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">exofs_sysfs_dbg_print</span><span class="p">();</span>
	<span class="n">_exofs_print_device</span><span class="p">(</span><span class="s">&quot;Mounting&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span>
			    <span class="n">ore_comp_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			    <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">one_comp</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">partition</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_sbi:</span>
	<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;Unable to mount exofs on %s pid=0x%llx err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">opts</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">one_comp</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">partition</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">exofs_free_sbi</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up the superblock (calls exofs_fill_super eventually)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">exofs_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_mountopt</span> <span class="n">opts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">parse_options</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opts</span><span class="p">.</span><span class="n">dev_name</span><span class="p">)</span>
		<span class="n">opts</span><span class="p">.</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">dev_name</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mount_nodev</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">,</span> <span class="n">exofs_fill_super</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return information about the file system state in the buffer.  This is used</span>
<span class="cm"> * by the &#39;df&#39; command, for example.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">exofs_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_attr</span> <span class="n">attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">ATTR_DEF</span><span class="p">(</span><span class="n">OSD_APAGE_PARTITION_QUOTAS</span><span class="p">,</span>
			<span class="n">OSD_ATTR_PQ_CAPACITY_QUOTA</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be64</span><span class="p">)),</span>
		<span class="n">ATTR_DEF</span><span class="p">(</span><span class="n">OSD_APAGE_PARTITION_INFORMATION</span><span class="p">,</span>
			<span class="n">OSD_ATTR_PI_USED_CAPACITY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be64</span><span class="p">)),</span>
	<span class="p">};</span>
	<span class="kt">uint64_t</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">ULLONG_MAX</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">used</span> <span class="o">=</span> <span class="n">ULLONG_MAX</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_get_io_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;ore_get_io_state failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">in_attr</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">in_attr_len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">attrs</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_read</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">extract_attr_from_ios</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">capacity</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">capacity</span><span class="p">))</span>
			<span class="n">capacity</span> <span class="o">=</span> <span class="n">ULLONG_MAX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;exofs_statfs: get capacity failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">extract_attr_from_ios</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">))</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;exofs_statfs: get used-space failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* fill in the stats buffer */</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_type</span> <span class="o">=</span> <span class="n">EXOFS_SUPER_MAGIC</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bsize</span> <span class="o">=</span> <span class="n">EXOFS_BLKSIZE</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_blocks</span> <span class="o">=</span> <span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">-</span> <span class="n">used</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bavail</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_files</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_numfiles</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_ffree</span> <span class="o">=</span> <span class="n">EXOFS_MAX_ID</span> <span class="o">-</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_numfiles</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_namelen</span> <span class="o">=</span> <span class="n">EXOFS_NAME_LEN</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">ore_put_io_state</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">super_operations</span> <span class="n">exofs_sops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc_inode</span>    <span class="o">=</span> <span class="n">exofs_alloc_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_inode</span>  <span class="o">=</span> <span class="n">exofs_destroy_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_inode</span>    <span class="o">=</span> <span class="n">exofs_write_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">evict_inode</span>    <span class="o">=</span> <span class="n">exofs_evict_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_super</span>      <span class="o">=</span> <span class="n">exofs_put_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_super</span>    <span class="o">=</span> <span class="n">exofs_write_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_fs</span>	<span class="o">=</span> <span class="n">exofs_sync_fs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">statfs</span>         <span class="o">=</span> <span class="n">exofs_statfs</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * EXPORT OPERATIONS</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">exofs_get_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ino</span> <span class="o">=</span> <span class="n">exofs_parent_ino</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ino</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">d_obtain_alias</span><span class="p">(</span><span class="n">exofs_iget</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">ino</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">exofs_nfs_get_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">ino</span><span class="p">,</span> <span class="n">u32</span> <span class="n">generation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>

	<span class="n">inode</span> <span class="o">=</span> <span class="n">exofs_iget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">generation</span> <span class="o">&amp;&amp;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_generation</span> <span class="o">!=</span> <span class="n">generation</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we didn&#39;t find the right inode.. */</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">exofs_fh_to_dentry</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fh_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fh_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">generic_fh_to_dentry</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">fh_len</span><span class="p">,</span> <span class="n">fh_type</span><span class="p">,</span>
				    <span class="n">exofs_nfs_get_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">exofs_fh_to_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fh_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fh_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">generic_fh_to_parent</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">fh_len</span><span class="p">,</span> <span class="n">fh_type</span><span class="p">,</span>
				    <span class="n">exofs_nfs_get_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">export_operations</span> <span class="n">exofs_export_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fh_to_dentry</span> <span class="o">=</span> <span class="n">exofs_fh_to_dentry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fh_to_parent</span> <span class="o">=</span> <span class="n">exofs_fh_to_parent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_parent</span> <span class="o">=</span> <span class="n">exofs_get_parent</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * INSMOD/RMMOD</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * struct that describes this file system</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">exofs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>          <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;exofs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>          <span class="o">=</span> <span class="n">exofs_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>        <span class="o">=</span> <span class="n">generic_shutdown_super</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_exofs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">init_inodecache</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exofs_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_d</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t fail if sysfs creation failed */</span>
	<span class="n">exofs_sysfs_init</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_d:</span>
	<span class="n">destroy_inodecache</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_exofs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">exofs_sysfs_uninit</span><span class="p">();</span>
	<span class="n">unregister_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exofs_type</span><span class="p">);</span>
	<span class="n">destroy_inodecache</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Avishay Traeger &lt;avishay@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;exofs&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_exofs</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_exofs</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
