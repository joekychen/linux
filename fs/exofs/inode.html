<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › exofs › inode.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>inode.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2005, 2006</span>
<span class="cm"> * Avishay Traeger (avishay@gmail.com)</span>
<span class="cm"> * Copyright (C) 2008, 2009</span>
<span class="cm"> * Boaz Harrosh &lt;bharrosh@panasas.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyrights for code taken from ext2:</span>
<span class="cm"> *     Copyright (C) 1992, 1993, 1994, 1995</span>
<span class="cm"> *     Remy Card (card@masi.ibp.fr)</span>
<span class="cm"> *     Laboratoire MASI - Institut Blaise Pascal</span>
<span class="cm"> *     Universite Pierre et Marie Curie (Paris VI)</span>
<span class="cm"> *     from</span>
<span class="cm"> *     linux/fs/minix/inode.c</span>
<span class="cm"> *     Copyright (C) 1991, 1992  Linus Torvalds</span>
<span class="cm"> *</span>
<span class="cm"> * This file is part of exofs.</span>
<span class="cm"> *</span>
<span class="cm"> * exofs is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation.  Since it is based on ext2, and the only</span>
<span class="cm"> * valid version of GPL for the Linux kernel is version 2, the only valid</span>
<span class="cm"> * version of GPL for exofs is version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * exofs is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with exofs; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;exofs.h&quot;</span>

<span class="cp">#define EXOFS_DBGMSG2(M...) do {} while (0)</span>

<span class="k">enum</span> <span class="p">{</span><span class="n">MAX_PAGES_KMALLOC</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">),</span> <span class="p">};</span>

<span class="kt">unsigned</span> <span class="nf">exofs_max_io_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">expected_pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">pages</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">expected_pages</span><span class="p">,</span> <span class="n">MAX_PAGES_KMALLOC</span><span class="p">);</span>

	<span class="cm">/* TODO: easily support bio chaining */</span>
	<span class="n">pages</span> <span class="o">=</span>  <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">max_io_length</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pages</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">page_collect</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">expected_pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">alloc_pages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">nr_pages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">pg_first</span><span class="p">;</span> <span class="cm">/* keep 64bit also in 32-arches */</span>
	<span class="n">bool</span> <span class="n">read_4_write</span><span class="p">;</span> <span class="cm">/* This means two things: that the read is sync</span>
<span class="cm">			    * And the pages should not be unlocked.</span>
<span class="cm">			    */</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">that_locked_page</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_pcol_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">expected_pages</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>

	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">sbi</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">inode</span> <span class="o">=</span> <span class="n">inode</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">expected_pages</span> <span class="o">=</span> <span class="n">expected_pages</span><span class="p">;</span>

	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">ios</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">alloc_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pg_first</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">read_4_write</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">that_locked_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_pcol_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">expected_pages</span> <span class="o">-=</span> <span class="n">min</span><span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">,</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">expected_pages</span><span class="p">);</span>

	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">alloc_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pg_first</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">ios</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">that_locked_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* this is probably the end of the loop but in writes</span>
<span class="cm">	 * it might not end here. don&#39;t be left with nothing</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">expected_pages</span><span class="p">)</span>
		<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">expected_pages</span> <span class="o">=</span> <span class="n">MAX_PAGES_KMALLOC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcol_try_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">pages</span><span class="p">;</span>

	<span class="cm">/* TODO: easily support bio chaining */</span>
	<span class="n">pages</span> <span class="o">=</span>  <span class="n">exofs_max_io_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">expected_pages</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">pages</span><span class="p">;</span> <span class="n">pages</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">pages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">),</span>
				      <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">alloc_pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;Failed to kmalloc expected_pages=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">expected_pages</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcol_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">);</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ore_put_io_state</span><span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">);</span>
		<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">ios</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcol_add_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">&gt;=</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">alloc_pages</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="p">{</span><span class="n">PAGE_WAS_NOT_IN_IO</span> <span class="o">=</span> <span class="mi">17</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_read_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* Everything is OK */</span>
		<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PageError</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
			<span class="n">ClearPageError</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EFAULT</span>:
		<span class="cm">/* In this case we were trying to read something that wasn&#39;t on</span>
<span class="cm">		 * disk yet - return a page full of zeroes.  This should be OK,</span>
<span class="cm">		 * because the object should be empty (if there was a write</span>
<span class="cm">		 * before this read, the read would be waiting with the page</span>
<span class="cm">		 * locked */</span>
		<span class="n">clear_highpage</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PageError</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
			<span class="n">ClearPageError</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;recovered read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">PAGE_WAS_NOT_IN_IO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* recovered error */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">SetPageError</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_write_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">PAGE_WAS_NOT_IN_IO</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* don&#39;t pass start don&#39;t collect $200 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mapping_set_error</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">SetPageError</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">end_page_writeback</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called at the end of reads, to optionally unlock pages and update their</span>
<span class="cm"> * status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__readpages_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">good_bytes</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ore_check_io</span><span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">good_bytes</span> <span class="o">=</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PAGE_WAS_NOT_IN_IO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">good_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">EXOFS_DBGMSG2</span><span class="p">(</span><span class="s">&quot;readpages_done(0x%lx) good_bytes=0x%llx&quot;</span>
		     <span class="s">&quot; length=0x%lx nr_pages=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">good_bytes</span><span class="p">),</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
		     <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">page_stat</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">inode</span> <span class="o">!=</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* osd might add more pages at end */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">good_bytes</span><span class="p">))</span>
			<span class="n">page_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">page_stat</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">EXOFS_DBGMSG2</span><span class="p">(</span><span class="s">&quot;    readpages_done(0x%lx, 0x%lx) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
			  <span class="n">page_stat</span> <span class="o">?</span> <span class="s">&quot;bad_bytes&quot;</span> <span class="o">:</span> <span class="s">&quot;good_bytes&quot;</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">update_read_page</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">page_stat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">read_4_write</span><span class="p">)</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pcol_free</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
	<span class="n">EXOFS_DBGMSG2</span><span class="p">(</span><span class="s">&quot;readpages_done END</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* callback of async reads */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">readpages_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">__readpages_done</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_curr_pending</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_unlock_pcol_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
			<span class="n">update_read_page</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">update_write_page</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_maybe_not_all_in_one_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol_src</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* length was wrong or offset was not page aligned */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pcol_src</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">&lt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcol_src</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">&gt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">src_page</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">pages_less</span> <span class="o">=</span> <span class="n">pcol_src</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">-</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len_less</span> <span class="o">=</span> <span class="n">pcol_src</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/* This IO was trimmed */</span>
		<span class="n">pcol_src</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">;</span>
		<span class="n">pcol_src</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

		<span class="cm">/* Left over pages are passed to the next io */</span>
		<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">expected_pages</span> <span class="o">+=</span> <span class="n">pages_less</span><span class="p">;</span>
		<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="n">pages_less</span><span class="p">;</span>
		<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">len_less</span><span class="p">;</span>
		<span class="n">src_page</span> <span class="o">=</span> <span class="n">pcol_src</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">+</span> <span class="n">pcol_src</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">;</span>
		<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pg_first</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">src_page</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">pcol_try_alloc</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pages_less</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">src_page</span><span class="o">++</span><span class="p">;</span>

		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;Length was adjusted nr_pages=0x%x &quot;</span>
			<span class="s">&quot;pages_less=0x%x expected_pages=0x%x &quot;</span>
			<span class="s">&quot;next_offset=0x%llx next_len=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pcol_src</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">,</span> <span class="n">pages_less</span><span class="p">,</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">expected_pages</span><span class="p">,</span>
			<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pg_first</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_exec</span><span class="p">(</span><span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">exofs_i</span><span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol_copy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ore_get_rw_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
					     <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pg_first</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">,</span>
					     <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ios</span> <span class="o">=</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">read_4_write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ore_read</span><span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">__readpages_done</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pcol_copy</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pcol_copy</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcol_copy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">pcol_copy</span> <span class="o">=</span> <span class="o">*</span><span class="n">pcol</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">readpages_done</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">pcol_copy</span><span class="p">;</span>

	<span class="cm">/* pages ownership was passed to pcol_copy */</span>
	<span class="n">_pcol_reset</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_maybe_not_all_in_one_io</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">pcol_copy</span><span class="p">,</span> <span class="n">pcol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">EXOFS_DBGMSG2</span><span class="p">(</span><span class="s">&quot;read_exec(0x%lx) offset=0x%llx length=0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_read</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_curr_pending</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">read_4_write</span><span class="p">)</span>
		<span class="n">_unlock_pcol_pages</span><span class="p">(</span><span class="n">pcol</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">READ</span><span class="p">);</span>

	<span class="n">pcol_free</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pcol_copy</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* readpage_strip is called either directly from readpage() or by the VFS from</span>
<span class="cm"> * within read_cache_pages(), to add one more page to be read. It will try to</span>
<span class="cm"> * collect as many contiguous pages as posible. If a discontinuity is</span>
<span class="cm"> * encountered, or it runs out of resources, it will submit the previous segment</span>
<span class="cm"> * and will start a new collection. Eventually caller must submit the last</span>
<span class="cm"> * segment if present.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">readpage_strip</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">exofs_i</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">loff_t</span> <span class="n">i_size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">pgoff_t</span> <span class="n">end_index</span> <span class="o">=</span> <span class="n">i_size</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* FIXME: Just for debugging, will be removed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;PageUptodate(0x%lx, 0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span>
			  <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">that_locked_page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">end_index</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">end_index</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">i_size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_CACHE_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="o">!</span><span class="n">obj_created</span><span class="p">(</span><span class="n">oi</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* this will be out of bounds, or doesn&#39;t exist yet.</span>
<span class="cm">		 * Current page is cleared and the request is split</span>
<span class="cm">		 */</span>
		<span class="n">clear_highpage</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PageError</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
			<span class="n">ClearPageError</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">read_4_write</span><span class="p">)</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;readpage_strip(0x%lx) empty page len=%zx &quot;</span>
			     <span class="s">&quot;read_4_write=%d index=0x%lx end_index=0x%lx &quot;</span>
			     <span class="s">&quot;splitting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			     <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">read_4_write</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">end_index</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">read_exec</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">try_again:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pg_first</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pg_first</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pg_first</span> <span class="o">+</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">)</span> <span class="o">!=</span>
		   <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Discontinuity detected, split the request */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">read_exec</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pcol_try_alloc</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">)</span>
		<span class="n">zero_user</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">EXOFS_DBGMSG2</span><span class="p">(</span><span class="s">&quot;    readpage_strip(0x%lx, 0x%lx) len=0x%zx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcol_add_page</span><span class="p">(</span><span class="n">pcol</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_DBGMSG2</span><span class="p">(</span><span class="s">&quot;Failed pcol_add_page pages[i]=%p &quot;</span>
			  <span class="s">&quot;this_len=0x%zx nr_pages=%u length=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">page</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">,</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

		<span class="cm">/* split the request, and start again with current page */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">read_exec</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="cm">/* SetPageError(page); ??? */</span>
	<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exofs_readpages</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pages</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nr_pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page_collect</span> <span class="n">pcol</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_pcol_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_cache_pages</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">readpage_strip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;read_cache_pages =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_exec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">read_exec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_readpage</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="n">bool</span> <span class="n">read_4_write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page_collect</span> <span class="n">pcol</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_pcol_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">pcol</span><span class="p">.</span><span class="n">read_4_write</span> <span class="o">=</span> <span class="n">read_4_write</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">readpage_strip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;_readpage =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">read_exec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We don&#39;t need the file</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">exofs_readpage</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_readpage</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Callback for osd_write. All writes are asynchronous */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">writepages_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span>  <span class="n">good_bytes</span><span class="p">;</span>
	<span class="n">u64</span>  <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ore_check_io</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_curr_pending</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">good_bytes</span> <span class="o">=</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PAGE_WAS_NOT_IN_IO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">good_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">EXOFS_DBGMSG2</span><span class="p">(</span><span class="s">&quot;writepages_done(0x%lx) good_bytes=0x%llx&quot;</span>
		     <span class="s">&quot; length=0x%lx nr_pages=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">good_bytes</span><span class="p">),</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
		     <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">page_stat</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">inode</span> <span class="o">!=</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* osd might add more pages to a bio */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">good_bytes</span><span class="p">))</span>
			<span class="n">page_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">page_stat</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">update_write_page</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">page_stat</span><span class="p">);</span>
		<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">EXOFS_DBGMSG2</span><span class="p">(</span><span class="s">&quot;    writepages_done(0x%lx, 0x%lx) status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">page_stat</span><span class="p">);</span>

		<span class="n">length</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pcol_free</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
	<span class="n">EXOFS_DBGMSG2</span><span class="p">(</span><span class="s">&quot;writepages_done END</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">__r4w_get_page</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">uptodate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">pgoff_t</span> <span class="n">index</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">that_locked_page</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">that_locked_page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="n">index</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">find_get_page</span><span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">find_or_create_page</span><span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span>
						   <span class="n">index</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;grab_cache_page Failed &quot;</span>
					<span class="s">&quot;index=0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PageDirty</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">||</span> <span class="n">PageWriteback</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
			<span class="o">*</span><span class="n">uptodate</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">uptodate</span> <span class="o">=</span> <span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;index=0x%lx uptodate=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">*</span><span class="n">uptodate</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">page</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;YES that_locked_page index=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">that_locked_page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="o">*</span><span class="n">uptodate</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">that_locked_page</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__r4w_put_page</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">that_locked_page</span> <span class="o">!=</span> <span class="n">page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;index=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;that_locked_page index=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">_ore_r4w_op</span> <span class="n">_r4w_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_page</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__r4w_get_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_page</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__r4w_put_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_exec</span><span class="p">(</span><span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">exofs_i</span><span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol_copy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_get_rw_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
				 <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pg_first</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">,</span>
				 <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pcol_copy</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pcol_copy</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcol_copy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;write_exec: Failed to kmalloc(pcol)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">pcol_copy</span> <span class="o">=</span> <span class="o">*</span><span class="n">pcol</span><span class="p">;</span>

	<span class="n">ios</span> <span class="o">=</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">pcol_copy</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">writepages_done</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">r4w</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_r4w_op</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">pcol_copy</span><span class="p">;</span>

	<span class="cm">/* pages ownership was passed to pcol_copy */</span>
	<span class="n">_pcol_reset</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_maybe_not_all_in_one_io</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">pcol_copy</span><span class="p">,</span> <span class="n">pcol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">EXOFS_DBGMSG2</span><span class="p">(</span><span class="s">&quot;write_exec(0x%lx) offset=0x%llx length=0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_write</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;write_exec: ore_write() Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_curr_pending</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">_unlock_pcol_pages</span><span class="p">(</span><span class="n">pcol</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">);</span>
	<span class="n">pcol_free</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pcol_copy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* writepage_strip is called either directly from writepage() or by the VFS from</span>
<span class="cm"> * within write_cache_pages(), to add one more page to be written to storage.</span>
<span class="cm"> * It will try to collect as many contiguous pages as possible. If a</span>
<span class="cm"> * discontinuity is encountered or it runs out of resources it will submit the</span>
<span class="cm"> * previous segment and will start a new collection.</span>
<span class="cm"> * Eventually caller must submit the last segment if present.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">writepage_strip</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">writeback_control</span> <span class="o">*</span><span class="n">wbc_unused</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page_collect</span> <span class="o">*</span><span class="n">pcol</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">exofs_i</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">loff_t</span> <span class="n">i_size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">pgoff_t</span> <span class="n">end_index</span> <span class="o">=</span> <span class="n">i_size</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">PageLocked</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_obj_created</span><span class="p">(</span><span class="n">oi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">end_index</span><span class="p">)</span>
		<span class="cm">/* in this case, the page is within the limits of the file */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">i_size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_CACHE_MASK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">end_index</span> <span class="o">||</span> <span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* in this case, the page is outside the limits</span>
<span class="cm">			 * (truncate in progress)</span>
<span class="cm">			 */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">write_exec</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">PageError</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
				<span class="n">ClearPageError</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;writepage_strip(0x%lx, 0x%lx) &quot;</span>
				     <span class="s">&quot;outside the limits</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">try_again:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pg_first</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pg_first</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pg_first</span> <span class="o">+</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">)</span> <span class="o">!=</span>
		   <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Discontinuity detected, split the request */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">write_exec</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;writepage_strip(0x%lx, 0x%lx) Discontinuity</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcol</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pcol_try_alloc</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">EXOFS_DBGMSG2</span><span class="p">(</span><span class="s">&quot;    writepage_strip(0x%lx, 0x%lx) len=0x%zx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcol_add_page</span><span class="p">(</span><span class="n">pcol</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_DBGMSG2</span><span class="p">(</span><span class="s">&quot;Failed pcol_add_page &quot;</span>
			     <span class="s">&quot;nr_pages=%u total_length=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">,</span> <span class="n">pcol</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

		<span class="cm">/* split the request, next loop will start again */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">write_exec</span><span class="p">(</span><span class="n">pcol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;write_exec failed =&gt; %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">PageWriteback</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="n">set_page_writeback</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;Error: writepage_strip(0x%lx, 0x%lx)=&gt;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">AS_EIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exofs_writepages</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">writeback_control</span> <span class="o">*</span><span class="n">wbc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page_collect</span> <span class="n">pcol</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">expected_pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">wbc</span><span class="o">-&gt;</span><span class="n">range_start</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">wbc</span><span class="o">-&gt;</span><span class="n">range_end</span> <span class="o">==</span> <span class="n">LLONG_MAX</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">start</span> <span class="o">+</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">nrpages</span> <span class="o">:</span>
			<span class="n">wbc</span><span class="o">-&gt;</span><span class="n">range_end</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">||</span> <span class="n">end</span><span class="p">)</span>
		<span class="n">expected_pages</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">expected_pages</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">nrpages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">expected_pages</span> <span class="o">&lt;</span> <span class="mi">32L</span><span class="p">)</span>
		<span class="n">expected_pages</span> <span class="o">=</span> <span class="mi">32L</span><span class="p">;</span>

	<span class="n">EXOFS_DBGMSG2</span><span class="p">(</span><span class="s">&quot;inode(0x%lx) wbc-&gt;start=0x%llx wbc-&gt;end=0x%llx &quot;</span>
		     <span class="s">&quot;nrpages=%lu start=0x%lx end=0x%lx expected_pages=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">wbc</span><span class="o">-&gt;</span><span class="n">range_start</span><span class="p">,</span> <span class="n">wbc</span><span class="o">-&gt;</span><span class="n">range_end</span><span class="p">,</span>
		     <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">nrpages</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">expected_pages</span><span class="p">);</span>

	<span class="n">_pcol_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="p">,</span> <span class="n">expected_pages</span><span class="p">,</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">write_cache_pages</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">wbc</span><span class="p">,</span> <span class="n">writepage_strip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;write_cache_pages =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">write_exec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wbc</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">==</span> <span class="n">WB_SYNC_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">write_exec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcol</span><span class="p">);</span> <span class="cm">/* pump the last reminder */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pcol</span><span class="p">.</span><span class="n">nr_pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* not SYNC let the reminder join the next writeout */</span>
		<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pcol</span><span class="p">.</span><span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">pcol</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">end_page_writeback</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">set_page_dirty</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">static int exofs_writepage(struct page *page, struct writeback_control *wbc)</span>
<span class="cm">{</span>
<span class="cm">	struct page_collect pcol;</span>
<span class="cm">	int ret;</span>

<span class="cm">	_pcol_init(&amp;pcol, 1, page-&gt;mapping-&gt;host);</span>

<span class="cm">	ret = writepage_strip(page, NULL, &amp;pcol);</span>
<span class="cm">	if (ret) {</span>
<span class="cm">		EXOFS_ERR(&quot;exofs_writepage =&gt; %d\n&quot;, ret);</span>
<span class="cm">		return ret;</span>
<span class="cm">	}</span>

<span class="cm">	return write_exec(&amp;pcol);</span>
<span class="cm">}</span>
<span class="cm">*/</span>
<span class="cm">/* i_mutex held using inode-&gt;i_size directly */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_write_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">to</span> <span class="o">&gt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span>
		<span class="n">truncate_pagecache</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">exofs_write_begin</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
		<span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pagep</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">fsdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="o">*</span><span class="n">pagep</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_write_begin</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pagep</span><span class="p">,</span>
					 <span class="n">fsdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;simple_write_begin failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">page</span> <span class="o">=</span> <span class="o">*</span><span class="n">pagep</span><span class="p">;</span>
	<span class="p">}</span>

	 <span class="cm">/* read modify write */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">loff_t</span> <span class="n">i_size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
		<span class="n">pgoff_t</span> <span class="n">end_index</span> <span class="o">=</span> <span class="n">i_size</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">rlen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">end_index</span><span class="p">)</span>
			<span class="n">rlen</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">end_index</span><span class="p">)</span>
			<span class="n">rlen</span> <span class="o">=</span> <span class="n">i_size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_CACHE_MASK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_highpage</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">_readpage</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*SetPageError was done by _readpage. Is it ok?*/</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;__readpage failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="n">_write_failed</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exofs_write_begin_export</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
		<span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pagep</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">fsdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">pagep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">exofs_write_begin</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pagep</span><span class="p">,</span>
					<span class="n">fsdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exofs_write_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
			<span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">copied</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fsdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="cm">/* According to comment in simple_write_end i_mutex is held */</span>
	<span class="n">loff_t</span> <span class="n">i_size</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_write_end</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">copied</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">fsdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="n">_write_failed</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* TODO: once simple_write_end marks inode dirty remove */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i_size</span> <span class="o">!=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span>
		<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exofs_releasepage</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;page 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">exofs_invalidatepage</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;page 0x%lx offset 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">address_space_operations</span> <span class="n">exofs_aops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">readpage</span>	<span class="o">=</span> <span class="n">exofs_readpage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readpages</span>	<span class="o">=</span> <span class="n">exofs_readpages</span><span class="p">,</span>
	<span class="p">.</span><span class="n">writepage</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">writepages</span>	<span class="o">=</span> <span class="n">exofs_writepages</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_begin</span>	<span class="o">=</span> <span class="n">exofs_write_begin_export</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_end</span>	<span class="o">=</span> <span class="n">exofs_write_end</span><span class="p">,</span>
	<span class="p">.</span><span class="n">releasepage</span>	<span class="o">=</span> <span class="n">exofs_releasepage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_page_dirty</span>	<span class="o">=</span> <span class="n">__set_page_dirty_nobuffers</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invalidatepage</span> <span class="o">=</span> <span class="n">exofs_invalidatepage</span><span class="p">,</span>

	<span class="cm">/* Not implemented Yet */</span>
	<span class="p">.</span><span class="n">bmap</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* TODO: use osd&#39;s OSD_ACT_READ_MAP */</span>
	<span class="p">.</span><span class="n">direct_IO</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* TODO: Should be trivial to do */</span>

	<span class="cm">/* With these NULL has special meaning or default is not exported */</span>
	<span class="p">.</span><span class="n">get_xip_mem</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">migratepage</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">launder_page</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_partially_uptodate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_remove_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * INODE OPERATIONS</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Test whether an inode is a fast symlink.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">exofs_inode_is_fast_symlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">exofs_i</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">S_ISLNK</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_do_truncate</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">newsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">exofs_i</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_truncate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">newsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">))</span>
		<span class="n">truncate_setsize</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">newsize</span><span class="p">);</span>

	<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;(0x%lx) size=0x%llx ret=&gt;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">newsize</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set inode attributes - update size attribute on OSD if needed,</span>
<span class="cm"> *                        otherwise just call generic functions.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">exofs_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">iattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* if we are about to modify an object, and it hasn&#39;t been</span>
<span class="cm">	 * created yet, wait</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">wait_obj_created</span><span class="p">(</span><span class="n">exofs_i</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">inode_change_ok</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">iattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_size</span> <span class="o">!=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">_do_truncate</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setattr_copy</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">iattr</span><span class="p">);</span>
	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">osd_attr</span> <span class="n">g_attr_inode_file_layout</span> <span class="o">=</span> <span class="n">ATTR_DEF</span><span class="p">(</span>
	<span class="n">EXOFS_APAGE_FS_DATA</span><span class="p">,</span>
	<span class="n">EXOFS_ATTR_INODE_FILE_LAYOUT</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">osd_attr</span> <span class="n">g_attr_inode_dir_layout</span> <span class="o">=</span> <span class="n">ATTR_DEF</span><span class="p">(</span>
	<span class="n">EXOFS_APAGE_FS_DATA</span><span class="p">,</span>
	<span class="n">EXOFS_ATTR_INODE_DIR_LAYOUT</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Read the Linux inode info from the OSD, and return it as is. In exofs the</span>
<span class="cm"> * inode info is in an application specific page/attribute of the osd-object.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">exofs_get_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">exofs_fcb</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_attr</span> <span class="n">attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">g_attr_inode_data</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">g_attr_inode_file_layout</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">g_attr_inode_dir_layout</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_on_disk_inode_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_get_io_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: ore_get_io_state failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">attrs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">exofs_on_disk_inode_layout_size</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">.</span><span class="n">numdevs</span><span class="p">);</span>
	<span class="n">attrs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">exofs_on_disk_inode_layout_size</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">.</span><span class="n">numdevs</span><span class="p">);</span>

	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">in_attr</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">in_attr_len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">attrs</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_read</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;object(0x%llx) corrupted, return empty file=&gt;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">_LLU</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">one_comp</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">inode</span><span class="p">));</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span> <span class="o">=</span> <span class="mo">0040000</span> <span class="o">|</span> <span class="p">(</span><span class="mo">0777</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mo">022</span><span class="p">);</span>
		<span class="cm">/* If object is lost on target we might as well enable it&#39;s</span>
<span class="cm">		 * delete.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">extract_attr_from_ios</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: extract_attr of inode_data failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">!=</span> <span class="n">EXOFS_INO_ATTR_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">,</span> <span class="n">EXOFS_INO_ATTR_SIZE</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">extract_attr_from_ios</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: extract_attr of inode_data failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">layout</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">gen_func</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">LAYOUT_MOVING_WINDOW</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: unsupported files layout %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">gen_func</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">extract_attr_from_ios</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: extract_attr of inode_data failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">layout</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">gen_func</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">LAYOUT_MOVING_WINDOW</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: unsupported meta-data layout %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">gen_func</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">ore_put_io_state</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__oi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">i_wq</span><span class="p">);</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Fill in an inode read from the OSD and set it up for use</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">exofs_iget</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ino</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_fcb</span> <span class="n">fcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">inode</span> <span class="o">=</span> <span class="n">iget_locked</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_state</span> <span class="o">&amp;</span> <span class="n">I_NEW</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>
	<span class="n">oi</span> <span class="o">=</span> <span class="n">exofs_i</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">__oi_init</span><span class="p">(</span><span class="n">oi</span><span class="p">);</span>
	<span class="n">exofs_init_comps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">one_comp</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">,</span>
			 <span class="n">exofs_oi_objno</span><span class="p">(</span><span class="n">oi</span><span class="p">));</span>

	<span class="cm">/* read the inode from the osd */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">exofs_get_inode</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">oi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad_inode</span><span class="p">;</span>

	<span class="n">set_obj_created</span><span class="p">(</span><span class="n">oi</span><span class="p">);</span>

	<span class="cm">/* copy stuff from on-disk struct to in-memory struct */</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_mode</span><span class="p">);</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_uid</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_uid</span><span class="p">);</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_gid</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_gid</span><span class="p">);</span>
	<span class="n">set_nlink</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_links_count</span><span class="p">));</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_ctime</span><span class="p">);</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_atime</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_atime</span><span class="p">);</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_mtime</span><span class="p">);</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">=</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_atime</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">i_commit_size</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_size</span><span class="p">);</span>
	<span class="n">i_size_write</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">i_commit_size</span><span class="p">);</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span> <span class="o">=</span> <span class="n">EXOFS_BLKSHIFT</span><span class="p">;</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_generation</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_generation</span><span class="p">);</span>

	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">i_dir_start_lookup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bad_inode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISCHR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">||</span> <span class="n">S_ISBLK</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rdev</span> <span class="o">=</span>
				<span class="n">old_decode_dev</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="k">else</span>
			<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rdev</span> <span class="o">=</span>
				<span class="n">new_decode_dev</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">,</span> <span class="n">fcb</span><span class="p">.</span><span class="n">i_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_data</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">exofs_file_inode_operations</span><span class="p">;</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_fop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">exofs_file_operations</span><span class="p">;</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">exofs_aops</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">exofs_dir_inode_operations</span><span class="p">;</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_fop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">exofs_dir_operations</span><span class="p">;</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">exofs_aops</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISLNK</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exofs_inode_is_fast_symlink</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
			<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">exofs_fast_symlink_inode_operations</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">exofs_symlink_inode_operations</span><span class="p">;</span>
			<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">exofs_aops</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">exofs_special_inode_operations</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">init_special_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">,</span>
			   <span class="n">old_decode_dev</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span>
		<span class="k">else</span>
			<span class="n">init_special_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">,</span>
			   <span class="n">new_decode_dev</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fcb</span><span class="p">.</span><span class="n">i_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])));</span>
	<span class="p">}</span>

	<span class="n">unlock_new_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>

<span class="nl">bad_inode:</span>
	<span class="n">iget_failed</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__exofs_wait_obj_created</span><span class="p">(</span><span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj_created</span><span class="p">(</span><span class="n">oi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;!obj_created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">obj_2bcreated</span><span class="p">(</span><span class="n">oi</span><span class="p">));</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">i_wq</span><span class="p">,</span> <span class="n">obj_created</span><span class="p">(</span><span class="n">oi</span><span class="p">));</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;wait_event done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">unlikely</span><span class="p">(</span><span class="n">is_bad_inode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Callback function from exofs_new_inode().  The important thing is that we</span>
<span class="cm"> * set the obj_created flag so that other methods know that the object exists on</span>
<span class="cm"> * the OSD.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">create_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">exofs_i</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_check_io</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ore_put_io_state</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_curr_pending</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;object=0x%llx creation failed in pid=0x%llx&quot;</span><span class="p">,</span>
			  <span class="n">_LLU</span><span class="p">(</span><span class="n">exofs_oi_objno</span><span class="p">(</span><span class="n">oi</span><span class="p">)),</span>
			  <span class="n">_LLU</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">one_comp</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">partition</span><span class="p">));</span>
		<span class="cm">/*TODO: When FS is corrupted creation can fail, object already</span>
<span class="cm">		 * exist. Get rid of this asynchronous creation, if exist</span>
<span class="cm">		 * increment the obj counter and try the next object. Until we</span>
<span class="cm">		 * succeed. All these dangling objects will be made into lost</span>
<span class="cm">		 * files by chkfs.exofs</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="n">set_obj_created</span><span class="p">(</span><span class="n">oi</span><span class="p">);</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">i_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up a new inode and create an object for it on the OSD</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">exofs_new_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">inode</span> <span class="o">=</span> <span class="n">new_inode</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">oi</span> <span class="o">=</span> <span class="n">exofs_i</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">__oi_init</span><span class="p">(</span><span class="n">oi</span><span class="p">);</span>

	<span class="n">set_obj_2bcreated</span><span class="p">(</span><span class="n">oi</span><span class="p">);</span>

	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdi</span><span class="p">;</span>
	<span class="n">inode_init_owner</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_nextid</span><span class="o">++</span><span class="p">;</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span> <span class="o">=</span> <span class="n">EXOFS_BLKSHIFT</span><span class="p">;</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_atime</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">i_commit_size</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_next_gen_lock</span><span class="p">);</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_generation</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_next_generation</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_next_gen_lock</span><span class="p">);</span>
	<span class="n">insert_inode_hash</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">exofs_init_comps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">one_comp</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">,</span>
			 <span class="n">exofs_oi_objno</span><span class="p">(</span><span class="n">oi</span><span class="p">));</span>
	<span class="n">exofs_sbi_write_stats</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span> <span class="cm">/* Make sure new sbi-&gt;s_nextid is on disk */</span>

	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_get_io_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;exofs_new_inode: ore_get_io_state failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">create_done</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">inode</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_create</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ore_put_io_state</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_curr_pending</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * struct to pass two arguments to update_inode&#39;s callback</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">updatei_args</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_sb_info</span>	<span class="o">*</span><span class="n">sbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_fcb</span>	<span class="n">fcb</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Callback function from exofs_update_inode().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">updatei_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">updatei_args</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">ore_put_io_state</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_curr_pending</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write the inode to the OSD.  Just fill up the struct, and set the attribute</span>
<span class="cm"> * synchronously or asynchronously depending on the do_sync flag.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">exofs_update_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_sync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">exofs_i</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_fcb</span> <span class="o">*</span><span class="n">fcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">updatei_args</span> <span class="o">*</span><span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">args</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;Failed kzalloc of args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">fcb</span><span class="p">;</span>

	<span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_mode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">);</span>
	<span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_uid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_uid</span><span class="p">);</span>
	<span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_gid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_gid</span><span class="p">);</span>
	<span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_links_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">);</span>
	<span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
	<span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_atime</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_atime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
	<span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">i_commit_size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">i_commit_size</span><span class="p">);</span>
	<span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_generation</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_generation</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISCHR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">||</span> <span class="n">S_ISBLK</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_valid_dev</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">old_encode_dev</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rdev</span><span class="p">));</span>
			<span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">new_encode_dev</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rdev</span><span class="p">));</span>
			<span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fcb</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_get_io_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: ore_get_io_state failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_args</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">attr</span> <span class="o">=</span> <span class="n">g_attr_inode_data</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">val_ptr</span> <span class="o">=</span> <span class="n">fcb</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">out_attr_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">out_attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">;</span>

	<span class="n">wait_obj_created</span><span class="p">(</span><span class="n">oi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_sync</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">sbi</span><span class="p">;</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">updatei_done</span><span class="p">;</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">args</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_write</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_sync</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_curr_pending</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* deallocation in updatei_done */</span>
	<span class="p">}</span>

	<span class="n">ore_put_io_state</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
<span class="nl">free_args:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">EXOFS_DBGMSG</span><span class="p">(</span><span class="s">&quot;(0x%lx) do_sync=%d ret=&gt;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">do_sync</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">exofs_write_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">writeback_control</span> <span class="o">*</span><span class="n">wbc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: fix fsync and use wbc-&gt;sync_mode == WB_SYNC_ALL */</span>
	<span class="k">return</span> <span class="n">exofs_update_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Callback function from exofs_delete_inode() - don&#39;t have much cleaning up to</span>
<span class="cm"> * do.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">delete_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">ore_put_io_state</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_curr_pending</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called when the refcount of an inode reaches zero.  We remove the object</span>
<span class="cm"> * from the OSD here.  We make sure the object was created before we try and</span>
<span class="cm"> * delete it.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">exofs_evict_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exofs_i_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">exofs_i</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">truncate_inode_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* TODO: should do better here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span> <span class="o">||</span> <span class="n">is_bad_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">no_delete</span><span class="p">;</span>

	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clear_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="cm">/* if we are deleting an obj that hasn&#39;t been created yet, wait.</span>
<span class="cm">	 * This also makes sure that create_done cannot be called with an</span>
<span class="cm">	 * already evicted inode.</span>
<span class="cm">	 */</span>
	<span class="n">wait_obj_created</span><span class="p">(</span><span class="n">oi</span><span class="p">);</span>
	<span class="cm">/* ignore the error, attempt a remove anyway */</span>

	<span class="cm">/* Now Remove the OSD objects */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_get_io_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: ore_get_io_state failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">delete_done</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">sbi</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_remove</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXOFS_ERR</span><span class="p">(</span><span class="s">&quot;%s: ore_remove failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ore_put_io_state</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_curr_pending</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">no_delete:</span>
	<span class="n">clear_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
