<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › exofs › ore.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ore.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2005, 2006</span>
<span class="cm"> * Avishay Traeger (avishay@gmail.com)</span>
<span class="cm"> * Copyright (C) 2008, 2009</span>
<span class="cm"> * Boaz Harrosh &lt;bharrosh@panasas.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is part of exofs.</span>
<span class="cm"> *</span>
<span class="cm"> * exofs is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation.  Since it is based on ext2, and the only</span>
<span class="cm"> * valid version of GPL for the Linux kernel is version 2, the only valid</span>
<span class="cm"> * version of GPL for exofs is version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * exofs is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with exofs; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>
<span class="cp">#include &lt;linux/lcm.h&gt;</span>

<span class="cp">#include &quot;ore_raid.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Boaz Harrosh &lt;bharrosh@panasas.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Objects Raid Engine ore.ko&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* ore_verify_layout does a couple of things:</span>
<span class="cm"> * 1. Given a minimum number of needed parameters fixes up the rest of the</span>
<span class="cm"> *    members to be operatonals for the ore. The needed parameters are those</span>
<span class="cm"> *    that are defined by the pnfs-objects layout STD.</span>
<span class="cm"> * 2. Check to see if the current ore code actually supports these parameters</span>
<span class="cm"> *    for example stripe_unit must be a multple of the system PAGE_SIZE,</span>
<span class="cm"> *    and etc...</span>
<span class="cm"> * 3. Cache some havily used calculations that will be needed by users.</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">BIO_MAX_PAGES_KMALLOC</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span><span class="p">))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio_vec</span><span class="p">),};</span>

<span class="kt">int</span> <span class="nf">ore_verify_layout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">total_comps</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ore_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">stripe_length</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">raid_algorithm</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PNFS_OSD_RAID_0</span>:
		<span class="n">layout</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNFS_OSD_RAID_5</span>:
		<span class="n">layout</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNFS_OSD_RAID_PQ</span>:
	<span class="k">case</span> <span class="n">PNFS_OSD_RAID_4</span>:
	<span class="nl">default:</span>
		<span class="n">ORE_ERR</span><span class="p">(</span><span class="s">&quot;Only RAID_0/5 for now</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">stripe_unit</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ORE_ERR</span><span class="p">(</span><span class="s">&quot;Stripe Unit(0x%llx)&quot;</span>
			  <span class="s">&quot; must be Multples of PAGE_SIZE(0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">_LLU</span><span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">stripe_unit</span><span class="p">),</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_depth</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ORE_ERR</span><span class="p">(</span><span class="s">&quot;group_depth == 0 &amp;&amp; group_width != 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total_comps</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span> <span class="o">*</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ORE_ERR</span><span class="p">(</span><span class="s">&quot;Data Map wrong, &quot;</span>
				<span class="s">&quot;numdevs=%d &lt; group_width=%d * mirrors=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">total_comps</span><span class="p">,</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span><span class="p">,</span>
				<span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_count</span> <span class="o">=</span> <span class="n">total_comps</span> <span class="o">/</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span> <span class="o">/</span>
						<span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_depth</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Warning: group_depth ignored &quot;</span>
				<span class="s">&quot;group_width == 0 &amp;&amp; group_depth == %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">_LLU</span><span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_depth</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span> <span class="o">=</span> <span class="n">total_comps</span> <span class="o">/</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span><span class="p">;</span>
		<span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_depth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stripe_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span> <span class="o">*</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">stripe_unit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stripe_length</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ORE_ERR</span><span class="p">(</span><span class="s">&quot;Stripe_length(0x%llx) &gt;= 32bit is not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">_LLU</span><span class="p">(</span><span class="n">stripe_length</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">layout</span><span class="o">-&gt;</span><span class="n">max_io_length</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">BIO_MAX_PAGES_KMALLOC</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">stripe_unit</span><span class="p">)</span> <span class="o">*</span>
							<span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">stripe_length</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span> <span class="o">-</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">layout</span><span class="o">-&gt;</span><span class="n">stripe_unit</span><span class="p">;</span>

		<span class="n">layout</span><span class="o">-&gt;</span><span class="n">max_io_length</span> <span class="o">/=</span> <span class="n">stripe_length</span><span class="p">;</span>
		<span class="n">layout</span><span class="o">-&gt;</span><span class="n">max_io_length</span> <span class="o">*=</span> <span class="n">stripe_length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ore_verify_layout</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span><span class="nf">_ios_cred</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">comps</span><span class="p">[</span><span class="n">index</span> <span class="o">&amp;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">single_comp</span><span class="p">].</span><span class="n">cred</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="nf">_ios_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">comps</span><span class="p">[</span><span class="n">index</span> <span class="o">&amp;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">single_comp</span><span class="p">].</span><span class="n">obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">osd_dev</span> <span class="o">*</span><span class="nf">_ios_od</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ORE_DBGMSG2</span><span class="p">(</span><span class="s">&quot;oc-&gt;first_dev=%d oc-&gt;numdevs=%d i=%d oc-&gt;ods=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">first_dev</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
		    <span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">ods</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ore_comp_dev</span><span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>  <span class="nf">_ore_get_io_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ore_components</span> <span class="o">*</span><span class="n">oc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">numdevs</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="n">sgs_per_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">num_par_pages</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">**</span><span class="n">pios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_sg_entry</span> <span class="o">*</span><span class="n">sgilist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__alloc_all_io_state</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="n">ios</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ore_per_dev_state</span> <span class="n">per_dev</span><span class="p">[</span><span class="n">numdevs</span><span class="p">];</span>
		<span class="k">union</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">osd_sg_entry</span> <span class="n">sglist</span><span class="p">[</span><span class="n">sgs_per_dev</span> <span class="o">*</span> <span class="n">numdevs</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pages</span><span class="p">[</span><span class="n">num_par_pages</span><span class="p">];</span>
		<span class="p">};</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">_aios</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_aios</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">PAGE_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_aios</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_aios</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">_aios</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ORE_DBGMSG</span><span class="p">(</span><span class="s">&quot;Failed kzalloc bytes=%zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_aios</span><span class="p">));</span>
			<span class="o">*</span><span class="n">pios</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pages</span> <span class="o">=</span> <span class="n">num_par_pages</span> <span class="o">?</span> <span class="n">_aios</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">sgilist</span> <span class="o">=</span> <span class="n">sgs_per_dev</span> <span class="o">?</span> <span class="n">_aios</span><span class="o">-&gt;</span><span class="n">sglist</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ios</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_aios</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">__alloc_small_io_state</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="n">ios</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ore_per_dev_state</span> <span class="n">per_dev</span><span class="p">[</span><span class="n">numdevs</span><span class="p">];</span>
		<span class="p">}</span> <span class="o">*</span><span class="n">_aio_small</span><span class="p">;</span>
		<span class="k">union</span> <span class="n">__extra_part</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">osd_sg_entry</span> <span class="n">sglist</span><span class="p">[</span><span class="n">sgs_per_dev</span> <span class="o">*</span> <span class="n">numdevs</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pages</span><span class="p">[</span><span class="n">num_par_pages</span><span class="p">];</span>
		<span class="p">}</span> <span class="o">*</span><span class="n">extra_part</span><span class="p">;</span>

		<span class="n">_aio_small</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_aio_small</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">_aio_small</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ORE_DBGMSG</span><span class="p">(</span><span class="s">&quot;Failed alloc first part bytes=%zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_aio_small</span><span class="p">));</span>
			<span class="o">*</span><span class="n">pios</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">extra_part</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">extra_part</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">extra_part</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ORE_DBGMSG</span><span class="p">(</span><span class="s">&quot;Failed alloc second part bytes=%zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">extra_part</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">_aio_small</span><span class="p">);</span>
			<span class="o">*</span><span class="n">pios</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pages</span> <span class="o">=</span> <span class="n">num_par_pages</span> <span class="o">?</span> <span class="n">extra_part</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">sgilist</span> <span class="o">=</span> <span class="n">sgs_per_dev</span> <span class="o">?</span> <span class="n">extra_part</span><span class="o">-&gt;</span><span class="n">sglist</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/* In this case the per_dev[0].sgilist holds the pointer to</span>
<span class="cm">		 * be freed</span>
<span class="cm">		 */</span>
		<span class="n">ios</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_aio_small</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">;</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">extra_part_alloc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">parity_pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">max_par_pages</span> <span class="o">=</span> <span class="n">num_par_pages</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sgilist</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">d</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">numdevs</span><span class="p">;</span> <span class="o">++</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">sglist</span> <span class="o">=</span> <span class="n">sgilist</span><span class="p">;</span>
			<span class="n">sgilist</span> <span class="o">+=</span> <span class="n">sgs_per_dev</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">sgs_per_dev</span> <span class="o">=</span> <span class="n">sgs_per_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">=</span> <span class="n">layout</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span> <span class="o">=</span> <span class="n">oc</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pios</span> <span class="o">=</span> <span class="n">ios</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Allocate an io_state for only a single group of devices</span>
<span class="cm"> *</span>
<span class="cm"> * If a user needs to call ore_read/write() this version must be used becase it</span>
<span class="cm"> * allocates extra stuff for striping and raid.</span>
<span class="cm"> * The ore might decide to only IO less then @length bytes do to alignmets</span>
<span class="cm"> * and constrains as follows:</span>
<span class="cm"> * - The IO cannot cross group boundary.</span>
<span class="cm"> * - In raid5/6 The end of the IO must align at end of a stripe eg.</span>
<span class="cm"> *   (@offset + @length) % strip_size == 0. Or the complete range is within a</span>
<span class="cm"> *   single stripe.</span>
<span class="cm"> * - Memory condition only permitted a shorter IO. (A user can use @length=~0</span>
<span class="cm"> *   And check the returned ios-&gt;length for max_io_size.)</span>
<span class="cm"> *</span>
<span class="cm"> * The caller must check returned ios-&gt;length (and/or ios-&gt;nr_pages) and</span>
<span class="cm"> * re-issue these pages that fall outside of ios-&gt;length</span>
<span class="cm"> */</span>
<span class="kt">int</span>  <span class="nf">ore_get_rw_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ore_components</span> <span class="o">*</span><span class="n">oc</span><span class="p">,</span>
		      <span class="n">bool</span> <span class="n">is_reading</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u64</span> <span class="n">length</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">**</span><span class="n">pios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">numdevs</span> <span class="o">=</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span> <span class="o">*</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">sgs_per_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_par_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">&amp;&amp;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">data_devs</span> <span class="o">=</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span> <span class="o">-</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">stripe_size</span> <span class="o">=</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">stripe_unit</span> <span class="o">*</span> <span class="n">data_devs</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">pages_in_unit</span> <span class="o">=</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">stripe_unit</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">remainder</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">num_stripes</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">num_raid_units</span><span class="p">;</span>

		<span class="n">num_stripes</span> <span class="o">=</span> <span class="n">div_u64_rem</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">stripe_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remainder</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">remainder</span><span class="p">)</span>
			<span class="o">++</span><span class="n">num_stripes</span><span class="p">;</span>

		<span class="n">num_raid_units</span> <span class="o">=</span>  <span class="n">num_stripes</span> <span class="o">*</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_reading</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* For reads add per_dev sglist array */</span>
			<span class="cm">/* TODO: Raid 6 we need twice more. Actually:</span>
<span class="cm">			*         num_stripes / LCMdP(W,P);</span>
<span class="cm">			*         if (W%P != 0) num_stripes *= parity;</span>
<span class="cm">			*/</span>

			<span class="cm">/* first/last seg is split */</span>
			<span class="n">num_raid_units</span> <span class="o">+=</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span><span class="p">;</span>
			<span class="n">sgs_per_dev</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">num_raid_units</span><span class="p">,</span> <span class="n">data_devs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* For Writes add parity pages array. */</span>
			<span class="n">max_par_pages</span> <span class="o">=</span> <span class="n">num_raid_units</span> <span class="o">*</span> <span class="n">pages_in_unit</span> <span class="o">*</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_ore_get_io_state</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">oc</span><span class="p">,</span> <span class="n">numdevs</span><span class="p">,</span> <span class="n">sgs_per_dev</span><span class="p">,</span> <span class="n">max_par_pages</span><span class="p">,</span>
				<span class="n">pios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ios</span> <span class="o">=</span> <span class="o">*</span><span class="n">pios</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">reading</span> <span class="o">=</span> <span class="n">is_reading</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ore_calc_stripe_info</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">);</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">)</span>
			<span class="n">_ore_post_alloc_raid_stuff</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ore_get_rw_state</span><span class="p">);</span>

<span class="cm">/* Allocate an io_state for all the devices in the comps array</span>
<span class="cm"> *</span>
<span class="cm"> * This version of io_state allocation is used mostly by create/remove</span>
<span class="cm"> * and trunc where we currently need all the devices. The only wastful</span>
<span class="cm"> * bit is the read/write_attributes with no IO. Those sites should</span>
<span class="cm"> * be converted to use ore_get_rw_state() with length=0</span>
<span class="cm"> */</span>
<span class="kt">int</span>  <span class="nf">ore_get_io_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ore_components</span> <span class="o">*</span><span class="n">oc</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">**</span><span class="n">pios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_ore_get_io_state</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">oc</span><span class="p">,</span> <span class="n">oc</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pios</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ore_get_io_state</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ore_put_io_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ore_per_dev_state</span> <span class="o">*</span><span class="n">per_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">or</span><span class="p">)</span>
				<span class="n">osd_end_request</span><span class="p">(</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">or</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">)</span>
				<span class="n">bio_put</span><span class="p">(</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">_ore_free_raid_stuff</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ore_put_io_state</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_sync_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">waiting</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="n">waiting</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_last_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span>
					<span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ore_io_state</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>

	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_done_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">_last_io</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ore_io_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">sync</span> <span class="o">=</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">_sync_done</span><span class="p">;</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">or</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">osd_finalize_request</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_ios_cred</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ORE_DBGMSG</span><span class="p">(</span><span class="s">&quot;Failed to osd_finalize_request() =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">or</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
		<span class="n">osd_execute_request_async</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">_done_io</span><span class="p">,</span> <span class="n">ios</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">_last_io</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_check_io</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_clear_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">__bio_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">this_count</span> <span class="o">=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">==</span> <span class="n">this_count</span><span class="p">))</span>
			<span class="n">clear_highpage</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">zero_user</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">,</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">,</span> <span class="n">this_count</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ore_check_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="n">ore_on_dev_error</span> <span class="n">on_dev_error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">osd_err_priority</span> <span class="n">acumulated_osd_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">acumulated_lin_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osd_sense_info</span> <span class="n">osi</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ore_per_dev_state</span> <span class="o">*</span><span class="n">per_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span> <span class="o">=</span> <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">or</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">osd_req_decode_sense</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">OSD_ERR_PRI_CLEAR_PAGES</span> <span class="o">==</span> <span class="n">osi</span><span class="p">.</span><span class="n">osd_err_pri</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* start read offset passed endof file */</span>
			<span class="n">_clear_bio</span><span class="p">(</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">);</span>
			<span class="n">ORE_DBGMSG</span><span class="p">(</span><span class="s">&quot;start read offset passed end of file &quot;</span>
				<span class="s">&quot;offset=0x%llx, length=0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">_LLU</span><span class="p">(</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span>
				<span class="n">_LLU</span><span class="p">(</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>

			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* we recovered */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">on_dev_error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">residual</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">reading</span> <span class="o">?</span>
					<span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">residual</span> <span class="o">:</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">residual</span><span class="p">;</span>
			<span class="n">u64</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">-</span> <span class="n">residual</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">-</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">first_dev</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ore_dev</span> <span class="o">*</span><span class="n">od</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">ods</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>

			<span class="n">on_dev_error</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">od</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">osi</span><span class="p">.</span><span class="n">osd_err_pri</span><span class="p">,</span>
				     <span class="n">offset</span><span class="p">,</span> <span class="n">residual</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osi</span><span class="p">.</span><span class="n">osd_err_pri</span> <span class="o">&gt;=</span> <span class="n">acumulated_osd_err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">acumulated_osd_err</span> <span class="o">=</span> <span class="n">osi</span><span class="p">.</span><span class="n">osd_err_pri</span><span class="p">;</span>
			<span class="n">acumulated_lin_err</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">acumulated_lin_err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ore_check_io</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * L - logical offset into the file</span>
<span class="cm"> *</span>
<span class="cm"> * D - number of Data devices</span>
<span class="cm"> *	D = group_width - parity</span>
<span class="cm"> *</span>
<span class="cm"> * U - The number of bytes in a stripe within a group</span>
<span class="cm"> *	U =  stripe_unit * D</span>
<span class="cm"> *</span>
<span class="cm"> * T - The number of bytes striped within a group of component objects</span>
<span class="cm"> *     (before advancing to the next group)</span>
<span class="cm"> *	T = U * group_depth</span>
<span class="cm"> *</span>
<span class="cm"> * S - The number of bytes striped across all component objects</span>
<span class="cm"> *     before the pattern repeats</span>
<span class="cm"> *	S = T * group_count</span>
<span class="cm"> *</span>
<span class="cm"> * M - The &quot;major&quot; (i.e., across all components) cycle number</span>
<span class="cm"> *	M = L / S</span>
<span class="cm"> *</span>
<span class="cm"> * G - Counts the groups from the beginning of the major cycle</span>
<span class="cm"> *	G = (L - (M * S)) / T	[or (L % S) / T]</span>
<span class="cm"> *</span>
<span class="cm"> * H - The byte offset within the group</span>
<span class="cm"> *	H = (L - (M * S)) % T	[or (L % S) % T]</span>
<span class="cm"> *</span>
<span class="cm"> * N - The &quot;minor&quot; (i.e., across the group) stripe number</span>
<span class="cm"> *	N = H / U</span>
<span class="cm"> *</span>
<span class="cm"> * C - The component index coresponding to L</span>
<span class="cm"> *</span>
<span class="cm"> *	C = (H - (N * U)) / stripe_unit + G * D</span>
<span class="cm"> *	[or (L % U) / stripe_unit + G * D]</span>
<span class="cm"> *</span>
<span class="cm"> * O - The component offset coresponding to L</span>
<span class="cm"> *	O = L % stripe_unit + N * stripe_unit + M * group_depth * stripe_unit</span>
<span class="cm"> *</span>
<span class="cm"> * LCMdP – Parity cycle: Lowest Common Multiple of group_width, parity</span>
<span class="cm"> *          divide by parity</span>
<span class="cm"> *	LCMdP = lcm(group_width, parity) / parity</span>
<span class="cm"> *</span>
<span class="cm"> * R - The parity Rotation stripe</span>
<span class="cm"> *     (Note parity cycle always starts at a group&#39;s boundary)</span>
<span class="cm"> *	R = N % LCMdP</span>
<span class="cm"> *</span>
<span class="cm"> * I = the first parity device index</span>
<span class="cm"> *	I = (group_width + group_width - R*parity - parity) % group_width</span>
<span class="cm"> *</span>
<span class="cm"> * Craid - The component index Rotated</span>
<span class="cm"> *	Craid = (group_width + C - R*parity) % group_width</span>
<span class="cm"> *      (We add the group_width to avoid negative numbers modulo math)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ore_calc_stripe_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">,</span> <span class="n">u64</span> <span class="n">file_offset</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">length</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ore_striping_info</span> <span class="o">*</span><span class="n">si</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">stripe_unit</span> <span class="o">=</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">stripe_unit</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">group_width</span> <span class="o">=</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">group_depth</span> <span class="o">=</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_depth</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">parity</span>      <span class="o">=</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">;</span>

	<span class="n">u32</span>	<span class="n">D</span> <span class="o">=</span> <span class="n">group_width</span> <span class="o">-</span> <span class="n">parity</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">U</span> <span class="o">=</span> <span class="n">D</span> <span class="o">*</span> <span class="n">stripe_unit</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">T</span> <span class="o">=</span> <span class="n">U</span> <span class="o">*</span> <span class="n">group_depth</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">S</span> <span class="o">=</span> <span class="n">T</span> <span class="o">*</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_count</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">M</span> <span class="o">=</span> <span class="n">div64_u64</span><span class="p">(</span><span class="n">file_offset</span><span class="p">,</span> <span class="n">S</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	G = (L - (M * S)) / T</span>
<span class="cm">	H = (L - (M * S)) % T</span>
<span class="cm">	*/</span>
	<span class="n">u64</span>	<span class="n">LmodS</span> <span class="o">=</span> <span class="n">file_offset</span> <span class="o">-</span> <span class="n">M</span> <span class="o">*</span> <span class="n">S</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">G</span> <span class="o">=</span> <span class="n">div64_u64</span><span class="p">(</span><span class="n">LmodS</span><span class="p">,</span> <span class="n">T</span><span class="p">);</span>
	<span class="n">u64</span>	<span class="n">H</span> <span class="o">=</span> <span class="n">LmodS</span> <span class="o">-</span> <span class="n">G</span> <span class="o">*</span> <span class="n">T</span><span class="p">;</span>

	<span class="n">u32</span>	<span class="n">N</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">U</span><span class="p">);</span>

	<span class="cm">/* &quot;H - (N * U)&quot; is just &quot;H % U&quot; so it&#39;s bound to u32 */</span>
	<span class="n">u32</span>	<span class="n">C</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">H</span> <span class="o">-</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">U</span><span class="p">))</span> <span class="o">/</span> <span class="n">stripe_unit</span> <span class="o">+</span> <span class="n">G</span> <span class="o">*</span> <span class="n">group_width</span><span class="p">;</span>

	<span class="n">div_u64_rem</span><span class="p">(</span><span class="n">file_offset</span><span class="p">,</span> <span class="n">stripe_unit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">unit_off</span><span class="p">);</span>

	<span class="n">si</span><span class="o">-&gt;</span><span class="n">obj_offset</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">unit_off</span> <span class="o">+</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">stripe_unit</span><span class="p">)</span> <span class="o">+</span>
				  <span class="p">(</span><span class="n">M</span> <span class="o">*</span> <span class="n">group_depth</span> <span class="o">*</span> <span class="n">stripe_unit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parity</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">LCMdP</span> <span class="o">=</span> <span class="n">lcm</span><span class="p">(</span><span class="n">group_width</span><span class="p">,</span> <span class="n">parity</span><span class="p">)</span> <span class="o">/</span> <span class="n">parity</span><span class="p">;</span>
		<span class="cm">/* R     = N % LCMdP; */</span>
		<span class="n">u32</span> <span class="n">RxP</span>   <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">%</span> <span class="n">LCMdP</span><span class="p">)</span> <span class="o">*</span> <span class="n">parity</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">first_dev</span> <span class="o">=</span> <span class="n">C</span> <span class="o">-</span> <span class="n">C</span> <span class="o">%</span> <span class="n">group_width</span><span class="p">;</span>

		<span class="n">si</span><span class="o">-&gt;</span><span class="n">par_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">group_width</span> <span class="o">+</span> <span class="n">group_width</span> <span class="o">-</span> <span class="n">parity</span> <span class="o">-</span> <span class="n">RxP</span><span class="p">)</span> <span class="o">%</span>
			      <span class="n">group_width</span> <span class="o">+</span> <span class="n">first_dev</span><span class="p">;</span>
		<span class="n">si</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">group_width</span> <span class="o">+</span> <span class="n">C</span> <span class="o">-</span> <span class="n">RxP</span><span class="p">)</span> <span class="o">%</span> <span class="n">group_width</span> <span class="o">+</span> <span class="n">first_dev</span><span class="p">;</span>
		<span class="n">si</span><span class="o">-&gt;</span><span class="n">bytes_in_stripe</span> <span class="o">=</span> <span class="n">U</span><span class="p">;</span>
		<span class="n">si</span><span class="o">-&gt;</span><span class="n">first_stripe_start</span> <span class="o">=</span> <span class="n">M</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="n">G</span> <span class="o">*</span> <span class="n">T</span> <span class="o">+</span> <span class="n">N</span> <span class="o">*</span> <span class="n">U</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Make the math correct see _prepare_one_group */</span>
		<span class="n">si</span><span class="o">-&gt;</span><span class="n">par_dev</span> <span class="o">=</span> <span class="n">group_width</span><span class="p">;</span>
		<span class="n">si</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">C</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">si</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">*=</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span><span class="p">;</span>
	<span class="n">si</span><span class="o">-&gt;</span><span class="n">par_dev</span> <span class="o">*=</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span><span class="p">;</span>
	<span class="n">si</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">file_offset</span><span class="p">;</span>
	<span class="n">si</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">T</span> <span class="o">-</span> <span class="n">H</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">)</span>
		<span class="n">si</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">si</span><span class="o">-&gt;</span><span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ore_calc_stripe_info</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">_ore_add_stripe_unit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span>  <span class="kt">unsigned</span> <span class="o">*</span><span class="n">cur_pg</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="n">pgbase</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ore_per_dev_state</span> <span class="o">*</span><span class="n">per_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cur_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">pg</span> <span class="o">=</span> <span class="o">*</span><span class="n">cur_pg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span>
			<span class="n">osd_request_queue</span><span class="p">(</span><span class="n">_ios_od</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="n">len</span> <span class="o">=</span> <span class="n">cur_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">bio</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">pages_in_stripe</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span> <span class="o">*</span>
					<span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">stripe_unit</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="n">nr_pages</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">*</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span> <span class="o">/</span>
					<span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span> <span class="o">-</span>
					 <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="n">bio_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">nr_pages</span> <span class="o">+</span> <span class="n">pages_in_stripe</span><span class="p">)</span> <span class="o">/</span>
					<span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span><span class="p">;</span>

		<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio_kmalloc</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">bio_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ORE_DBGMSG</span><span class="p">(</span><span class="s">&quot;Failed to allocate BIO size=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">bio_size</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cur_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">pglen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">pgbase</span><span class="p">,</span> <span class="n">cur_len</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="n">added_len</span><span class="p">;</span>

		<span class="n">cur_len</span> <span class="o">-=</span> <span class="n">pglen</span><span class="p">;</span>

		<span class="n">added_len</span> <span class="o">=</span> <span class="n">bio_add_pc_page</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">,</span> <span class="n">pages</span><span class="p">[</span><span class="n">pg</span><span class="p">],</span>
					    <span class="n">pglen</span><span class="p">,</span> <span class="n">pgbase</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pglen</span> <span class="o">!=</span> <span class="n">added_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ORE_DBGMSG</span><span class="p">(</span><span class="s">&quot;Failed bio_add_pc_page bi_vcnt=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">_add_stripe_page</span><span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">sp2d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">,</span> <span class="n">pages</span><span class="p">[</span><span class="n">pg</span><span class="p">]);</span>

		<span class="n">pgbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">++</span><span class="n">pg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">cur_len</span><span class="p">);</span>

	<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cur_pg</span> <span class="o">=</span> <span class="n">pg</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>	<span class="cm">/* we fail the complete unit on an error eg don&#39;t advance</span>
<span class="cm">	 * per_dev-&gt;length and cur_pg. This means that we might have a bigger</span>
<span class="cm">	 * bio than the CDB requested length (per_dev-&gt;length). That&#39;s fine</span>
<span class="cm">	 * only the oposite is fatal.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_prepare_for_striping</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ore_striping_info</span> <span class="o">*</span><span class="n">si</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">stripe_unit</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">stripe_unit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">mirrors_p1</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">group_width</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">devs_in_group</span> <span class="o">=</span> <span class="n">group_width</span> <span class="o">*</span> <span class="n">mirrors_p1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">first_dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">-</span> <span class="p">(</span><span class="n">dev</span> <span class="o">%</span> <span class="n">devs_in_group</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">dev_order</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cur_pg</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">pages_consumed</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">length</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">numdevs</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="n">dev_order</span> <span class="o">=</span> <span class="n">_dev_order</span><span class="p">(</span><span class="n">devs_in_group</span><span class="p">,</span> <span class="n">mirrors_p1</span><span class="p">,</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">par_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">si</span><span class="o">-&gt;</span><span class="n">cur_comp</span> <span class="o">=</span> <span class="n">dev_order</span><span class="p">;</span>
	<span class="n">si</span><span class="o">-&gt;</span><span class="n">cur_pg</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">unit_off</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">comp</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">-</span> <span class="n">first_dev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ore_per_dev_state</span> <span class="o">*</span><span class="n">per_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="n">comp</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="n">cur_len</span><span class="p">,</span> <span class="n">page_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN_ON</span><span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">par_dev</span><span class="p">);</span>
				<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">obj_offset</span><span class="p">;</span>
				<span class="n">cur_len</span> <span class="o">=</span> <span class="n">stripe_unit</span> <span class="o">-</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">unit_off</span><span class="p">;</span>
				<span class="n">page_off</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">unit_off</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="n">page_off</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">page_off</span> <span class="o">!=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">pgbase</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">cur_comp</span> <span class="o">&gt;</span> <span class="n">dev_order</span><span class="p">)</span>
					<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span>
						<span class="n">si</span><span class="o">-&gt;</span><span class="n">obj_offset</span> <span class="o">-</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">unit_off</span><span class="p">;</span>
				<span class="k">else</span> <span class="cm">/* si-&gt;cur_comp &lt; dev_order */</span>
					<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span>
						<span class="n">si</span><span class="o">-&gt;</span><span class="n">obj_offset</span> <span class="o">+</span> <span class="n">stripe_unit</span> <span class="o">-</span>
								   <span class="n">si</span><span class="o">-&gt;</span><span class="n">unit_off</span><span class="p">;</span>
				<span class="n">cur_len</span> <span class="o">=</span> <span class="n">stripe_unit</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cur_len</span> <span class="o">=</span> <span class="n">stripe_unit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_len</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="p">)</span>
			<span class="n">cur_len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">_ore_add_stripe_unit</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_pg</span><span class="p">,</span> <span class="n">page_off</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span>
					   <span class="n">per_dev</span><span class="p">,</span> <span class="n">cur_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">dev</span> <span class="o">+=</span> <span class="n">mirrors_p1</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span> <span class="o">%</span> <span class="n">devs_in_group</span><span class="p">)</span> <span class="o">+</span> <span class="n">first_dev</span><span class="p">;</span>

		<span class="n">length</span> <span class="o">-=</span> <span class="n">cur_len</span><span class="p">;</span>

		<span class="n">si</span><span class="o">-&gt;</span><span class="n">cur_comp</span> <span class="o">=</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">cur_comp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">group_width</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">dev</span> <span class="o">==</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">par_dev</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">sp2d</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">sp2d</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* If we are writing and this is the very last</span>
<span class="cm">				 * stripe. then operate on parity dev.</span>
<span class="cm">				 */</span>
				<span class="n">dev</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">par_dev</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">sp2d</span><span class="p">)</span>
				<span class="cm">/* In writes cur_len just means if it&#39;s the</span>
<span class="cm">				 * last one. See _ore_add_parity_unit.</span>
<span class="cm">				 */</span>
				<span class="n">cur_len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">per_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="n">dev</span> <span class="o">-</span> <span class="n">first_dev</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Only/always the parity unit of the first</span>
<span class="cm">				 * stripe will be empty. So this is a chance to</span>
<span class="cm">				 * initialize the per_dev info.</span>
<span class="cm">				 */</span>
				<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
				<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">obj_offset</span> <span class="o">-</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">unit_off</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">_ore_add_parity_unit</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">per_dev</span><span class="p">,</span> <span class="n">cur_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="cm">/* Rotate next par_dev backwards with wraping */</span>
			<span class="n">si</span><span class="o">-&gt;</span><span class="n">par_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">devs_in_group</span> <span class="o">+</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">par_dev</span> <span class="o">-</span>
				       <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">*</span> <span class="n">mirrors_p1</span><span class="p">)</span> <span class="o">%</span>
				      <span class="n">devs_in_group</span> <span class="o">+</span> <span class="n">first_dev</span><span class="p">;</span>
			<span class="cm">/* Next stripe, start fresh */</span>
			<span class="n">si</span><span class="o">-&gt;</span><span class="n">cur_comp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">si</span><span class="o">-&gt;</span><span class="n">cur_pg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">numdevs</span> <span class="o">=</span> <span class="n">devs_in_group</span><span class="p">;</span>
	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">pages_consumed</span> <span class="o">=</span> <span class="n">cur_pg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-=</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ore_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">;</span>

		<span class="n">or</span> <span class="o">=</span> <span class="n">osd_start_request</span><span class="p">(</span><span class="n">_ios_od</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ORE_ERR</span><span class="p">(</span><span class="s">&quot;%s: osd_start_request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">or</span> <span class="o">=</span> <span class="n">or</span><span class="p">;</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="o">++</span><span class="p">;</span>

		<span class="n">osd_req_create_object</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">_ios_obj</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_io_execute</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ore_create</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ore_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">;</span>

		<span class="n">or</span> <span class="o">=</span> <span class="n">osd_start_request</span><span class="p">(</span><span class="n">_ios_od</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ORE_ERR</span><span class="p">(</span><span class="s">&quot;%s: osd_start_request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">or</span> <span class="o">=</span> <span class="n">or</span><span class="p">;</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="o">++</span><span class="p">;</span>

		<span class="n">osd_req_remove_object</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">_ios_obj</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_io_execute</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ore_remove</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_write_mirror</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cur_comp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ore_per_dev_state</span> <span class="o">*</span><span class="n">master_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="n">cur_comp</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="n">cur_comp</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">last_comp</span> <span class="o">=</span> <span class="n">cur_comp</span> <span class="o">+</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">master_dev</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Just an empty slot */</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">cur_comp</span> <span class="o">&lt;</span> <span class="n">last_comp</span><span class="p">;</span> <span class="o">++</span><span class="n">cur_comp</span><span class="p">,</span> <span class="o">++</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ore_per_dev_state</span> <span class="o">*</span><span class="n">per_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="n">cur_comp</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">;</span>

		<span class="n">or</span> <span class="o">=</span> <span class="n">osd_start_request</span><span class="p">(</span><span class="n">_ios_od</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ORE_ERR</span><span class="p">(</span><span class="s">&quot;%s: osd_start_request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">or</span> <span class="o">=</span> <span class="n">or</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">per_dev</span> <span class="o">!=</span> <span class="n">master_dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_kmalloc</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span>
						  <span class="n">master_dev</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_max_vecs</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ORE_DBGMSG</span><span class="p">(</span>
					      <span class="s">&quot;Failed to allocate BIO size=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">master_dev</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_max_vecs</span><span class="p">);</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">__bio_clone</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">master_dev</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">);</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">master_dev</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
				<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">master_dev</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
				<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">bio</span> <span class="o">=</span>  <span class="n">bio</span><span class="p">;</span>
				<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bio</span> <span class="o">=</span> <span class="n">master_dev</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">;</span>
				<span class="cm">/* FIXME: bio_set_dir() */</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">|=</span> <span class="n">REQ_WRITE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">osd_req_write</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">_ios_obj</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">dev</span><span class="p">),</span> <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
				      <span class="n">bio</span><span class="p">,</span> <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">ORE_DBGMSG</span><span class="p">(</span><span class="s">&quot;write(0x%llx) offset=0x%llx &quot;</span>
				      <span class="s">&quot;length=0x%llx dev=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">_LLU</span><span class="p">(</span><span class="n">_ios_obj</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">),</span>
				     <span class="n">_LLU</span><span class="p">(</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span>
				     <span class="n">_LLU</span><span class="p">(</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">),</span> <span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">kern_buff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">obj_offset</span><span class="p">;</span>
			<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">dev</span> <span class="o">+</span> <span class="n">dev</span><span class="p">;</span>

			<span class="cm">/* no cross device without page array */</span>
			<span class="n">BUG_ON</span><span class="p">((</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">unit_off</span> <span class="o">+</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span>
				<span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">stripe_unit</span><span class="p">));</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">osd_req_write_kern</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">_ios_obj</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
						 <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
						 <span class="n">ios</span><span class="o">-&gt;</span><span class="n">kern_buff</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">ORE_DBGMSG2</span><span class="p">(</span><span class="s">&quot;write_kern(0x%llx) offset=0x%llx &quot;</span>
				      <span class="s">&quot;length=0x%llx dev=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">_LLU</span><span class="p">(</span><span class="n">_ios_obj</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">),</span>
				     <span class="n">_LLU</span><span class="p">(</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span>
				     <span class="n">_LLU</span><span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">),</span> <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">osd_req_set_attributes</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">_ios_obj</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">dev</span><span class="p">));</span>
			<span class="n">ORE_DBGMSG2</span><span class="p">(</span><span class="s">&quot;obj(0x%llx) set_attributes=%d dev=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">_LLU</span><span class="p">(</span><span class="n">_ios_obj</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">),</span>
				     <span class="n">ios</span><span class="o">-&gt;</span><span class="n">out_attr_len</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">out_attr</span><span class="p">)</span>
			<span class="n">osd_req_add_set_attr_list</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">out_attr</span><span class="p">,</span>
						  <span class="n">ios</span><span class="o">-&gt;</span><span class="n">out_attr_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">in_attr</span><span class="p">)</span>
			<span class="n">osd_req_add_get_attr_list</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">in_attr</span><span class="p">,</span>
						  <span class="n">ios</span><span class="o">-&gt;</span><span class="n">in_attr_len</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ore_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">sp2d</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">r4w</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* A library is attempting a RAID-write without providing</span>
<span class="cm">		 * a pages lock interface.</span>
<span class="cm">		 */</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_prepare_for_striping</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_write_mirror</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_io_execute</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ore_write</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">_ore_read_mirror</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cur_comp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ore_per_dev_state</span> <span class="o">*</span><span class="n">per_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="n">cur_comp</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">_ios_obj</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">cur_comp</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">first_dev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Just an empty slot */</span>

	<span class="n">first_dev</span> <span class="o">=</span> <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">+</span> <span class="n">first_dev</span> <span class="o">%</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span><span class="p">;</span>
	<span class="n">or</span> <span class="o">=</span> <span class="n">osd_start_request</span><span class="p">(</span><span class="n">_ios_od</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">first_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ORE_ERR</span><span class="p">(</span><span class="s">&quot;%s: osd_start_request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">or</span> <span class="o">=</span> <span class="n">or</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* finalize the last sg_entry */</span>
			<span class="n">_ore_add_sg_seg</span><span class="p">(</span><span class="n">per_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Skip parity only device */</span>

			<span class="n">osd_req_read_sg</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">,</span>
					<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span> <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The no raid case */</span>
			<span class="n">osd_req_read</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
				     <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">,</span> <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ORE_DBGMSG</span><span class="p">(</span><span class="s">&quot;read(0x%llx) offset=0x%llx length=0x%llx&quot;</span>
			     <span class="s">&quot; dev=%d sg_len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">),</span>
			     <span class="n">_LLU</span><span class="p">(</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">),</span>
			     <span class="n">first_dev</span><span class="p">,</span> <span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">kern_buff</span><span class="p">);</span>

		<span class="n">osd_req_get_attributes</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="n">ORE_DBGMSG2</span><span class="p">(</span><span class="s">&quot;obj(0x%llx) get_attributes=%d dev=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">_LLU</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">),</span>
			      <span class="n">ios</span><span class="o">-&gt;</span><span class="n">in_attr_len</span><span class="p">,</span> <span class="n">first_dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">out_attr</span><span class="p">)</span>
		<span class="n">osd_req_add_set_attr_list</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">out_attr</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">out_attr_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">in_attr</span><span class="p">)</span>
		<span class="n">osd_req_add_get_attr_list</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">in_attr</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">in_attr_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ore_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_prepare_for_striping</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_ore_read_mirror</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_io_execute</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ore_read</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">extract_attr_from_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osd_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_attr</span> <span class="n">cur_attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">attr_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">};</span> <span class="cm">/* start with zeros */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">iter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nelem</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">nelem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">osd_req_decode_get_attr_list</span><span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">or</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">cur_attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nelem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cur_attr</span><span class="p">.</span><span class="n">attr_page</span> <span class="o">==</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_page</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cur_attr</span><span class="p">.</span><span class="n">attr_id</span> <span class="o">==</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_id</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cur_attr</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">val_ptr</span> <span class="o">=</span> <span class="n">cur_attr</span><span class="p">.</span><span class="n">val_ptr</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">iter</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">extract_attr_from_ios</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_truncate_mirrors</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cur_comp</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">osd_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">last_comp</span> <span class="o">=</span> <span class="n">cur_comp</span> <span class="o">+</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">cur_comp</span> <span class="o">&lt;</span> <span class="n">last_comp</span><span class="p">;</span> <span class="o">++</span><span class="n">cur_comp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ore_per_dev_state</span> <span class="o">*</span><span class="n">per_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">per_dev</span><span class="p">[</span><span class="n">cur_comp</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">;</span>

		<span class="n">or</span> <span class="o">=</span> <span class="n">osd_start_request</span><span class="p">(</span><span class="n">_ios_od</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">cur_comp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ORE_ERR</span><span class="p">(</span><span class="s">&quot;%s: osd_start_request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">per_dev</span><span class="o">-&gt;</span><span class="n">or</span> <span class="o">=</span> <span class="n">or</span><span class="p">;</span>

		<span class="n">osd_req_set_attributes</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">_ios_obj</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">cur_comp</span><span class="p">));</span>
		<span class="n">osd_req_add_set_attr_list</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">_trunc_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ore_striping_info</span> <span class="n">si</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">prev_group_obj_off</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">next_group_obj_off</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="n">first_group_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">nex_group_dev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_calc_trunk_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">,</span> <span class="n">u64</span> <span class="n">file_offset</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">_trunc_info</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">stripe_unit</span> <span class="o">=</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">stripe_unit</span><span class="p">;</span>

	<span class="n">ore_calc_stripe_info</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">);</span>

	<span class="n">ti</span><span class="o">-&gt;</span><span class="n">prev_group_obj_off</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">M</span> <span class="o">*</span> <span class="n">stripe_unit</span><span class="p">;</span>
	<span class="n">ti</span><span class="o">-&gt;</span><span class="n">next_group_obj_off</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">M</span> <span class="o">?</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">stripe_unit</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ti</span><span class="o">-&gt;</span><span class="n">first_group_dev</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">dev</span> <span class="o">-</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">dev</span> <span class="o">%</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span><span class="p">);</span>
	<span class="n">ti</span><span class="o">-&gt;</span><span class="n">nex_group_dev</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">first_group_dev</span> <span class="o">+</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">group_width</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ore_truncate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ore_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ore_components</span> <span class="o">*</span><span class="n">oc</span><span class="p">,</span>
		   <span class="n">u64</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ore_io_state</span> <span class="o">*</span><span class="n">ios</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exofs_trunc_attr</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osd_attr</span> <span class="n">attr</span><span class="p">;</span>
		<span class="n">__be64</span> <span class="n">newsize</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">size_attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_trunc_info</span> <span class="n">ti</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_get_io_state</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">oc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_calc_trunk_info</span><span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">);</span>

	<span class="n">size_attrs</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">size_attrs</span><span class="p">),</span>
			     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">size_attrs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ios</span><span class="o">-&gt;</span><span class="n">numdevs</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">numdevs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">exofs_trunc_attr</span> <span class="o">*</span><span class="n">size_attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">size_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">u64</span> <span class="n">obj_size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ti</span><span class="p">.</span><span class="n">first_group_dev</span><span class="p">)</span>
			<span class="n">obj_size</span> <span class="o">=</span> <span class="n">ti</span><span class="p">.</span><span class="n">prev_group_obj_off</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ti</span><span class="p">.</span><span class="n">nex_group_dev</span><span class="p">)</span>
			<span class="n">obj_size</span> <span class="o">=</span> <span class="n">ti</span><span class="p">.</span><span class="n">next_group_obj_off</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ti</span><span class="p">.</span><span class="n">si</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span> <span class="cm">/* dev within this group */</span>
			<span class="n">obj_size</span> <span class="o">=</span> <span class="n">ti</span><span class="p">.</span><span class="n">si</span><span class="p">.</span><span class="n">obj_offset</span> <span class="o">+</span>
				      <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">stripe_unit</span> <span class="o">-</span> <span class="n">ti</span><span class="p">.</span><span class="n">si</span><span class="p">.</span><span class="n">unit_off</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ti</span><span class="p">.</span><span class="n">si</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">obj_size</span> <span class="o">=</span> <span class="n">ti</span><span class="p">.</span><span class="n">si</span><span class="p">.</span><span class="n">obj_offset</span><span class="p">;</span>
		<span class="k">else</span> <span class="cm">/* i &gt; ti.dev */</span>
			<span class="n">obj_size</span> <span class="o">=</span> <span class="n">ti</span><span class="p">.</span><span class="n">si</span><span class="p">.</span><span class="n">obj_offset</span> <span class="o">-</span> <span class="n">ti</span><span class="p">.</span><span class="n">si</span><span class="p">.</span><span class="n">unit_off</span><span class="p">;</span>

		<span class="n">size_attr</span><span class="o">-&gt;</span><span class="n">newsize</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">obj_size</span><span class="p">);</span>
		<span class="n">size_attr</span><span class="o">-&gt;</span><span class="n">attr</span> <span class="o">=</span> <span class="n">g_attr_logical_length</span><span class="p">;</span>
		<span class="n">size_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">val_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">size_attr</span><span class="o">-&gt;</span><span class="n">newsize</span><span class="p">;</span>

		<span class="n">ORE_DBGMSG</span><span class="p">(</span><span class="s">&quot;trunc(0x%llx) obj_offset=0x%llx dev=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">_LLU</span><span class="p">(</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">comps</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">),</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">obj_size</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_truncate_mirrors</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">mirrors_p1</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">size_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ore_io_execute</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">size_attrs</span><span class="p">);</span>
	<span class="n">ore_put_io_state</span><span class="p">(</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ore_truncate</span><span class="p">);</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_attr</span> <span class="n">g_attr_logical_length</span> <span class="o">=</span> <span class="n">ATTR_DEF</span><span class="p">(</span>
	<span class="n">OSD_APAGE_OBJECT_INFORMATION</span><span class="p">,</span> <span class="n">OSD_ATTR_OI_LOGICAL_LENGTH</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">g_attr_logical_length</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
