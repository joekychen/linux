f | nfs4recover.c | s | 23K | 895 | Linus Torvalds | torvalds@linux-foundation.org | 1338564778 |  | Merge branch 'for-3.5' of git://linux-nfs.org/~bfields/linux  Pull the rest of the nfsd commits from Bruce Fields:  "... and then I cherry-picked the remainder of the patches from the   head of my previous branch"  This is the rest of the original nfsd branch, rebased without the delegation stuff that I thought really needed to be redone.  I don't like rebasing things like this in general, but in this situation this was the lesser of two evils.  * 'for-3.5' of git://linux-nfs.org/~bfields/linux: (50 commits)   nfsd4: fix, consolidate client_has_state   nfsd4: don't remove rebooted client record until confirmation   nfsd4: remove some dprintk's and a comment   nfsd4: return "real" sequence id in confirmed case   nfsd4: fix exchange_id to return confirm flag   nfsd4: clarify that renewing expired client is a bug   nfsd4: simpler ordering of setclientid_confirm checks   nfsd4: setclientid: remove pointless assignment   nfsd4: fix error return in non-matching-creds case   nfsd4: fix setclientid_confirm same_cred check   nfsd4: merge 3 setclientid cases to 2   nfsd4: pull out common code from setclientid cases   nfsd4: merge last two setclientid cases   nfsd4: setclientid/confirm comment cleanup   nfsd4: setclientid remove unnecessary terms from a logical expression   nfsd4: move rq_flavor into svc_cred   nfsd4: stricter cred comparison for setclientid/exchange_id   nfsd4: move principal name into svc_cred   nfsd4: allow removing clients not holding state   nfsd4: rearrange exchange_id logic to simplify   ...
f | nfsctl.c | s | 30K | 1111 | Stanislav Kinsbursky | skinsbursky@parallels.com | 1338510580 |  | SUNRPC: move per-net operations from svc_destroy()  The idea is to separate service destruction and per-net operations, because these are two different things and the mix looks ugly.  Notes:  1) For NFS server this patch looks ugly (sorry for that). But these place will be rewritten soon during NFSd containerization.  2) LockD per-net counter increase int lockd_up() was moved prior to make_socks() to make lockd_down_net() call safe in case of error.  Signed-off-by: Stanislav Kinsbursky <skinsbursky@parallels.com> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | nfs3xdr.c | s | 26K | 975 | Al Viro | viro@zeniv.linux.org.uk | 1334326322 |  | nfsd: fix compose_entry_fh() failure exits  Restore the original logics ("fail on mountpoints, negatives and in case of fh_compose() failures").  Since commit 8177e (nfsd: clean up readdirplus encoding) that got broken - 	rv = fh_compose(fhp, exp, dchild, &cd->fh); 	if (rv) 	       goto out; 	if (!dchild->d_inode) 		goto out; 	rv = 0; out: is equivalent to 	rv = fh_compose(fhp, exp, dchild, &cd->fh); out: and the second check has no effect whatsoever...  Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
f | Makefile | g | 485B |  | Bryan Schumaker | bjschuma@netapp.com | 1320718247 |  | NFSD: Added fault injection  Fault injection on the NFS server makes it easier to test the client's state manager and recovery threads.  Simulating errors on the server is easier than finding the right conditions that cause them naturally.  This patch uses debugfs to add a simple framework for fault injection to the server.  This framework is a config option, and can be enabled through CONFIG_NFSD_FAULT_INJECTION.  Assuming you have debugfs mounted to /sys/debug, a set of files will be created in /sys/debug/nfsd/. Writing to any of these files will cause the corresponding action and write a log entry to dmesg.  Signed-off-by: Bryan Schumaker <bjschuma@netapp.com> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | nfs4state.c | s | 125K | 4250 | J. Bruce Fields | bfields@redhat.com | 1339696448 |  | nfsd4: BUG_ON(!is_spin_locked()) no good on UP kernels  Most frequent symptom was a BUG triggering in expire_client, with the server locking up shortly thereafter.  Introduced by 508dc6e110c6dbdc0bbe84298ccfe22de7538486 "nfsd41: free_session/free_client must be called under the client_lock".  Cc: stable@kernel.org Cc: Benny Halevy <bhalevy@tonian.com> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | nfs4acl.c | s | 21K | 745 | Paul Gortmaker | paul.gortmaker@windriver.com | 1320103831 |  | fs: add export.h to files using EXPORT_SYMBOL/THIS_MODULE macros  These files were getting <linux/module.h> via an implicit include path, but we want to crush those out of existence since they cost time during compiles of processing thousands of lines of headers for no reason.  Give them the lightweight header that just contains the EXPORT_SYMBOL infrastructure.  Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
f | nfsproc.c | s | 20K | 674 | J. Bruce Fields | bfields@redhat.com | 1294183331 |  | nfsd4: return nfs errno from name_to_id functions  This avoids the need for the confusing ESRCH mapping.  Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | xdr3.h | s | 7.9K | 304 | J. Bruce Fields | bfields@citi.umich.edu | 1260907307 |  | nfsd: remove pointless paths in file headers  The new .h files have paths at the top that are now out of date.  While we're here, just remove all of those from fs/nfsd; they never served any purpose.  Signed-off-by: J. Bruce Fields <bfields@citi.umich.edu>
f | xdr4.h | s | 18K | 551 | J. Bruce Fields | bfields@redhat.com | 1338510577 |  | nfsd4: int/__be32 fixes  In each of these cases there's a simple unambiguous correct choice, and no actual bug.  Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | nfs4proc.c | s | 50K | 1563 | Linus Torvalds | torvalds@linux-foundation.org | 1334872492 |  | Merge branch 'for-3.4' of git://linux-nfs.org/~bfields/linux  Pull nfsd bugfixes from J. Bruce Fields:  "One bugfix, and one minor header fix from Jeff Layton while we're   here"  * 'for-3.4' of git://linux-nfs.org/~bfields/linux:   nfsd: include cld.h in the headers_install target   nfsd: don't fail unchecked creates of non-special files
f | nfsfh.c | s | 18K | 623 | Stanislav Kinsbursky | skinsbursky@parallels.com | 1334181302 |  | nfsd: use exp_put() for svc_export_cache put  This patch replaces cache_put() call for svc_export_cache by exp_put() call.  Signed-off-by: Stanislav Kinsbursky <skinsbursky@parallels.com> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | xdr.h | s | 4.0K | 145 | J. Bruce Fields | bfields@citi.umich.edu | 1260907307 |  | nfsd: remove pointless paths in file headers  The new .h files have paths at the top that are now out of date.  While we're here, just remove all of those from fs/nfsd; they never served any purpose.  Signed-off-by: J. Bruce Fields <bfields@citi.umich.edu>
f | vfs.h | s | 4.4K | 108 | Bernd Schubert | bernd.schubert@itwm.fraunhofer.de | 1332125090 |  | nfsd: vfs_llseek() with 32 or 64 bit offsets (hashes)  Use 32-bit or 64-bit llseek() hashes for directory offsets depending on the NFS version. NFSv2 gets 32-bit hashes only.  NOTE: This patch got rather complex as Christoph asked to set the filp->f_mode flag in the open call or immediatly after dentry_open() in nfsd_open() to avoid races. Personally I still do not see a reason for that and in my opinion FMODE_32BITHASH/FMODE_64BITHASH flags could be set nfsd_readdir(), as it follows directly after nfsd_open() without a chance of races.  Signed-off-by: Bernd Schubert <bernd.schubert@itwm.fraunhofer.de> Signed-off-by: "Theodore Ts'o" <tytso@mit.edu> Acked-by: J. Bruce Fields<bfields@redhat.com>
f | nfs3proc.c | s | 24K | 789 | Mi Jinlong | mijinlong@cn.fujitsu.com | 1304124472 |  | nfsd41: make sure nfs server process OPEN with EXCLUSIVE4_1 correctly  The NFS server uses nfsd_create_v3 to handle EXCLUSIVE4_1 opens, but that function is not prepared to handle them.  Rename nfsd_create_v3() to do_nfsd_create(), and add handling of EXCLUSIVE4_1.  Signed-off-by: Mi Jinlong <mijinlong@cn.fujitsu.com> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | idmap.h | s | 2.3K | 56 | Stanislav Kinsbursky | skinsbursky@parallels.com | 1334236330 |  | nfsd: pass network context to idmap init/exit functions  These functions will be called from per-net operations.  Signed-off-by: Stanislav Kinsbursky <skinsbursky@parallels.com> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | cache.h | s | 1.6K | 71 | J. Bruce Fields | bfields@redhat.com | 1310996341 |  | nfsd: turn on reply cache for NFSv4  It's sort of ridiculous that we've never had a working reply cache for NFSv4.  On the other hand, we may still not: our current reply cache is likely not very good, especially in the TCP case (which is the only case that matters for v4).  What we really need here is some serious testing.  Anyway, here's a start.  Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | export.c | s | 31K | 1132 | J. Bruce Fields | bfields@redhat.com | 1338510598 |  | nfsd4: move rq_flavor into svc_cred  Move the rq_flavor into struct svc_cred, and use it in setclientid and exchange_id comparisons as well.  Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | nfsfh.h | s | 4.2K | 176 | Al Viro | viro@zeniv.linux.org.uk | 1325649310 |  | fs: propagate umode_t, misc bits  Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
f | nfs3acl.c | s | 6.3K | 228 | Tejun Heo | tj@kernel.org | 1269954152 |  | include cleanup: Update gfp.h and slab.h includes to prepare for breaking implicit slab.h inclusion from percpu.h  percpu.h is included by sched.h and module.h and thus ends up being included when building most .c files.  percpu.h includes slab.h which in turn includes gfp.h making everything defined by the two files universally available and complicating inclusion dependencies.  percpu.h -> slab.h dependency is about to be removed.  Prepare for this change by updating users of gfp and slab facilities include those headers directly instead of assuming availability.  As this conversion needs to touch large number of source files, the following script is used as the basis of conversion.    http://userweb.kernel.org/~tj/misc/slabh-sweep.py  The script does the followings.  * Scan files for gfp and slab usages and update includes such that   only the necessary includes are there.  ie. if only gfp is used,   gfp.h, if slab is used, slab.h.  * When the script inserts a new include, it looks at the include   blocks and try to put the new include such that its order conforms   to its surrounding.  It's put in the include block which contains   core kernel includes, in the same order that the rest are ordered -   alphabetical, Christmas tree, rev-Xmas-tree or at the end if there   doesn't seem to be any matching order.  * If the script can't find a place to put a new include (mostly   because the file doesn't have fitting include block), it prints out   an error message indicating which .h file needs to be added to the   file.  The conversion was done in the following steps.  1. The initial automatic conversion of all .c files updated slightly    over 4000 files, deleting around 700 includes and adding ~480 gfp.h    and ~3000 slab.h inclusions.  The script emitted errors for ~400    files.  2. Each error was manually checked.  Some didn't need the inclusion,    some needed manual addition while adding it to implementation .h or    embedding .c file was more appropriate for others.  This step added    inclusions to around 150 files.  3. The script was run again and the output was compared to the edits    from #2 to make sure no file was left behind.  4. Several build tests were done and a couple of problems were fixed.    e.g. lib/decompress_*.c used malloc/free() wrappers around slab    APIs requiring slab.h to be added manually.  5. The script was run on all .h files but without automatically    editing them as sprinkling gfp.h and slab.h inclusions around .h    files could easily lead to inclusion dependency hell.  Most gfp.h    inclusion directives were ignored as stuff from gfp.h was usually    wildly available and often used in preprocessor macros.  Each    slab.h inclusion directive was examined and added manually as    necessary.  6. percpu.h was updated not to include slab.h.  7. Build test were done on the following configurations and failures    were fixed.  CONFIG_GCOV_KERNEL was turned off for all tests (as my    distributed build env didn't work with gcov compiles) and a few    more options had to be turned off depending on archs to make things    build (like ipr on powerpc/64 which failed due to missing writeq).     * x86 and x86_64 UP and SMP allmodconfig and a custom test config.    * powerpc and powerpc64 SMP allmodconfig    * sparc and sparc64 SMP allmodconfig    * ia64 SMP allmodconfig    * s390 SMP allmodconfig    * alpha SMP allmodconfig    * um on x86_64 SMP allmodconfig  8. percpu.h modifications were reverted so that it could be applied as    a separate patch and serve as bisection point.  Given the fact that I had only a couple of failures from tests on step 6, I'm fairly confident about the coverage of this conversion patch. If there is a breakage, it's likely to be something in one of the arch headers which should be easily discoverable easily on most builds of the specific arch.  Signed-off-by: Tejun Heo <tj@kernel.org> Guess-its-ok-by: Christoph Lameter <cl@linux-foundation.org> Cc: Ingo Molnar <mingo@redhat.com> Cc: Lee Schermerhorn <Lee.Schermerhorn@hp.com>
f | auth.h | s | 540B | 18 | J. Bruce Fields | bfields@citi.umich.edu | 1201902125 |  | nfsd: minor fs/nfsd/auth.h cleanup  While we're here, let's remove the redundant (and now wrong) pathname in the comment, and the #ifdef __KERNEL__'s.  Acked-by: NeilBrown <neilb@suse.de> Signed-off-by: J. Bruce Fields <bfields@citi.umich.edu>
f | vfs.c | s | 54K | 2032 | Jeff Layton | jlayton@redhat.com | 1335382703 |  | nfsd: trivial: use SEEK_SET instead of 0 in vfs_llseek  They're equivalent, but SEEK_SET is more informative...  Cc: Eric Sandeen <sandeen@redhat.com> Signed-off-by: Jeff Layton <jlayton@redhat.com> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | stats.c | s | 2.7K | 91 | Stanislav Kinsbursky | skinsbursky@parallels.com | 1328056098 |  | SUNRPC: register service stats /proc entries in passed network namespace context  This patch makes it possible to create NFSd program entry ("/proc/net/rpc/nfsd") in passed network namespace context instead of hard-coded "init_net".  Signed-off-by: Stanislav Kinsbursky <skinsbursky@parallels.com> Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>
f | acl.h | s | 2.4K | 52 | J. Bruce Fields | bfields@redhat.com | 1294183330 |  | nfsd4: remove outdated pathname-comments  Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | nfsxdr.c | s | 12K | 477 | Lucas De Marchi | lucas.demarchi@profusion.mobi | 1301581583 |  | Fix common misspellings  Fixes generated by 'codespell' and manually reviewed.  Signed-off-by: Lucas De Marchi <lucas.demarchi@profusion.mobi>
f | nfs4xdr.c | s | 90K | 3291 | Linus Torvalds | torvalds@linux-foundation.org | 1338564778 |  | Merge branch 'for-3.5' of git://linux-nfs.org/~bfields/linux  Pull the rest of the nfsd commits from Bruce Fields:  "... and then I cherry-picked the remainder of the patches from the   head of my previous branch"  This is the rest of the original nfsd branch, rebased without the delegation stuff that I thought really needed to be redone.  I don't like rebasing things like this in general, but in this situation this was the lesser of two evils.  * 'for-3.5' of git://linux-nfs.org/~bfields/linux: (50 commits)   nfsd4: fix, consolidate client_has_state   nfsd4: don't remove rebooted client record until confirmation   nfsd4: remove some dprintk's and a comment   nfsd4: return "real" sequence id in confirmed case   nfsd4: fix exchange_id to return confirm flag   nfsd4: clarify that renewing expired client is a bug   nfsd4: simpler ordering of setclientid_confirm checks   nfsd4: setclientid: remove pointless assignment   nfsd4: fix error return in non-matching-creds case   nfsd4: fix setclientid_confirm same_cred check   nfsd4: merge 3 setclientid cases to 2   nfsd4: pull out common code from setclientid cases   nfsd4: merge last two setclientid cases   nfsd4: setclientid/confirm comment cleanup   nfsd4: setclientid remove unnecessary terms from a logical expression   nfsd4: move rq_flavor into svc_cred   nfsd4: stricter cred comparison for setclientid/exchange_id   nfsd4: move principal name into svc_cred   nfsd4: allow removing clients not holding state   nfsd4: rearrange exchange_id logic to simplify   ...
f | fault_inject.c | s | 1.8K | 77 | Weston Andros Adamson | dros@netapp.com | 1338510588 |  | nfsd: return 0 on reads of fault injection files  debugfs read operations were returning the contents of an uninitialized u64.  Signed-off-by: Weston Andros Adamson <dros@netapp.com> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | Kconfig | g | 3.0K |  | Bryan Schumaker | bjschuma@netapp.com | 1320718247 |  | NFSD: Added fault injection  Fault injection on the NFS server makes it easier to test the client's state manager and recovery threads.  Simulating errors on the server is easier than finding the right conditions that cause them naturally.  This patch uses debugfs to add a simple framework for fault injection to the server.  This framework is a config option, and can be enabled through CONFIG_NFSD_FAULT_INJECTION.  Assuming you have debugfs mounted to /sys/debug, a set of files will be created in /sys/debug/nfsd/. Writing to any of these files will cause the corresponding action and write a log entry to dmesg.  Signed-off-by: Bryan Schumaker <bjschuma@netapp.com> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | nfscache.c | s | 7.6K | 284 | J. Bruce Fields | bfields@redhat.com | 1310996341 |  | nfsd: turn on reply cache for NFSv4  It's sort of ridiculous that we've never had a working reply cache for NFSv4.  On the other hand, we may still not: our current reply cache is likely not very good, especially in the TCP case (which is the only case that matters for v4).  What we really need here is some serious testing.  Anyway, here's a start.  Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | nfs4idmap.c | s | 15K | 553 | J. Bruce Fields | bfields@redhat.com | 1338510598 |  | nfsd4: move rq_flavor into svc_cred  Move the rq_flavor into struct svc_cred, and use it in setclientid and exchange_id comparisons as well.  Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | auth.c | s | 2.1K | 79 | Linus Torvalds | torvalds@linux-foundation.org | 1338564778 |  | Merge branch 'for-3.5' of git://linux-nfs.org/~bfields/linux  Pull the rest of the nfsd commits from Bruce Fields:  "... and then I cherry-picked the remainder of the patches from the   head of my previous branch"  This is the rest of the original nfsd branch, rebased without the delegation stuff that I thought really needed to be redone.  I don't like rebasing things like this in general, but in this situation this was the lesser of two evils.  * 'for-3.5' of git://linux-nfs.org/~bfields/linux: (50 commits)   nfsd4: fix, consolidate client_has_state   nfsd4: don't remove rebooted client record until confirmation   nfsd4: remove some dprintk's and a comment   nfsd4: return "real" sequence id in confirmed case   nfsd4: fix exchange_id to return confirm flag   nfsd4: clarify that renewing expired client is a bug   nfsd4: simpler ordering of setclientid_confirm checks   nfsd4: setclientid: remove pointless assignment   nfsd4: fix error return in non-matching-creds case   nfsd4: fix setclientid_confirm same_cred check   nfsd4: merge 3 setclientid cases to 2   nfsd4: pull out common code from setclientid cases   nfsd4: merge last two setclientid cases   nfsd4: setclientid/confirm comment cleanup   nfsd4: setclientid remove unnecessary terms from a logical expression   nfsd4: move rq_flavor into svc_cred   nfsd4: stricter cred comparison for setclientid/exchange_id   nfsd4: move principal name into svc_cred   nfsd4: allow removing clients not holding state   nfsd4: rearrange exchange_id logic to simplify   ...
f | nfssvc.c | s | 16K | 603 | Stanislav Kinsbursky | skinsbursky@parallels.com | 1338510580 |  | SUNRPC: move per-net operations from svc_destroy()  The idea is to separate service destruction and per-net operations, because these are two different things and the mix looks ugly.  Notes:  1) For NFS server this patch looks ugly (sorry for that). But these place will be rewritten soon during NFSd containerization.  2) LockD per-net counter increase int lockd_up() was moved prior to make_socks() to make lockd_down_net() call safe in case of error.  Signed-off-by: Stanislav Kinsbursky <skinsbursky@parallels.com> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | netns.h | s | 1.2K | 33 | Stanislav Kinsbursky | skinsbursky@parallels.com | 1334236330 |  | nfsd: make name-to-id cache allocated per network namespace context  Signed-off-by: Stanislav Kinsbursky <skinsbursky@parallels.com> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | state.h | s | 15K | 439 | J. Bruce Fields | bfields@redhat.com | 1338510595 |  | nfsd4: move principal name into svc_cred  Instead of keeping the principal name associated with a request in a structure that's private to auth_gss and using an accessor function, move it to svc_cred.  Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | current_stateid.h | s | 1.4K | 24 | Tigran Mkrtchyan | kofemann@gmail.com | 1329322845 |  | nfsd41: use current stateid by value  Signed-off-by: Tigran Mkrtchyan <kofemann@gmail.com> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | lockd.c | s | 1.7K | 68 | NeilBrown | neilb@suse.de | 1310770722 |  | nfsd: Remove deprecated nfsctl system call and related code.  As promised in feature-removal-schedule.txt it is time to remove the nfsctl system call.  Userspace has perferred to not use this call throughout 2.6 and it has been excluded in the default configuration since 2.6.36 (9 months ago).  So this patch removes all the code that was being compiled out.  There are still references to sys_nfsctl in various arch systemcall tables and related code.  These should be cleaned out too, probably in the next merge window.  Signed-off-by: NeilBrown <neilb@suse.de> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | fault_inject.h | s | 955B | 25 | Bryan Schumaker | bjschuma@netapp.com | 1320718247 |  | NFSD: Added fault injection  Fault injection on the NFS server makes it easier to test the client's state manager and recovery threads.  Simulating errors on the server is easier than finding the right conditions that cause them naturally.  This patch uses debugfs to add a simple framework for fault injection to the server.  This framework is a config option, and can be enabled through CONFIG_NFSD_FAULT_INJECTION.  Assuming you have debugfs mounted to /sys/debug, a set of files will be created in /sys/debug/nfsd/. Writing to any of these files will cause the corresponding action and write a log entry to dmesg.  Signed-off-by: Bryan Schumaker <bjschuma@netapp.com> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | nfsd.h | s | 14K | 336 | Jeff Layton | jlayton@redhat.com | 1333022467 |  | nfsd: only register cld pipe notifier when CONFIG_NFSD_V4 is enabled  Otherwise, we get a warning or error similar to this when building with CONFIG_NFSD_V4 disabled:      ERROR: "nfsd4_cld_block" [fs/nfsd/nfsd.ko] undefined!  Fix this by wrapping the calls to rpc_pipefs_notifier_register and ..._unregister in another function and providing no-op replacements when CONFIG_NFSD_V4 is disabled.  Reported-by: Paul Gortmaker <paul.gortmaker@windriver.com> Signed-off-by: Jeff Layton <jlayton@redhat.com> Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | nfs4callback.c | s | 25K | 911 | J. Bruce Fields | bfields@redhat.com | 1338510595 |  | nfsd4: move principal name into svc_cred  Instead of keeping the principal name associated with a request in a structure that's private to auth_gss and using an accessor function, move it to svc_cred.  Signed-off-by: J. Bruce Fields <bfields@redhat.com>
f | nfs2acl.c | s | 8.6K | 306 | Tejun Heo | tj@kernel.org | 1269954152 |  | include cleanup: Update gfp.h and slab.h includes to prepare for breaking implicit slab.h inclusion from percpu.h  percpu.h is included by sched.h and module.h and thus ends up being included when building most .c files.  percpu.h includes slab.h which in turn includes gfp.h making everything defined by the two files universally available and complicating inclusion dependencies.  percpu.h -> slab.h dependency is about to be removed.  Prepare for this change by updating users of gfp and slab facilities include those headers directly instead of assuming availability.  As this conversion needs to touch large number of source files, the following script is used as the basis of conversion.    http://userweb.kernel.org/~tj/misc/slabh-sweep.py  The script does the followings.  * Scan files for gfp and slab usages and update includes such that   only the necessary includes are there.  ie. if only gfp is used,   gfp.h, if slab is used, slab.h.  * When the script inserts a new include, it looks at the include   blocks and try to put the new include such that its order conforms   to its surrounding.  It's put in the include block which contains   core kernel includes, in the same order that the rest are ordered -   alphabetical, Christmas tree, rev-Xmas-tree or at the end if there   doesn't seem to be any matching order.  * If the script can't find a place to put a new include (mostly   because the file doesn't have fitting include block), it prints out   an error message indicating which .h file needs to be added to the   file.  The conversion was done in the following steps.  1. The initial automatic conversion of all .c files updated slightly    over 4000 files, deleting around 700 includes and adding ~480 gfp.h    and ~3000 slab.h inclusions.  The script emitted errors for ~400    files.  2. Each error was manually checked.  Some didn't need the inclusion,    some needed manual addition while adding it to implementation .h or    embedding .c file was more appropriate for others.  This step added    inclusions to around 150 files.  3. The script was run again and the output was compared to the edits    from #2 to make sure no file was left behind.  4. Several build tests were done and a couple of problems were fixed.    e.g. lib/decompress_*.c used malloc/free() wrappers around slab    APIs requiring slab.h to be added manually.  5. The script was run on all .h files but without automatically    editing them as sprinkling gfp.h and slab.h inclusions around .h    files could easily lead to inclusion dependency hell.  Most gfp.h    inclusion directives were ignored as stuff from gfp.h was usually    wildly available and often used in preprocessor macros.  Each    slab.h inclusion directive was examined and added manually as    necessary.  6. percpu.h was updated not to include slab.h.  7. Build test were done on the following configurations and failures    were fixed.  CONFIG_GCOV_KERNEL was turned off for all tests (as my    distributed build env didn't work with gcov compiles) and a few    more options had to be turned off depending on archs to make things    build (like ipr on powerpc/64 which failed due to missing writeq).     * x86 and x86_64 UP and SMP allmodconfig and a custom test config.    * powerpc and powerpc64 SMP allmodconfig    * sparc and sparc64 SMP allmodconfig    * ia64 SMP allmodconfig    * s390 SMP allmodconfig    * alpha SMP allmodconfig    * um on x86_64 SMP allmodconfig  8. percpu.h modifications were reverted so that it could be applied as    a separate patch and serve as bisection point.  Given the fact that I had only a couple of failures from tests on step 6, I'm fairly confident about the coverage of this conversion patch. If there is a breakage, it's likely to be something in one of the arch headers which should be easily discoverable easily on most builds of the specific arch.  Signed-off-by: Tejun Heo <tj@kernel.org> Guess-its-ok-by: Christoph Lameter <cl@linux-foundation.org> Cc: Ingo Molnar <mingo@redhat.com> Cc: Lee Schermerhorn <Lee.Schermerhorn@hp.com>
