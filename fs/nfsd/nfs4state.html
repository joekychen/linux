<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › nfsd › nfs4state.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>nfs4state.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">*  Copyright (c) 2001 The Regents of the University of Michigan.</span>
<span class="cm">*  All rights reserved.</span>
<span class="cm">*</span>
<span class="cm">*  Kendrick Smith &lt;kmsmith@umich.edu&gt;</span>
<span class="cm">*  Andy Adamson &lt;kandros@umich.edu&gt;</span>
<span class="cm">*</span>
<span class="cm">*  Redistribution and use in source and binary forms, with or without</span>
<span class="cm">*  modification, are permitted provided that the following conditions</span>
<span class="cm">*  are met:</span>
<span class="cm">*</span>
<span class="cm">*  1. Redistributions of source code must retain the above copyright</span>
<span class="cm">*     notice, this list of conditions and the following disclaimer.</span>
<span class="cm">*  2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm">*     notice, this list of conditions and the following disclaimer in the</span>
<span class="cm">*     documentation and/or other materials provided with the distribution.</span>
<span class="cm">*  3. Neither the name of the University nor the names of its</span>
<span class="cm">*     contributors may be used to endorse or promote products derived</span>
<span class="cm">*     from this software without specific prior written permission.</span>
<span class="cm">*</span>
<span class="cm">*  THIS SOFTWARE IS PROVIDED ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED</span>
<span class="cm">*  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<span class="cm">*  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="cm">*  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</span>
<span class="cm">*  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="cm">*  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm">*  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span>
<span class="cm">*  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
<span class="cm">*  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="cm">*  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="cm">*  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm">*</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/swap.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/svcauth_gss.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/clnt.h&gt;</span>
<span class="cp">#include &quot;xdr4.h&quot;</span>
<span class="cp">#include &quot;vfs.h&quot;</span>
<span class="cp">#include &quot;current_stateid.h&quot;</span>

<span class="cp">#define NFSDDBG_FACILITY                NFSDDBG_PROC</span>

<span class="cm">/* Globals */</span>
<span class="kt">time_t</span> <span class="n">nfsd4_lease</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>     <span class="cm">/* default lease time */</span>
<span class="kt">time_t</span> <span class="n">nfsd4_grace</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">time_t</span> <span class="n">boot_time</span><span class="p">;</span>

<span class="cp">#define all_ones {{~0,~0},~0}</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">stateid_t</span> <span class="n">one_stateid</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">si_generation</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">si_opaque</span> <span class="o">=</span> <span class="n">all_ones</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">stateid_t</span> <span class="n">zero_stateid</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* all fields zero */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">stateid_t</span> <span class="n">currentstateid</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">si_generation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">current_sessionid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#define ZERO_STATEID(stateid) (!memcmp((stateid), &amp;zero_stateid, sizeof(stateid_t)))</span>
<span class="cp">#define ONE_STATEID(stateid)  (!memcmp((stateid), &amp;one_stateid, sizeof(stateid_t)))</span>
<span class="cp">#define CURRENT_STATEID(stateid) (!memcmp((stateid), &amp;currentstateid, sizeof(stateid_t)))</span>

<span class="cm">/* forward declarations */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">check_for_locks</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lowner</span><span class="p">);</span>

<span class="cm">/* Locking: */</span>

<span class="cm">/* Currently used for almost all code touching nfsv4 state: */</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">client_mutex</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Currently used for the del_recall_lru and file hash table.  In an</span>
<span class="cm"> * effort to decrease the scope of the client_mutex, this spinlock may</span>
<span class="cm"> * eventually cover more:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">recall_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">openowner_slab</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">lockowner_slab</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">file_slab</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">stateid_slab</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">deleg_slab</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="kt">void</span>
<span class="nf">nfs4_lock_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">free_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* Must be called under the client_lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd4_put_session_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_ref</span><span class="p">,</span> <span class="n">free_session</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd4_get_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_ref</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfs4_unlock_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span>
<span class="nf">opaque_hashval</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nbytes</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">*=</span> <span class="mi">37</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">+=</span> <span class="o">*</span><span class="n">cptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">del_recall_lru</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd4_free_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">file_slab</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">put_nfs4_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">fi_ref</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">fi_hash</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">fi_inode</span><span class="p">);</span>
		<span class="n">nfsd4_free_file</span><span class="p">(</span><span class="n">fi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">get_nfs4_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">fi_ref</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">num_delegations</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_delegations</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Open owner state (share locks)</span>
<span class="cm"> */</span>

<span class="cm">/* hash tables for lock and open owners */</span>
<span class="cp">#define OWNER_HASH_BITS              8</span>
<span class="cp">#define OWNER_HASH_SIZE             (1 &lt;&lt; OWNER_HASH_BITS)</span>
<span class="cp">#define OWNER_HASH_MASK             (OWNER_HASH_SIZE - 1)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ownerstr_hashval</span><span class="p">(</span><span class="n">u32</span> <span class="n">clientid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="o">*</span><span class="n">ownername</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">opaque_hashval</span><span class="p">(</span><span class="n">ownername</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ownername</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">+=</span> <span class="n">clientid</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">&amp;</span> <span class="n">OWNER_HASH_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span>	<span class="n">ownerstr_hashtbl</span><span class="p">[</span><span class="n">OWNER_HASH_SIZE</span><span class="p">];</span>

<span class="cm">/* hash table for nfs4_file */</span>
<span class="cp">#define FILE_HASH_BITS                   8</span>
<span class="cp">#define FILE_HASH_SIZE                  (1 &lt;&lt; FILE_HASH_BITS)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">file_hashval</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ino</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* XXX: why are we hashing on inode pointer, anyway? */</span>
	<span class="k">return</span> <span class="n">hash_ptr</span><span class="p">(</span><span class="n">ino</span><span class="p">,</span> <span class="n">FILE_HASH_BITS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">file_hashtbl</span><span class="p">[</span><span class="n">FILE_HASH_SIZE</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__nfs4_file_get_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_fds</span><span class="p">[</span><span class="n">oflag</span><span class="p">]</span> <span class="o">||</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_fds</span><span class="p">[</span><span class="n">O_RDWR</span><span class="p">]));</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_access</span><span class="p">[</span><span class="n">oflag</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_file_get_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oflag</span> <span class="o">==</span> <span class="n">O_RDWR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__nfs4_file_get_access</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
		<span class="n">__nfs4_file_get_access</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">__nfs4_file_get_access</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">oflag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_file_put_fd</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_fds</span><span class="p">[</span><span class="n">oflag</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">fput</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_fds</span><span class="p">[</span><span class="n">oflag</span><span class="p">]);</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_fds</span><span class="p">[</span><span class="n">oflag</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__nfs4_file_put_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_access</span><span class="p">[</span><span class="n">oflag</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">nfs4_file_put_fd</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">oflag</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * It&#39;s also safe to get rid of the RDWR open *if*</span>
<span class="cm">		 * we no longer have need of the other kind of access</span>
<span class="cm">		 * or if we already have the other kind of open:</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_fds</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">oflag</span><span class="p">]</span>
			<span class="o">||</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_access</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">oflag</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nfs4_file_put_fd</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_file_put_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oflag</span> <span class="o">==</span> <span class="n">O_RDWR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__nfs4_file_put_access</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
		<span class="n">__nfs4_file_put_access</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">__nfs4_file_put_access</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">oflag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_new_stid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_stid</span> <span class="o">*</span><span class="n">stid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">min_stateid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idr</span> <span class="o">*</span><span class="n">stateids</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stid</span><span class="o">-&gt;</span><span class="n">sc_client</span><span class="o">-&gt;</span><span class="n">cl_stateids</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_stid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">idr_get_new_above</span><span class="p">(</span><span class="n">stateids</span><span class="p">,</span> <span class="n">stid</span><span class="p">,</span> <span class="n">min_stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_stid</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Note: the necessary preallocation was done in</span>
<span class="cm">	 * nfs4_alloc_stateid().  The idr code caps the number of</span>
<span class="cm">	 * preallocations that can exist at a time, but the state lock</span>
<span class="cm">	 * prevents anyone from using ours before we get here:</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * It shouldn&#39;t be a problem to reuse an opaque stateid value.</span>
<span class="cm">	 * I don&#39;t think it is for 4.1.  But with 4.0 I worry that, for</span>
<span class="cm">	 * example, a stray write retransmission could be accepted by</span>
<span class="cm">	 * the server when it should have been rejected.  Therefore,</span>
<span class="cm">	 * adopt a trick from the sctp code to attempt to maximize the</span>
<span class="cm">	 * amount of time until an id is reused, by ensuring they always</span>
<span class="cm">	 * &quot;increase&quot; (mod INT_MAX):</span>
<span class="cm">	 */</span>

	<span class="n">min_stateid</span> <span class="o">=</span> <span class="n">new_stid</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">min_stateid</span> <span class="o">==</span> <span class="n">INT_MAX</span><span class="p">)</span>
		<span class="n">min_stateid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">new_stid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_stid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_stid</span> <span class="o">*</span><span class="n">stid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stateid_t</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stid</span><span class="o">-&gt;</span><span class="n">sc_stateid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_id</span><span class="p">;</span>

	<span class="n">stid</span><span class="o">-&gt;</span><span class="n">sc_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">stid</span><span class="o">-&gt;</span><span class="n">sc_client</span> <span class="o">=</span> <span class="n">cl</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">si_opaque</span><span class="p">.</span><span class="n">so_clid</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">;</span>
	<span class="n">new_id</span> <span class="o">=</span> <span class="n">get_new_stid</span><span class="p">(</span><span class="n">stid</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">si_opaque</span><span class="p">.</span><span class="n">so_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">new_id</span><span class="p">;</span>
	<span class="cm">/* Will be incremented before return to client: */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">si_generation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_stid</span> <span class="o">*</span><span class="nf">nfs4_alloc_stid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">slab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idr</span> <span class="o">*</span><span class="n">stateids</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">cl_stateids</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idr_pre_get</span><span class="p">(</span><span class="n">stateids</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Note: if we fail here (or any time between now and the time</span>
<span class="cm">	 * we actually get the new idr), we won&#39;t need to undo the idr</span>
<span class="cm">	 * preallocation, since the idr code caps the number of</span>
<span class="cm">	 * preallocated entries.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span> <span class="nf">nfs4_alloc_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">openlockstateid</span><span class="p">(</span><span class="n">nfs4_alloc_stid</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">stateid_slab</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span>
<span class="nf">alloc_init_deleg</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD alloc_init_deleg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Major work on the lease subsystem (for example, to support</span>
<span class="cm">	 * calbacks on stat) will be required before we can support</span>
<span class="cm">	 * write delegations properly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NFS4_OPEN_DELEGATE_READ</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_had_conflict</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_delegations</span> <span class="o">&gt;</span> <span class="n">max_delegations</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">delegstateid</span><span class="p">(</span><span class="n">nfs4_alloc_stid</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">deleg_slab</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dp</span><span class="p">;</span>
	<span class="n">init_stid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_stid</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="n">NFS4_DELEG_STID</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * delegation seqid&#39;s are never incremented.  The 4.1 special</span>
<span class="cm">	 * meaning of seqid 0 isn&#39;t meaningful, really, but let&#39;s avoid</span>
<span class="cm">	 * 0 anyway just for consistency and use 1:</span>
<span class="cm">	 */</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">.</span><span class="n">si_generation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">num_delegations</span><span class="o">++</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_perfile</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_perclnt</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_recall_lru</span><span class="p">);</span>
	<span class="n">get_nfs4_file</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_file</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">fh_copy_shallow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_fh</span><span class="o">-&gt;</span><span class="n">fh_handle</span><span class="p">);</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_recall</span><span class="p">.</span><span class="n">cb_work</span><span class="p">,</span> <span class="n">nfsd4_do_callback_rpc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfs4_put_delegation</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: freeing dp %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dp</span><span class="p">);</span>
		<span class="n">put_nfs4_file</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_file</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">deleg_slab</span><span class="p">,</span> <span class="n">dp</span><span class="p">);</span>
		<span class="n">num_delegations</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_put_deleg_lease</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_delegees</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vfs_setlease</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_deleg_file</span><span class="p">,</span> <span class="n">F_UNLCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_lease</span><span class="p">);</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_lease</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">fput</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_deleg_file</span><span class="p">);</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_deleg_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unhash_stid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_stid</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idr</span> <span class="o">*</span><span class="n">stateids</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sc_client</span><span class="o">-&gt;</span><span class="n">cl_stateids</span><span class="p">;</span>

	<span class="n">idr_remove</span><span class="p">(</span><span class="n">stateids</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sc_stateid</span><span class="p">.</span><span class="n">si_opaque</span><span class="p">.</span><span class="n">so_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called under the state lock. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">unhash_delegation</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unhash_stid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_stid</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_perclnt</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_perfile</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_recall_lru</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="n">nfs4_put_deleg_lease</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_file</span><span class="p">);</span>
	<span class="n">nfs4_put_delegation</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> * SETCLIENTID state </span>
<span class="cm"> */</span>

<span class="cm">/* client_lock protects the client lru list and session hash table */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">client_lock</span><span class="p">);</span>

<span class="cm">/* Hash tables for nfs4_clientid state */</span>
<span class="cp">#define CLIENT_HASH_BITS                 4</span>
<span class="cp">#define CLIENT_HASH_SIZE                (1 &lt;&lt; CLIENT_HASH_BITS)</span>
<span class="cp">#define CLIENT_HASH_MASK                (CLIENT_HASH_SIZE - 1)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">clientid_hashval</span><span class="p">(</span><span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">id</span> <span class="o">&amp;</span> <span class="n">CLIENT_HASH_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">clientstr_hashval</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">opaque_hashval</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CLIENT_HASH_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * reclaim_str_hashtbl[] holds known client info from previous reset/reboot</span>
<span class="cm"> * used in reboot/reset lease grace period processing</span>
<span class="cm"> *</span>
<span class="cm"> * conf_id_hashtbl[], and conf_str_hashtbl[] hold confirmed</span>
<span class="cm"> * setclientid_confirmed info. </span>
<span class="cm"> *</span>
<span class="cm"> * unconf_str_hastbl[] and unconf_id_hashtbl[] hold unconfirmed </span>
<span class="cm"> * setclientid info.</span>
<span class="cm"> *</span>
<span class="cm"> * client_lru holds client queue ordered by nfs4_client.cl_time</span>
<span class="cm"> * for lease renewal.</span>
<span class="cm"> *</span>
<span class="cm"> * close_lru holds (open) stateowner queue ordered by nfs4_stateowner.so_time</span>
<span class="cm"> * for last close replay.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span>	<span class="n">reclaim_str_hashtbl</span><span class="p">[</span><span class="n">CLIENT_HASH_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reclaim_str_hashtbl_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span>	<span class="n">conf_id_hashtbl</span><span class="p">[</span><span class="n">CLIENT_HASH_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span>	<span class="n">conf_str_hashtbl</span><span class="p">[</span><span class="n">CLIENT_HASH_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span>	<span class="n">unconf_str_hashtbl</span><span class="p">[</span><span class="n">CLIENT_HASH_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span>	<span class="n">unconf_id_hashtbl</span><span class="p">[</span><span class="n">CLIENT_HASH_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">client_lru</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">close_lru</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * We store the NONE, READ, WRITE, and BOTH bits separately in the</span>
<span class="cm"> * st_{access,deny}_bmap field of the stateid, in order to track not</span>
<span class="cm"> * only what share bits are currently in force, but also what</span>
<span class="cm"> * combinations of share bits previous opens have used.  This allows us</span>
<span class="cm"> * to enforce the recommendation of rfc 3530 14.2.19 that the server</span>
<span class="cm"> * return an error if the client attempt to downgrade to a combination</span>
<span class="cm"> * of share bits not explicable by closing some of its previous opens.</span>
<span class="cm"> *</span>
<span class="cm"> * XXX: This enforcement is actually incomplete, since we don&#39;t keep</span>
<span class="cm"> * track of access/deny bit combinations; so, e.g., we allow:</span>
<span class="cm"> *</span>
<span class="cm"> *	OPEN allow read, deny write</span>
<span class="cm"> *	OPEN allow both, deny none</span>
<span class="cm"> *	DOWNGRADE allow read, deny none</span>
<span class="cm"> *</span>
<span class="cm"> * which we should reject.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">bmap_to_share_mode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bmap</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">access</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmap</span><span class="p">))</span>
			<span class="n">access</span> <span class="o">|=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">access</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">test_share</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">access</span><span class="p">,</span> <span class="n">deny</span><span class="p">;</span>

	<span class="n">access</span> <span class="o">=</span> <span class="n">bmap_to_share_mode</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_access_bmap</span><span class="p">);</span>
	<span class="n">deny</span> <span class="o">=</span> <span class="n">bmap_to_share_mode</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_deny_bmap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">access</span> <span class="o">&amp;</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_deny</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">deny</span> <span class="o">&amp;</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_access</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set share access for a given stateid */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">set_access</span><span class="p">(</span><span class="n">u32</span> <span class="n">access</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">access</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_access_bmap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* clear share access for a given stateid */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">clear_access</span><span class="p">(</span><span class="n">u32</span> <span class="n">access</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">access</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_access_bmap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* test whether a given stateid has access */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span>
<span class="nf">test_access</span><span class="p">(</span><span class="n">u32</span> <span class="n">access</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">access</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_access_bmap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* set share deny for a given stateid */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">set_deny</span><span class="p">(</span><span class="n">u32</span> <span class="n">access</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">access</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_deny_bmap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* clear share deny for a given stateid */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">clear_deny</span><span class="p">(</span><span class="n">u32</span> <span class="n">access</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">access</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_deny_bmap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* test whether a given stateid is denying specific access */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span>
<span class="nf">test_deny</span><span class="p">(</span><span class="n">u32</span> <span class="n">access</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">access</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_deny_bmap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_access_to_omode</span><span class="p">(</span><span class="n">u32</span> <span class="n">access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">access</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_ACCESS_BOTH</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFS4_SHARE_ACCESS_READ</span>:
		<span class="k">return</span> <span class="n">O_RDONLY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_SHARE_ACCESS_WRITE</span>:
		<span class="k">return</span> <span class="n">O_WRONLY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_SHARE_ACCESS_BOTH</span>:
		<span class="k">return</span> <span class="n">O_RDWR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* release all access and file references for a given stateid */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_all_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_access</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">stp</span><span class="p">))</span>
			<span class="n">nfs4_file_put_access</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">,</span>
					     <span class="n">nfs4_access_to_omode</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">clear_access</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unhash_generic_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_perfile</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_perstateowner</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">close_generic_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">release_all_access</span><span class="p">(</span><span class="n">stp</span><span class="p">);</span>
	<span class="n">put_nfs4_file</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">);</span>
	<span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_generic_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">stateid_slab</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_lock_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>

	<span class="n">unhash_generic_stateid</span><span class="p">(</span><span class="n">stp</span><span class="p">);</span>
	<span class="n">unhash_stid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">);</span>
	<span class="n">file</span> <span class="o">=</span> <span class="n">find_any_file</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span>
		<span class="n">locks_remove_posix</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="p">(</span><span class="n">fl_owner_t</span><span class="p">)</span><span class="n">lockowner</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="p">));</span>
	<span class="n">close_generic_stateid</span><span class="p">(</span><span class="n">stp</span><span class="p">);</span>
	<span class="n">free_generic_stateid</span><span class="p">(</span><span class="n">stp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unhash_lockowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">;</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_strhash</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_perstateid</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner_ino_hash</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_stateids</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">stp</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_stateids</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span><span class="p">,</span> <span class="n">st_perstateowner</span><span class="p">);</span>
		<span class="n">release_lock_stateid</span><span class="p">(</span><span class="n">stp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_lockowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unhash_lockowner</span><span class="p">(</span><span class="n">lo</span><span class="p">);</span>
	<span class="n">nfs4_free_lockowner</span><span class="p">(</span><span class="n">lo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_stateid_lockowners</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">open_stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lo</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open_stp</span><span class="o">-&gt;</span><span class="n">st_lockowners</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lo</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">open_stp</span><span class="o">-&gt;</span><span class="n">st_lockowners</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nfs4_lockowner</span><span class="p">,</span> <span class="n">lo_perstateid</span><span class="p">);</span>
		<span class="n">release_lockowner</span><span class="p">(</span><span class="n">lo</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unhash_open_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unhash_generic_stateid</span><span class="p">(</span><span class="n">stp</span><span class="p">);</span>
	<span class="n">release_stateid_lockowners</span><span class="p">(</span><span class="n">stp</span><span class="p">);</span>
	<span class="n">close_generic_stateid</span><span class="p">(</span><span class="n">stp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_open_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unhash_open_stateid</span><span class="p">(</span><span class="n">stp</span><span class="p">);</span>
	<span class="n">unhash_stid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">);</span>
	<span class="n">free_generic_stateid</span><span class="p">(</span><span class="n">stp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unhash_openowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">;</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_strhash</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_perclient</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_stateids</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">stp</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_stateids</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span><span class="p">,</span> <span class="n">st_perstateowner</span><span class="p">);</span>
		<span class="n">release_open_stateid</span><span class="p">(</span><span class="n">stp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_last_closed_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_last_closed_stid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unhash_stid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">);</span>
		<span class="n">free_generic_stateid</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_last_closed_stid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_openowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unhash_openowner</span><span class="p">(</span><span class="n">oo</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_close_lru</span><span class="p">);</span>
	<span class="n">release_last_closed_stateid</span><span class="p">(</span><span class="n">oo</span><span class="p">);</span>
	<span class="n">nfs4_free_openowner</span><span class="p">(</span><span class="n">oo</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SESSION_HASH_SIZE	512</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">sessionid_hashtbl</span><span class="p">[</span><span class="n">SESSION_HASH_SIZE</span><span class="p">];</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">hash_sessionid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_sessionid</span> <span class="o">*</span><span class="n">sessionid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_sessionid</span> <span class="o">*</span><span class="n">sid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_sessionid</span> <span class="o">*</span><span class="p">)</span><span class="n">sessionid</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sid</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">%</span> <span class="n">SESSION_HASH_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef NFSD_DEBUG</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">dump_sessionid</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_sessionid</span> <span class="o">*</span><span class="n">sessionid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">sessionid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: %u:%u:%u:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">dump_sessionid</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_sessionid</span> <span class="o">*</span><span class="n">sessionid</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gen_sessionid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_sessionid</span> <span class="o">*</span><span class="n">sid</span><span class="p">;</span>

	<span class="n">sid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_sessionid</span> <span class="o">*</span><span class="p">)</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_sessionid</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="n">sid</span><span class="o">-&gt;</span><span class="n">clientid</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">;</span>
	<span class="n">sid</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">current_sessionid</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sid</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The protocol defines ca_maxresponssize_cached to include the size of</span>
<span class="cm"> * the rpc header, but all we need to cache is the data starting after</span>
<span class="cm"> * the end of the initial SEQUENCE operation--the rest we regenerate</span>
<span class="cm"> * each time.  Therefore we can advertise a ca_maxresponssize_cached</span>
<span class="cm"> * value that is the number of bytes in our cache plus a few additional</span>
<span class="cm"> * bytes.  In order to stay on the safe side, and not promise more than</span>
<span class="cm"> * we can cache, those additional bytes must be the minimum possible: 24</span>
<span class="cm"> * bytes of rpc header (xid through accept state, with AUTH_NULL</span>
<span class="cm"> * verifier), 12 for the compound header (with zero-length tag), and 44</span>
<span class="cm"> * for the SEQUENCE op response:</span>
<span class="cm"> */</span>
<span class="cp">#define NFSD_MIN_HDR_SEQ_SZ  (24 + 12 + 44)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">free_session_slots</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_fchannel</span><span class="p">.</span><span class="n">maxreqs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_slots</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We don&#39;t actually need to cache the rpc and session headers, so we</span>
<span class="cm"> * can allocate a little less for each slot:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">slot_bytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_channel_attrs</span> <span class="o">*</span><span class="n">ca</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">maxresp_cached</span> <span class="o">-</span> <span class="n">NFSD_MIN_HDR_SEQ_SZ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfsd4_sanitize_slot_size</span><span class="p">(</span><span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">NFSD_MIN_HDR_SEQ_SZ</span><span class="p">;</span> <span class="cm">/* We don&#39;t cache the rpc header */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">NFSD_SLOT_CACHE_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * XXX: If we run out of reserved DRC memory we could (up to a point)</span>
<span class="cm"> * re-negotiate active sessions and reduce their slot usage to make</span>
<span class="cm"> * room for new connections. For now we just fail the create session.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfsd4_get_drc_mem</span><span class="p">(</span><span class="kt">int</span> <span class="n">slotsize</span><span class="p">,</span> <span class="n">u32</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">avail</span><span class="p">;</span>

	<span class="n">num</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">NFSD_MAX_SLOTS_PER_SESSION</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsd_drc_lock</span><span class="p">);</span>
	<span class="n">avail</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">NFSD_MAX_MEM_PER_SESSION</span><span class="p">,</span>
			<span class="n">nfsd_drc_max_mem</span> <span class="o">-</span> <span class="n">nfsd_drc_mem_used</span><span class="p">);</span>
	<span class="n">num</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">avail</span> <span class="o">/</span> <span class="n">slotsize</span><span class="p">);</span>
	<span class="n">nfsd_drc_mem_used</span> <span class="o">+=</span> <span class="n">num</span> <span class="o">*</span> <span class="n">slotsize</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsd_drc_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd4_put_drc_mem</span><span class="p">(</span><span class="kt">int</span> <span class="n">slotsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsd_drc_lock</span><span class="p">);</span>
	<span class="n">nfsd_drc_mem_used</span> <span class="o">-=</span> <span class="n">slotsize</span> <span class="o">*</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsd_drc_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="nf">alloc_session</span><span class="p">(</span><span class="kt">int</span> <span class="n">slotsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numslots</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mem</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">NFSD_MAX_SLOTS_PER_SESSION</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_slot</span> <span class="o">*</span><span class="p">)</span>
			<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_session</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">mem</span> <span class="o">=</span> <span class="n">numslots</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_slot</span> <span class="o">*</span><span class="p">);</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">)</span> <span class="o">+</span> <span class="n">mem</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* allocate each struct nfsd4_slot and data cache in one piece */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numslots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_slot</span><span class="p">)</span> <span class="o">+</span> <span class="n">slotsize</span><span class="p">;</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">se_slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">se_slots</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">se_slots</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_forechannel_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_channel_attrs</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_channel_attrs</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numslots</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slotsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">maxrpc</span> <span class="o">=</span> <span class="n">nfsd_serv</span><span class="o">-&gt;</span><span class="n">sv_max_mesg</span><span class="p">;</span>

	<span class="n">new</span><span class="o">-&gt;</span><span class="n">maxreqs</span> <span class="o">=</span> <span class="n">numslots</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">maxresp_cached</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">maxresp_cached</span><span class="p">,</span>
					<span class="n">slotsize</span> <span class="o">+</span> <span class="n">NFSD_MIN_HDR_SEQ_SZ</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">maxreq_sz</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">maxreq_sz</span><span class="p">,</span> <span class="n">maxrpc</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">maxresp_sz</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">maxresp_sz</span><span class="p">,</span> <span class="n">maxrpc</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">maxops</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">maxops</span><span class="p">,</span> <span class="n">NFSD_MAX_OPS_PER_COMPOUND</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_conn</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">svc_xprt_put</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cn_xprt</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd4_conn_lost</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xpt_user</span> <span class="o">*</span><span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_conn</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_conn</span><span class="p">,</span> <span class="n">cn_xpt_user</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">cn_session</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cn_persession</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cn_persession</span><span class="p">);</span>
		<span class="n">free_conn</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">nfsd4_probe_callback</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfsd4_conn</span> <span class="o">*</span><span class="nf">alloc_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_conn</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">svc_xprt_get</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">);</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">cn_xprt</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">cn_flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cn_xpt_user</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">conn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__nfsd4_hash_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">cn_session</span> <span class="o">=</span> <span class="n">ses</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cn_persession</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_conns</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd4_hash_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">__nfsd4_hash_conn</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ses</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfsd4_register_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">cn_xpt_user</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">nfsd4_conn_lost</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">register_xpt_user</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cn_xprt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cn_xpt_user</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_new_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">alloc_conn</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>
	<span class="n">nfsd4_hash_conn</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ses</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfsd4_register_conn</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="cm">/* oops; xprt is already down: */</span>
		<span class="n">nfsd4_conn_lost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cn_xpt_user</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_new_conn_from_crses</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">NFS4_CDFC4_FORE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_flags</span> <span class="o">&amp;</span> <span class="n">SESSION4_BACK_CHAN</span><span class="p">)</span>
		<span class="n">dir</span> <span class="o">|=</span> <span class="n">NFS4_CDFC4_BACK</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nfsd4_new_conn</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* must be called under client_lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd4_del_conns</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_conn</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">se_conns</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">se_conns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_conn</span><span class="p">,</span> <span class="n">cn_persession</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cn_persession</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>

		<span class="n">unregister_xpt_user</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cn_xprt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cn_xpt_user</span><span class="p">);</span>
		<span class="n">free_conn</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mem</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="n">ses</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_session</span><span class="p">,</span> <span class="n">se_ref</span><span class="p">);</span>
	<span class="n">nfsd4_del_conns</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsd_drc_lock</span><span class="p">);</span>
	<span class="n">mem</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_fchannel</span><span class="p">.</span><span class="n">maxreqs</span> <span class="o">*</span> <span class="n">slot_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_fchannel</span><span class="p">);</span>
	<span class="n">nfsd_drc_mem_used</span> <span class="o">-=</span> <span class="n">mem</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsd_drc_lock</span><span class="p">);</span>
	<span class="n">free_session_slots</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfsd4_put_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="n">nfsd4_put_session_locked</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="nf">alloc_init_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_create_session</span> <span class="o">*</span><span class="n">cses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_channel_attrs</span> <span class="o">*</span><span class="n">fchan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cses</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numslots</span><span class="p">,</span> <span class="n">slotsize</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note decreasing slot size below client&#39;s request may</span>
<span class="cm">	 * make it difficult for client to function correctly, whereas</span>
<span class="cm">	 * decreasing the number of slots will (just?) affect</span>
<span class="cm">	 * performance.  When short on memory we therefore prefer to</span>
<span class="cm">	 * decrease number of slots instead of their size.</span>
<span class="cm">	 */</span>
	<span class="n">slotsize</span> <span class="o">=</span> <span class="n">nfsd4_sanitize_slot_size</span><span class="p">(</span><span class="n">fchan</span><span class="o">-&gt;</span><span class="n">maxresp_cached</span><span class="p">);</span>
	<span class="n">numslots</span> <span class="o">=</span> <span class="n">nfsd4_get_drc_mem</span><span class="p">(</span><span class="n">slotsize</span><span class="p">,</span> <span class="n">fchan</span><span class="o">-&gt;</span><span class="n">maxreqs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">numslots</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">alloc_session</span><span class="p">(</span><span class="n">slotsize</span><span class="p">,</span> <span class="n">numslots</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfsd4_put_drc_mem</span><span class="p">(</span><span class="n">slotsize</span><span class="p">,</span> <span class="n">fchan</span><span class="o">-&gt;</span><span class="n">maxreqs</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">init_forechannel_attrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">se_fchannel</span><span class="p">,</span> <span class="n">fchan</span><span class="p">,</span> <span class="n">numslots</span><span class="p">,</span> <span class="n">slotsize</span><span class="p">);</span>

	<span class="n">new</span><span class="o">-&gt;</span><span class="n">se_client</span> <span class="o">=</span> <span class="n">clp</span><span class="p">;</span>
	<span class="n">gen_sessionid</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">se_conns</span><span class="p">);</span>

	<span class="n">new</span><span class="o">-&gt;</span><span class="n">se_cb_seq_nr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">se_flags</span> <span class="o">=</span> <span class="n">cses</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">se_cb_prog</span> <span class="o">=</span> <span class="n">cses</span><span class="o">-&gt;</span><span class="n">callback_prog</span><span class="p">;</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">se_ref</span><span class="p">);</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">hash_sessionid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">se_sessionid</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">se_hash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sessionid_hashtbl</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">se_perclnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_sessions</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_new_conn_from_crses</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="cm">/* whoops: benny points out, status is ignored! (err, or bogus) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
		<span class="n">free_session</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">se_ref</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SESSION4_BACK_CHAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="n">svc_addr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is a little silly; with sessions there&#39;s no real</span>
<span class="cm">		 * use for the callback address.  Use the peer address</span>
<span class="cm">		 * as a reasonable default for now, but consider fixing</span>
<span class="cm">		 * the rpc client not to require an address in the</span>
<span class="cm">		 * future:</span>
<span class="cm">		 */</span>
		<span class="n">rpc_copy_addr</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_conn</span><span class="p">.</span><span class="n">cb_addr</span><span class="p">,</span> <span class="n">sa</span><span class="p">);</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_conn</span><span class="p">.</span><span class="n">cb_addrlen</span> <span class="o">=</span> <span class="n">svc_addr_len</span><span class="p">(</span><span class="n">sa</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nfsd4_probe_callback</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* caller must hold client_lock */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span>
<span class="nf">find_in_sessionid_hashtbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_sessionid</span> <span class="o">*</span><span class="n">sessionid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">elem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">dump_sessionid</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="n">sessionid</span><span class="p">);</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">hash_sessionid</span><span class="p">(</span><span class="n">sessionid</span><span class="p">);</span>
	<span class="cm">/* Search in the appropriate list */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sessionid_hashtbl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">se_hash</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">se_sessionid</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">sessionid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			    <span class="n">NFS4_MAX_SESSIONID_LEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">elem</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: session not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* caller must hold client_lock */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">unhash_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_hash</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_perclnt</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* must be called under the client_lock */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">renew_client_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_client_expired</span><span class="p">(</span><span class="n">clp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: client (clientid %08x/%08x) already expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_boot</span><span class="p">,</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;renewing client (clientid %08x/%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_boot</span><span class="p">,</span> 
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span><span class="p">);</span>
	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_lru</span><span class="p">);</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_time</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">renew_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="n">renew_client_locked</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* SETCLIENTID and SETCLIENTID_CONFIRM Helper functions */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">STALE_CLIENTID</span><span class="p">(</span><span class="n">clientid_t</span> <span class="o">*</span><span class="n">clid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_boot</span> <span class="o">==</span> <span class="n">boot_time</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD stale clientid (%08x/%08x) boot_time %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_boot</span><span class="p">,</span> <span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">,</span> <span class="n">boot_time</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> * XXX Should we use a slab cache ?</span>
<span class="cm"> * This type of memory management is somewhat inefficient, but we use it</span>
<span class="cm"> * anyway since SETCLIENTID is not a common operation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="nf">alloc_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>

	<span class="n">clp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_name</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_name</span><span class="p">.</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_name</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">free_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_sessions</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">;</span>
		<span class="n">ses</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_sessions</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_session</span><span class="p">,</span>
				<span class="n">se_perclnt</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_perclnt</span><span class="p">);</span>
		<span class="n">nfsd4_put_session_locked</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free_svc_cred</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cred</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_name</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">release_session_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_refcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_lock</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_client_expired</span><span class="p">(</span><span class="n">clp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">se_client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">renew_client_locked</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* must be called under the client_lock */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">unhash_client_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">;</span>

	<span class="n">mark_client_expired</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lru</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_sessions</span><span class="p">,</span> <span class="n">se_perclnt</span><span class="p">)</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_hash</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">expire_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">reaplist</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reaplist</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_delegations</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_delegations</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_delegation</span><span class="p">,</span> <span class="n">dl_perclnt</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_perclnt</span><span class="p">);</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_recall_lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reaplist</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reaplist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">reaplist</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_delegation</span><span class="p">,</span> <span class="n">dl_recall_lru</span><span class="p">);</span>
		<span class="n">unhash_delegation</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_openowners</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">oo</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_openowners</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_openowner</span><span class="p">,</span> <span class="n">oo_perclient</span><span class="p">);</span>
		<span class="n">release_openowner</span><span class="p">(</span><span class="n">oo</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nfsd4_shutdown_callback</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_conn</span><span class="p">.</span><span class="n">cb_xprt</span><span class="p">)</span>
		<span class="n">svc_xprt_put</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_conn</span><span class="p">.</span><span class="n">cb_xprt</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_idhash</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_strhash</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="n">unhash_client_locked</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_refcount</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_verf</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="n">nfs4_verifier</span> <span class="o">*</span><span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cl_verifier</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cl_verifier</span><span class="p">.</span><span class="n">data</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_clid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_boot</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_boot</span><span class="p">;</span> 
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span><span class="p">;</span> 
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_cred</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_cred</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_cred</span> <span class="o">*</span><span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">cr_principal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">cr_principal</span> <span class="o">=</span>
				<span class="n">kstrdup</span><span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">cr_principal</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cr_principal</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">cr_principal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">cr_flavor</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">cr_flavor</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">cr_uid</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">cr_uid</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">cr_gid</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">cr_gid</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">cr_group_info</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">cr_group_info</span><span class="p">;</span>
	<span class="n">get_group_info</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cr_group_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">same_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">n1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">n2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">HEXDIR_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">same_verf</span><span class="p">(</span><span class="n">nfs4_verifier</span> <span class="o">*</span><span class="n">v1</span><span class="p">,</span> <span class="n">nfs4_verifier</span> <span class="o">*</span><span class="n">v2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">v2</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">same_clid</span><span class="p">(</span><span class="n">clientid_t</span> <span class="o">*</span><span class="n">cl1</span><span class="p">,</span> <span class="n">clientid_t</span> <span class="o">*</span><span class="n">cl2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">cl1</span><span class="o">-&gt;</span><span class="n">cl_boot</span> <span class="o">==</span> <span class="n">cl2</span><span class="o">-&gt;</span><span class="n">cl_boot</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cl1</span><span class="o">-&gt;</span><span class="n">cl_id</span> <span class="o">==</span> <span class="n">cl2</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">groups_equal</span><span class="p">(</span><span class="k">struct</span> <span class="n">group_info</span> <span class="o">*</span><span class="n">g1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">group_info</span> <span class="o">*</span><span class="n">g2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">g1</span><span class="o">-&gt;</span><span class="n">ngroups</span> <span class="o">!=</span> <span class="n">g2</span><span class="o">-&gt;</span><span class="n">ngroups</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">g1</span><span class="o">-&gt;</span><span class="n">ngroups</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GROUP_AT</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GROUP_AT</span><span class="p">(</span><span class="n">g2</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">same_creds</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_cred</span> <span class="o">*</span><span class="n">cr1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_cred</span> <span class="o">*</span><span class="n">cr2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cr1</span><span class="o">-&gt;</span><span class="n">cr_flavor</span> <span class="o">!=</span> <span class="n">cr2</span><span class="o">-&gt;</span><span class="n">cr_flavor</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">cr1</span><span class="o">-&gt;</span><span class="n">cr_uid</span> <span class="o">!=</span> <span class="n">cr2</span><span class="o">-&gt;</span><span class="n">cr_uid</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">cr1</span><span class="o">-&gt;</span><span class="n">cr_gid</span> <span class="o">!=</span> <span class="n">cr2</span><span class="o">-&gt;</span><span class="n">cr_gid</span><span class="p">)</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">groups_equal</span><span class="p">(</span><span class="n">cr1</span><span class="o">-&gt;</span><span class="n">cr_group_info</span><span class="p">,</span> <span class="n">cr2</span><span class="o">-&gt;</span><span class="n">cr_group_info</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cr1</span><span class="o">-&gt;</span><span class="n">cr_principal</span> <span class="o">==</span> <span class="n">cr2</span><span class="o">-&gt;</span><span class="n">cr_principal</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cr1</span><span class="o">-&gt;</span><span class="n">cr_principal</span> <span class="o">||</span> <span class="o">!</span><span class="n">cr2</span><span class="o">-&gt;</span><span class="n">cr_principal</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">cr1</span><span class="o">-&gt;</span><span class="n">cr_principal</span><span class="p">,</span> <span class="n">cr1</span><span class="o">-&gt;</span><span class="n">cr_principal</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gen_clid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">current_clientid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_boot</span> <span class="o">=</span> <span class="n">boot_time</span><span class="p">;</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span> <span class="o">=</span> <span class="n">current_clientid</span><span class="o">++</span><span class="p">;</span> 
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gen_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">verf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">verf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span><span class="p">)</span><span class="n">get_seconds</span><span class="p">();</span>
	<span class="n">verf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span><span class="p">)</span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_confirm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">verf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_confirm</span><span class="p">.</span><span class="n">data</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_stid</span> <span class="o">*</span><span class="nf">find_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="n">stateid_t</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">cl_stateids</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">si_opaque</span><span class="p">.</span><span class="n">so_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_stid</span> <span class="o">*</span><span class="nf">find_stateid_by_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="n">stateid_t</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">char</span> <span class="n">typemask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_stid</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">find_stateid</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">typemask</span> <span class="o">&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sc_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="nf">create_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">recdir</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">nfs4_verifier</span> <span class="o">*</span><span class="n">verf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="n">svc_addr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">clp</span> <span class="o">=</span> <span class="n">alloc_client</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_sessions</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_cred</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
		<span class="n">free_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_stateids</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_recdir</span><span class="p">,</span> <span class="n">recdir</span><span class="p">,</span> <span class="n">HEXDIR_LEN</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_refcount</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_state</span> <span class="o">=</span> <span class="n">NFSD4_CB_UNKNOWN</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_idhash</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_strhash</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_openowners</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_delegations</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lru</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_callbacks</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_null</span><span class="p">.</span><span class="n">cb_work</span><span class="p">,</span> <span class="n">nfsd4_do_callback_rpc</span><span class="p">);</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_time</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_slot_busy</span><span class="p">);</span>
	<span class="n">rpc_init_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_waitq</span><span class="p">,</span> <span class="s">&quot;Backchannel slot table&quot;</span><span class="p">);</span>
	<span class="n">copy_verf</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">verf</span><span class="p">);</span>
	<span class="n">rpc_copy_addr</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_addr</span><span class="p">,</span> <span class="n">sa</span><span class="p">);</span>
	<span class="n">gen_confirm</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">add_to_unconfirmed</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">strhashval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idhashval</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_strhash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unconf_str_hashtbl</span><span class="p">[</span><span class="n">strhashval</span><span class="p">]);</span>
	<span class="n">idhashval</span> <span class="o">=</span> <span class="n">clientid_hashval</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_idhash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unconf_id_hashtbl</span><span class="p">[</span><span class="n">idhashval</span><span class="p">]);</span>
	<span class="n">renew_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">move_to_confirmed</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idhashval</span> <span class="o">=</span> <span class="n">clientid_hashval</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">strhashval</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: move_to_confirm nfs4_client %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clp</span><span class="p">);</span>
	<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_idhash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_id_hashtbl</span><span class="p">[</span><span class="n">idhashval</span><span class="p">]);</span>
	<span class="n">strhashval</span> <span class="o">=</span> <span class="n">clientstr_hashval</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_recdir</span><span class="p">);</span>
	<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_strhash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_str_hashtbl</span><span class="p">[</span><span class="n">strhashval</span><span class="p">]);</span>
	<span class="n">renew_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span>
<span class="nf">find_confirmed_client</span><span class="p">(</span><span class="n">clientid_t</span> <span class="o">*</span><span class="n">clid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idhashval</span> <span class="o">=</span> <span class="n">clientid_hashval</span><span class="p">(</span><span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_id_hashtbl</span><span class="p">[</span><span class="n">idhashval</span><span class="p">],</span> <span class="n">cl_idhash</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">same_clid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">,</span> <span class="n">clid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">renew_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span>
<span class="nf">find_unconfirmed_client</span><span class="p">(</span><span class="n">clientid_t</span> <span class="o">*</span><span class="n">clid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idhashval</span> <span class="o">=</span> <span class="n">clientid_hashval</span><span class="p">(</span><span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unconf_id_hashtbl</span><span class="p">[</span><span class="n">idhashval</span><span class="p">],</span> <span class="n">cl_idhash</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">same_clid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">,</span> <span class="n">clid</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">clp_used_exchangeid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_exchange_flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> 

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span>
<span class="nf">find_confirmed_client_by_str</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dname</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hashval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_str_hashtbl</span><span class="p">[</span><span class="n">hashval</span><span class="p">],</span> <span class="n">cl_strhash</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">same_name</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_recdir</span><span class="p">,</span> <span class="n">dname</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span>
<span class="nf">find_unconfirmed_client_by_str</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dname</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hashval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unconf_str_hashtbl</span><span class="p">[</span><span class="n">hashval</span><span class="p">],</span> <span class="n">cl_strhash</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">same_name</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_recdir</span><span class="p">,</span> <span class="n">dname</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gen_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_setclientid</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_cb_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span>	<span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="n">svc_addr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">scopeid</span> <span class="o">=</span> <span class="n">rpc_get_scope_id</span><span class="p">(</span><span class="n">sa</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">expected_family</span><span class="p">;</span>

	<span class="cm">/* Currently, we only support tcp and tcp6 for the callback channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">se_callback_netid_len</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">se_callback_netid_val</span><span class="p">,</span> <span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">expected_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">se_callback_netid_len</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
		 <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">se_callback_netid_val</span><span class="p">,</span> <span class="s">&quot;tcp6&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">expected_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">cb_addrlen</span> <span class="o">=</span> <span class="n">rpc_uaddr2sockaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">se</span><span class="o">-&gt;</span><span class="n">se_callback_addr_val</span><span class="p">,</span>
					    <span class="n">se</span><span class="o">-&gt;</span><span class="n">se_callback_addr_len</span><span class="p">,</span>
					    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cb_addr</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cb_addr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cb_addrlen</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">cb_addr</span><span class="p">.</span><span class="n">ss_family</span> <span class="o">!=</span> <span class="n">expected_family</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cb_addr</span><span class="p">.</span><span class="n">ss_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span>
		<span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cb_addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_scope_id</span> <span class="o">=</span> <span class="n">scopeid</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">cb_prog</span> <span class="o">=</span> <span class="n">se</span><span class="o">-&gt;</span><span class="n">se_callback_prog</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">cb_ident</span> <span class="o">=</span> <span class="n">se</span><span class="o">-&gt;</span><span class="n">se_callback_ident</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cb_saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_daddr</span><span class="p">,</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_daddrlen</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">out_err:</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">cb_addr</span><span class="p">.</span><span class="n">ss_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">cb_addrlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NFSD: this client (clientid %08x/%08x) &quot;</span>
		<span class="s">&quot;will not receive delegations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_boot</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cache a reply. nfsd4_check_drc_limit() has bounded the cache size.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">nfsd4_store_cache_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">slot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s slot %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_opcnt</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_status</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_flags</span> <span class="o">|=</span> <span class="n">NFSD4_SLOT_INITIALIZED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfsd4_not_cached</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_datalen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_datalen</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">datap</span><span class="p">;</span>
	<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">datap</span> <span class="o">-</span>
					<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_bytes_from_xdr_buf</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_data</span><span class="p">,</span>
				    <span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_datalen</span><span class="p">))</span>
		<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;%s: sessions DRC could not cache compound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Encode the replay sequence operation from the slot values.</span>
<span class="cm"> * If cachethis is FALSE encode the uncached rep error on the next</span>
<span class="cm"> * operation which sets resp-&gt;p and increments resp-&gt;opcnt for</span>
<span class="cm"> * nfs4svc_encode_compoundres.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_enc_sequence_replay</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">slot</span><span class="p">;</span>

	<span class="cm">/* Encode the replayed sequence operation */</span>
	<span class="n">op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">nfsd4_encode_operation</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>

	<span class="cm">/* Return nfserr_retry_uncached_rep in next operation. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_flags</span> <span class="o">&amp;</span> <span class="n">NFSD4_SLOT_CACHETHIS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span><span class="o">++</span><span class="p">];</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_retry_uncached_rep</span><span class="p">;</span>
		<span class="n">nfsd4_encode_operation</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The sequence operation is not cached because we can use the slot and</span>
<span class="cm"> * session values.</span>
<span class="cm"> */</span>
<span class="n">__be32</span>
<span class="nf">nfsd4_replay_cache_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">nfsd4_sequence</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">slot</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s slot %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="cm">/* Either returns 0 or nfserr_retry_uncached */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_enc_sequence_replay</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_argp</span><span class="p">,</span> <span class="n">resp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_retry_uncached_rep</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* The sequence operation has been encoded, cstate-&gt;datap set. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">datap</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_data</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_datalen</span><span class="p">);</span>

	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_opcnt</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">datap</span> <span class="o">+</span> <span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_datalen</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_status</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the exchange_id flags returned by the server.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfsd4_set_ex_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_exchange_id</span> <span class="o">*</span><span class="n">clid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* pNFS is not supported */</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">cl_exchange_flags</span> <span class="o">|=</span> <span class="n">EXCHGID4_FLAG_USE_NON_PNFS</span><span class="p">;</span>

	<span class="cm">/* Referrals are supported, Migration is not. */</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">cl_exchange_flags</span> <span class="o">|=</span> <span class="n">EXCHGID4_FLAG_SUPP_MOVED_REFER</span><span class="p">;</span>

	<span class="cm">/* set the wire flags to return to client. */</span>
	<span class="n">clid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cl_exchange_flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">client_has_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Note clp-&gt;cl_openowners check isn&#39;t quite right: there&#39;s no</span>
<span class="cm">	 * need to count owners without stateid&#39;s.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Also note we should probably be using this in 4.0 case too.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_openowners</span><span class="p">)</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_delegations</span><span class="p">)</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_sessions</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_exchange_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">nfsd4_exchange_id</span> <span class="o">*</span><span class="n">exid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">unconf</span><span class="p">,</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">strhashval</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">dname</span><span class="p">[</span><span class="n">HEXDIR_LEN</span><span class="p">];</span>
	<span class="kt">char</span>			<span class="n">addr_str</span><span class="p">[</span><span class="n">INET6_ADDRSTRLEN</span><span class="p">];</span>
	<span class="n">nfs4_verifier</span>		<span class="n">verf</span> <span class="o">=</span> <span class="n">exid</span><span class="o">-&gt;</span><span class="n">verifier</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span>		<span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="n">svc_addr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>
	<span class="n">bool</span>	<span class="n">update</span> <span class="o">=</span> <span class="n">exid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EXCHGID4_FLAG_UPD_CONFIRMED_REC_A</span><span class="p">;</span>

	<span class="n">rpc_ntop</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">addr_str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr_str</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s rqstp=%p exid=%p clname.len=%u clname.data=%p &quot;</span>
		<span class="s">&quot;ip_addr=%s flags %x, spa_how %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="n">exid</span><span class="p">,</span> <span class="n">exid</span><span class="o">-&gt;</span><span class="n">clname</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">exid</span><span class="o">-&gt;</span><span class="n">clname</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
		<span class="n">addr_str</span><span class="p">,</span> <span class="n">exid</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">exid</span><span class="o">-&gt;</span><span class="n">spa_how</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">exid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EXCHGID4_FLAG_MASK_A</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>

	<span class="cm">/* Currently only support SP4_NONE */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">exid</span><span class="o">-&gt;</span><span class="n">spa_how</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SP4_NONE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SP4_SSV</span>:
		<span class="k">return</span> <span class="n">nfserr_serverfault</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>				<span class="cm">/* checked by xdr code */</span>
	<span class="k">case</span> <span class="n">SP4_MACH_CRED</span>:
		<span class="k">return</span> <span class="n">nfserr_serverfault</span><span class="p">;</span>	<span class="cm">/* no excuse :-/ */</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_make_rec_clidname</span><span class="p">(</span><span class="n">dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exid</span><span class="o">-&gt;</span><span class="n">clname</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">strhashval</span> <span class="o">=</span> <span class="n">clientstr_hashval</span><span class="p">(</span><span class="n">dname</span><span class="p">);</span>

	<span class="cm">/* Cases below refer to rfc 5661 section 18.35.4: */</span>
	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">conf</span> <span class="o">=</span> <span class="n">find_confirmed_client_by_str</span><span class="p">(</span><span class="n">dname</span><span class="p">,</span> <span class="n">strhashval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">creds_match</span> <span class="o">=</span> <span class="n">same_creds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cl_cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">);</span>
		<span class="n">bool</span> <span class="n">verfs_match</span> <span class="o">=</span> <span class="n">same_verf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">verf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cl_verifier</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">update</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clp_used_exchangeid</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* buggy client */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_inval</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">creds_match</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* case 9 */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_perm</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">verfs_match</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* case 8 */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_not_same</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* case 6 */</span>
			<span class="n">exid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EXCHGID4_FLAG_CONFIRMED_R</span><span class="p">;</span>
			<span class="n">new</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_copy</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">creds_match</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* case 3 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">client_has_state</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_clid_inuse</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">expire_client</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_new</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">verfs_match</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* case 2 */</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">cl_exchange_flags</span> <span class="o">|=</span> <span class="n">EXCHGID4_FLAG_CONFIRMED_R</span><span class="p">;</span>
			<span class="n">new</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_copy</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* case 5, client reboot */</span>
		<span class="k">goto</span> <span class="n">out_new</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">update</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* case 7 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_noent</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">unconf</span>  <span class="o">=</span> <span class="n">find_unconfirmed_client_by_str</span><span class="p">(</span><span class="n">dname</span><span class="p">,</span> <span class="n">strhashval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unconf</span><span class="p">)</span> <span class="cm">/* case 4, possible retry or client restart */</span>
		<span class="n">expire_client</span><span class="p">(</span><span class="n">unconf</span><span class="p">);</span>

	<span class="cm">/* case 1 (normal case) */</span>
<span class="nl">out_new:</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">create_client</span><span class="p">(</span><span class="n">exid</span><span class="o">-&gt;</span><span class="n">clname</span><span class="p">,</span> <span class="n">dname</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">verf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gen_clid</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
	<span class="n">add_to_unconfirmed</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">strhashval</span><span class="p">);</span>
<span class="nl">out_copy:</span>
	<span class="n">exid</span><span class="o">-&gt;</span><span class="n">clientid</span><span class="p">.</span><span class="n">cl_boot</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_boot</span><span class="p">;</span>
	<span class="n">exid</span><span class="o">-&gt;</span><span class="n">clientid</span><span class="p">.</span><span class="n">cl_id</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span><span class="p">;</span>

	<span class="n">exid</span><span class="o">-&gt;</span><span class="n">seqid</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cl_cs_slot</span><span class="p">.</span><span class="n">sl_seqid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nfsd4_set_ex_flags</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">exid</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsd4_exchange_id seqid %d flags %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">cl_cs_slot</span><span class="p">.</span><span class="n">sl_seqid</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cl_exchange_flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">check_slot_seqid</span><span class="p">(</span><span class="n">u32</span> <span class="n">seqid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">slot_seqid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot_inuse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter. seqid %d slot_seqid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">seqid</span><span class="p">,</span>
		<span class="n">slot_seqid</span><span class="p">);</span>

	<span class="cm">/* The slot is in use, and no response has been sent. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot_inuse</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seqid</span> <span class="o">==</span> <span class="n">slot_seqid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">nfserr_seq_misordered</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Note unsigned 32-bit arithmetic handles wraparound: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">seqid</span> <span class="o">==</span> <span class="n">slot_seqid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seqid</span> <span class="o">==</span> <span class="n">slot_seqid</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_replay_cache</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfserr_seq_misordered</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cache the create session result into the create session single DRC</span>
<span class="cm"> * slot cache by saving the xdr structure. sl_seqid has been set.</span>
<span class="cm"> * Do this for solo or embedded create session operations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfsd4_cache_create_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_create_session</span> <span class="o">*</span><span class="n">cr_ses</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nfsd4_clid_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_status</span> <span class="o">=</span> <span class="n">nfserr</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_cr_ses</span><span class="p">,</span> <span class="n">cr_ses</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cr_ses</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_replay_create_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_create_session</span> <span class="o">*</span><span class="n">cr_ses</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nfsd4_clid_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cr_ses</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_cr_ses</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cr_ses</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NFSD_MIN_REQ_HDR_SEQ_SZ	((\</span>
<span class="cp">			2 * 2 + </span><span class="cm">/* credential,verifier: AUTH_NULL, length 0 */</span><span class="cp"> \</span>
<span class="cp">			1 +	</span><span class="cm">/* MIN tag is length with zero, only length */</span><span class="cp"> \</span>
<span class="cp">			3 +	</span><span class="cm">/* version, opcount, opcode */</span><span class="cp"> \</span>
<span class="cp">			XDR_QUADLEN(NFS4_MAX_SESSIONID_LEN) + \</span>
<span class="cp">				</span><span class="cm">/* seqid, slotID, slotID, cache */</span><span class="cp"> \</span>
<span class="cp">			4 ) * sizeof(__be32))</span>

<span class="cp">#define NFSD_MIN_RESP_HDR_SEQ_SZ ((\</span>
<span class="cp">			2 +	</span><span class="cm">/* verifier: AUTH_NULL, length 0 */</span><span class="cp">\</span>
<span class="cp">			1 +	</span><span class="cm">/* status */</span><span class="cp"> \</span>
<span class="cp">			1 +	</span><span class="cm">/* MIN tag is length with zero, only length */</span><span class="cp"> \</span>
<span class="cp">			3 +	</span><span class="cm">/* opcount, opcode, opstatus*/</span><span class="cp"> \</span>
<span class="cp">			XDR_QUADLEN(NFS4_MAX_SESSIONID_LEN) + \</span>
<span class="cp">				</span><span class="cm">/* seqid, slotID, slotID, slotID, status */</span><span class="cp"> \</span>
<span class="cp">			5 ) * sizeof(__be32))</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">check_forechannel_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_channel_attrs</span> <span class="n">fchannel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fchannel</span><span class="p">.</span><span class="n">maxreq_sz</span> <span class="o">&lt;</span> <span class="n">NFSD_MIN_REQ_HDR_SEQ_SZ</span>
		<span class="o">||</span> <span class="n">fchannel</span><span class="p">.</span><span class="n">maxresp_sz</span> <span class="o">&lt;</span> <span class="n">NFSD_MIN_RESP_HDR_SEQ_SZ</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_create_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nfsd4_create_session</span> <span class="o">*</span><span class="n">cr_ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="n">svc_addr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="o">*</span><span class="n">unconf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_clid_slot</span> <span class="o">*</span><span class="n">cs_slot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">confirm_me</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cr_ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SESSION4_FLAG_MASK_A</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">unconf</span> <span class="o">=</span> <span class="n">find_unconfirmed_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cr_ses</span><span class="o">-&gt;</span><span class="n">clientid</span><span class="p">);</span>
	<span class="n">conf</span> <span class="o">=</span> <span class="n">find_confirmed_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cr_ses</span><span class="o">-&gt;</span><span class="n">clientid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs_slot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cl_cs_slot</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">check_slot_seqid</span><span class="p">(</span><span class="n">cr_ses</span><span class="o">-&gt;</span><span class="n">seqid</span><span class="p">,</span> <span class="n">cs_slot</span><span class="o">-&gt;</span><span class="n">sl_seqid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_replay_cache</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_replay_create_session</span><span class="p">(</span><span class="n">cr_ses</span><span class="p">,</span> <span class="n">cs_slot</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cr_ses</span><span class="o">-&gt;</span><span class="n">seqid</span> <span class="o">!=</span> <span class="n">cs_slot</span><span class="o">-&gt;</span><span class="n">sl_seqid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_seq_misordered</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unconf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">same_creds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unconf</span><span class="o">-&gt;</span><span class="n">cl_cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">rpc_cmp_addr</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">unconf</span><span class="o">-&gt;</span><span class="n">cl_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_clid_inuse</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cs_slot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">unconf</span><span class="o">-&gt;</span><span class="n">cl_cs_slot</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">check_slot_seqid</span><span class="p">(</span><span class="n">cr_ses</span><span class="o">-&gt;</span><span class="n">seqid</span><span class="p">,</span> <span class="n">cs_slot</span><span class="o">-&gt;</span><span class="n">sl_seqid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* an unconfirmed replay returns misordered */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_seq_misordered</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">confirm_me</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">conf</span> <span class="o">=</span> <span class="n">unconf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_stale_clientid</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX: we should probably set this at creation time, and check</span>
<span class="cm">	 * for consistent minorversion use throughout:</span>
<span class="cm">	 */</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">cl_minorversion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We do not support RDMA or persistent sessions</span>
<span class="cm">	 */</span>
	<span class="n">cr_ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SESSION4_PERSIST</span><span class="p">;</span>
	<span class="n">cr_ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SESSION4_RDMA</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_toosmall</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_forechannel_attrs</span><span class="p">(</span><span class="n">cr_ses</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">alloc_init_session</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">cr_ses</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cr_ses</span><span class="o">-&gt;</span><span class="n">sessionid</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">se_sessionid</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
	       <span class="n">NFS4_MAX_SESSIONID_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cr_ses</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">se_fchannel</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_channel_attrs</span><span class="p">));</span>
	<span class="n">cs_slot</span><span class="o">-&gt;</span><span class="n">sl_seqid</span><span class="o">++</span><span class="p">;</span>
	<span class="n">cr_ses</span><span class="o">-&gt;</span><span class="n">seqid</span> <span class="o">=</span> <span class="n">cs_slot</span><span class="o">-&gt;</span><span class="n">sl_seqid</span><span class="p">;</span>

	<span class="cm">/* cache solo and embedded create sessions under the state lock */</span>
	<span class="n">nfsd4_cache_create_session</span><span class="p">(</span><span class="n">cr_ses</span><span class="p">,</span> <span class="n">cs_slot</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">confirm_me</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">clientstr_hashval</span><span class="p">(</span><span class="n">unconf</span><span class="o">-&gt;</span><span class="n">cl_recdir</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span>
			<span class="n">find_confirmed_client_by_str</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cl_recdir</span><span class="p">,</span> <span class="n">hash</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span>
			<span class="n">expire_client</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
		<span class="n">move_to_confirmed</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nfsd4_last_compound_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_argp</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">==</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_map_bcts_dir</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFS4_CDFC4_FORE</span>:
	<span class="k">case</span> <span class="n">NFS4_CDFC4_BACK</span>:
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_CDFC4_FORE_OR_BOTH</span>:
	<span class="k">case</span> <span class="n">NFS4_CDFC4_BACK_OR_BOTH</span>:
		<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">NFS4_CDFC4_BOTH</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span> <span class="nf">nfsd4_bind_conn_to_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nfsd4_bind_conn_to_session</span> <span class="o">*</span><span class="n">bcts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfsd4_last_compound_op</span><span class="p">(</span><span class="n">rqstp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_not_only_op</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">=</span> <span class="n">find_in_sessionid_hashtbl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcts</span><span class="o">-&gt;</span><span class="n">sessionid</span><span class="p">);</span>
	<span class="cm">/* Sorta weird: we only need the refcnt&#39;ing because new_conn acquires</span>
<span class="cm">	 * client_lock iself: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfsd4_get_session</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="o">-&gt;</span><span class="n">cl_refcount</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_badsession</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_map_bcts_dir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcts</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">nfsd4_new_conn</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">,</span> <span class="n">bcts</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nfsd4_compound_in_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_sessionid</span> <span class="o">*</span><span class="n">sid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">session</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">se_sessionid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sid</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_destroy_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">nfsd4_destroy_session</span> <span class="o">*</span><span class="n">sessionid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_badsession</span><span class="p">;</span>

	<span class="cm">/* Notes:</span>
<span class="cm">	 * - The confirmed nfs4_client-&gt;cl_sessionid holds destroyed sessinid</span>
<span class="cm">	 * - Should we return nfserr_back_chan_busy if waiting for</span>
<span class="cm">	 *   callbacks on to-be-destroyed session?</span>
<span class="cm">	 * - Do we need to clear any callback info from previous session?</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfsd4_compound_in_session</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sessionid</span><span class="o">-&gt;</span><span class="n">sessionid</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfsd4_last_compound_op</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">nfserr_not_only_op</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dump_sessionid</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sessionid</span><span class="o">-&gt;</span><span class="n">sessionid</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="n">ses</span> <span class="o">=</span> <span class="n">find_in_sessionid_hashtbl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sessionid</span><span class="o">-&gt;</span><span class="n">sessionid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">unhash_session</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">nfsd4_probe_callback_sync</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="p">);</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="n">nfsd4_del_conns</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
	<span class="n">nfsd4_put_session_locked</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfsd4_conn</span> <span class="o">*</span><span class="nf">__nfsd4_find_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xpt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_conn</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">se_conns</span><span class="p">,</span> <span class="n">cn_persession</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cn_xprt</span> <span class="o">==</span> <span class="n">xpt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd4_sequence_check_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_conn</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_conn</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">__nfsd4_find_conn</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">cn_xprt</span><span class="p">,</span> <span class="n">ses</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
		<span class="n">free_conn</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__nfsd4_hash_conn</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">ses</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfsd4_register_conn</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="cm">/* oops; xprt is already down: */</span>
		<span class="n">nfsd4_conn_lost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">cn_xpt_user</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nfsd4_session_too_many_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_argp</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">&gt;</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">se_fchannel</span><span class="p">.</span><span class="n">maxops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nfsd4_request_too_big</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xdr_buf</span> <span class="o">*</span><span class="n">xb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">xb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">se_fchannel</span><span class="p">.</span><span class="n">maxreq_sz</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">nfsd4_sequence</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_sequence_pos</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Will be either used or freed by nfsd4_sequence_check_conn</span>
<span class="cm">	 * below.</span>
<span class="cm">	 */</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">alloc_conn</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">NFS4_CDFC4_FORE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_badsession</span><span class="p">;</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">find_in_sessionid_hashtbl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">sessionid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">session</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_too_many_ops</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfsd4_session_too_many_ops</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">session</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_req_too_big</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfsd4_request_too_big</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">session</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_badslot</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">slotid</span> <span class="o">&gt;=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">se_fchannel</span><span class="p">.</span><span class="n">maxreqs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">se_slots</span><span class="p">[</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">slotid</span><span class="p">];</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: slotid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">slotid</span><span class="p">);</span>

	<span class="cm">/* We do not negotiate the number of slots yet, so set the</span>
<span class="cm">	 * maxslots to the session maxreqs which is used to encode</span>
<span class="cm">	 * sr_highest_slotid and the sr_target_slot id to maxslots */</span>
	<span class="n">seq</span><span class="o">-&gt;</span><span class="n">maxslots</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">se_fchannel</span><span class="p">.</span><span class="n">maxreqs</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">check_slot_seqid</span><span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">seqid</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_seqid</span><span class="p">,</span>
					<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_flags</span> <span class="o">&amp;</span> <span class="n">NFSD4_SLOT_INUSE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_replay_cache</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_seq_misordered</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_flags</span> <span class="o">&amp;</span> <span class="n">NFSD4_SLOT_INITIALIZED</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">cstate</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
		<span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span><span class="p">;</span>
		<span class="cm">/* Return the cached reply status and set cstate-&gt;status</span>
<span class="cm">		 * for nfsd4_proc_compound processing */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_replay_cache_entry</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>
		<span class="n">cstate</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_replay_cache</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">nfsd4_sequence_check_conn</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Success! bump slot seqid */</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_seqid</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">seqid</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_flags</span> <span class="o">|=</span> <span class="n">NFSD4_SLOT_INUSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">cachethis</span><span class="p">)</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_flags</span> <span class="o">|=</span> <span class="n">NFSD4_SLOT_CACHETHIS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFSD4_SLOT_CACHETHIS</span><span class="p">;</span>

	<span class="n">cstate</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="cm">/* Hold a session reference until done processing the compound. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="p">;</span>

		<span class="n">nfsd4_get_session</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_refcount</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NFSD4_CB_DOWN</span>:
			<span class="n">seq</span><span class="o">-&gt;</span><span class="n">status_flags</span> <span class="o">=</span> <span class="n">SEQ4_STATUS_CB_PATH_DOWN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFSD4_CB_FAULT</span>:
			<span class="n">seq</span><span class="o">-&gt;</span><span class="n">status_flags</span> <span class="o">=</span> <span class="n">SEQ4_STATUS_BACKCHANNEL_FAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">seq</span><span class="o">-&gt;</span><span class="n">status_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: return %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_destroy_clientid</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_destroy_clientid</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="o">*</span><span class="n">unconf</span><span class="p">,</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">unconf</span> <span class="o">=</span> <span class="n">find_unconfirmed_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">clientid</span><span class="p">);</span>
	<span class="n">conf</span> <span class="o">=</span> <span class="n">find_confirmed_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">clientid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clp</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_client_expired</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">client_has_state</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_clientid_busy</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* rfc5661 18.50.3 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">&amp;&amp;</span> <span class="n">conf</span> <span class="o">==</span> <span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_clientid_busy</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unconf</span><span class="p">)</span>
		<span class="n">clp</span> <span class="o">=</span> <span class="n">unconf</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_stale_clientid</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">expire_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s return %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_reclaim_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_reclaim_complete</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rca_one_fs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">nfserr_nofilehandle</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * We don&#39;t take advantage of the rca_one_fs case.</span>
<span class="cm">		 * That&#39;s OK, it&#39;s optional, we can safely ignore it.</span>
<span class="cm">		 */</span>
		 <span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_complete_already</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">NFSD4_CLIENT_RECLAIM_COMPLETE</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="o">-&gt;</span><span class="n">cl_flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_stale_clientid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_client_expired</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="p">))</span>
		<span class="cm">/*</span>
<span class="cm">		 * The following error isn&#39;t really legal.</span>
<span class="cm">		 * But we only get here if the client just explicitly</span>
<span class="cm">		 * destroyed the client.  Surely it no longer cares what</span>
<span class="cm">		 * error it gets back on an operation for the dead</span>
<span class="cm">		 * client.</span>
<span class="cm">		 */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="n">nfsd4_client_record_create</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_setclientid</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">nfsd4_setclientid</span> <span class="o">*</span><span class="n">setclid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xdr_netobj</span> 	<span class="n">clname</span> <span class="o">=</span> <span class="n">setclid</span><span class="o">-&gt;</span><span class="n">se_name</span><span class="p">;</span>
	<span class="n">nfs4_verifier</span>		<span class="n">clverifier</span> <span class="o">=</span> <span class="n">setclid</span><span class="o">-&gt;</span><span class="n">se_verf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> 		<span class="n">strhashval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span>	<span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="o">*</span><span class="n">unconf</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="n">__be32</span> 			<span class="n">status</span><span class="p">;</span>
	<span class="kt">char</span>                    <span class="n">dname</span><span class="p">[</span><span class="n">HEXDIR_LEN</span><span class="p">];</span>
	
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_make_rec_clidname</span><span class="p">(</span><span class="n">dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">strhashval</span> <span class="o">=</span> <span class="n">clientstr_hashval</span><span class="p">(</span><span class="n">dname</span><span class="p">);</span>

	<span class="cm">/* Cases below refer to rfc 3530 section 14.2.33: */</span>
	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">conf</span> <span class="o">=</span> <span class="n">find_confirmed_client_by_str</span><span class="p">(</span><span class="n">dname</span><span class="p">,</span> <span class="n">strhashval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* case 0: */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_clid_inuse</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clp_used_exchangeid</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">same_creds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cl_cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">addr_str</span><span class="p">[</span><span class="n">INET6_ADDRSTRLEN</span><span class="p">];</span>
			<span class="n">rpc_ntop</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cl_addr</span><span class="p">,</span> <span class="n">addr_str</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">addr_str</span><span class="p">));</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: setclientid: string in use by client &quot;</span>
				<span class="s">&quot;at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr_str</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">unconf</span> <span class="o">=</span> <span class="n">find_unconfirmed_client_by_str</span><span class="p">(</span><span class="n">dname</span><span class="p">,</span> <span class="n">strhashval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unconf</span><span class="p">)</span>
		<span class="n">expire_client</span><span class="p">(</span><span class="n">unconf</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">create_client</span><span class="p">(</span><span class="n">clname</span><span class="p">,</span> <span class="n">dname</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clverifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span> <span class="o">&amp;&amp;</span> <span class="n">same_verf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cl_verifier</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clverifier</span><span class="p">))</span>
		<span class="cm">/* case 1: probable callback update */</span>
		<span class="n">copy_clid</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* case 4 (new client) or cases 2, 3 (client reboot): */</span>
		<span class="n">gen_clid</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * XXX: we should probably set this at creation time, and check</span>
<span class="cm">	 * for consistent minorversion use throughout:</span>
<span class="cm">	 */</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">cl_minorversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gen_callback</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">setclid</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">);</span>
	<span class="n">add_to_unconfirmed</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">strhashval</span><span class="p">);</span>
	<span class="n">setclid</span><span class="o">-&gt;</span><span class="n">se_clientid</span><span class="p">.</span><span class="n">cl_boot</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_boot</span><span class="p">;</span>
	<span class="n">setclid</span><span class="o">-&gt;</span><span class="n">se_clientid</span><span class="p">.</span><span class="n">cl_id</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">setclid</span><span class="o">-&gt;</span><span class="n">se_confirm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cl_confirm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">setclid</span><span class="o">-&gt;</span><span class="n">se_confirm</span><span class="p">.</span><span class="n">data</span><span class="p">));</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">__be32</span>
<span class="nf">nfsd4_setclientid_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">nfsd4_setclientid_confirm</span> <span class="o">*</span><span class="n">setclientid_confirm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="o">*</span><span class="n">unconf</span><span class="p">;</span>
	<span class="n">nfs4_verifier</span> <span class="n">confirm</span> <span class="o">=</span> <span class="n">setclientid_confirm</span><span class="o">-&gt;</span><span class="n">sc_confirm</span><span class="p">;</span> 
	<span class="n">clientid_t</span> <span class="o">*</span> <span class="n">clid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">setclientid_confirm</span><span class="o">-&gt;</span><span class="n">sc_clientid</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STALE_CLIENTID</span><span class="p">(</span><span class="n">clid</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_stale_clientid</span><span class="p">;</span>
	<span class="n">nfs4_lock_state</span><span class="p">();</span>

	<span class="n">conf</span> <span class="o">=</span> <span class="n">find_confirmed_client</span><span class="p">(</span><span class="n">clid</span><span class="p">);</span>
	<span class="n">unconf</span> <span class="o">=</span> <span class="n">find_unconfirmed_client</span><span class="p">(</span><span class="n">clid</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We try hard to give out unique clientid&#39;s, so if we get an</span>
<span class="cm">	 * attempt to confirm the same clientid with a different cred,</span>
<span class="cm">	 * there&#39;s a bug somewhere.  Let&#39;s charitably assume it&#39;s our</span>
<span class="cm">	 * bug.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_serverfault</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unconf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">same_creds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unconf</span><span class="o">-&gt;</span><span class="n">cl_cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">same_creds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cl_cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* cases below refer to rfc 3530 section 14.2.34: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unconf</span> <span class="o">||</span> <span class="o">!</span><span class="n">same_verf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">confirm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unconf</span><span class="o">-&gt;</span><span class="n">cl_confirm</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">unconf</span><span class="p">)</span> <span class="cm">/* case 2: probable retransmit */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
		<span class="k">else</span> <span class="cm">/* case 4: client hasn&#39;t noticed we rebooted yet? */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_stale_clientid</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* case 1: callback update */</span>
		<span class="n">nfsd4_change_callback</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unconf</span><span class="o">-&gt;</span><span class="n">cl_cb_conn</span><span class="p">);</span>
		<span class="n">nfsd4_probe_callback</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">expire_client</span><span class="p">(</span><span class="n">unconf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* case 3: normal case; new or rebooted client */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">clientstr_hashval</span><span class="p">(</span><span class="n">unconf</span><span class="o">-&gt;</span><span class="n">cl_recdir</span><span class="p">);</span>

		<span class="n">conf</span> <span class="o">=</span> <span class="n">find_confirmed_client_by_str</span><span class="p">(</span><span class="n">unconf</span><span class="o">-&gt;</span><span class="n">cl_recdir</span><span class="p">,</span> <span class="n">hash</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nfsd4_client_record_remove</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
			<span class="n">expire_client</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">move_to_confirmed</span><span class="p">(</span><span class="n">unconf</span><span class="p">);</span>
		<span class="n">nfsd4_probe_callback</span><span class="p">(</span><span class="n">unconf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="nf">nfsd4_alloc_file</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">file_slab</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* OPEN Share state helper functions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd4_init_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ino</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hashval</span> <span class="o">=</span> <span class="n">file_hashval</span><span class="p">(</span><span class="n">ino</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_ref</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_hash</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_stateids</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_delegations</span><span class="p">);</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_inode</span> <span class="o">=</span> <span class="n">igrab</span><span class="p">(</span><span class="n">ino</span><span class="p">);</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_had_conflict</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_lease</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_fds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_fds</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_access</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_access</span><span class="p">));</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_hash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file_hashtbl</span><span class="p">[</span><span class="n">hashval</span><span class="p">]);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfsd4_free_slab</span><span class="p">(</span><span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">**</span><span class="n">slab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">slab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="o">*</span><span class="n">slab</span><span class="p">);</span>
	<span class="o">*</span><span class="n">slab</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfsd4_free_slabs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfsd4_free_slab</span><span class="p">(</span><span class="o">&amp;</span><span class="n">openowner_slab</span><span class="p">);</span>
	<span class="n">nfsd4_free_slab</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockowner_slab</span><span class="p">);</span>
	<span class="n">nfsd4_free_slab</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_slab</span><span class="p">);</span>
	<span class="n">nfsd4_free_slab</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stateid_slab</span><span class="p">);</span>
	<span class="n">nfsd4_free_slab</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deleg_slab</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">nfsd4_init_slabs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">openowner_slab</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;nfsd4_openowners&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_openowner</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">openowner_slab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
	<span class="n">lockowner_slab</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;nfsd4_lockowners&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_openowner</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lockowner_slab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
	<span class="n">file_slab</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;nfsd4_files&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file_slab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
	<span class="n">stateid_slab</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;nfsd4_stateids&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stateid_slab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
	<span class="n">deleg_slab</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;nfsd4_delegations&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_delegation</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">deleg_slab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_nomem:</span>
	<span class="n">nfsd4_free_slabs</span><span class="p">();</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsd4: out of memory while initializing nfsv4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs4_free_openowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_owner</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">openowner_slab</span><span class="p">,</span> <span class="n">oo</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs4_free_lockowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_owner</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">lockowner_slab</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_nfs4_replay</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_replay</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rp_status</span> <span class="o">=</span> <span class="n">nfserr_serverfault</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rp_buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rp_buf</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rp_ibuf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">alloc_stateowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">slab</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="o">*</span><span class="n">owner</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_stateowner</span> <span class="o">*</span><span class="n">sop</span><span class="p">;</span>

	<span class="n">sop</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sop</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sop</span><span class="o">-&gt;</span><span class="n">so_owner</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">owner</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">so_owner</span><span class="p">.</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span> <span class="n">sop</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sop</span><span class="o">-&gt;</span><span class="n">so_owner</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">owner</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">so_stateids</span><span class="p">);</span>
	<span class="n">sop</span><span class="o">-&gt;</span><span class="n">so_client</span> <span class="o">=</span> <span class="n">clp</span><span class="p">;</span>
	<span class="n">init_nfs4_replay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">so_replay</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sop</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hash_openowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">strhashval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_strhash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ownerstr_hashtbl</span><span class="p">[</span><span class="n">strhashval</span><span class="p">]);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_perclient</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_openowners</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span>
<span class="nf">alloc_init_open_stateowner</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">strhashval</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span><span class="p">;</span>

	<span class="n">oo</span> <span class="o">=</span> <span class="n">alloc_stateowner</span><span class="p">(</span><span class="n">openowner_slab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_owner</span><span class="p">,</span> <span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oo</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_is_open_owner</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_seqid</span> <span class="o">=</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_seqid</span><span class="p">;</span>
	<span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">=</span> <span class="n">NFS4_OO_NEW</span><span class="p">;</span>
	<span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_last_closed_stid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_close_lru</span><span class="p">);</span>
	<span class="n">hash_openowner</span><span class="p">(</span><span class="n">oo</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="n">strhashval</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">oo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_open_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span> <span class="o">=</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_client</span><span class="p">;</span>

	<span class="n">init_stid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="n">NFS4_OPEN_STID</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_lockowners</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_perstateowner</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_stateids</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_perfile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_stateids</span><span class="p">);</span>
	<span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stateowner</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">;</span>
	<span class="n">get_nfs4_file</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_file</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>
	<span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_access_bmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_deny_bmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_access</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_access</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>
	<span class="n">set_deny</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_deny</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>
	<span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_openstp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">move_to_close_lru</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: move_to_close_lru nfs4_openowner %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oo</span><span class="p">);</span>

	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_close_lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">close_lru</span><span class="p">);</span>
	<span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_time</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">same_owner_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_stateowner</span> <span class="o">*</span><span class="n">sop</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="o">*</span><span class="n">owner</span><span class="p">,</span>
							<span class="n">clientid_t</span> <span class="o">*</span><span class="n">clid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">so_owner</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="n">owner</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">so_owner</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">owner</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">owner</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">so_client</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span> <span class="o">==</span> <span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span>
<span class="nf">find_openstateowner_str</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hashval</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_stateowner</span> <span class="o">*</span><span class="n">so</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ownerstr_hashtbl</span><span class="p">[</span><span class="n">hashval</span><span class="p">],</span> <span class="n">so_strhash</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">so</span><span class="o">-&gt;</span><span class="n">so_is_open_owner</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">same_owner_str</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_owner</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_clientid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">oo</span> <span class="o">=</span> <span class="n">openowner</span><span class="p">(</span><span class="n">so</span><span class="p">);</span>
			<span class="n">renew_client</span><span class="p">(</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_client</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">oo</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* search file_hashtbl[] for file */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span>
<span class="nf">find_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ino</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hashval</span> <span class="o">=</span> <span class="n">file_hashval</span><span class="p">(</span><span class="n">ino</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file_hashtbl</span><span class="p">[</span><span class="n">hashval</span><span class="p">],</span> <span class="n">fi_hash</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_inode</span> <span class="o">==</span> <span class="n">ino</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">get_nfs4_file</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">fp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called to check deny when READ with all zero stateid or</span>
<span class="cm"> * WRITE with all zero or all one stateid</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfs4_share_conflict</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">current_fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">deny_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ino</span> <span class="o">=</span> <span class="n">current_fh</span><span class="o">-&gt;</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfs4_share_conflict</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">find_file</span><span class="p">(</span><span class="n">ino</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfserr_locked</span><span class="p">;</span>
	<span class="cm">/* Search for conflicting share reservations */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">stp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_stateids</span><span class="p">,</span> <span class="n">st_perfile</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_deny</span><span class="p">(</span><span class="n">deny_type</span><span class="p">,</span> <span class="n">stp</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_deny</span><span class="p">(</span><span class="n">NFS4_SHARE_DENY_BOTH</span><span class="p">,</span> <span class="n">stp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">put_nfs4_file</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd_break_one_deleg</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We&#39;re assuming the state code never drops its reference</span>
<span class="cm">	 * without first removing the lease.  Since we&#39;re in this lease</span>
<span class="cm">	 * callback (and since the lease code is serialized by the kernel</span>
<span class="cm">	 * lock) we know the server hasn&#39;t removed the lease yet, we know</span>
<span class="cm">	 * it&#39;s safe to take a reference: */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_count</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_recall_lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">del_recall_lru</span><span class="p">);</span>

	<span class="cm">/* only place dl_time is set. protected by lock_flocks*/</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_time</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>

	<span class="n">nfsd4_cb_recall</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called from break_lease() with lock_flocks() held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd_break_deleg_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="p">)</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_owner</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">);</span>
	<span class="cm">/* We assume break_lease is only called once per lease: */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_had_conflict</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t want the locks code to timeout the lease for us;</span>
<span class="cm">	 * we&#39;ll remove it ourself if a delegation isn&#39;t returned</span>
<span class="cm">	 * in time:</span>
<span class="cm">	 */</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_break_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_had_conflict</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_delegations</span><span class="p">,</span> <span class="n">dl_perfile</span><span class="p">)</span>
		<span class="n">nfsd_break_one_deleg</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">int</span> <span class="nf">nfsd_change_deleg_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span> <span class="o">**</span><span class="n">onlist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">F_UNLCK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">lease_modify</span><span class="p">(</span><span class="n">onlist</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">lock_manager_operations</span> <span class="n">nfsd_lease_mng_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">lm_break</span> <span class="o">=</span> <span class="n">nfsd_break_deleg_cb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lm_change</span> <span class="o">=</span> <span class="n">nfsd_change_deleg_cb</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_check_seqid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_stateowner</span> <span class="o">*</span><span class="n">so</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seqid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfsd4_has_session</span><span class="p">(</span><span class="n">cstate</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seqid</span> <span class="o">==</span> <span class="n">so</span><span class="o">-&gt;</span><span class="n">so_seqid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_replay_me</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seqid</span> <span class="o">==</span> <span class="n">so</span><span class="o">-&gt;</span><span class="n">so_seqid</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfserr_bad_seqid</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_process_open1</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clientid_t</span> <span class="o">*</span><span class="n">clientid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_clientid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">strhashval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STALE_CLIENTID</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_clientid</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_stale_clientid</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * In case we need it later, after we&#39;ve already created the</span>
<span class="cm">	 * file and don&#39;t want to risk a further failure:</span>
<span class="cm">	 */</span>
	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_file</span> <span class="o">=</span> <span class="n">nfsd4_alloc_file</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>

	<span class="n">strhashval</span> <span class="o">=</span> <span class="n">ownerstr_hashval</span><span class="p">(</span><span class="n">clientid</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_owner</span><span class="p">);</span>
	<span class="n">oo</span> <span class="o">=</span> <span class="n">find_openstateowner_str</span><span class="p">(</span><span class="n">strhashval</span><span class="p">,</span> <span class="n">open</span><span class="p">);</span>
	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span> <span class="o">=</span> <span class="n">oo</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clp</span> <span class="o">=</span> <span class="n">find_confirmed_client</span><span class="p">(</span><span class="n">clientid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">nfserr_expired</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">new_owner</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">&amp;</span> <span class="n">NFS4_OO_CONFIRMED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Replace unconfirmed owners without checking for replay. */</span>
		<span class="n">clp</span> <span class="o">=</span> <span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_client</span><span class="p">;</span>
		<span class="n">release_openowner</span><span class="p">(</span><span class="n">oo</span><span class="p">);</span>
		<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">new_owner</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_check_seqid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">,</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_seqid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">clp</span> <span class="o">=</span> <span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_client</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">alloc_stateid</span><span class="p">;</span>
<span class="nl">new_owner:</span>
	<span class="n">oo</span> <span class="o">=</span> <span class="n">alloc_init_open_stateowner</span><span class="p">(</span><span class="n">strhashval</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="n">open</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>
	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span> <span class="o">=</span> <span class="n">oo</span><span class="p">;</span>
<span class="nl">alloc_stateid:</span>
	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_stp</span> <span class="o">=</span> <span class="n">nfs4_alloc_stateid</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_stp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be32</span>
<span class="nf">nfs4_check_delegmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WR_STATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_type</span> <span class="o">==</span> <span class="n">NFS4_OPEN_DELEGATE_READ</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_openmode</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">share_access_to_flags</span><span class="p">(</span><span class="n">u32</span> <span class="n">share_access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">share_access</span> <span class="o">==</span> <span class="n">NFS4_SHARE_ACCESS_READ</span> <span class="o">?</span> <span class="n">RD_STATE</span> <span class="o">:</span> <span class="n">WR_STATE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="nf">find_deleg_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="n">stateid_t</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_stid</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">find_stateid_by_type</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">NFS4_DELEG_STID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">delegstateid</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nfsd4_is_deleg_cur</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_claim_type</span> <span class="o">==</span> <span class="n">NFS4_OPEN_CLAIM_DELEGATE_CUR</span> <span class="o">||</span>
	       <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_claim_type</span> <span class="o">==</span> <span class="n">NFS4_OPEN_CLAIM_DELEG_CUR_FH</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfs4_check_deleg</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">**</span><span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_bad_stateid</span><span class="p">;</span>

	<span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">find_deleg_stateid</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_stateid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">share_access_to_flags</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_access</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_check_delegmode</span><span class="p">(</span><span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfsd4_is_deleg_cur</span><span class="p">(</span><span class="n">open</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">|=</span> <span class="n">NFS4_OO_CONFIRMED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfs4_check_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">**</span><span class="n">stpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span> <span class="o">=</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_stateids</span><span class="p">,</span> <span class="n">st_perfile</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ignore lock owners */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="o">-&gt;</span><span class="n">so_is_open_owner</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* remember if we have seen this open owner */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">st_stateowner</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">)</span>
			<span class="o">*</span><span class="n">stpp</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>
		<span class="cm">/* check for conflicting share reservations */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_share</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">open</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">nfserr_share_denied</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_free_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">stateid_slab</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">nfs4_access_to_access</span><span class="p">(</span><span class="n">u32</span> <span class="n">nfs4_access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_access</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_ACCESS_READ</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">NFSD_MAY_READ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_access</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_ACCESS_WRITE</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">NFSD_MAY_WRITE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfs4_get_vfs_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">cur_fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oflag</span> <span class="o">=</span> <span class="n">nfs4_access_to_omode</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_access</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">access</span> <span class="o">=</span> <span class="n">nfs4_access_to_access</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_access</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_fds</span><span class="p">[</span><span class="n">oflag</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_open</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cur_fh</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_fds</span><span class="p">[</span><span class="n">oflag</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nfs4_file_get_access</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">oflag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be32</span>
<span class="nf">nfsd4_truncate</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iattr</span> <span class="n">iattr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ia_valid</span> <span class="o">=</span> <span class="n">ATTR_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ia_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_truncate</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_access</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_ACCESS_WRITE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfsd_setattr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iattr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">time_t</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfs4_upgrade_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">cur_fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">op_share_access</span> <span class="o">=</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_access</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">new_access</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">new_access</span> <span class="o">=</span> <span class="o">!</span><span class="n">test_access</span><span class="p">(</span><span class="n">op_share_access</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_access</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_get_vfs_file</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">cur_fh</span><span class="p">,</span> <span class="n">open</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_truncate</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cur_fh</span><span class="p">,</span> <span class="n">open</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_access</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">oflag</span> <span class="o">=</span> <span class="n">nfs4_access_to_omode</span><span class="p">(</span><span class="n">op_share_access</span><span class="p">);</span>
			<span class="n">nfs4_file_put_access</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">oflag</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* remember the open */</span>
	<span class="n">set_access</span><span class="p">(</span><span class="n">op_share_access</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>
	<span class="n">set_deny</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_deny</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfs4_set_claim_prev</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">,</span> <span class="n">bool</span> <span class="n">has_session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">|=</span> <span class="n">NFS4_OO_CONFIRMED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Should we give out recallable state?: */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">nfsd4_cb_channel_good</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_state</span> <span class="o">==</span> <span class="n">NFSD4_CB_UP</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * In the sessions case, since we don&#39;t have to establish a</span>
<span class="cm">	 * separate connection for callbacks, we assume it&#39;s OK</span>
<span class="cm">	 * until we hear otherwise:</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_minorversion</span> <span class="o">&amp;&amp;</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_state</span> <span class="o">==</span> <span class="n">NFSD4_CB_UNKNOWN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="nf">nfs4_alloc_init_lease</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">;</span>

	<span class="n">fl</span> <span class="o">=</span> <span class="n">locks_alloc_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fl</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">locks_init_lock</span><span class="p">(</span><span class="n">fl</span><span class="p">);</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_lmops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfsd_lease_mng_ops</span><span class="p">;</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">=</span> <span class="n">FL_LEASE</span><span class="p">;</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">flag</span> <span class="o">==</span> <span class="n">NFS4_OPEN_DELEGATE_READ</span><span class="o">?</span> <span class="n">F_RDLCK</span><span class="o">:</span> <span class="n">F_WRLCK</span><span class="p">;</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_end</span> <span class="o">=</span> <span class="n">OFFSET_MAX</span><span class="p">;</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_owner</span> <span class="o">=</span> <span class="p">(</span><span class="n">fl_owner_t</span><span class="p">)(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_file</span><span class="p">);</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">tgid</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_setlease</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">fl</span> <span class="o">=</span> <span class="n">nfs4_alloc_init_lease</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_file</span> <span class="o">=</span> <span class="n">find_readable_file</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_perclnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_stid</span><span class="p">.</span><span class="n">sc_client</span><span class="o">-&gt;</span><span class="n">cl_delegations</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vfs_setlease</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">,</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_perclnt</span><span class="p">);</span>
		<span class="n">locks_free_lock</span><span class="p">(</span><span class="n">fl</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_lease</span> <span class="o">=</span> <span class="n">fl</span><span class="p">;</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_deleg_file</span> <span class="o">=</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">;</span>
	<span class="n">get_file</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_deleg_file</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_delegees</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_perfile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_delegations</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_set_delegation</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_file</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_lease</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfs4_setlease</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_had_conflict</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_delegees</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_perfile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_delegations</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_perclnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_stid</span><span class="p">.</span><span class="n">sc_client</span><span class="o">-&gt;</span><span class="n">cl_delegations</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd4_open_deleg_none_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_type</span> <span class="o">=</span> <span class="n">NFS4_OPEN_DELEGATE_NONE_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_why_no_deleg</span> <span class="o">=</span> <span class="n">WND4_CONTENTION</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_why_no_deleg</span> <span class="o">=</span> <span class="n">WND4_RESOURCE</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_deleg_want</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NFS4_SHARE_WANT_READ_DELEG</span>:
		<span class="k">case</span> <span class="n">NFS4_SHARE_WANT_WRITE_DELEG</span>:
		<span class="k">case</span> <span class="n">NFS4_SHARE_WANT_ANY_DELEG</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFS4_SHARE_WANT_CANCEL</span>:
			<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_why_no_deleg</span> <span class="o">=</span> <span class="n">WND4_CANCELLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFS4_SHARE_WANT_NO_DELEG</span>:
			<span class="n">BUG</span><span class="p">();</span>	<span class="cm">/* not supposed to get here */</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Attempt to hand out a delegation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfs4_open_delegation</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_openowner</span><span class="p">,</span> <span class="n">oo_owner</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cb_up</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cb_up</span> <span class="o">=</span> <span class="n">nfsd4_cb_channel_good</span><span class="p">(</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_client</span><span class="p">);</span>
	<span class="n">flag</span> <span class="o">=</span> <span class="n">NFS4_OPEN_DELEGATE_NONE</span><span class="p">;</span>
	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_recall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_claim_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_PREVIOUS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb_up</span><span class="p">)</span>
				<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_recall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_type</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">NFS4_OPEN_DELEGATE_NONE</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_NULL</span>:
			<span class="cm">/* Let&#39;s not give out any delegations till everyone&#39;s</span>
<span class="cm">			 * had the chance to reclaim theirs.... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">locks_in_grace</span><span class="p">())</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb_up</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">&amp;</span> <span class="n">NFS4_OO_CONFIRMED</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_access</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_ACCESS_WRITE</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">NFS4_OPEN_DELEGATE_WRITE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">NFS4_OPEN_DELEGATE_READ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">alloc_init_deleg</span><span class="p">(</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_client</span><span class="p">,</span> <span class="n">stp</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_no_deleg</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_set_delegation</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: delegation stateid=&quot;</span> <span class="n">STATEID_FMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">STATEID_VAL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_type</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">NFS4_OPEN_DELEGATE_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_claim_type</span> <span class="o">==</span> <span class="n">NFS4_OPEN_CLAIM_PREVIOUS</span> <span class="o">&amp;&amp;</span>
		    <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_type</span> <span class="o">!=</span> <span class="n">NFS4_OPEN_DELEGATE_NONE</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: WARNING: refusing delegation reclaim</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* 4.1 client asking for a delegation? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_deleg_want</span><span class="p">)</span>
			<span class="n">nfsd4_open_deleg_none_ext</span><span class="p">(</span><span class="n">open</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="n">nfs4_put_delegation</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
<span class="nl">out_no_deleg:</span>
	<span class="n">flag</span> <span class="o">=</span> <span class="n">NFS4_OPEN_DELEGATE_NONE</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd4_deleg_xgrade_none_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_deleg_want</span> <span class="o">==</span> <span class="n">NFS4_SHARE_WANT_READ_DELEG</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_type</span> <span class="o">==</span> <span class="n">NFS4_OPEN_DELEGATE_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_type</span> <span class="o">=</span> <span class="n">NFS4_OPEN_DELEGATE_NONE_EXT</span><span class="p">;</span>
		<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_why_no_deleg</span> <span class="o">=</span> <span class="n">WND4_NOT_SUPP_DOWNGRADE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_deleg_want</span> <span class="o">==</span> <span class="n">NFS4_SHARE_WANT_WRITE_DELEG</span> <span class="o">&amp;&amp;</span>
		   <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_type</span> <span class="o">==</span> <span class="n">NFS4_OPEN_DELEGATE_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_type</span> <span class="o">=</span> <span class="n">NFS4_OPEN_DELEGATE_NONE_EXT</span><span class="p">;</span>
		<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_why_no_deleg</span> <span class="o">=</span> <span class="n">WND4_NOT_SUPP_UPGRADE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Otherwise the client must be confused wanting a delegation</span>
<span class="cm">	 * it already has, therefore we don&#39;t return</span>
<span class="cm">	 * NFS4_OPEN_DELEGATE_NONE_EXT and reason.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called with nfs4_lock_state() held.</span>
<span class="cm"> */</span>
<span class="n">__be32</span>
<span class="nf">nfsd4_process_open2</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">current_fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ino</span> <span class="o">=</span> <span class="n">current_fh</span><span class="o">-&gt;</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Lookup file; if found, lookup stateid and check open request,</span>
<span class="cm">	 * and check for delegations in the process of being recalled.</span>
<span class="cm">	 * If not found, create the nfs4_file struct</span>
<span class="cm">	 */</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="n">find_file</span><span class="p">(</span><span class="n">ino</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_check_open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">open</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_check_deleg</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">open</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_bad_stateid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nfsd4_is_deleg_cur</span><span class="p">(</span><span class="n">open</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_file</span><span class="p">;</span>
		<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">nfsd4_init_file</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * OPEN the file, or upgrade an existing OPEN.</span>
<span class="cm">	 * If truncate fails, the OPEN fails.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Stateid was found, this is an OPEN upgrade */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_upgrade_open</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">current_fh</span><span class="p">,</span> <span class="n">stp</span><span class="p">,</span> <span class="n">open</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_get_vfs_file</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">current_fh</span><span class="p">,</span> <span class="n">open</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">stp</span> <span class="o">=</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_stp</span><span class="p">;</span>
		<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_stp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">init_open_stateid</span><span class="p">(</span><span class="n">stp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">open</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_truncate</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">current_fh</span><span class="p">,</span> <span class="n">open</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_open_stateid</span><span class="p">(</span><span class="n">stp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">update_stateid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_t</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfsd4_has_session</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">|=</span> <span class="n">NFS4_OO_CONFIRMED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_deleg_want</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_WANT_NO_DELEG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_type</span> <span class="o">=</span> <span class="n">NFS4_OPEN_DELEGATE_NONE_EXT</span><span class="p">;</span>
			<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_why_no_deleg</span> <span class="o">=</span> <span class="n">WND4_NOT_WANTED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">nodeleg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	* Attempt to hand out a delegation. No error return, because the</span>
<span class="cm">	* OPEN succeeds even if we fail.</span>
<span class="cm">	*/</span>
	<span class="n">nfs4_open_delegation</span><span class="p">(</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">open</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>
<span class="nl">nodeleg:</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: stateid=&quot;</span> <span class="n">STATEID_FMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">STATEID_VAL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="cm">/* 4.1 client trying to upgrade/downgrade delegation? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_type</span> <span class="o">==</span> <span class="n">NFS4_OPEN_DELEGATE_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">dp</span> <span class="o">&amp;&amp;</span>
	    <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_deleg_want</span><span class="p">)</span>
		<span class="n">nfsd4_deleg_xgrade_none_ext</span><span class="p">(</span><span class="n">open</span><span class="p">,</span> <span class="n">dp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span>
		<span class="n">put_nfs4_file</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_claim_type</span> <span class="o">==</span> <span class="n">NFS4_OPEN_CLAIM_PREVIOUS</span><span class="p">)</span>
		<span class="n">nfs4_set_claim_prev</span><span class="p">(</span><span class="n">open</span><span class="p">,</span> <span class="n">nfsd4_has_session</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	* To finish the open response, we just need to set the rflags.</span>
<span class="cm">	*/</span>
	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_rflags</span> <span class="o">=</span> <span class="n">NFS4_OPEN_RESULT_LOCKTYPE_POSIX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">&amp;</span> <span class="n">NFS4_OO_CONFIRMED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">nfsd4_has_session</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">))</span>
		<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_rflags</span> <span class="o">|=</span> <span class="n">NFS4_OPEN_RESULT_CONFIRM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfsd4_cleanup_open_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span> <span class="o">=</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_stateids</span><span class="p">))</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_close_lru</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">&amp;</span> <span class="n">NFS4_OO_NEW</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">release_openowner</span><span class="p">(</span><span class="n">oo</span><span class="p">);</span>
				<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS4_OO_NEW</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_file</span><span class="p">)</span>
		<span class="n">nfsd4_free_file</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_stp</span><span class="p">)</span>
		<span class="n">nfs4_free_stateid</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_stp</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_renew</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	    <span class="n">clientid_t</span> <span class="o">*</span><span class="n">clid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;process_renew(%08x/%08x): starting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_boot</span><span class="p">,</span> <span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_stale_clientid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STALE_CLIENTID</span><span class="p">(</span><span class="n">clid</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">clp</span> <span class="o">=</span> <span class="n">find_confirmed_client</span><span class="p">(</span><span class="n">clid</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_expired</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We assume the client took too long to RENEW. */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsd4_renew: clientid not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_cb_path_down</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_delegations</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_state</span> <span class="o">!=</span> <span class="n">NFSD4_CB_UP</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lock_manager</span> <span class="n">nfsd4_manager</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">grace_ended</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfsd4_end_grace</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* do nothing if grace period already ended */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">grace_ended</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: end of grace period</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">grace_ended</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">nfsd4_record_grace_done</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">boot_time</span><span class="p">);</span>
	<span class="n">locks_end_grace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsd4_manager</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now that every NFSv4 client has had the chance to recover and</span>
<span class="cm">	 * to see the (possibly new, possibly shorter) lease time, we</span>
<span class="cm">	 * can safely set the next grace time to the current lease time:</span>
<span class="cm">	 */</span>
	<span class="n">nfsd4_grace</span> <span class="o">=</span> <span class="n">nfsd4_lease</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">time_t</span>
<span class="nf">nfs4_laundromat</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="n">reaplist</span><span class="p">;</span>
	<span class="kt">time_t</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">nfsd4_lease</span><span class="p">;</span>
	<span class="kt">time_t</span> <span class="n">t</span><span class="p">,</span> <span class="n">clientid_val</span> <span class="o">=</span> <span class="n">nfsd4_lease</span><span class="p">;</span>
	<span class="kt">time_t</span> <span class="n">u</span><span class="p">,</span> <span class="n">test_val</span> <span class="o">=</span> <span class="n">nfsd4_lease</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: laundromat service - starting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">nfsd4_end_grace</span><span class="p">();</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reaplist</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_lru</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clp</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_client</span><span class="p">,</span> <span class="n">cl_lru</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_time</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cutoff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_time</span> <span class="o">-</span> <span class="n">cutoff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clientid_val</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">)</span>
				<span class="n">clientid_val</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_refcount</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: client in use (clientid %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">unhash_client_locked</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reaplist</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reaplist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clp</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_client</span><span class="p">,</span> <span class="n">cl_lru</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: purging unused client (clientid %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span><span class="p">);</span>
		<span class="n">nfsd4_client_record_remove</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="n">expire_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">del_recall_lru</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_delegation</span><span class="p">,</span> <span class="n">dl_recall_lru</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_time</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cutoff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_time</span> <span class="o">-</span> <span class="n">cutoff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_val</span> <span class="o">&gt;</span> <span class="n">u</span><span class="p">)</span>
				<span class="n">test_val</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_recall_lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reaplist</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reaplist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_delegation</span><span class="p">,</span> <span class="n">dl_recall_lru</span><span class="p">);</span>
		<span class="n">unhash_delegation</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">test_val</span> <span class="o">=</span> <span class="n">nfsd4_lease</span><span class="p">;</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">close_lru</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">oo</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_openowner</span><span class="p">,</span> <span class="n">oo_close_lru</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_time</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cutoff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u</span> <span class="o">=</span> <span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_time</span> <span class="o">-</span> <span class="n">cutoff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_val</span> <span class="o">&gt;</span> <span class="n">u</span><span class="p">)</span>
				<span class="n">test_val</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">release_openowner</span><span class="p">(</span><span class="n">oo</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clientid_val</span> <span class="o">&lt;</span> <span class="n">NFSD_LAUNDROMAT_MINTIMEOUT</span><span class="p">)</span>
		<span class="n">clientid_val</span> <span class="o">=</span> <span class="n">NFSD_LAUNDROMAT_MINTIMEOUT</span><span class="p">;</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">clientid_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">laundry_wq</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">laundromat_main</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_DELAYED_WORK</span><span class="p">(</span><span class="n">laundromat_work</span><span class="p">,</span> <span class="n">laundromat_main</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">laundromat_main</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">not_used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">time_t</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">nfs4_laundromat</span><span class="p">();</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: laundromat_main - sleeping for %ld seconds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">laundry_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">laundromat_work</span><span class="p">,</span> <span class="n">t</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be32</span> <span class="nf">nfs4_check_fh</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">fhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fhp</span><span class="o">-&gt;</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span> <span class="o">!=</span> <span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="o">-&gt;</span><span class="n">fi_inode</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_bad_stateid</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">STALE_STATEID</span><span class="p">(</span><span class="n">stateid_t</span> <span class="o">*</span><span class="n">stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stateid</span><span class="o">-&gt;</span><span class="n">si_opaque</span><span class="p">.</span><span class="n">so_clid</span><span class="p">.</span><span class="n">cl_boot</span> <span class="o">==</span> <span class="n">boot_time</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: stale stateid &quot;</span> <span class="n">STATEID_FMT</span> <span class="s">&quot;!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">STATEID_VAL</span><span class="p">(</span><span class="n">stateid</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">access_permit_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_access</span><span class="p">(</span><span class="n">NFS4_SHARE_ACCESS_READ</span><span class="p">,</span> <span class="n">stp</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">test_access</span><span class="p">(</span><span class="n">NFS4_SHARE_ACCESS_BOTH</span><span class="p">,</span> <span class="n">stp</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">test_access</span><span class="p">(</span><span class="n">NFS4_SHARE_ACCESS_WRITE</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">access_permit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_access</span><span class="p">(</span><span class="n">NFS4_SHARE_ACCESS_WRITE</span><span class="p">,</span> <span class="n">stp</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">test_access</span><span class="p">(</span><span class="n">NFS4_SHARE_ACCESS_BOTH</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="n">__be32</span> <span class="nf">nfs4_check_openmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">__be32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_openmode</span><span class="p">;</span>

	<span class="cm">/* For lock stateid&#39;s, we test the parent open, not the lock: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_openstp</span><span class="p">)</span>
		<span class="n">stp</span> <span class="o">=</span> <span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_openstp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WR_STATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">access_permit_write</span><span class="p">(</span><span class="n">stp</span><span class="p">))</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RD_STATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">access_permit_read</span><span class="p">(</span><span class="n">stp</span><span class="p">))</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be32</span>
<span class="nf">check_special_stateids</span><span class="p">(</span><span class="n">svc_fh</span> <span class="o">*</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">stateid_t</span> <span class="o">*</span><span class="n">stateid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ONE_STATEID</span><span class="p">(</span><span class="n">stateid</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RD_STATE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">locks_in_grace</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/* Answer in remaining cases depends on existence of</span>
<span class="cm">		 * conflicting state; so we must wait out the grace period. */</span>
		<span class="k">return</span> <span class="n">nfserr_grace</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WR_STATE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfs4_share_conflict</span><span class="p">(</span><span class="n">current_fh</span><span class="p">,</span>
				<span class="n">NFS4_SHARE_DENY_WRITE</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* (flags &amp; RD_STATE) &amp;&amp; ZERO_STATEID(stateid) */</span>
		<span class="k">return</span> <span class="n">nfs4_share_conflict</span><span class="p">(</span><span class="n">current_fh</span><span class="p">,</span>
				<span class="n">NFS4_SHARE_DENY_READ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allow READ/WRITE during grace period on recovered state only for files</span>
<span class="cm"> * that are not able to provide mandatory locking.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">grace_disallows_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">locks_in_grace</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">mandatory_lock</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Returns true iff a is later than b: */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">stateid_generation_after</span><span class="p">(</span><span class="n">stateid_t</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">stateid_t</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">si_generation</span> <span class="o">-</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">si_generation</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">check_stateid_generation</span><span class="p">(</span><span class="n">stateid_t</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="n">stateid_t</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="n">bool</span> <span class="n">has_session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * When sessions are used the stateid generation number is ignored</span>
<span class="cm">	 * when it is zero.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_session</span> <span class="o">&amp;&amp;</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">si_generation</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">si_generation</span> <span class="o">==</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">si_generation</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>

	<span class="cm">/* If the client sends us a stateid from the future, it&#39;s buggy: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stateid_generation_after</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">ref</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_bad_stateid</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * However, we could see a stateid from the past, even from a</span>
<span class="cm">	 * non-buggy client.  For example, if the client sends a lock</span>
<span class="cm">	 * while some IO is outstanding, the lock may bump si_generation</span>
<span class="cm">	 * while the IO is still in flight.  The client could avoid that</span>
<span class="cm">	 * situation by waiting for responses on all the IO requests,</span>
<span class="cm">	 * but better performance may result in retrying IO that</span>
<span class="cm">	 * receives an old_stateid error if requests are rarely</span>
<span class="cm">	 * reordered in flight:</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">nfserr_old_stateid</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span> <span class="nf">nfs4_validate_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="n">stateid_t</span> <span class="o">*</span><span class="n">stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_stid</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">ols</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STALE_STATEID</span><span class="p">(</span><span class="n">stateid</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_stale_stateid</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">find_stateid</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">stateid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
		 <span class="k">return</span> <span class="n">nfserr_stale_stateid</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">check_stateid_generation</span><span class="p">(</span><span class="n">stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sc_stateid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sc_type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NFS4_OPEN_STID</span> <span class="o">|</span> <span class="n">NFS4_LOCK_STID</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="n">ols</span> <span class="o">=</span> <span class="n">openlockstateid</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ols</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="o">-&gt;</span><span class="n">so_is_open_owner</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">openowner</span><span class="p">(</span><span class="n">ols</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">&amp;</span> <span class="n">NFS4_OO_CONFIRMED</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_bad_stateid</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_lookup_stateid</span><span class="p">(</span><span class="n">stateid_t</span> <span class="o">*</span><span class="n">stateid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">typemask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_stid</span> <span class="o">**</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">cl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ZERO_STATEID</span><span class="p">(</span><span class="n">stateid</span><span class="p">)</span> <span class="o">||</span> <span class="n">ONE_STATEID</span><span class="p">(</span><span class="n">stateid</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_bad_stateid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STALE_STATEID</span><span class="p">(</span><span class="n">stateid</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_stale_stateid</span><span class="p">;</span>
	<span class="n">cl</span> <span class="o">=</span> <span class="n">find_confirmed_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stateid</span><span class="o">-&gt;</span><span class="n">si_opaque</span><span class="p">.</span><span class="n">so_clid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cl</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_expired</span><span class="p">;</span>
	<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">find_stateid_by_type</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">stateid</span><span class="p">,</span> <span class="n">typemask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_bad_stateid</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* Checks for stateid operations</span>
<span class="cm">*/</span>
<span class="n">__be32</span>
<span class="nf">nfs4_preprocess_stateid_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
			   <span class="n">stateid_t</span> <span class="o">*</span><span class="n">stateid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">**</span><span class="n">filpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_stid</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">current_fh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ino</span> <span class="o">=</span> <span class="n">current_fh</span><span class="o">-&gt;</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filpp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">filpp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">grace_disallows_io</span><span class="p">(</span><span class="n">ino</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_grace</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ZERO_STATEID</span><span class="p">(</span><span class="n">stateid</span><span class="p">)</span> <span class="o">||</span> <span class="n">ONE_STATEID</span><span class="p">(</span><span class="n">stateid</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">check_special_stateids</span><span class="p">(</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">stateid</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_lookup_stateid</span><span class="p">(</span><span class="n">stateid</span><span class="p">,</span> <span class="n">NFS4_DELEG_STID</span><span class="o">|</span><span class="n">NFS4_OPEN_STID</span><span class="o">|</span><span class="n">NFS4_LOCK_STID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">check_stateid_generation</span><span class="p">(</span><span class="n">stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sc_stateid</span><span class="p">,</span> <span class="n">nfsd4_has_session</span><span class="p">(</span><span class="n">cstate</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sc_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFS4_DELEG_STID</span>:
		<span class="n">dp</span> <span class="o">=</span> <span class="n">delegstateid</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_check_delegmode</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filpp</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">filpp</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_file</span><span class="o">-&gt;</span><span class="n">fi_deleg_file</span><span class="p">;</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!*</span><span class="n">filpp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_OPEN_STID</span>:
	<span class="k">case</span> <span class="n">NFS4_LOCK_STID</span>:
		<span class="n">stp</span> <span class="o">=</span> <span class="n">openlockstateid</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_check_fh</span><span class="p">(</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="o">-&gt;</span><span class="n">so_is_open_owner</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">openowner</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">&amp;</span> <span class="n">NFS4_OO_CONFIRMED</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_check_openmode</span><span class="p">(</span><span class="n">stp</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filpp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RD_STATE</span><span class="p">)</span>
				<span class="o">*</span><span class="n">filpp</span> <span class="o">=</span> <span class="n">find_readable_file</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">filpp</span> <span class="o">=</span> <span class="n">find_writeable_file</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">nfserr_bad_stateid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_free_lock_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_for_locks</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">,</span> <span class="n">lockowner</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">nfserr_locks_held</span><span class="p">;</span>
	<span class="n">release_lock_stateid</span><span class="p">(</span><span class="n">stp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Test if the stateid is valid</span>
<span class="cm"> */</span>
<span class="n">__be32</span>
<span class="nf">nfsd4_test_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">nfsd4_test_stateid</span> <span class="o">*</span><span class="n">test_stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_test_stateid_id</span> <span class="o">*</span><span class="n">stateid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">test_stateid</span><span class="o">-&gt;</span><span class="n">ts_stateid_list</span><span class="p">,</span> <span class="n">ts_id_list</span><span class="p">)</span>
		<span class="n">stateid</span><span class="o">-&gt;</span><span class="n">ts_id_status</span> <span class="o">=</span> <span class="n">nfs4_validate_stateid</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stateid</span><span class="o">-&gt;</span><span class="n">ts_id_stateid</span><span class="p">);</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_free_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">nfsd4_free_stateid</span> <span class="o">*</span><span class="n">free_stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stateid_t</span> <span class="o">*</span><span class="n">stateid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">free_stateid</span><span class="o">-&gt;</span><span class="n">fr_stateid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_stid</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">nfserr_bad_stateid</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">find_stateid</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">stateid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sc_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFS4_DELEG_STID</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nfserr_locks_held</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_OPEN_STID</span>:
	<span class="k">case</span> <span class="n">NFS4_LOCK_STID</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_stateid_generation</span><span class="p">(</span><span class="n">stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sc_stateid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sc_type</span> <span class="o">==</span> <span class="n">NFS4_LOCK_STID</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">nfsd4_free_lock_stateid</span><span class="p">(</span><span class="n">openlockstateid</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">nfserr_locks_held</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nfserr_bad_stateid</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">setlkflg</span> <span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NFS4_READW_LT</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">NFS4_READ_LT</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">RD_STATE</span> <span class="o">:</span> <span class="n">WR_STATE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfs4_seqid_op_checks</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="n">stateid_t</span> <span class="o">*</span><span class="n">stateid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seqid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">current_fh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_stateowner</span> <span class="o">*</span><span class="n">sop</span> <span class="o">=</span> <span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_check_seqid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">sop</span><span class="p">,</span> <span class="n">seqid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_type</span> <span class="o">==</span> <span class="n">NFS4_CLOSED_STID</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * &quot;Closed&quot; stateid&#39;s exist *only* to return</span>
<span class="cm">		 * nfserr_replay_me from the previous step.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">nfserr_bad_stateid</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">check_stateid_generation</span><span class="p">(</span><span class="n">stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">,</span> <span class="n">nfsd4_has_session</span><span class="p">(</span><span class="n">cstate</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs4_check_fh</span><span class="p">(</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> * Checks for sequence id mutating operations. </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfs4_preprocess_seqid_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seqid</span><span class="p">,</span>
			 <span class="n">stateid_t</span> <span class="o">*</span><span class="n">stateid</span><span class="p">,</span> <span class="kt">char</span> <span class="n">typemask</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">**</span><span class="n">stpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_stid</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: %s: seqid=%d stateid = &quot;</span> <span class="n">STATEID_FMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">seqid</span><span class="p">,</span> <span class="n">STATEID_VAL</span><span class="p">(</span><span class="n">stateid</span><span class="p">));</span>

	<span class="o">*</span><span class="n">stpp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_lookup_stateid</span><span class="p">(</span><span class="n">stateid</span><span class="p">,</span> <span class="n">typemask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="o">*</span><span class="n">stpp</span> <span class="o">=</span> <span class="n">openlockstateid</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">cstate</span><span class="o">-&gt;</span><span class="n">replay_owner</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">stpp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nfs4_seqid_op_checks</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">stateid</span><span class="p">,</span> <span class="n">seqid</span><span class="p">,</span> <span class="o">*</span><span class="n">stpp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfs4_preprocess_confirmed_seqid_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seqid</span><span class="p">,</span> <span class="n">stateid_t</span> <span class="o">*</span><span class="n">stateid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">**</span><span class="n">stpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_preprocess_seqid_op</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">seqid</span><span class="p">,</span> <span class="n">stateid</span><span class="p">,</span>
						<span class="n">NFS4_OPEN_STID</span><span class="p">,</span> <span class="n">stpp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">oo</span> <span class="o">=</span> <span class="n">openowner</span><span class="p">((</span><span class="o">*</span><span class="n">stpp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">&amp;</span> <span class="n">NFS4_OO_CONFIRMED</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_bad_stateid</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_open_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">nfsd4_open_confirm</span> <span class="o">*</span><span class="n">oc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfsd4_open_confirm on file %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
			<span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">fh_verify</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_preprocess_seqid_op</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span>
					<span class="n">oc</span><span class="o">-&gt;</span><span class="n">oc_seqid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">oc_req_stateid</span><span class="p">,</span>
					<span class="n">NFS4_OPEN_STID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">oo</span> <span class="o">=</span> <span class="n">openowner</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_bad_stateid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">&amp;</span> <span class="n">NFS4_OO_CONFIRMED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">|=</span> <span class="n">NFS4_OO_CONFIRMED</span><span class="p">;</span>
	<span class="n">update_stateid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">oc_resp_stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_t</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: %s: success, seqid=%d stateid=&quot;</span> <span class="n">STATEID_FMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">oc</span><span class="o">-&gt;</span><span class="n">oc_seqid</span><span class="p">,</span> <span class="n">STATEID_VAL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">));</span>

	<span class="n">nfsd4_client_record_create</span><span class="p">(</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_client</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">replay_owner</span><span class="p">)</span>
		<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nfs4_stateid_downgrade_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_access</span><span class="p">(</span><span class="n">access</span><span class="p">,</span> <span class="n">stp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">nfs4_file_put_access</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">,</span> <span class="n">nfs4_access_to_omode</span><span class="p">(</span><span class="n">access</span><span class="p">));</span>
	<span class="n">clear_access</span><span class="p">(</span><span class="n">access</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nfs4_stateid_downgrade</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">to_access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">to_access</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFS4_SHARE_ACCESS_READ</span>:
		<span class="n">nfs4_stateid_downgrade_bit</span><span class="p">(</span><span class="n">stp</span><span class="p">,</span> <span class="n">NFS4_SHARE_ACCESS_WRITE</span><span class="p">);</span>
		<span class="n">nfs4_stateid_downgrade_bit</span><span class="p">(</span><span class="n">stp</span><span class="p">,</span> <span class="n">NFS4_SHARE_ACCESS_BOTH</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_SHARE_ACCESS_WRITE</span>:
		<span class="n">nfs4_stateid_downgrade_bit</span><span class="p">(</span><span class="n">stp</span><span class="p">,</span> <span class="n">NFS4_SHARE_ACCESS_READ</span><span class="p">);</span>
		<span class="n">nfs4_stateid_downgrade_bit</span><span class="p">(</span><span class="n">stp</span><span class="p">,</span> <span class="n">NFS4_SHARE_ACCESS_BOTH</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_SHARE_ACCESS_BOTH</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">reset_union_bmap_deny</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deny</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">deny</span><span class="p">)</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">clear_deny</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_open_downgrade</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nfsd4_open_downgrade</span> <span class="o">*</span><span class="n">od</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfsd4_open_downgrade on file %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
			<span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* We don&#39;t yet support WANT bits: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">od</span><span class="o">-&gt;</span><span class="n">od_deleg_want</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: %s: od_deleg_want=0x%x ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">od</span><span class="o">-&gt;</span><span class="n">od_deleg_want</span><span class="p">);</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_preprocess_confirmed_seqid_op</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">od</span><span class="o">-&gt;</span><span class="n">od_seqid</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">od</span><span class="o">-&gt;</span><span class="n">od_stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> 
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_inval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_access</span><span class="p">(</span><span class="n">od</span><span class="o">-&gt;</span><span class="n">od_share_access</span><span class="p">,</span> <span class="n">stp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: access not a subset current bitmap: 0x%lx, input access=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_access_bmap</span><span class="p">,</span> <span class="n">od</span><span class="o">-&gt;</span><span class="n">od_share_access</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_deny</span><span class="p">(</span><span class="n">od</span><span class="o">-&gt;</span><span class="n">od_share_deny</span><span class="p">,</span> <span class="n">stp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD:deny not a subset current bitmap: 0x%lx, input deny=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_deny_bmap</span><span class="p">,</span> <span class="n">od</span><span class="o">-&gt;</span><span class="n">od_share_deny</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nfs4_stateid_downgrade</span><span class="p">(</span><span class="n">stp</span><span class="p">,</span> <span class="n">od</span><span class="o">-&gt;</span><span class="n">od_share_access</span><span class="p">);</span>

	<span class="n">reset_union_bmap_deny</span><span class="p">(</span><span class="n">od</span><span class="o">-&gt;</span><span class="n">od_share_deny</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>

	<span class="n">update_stateid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">od</span><span class="o">-&gt;</span><span class="n">od_stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_t</span><span class="p">));</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">replay_owner</span><span class="p">)</span>
		<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfsd4_purge_closed_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_stateowner</span> <span class="o">*</span><span class="n">so</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">so</span><span class="o">-&gt;</span><span class="n">so_is_open_owner</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">oo</span> <span class="o">=</span> <span class="n">openowner</span><span class="p">(</span><span class="n">so</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_last_closed_stid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">&amp;</span> <span class="n">NFS4_OO_PURGE_CLOSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Release the last_closed_stid on the next seqid bump: */</span>
		<span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">|=</span> <span class="n">NFS4_OO_PURGE_CLOSE</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS4_OO_PURGE_CLOSE</span><span class="p">;</span>
	<span class="n">release_last_closed_stateid</span><span class="p">(</span><span class="n">oo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd4_close_open_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unhash_open_stateid</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_type</span> <span class="o">=</span> <span class="n">NFS4_CLOSED_STID</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nfs4_unlock_state() called after encode</span>
<span class="cm"> */</span>
<span class="n">__be32</span>
<span class="nf">nfsd4_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">nfsd4_close</span> <span class="o">*</span><span class="n">close</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfsd4_close on file %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
			<span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_preprocess_seqid_op</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">close</span><span class="o">-&gt;</span><span class="n">cl_seqid</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">close</span><span class="o">-&gt;</span><span class="n">cl_stateid</span><span class="p">,</span>
					<span class="n">NFS4_OPEN_STID</span><span class="o">|</span><span class="n">NFS4_CLOSED_STID</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">stp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> 
	<span class="n">oo</span> <span class="o">=</span> <span class="n">openowner</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="n">update_stateid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">close</span><span class="o">-&gt;</span><span class="n">cl_stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_t</span><span class="p">));</span>

	<span class="n">nfsd4_close_open_stateid</span><span class="p">(</span><span class="n">stp</span><span class="p">);</span>
	<span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_last_closed_stid</span> <span class="o">=</span> <span class="n">stp</span><span class="p">;</span>

	<span class="cm">/* place unused nfs4_stateowners on so_close_lru list to be</span>
<span class="cm">	 * released by the laundromat service after the lease period</span>
<span class="cm">	 * to enable us to handle CLOSE replay</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_stateids</span><span class="p">))</span>
		<span class="n">move_to_close_lru</span><span class="p">(</span><span class="n">oo</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">replay_owner</span><span class="p">)</span>
		<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_delegreturn</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">nfsd4_delegreturn</span> <span class="o">*</span><span class="n">dr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="n">stateid_t</span> <span class="o">*</span><span class="n">stateid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">dr_stateid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_stid</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">fh_verify</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_lookup_stateid</span><span class="p">(</span><span class="n">stateid</span><span class="p">,</span> <span class="n">NFS4_DELEG_STID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">delegstateid</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">check_stateid_generation</span><span class="p">(</span><span class="n">stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">,</span> <span class="n">nfsd4_has_session</span><span class="p">(</span><span class="n">cstate</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">unhash_delegation</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define LOFF_OVERFLOW(start, len)      ((u64)(len) &gt; ~(u64)(start))</span>

<span class="cp">#define LOCKOWNER_INO_HASH_BITS 8</span>
<span class="cp">#define LOCKOWNER_INO_HASH_SIZE (1 &lt;&lt; LOCKOWNER_INO_HASH_BITS)</span>
<span class="cp">#define LOCKOWNER_INO_HASH_MASK (LOCKOWNER_INO_HASH_SIZE - 1)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">end_offset</span><span class="p">(</span><span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">end</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="o">?</span> <span class="n">end</span><span class="o">:</span> <span class="n">NFS4_MAX_UINT64</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* last octet in a range */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">last_byte_offset</span><span class="p">(</span><span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">start</span> <span class="o">?</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="o">:</span> <span class="n">NFS4_MAX_UINT64</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">lockowner_ino_hashval</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cl_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="o">*</span><span class="n">ownername</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">file_hashval</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">+</span> <span class="n">cl_id</span>
			<span class="o">+</span> <span class="n">opaque_hashval</span><span class="p">(</span><span class="n">ownername</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ownername</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
		<span class="o">&amp;</span> <span class="n">LOCKOWNER_INO_HASH_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">lockowner_ino_hashtbl</span><span class="p">[</span><span class="n">LOCKOWNER_INO_HASH_SIZE</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * TODO: Linux file offsets are _signed_ 64-bit quantities, which means that</span>
<span class="cm"> * we can&#39;t properly handle lock requests that go beyond the (2^63 - 1)-th</span>
<span class="cm"> * byte, because of sign extension problems.  Since NFSv4 calls for 64-bit</span>
<span class="cm"> * locking, this prevents us from being completely protocol-compliant.  The</span>
<span class="cm"> * real solution to this problem is to start using unsigned file offsets in</span>
<span class="cm"> * the VFS, but this is a very deep change!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">nfs4_transform_lock_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">fl_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">lock</span><span class="o">-&gt;</span><span class="n">fl_start</span> <span class="o">=</span> <span class="n">OFFSET_MAX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">fl_end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">lock</span><span class="o">-&gt;</span><span class="n">fl_end</span> <span class="o">=</span> <span class="n">OFFSET_MAX</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Hack!: For now, we&#39;re defining this just so we can use a pointer to it</span>
<span class="cm"> * as a unique cookie to identify our (NFSv4&#39;s) posix locks. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">lock_manager_operations</span> <span class="n">nfsd_posix_mng_ops</span>  <span class="o">=</span> <span class="p">{</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">nfs4_set_lock_denied</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_lock_denied</span> <span class="o">*</span><span class="n">deny</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_lmops</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">nfsd_posix_mng_ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="p">)</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_owner</span><span class="p">;</span>
		<span class="n">deny</span><span class="o">-&gt;</span><span class="n">ld_owner</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_owner</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
					<span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_owner</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">deny</span><span class="o">-&gt;</span><span class="n">ld_owner</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
			<span class="cm">/* We just don&#39;t care that much */</span>
			<span class="k">goto</span> <span class="n">nevermind</span><span class="p">;</span>
		<span class="n">deny</span><span class="o">-&gt;</span><span class="n">ld_owner</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_owner</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
		<span class="n">deny</span><span class="o">-&gt;</span><span class="n">ld_clientid</span> <span class="o">=</span> <span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_client</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nl">nevermind:</span>
		<span class="n">deny</span><span class="o">-&gt;</span><span class="n">ld_owner</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">deny</span><span class="o">-&gt;</span><span class="n">ld_owner</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">deny</span><span class="o">-&gt;</span><span class="n">ld_clientid</span><span class="p">.</span><span class="n">cl_boot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">deny</span><span class="o">-&gt;</span><span class="n">ld_clientid</span><span class="p">.</span><span class="n">cl_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">deny</span><span class="o">-&gt;</span><span class="n">ld_start</span> <span class="o">=</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_start</span><span class="p">;</span>
	<span class="n">deny</span><span class="o">-&gt;</span><span class="n">ld_length</span> <span class="o">=</span> <span class="n">NFS4_MAX_UINT64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_end</span> <span class="o">!=</span> <span class="n">NFS4_MAX_UINT64</span><span class="p">)</span>
		<span class="n">deny</span><span class="o">-&gt;</span><span class="n">ld_length</span> <span class="o">=</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_end</span> <span class="o">-</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>        
	<span class="n">deny</span><span class="o">-&gt;</span><span class="n">ld_type</span> <span class="o">=</span> <span class="n">NFS4_READ_LT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">!=</span> <span class="n">F_RDLCK</span><span class="p">)</span>
		<span class="n">deny</span><span class="o">-&gt;</span><span class="n">ld_type</span> <span class="o">=</span> <span class="n">NFS4_WRITE_LT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">same_lockowner_ino</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">clientid_t</span> <span class="o">*</span><span class="n">clid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="o">*</span><span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">lst</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">same_owner_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">clid</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">lst</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_stateids</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span><span class="p">,</span> <span class="n">st_perstateowner</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lst</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="o">-&gt;</span><span class="n">fi_inode</span> <span class="o">==</span> <span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span>
<span class="nf">find_lockowner_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">clientid_t</span> <span class="o">*</span><span class="n">clid</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="o">*</span><span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hashval</span> <span class="o">=</span> <span class="n">lockowner_ino_hashval</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lo</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lockowner_ino_hashtbl</span><span class="p">[</span><span class="n">hashval</span><span class="p">],</span> <span class="n">lo_owner_ino_hash</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">same_lockowner_ino</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">clid</span><span class="p">,</span> <span class="n">owner</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">lo</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hash_lockowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">strhashval</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">open_stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">open_stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="o">-&gt;</span><span class="n">fi_inode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inohash</span> <span class="o">=</span> <span class="n">lockowner_ino_hashval</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_owner</span><span class="p">);</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_strhash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ownerstr_hashtbl</span><span class="p">[</span><span class="n">strhashval</span><span class="p">]);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner_ino_hash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lockowner_ino_hashtbl</span><span class="p">[</span><span class="n">inohash</span><span class="p">]);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_perstateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open_stp</span><span class="o">-&gt;</span><span class="n">st_lockowners</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Alloc a lock owner structure.</span>
<span class="cm"> * Called in nfsd4_lock - therefore, OPEN and OPEN_CONFIRM (if needed) has </span>
<span class="cm"> * occurred. </span>
<span class="cm"> *</span>
<span class="cm"> * strhashval = ownerstr_hashval</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span>
<span class="nf">alloc_init_lock_stateowner</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">strhashval</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">open_stp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lo</span><span class="p">;</span>

	<span class="n">lo</span> <span class="o">=</span> <span class="n">alloc_stateowner</span><span class="p">(</span><span class="n">lockowner_slab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_new_owner</span><span class="p">,</span> <span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lo</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_stateids</span><span class="p">);</span>
	<span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_is_open_owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* It is the openowner seqid that will be incremented in encode in the</span>
<span class="cm">	 * case of new lockowners; so increment the lock seqid manually: */</span>
	<span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_seqid</span> <span class="o">=</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_new_lock_seqid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hash_lockowner</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">strhashval</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="n">open_stp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span>
<span class="nf">alloc_init_lock_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">open_stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_client</span><span class="p">;</span>

	<span class="n">stp</span> <span class="o">=</span> <span class="n">nfs4_alloc_stateid</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">init_stid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="n">NFS4_LOCK_STID</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_perfile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_stateids</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_perstateowner</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_stateids</span><span class="p">);</span>
	<span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stateowner</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">;</span>
	<span class="n">get_nfs4_file</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_file</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>
	<span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_access_bmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_deny_bmap</span> <span class="o">=</span> <span class="n">open_stp</span><span class="o">-&gt;</span><span class="n">st_deny_bmap</span><span class="p">;</span>
	<span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_openstp</span> <span class="o">=</span> <span class="n">open_stp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">stp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">check_lock_length</span><span class="p">(</span><span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u64</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">||</span> <span class="p">((</span><span class="n">length</span> <span class="o">!=</span> <span class="n">NFS4_MAX_UINT64</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">LOFF_OVERFLOW</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_lock_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">lock_stp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">lock_stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oflag</span> <span class="o">=</span> <span class="n">nfs4_access_to_omode</span><span class="p">(</span><span class="n">access</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_access</span><span class="p">(</span><span class="n">access</span><span class="p">,</span> <span class="n">lock_stp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">nfs4_file_get_access</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">oflag</span><span class="p">);</span>
	<span class="n">set_access</span><span class="p">(</span><span class="n">access</span><span class="p">,</span> <span class="n">lock_stp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">lookup_or_create_lock_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">ost</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">**</span><span class="n">lst</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">ost</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">oo</span> <span class="o">=</span> <span class="n">openowner</span><span class="p">(</span><span class="n">ost</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="n">oo</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">strhashval</span><span class="p">;</span>

	<span class="n">lo</span> <span class="o">=</span> <span class="n">find_lockowner_str</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">fi_inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">new</span><span class="p">.</span><span class="n">owner</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">nfserr_bad_seqid</span><span class="p">;</span>
		<span class="cm">/* XXX: a lockowner always has exactly one stateid: */</span>
		<span class="o">*</span><span class="n">lst</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_owner</span><span class="p">.</span><span class="n">so_stateids</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span><span class="p">,</span> <span class="n">st_perstateowner</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strhashval</span> <span class="o">=</span> <span class="n">ownerstr_hashval</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">.</span><span class="n">cl_id</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">new</span><span class="p">.</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">lo</span> <span class="o">=</span> <span class="n">alloc_init_lock_stateowner</span><span class="p">(</span><span class="n">strhashval</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">ost</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>
	<span class="o">*</span><span class="n">lst</span> <span class="o">=</span> <span class="n">alloc_init_lock_stateid</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">ost</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">lst</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_lockowner</span><span class="p">(</span><span class="n">lo</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  LOCK operation </span>
<span class="cm"> */</span>
<span class="n">__be32</span>
<span class="nf">nfsd4_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	   <span class="k">struct</span> <span class="n">nfsd4_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_openowner</span> <span class="o">*</span><span class="n">open_sop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lock_sop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">lock_stp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file_lock</span> <span class="n">file_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file_lock</span> <span class="n">conflock</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">new_state</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lkflg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfsd4_lock: start=%Ld length=%Ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_offset</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_lock_length</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_offset</span><span class="p">,</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_length</span><span class="p">))</span>
		 <span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">fh_verify</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
				<span class="n">S_IFREG</span><span class="p">,</span> <span class="n">NFSD_MAY_LOCK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfsd4_lock: permission denied!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_is_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Client indicates that this is a new lockowner.</span>
<span class="cm">		 * Use open owner and open stateid to create lock owner and</span>
<span class="cm">		 * lock stateid.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">open_stp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nfsd4_has_session</span><span class="p">(</span><span class="n">cstate</span><span class="p">))</span>
			<span class="cm">/* See rfc 5661 18.10.3: given clientid is ignored: */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">new</span><span class="p">.</span><span class="n">clientid</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">clientid_t</span><span class="p">));</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_stale_clientid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STALE_CLIENTID</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_new_clientid</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* validate and update open stateid and open seqid */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_preprocess_confirmed_seqid_op</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span>
				        <span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_new_open_seqid</span><span class="p">,</span>
		                        <span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_new_open_stateid</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">open_stp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">open_sop</span> <span class="o">=</span> <span class="n">openowner</span><span class="p">(</span><span class="n">open_stp</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_bad_stateid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">same_clid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open_sop</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_client</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">new</span><span class="p">.</span><span class="n">clientid</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">lookup_or_create_lock_state</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">open_stp</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">lock_stp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* lock (lock owner + lock stateid) already exists */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_preprocess_seqid_op</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span>
				       <span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_old_lock_seqid</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_old_lock_stateid</span><span class="p">,</span>
				       <span class="n">NFS4_LOCK_STID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock_stp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lock_sop</span> <span class="o">=</span> <span class="n">lockowner</span><span class="p">(</span><span class="n">lock_stp</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="p">);</span>

	<span class="n">lkflg</span> <span class="o">=</span> <span class="n">setlkflg</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_type</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_check_openmode</span><span class="p">(</span><span class="n">lock_stp</span><span class="p">,</span> <span class="n">lkflg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_grace</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locks_in_grace</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_reclaim</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_no_grace</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">locks_in_grace</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_reclaim</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">locks_init_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NFS4_READ_LT</span>:
		<span class="k">case</span> <span class="n">NFS4_READW_LT</span>:
			<span class="n">filp</span> <span class="o">=</span> <span class="n">find_readable_file</span><span class="p">(</span><span class="n">lock_stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="p">)</span>
				<span class="n">get_lock_access</span><span class="p">(</span><span class="n">lock_stp</span><span class="p">,</span> <span class="n">NFS4_SHARE_ACCESS_READ</span><span class="p">);</span>
			<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">F_RDLCK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFS4_WRITE_LT</span>:
		<span class="k">case</span> <span class="n">NFS4_WRITEW_LT</span>:
			<span class="n">filp</span> <span class="o">=</span> <span class="n">find_writeable_file</span><span class="p">(</span><span class="n">lock_stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="p">)</span>
				<span class="n">get_lock_access</span><span class="p">(</span><span class="n">lock_stp</span><span class="p">,</span> <span class="n">NFS4_SHARE_ACCESS_WRITE</span><span class="p">);</span>
			<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">F_WRLCK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_inval</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_openmode</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_owner</span> <span class="o">=</span> <span class="p">(</span><span class="n">fl_owner_t</span><span class="p">)</span><span class="n">lock_sop</span><span class="p">;</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">tgid</span><span class="p">;</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_file</span> <span class="o">=</span> <span class="n">filp</span><span class="p">;</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_flags</span> <span class="o">=</span> <span class="n">FL_POSIX</span><span class="p">;</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_lmops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfsd_posix_mng_ops</span><span class="p">;</span>

	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_start</span> <span class="o">=</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_offset</span><span class="p">;</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_end</span> <span class="o">=</span> <span class="n">last_byte_offset</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_offset</span><span class="p">,</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_length</span><span class="p">);</span>
	<span class="n">nfs4_transform_lock_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	* Try to lock the file in the VFS.</span>
<span class="cm">	* Note: locks.c uses the BKL to protect the inode&#39;s lock list.</span>
<span class="cm">	*/</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">vfs_lock_file</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">F_SETLK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conflock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">-</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* success! */</span>
		<span class="n">update_stateid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_resp_stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock_stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">,</span> 
				<span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_t</span><span class="p">));</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">EAGAIN</span><span class="p">)</span>:		<span class="cm">/* conflock holds conflicting lock */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_denied</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfsd4_lock: conflicting lock found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">nfs4_set_lock_denied</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conflock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_denied</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">EDEADLK</span><span class="p">)</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_deadlock</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfsd4_lock: vfs_lock_file() failed! status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserrno</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">new_state</span><span class="p">)</span>
		<span class="n">release_lockowner</span><span class="p">(</span><span class="n">lock_sop</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">replay_owner</span><span class="p">)</span>
		<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The NFSv4 spec allows a client to do a LOCKT without holding an OPEN,</span>
<span class="cm"> * so we do a temporary open here just to get an open file to pass to</span>
<span class="cm"> * vfs_test_lock.  (Arguably perhaps test_lock should be done with an</span>
<span class="cm"> * inode operation.)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd_test_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">fhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">err</span> <span class="o">=</span> <span class="n">nfsd_open</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">fhp</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="p">,</span> <span class="n">NFSD_MAY_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfserrno</span><span class="p">(</span><span class="n">vfs_test_lock</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">lock</span><span class="p">));</span>
		<span class="n">nfsd_close</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LOCKT operation</span>
<span class="cm"> */</span>
<span class="n">__be32</span>
<span class="nf">nfsd4_lockt</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">nfsd4_lockt</span> <span class="o">*</span><span class="n">lockt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file_lock</span> <span class="n">file_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lo</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">locks_in_grace</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">nfserr_grace</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_lock_length</span><span class="p">(</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_offset</span><span class="p">,</span> <span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_length</span><span class="p">))</span>
		 <span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_stale_clientid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfsd4_has_session</span><span class="p">(</span><span class="n">cstate</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">STALE_CLIENTID</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_clientid</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">fh_verify</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">inode</span> <span class="o">=</span> <span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="n">locks_init_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NFS4_READ_LT</span>:
		<span class="k">case</span> <span class="n">NFS4_READW_LT</span>:
			<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">F_RDLCK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFS4_WRITE_LT</span>:
		<span class="k">case</span> <span class="n">NFS4_WRITEW_LT</span>:
			<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">F_WRLCK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfs4_lockt: bad lock type!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_inval</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lo</span> <span class="o">=</span> <span class="n">find_lockowner_str</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_clientid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_owner</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lo</span><span class="p">)</span>
		<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_owner</span> <span class="o">=</span> <span class="p">(</span><span class="n">fl_owner_t</span><span class="p">)</span><span class="n">lo</span><span class="p">;</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">tgid</span><span class="p">;</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_flags</span> <span class="o">=</span> <span class="n">FL_POSIX</span><span class="p">;</span>

	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_start</span> <span class="o">=</span> <span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_offset</span><span class="p">;</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_end</span> <span class="o">=</span> <span class="n">last_byte_offset</span><span class="p">(</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_offset</span><span class="p">,</span> <span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_length</span><span class="p">);</span>

	<span class="n">nfs4_transform_lock_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_lock</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_test_lock</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file_lock</span><span class="p">.</span><span class="n">fl_type</span> <span class="o">!=</span> <span class="n">F_UNLCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_denied</span><span class="p">;</span>
		<span class="n">nfs4_set_lock_denied</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_denied</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_locku</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">nfsd4_locku</span> <span class="o">*</span><span class="n">locku</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file_lock</span> <span class="n">file_lock</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
						        
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfsd4_locku: start=%Ld length=%Ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_offset</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_lock_length</span><span class="p">(</span><span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_offset</span><span class="p">,</span> <span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_length</span><span class="p">))</span>
		 <span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
									        
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_preprocess_seqid_op</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_seqid</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_stateid</span><span class="p">,</span> <span class="n">NFS4_LOCK_STID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">filp</span> <span class="o">=</span> <span class="n">find_any_file</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_lock_range</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">filp</span><span class="p">);</span>
	<span class="n">locks_init_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_lock</span><span class="p">);</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">F_UNLCK</span><span class="p">;</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_owner</span> <span class="o">=</span> <span class="p">(</span><span class="n">fl_owner_t</span><span class="p">)</span><span class="n">lockowner</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stateowner</span><span class="p">);</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">tgid</span><span class="p">;</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_file</span> <span class="o">=</span> <span class="n">filp</span><span class="p">;</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_flags</span> <span class="o">=</span> <span class="n">FL_POSIX</span><span class="p">;</span> 
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_lmops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfsd_posix_mng_ops</span><span class="p">;</span>
	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_start</span> <span class="o">=</span> <span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_offset</span><span class="p">;</span>

	<span class="n">file_lock</span><span class="p">.</span><span class="n">fl_end</span> <span class="o">=</span> <span class="n">last_byte_offset</span><span class="p">(</span><span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_offset</span><span class="p">,</span> <span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_length</span><span class="p">);</span>
	<span class="n">nfs4_transform_lock_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	*  Try to unlock the file in the VFS.</span>
<span class="cm">	*/</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">vfs_lock_file</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">F_SETLK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file_lock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfs4_locku: vfs_lock_file failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_nfserr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	* OK, unlock succeeded; the only thing left to do is update the stateid.</span>
<span class="cm">	*/</span>
	<span class="n">update_stateid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_stid</span><span class="p">.</span><span class="n">sc_stateid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_t</span><span class="p">));</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">replay_owner</span><span class="p">)</span>
		<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

<span class="nl">out_nfserr:</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserrno</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * returns</span>
<span class="cm"> * 	1: locks held by lockowner</span>
<span class="cm"> * 	0: no locks held by lockowner</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">check_for_locks</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lowner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file_lock</span> <span class="o">**</span><span class="n">flpp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">fi_inode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lock_flocks</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">flpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flock</span><span class="p">;</span> <span class="o">*</span><span class="n">flpp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">flpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">flpp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fl_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">flpp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fl_owner</span> <span class="o">==</span> <span class="p">(</span><span class="n">fl_owner_t</span><span class="p">)</span><span class="n">lowner</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">unlock_flocks</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span>
<span class="nf">nfsd4_release_lockowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nfsd4_release_lockowner</span> <span class="o">*</span><span class="n">rlockowner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clientid_t</span> <span class="o">*</span><span class="n">clid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rlockowner</span><span class="o">-&gt;</span><span class="n">rl_clientid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_stateowner</span> <span class="o">*</span><span class="n">sop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_lockowner</span> <span class="o">*</span><span class="n">lo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_ol_stateid</span> <span class="o">*</span><span class="n">stp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="o">*</span><span class="n">owner</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rlockowner</span><span class="o">-&gt;</span><span class="n">rl_owner</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">matches</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hashval</span> <span class="o">=</span> <span class="n">ownerstr_hashval</span><span class="p">(</span><span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsd4_release_lockowner clientid: (%08x/%08x):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_boot</span><span class="p">,</span> <span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">);</span>

	<span class="cm">/* XXX check for lease expiration */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_stale_clientid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STALE_CLIENTID</span><span class="p">(</span><span class="n">clid</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_locks_held</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matches</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ownerstr_hashtbl</span><span class="p">[</span><span class="n">hashval</span><span class="p">],</span> <span class="n">so_strhash</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">so_is_open_owner</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">same_owner_str</span><span class="p">(</span><span class="n">sop</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">clid</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">stp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">so_stateids</span><span class="p">,</span>
				<span class="n">st_perstateowner</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lo</span> <span class="o">=</span> <span class="n">lockowner</span><span class="p">(</span><span class="n">sop</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_for_locks</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">,</span> <span class="n">lo</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">matches</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Clients probably won&#39;t expect us to return with some (but not all)</span>
<span class="cm">	 * of the lockowner state released; so don&#39;t release any until all</span>
<span class="cm">	 * have been checked. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matches</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lo</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">matches</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_lockowner</span><span class="p">,</span>
								<span class="n">lo_list</span><span class="p">);</span>
		<span class="cm">/* unhash_stateowner deletes so_perclient only</span>
<span class="cm">		 * for openowners. */</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">lo_list</span><span class="p">);</span>
		<span class="n">release_lockowner</span><span class="p">(</span><span class="n">lo</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">nfs4_client_reclaim</span> <span class="o">*</span>
<span class="nf">alloc_reclaim</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client_reclaim</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">nfs4_has_reclaimed_state</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">bool</span> <span class="n">use_exchange_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">strhashval</span> <span class="o">=</span> <span class="n">clientstr_hashval</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>

	<span class="n">clp</span> <span class="o">=</span> <span class="n">find_confirmed_client_by_str</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">strhashval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clp</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">NFSD4_CLIENT_STABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * failure =&gt; all reset bets are off, nfserr_no_grace...</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">nfs4_client_to_reclaim</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">strhashval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_client_reclaim</span> <span class="o">*</span><span class="n">crp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD nfs4_client_to_reclaim NAME: %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HEXDIR_LEN</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">crp</span> <span class="o">=</span> <span class="n">alloc_reclaim</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crp</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strhashval</span> <span class="o">=</span> <span class="n">clientstr_hashval</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crp</span><span class="o">-&gt;</span><span class="n">cr_strhash</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crp</span><span class="o">-&gt;</span><span class="n">cr_strhash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reclaim_str_hashtbl</span><span class="p">[</span><span class="n">strhashval</span><span class="p">]);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">crp</span><span class="o">-&gt;</span><span class="n">cr_recdir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">HEXDIR_LEN</span><span class="p">);</span>
	<span class="n">reclaim_str_hashtbl_size</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfs4_release_reclaim</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client_reclaim</span> <span class="o">*</span><span class="n">crp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CLIENT_HASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reclaim_str_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">crp</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">reclaim_str_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span><span class="p">,</span>
			                <span class="k">struct</span> <span class="n">nfs4_client_reclaim</span><span class="p">,</span> <span class="n">cr_strhash</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crp</span><span class="o">-&gt;</span><span class="n">cr_strhash</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">crp</span><span class="p">);</span>
			<span class="n">reclaim_str_hashtbl_size</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">reclaim_str_hashtbl_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called from OPEN, CLAIM_PREVIOUS with a new clientid. */</span>
<span class="k">struct</span> <span class="n">nfs4_client_reclaim</span> <span class="o">*</span>
<span class="nf">nfsd4_find_reclaim_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">strhashval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_client_reclaim</span> <span class="o">*</span><span class="n">crp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfs4_find_reclaim_client for %.*s with recdir %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		            <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_name</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
			    <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_recdir</span><span class="p">);</span>

	<span class="cm">/* find clp-&gt;cl_name in reclaim_str_hashtbl */</span>
	<span class="n">strhashval</span> <span class="o">=</span> <span class="n">clientstr_hashval</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_recdir</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reclaim_str_hashtbl</span><span class="p">[</span><span class="n">strhashval</span><span class="p">],</span> <span class="n">cr_strhash</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">same_name</span><span class="p">(</span><span class="n">crp</span><span class="o">-&gt;</span><span class="n">cr_recdir</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_recdir</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">crp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* Called from OPEN. Look for clientid in reclaim list.</span>
<span class="cm">*/</span>
<span class="n">__be32</span>
<span class="nf">nfs4_check_open_reclaim</span><span class="p">(</span><span class="n">clientid_t</span> <span class="o">*</span><span class="n">clid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>

	<span class="cm">/* find clientid in conf_id_hashtbl */</span>
	<span class="n">clp</span> <span class="o">=</span> <span class="n">find_confirmed_client</span><span class="p">(</span><span class="n">clid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_reclaim_bad</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nfsd4_client_record_check</span><span class="p">(</span><span class="n">clp</span><span class="p">)</span> <span class="o">?</span> <span class="n">nfserr_reclaim_bad</span> <span class="o">:</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NFSD_FAULT_INJECTION</span>

<span class="kt">void</span> <span class="nf">nfsd_forget_clients</span><span class="p">(</span><span class="n">u64</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_lru</span><span class="p">,</span> <span class="n">cl_lru</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfsd4_client_record_remove</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="n">expire_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">count</span> <span class="o">==</span> <span class="n">num</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NFSD: Forgot %d clients&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_lockowner_sop</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_stateowner</span> <span class="o">*</span><span class="n">sop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">release_lockowner</span><span class="p">(</span><span class="n">lockowner</span><span class="p">(</span><span class="n">sop</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_openowner_sop</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_stateowner</span> <span class="o">*</span><span class="n">sop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">release_openowner</span><span class="p">(</span><span class="n">openowner</span><span class="p">(</span><span class="n">sop</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfsd_release_n_owners</span><span class="p">(</span><span class="n">u64</span> <span class="n">num</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_open_owner</span><span class="p">,</span>
				<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">release_sop</span><span class="p">)(</span><span class="k">struct</span> <span class="n">nfs4_stateowner</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_stateowner</span> <span class="o">*</span><span class="n">sop</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OWNER_HASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sop</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ownerstr_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">so_strhash</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">so_is_open_owner</span> <span class="o">!=</span> <span class="n">is_open_owner</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">release_sop</span><span class="p">(</span><span class="n">sop</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">count</span> <span class="o">==</span> <span class="n">num</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfsd_forget_locks</span><span class="p">(</span><span class="n">u64</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">nfsd_release_n_owners</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">release_lockowner_sop</span><span class="p">);</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NFSD: Forgot %d locks&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfsd_forget_openowners</span><span class="p">(</span><span class="n">u64</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">nfsd_release_n_owners</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">release_openowner_sop</span><span class="p">);</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NFSD: Forgot %d open owners&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfsd_process_n_delegations</span><span class="p">(</span><span class="n">u64</span> <span class="n">num</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">deleg_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="o">*</span><span class="n">fnext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="o">*</span><span class="n">dnext</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FILE_HASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fnext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fi_hash</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">dnext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fi_delegations</span><span class="p">,</span> <span class="n">dl_perfile</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">deleg_func</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">count</span> <span class="o">==</span> <span class="n">num</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfsd_forget_delegations</span><span class="p">(</span><span class="n">u64</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">nfsd_process_n_delegations</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">unhash_delegation</span><span class="p">);</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NFSD: Forgot %d delegations&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfsd_recall_delegations</span><span class="p">(</span><span class="n">u64</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">nfsd_process_n_delegations</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">nfsd_break_one_deleg</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NFSD: Recalled %d delegations&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_NFSD_FAULT_INJECTION */</span><span class="cp"></span>

<span class="cm">/* initialization to perform at module load time: */</span>

<span class="kt">void</span>
<span class="nf">nfs4_state_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CLIENT_HASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf_id_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf_str_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unconf_str_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unconf_id_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reclaim_str_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SESSION_HASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sessionid_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FILE_HASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OWNER_HASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ownerstr_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LOCKOWNER_INO_HASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockowner_ino_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">close_lru</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_lru</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">del_recall_lru</span><span class="p">);</span>
	<span class="n">reclaim_str_hashtbl_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Since the lifetime of a delegation isn&#39;t limited to that of an open, a</span>
<span class="cm"> * client may quite reasonably hang on to a delegation as long as it has</span>
<span class="cm"> * the inode cached.  This becomes an obvious problem the first time a</span>
<span class="cm"> * client&#39;s inode cache approaches the size of the server&#39;s total memory.</span>
<span class="cm"> *</span>
<span class="cm"> * For now we avoid this problem by imposing a hard limit on the number</span>
<span class="cm"> * of delegations, which varies according to the server&#39;s memory size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_max_delegations</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Allow at most 4 delegations per megabyte of RAM.  Quick</span>
<span class="cm">	 * estimates suggest that in the worst case (where every delegation</span>
<span class="cm">	 * is for a different inode), a delegation could take about 1.5K,</span>
<span class="cm">	 * giving a worst case usage of about 6% of memory.</span>
<span class="cm">	 */</span>
	<span class="n">max_delegations</span> <span class="o">=</span> <span class="n">nr_free_buffer_pages</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">20</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* initialization to perform when the nfsd service is started: */</span>

<span class="kt">int</span>
<span class="nf">nfs4_state_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: For now, we hang most of the pernet global stuff off of</span>
<span class="cm">	 * init_net until nfsd is fully containerized. Eventually, we&#39;ll</span>
<span class="cm">	 * need to pass a net pointer into this function, take a reference</span>
<span class="cm">	 * to that instead and then do most of the rest of this on a per-net</span>
<span class="cm">	 * basis.</span>
<span class="cm">	 */</span>
	<span class="n">get_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">);</span>
	<span class="n">nfsd4_client_tracking_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">);</span>
	<span class="n">boot_time</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>
	<span class="n">locks_start_grace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsd4_manager</span><span class="p">);</span>
	<span class="n">grace_ended</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NFSD: starting %ld-second grace period</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nfsd4_grace</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_callback_cred</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_recovery</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">laundry_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;nfsd4&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">laundry_wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_recovery</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfsd4_create_callback_queue</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_laundry</span><span class="p">;</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">laundry_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">laundromat_work</span><span class="p">,</span> <span class="n">nfsd4_grace</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">set_max_delegations</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_free_laundry:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">laundry_wq</span><span class="p">);</span>
<span class="nl">out_recovery:</span>
	<span class="n">nfsd4_client_tracking_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">);</span>
	<span class="n">put_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__nfs4_state_shutdown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_delegation</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="n">reaplist</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CLIENT_HASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf_id_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">clp</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">conf_id_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_client</span><span class="p">,</span> <span class="n">cl_idhash</span><span class="p">);</span>
			<span class="n">expire_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unconf_str_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">clp</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">unconf_str_hashtbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_client</span><span class="p">,</span> <span class="n">cl_strhash</span><span class="p">);</span>
			<span class="n">expire_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reaplist</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">del_recall_lru</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_delegation</span><span class="p">,</span> <span class="n">dl_recall_lru</span><span class="p">);</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dl_recall_lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reaplist</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recall_lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reaplist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_delegation</span><span class="p">,</span> <span class="n">dl_recall_lru</span><span class="p">);</span>
		<span class="n">unhash_delegation</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nfsd4_client_tracking_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">);</span>
	<span class="n">put_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfs4_state_shutdown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">laundromat_work</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">laundry_wq</span><span class="p">);</span>
	<span class="n">locks_end_grace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsd4_manager</span><span class="p">);</span>
	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">__nfs4_state_shutdown</span><span class="p">();</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="n">nfsd4_destroy_callback_queue</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">get_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="n">stateid_t</span> <span class="o">*</span><span class="n">stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_STATE_ID</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">CURRENT_STATE_ID_FLAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">CURRENT_STATEID</span><span class="p">(</span><span class="n">stateid</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_stateid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_t</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">put_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="n">stateid_t</span> <span class="o">*</span><span class="n">stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_stateid</span><span class="p">,</span> <span class="n">stateid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_t</span><span class="p">));</span>
		<span class="n">SET_STATE_ID</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">CURRENT_STATE_ID_FLAG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">clear_current_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CLEAR_STATE_ID</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">CURRENT_STATE_ID_FLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * functions to set current state id</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">nfsd4_set_opendowngradestateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open_downgrade</span> <span class="o">*</span><span class="n">odp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">put_stateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">odp</span><span class="o">-&gt;</span><span class="n">od_stateid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfsd4_set_openstateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">put_stateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_stateid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfsd4_set_closestateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_close</span> <span class="o">*</span><span class="n">close</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">put_stateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">close</span><span class="o">-&gt;</span><span class="n">cl_stateid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfsd4_set_lockstateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">put_stateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_resp_stateid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * functions to consume current state id</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">nfsd4_get_opendowngradestateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open_downgrade</span> <span class="o">*</span><span class="n">odp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_stateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">odp</span><span class="o">-&gt;</span><span class="n">od_stateid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfsd4_get_delegreturnstateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_delegreturn</span> <span class="o">*</span><span class="n">drp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_stateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drp</span><span class="o">-&gt;</span><span class="n">dr_stateid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfsd4_get_freestateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_free_stateid</span> <span class="o">*</span><span class="n">fsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_stateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsp</span><span class="o">-&gt;</span><span class="n">fr_stateid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfsd4_get_setattrstateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_setattr</span> <span class="o">*</span><span class="n">setattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_stateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setattr</span><span class="o">-&gt;</span><span class="n">sa_stateid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfsd4_get_closestateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_close</span> <span class="o">*</span><span class="n">close</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_stateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">close</span><span class="o">-&gt;</span><span class="n">cl_stateid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfsd4_get_lockustateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_locku</span> <span class="o">*</span><span class="n">locku</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_stateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_stateid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfsd4_get_readstateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_read</span> <span class="o">*</span><span class="n">read</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_stateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_stateid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfsd4_get_writestateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_write</span> <span class="o">*</span><span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_stateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_stateid</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
