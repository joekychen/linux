<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › nfsd › nfs4proc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>nfs4proc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Server-side procedures for NFSv4.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2002 The Regents of the University of Michigan.</span>
<span class="cm"> *  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *  Kendrick Smith &lt;kmsmith@umich.edu&gt;</span>
<span class="cm"> *  Andy Adamson   &lt;andros@umich.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> *  modification, are permitted provided that the following conditions</span>
<span class="cm"> *  are met:</span>
<span class="cm"> *</span>
<span class="cm"> *  1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> *  2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *     documentation and/or other materials provided with the distribution.</span>
<span class="cm"> *  3. Neither the name of the University nor the names of its</span>
<span class="cm"> *     contributors may be used to endorse or promote products derived</span>
<span class="cm"> *     from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> *  THIS SOFTWARE IS PROVIDED ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED</span>
<span class="cm"> *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<span class="cm"> *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="cm"> *  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</span>
<span class="cm"> *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="cm"> *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span>
<span class="cm"> *  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
<span class="cm"> *  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="cm"> *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="cm"> *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;idmap.h&quot;</span>
<span class="cp">#include &quot;cache.h&quot;</span>
<span class="cp">#include &quot;xdr4.h&quot;</span>
<span class="cp">#include &quot;vfs.h&quot;</span>
<span class="cp">#include &quot;current_stateid.h&quot;</span>

<span class="cp">#define NFSDDBG_FACILITY		NFSDDBG_PROC</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">nfsd_attrmask</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">NFSD_WRITEABLE_ATTRS_WORD0</span><span class="p">,</span>
	<span class="n">NFSD_WRITEABLE_ATTRS_WORD1</span><span class="p">,</span>
	<span class="n">NFSD_WRITEABLE_ATTRS_WORD2</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">nfsd41_ex_attrmask</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">NFSD_SUPPATTR_EXCLCREAT_WORD0</span><span class="p">,</span>
	<span class="n">NFSD_SUPPATTR_EXCLCREAT_WORD1</span><span class="p">,</span>
	<span class="n">NFSD_SUPPATTR_EXCLCREAT_WORD2</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">check_attr_support</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="o">*</span><span class="n">bmval</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">writable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check about attributes are supported by the NFSv4 server or not.</span>
<span class="cm">	 * According to spec, unsupported attributes return ERR_ATTRNOTSUPP.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">nfsd_suppattrs0</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">nfsd_suppattrs1</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">nfsd_suppattrs2</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">nfserr_attrnotsupp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check FATTR4_WORD0_ACL can be supported</span>
<span class="cm">	 * in current environment or not.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_ACL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_POSIXACL</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">nfserr_attrnotsupp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * According to spec, read-only attributes return ERR_INVAL.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">writable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">writable</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">writable</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">writable</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
			<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_check_open_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_create</span> <span class="o">==</span> <span class="n">NFS4_OPEN_CREATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_createmode</span> <span class="o">==</span> <span class="n">NFS4_CREATE_UNCHECKED</span>
		    <span class="o">||</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_createmode</span> <span class="o">==</span> <span class="n">NFS4_CREATE_GUARDED</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">check_attr_support</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cstate</span><span class="p">,</span>
					<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_bmval</span><span class="p">,</span> <span class="n">nfsd_attrmask</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_createmode</span> <span class="o">==</span> <span class="n">NFS4_CREATE_EXCLUSIVE4_1</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">check_attr_support</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cstate</span><span class="p">,</span>
					<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_bmval</span><span class="p">,</span> <span class="n">nfsd41_ex_attrmask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">is_create_with_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_create</span> <span class="o">==</span> <span class="n">NFS4_OPEN_CREATE</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_createmode</span> <span class="o">==</span> <span class="n">NFS4_CREATE_UNCHECKED</span>
		    <span class="o">||</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_createmode</span> <span class="o">==</span> <span class="n">NFS4_CREATE_GUARDED</span>
		    <span class="o">||</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_createmode</span> <span class="o">==</span> <span class="n">NFS4_CREATE_EXCLUSIVE4_1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * if error occurs when setting the acl, just clear the acl bit</span>
<span class="cm"> * in the returned attr bitmap.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">do_set_nfs4_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">fhp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs4_acl</span> <span class="o">*</span><span class="n">acl</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">bmval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_set_nfs4_acl</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">fhp</span><span class="p">,</span> <span class="n">acl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * We should probably fail the whole open at this point,</span>
<span class="cm">		 * but we&#39;ve already created the file, so it&#39;s too late;</span>
<span class="cm">		 * So this seems the least of evils:</span>
<span class="cm">		 */</span>
		<span class="n">bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FATTR4_WORD0_ACL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fh_dup2</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fh_put</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">dget</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">fh_dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">fh_export</span><span class="p">)</span>
		<span class="n">cache_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">fh_export</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">);</span>
	<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">do_open_permission</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">current_fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">,</span> <span class="kt">int</span> <span class="n">accmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_truncate</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_access</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_ACCESS_WRITE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>

	<span class="n">accmode</span> <span class="o">|=</span> <span class="n">NFSD_MAY_READ_IF_EXEC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_access</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_ACCESS_READ</span><span class="p">)</span>
		<span class="n">accmode</span> <span class="o">|=</span> <span class="n">NFSD_MAY_READ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_access</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_ACCESS_WRITE</span><span class="p">)</span>
		<span class="n">accmode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NFSD_MAY_WRITE</span> <span class="o">|</span> <span class="n">NFSD_MAY_TRUNC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_deny</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_DENY_READ</span><span class="p">)</span>
		<span class="n">accmode</span> <span class="o">|=</span> <span class="n">NFSD_MAY_WRITE</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">fh_verify</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">current_fh</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="p">,</span> <span class="n">accmode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd_check_obj_isreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">umode_t</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_isdir</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Using err_symlink as our catch-all case may look odd; but</span>
<span class="cm">	 * there&#39;s no other obvious error for this case in 4.0, and we</span>
<span class="cm">	 * happen to know that it will cause the linux v4 client to do</span>
<span class="cm">	 * the right thing on attempts to open something other than a</span>
<span class="cm">	 * regular file.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">nfserr_symlink</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">do_open_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">current_fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">resfh</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">resfh</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_fh</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resfh</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>
	<span class="n">fh_init</span><span class="p">(</span><span class="n">resfh</span><span class="p">,</span> <span class="n">NFS4_FHSIZE</span><span class="p">);</span>
	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_truncate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_create</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME: check session persistence and pnfs flags.</span>
<span class="cm">		 * The nfsv4.1 spec requires the following semantics:</span>
<span class="cm">		 *</span>
<span class="cm">		 * Persistent   | pNFS   | Server REQUIRED | Client Allowed</span>
<span class="cm">		 * Reply Cache  | server |                 |</span>
<span class="cm">		 * -------------+--------+-----------------+--------------------</span>
<span class="cm">		 * no           | no     | EXCLUSIVE4_1    | EXCLUSIVE4_1</span>
<span class="cm">		 *              |        |                 | (SHOULD)</span>
<span class="cm">		 *              |        | and EXCLUSIVE4  | or EXCLUSIVE4</span>
<span class="cm">		 *              |        |                 | (SHOULD NOT)</span>
<span class="cm">		 * no           | yes    | EXCLUSIVE4_1    | EXCLUSIVE4_1</span>
<span class="cm">		 * yes          | no     | GUARDED4        | GUARDED4</span>
<span class="cm">		 * yes          | yes    | GUARDED4        | GUARDED4</span>
<span class="cm">		 */</span>

		<span class="cm">/*</span>
<span class="cm">		 * Note: create modes (UNCHECKED,GUARDED...) are the same</span>
<span class="cm">		 * in NFSv4 as in v3 except EXCLUSIVE4_1.</span>
<span class="cm">		 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">do_nfsd_create</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">current_fh</span><span class="p">,</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
					<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_iattr</span><span class="p">,</span>
					<span class="n">resfh</span><span class="p">,</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_createmode</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_verf</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_truncate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_created</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Following rfc 3530 14.2.16, use the returned bitmask</span>
<span class="cm">		 * to indicate which attributes we used to store the</span>
<span class="cm">		 * verifier:</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_createmode</span> <span class="o">==</span> <span class="n">NFS4_CREATE_EXCLUSIVE</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">FATTR4_WORD1_TIME_ACCESS</span> <span class="o">|</span>
							<span class="n">FATTR4_WORD1_TIME_MODIFY</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_lookup</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">current_fh</span><span class="p">,</span>
				     <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">resfh</span><span class="p">);</span>
		<span class="n">fh_unlock</span><span class="p">(</span><span class="n">current_fh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_check_obj_isreg</span><span class="p">(</span><span class="n">resfh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_create_with_attrs</span><span class="p">(</span><span class="n">open</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_acl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">do_set_nfs4_acl</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">resfh</span><span class="p">,</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_acl</span><span class="p">,</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_bmval</span><span class="p">);</span>

	<span class="cm">/* set reply cache */</span>
	<span class="n">fh_copy_shallow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_replay</span><span class="p">.</span><span class="n">rp_openfh</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">resfh</span><span class="o">-&gt;</span><span class="n">fh_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_created</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">do_open_permission</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">resfh</span><span class="p">,</span> <span class="n">open</span><span class="p">,</span>
					    <span class="n">NFSD_MAY_NOP</span><span class="p">);</span>
	<span class="n">set_change_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_cinfo</span><span class="p">,</span> <span class="n">current_fh</span><span class="p">);</span>
	<span class="n">fh_dup2</span><span class="p">(</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">resfh</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">fh_put</span><span class="p">(</span><span class="n">resfh</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">resfh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">do_open_fhandle</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">current_fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t know the target directory, and therefore can not</span>
<span class="cm">	* set the change info</span>
<span class="cm">	*/</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_cinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_change_info</span><span class="p">));</span>

	<span class="cm">/* set replay cache */</span>
	<span class="n">fh_copy_shallow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_replay</span><span class="p">.</span><span class="n">rp_openfh</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">current_fh</span><span class="o">-&gt;</span><span class="n">fh_handle</span><span class="p">);</span>

	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_truncate</span> <span class="o">=</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_iattr</span><span class="p">.</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_iattr</span><span class="p">.</span><span class="n">ia_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">do_open_permission</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">current_fh</span><span class="p">,</span> <span class="n">open</span><span class="p">,</span>
				    <span class="n">NFSD_MAY_OWNER_OVERRIDE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">copy_clientid</span><span class="p">(</span><span class="n">clientid_t</span> <span class="o">*</span><span class="n">clid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_sessionid</span> <span class="o">*</span><span class="n">sid</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_sessionid</span> <span class="o">*</span><span class="p">)</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">se_sessionid</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>

	<span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_boot</span> <span class="o">=</span> <span class="n">sid</span><span class="o">-&gt;</span><span class="n">clientid</span><span class="p">.</span><span class="n">cl_boot</span><span class="p">;</span>
	<span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_id</span> <span class="o">=</span> <span class="n">sid</span><span class="o">-&gt;</span><span class="n">clientid</span><span class="p">.</span><span class="n">cl_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	   <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfsd4_open filename %.*s op_openowner %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
		<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="p">);</span>

	<span class="cm">/* This check required by spec. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_create</span> <span class="o">&amp;&amp;</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_claim_type</span> <span class="o">!=</span> <span class="n">NFS4_OPEN_CLAIM_NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>

	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_created</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * RFC5661 18.51.3</span>
<span class="cm">	 * Before RECLAIM_COMPLETE done, server should deny new lock</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfsd4_has_session</span><span class="p">(</span><span class="n">cstate</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFSD4_CLIENT_RECLAIM_COMPLETE</span><span class="p">,</span>
		      <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">se_client</span><span class="o">-&gt;</span><span class="n">cl_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_claim_type</span> <span class="o">!=</span> <span class="n">NFS4_OPEN_CLAIM_PREVIOUS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_grace</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfsd4_has_session</span><span class="p">(</span><span class="n">cstate</span><span class="p">))</span>
		<span class="n">copy_clientid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_clientid</span><span class="p">,</span> <span class="n">cstate</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">);</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>

	<span class="cm">/* check seqid for replay. set nfs4_owner */</span>
	<span class="n">resp</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_resp</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_process_open1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">,</span> <span class="n">open</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_replay_me</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs4_replay</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">.</span><span class="n">so_replay</span><span class="p">;</span>
		<span class="n">fh_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
		<span class="n">fh_copy_shallow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_handle</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rp_openfh</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">fh_verify</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NFSD_MAY_NOP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsd4_open: replay failed&quot;</span>
				<span class="s">&quot; restoring previous filehandle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_replay_me</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_check_open_attributes</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cstate</span><span class="p">,</span> <span class="n">open</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Openowner is now set, so sequence id will get bumped.  Now we need</span>
<span class="cm">	 * these checks before we do any creates: */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_grace</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locks_in_grace</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_claim_type</span> <span class="o">!=</span> <span class="n">NFS4_OPEN_CLAIM_PREVIOUS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_no_grace</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">locks_in_grace</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_claim_type</span> <span class="o">==</span> <span class="n">NFS4_OPEN_CLAIM_PREVIOUS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_claim_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_DELEGATE_CUR</span>:
		<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_NULL</span>:
			<span class="n">status</span> <span class="o">=</span> <span class="n">do_open_lookup</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
						<span class="n">open</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_PREVIOUS</span>:
			<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">|=</span> <span class="n">NFS4_OO_CONFIRMED</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_check_open_reclaim</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_clientid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_FH</span>:
		<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_DELEG_CUR_FH</span>:
			<span class="n">status</span> <span class="o">=</span> <span class="n">do_open_fhandle</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
						 <span class="n">open</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_DELEG_PREV_FH</span>:
             	<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_DELEGATE_PREV</span>:
			<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="o">-&gt;</span><span class="n">oo_flags</span> <span class="o">|=</span> <span class="n">NFS4_OO_CONFIRMED</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: unsupported OPEN claim type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_claim_type</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_notsupp</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: Invalid OPEN claim type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_claim_type</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_inval</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * nfsd4_process_open2() does the actual opening of the file.  If</span>
<span class="cm">	 * successful, it (1) truncates the file if open-&gt;op_truncate was</span>
<span class="cm">	 * set, (2) sets open-&gt;op_stateid, (3) sets open-&gt;op_delegation.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_process_open2</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">open</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_created</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">nfsd4_cleanup_open_state</span><span class="p">(</span><span class="n">open</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="p">)</span>
		<span class="n">cstate</span><span class="o">-&gt;</span><span class="n">replay_owner</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span><span class="o">-&gt;</span><span class="n">oo_owner</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * filehandle-manipulating ops.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_getfh</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">**</span><span class="n">getfh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_nofilehandle</span><span class="p">;</span>

	<span class="o">*</span><span class="n">getfh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_putfh</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">nfsd4_putfh</span> <span class="o">*</span><span class="n">putfh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fh_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
	<span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_handle</span><span class="p">.</span><span class="n">fh_size</span> <span class="o">=</span> <span class="n">putfh</span><span class="o">-&gt;</span><span class="n">pf_fhlen</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_handle</span><span class="p">.</span><span class="n">fh_base</span><span class="p">,</span> <span class="n">putfh</span><span class="o">-&gt;</span><span class="n">pf_fhval</span><span class="p">,</span>
	       <span class="n">putfh</span><span class="o">-&gt;</span><span class="n">pf_fhlen</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fh_verify</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NFSD_MAY_BYPASS_GSS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_putrootfh</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">fh_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">exp_pseudoroot</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_restorefh</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">save_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_restorefh</span><span class="p">;</span>

	<span class="n">fh_dup2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">save_fh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_STATE_ID</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">SAVED_STATE_ID_FLAG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">save_stateid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_t</span><span class="p">));</span>
		<span class="n">SET_STATE_ID</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">CURRENT_STATE_ID_FLAG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_savefh</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	     <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_nofilehandle</span><span class="p">;</span>

	<span class="n">fh_dup2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">save_fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_STATE_ID</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">CURRENT_STATE_ID_FLAG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">save_stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_stateid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_t</span><span class="p">));</span>
		<span class="n">SET_STATE_ID</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">SAVED_STATE_ID_FLAG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * misc nfsv4 ops</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">nfsd4_access</span> <span class="o">*</span><span class="n">access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="o">-&gt;</span><span class="n">ac_req_access</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NFS3_ACCESS_FULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>

	<span class="n">access</span><span class="o">-&gt;</span><span class="n">ac_resp_access</span> <span class="o">=</span> <span class="n">access</span><span class="o">-&gt;</span><span class="n">ac_req_access</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfsd_access</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">access</span><span class="o">-&gt;</span><span class="n">ac_resp_access</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">access</span><span class="o">-&gt;</span><span class="n">ac_supported</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gen_boot_verifier</span><span class="p">(</span><span class="n">nfs4_verifier</span> <span class="o">*</span><span class="n">verifier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">verf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">verf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span><span class="p">)</span><span class="n">nfssvc_boot</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">verf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span><span class="p">)</span><span class="n">nfssvc_boot</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">verifier</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">verf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">verifier</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">nfsd4_commit</span> <span class="o">*</span><span class="n">commit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gen_boot_verifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">co_verf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfsd_commit</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">commit</span><span class="o">-&gt;</span><span class="n">co_offset</span><span class="p">,</span>
			     <span class="n">commit</span><span class="o">-&gt;</span><span class="n">co_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">nfsd4_create</span> <span class="o">*</span><span class="n">create</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_fh</span> <span class="n">resfh</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">dev_t</span> <span class="n">rdev</span><span class="p">;</span>

	<span class="n">fh_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resfh</span><span class="p">,</span> <span class="n">NFS4_FHSIZE</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">fh_verify</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">S_IFDIR</span><span class="p">,</span>
			   <span class="n">NFSD_MAY_CREATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">check_attr_support</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cstate</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_bmval</span><span class="p">,</span>
				    <span class="n">nfsd_attrmask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NF4LNK</span>:
		<span class="cm">/* ugh! we have to null-terminate the linktext, or</span>
<span class="cm">		 * vfs_symlink() will choke.  it is always safe to</span>
<span class="cm">		 * null-terminate by brute force, since at worst we</span>
<span class="cm">		 * will overwrite the first byte of the create namelen</span>
<span class="cm">		 * in the XDR buffer, which has already been extracted</span>
<span class="cm">		 * during XDR decode.</span>
<span class="cm">		 */</span>
		<span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_linkname</span><span class="p">[</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_linklen</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_symlink</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
				      <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_name</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_namelen</span><span class="p">,</span>
				      <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_linkname</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_linklen</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">resfh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_iattr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NF4BLK</span>:
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_specdata1</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_specdata2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_specdata1</span> <span class="o">||</span>
		    <span class="n">MINOR</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_specdata2</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_create</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
				     <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_name</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_namelen</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_iattr</span><span class="p">,</span> <span class="n">S_IFBLK</span><span class="p">,</span> <span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resfh</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NF4CHR</span>:
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_specdata1</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_specdata2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_specdata1</span> <span class="o">||</span>
		    <span class="n">MINOR</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_specdata2</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_create</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
				     <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_name</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_namelen</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_iattr</span><span class="p">,</span><span class="n">S_IFCHR</span><span class="p">,</span> <span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resfh</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NF4SOCK</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_create</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
				     <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_name</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_namelen</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_iattr</span><span class="p">,</span> <span class="n">S_IFSOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resfh</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NF4FIFO</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_create</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
				     <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_name</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_namelen</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_iattr</span><span class="p">,</span> <span class="n">S_IFIFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resfh</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NF4DIR</span>:
		<span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_iattr</span><span class="p">.</span><span class="n">ia_valid</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATTR_SIZE</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_create</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
				     <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_name</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_namelen</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_iattr</span><span class="p">,</span> <span class="n">S_IFDIR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resfh</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_badtype</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_acl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">do_set_nfs4_acl</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resfh</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_acl</span><span class="p">,</span>
				<span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_bmval</span><span class="p">);</span>

	<span class="n">fh_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
	<span class="n">set_change_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_cinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
	<span class="n">fh_dup2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resfh</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">fh_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resfh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_getattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">nfsd4_getattr</span> <span class="o">*</span><span class="n">getattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">fh_verify</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NFSD_MAY_NOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">getattr</span><span class="o">-&gt;</span><span class="n">ga_bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">NFSD_WRITEONLY_ATTRS_WORD1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>

	<span class="n">getattr</span><span class="o">-&gt;</span><span class="n">ga_bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">nfsd_suppattrs0</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">);</span>
	<span class="n">getattr</span><span class="o">-&gt;</span><span class="n">ga_bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">nfsd_suppattrs1</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">);</span>
	<span class="n">getattr</span><span class="o">-&gt;</span><span class="n">ga_bmval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">nfsd_suppattrs2</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">);</span>

	<span class="n">getattr</span><span class="o">-&gt;</span><span class="n">ga_fhp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	   <span class="k">struct</span> <span class="n">nfsd4_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_nofilehandle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">save_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_link</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
			   <span class="n">link</span><span class="o">-&gt;</span><span class="n">li_name</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">li_namelen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">save_fh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">set_change_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">li_cinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_do_lookupp</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_fh</span> <span class="n">tmp_fh</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fh_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_fh</span><span class="p">,</span> <span class="n">NFS4_FHSIZE</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">exp_pseudoroot</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_fh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp_fh</span><span class="p">.</span><span class="n">fh_dentry</span> <span class="o">==</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_dentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fh_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_fh</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">nfserr_noent</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fh_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_fh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfsd_lookup</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="s">&quot;..&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_lookupp</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	      <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfsd4_do_lookupp</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">nfsd4_lookup</span> <span class="o">*</span><span class="n">lookup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfsd_lookup</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
			   <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">lo_name</span><span class="p">,</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">lo_len</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	   <span class="k">struct</span> <span class="n">nfsd4_read</span> <span class="o">*</span><span class="n">read</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* no need to check permission - this will be done in nfsd_read() */</span>

	<span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_filp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_offset</span> <span class="o">&gt;=</span> <span class="n">OFFSET_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="cm">/* check stateid */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_preprocess_stateid_op</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_stateid</span><span class="p">,</span>
						 <span class="n">RD_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_filp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfsd4_read: couldn&#39;t process stateid!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_filp</span><span class="p">)</span>
		<span class="n">get_file</span><span class="p">(</span><span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_filp</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>
	<span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_rqstp</span> <span class="o">=</span> <span class="n">rqstp</span><span class="p">;</span>
	<span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_fhp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_readdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">nfsd4_readdir</span> <span class="o">*</span><span class="n">readdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_cookie</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">nfs4_verifier</span> <span class="n">zeroverf</span><span class="p">;</span>

	<span class="cm">/* no need to check permission - this will be done in nfsd_readdir() */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">NFSD_WRITEONLY_ATTRS_WORD1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>

	<span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">nfsd_suppattrs0</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">);</span>
	<span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">nfsd_suppattrs1</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">);</span>
	<span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_bmval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">nfsd_suppattrs2</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cookie</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cookie</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_verf</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">zeroverf</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_VERIFIER_SIZE</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">nfserr_bad_cookie</span><span class="p">;</span>

	<span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_rqstp</span> <span class="o">=</span> <span class="n">rqstp</span><span class="p">;</span>
	<span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_fhp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_readlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">nfsd4_readlink</span> <span class="o">*</span><span class="n">readlink</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">readlink</span><span class="o">-&gt;</span><span class="n">rl_rqstp</span> <span class="o">=</span> <span class="n">rqstp</span><span class="p">;</span>
	<span class="n">readlink</span><span class="o">-&gt;</span><span class="n">rl_fhp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">nfsd4_remove</span> <span class="o">*</span><span class="n">remove</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">locks_in_grace</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">nfserr_grace</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_unlink</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">remove</span><span class="o">-&gt;</span><span class="n">rm_name</span><span class="p">,</span> <span class="n">remove</span><span class="o">-&gt;</span><span class="n">rm_namelen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fh_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
		<span class="n">set_change_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">remove</span><span class="o">-&gt;</span><span class="n">rm_cinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">nfsd4_rename</span> <span class="o">*</span><span class="n">rename</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_nofilehandle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">save_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locks_in_grace</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">save_fh</span><span class="p">.</span><span class="n">fh_export</span><span class="o">-&gt;</span><span class="n">ex_flags</span>
					<span class="o">&amp;</span> <span class="n">NFSEXP_NOSUBTREECHECK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_grace</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_rename</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">save_fh</span><span class="p">,</span> <span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_sname</span><span class="p">,</span>
			     <span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_snamelen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
			     <span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_tname</span><span class="p">,</span> <span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_tnamelen</span><span class="p">);</span>

	<span class="cm">/* the underlying filesystem returns different error&#39;s than required</span>
<span class="cm">	 * by NFSv4. both save_fh and current_fh have been verified.. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_isdir</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_exist</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_notdir</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                  <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">save_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                   <span class="n">S_ISDIR</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_exist</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_change_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_sinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
		<span class="n">set_change_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_tinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">save_fh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_secinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">nfsd4_secinfo</span> <span class="o">*</span><span class="n">secinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_fh</span> <span class="n">resfh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">fh_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resfh</span><span class="p">,</span> <span class="n">NFS4_FHSIZE</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">fh_verify</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">S_IFDIR</span><span class="p">,</span> <span class="n">NFSD_MAY_EXEC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">nfsd_lookup_dentry</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
				    <span class="n">secinfo</span><span class="o">-&gt;</span><span class="n">si_name</span><span class="p">,</span> <span class="n">secinfo</span><span class="o">-&gt;</span><span class="n">si_namelen</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">exp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">exp_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfserr_noent</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">secinfo</span><span class="o">-&gt;</span><span class="n">si_exp</span> <span class="o">=</span> <span class="n">exp</span><span class="p">;</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">)</span>
		<span class="cm">/* See rfc 5661 section 2.6.3.1.1.8 */</span>
		<span class="n">fh_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_secinfo_no_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">nfsd4_secinfo_no_name</span> <span class="o">*</span><span class="n">sin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_style</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFS4_SECINFO_STYLE4_CURRENT_FH</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_SECINFO_STYLE4_PARENT</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfsd4_do_lookupp</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">exp_get</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_export</span><span class="p">);</span>
	<span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_exp</span> <span class="o">=</span> <span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_export</span><span class="p">;</span>
	<span class="n">fh_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">nfsd4_setattr</span> <span class="o">*</span><span class="n">setattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setattr</span><span class="o">-&gt;</span><span class="n">sa_iattr</span><span class="p">.</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs4_lock_state</span><span class="p">();</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_preprocess_stateid_op</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">setattr</span><span class="o">-&gt;</span><span class="n">sa_stateid</span><span class="p">,</span> <span class="n">WR_STATE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">nfs4_unlock_state</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfsd4_setattr: couldn&#39;t process stateid!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">fh_want_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserrno</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">check_attr_support</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cstate</span><span class="p">,</span> <span class="n">setattr</span><span class="o">-&gt;</span><span class="n">sa_bmval</span><span class="p">,</span>
				    <span class="n">nfsd_attrmask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setattr</span><span class="o">-&gt;</span><span class="n">sa_acl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_set_nfs4_acl</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
					    <span class="n">setattr</span><span class="o">-&gt;</span><span class="n">sa_acl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_setattr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setattr</span><span class="o">-&gt;</span><span class="n">sa_iattr</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">time_t</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">fh_drop_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">nfsd4_write</span> <span class="o">*</span><span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stateid_t</span> <span class="o">*</span><span class="n">stateid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_stateid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="cm">/* no need to check permission - this will be done in nfsd_write() */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_offset</span> <span class="o">&gt;=</span> <span class="n">OFFSET_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>

	<span class="n">nfs4_lock_state</span><span class="p">();</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_preprocess_stateid_op</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="n">stateid</span><span class="p">,</span> <span class="n">WR_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">filp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="p">)</span>
		<span class="n">get_file</span><span class="p">(</span><span class="n">filp</span><span class="p">);</span>
	<span class="n">nfs4_unlock_state</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: nfsd4_write: couldn&#39;t process stateid!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_buflen</span><span class="p">;</span>
	<span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_how_written</span> <span class="o">=</span> <span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_stable_how</span><span class="p">;</span>
	<span class="n">gen_boot_verifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_verifier</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span>  <span class="n">nfsd_write</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span>
			     <span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_offset</span><span class="p">,</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">,</span> <span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_vlen</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_how_written</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="p">)</span>
		<span class="n">fput</span><span class="p">(</span><span class="n">filp</span><span class="p">);</span>

	<span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_bytes_written</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This routine never returns NFS_OK!  If there are no other errors, it</span>
<span class="cm"> * will return NFSERR_SAME or NFSERR_NOT_SAME depending on whether the</span>
<span class="cm"> * attributes matched.  VERIFY is implemented by mapping NFSERR_SAME</span>
<span class="cm"> * to NFS_OK after the call; NVERIFY by mapping NFSERR_NOT_SAME to NFS_OK.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">_nfsd4_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">nfsd4_verify</span> <span class="o">*</span><span class="n">verify</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">fh_verify</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NFSD_MAY_NOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">check_attr_support</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cstate</span><span class="p">,</span> <span class="n">verify</span><span class="o">-&gt;</span><span class="n">ve_bmval</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">verify</span><span class="o">-&gt;</span><span class="n">ve_bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_RDATTR_ERROR</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">verify</span><span class="o">-&gt;</span><span class="n">ve_bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">NFSD_WRITEONLY_ATTRS_WORD1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">verify</span><span class="o">-&gt;</span><span class="n">ve_attrlen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>

	<span class="cm">/* count in words:</span>
<span class="cm">	 *   bitmap_len(1) + bitmap(2) + attr_len(1) = 4</span>
<span class="cm">	 */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">verify</span><span class="o">-&gt;</span><span class="n">ve_attrlen</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">count</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_encode_fattr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">,</span>
				    <span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_export</span><span class="p">,</span>
				    <span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="n">verify</span><span class="o">-&gt;</span><span class="n">ve_bmval</span><span class="p">,</span>
				    <span class="n">rqstp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* this means that nfsd4_encode_fattr() ran out of space */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_resource</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_not_same</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>

	<span class="cm">/* skip bitmap */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_not_same</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">!=</span> <span class="n">verify</span><span class="o">-&gt;</span><span class="n">ve_attrlen</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">verify</span><span class="o">-&gt;</span><span class="n">ve_attrval</span><span class="p">,</span> <span class="n">verify</span><span class="o">-&gt;</span><span class="n">ve_attrlen</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_same</span><span class="p">;</span>

<span class="nl">out_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_nverify</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">nfsd4_verify</span> <span class="o">*</span><span class="n">verify</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">_nfsd4_verify</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cstate</span><span class="p">,</span> <span class="n">verify</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_not_same</span> <span class="o">?</span> <span class="n">nfs_ok</span> <span class="o">:</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">nfsd4_verify</span> <span class="o">*</span><span class="n">verify</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">_nfsd4_verify</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cstate</span><span class="p">,</span> <span class="n">verify</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_same</span> <span class="o">?</span> <span class="n">nfs_ok</span> <span class="o">:</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NULL call.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_proc_null</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nfsd4_increment_op_stats</span><span class="p">(</span><span class="n">u32</span> <span class="n">opnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opnum</span> <span class="o">&gt;=</span> <span class="n">FIRST_NFS4_OP</span> <span class="o">&amp;&amp;</span> <span class="n">opnum</span> <span class="o">&lt;=</span> <span class="n">LAST_NFS4_OP</span><span class="p">)</span>
		<span class="n">nfsdstats</span><span class="p">.</span><span class="n">nfs4_opcount</span><span class="p">[</span><span class="n">opnum</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="n">__be32</span><span class="p">(</span><span class="o">*</span><span class="n">nfsd4op_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">typedef</span> <span class="n">u32</span><span class="p">(</span><span class="o">*</span><span class="n">nfsd4op_rsize</span><span class="p">)(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">);</span>
<span class="k">typedef</span> <span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">stateid_setter</span><span class="p">)(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">typedef</span> <span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">stateid_getter</span><span class="p">)(</span><span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">nfsd4_op_flags</span> <span class="p">{</span>
	<span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* No current filehandle required */</span>
	<span class="n">ALLOWED_ON_ABSENT_FS</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* ops processed on absent fs */</span>
	<span class="n">ALLOWED_AS_FIRST_OP</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/* ops reqired first in compound */</span>
	<span class="cm">/* For rfc 5661 section 2.6.3.1.1: */</span>
	<span class="n">OP_HANDLES_WRONGSEC</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">OP_IS_PUTFH_LIKE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span>
	<span class="cm">/*</span>
<span class="cm">	 * These are the ops whose result size we estimate before</span>
<span class="cm">	 * encoding, to avoid performing an op then not being able to</span>
<span class="cm">	 * respond or cache a response.  This includes writes and setattrs</span>
<span class="cm">	 * as well as the operations usually called &quot;nonidempotent&quot;:</span>
<span class="cm">	 */</span>
	<span class="n">OP_MODIFIES_SOMETHING</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">,</span>
	<span class="cm">/*</span>
<span class="cm">	 * Cache compounds containing these ops in the xid-based drc:</span>
<span class="cm">	 * We use the DRC for compounds containing non-idempotent</span>
<span class="cm">	 * operations, *except* those that are 4.1-specific (since</span>
<span class="cm">	 * sessions provide their own EOS), and except for stateful</span>
<span class="cm">	 * operations other than setclientid and setclientid_confirm</span>
<span class="cm">	 * (since sequence numbers provide EOS for open, lock, etc in</span>
<span class="cm">	 * the v4.0 case).</span>
<span class="cm">	 */</span>
	<span class="n">OP_CACHEME</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span>
	<span class="cm">/*</span>
<span class="cm">	 * These are ops which clear current state id.</span>
<span class="cm">	 */</span>
	<span class="n">OP_CLEAR_STATEID</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nfsd4_operation</span> <span class="p">{</span>
	<span class="n">nfsd4op_func</span> <span class="n">op_func</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">op_flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">op_name</span><span class="p">;</span>
	<span class="cm">/* Try to get response size before operation */</span>
	<span class="n">nfsd4op_rsize</span> <span class="n">op_rsize_bop</span><span class="p">;</span>
	<span class="n">stateid_setter</span> <span class="n">op_get_currentstateid</span><span class="p">;</span>
	<span class="n">stateid_getter</span> <span class="n">op_set_currentstateid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfsd4_operation</span> <span class="n">nfsd4_ops</span><span class="p">[];</span>

<span class="cp">#ifdef NFSD_DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nfsd4_op_name</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">opnum</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Enforce NFSv4.1 COMPOUND ordering rules:</span>
<span class="cm"> *</span>
<span class="cm"> * Also note, enforced elsewhere:</span>
<span class="cm"> *	- SEQUENCE other than as first op results in</span>
<span class="cm"> *	  NFS4ERR_SEQUENCE_POS. (Enforced in nfsd4_sequence().)</span>
<span class="cm"> *	- BIND_CONN_TO_SESSION must be the only op in its compound.</span>
<span class="cm"> *	  (Enforced in nfsd4_bind_conn_to_session().)</span>
<span class="cm"> *	- DESTROY_SESSION must be the final operation in a compound, if</span>
<span class="cm"> *	  sessionid&#39;s in SEQUENCE and DESTROY_SESSION are the same.</span>
<span class="cm"> *	  (Enforced in nfsd4_destroy_session().)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfs41_check_op_ordering</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* These ordering requirements don&#39;t apply to NFSv4.0: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">minorversion</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="cm">/* This is weird, but OK, not our problem: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_op_illegal</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">nfsd4_ops</span><span class="p">[</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span><span class="p">].</span><span class="n">op_flags</span> <span class="o">&amp;</span> <span class="n">ALLOWED_AS_FIRST_OP</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_op_not_in_session</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span> <span class="o">==</span> <span class="n">OP_SEQUENCE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_not_only_op</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">nfsd4_operation</span> <span class="o">*</span><span class="nf">OPDESC</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">nfsd4_ops</span><span class="p">[</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span><span class="p">];</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">nfsd4_cache_this_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">OPDESC</span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;</span> <span class="n">OP_CACHEME</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">need_wrongsec_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_argp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nfsd4_operation</span> <span class="o">*</span><span class="n">thisd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_operation</span> <span class="o">*</span><span class="n">nextd</span><span class="p">;</span>

	<span class="n">thisd</span> <span class="o">=</span> <span class="n">OPDESC</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Most ops check wronsec on our own; only the putfh-like ops</span>
<span class="cm">	 * have special rules.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">thisd</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;</span> <span class="n">OP_IS_PUTFH_LIKE</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * rfc 5661 2.6.3.1.1.6: don&#39;t bother erroring out a</span>
<span class="cm">	 * put-filehandle operation if we&#39;re not going to use the</span>
<span class="cm">	 * result:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">==</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">nextd</span> <span class="o">=</span> <span class="n">OPDESC</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Rest of 2.6.3.1.1: certain operations will return WRONGSEC</span>
<span class="cm">	 * errors themselves as necessary; others should check for them</span>
<span class="cm">	 * now:</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">nextd</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;</span> <span class="n">OP_HANDLES_WRONGSEC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * COMPOUND call.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_proc_compound</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_op</span>	<span class="o">*</span><span class="n">op</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_operation</span> <span class="o">*</span><span class="n">opdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cstate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">slack_bytes</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">plen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be32</span>		<span class="n">status</span><span class="p">;</span>

	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_res</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_res</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">+</span>
						<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_res</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">tagp</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
	<span class="cm">/* reserve space for: taglen, tag, and opcnt */</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">taglen</span><span class="p">);</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_res</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">taglen</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">taglen</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span> <span class="o">=</span> <span class="n">rqstp</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">minorversion</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">replay_owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fh_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">current_fh</span><span class="p">,</span> <span class="n">NFS4_FHSIZE</span><span class="p">);</span>
	<span class="n">fh_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">save_fh</span><span class="p">,</span> <span class="n">NFS4_FHSIZE</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t use the deferral mechanism for NFSv4; compounds make it</span>
<span class="cm">	 * too hard to avoid non-idempotency problems.</span>
<span class="cm">	 */</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_usedeferral</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * According to RFC3010, this takes precedence over all other errors.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_minor_vers_mismatch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">minorversion</span> <span class="o">&gt;</span> <span class="n">nfsd_supported_minorversion</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs41_check_op_ordering</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">encode_op</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">opcnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span><span class="o">++</span><span class="p">];</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsv4 compound op #%d/%d: %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">opcnt</span><span class="p">,</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span><span class="p">,</span>
			<span class="n">nfsd4_op_name</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * The XDR decode routines may have pre-set op-&gt;status;</span>
<span class="cm">		 * for example, if there is a miscellaneous XDR error</span>
<span class="cm">		 * it will be set to nfserr_bad_xdr.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">encode_op</span><span class="p">;</span>

		<span class="cm">/* We must be able to encode a successful response to</span>
<span class="cm">		 * this operation, with enough room left over to encode a</span>
<span class="cm">		 * failed response to the next operation.  If we don&#39;t</span>
<span class="cm">		 * have enough room, fail with ERR_RESOURCE.</span>
<span class="cm">		 */</span>
		<span class="n">slack_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slack_bytes</span> <span class="o">&lt;</span> <span class="n">COMPOUND_SLACK_SPACE</span>
				<span class="o">+</span> <span class="n">COMPOUND_ERR_SLACK_SPACE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">slack_bytes</span> <span class="o">&lt;</span> <span class="n">COMPOUND_ERR_SLACK_SPACE</span><span class="p">);</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_resource</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">encode_op</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">opdesc</span> <span class="o">=</span> <span class="n">OPDESC</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_dentry</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">opdesc</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;</span> <span class="n">ALLOWED_WITHOUT_FH</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_nofilehandle</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">encode_op</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_export</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">migrated</span> <span class="o">&amp;&amp;</span>
			  <span class="o">!</span><span class="p">(</span><span class="n">opdesc</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;</span> <span class="n">ALLOWED_ON_ABSENT_FS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_moved</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">encode_op</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If op is non-idempotent */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opdesc</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">plen</span> <span class="o">=</span> <span class="n">opdesc</span><span class="o">-&gt;</span><span class="n">op_rsize_bop</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_check_resp_size</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">encode_op</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opdesc</span><span class="o">-&gt;</span><span class="n">op_func</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opdesc</span><span class="o">-&gt;</span><span class="n">op_get_currentstateid</span><span class="p">)</span>
				<span class="n">opdesc</span><span class="o">-&gt;</span><span class="n">op_get_currentstateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">opdesc</span><span class="o">-&gt;</span><span class="n">op_func</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfs_ok</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opdesc</span><span class="o">-&gt;</span><span class="n">op_set_currentstateid</span><span class="p">)</span>
				<span class="n">opdesc</span><span class="o">-&gt;</span><span class="n">op_set_currentstateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">opdesc</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;</span> <span class="n">OP_CLEAR_STATEID</span><span class="p">)</span>
				<span class="n">clear_current_stateid</span><span class="p">(</span><span class="n">cstate</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">need_wrongsec_check</span><span class="p">(</span><span class="n">rqstp</span><span class="p">))</span>
				<span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">check_nfsd_access</span><span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">current_fh</span><span class="p">.</span><span class="n">fh_export</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">);</span>
		<span class="p">}</span>

<span class="nl">encode_op:</span>
		<span class="cm">/* Only from SEQUENCE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_replay_cache</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s NFS4.1 replay from cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_replay_me</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">replay</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">replay_owner</span><span class="o">-&gt;</span><span class="n">so_replay</span><span class="p">;</span>
			<span class="n">nfsd4_encode_replay</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">replay</span><span class="o">-&gt;</span><span class="n">rp_status</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nfsd4_encode_operation</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsv4 compound op %p opcnt %d #%d: %d: status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">opcnt</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span><span class="p">,</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span><span class="p">,</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cstate</span><span class="o">-&gt;</span><span class="n">replay_owner</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nfs4_unlock_state</span><span class="p">();</span>
			<span class="n">cstate</span><span class="o">-&gt;</span><span class="n">replay_owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* XXX Ugh, we need to get rid of this kind of special case: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span> <span class="o">==</span> <span class="n">OP_READ</span> <span class="o">&amp;&amp;</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">rd_filp</span><span class="p">)</span>
			<span class="n">fput</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">rd_filp</span><span class="p">);</span>

		<span class="n">nfsd4_increment_op_stats</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">fh_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">current_fh</span><span class="p">);</span>
	<span class="n">fh_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">save_fh</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">replay_owner</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="cm">/* Reset deferral mechanism for RPC deferrals */</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_usedeferral</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsv4 compound returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define op_encode_hdr_size		(2)</span>
<span class="cp">#define op_encode_stateid_maxsz		(XDR_QUADLEN(NFS4_STATEID_SIZE))</span>
<span class="cp">#define op_encode_verifier_maxsz	(XDR_QUADLEN(NFS4_VERIFIER_SIZE))</span>
<span class="cp">#define op_encode_change_info_maxsz	(5)</span>
<span class="cp">#define nfs4_fattr_bitmap_maxsz		(4)</span>

<span class="cp">#define op_encode_lockowner_maxsz	(1 + XDR_QUADLEN(IDMAP_NAMESZ))</span>
<span class="cp">#define op_encode_lock_denied_maxsz	(8 + op_encode_lockowner_maxsz)</span>

<span class="cp">#define nfs4_owner_maxsz		(1 + XDR_QUADLEN(IDMAP_NAMESZ))</span>

<span class="cp">#define op_encode_ace_maxsz		(3 + nfs4_owner_maxsz)</span>
<span class="cp">#define op_encode_delegation_maxsz	(1 + op_encode_stateid_maxsz + 1 + \</span>
<span class="cp">					 op_encode_ace_maxsz)</span>

<span class="cp">#define op_encode_channel_attrs_maxsz	(6 + 1 + 1)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_only_status_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_status_stateid_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> <span class="n">op_encode_stateid_maxsz</span><span class="p">)</span><span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_commit_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> <span class="n">op_encode_verifier_maxsz</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_create_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> <span class="n">op_encode_change_info_maxsz</span>
		<span class="o">+</span> <span class="n">nfs4_fattr_bitmap_maxsz</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_link_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> <span class="n">op_encode_change_info_maxsz</span><span class="p">)</span>
		<span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_lock_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> <span class="n">op_encode_lock_denied_maxsz</span><span class="p">)</span>
		<span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_open_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> <span class="n">op_encode_stateid_maxsz</span>
		<span class="o">+</span> <span class="n">op_encode_change_info_maxsz</span> <span class="o">+</span> <span class="mi">1</span>
		<span class="o">+</span> <span class="n">nfs4_fattr_bitmap_maxsz</span>
		<span class="o">+</span> <span class="n">op_encode_delegation_maxsz</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_read_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">maxcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">maxcount</span> <span class="o">=</span> <span class="n">svc_max_payload</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>
	<span class="n">rlen</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">rd_length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">&gt;</span> <span class="n">maxcount</span><span class="p">)</span>
		<span class="n">rlen</span> <span class="o">=</span> <span class="n">maxcount</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">)</span> <span class="o">+</span> <span class="n">rlen</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_readdir_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rlen</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">readdir</span><span class="p">.</span><span class="n">rd_maxcount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">rlen</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> <span class="n">op_encode_verifier_maxsz</span><span class="p">)</span>
		 <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">)</span> <span class="o">+</span> <span class="n">rlen</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_remove_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> <span class="n">op_encode_change_info_maxsz</span><span class="p">)</span>
		<span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_rename_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> <span class="n">op_encode_change_info_maxsz</span>
		<span class="o">+</span> <span class="n">op_encode_change_info_maxsz</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_setattr_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> <span class="n">nfs4_fattr_bitmap_maxsz</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_setclientid_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_write_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> <span class="n">op_encode_verifier_maxsz</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_exchange_id_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="cm">/* eir_clientid, eir_sequenceid */</span>\
		<span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="cm">/* eir_flags, spr_how, SP4_NONE (for now) */</span>\
		<span class="mi">2</span> <span class="o">+</span> <span class="cm">/*eir_server_owner.so_minor_id */</span>\
		<span class="cm">/* eir_server_owner.so_major_id&lt;&gt; */</span>\
		<span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">NFS4_OPAQUE_LIMIT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>\
		<span class="cm">/* eir_server_scope&lt;&gt; */</span>\
		<span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">NFS4_OPAQUE_LIMIT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>\
		<span class="mi">1</span> <span class="o">+</span> <span class="cm">/* eir_server_impl_id array length */</span>\
		<span class="mi">0</span> <span class="cm">/* ignored eir_server_impl_id contents */</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_bind_conn_to_session_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> \
		<span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">NFS4_MAX_SESSIONID_LEN</span><span class="p">)</span> <span class="o">+</span> <span class="cm">/* bctsr_sessid */</span>\
		<span class="mi">2</span> <span class="cm">/* bctsr_dir, use_conn_in_rdma_mode */</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nfsd4_create_session_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op_encode_hdr_size</span> <span class="o">+</span> \
		<span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">NFS4_MAX_SESSIONID_LEN</span><span class="p">)</span> <span class="o">+</span> <span class="cm">/* sessionid */</span>\
		<span class="mi">2</span> <span class="o">+</span> <span class="cm">/* csr_sequence, csr_flags */</span>\
		<span class="n">op_encode_channel_attrs_maxsz</span> <span class="o">+</span> \
		<span class="n">op_encode_channel_attrs_maxsz</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfsd4_operation</span> <span class="n">nfsd4_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">OP_ACCESS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_access</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_ACCESS&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_CLOSE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_close</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_CLOSE&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_status_stateid_rsize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_get_currentstateid</span> <span class="o">=</span> <span class="p">(</span><span class="n">stateid_getter</span><span class="p">)</span><span class="n">nfsd4_get_closestateid</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_set_currentstateid</span> <span class="o">=</span> <span class="p">(</span><span class="n">stateid_setter</span><span class="p">)</span><span class="n">nfsd4_set_closestateid</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_COMMIT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_commit</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_COMMIT&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_commit_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_CREATE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_create</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_MODIFIES_SOMETHING</span> <span class="o">|</span> <span class="n">OP_CACHEME</span> <span class="o">|</span> <span class="n">OP_CLEAR_STATEID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_CREATE&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_create_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_DELEGRETURN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_delegreturn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_DELEGRETURN&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="n">nfsd4_only_status_rsize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_get_currentstateid</span> <span class="o">=</span> <span class="p">(</span><span class="n">stateid_getter</span><span class="p">)</span><span class="n">nfsd4_get_delegreturnstateid</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_GETATTR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_getattr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_ON_ABSENT_FS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_GETATTR&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_GETFH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_getfh</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_GETFH&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_LINK</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_link</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_ON_ABSENT_FS</span> <span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span>
				<span class="o">|</span> <span class="n">OP_CACHEME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_LINK&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_link_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_LOCK</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_lock</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_LOCK&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_lock_rsize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_set_currentstateid</span> <span class="o">=</span> <span class="p">(</span><span class="n">stateid_setter</span><span class="p">)</span><span class="n">nfsd4_set_lockstateid</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_LOCKT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_lockt</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_LOCKT&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_LOCKU</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_locku</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_LOCKU&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_status_stateid_rsize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_get_currentstateid</span> <span class="o">=</span> <span class="p">(</span><span class="n">stateid_getter</span><span class="p">)</span><span class="n">nfsd4_get_lockustateid</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_LOOKUP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_lookup</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_HANDLES_WRONGSEC</span> <span class="o">|</span> <span class="n">OP_CLEAR_STATEID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_LOOKUP&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_LOOKUPP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_lookupp</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_HANDLES_WRONGSEC</span> <span class="o">|</span> <span class="n">OP_CLEAR_STATEID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_LOOKUPP&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_NVERIFY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_nverify</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_NVERIFY&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_OPEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_open</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_HANDLES_WRONGSEC</span> <span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_OPEN&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_open_rsize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_set_currentstateid</span> <span class="o">=</span> <span class="p">(</span><span class="n">stateid_setter</span><span class="p">)</span><span class="n">nfsd4_set_openstateid</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_OPEN_CONFIRM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_open_confirm</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_OPEN_CONFIRM&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_status_stateid_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_OPEN_DOWNGRADE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_open_downgrade</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_OPEN_DOWNGRADE&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_status_stateid_rsize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_get_currentstateid</span> <span class="o">=</span> <span class="p">(</span><span class="n">stateid_getter</span><span class="p">)</span><span class="n">nfsd4_get_opendowngradestateid</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_set_currentstateid</span> <span class="o">=</span> <span class="p">(</span><span class="n">stateid_setter</span><span class="p">)</span><span class="n">nfsd4_set_opendowngradestateid</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_PUTFH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_putfh</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">ALLOWED_ON_ABSENT_FS</span>
				<span class="o">|</span> <span class="n">OP_IS_PUTFH_LIKE</span> <span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span>
				<span class="o">|</span> <span class="n">OP_CLEAR_STATEID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_PUTFH&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_only_status_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_PUTPUBFH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_putrootfh</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">ALLOWED_ON_ABSENT_FS</span>
				<span class="o">|</span> <span class="n">OP_IS_PUTFH_LIKE</span> <span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span>
				<span class="o">|</span> <span class="n">OP_CLEAR_STATEID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_PUTPUBFH&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_only_status_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_PUTROOTFH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_putrootfh</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">ALLOWED_ON_ABSENT_FS</span>
				<span class="o">|</span> <span class="n">OP_IS_PUTFH_LIKE</span> <span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span>
				<span class="o">|</span> <span class="n">OP_CLEAR_STATEID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_PUTROOTFH&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_only_status_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_READ</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_READ&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_read_rsize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_get_currentstateid</span> <span class="o">=</span> <span class="p">(</span><span class="n">stateid_getter</span><span class="p">)</span><span class="n">nfsd4_get_readstateid</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_READDIR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_readdir</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_READDIR&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_readdir_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_READLINK</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_readlink</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_READLINK&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_REMOVE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_remove</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_MODIFIES_SOMETHING</span> <span class="o">|</span> <span class="n">OP_CACHEME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_REMOVE&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_remove_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_RENAME</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_rename</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_MODIFIES_SOMETHING</span> <span class="o">|</span> <span class="n">OP_CACHEME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_RENAME&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_rename_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_RENEW</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_renew</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">ALLOWED_ON_ABSENT_FS</span>
				<span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_RENEW&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_only_status_rsize</span><span class="p">,</span>

	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_RESTOREFH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_restorefh</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">ALLOWED_ON_ABSENT_FS</span>
				<span class="o">|</span> <span class="n">OP_IS_PUTFH_LIKE</span> <span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_RESTOREFH&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_only_status_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_SAVEFH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_savefh</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_HANDLES_WRONGSEC</span> <span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_SAVEFH&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_only_status_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_SECINFO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_secinfo</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_HANDLES_WRONGSEC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_SECINFO&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_SETATTR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_setattr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_SETATTR&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_MODIFIES_SOMETHING</span> <span class="o">|</span> <span class="n">OP_CACHEME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_setattr_rsize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_get_currentstateid</span> <span class="o">=</span> <span class="p">(</span><span class="n">stateid_getter</span><span class="p">)</span><span class="n">nfsd4_get_setattrstateid</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_SETCLIENTID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_setclientid</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">ALLOWED_ON_ABSENT_FS</span>
				<span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span> <span class="o">|</span> <span class="n">OP_CACHEME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_SETCLIENTID&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_setclientid_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_SETCLIENTID_CONFIRM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_setclientid_confirm</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">ALLOWED_ON_ABSENT_FS</span>
				<span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span> <span class="o">|</span> <span class="n">OP_CACHEME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_SETCLIENTID_CONFIRM&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_only_status_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_VERIFY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_verify</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_VERIFY&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_WRITE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_MODIFIES_SOMETHING</span> <span class="o">|</span> <span class="n">OP_CACHEME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_WRITE&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_write_rsize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_get_currentstateid</span> <span class="o">=</span> <span class="p">(</span><span class="n">stateid_getter</span><span class="p">)</span><span class="n">nfsd4_get_writestateid</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_RELEASE_LOCKOWNER</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_release_lockowner</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">ALLOWED_ON_ABSENT_FS</span>
				<span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_RELEASE_LOCKOWNER&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_only_status_rsize</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="cm">/* NFSv4.1 operations */</span>
	<span class="p">[</span><span class="n">OP_EXCHANGE_ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_exchange_id</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">ALLOWED_AS_FIRST_OP</span>
				<span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_EXCHANGE_ID&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_exchange_id_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_BIND_CONN_TO_SESSION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_bind_conn_to_session</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">ALLOWED_AS_FIRST_OP</span>
				<span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_BIND_CONN_TO_SESSION&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_bind_conn_to_session_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_CREATE_SESSION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_create_session</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">ALLOWED_AS_FIRST_OP</span>
				<span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_CREATE_SESSION&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_create_session_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_DESTROY_SESSION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_destroy_session</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">ALLOWED_AS_FIRST_OP</span>
				<span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_DESTROY_SESSION&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_only_status_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_SEQUENCE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_sequence</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">ALLOWED_AS_FIRST_OP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_SEQUENCE&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_DESTROY_CLIENTID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_destroy_clientid</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">ALLOWED_AS_FIRST_OP</span>
				<span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_DESTROY_CLIENTID&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_only_status_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_RECLAIM_COMPLETE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_reclaim_complete</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_RECLAIM_COMPLETE&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_only_status_rsize</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_SECINFO_NO_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_secinfo_no_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">OP_HANDLES_WRONGSEC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_SECINFO_NO_NAME&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_TEST_STATEID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_test_stateid</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_TEST_STATEID&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">OP_FREE_STATEID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_func</span><span class="p">)</span><span class="n">nfsd4_free_stateid</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_flags</span> <span class="o">=</span> <span class="n">ALLOWED_WITHOUT_FH</span> <span class="o">|</span> <span class="n">OP_MODIFIES_SOMETHING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="s">&quot;OP_FREE_STATEID&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_rsize_bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4op_rsize</span><span class="p">)</span><span class="n">nfsd4_only_status_rsize</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#ifdef NFSD_DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">nfsd4_op_name</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">opnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opnum</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nfsd4_ops</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfsd4_ops</span><span class="p">[</span><span class="n">opnum</span><span class="p">].</span><span class="n">op_name</span><span class="p">;</span>
	<span class="k">return</span> <span class="s">&quot;unknown_operation&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define nfsd4_voidres			nfsd4_voidargs</span>
<span class="k">struct</span> <span class="n">nfsd4_voidargs</span> <span class="p">{</span> <span class="kt">int</span> <span class="n">dummy</span><span class="p">;</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_procedure</span>		<span class="n">nfsd_procedures4</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NFSPROC4_NULL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">pc_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">svc_procfunc</span><span class="p">)</span> <span class="n">nfsd4_proc_null</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pc_encode</span> <span class="o">=</span> <span class="p">(</span><span class="n">kxdrproc_t</span><span class="p">)</span> <span class="n">nfs4svc_encode_voidres</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pc_argsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_voidargs</span><span class="p">),</span>
		<span class="p">.</span><span class="n">pc_ressize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_voidres</span><span class="p">),</span>
		<span class="p">.</span><span class="n">pc_cachetype</span> <span class="o">=</span> <span class="n">RC_NOCACHE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pc_xdrressize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">NFSPROC4_COMPOUND</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">pc_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">svc_procfunc</span><span class="p">)</span> <span class="n">nfsd4_proc_compound</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pc_decode</span> <span class="o">=</span> <span class="p">(</span><span class="n">kxdrproc_t</span><span class="p">)</span> <span class="n">nfs4svc_decode_compoundargs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pc_encode</span> <span class="o">=</span> <span class="p">(</span><span class="n">kxdrproc_t</span><span class="p">)</span> <span class="n">nfs4svc_encode_compoundres</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pc_argsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span><span class="p">),</span>
		<span class="p">.</span><span class="n">pc_ressize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span><span class="p">),</span>
		<span class="p">.</span><span class="n">pc_release</span> <span class="o">=</span> <span class="n">nfsd4_release_compoundargs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pc_cachetype</span> <span class="o">=</span> <span class="n">RC_NOCACHE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pc_xdrressize</span> <span class="o">=</span> <span class="n">NFSD_BUFSIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">svc_version</span>	<span class="n">nfsd_version4</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">vs_vers</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vs_nproc</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vs_proc</span>	<span class="o">=</span> <span class="n">nfsd_procedures4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vs_dispatch</span>	<span class="o">=</span> <span class="n">nfsd_dispatch</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vs_xdrsize</span>	<span class="o">=</span> <span class="n">NFS4_SVC_XDRSIZE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> *  c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
