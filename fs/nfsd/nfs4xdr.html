<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › nfsd › nfs4xdr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>nfs4xdr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Server-side XDR for NFSv4</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2002 The Regents of the University of Michigan.</span>
<span class="cm"> *  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *  Kendrick Smith &lt;kmsmith@umich.edu&gt;</span>
<span class="cm"> *  Andy Adamson   &lt;andros@umich.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> *  modification, are permitted provided that the following conditions</span>
<span class="cm"> *  are met:</span>
<span class="cm"> *</span>
<span class="cm"> *  1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> *  2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *     documentation and/or other materials provided with the distribution.</span>
<span class="cm"> *  3. Neither the name of the University nor the names of its</span>
<span class="cm"> *     contributors may be used to endorse or promote products derived</span>
<span class="cm"> *     from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> *  THIS SOFTWARE IS PROVIDED ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED</span>
<span class="cm"> *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<span class="cm"> *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="cm"> *  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</span>
<span class="cm"> *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="cm"> *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span>
<span class="cm"> *  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
<span class="cm"> *  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="cm"> *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="cm"> *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: Neil Brown made the following observation:  We currently</span>
<span class="cm"> * initially reserve NFSD_BUFSIZE space on the transmit queue and</span>
<span class="cm"> * never release any of that until the request is complete.</span>
<span class="cm"> * It would be good to calculate a new maximum response size while</span>
<span class="cm"> * decoding the COMPOUND, and call svc_reserve with this number</span>
<span class="cm"> * at the end of nfs4svc_decode_compoundargs.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/statfs.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/svcauth_gss.h&gt;</span>

<span class="cp">#include &quot;idmap.h&quot;</span>
<span class="cp">#include &quot;acl.h&quot;</span>
<span class="cp">#include &quot;xdr4.h&quot;</span>
<span class="cp">#include &quot;vfs.h&quot;</span>
<span class="cp">#include &quot;state.h&quot;</span>
<span class="cp">#include &quot;cache.h&quot;</span>

<span class="cp">#define NFSDDBG_FACILITY		NFSDDBG_XDR</span>

<span class="cm">/*</span>
<span class="cm"> * As per referral draft, the fsid for a referral MUST be different from the fsid of the containing</span>
<span class="cm"> * directory in order to indicate to the client that a filesystem boundary is present</span>
<span class="cm"> * We use a fixed fsid for a referral</span>
<span class="cm"> */</span>
<span class="cp">#define NFS4_REFERRAL_FSID_MAJOR	0x8000000ULL</span>
<span class="cp">#define NFS4_REFERRAL_FSID_MINOR	0x8000000ULL</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">check_filename</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isdotent</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DECODE_HEAD				\</span>
<span class="cp">	__be32 *p;				\</span>
<span class="cp">	__be32 status</span>
<span class="cp">#define DECODE_TAIL				\</span>
<span class="cp">	status = 0;				\</span>
<span class="cp">out:						\</span>
<span class="cp">	return status;				\</span>
<span class="cp">xdr_error:					\</span>
<span class="cp">	dprintk(&quot;NFSD: xdr error (%s:%d)\n&quot;,	\</span>
<span class="cp">			__FILE__, __LINE__);	\</span>
<span class="cp">	status = nfserr_bad_xdr;		\</span>
<span class="cp">	goto out</span>

<span class="cp">#define READ32(x)         (x) = ntohl(*p++)</span>
<span class="cp">#define READ64(x)         do {			\</span>
<span class="cp">	(x) = (u64)ntohl(*p++) &lt;&lt; 32;		\</span>
<span class="cp">	(x) |= ntohl(*p++);			\</span>
<span class="cp">} while (0)</span>
<span class="cp">#define READTIME(x)       do {			\</span>
<span class="cp">	p++;					\</span>
<span class="cp">	(x) = ntohl(*p++);			\</span>
<span class="cp">	p++;					\</span>
<span class="cp">} while (0)</span>
<span class="cp">#define READMEM(x,nbytes) do {			\</span>
<span class="cp">	x = (char *)p;				\</span>
<span class="cp">	p += XDR_QUADLEN(nbytes);		\</span>
<span class="cp">} while (0)</span>
<span class="cp">#define SAVEMEM(x,nbytes) do {			\</span>
<span class="cp">	if (!(x = (p==argp-&gt;tmp || p == argp-&gt;tmpp) ? \</span>
<span class="cp"> 		savemem(argp, p, nbytes) :	\</span>
<span class="cp"> 		(char *)p)) {			\</span>
<span class="cp">		dprintk(&quot;NFSD: xdr error (%s:%d)\n&quot;, \</span>
<span class="cp">				__FILE__, __LINE__); \</span>
<span class="cp">		goto xdr_error;			\</span>
<span class="cp">		}				\</span>
<span class="cp">	p += XDR_QUADLEN(nbytes);		\</span>
<span class="cp">} while (0)</span>
<span class="cp">#define COPYMEM(x,nbytes) do {			\</span>
<span class="cp">	memcpy((x), p, nbytes);			\</span>
<span class="cp">	p += XDR_QUADLEN(nbytes);		\</span>
<span class="cp">} while (0)</span>

<span class="cm">/* READ_BUF, read_buf(): nbytes must be &lt;= PAGE_SIZE */</span>
<span class="cp">#define READ_BUF(nbytes)  do {			\</span>
<span class="cp">	if (nbytes &lt;= (u32)((char *)argp-&gt;end - (char *)argp-&gt;p)) {	\</span>
<span class="cp">		p = argp-&gt;p;			\</span>
<span class="cp">		argp-&gt;p += XDR_QUADLEN(nbytes);	\</span>
<span class="cp">	} else if (!(p = read_buf(argp, nbytes))) { \</span>
<span class="cp">		dprintk(&quot;NFSD: xdr error (%s:%d)\n&quot;, \</span>
<span class="cp">				__FILE__, __LINE__); \</span>
<span class="cp">		goto xdr_error;			\</span>
<span class="cp">	}					\</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="o">*</span><span class="nf">read_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">nbytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We want more bytes than seem to be available.</span>
<span class="cm">	 * Maybe we need a new page, maybe we have just run out</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">avail</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">+</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span> <span class="o">&lt;</span> <span class="n">nbytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;</span> <span class="n">nbytes</span><span class="p">)</span> <span class="cm">/* need more than a page !! */</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* ok, we can do it with the current plus the next page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">))</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">tmpp</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">tmpp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * The following memcpy is safe because read_buf is always</span>
<span class="cm">	 * called with nbytes &gt; avail, and the two cases above both</span>
<span class="cm">	 * guarantee p points to at least nbytes bytes.</span>
<span class="cm">	 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span> <span class="n">avail</span><span class="p">);</span>
	<span class="cm">/* step to next page */</span>
	<span class="n">argp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">argp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">argp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">+</span><span class="n">avail</span><span class="p">,</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">-</span> <span class="n">avail</span><span class="p">));</span>
	<span class="n">argp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">+=</span> <span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">nbytes</span> <span class="o">-</span> <span class="n">avail</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zero_clientid</span><span class="p">(</span><span class="n">clientid_t</span> <span class="o">*</span><span class="n">clid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_boot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">clid</span><span class="o">-&gt;</span><span class="n">cl_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">defer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmpbuf</span> <span class="o">*</span><span class="n">tb</span><span class="p">;</span>

	<span class="n">tb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">release</span><span class="p">;</span>
	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">to_free</span><span class="p">;</span>
	<span class="n">argp</span><span class="o">-&gt;</span><span class="n">to_free</span> <span class="o">=</span> <span class="n">tb</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">savemem</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">tmpp</span><span class="p">);</span>
		<span class="n">argp</span><span class="o">-&gt;</span><span class="n">tmpp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">defer_free</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">kfree</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_bitmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">bmval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bmlen</span><span class="p">;</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bmval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">bmlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmlen</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">bmlen</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmlen</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmlen</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_fattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">bmval</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">iattr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_acl</span> <span class="o">**</span><span class="n">acl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">expected_len</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dummy32</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">host_err</span><span class="p">;</span>

	<span class="n">DECODE_HEAD</span><span class="p">;</span>
	<span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_bitmap</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">bmval</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">expected_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">READ64</span><span class="p">(</span><span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_size</span><span class="p">);</span>
		<span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">|=</span> <span class="n">ATTR_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_ACL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nace</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">nfs4_ace</span> <span class="o">*</span><span class="n">ace</span><span class="p">;</span>

		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="n">len</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">nace</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nace</span> <span class="o">&gt;</span> <span class="n">NFS4_ACL_MAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">nfserr_resource</span><span class="p">;</span>

		<span class="o">*</span><span class="n">acl</span> <span class="o">=</span> <span class="n">nfs4_acl_new</span><span class="p">(</span><span class="n">nace</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">acl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_nfserr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">defer_free</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">kfree</span><span class="p">,</span> <span class="o">*</span><span class="n">acl</span><span class="p">);</span>

		<span class="p">(</span><span class="o">*</span><span class="n">acl</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">naces</span> <span class="o">=</span> <span class="n">nace</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ace</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">acl</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">aces</span><span class="p">;</span> <span class="n">ace</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">acl</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">aces</span> <span class="o">+</span> <span class="n">nace</span><span class="p">;</span> <span class="n">ace</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span> <span class="n">len</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">ace</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">ace</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">ace</span><span class="o">-&gt;</span><span class="n">access_mask</span><span class="p">);</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">dummy32</span><span class="p">);</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy32</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">dummy32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">READMEM</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dummy32</span><span class="p">);</span>
			<span class="n">ace</span><span class="o">-&gt;</span><span class="n">whotype</span> <span class="o">=</span> <span class="n">nfs4_acl_get_whotype</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dummy32</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ace</span><span class="o">-&gt;</span><span class="n">whotype</span> <span class="o">!=</span> <span class="n">NFS4_ACL_WHO_NAMED</span><span class="p">)</span>
				<span class="n">ace</span><span class="o">-&gt;</span><span class="n">who</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ace</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">NFS4_ACE_IDENTIFIER_GROUP</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_map_name_to_gid</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="p">,</span>
						<span class="n">buf</span><span class="p">,</span> <span class="n">dummy32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ace</span><span class="o">-&gt;</span><span class="n">who</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_map_name_to_uid</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="p">,</span>
						<span class="n">buf</span><span class="p">,</span> <span class="n">dummy32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ace</span><span class="o">-&gt;</span><span class="n">who</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">acl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_mode</span><span class="p">);</span>
		<span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_mode</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">S_IFMT</span> <span class="o">|</span> <span class="n">S_IALLUGO</span><span class="p">);</span>
		<span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">|=</span> <span class="n">ATTR_MODE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_OWNER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">dummy32</span><span class="p">);</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy32</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">dummy32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">READMEM</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dummy32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_map_name_to_uid</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dummy32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_uid</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">|=</span> <span class="n">ATTR_UID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_OWNER_GROUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">dummy32</span><span class="p">);</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy32</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">dummy32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">READMEM</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dummy32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_map_name_to_gid</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dummy32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_gid</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">|=</span> <span class="n">ATTR_GID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_TIME_ACCESS_SET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">dummy32</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dummy32</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NFS4_SET_TO_CLIENT_TIME</span>:
			<span class="cm">/* We require the high 32 bits of &#39;seconds&#39; to be 0, and we ignore</span>
<span class="cm">			   all 32 bits of &#39;nseconds&#39;. */</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">dummy32</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dummy32</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_atime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_atime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_atime</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">1000000000</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
			<span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ATTR_ATIME</span> <span class="o">|</span> <span class="n">ATTR_ATIME_SET</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFS4_SET_TO_SERVER_TIME</span>:
			<span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">|=</span> <span class="n">ATTR_ATIME</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_TIME_MODIFY_SET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">dummy32</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dummy32</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NFS4_SET_TO_CLIENT_TIME</span>:
			<span class="cm">/* We require the high 32 bits of &#39;seconds&#39; to be 0, and we ignore</span>
<span class="cm">			   all 32 bits of &#39;nseconds&#39;. */</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">dummy32</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dummy32</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_mtime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_mtime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_mtime</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">1000000000</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
			<span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ATTR_MTIME</span> <span class="o">|</span> <span class="n">ATTR_MTIME_SET</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFS4_SET_TO_SERVER_TIME</span>:
			<span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">|=</span> <span class="n">ATTR_MTIME</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NFSD_WRITEABLE_ATTRS_WORD0</span>
	    <span class="o">||</span> <span class="n">bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NFSD_WRITEABLE_ATTRS_WORD1</span>
	    <span class="o">||</span> <span class="n">bmval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NFSD_WRITEABLE_ATTRS_WORD2</span><span class="p">)</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="n">expected_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">expected_len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>

<span class="nl">out_nfserr:</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserrno</span><span class="p">(</span><span class="n">host_err</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="n">stateid_t</span> <span class="o">*</span><span class="n">sid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_t</span><span class="p">));</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sid</span><span class="o">-&gt;</span><span class="n">si_generation</span><span class="p">);</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sid</span><span class="o">-&gt;</span><span class="n">si_opaque</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_opaque_t</span><span class="p">));</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_access</span> <span class="o">*</span><span class="n">access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">access</span><span class="o">-&gt;</span><span class="n">ac_req_access</span><span class="p">);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_decode_bind_conn_to_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_bind_conn_to_session</span> <span class="o">*</span><span class="n">bcts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">NFS4_MAX_SESSIONID_LEN</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="n">bcts</span><span class="o">-&gt;</span><span class="n">sessionid</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_MAX_SESSIONID_LEN</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">bcts</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
	<span class="cm">/* XXX: skipping ctsa_use_conn_in_rdma_mode.  Perhaps Tom Tucker</span>
<span class="cm">	 * could help us figure out we should be using it. */</span>
	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_close</span> <span class="o">*</span><span class="n">close</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">close</span><span class="o">-&gt;</span><span class="n">cl_seqid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfsd4_decode_stateid</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">close</span><span class="o">-&gt;</span><span class="n">cl_stateid</span><span class="p">);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_commit</span> <span class="o">*</span><span class="n">commit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">READ64</span><span class="p">(</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">co_offset</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">co_count</span><span class="p">);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_create</span> <span class="o">*</span><span class="n">create</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_type</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NF4LNK</span>:
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_linklen</span><span class="p">);</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_linklen</span><span class="p">);</span>
		<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_linkname</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_linklen</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NF4BLK</span>:
	<span class="k">case</span> <span class="n">NF4CHR</span>:
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_specdata1</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_specdata2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NF4SOCK</span>:
	<span class="k">case</span> <span class="n">NF4FIFO</span>:
	<span class="k">case</span> <span class="n">NF4DIR</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_namelen</span><span class="p">);</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_namelen</span><span class="p">);</span>
	<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_name</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_namelen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">check_filename</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_name</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_namelen</span><span class="p">,</span> <span class="n">nfserr_inval</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_fattr</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_bmval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_iattr</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_acl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_delegreturn</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_delegreturn</span> <span class="o">*</span><span class="n">dr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfsd4_decode_stateid</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">dr_stateid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_getattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_getattr</span> <span class="o">*</span><span class="n">getattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfsd4_decode_bitmap</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">getattr</span><span class="o">-&gt;</span><span class="n">ga_bmval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">li_namelen</span><span class="p">);</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">li_namelen</span><span class="p">);</span>
	<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">li_name</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">li_namelen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">check_filename</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">li_name</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">li_namelen</span><span class="p">,</span> <span class="n">nfserr_inval</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	* type, reclaim(boolean), offset, length, new_lock_owner(boolean)</span>
<span class="cm">	*/</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">28</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_type</span> <span class="o">&lt;</span> <span class="n">NFS4_READ_LT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_type</span> <span class="o">&gt;</span> <span class="n">NFS4_WRITEW_LT</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_reclaim</span><span class="p">);</span>
	<span class="n">READ64</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_offset</span><span class="p">);</span>
	<span class="n">READ64</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_length</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_is_new</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_is_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_new_open_seqid</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_stateid</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_new_open_stateid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clientid_t</span><span class="p">));</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_new_lock_seqid</span><span class="p">);</span>
		<span class="n">COPYMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_new_clientid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clientid_t</span><span class="p">));</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_new_owner</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_new_owner</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">READMEM</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_new_owner</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_new_owner</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_stateid</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_old_lock_stateid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_old_lock_seqid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_lockt</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_lockt</span> <span class="o">*</span><span class="n">lockt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>
		        
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_type</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_type</span> <span class="o">&lt;</span> <span class="n">NFS4_READ_LT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_type</span> <span class="o">&gt;</span> <span class="n">NFS4_WRITEW_LT</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="n">READ64</span><span class="p">(</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_offset</span><span class="p">);</span>
	<span class="n">READ64</span><span class="p">(</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_length</span><span class="p">);</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_clientid</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_owner</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_owner</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">READMEM</span><span class="p">(</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_owner</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_owner</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_locku</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_locku</span> <span class="o">*</span><span class="n">locku</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_type</span> <span class="o">&lt;</span> <span class="n">NFS4_READ_LT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_type</span> <span class="o">&gt;</span> <span class="n">NFS4_WRITEW_LT</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_seqid</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_stateid</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_stateid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
	<span class="n">READ64</span><span class="p">(</span><span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_offset</span><span class="p">);</span>
	<span class="n">READ64</span><span class="p">(</span><span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_length</span><span class="p">);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_lookup</span> <span class="o">*</span><span class="n">lookup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">lookup</span><span class="o">-&gt;</span><span class="n">lo_len</span><span class="p">);</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">lookup</span><span class="o">-&gt;</span><span class="n">lo_len</span><span class="p">);</span>
	<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">lookup</span><span class="o">-&gt;</span><span class="n">lo_name</span><span class="p">,</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">lo_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">check_filename</span><span class="p">(</span><span class="n">lookup</span><span class="o">-&gt;</span><span class="n">lo_name</span><span class="p">,</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">lo_len</span><span class="p">,</span> <span class="n">nfserr_noent</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_decode_share_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">share_access</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">deleg_want</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">deleg_when</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">w</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="o">*</span><span class="n">share_access</span> <span class="o">=</span> <span class="n">w</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_ACCESS_MASK</span><span class="p">;</span>
	<span class="o">*</span><span class="n">deleg_want</span> <span class="o">=</span> <span class="n">w</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_WANT_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">deleg_when</span><span class="p">)</span>
		<span class="o">*</span><span class="n">deleg_when</span> <span class="o">=</span> <span class="n">w</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_WHEN_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_ACCESS_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFS4_SHARE_ACCESS_READ</span>:
	<span class="k">case</span> <span class="n">NFS4_SHARE_ACCESS_WRITE</span>:
	<span class="k">case</span> <span class="n">NFS4_SHARE_ACCESS_BOTH</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">nfserr_bad_xdr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS4_SHARE_ACCESS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_bad_xdr</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">NFS4_SHARE_WANT_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFS4_SHARE_WANT_NO_PREFERENCE</span>:
	<span class="k">case</span> <span class="n">NFS4_SHARE_WANT_READ_DELEG</span>:
	<span class="k">case</span> <span class="n">NFS4_SHARE_WANT_WRITE_DELEG</span>:
	<span class="k">case</span> <span class="n">NFS4_SHARE_WANT_ANY_DELEG</span>:
	<span class="k">case</span> <span class="n">NFS4_SHARE_WANT_NO_DELEG</span>:
	<span class="k">case</span> <span class="n">NFS4_SHARE_WANT_CANCEL</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">nfserr_bad_xdr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS4_SHARE_WANT_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">deleg_when</span><span class="p">)</span>	<span class="cm">/* open_downgrade */</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFS4_SHARE_SIGNAL_DELEG_WHEN_RESRC_AVAIL</span>:
	<span class="k">case</span> <span class="n">NFS4_SHARE_PUSH_DELEG_WHEN_UNCONTENDED</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">NFS4_SHARE_SIGNAL_DELEG_WHEN_RESRC_AVAIL</span> <span class="o">|</span>
	      <span class="n">NFS4_SHARE_PUSH_DELEG_WHEN_UNCONTENDED</span><span class="p">)</span><span class="o">:</span>
		<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">xdr_error:</span>
	<span class="k">return</span> <span class="n">nfserr_bad_xdr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_decode_share_deny</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">);</span>
	<span class="cm">/* Note: unlinke access bits, deny bits may be zero. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">x</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NFS4_SHARE_DENY_BOTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_bad_xdr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="nl">xdr_error:</span>
	<span class="k">return</span> <span class="n">nfserr_bad_xdr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_decode_opaque</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">NFS4_OPAQUE_LIMIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_bad_xdr</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="nl">xdr_error:</span>
	<span class="k">return</span> <span class="n">nfserr_bad_xdr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_bmval</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_bmval</span><span class="p">));</span>
	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_iattr</span><span class="p">.</span><span class="n">ia_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">open</span><span class="o">-&gt;</span><span class="n">op_openowner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* seqid, share_access, share_deny, clientid, ownerlen */</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_seqid</span><span class="p">);</span>
	<span class="cm">/* decode, yet ignore deleg_when until supported */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_share_access</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_access</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_deleg_want</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_share_deny</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_share_deny</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">clientid_t</span><span class="p">));</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_clientid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clientid_t</span><span class="p">));</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_opaque</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_owner</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_create</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_create</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFS4_OPEN_NOCREATE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_OPEN_CREATE</span>:
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_createmode</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_createmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NFS4_CREATE_UNCHECKED</span>:
		<span class="k">case</span> <span class="n">NFS4_CREATE_GUARDED</span>:
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_fattr</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_bmval</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_iattr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_acl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFS4_CREATE_EXCLUSIVE</span>:
			<span class="n">READ_BUF</span><span class="p">(</span><span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>
			<span class="n">COPYMEM</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_verf</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFS4_CREATE_EXCLUSIVE4_1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">minorversion</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>
			<span class="n">COPYMEM</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_verf</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_fattr</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_bmval</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_iattr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_acl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* open_claim */</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_claim_type</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_claim_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_NULL</span>:
	<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_DELEGATE_PREV</span>:
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">check_filename</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">nfserr_inval</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_PREVIOUS</span>:
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_DELEGATE_CUR</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_stateid</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_stateid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">check_filename</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">open</span><span class="o">-&gt;</span><span class="n">op_fname</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">nfserr_inval</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_FH</span>:
	<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_DELEG_PREV_FH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">minorversion</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
		<span class="cm">/* void */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_OPEN_CLAIM_DELEG_CUR_FH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">minorversion</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_stateid</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_stateid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_open_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open_confirm</span> <span class="o">*</span><span class="n">open_conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>
		    
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_stateid</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open_conf</span><span class="o">-&gt;</span><span class="n">oc_req_stateid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">open_conf</span><span class="o">-&gt;</span><span class="n">oc_seqid</span><span class="p">);</span>
						        
	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_open_downgrade</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open_downgrade</span> <span class="o">*</span><span class="n">open_down</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>
		    
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_stateid</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open_down</span><span class="o">-&gt;</span><span class="n">od_stateid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">open_down</span><span class="o">-&gt;</span><span class="n">od_seqid</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_share_access</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open_down</span><span class="o">-&gt;</span><span class="n">od_share_access</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">open_down</span><span class="o">-&gt;</span><span class="n">od_deleg_want</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_share_deny</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open_down</span><span class="o">-&gt;</span><span class="n">od_share_deny</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_putfh</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_putfh</span> <span class="o">*</span><span class="n">putfh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">putfh</span><span class="o">-&gt;</span><span class="n">pf_fhlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">putfh</span><span class="o">-&gt;</span><span class="n">pf_fhlen</span> <span class="o">&gt;</span> <span class="n">NFS4_FHSIZE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">putfh</span><span class="o">-&gt;</span><span class="n">pf_fhlen</span><span class="p">);</span>
	<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">putfh</span><span class="o">-&gt;</span><span class="n">pf_fhval</span><span class="p">,</span> <span class="n">putfh</span><span class="o">-&gt;</span><span class="n">pf_fhlen</span><span class="p">);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_read</span> <span class="o">*</span><span class="n">read</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_stateid</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_stateid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">READ64</span><span class="p">(</span><span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_offset</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_readdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_readdir</span> <span class="o">*</span><span class="n">readdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>
	<span class="n">READ64</span><span class="p">(</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_cookie</span><span class="p">);</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_verf</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_verf</span><span class="p">.</span><span class="n">data</span><span class="p">));</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_dircount</span><span class="p">);</span>    <span class="cm">/* just in case you needed a useless field... */</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_maxcount</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_bitmap</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_bmval</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_remove</span> <span class="o">*</span><span class="n">remove</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">remove</span><span class="o">-&gt;</span><span class="n">rm_namelen</span><span class="p">);</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">remove</span><span class="o">-&gt;</span><span class="n">rm_namelen</span><span class="p">);</span>
	<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">remove</span><span class="o">-&gt;</span><span class="n">rm_name</span><span class="p">,</span> <span class="n">remove</span><span class="o">-&gt;</span><span class="n">rm_namelen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">check_filename</span><span class="p">(</span><span class="n">remove</span><span class="o">-&gt;</span><span class="n">rm_name</span><span class="p">,</span> <span class="n">remove</span><span class="o">-&gt;</span><span class="n">rm_namelen</span><span class="p">,</span> <span class="n">nfserr_noent</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_rename</span> <span class="o">*</span><span class="n">rename</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_snamelen</span><span class="p">);</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_snamelen</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_sname</span><span class="p">,</span> <span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_snamelen</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_tnamelen</span><span class="p">);</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_tnamelen</span><span class="p">);</span>
	<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_tname</span><span class="p">,</span> <span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_tnamelen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">check_filename</span><span class="p">(</span><span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_sname</span><span class="p">,</span> <span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_snamelen</span><span class="p">,</span> <span class="n">nfserr_noent</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">check_filename</span><span class="p">(</span><span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_tname</span><span class="p">,</span> <span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_tnamelen</span><span class="p">,</span> <span class="n">nfserr_inval</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_renew</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="n">clientid_t</span> <span class="o">*</span><span class="n">clientid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">clientid_t</span><span class="p">));</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="n">clientid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clientid_t</span><span class="p">));</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_secinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nfsd4_secinfo</span> <span class="o">*</span><span class="n">secinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">secinfo</span><span class="o">-&gt;</span><span class="n">si_namelen</span><span class="p">);</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">secinfo</span><span class="o">-&gt;</span><span class="n">si_namelen</span><span class="p">);</span>
	<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">secinfo</span><span class="o">-&gt;</span><span class="n">si_name</span><span class="p">,</span> <span class="n">secinfo</span><span class="o">-&gt;</span><span class="n">si_namelen</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">check_filename</span><span class="p">(</span><span class="n">secinfo</span><span class="o">-&gt;</span><span class="n">si_name</span><span class="p">,</span> <span class="n">secinfo</span><span class="o">-&gt;</span><span class="n">si_namelen</span><span class="p">,</span>
								<span class="n">nfserr_noent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_secinfo_no_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nfsd4_secinfo_no_name</span> <span class="o">*</span><span class="n">sin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_style</span><span class="p">);</span>
	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_setattr</span> <span class="o">*</span><span class="n">setattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_stateid</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setattr</span><span class="o">-&gt;</span><span class="n">sa_stateid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfsd4_decode_fattr</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">setattr</span><span class="o">-&gt;</span><span class="n">sa_bmval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setattr</span><span class="o">-&gt;</span><span class="n">sa_iattr</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">setattr</span><span class="o">-&gt;</span><span class="n">sa_acl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_setclientid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_setclientid</span> <span class="o">*</span><span class="n">setclientid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="n">setclientid</span><span class="o">-&gt;</span><span class="n">se_verf</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_opaque</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setclientid</span><span class="o">-&gt;</span><span class="n">se_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_bad_xdr</span><span class="p">;</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">setclientid</span><span class="o">-&gt;</span><span class="n">se_callback_prog</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">setclientid</span><span class="o">-&gt;</span><span class="n">se_callback_netid_len</span><span class="p">);</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">setclientid</span><span class="o">-&gt;</span><span class="n">se_callback_netid_len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">setclientid</span><span class="o">-&gt;</span><span class="n">se_callback_netid_val</span><span class="p">,</span> <span class="n">setclientid</span><span class="o">-&gt;</span><span class="n">se_callback_netid_len</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">setclientid</span><span class="o">-&gt;</span><span class="n">se_callback_addr_len</span><span class="p">);</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">setclientid</span><span class="o">-&gt;</span><span class="n">se_callback_addr_len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">setclientid</span><span class="o">-&gt;</span><span class="n">se_callback_addr_val</span><span class="p">,</span> <span class="n">setclientid</span><span class="o">-&gt;</span><span class="n">se_callback_addr_len</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">setclientid</span><span class="o">-&gt;</span><span class="n">se_callback_ident</span><span class="p">);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_setclientid_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_setclientid_confirm</span> <span class="o">*</span><span class="n">scd_c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scd_c</span><span class="o">-&gt;</span><span class="n">sc_clientid</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scd_c</span><span class="o">-&gt;</span><span class="n">sc_confirm</span><span class="p">,</span> <span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Also used for NVERIFY */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_verify</span> <span class="o">*</span><span class="n">verify</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	struct nfsd4_compoundargs save = {</span>
<span class="c">		.p = argp-&gt;p,</span>
<span class="c">		.end = argp-&gt;end,</span>
<span class="c">		.rqstp = argp-&gt;rqstp,</span>
<span class="c">	};</span>
<span class="c">	u32             ve_bmval[2];</span>
<span class="c">	struct iattr    ve_iattr;           /* request */</span>
<span class="c">	struct nfs4_acl *ve_acl;            /* request */</span>
<span class="cp">#endif</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_bitmap</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">verify</span><span class="o">-&gt;</span><span class="n">ve_bmval</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* For convenience&#39;s sake, we compare raw xdr&#39;d attributes in</span>
<span class="cm">	 * nfsd4_proc_verify; however we still decode here just to return</span>
<span class="cm">	 * correct error in case of bad xdr. */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	status = nfsd4_decode_fattr(ve_bmval, &amp;ve_iattr, &amp;ve_acl);</span>
<span class="c">	if (status == nfserr_inval) {</span>
<span class="c">		status = nfserrno(status);</span>
<span class="c">		goto out;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">verify</span><span class="o">-&gt;</span><span class="n">ve_attrlen</span><span class="p">);</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">verify</span><span class="o">-&gt;</span><span class="n">ve_attrlen</span><span class="p">);</span>
	<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">verify</span><span class="o">-&gt;</span><span class="n">ve_attrval</span><span class="p">,</span> <span class="n">verify</span><span class="o">-&gt;</span><span class="n">ve_attrlen</span><span class="p">);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_write</span> <span class="o">*</span><span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">avail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_stateid</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_stateid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
	<span class="n">READ64</span><span class="p">(</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_offset</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_stable_how</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_stable_how</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_buflen</span><span class="p">);</span>

	<span class="cm">/* Sorry .. no magic macros for this.. *</span>
<span class="cm">	 * READ_BUF(write-&gt;wr_buflen);</span>
<span class="cm">	 * SAVEMEM(write-&gt;wr_buf, write-&gt;wr_buflen);</span>
<span class="cm">	 */</span>
	<span class="n">avail</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">+</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span> <span class="o">&lt;</span> <span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_buflen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: xdr error (%s:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">avail</span><span class="p">;</span>
	<span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_buflen</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="n">v</span><span class="o">++</span><span class="p">;</span>
		<span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span><span class="p">;</span>
			<span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">argp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">+</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">iov_len</span><span class="p">);</span>
	<span class="n">argp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span><span class="o">*</span><span class="p">)</span>  <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_vlen</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_release_lockowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_release_lockowner</span> <span class="o">*</span><span class="n">rlockowner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rlockowner</span><span class="o">-&gt;</span><span class="n">rl_clientid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clientid_t</span><span class="p">));</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">rlockowner</span><span class="o">-&gt;</span><span class="n">rl_owner</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">rlockowner</span><span class="o">-&gt;</span><span class="n">rl_owner</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">READMEM</span><span class="p">(</span><span class="n">rlockowner</span><span class="o">-&gt;</span><span class="n">rl_owner</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">rlockowner</span><span class="o">-&gt;</span><span class="n">rl_owner</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">minorversion</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">zero_clientid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rlockowner</span><span class="o">-&gt;</span><span class="n">rl_clientid</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_exchange_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">nfsd4_exchange_id</span> <span class="o">*</span><span class="n">exid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="n">exid</span><span class="o">-&gt;</span><span class="n">verifier</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_opaque</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exid</span><span class="o">-&gt;</span><span class="n">clname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_bad_xdr</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">exid</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Ignore state_protect4_a */</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">exid</span><span class="o">-&gt;</span><span class="n">spa_how</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">exid</span><span class="o">-&gt;</span><span class="n">spa_how</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SP4_NONE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SP4_MACH_CRED</span>:
		<span class="cm">/* spo_must_enforce */</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">dummy</span><span class="p">;</span>

		<span class="cm">/* spo_must_allow */</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">dummy</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SP4_SSV</span>:
		<span class="cm">/* ssp_ops */</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">dummy</span><span class="p">;</span>

		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">dummy</span><span class="p">;</span>

		<span class="cm">/* ssp_hash_algs&lt;&gt; */</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* ssp_encr_algs&lt;&gt; */</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* ssp_window and ssp_num_gss_handles */</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ignore Implementation ID */</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>    <span class="cm">/* nfs_impl_id4 array length */</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dummy</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dummy</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* nii_domain */</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>

		<span class="cm">/* nii_name */</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>

		<span class="cm">/* nii_date */</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_create_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nfsd4_create_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">dummy</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">machine_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_secflavs</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">clientid</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">seqid</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Fore channel attrs */</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">28</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span> <span class="cm">/* headerpadsz is always 0 */</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">maxreq_sz</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">maxresp_sz</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">maxresp_cached</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">maxops</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">maxreqs</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">nr_rdma_attrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">nr_rdma_attrs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">rdma_attrs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">nr_rdma_attrs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Too many fore channel attr bitmaps!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Back channel attrs */</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">28</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span> <span class="cm">/* headerpadsz is always 0 */</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">maxreq_sz</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">maxresp_sz</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">maxresp_cached</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">maxops</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">maxreqs</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">nr_rdma_attrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">nr_rdma_attrs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">rdma_attrs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">nr_rdma_attrs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Too many back channel attr bitmaps!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">callback_prog</span><span class="p">);</span>

	<span class="cm">/* callback_sec_params4 */</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">nr_secflavs</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_secflavs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dummy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RPC_AUTH_NULL</span>:
			<span class="cm">/* Nothing to read */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RPC_AUTH_UNIX</span>:
			<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
			<span class="cm">/* stamp */</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>

			<span class="cm">/* machine name */</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
			<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">machine_name</span><span class="p">,</span> <span class="n">dummy</span><span class="p">);</span>

			<span class="cm">/* uid, gid */</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">);</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">);</span>

			<span class="cm">/* more gids */</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RPC_AUTH_GSS</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC_AUTH_GSS callback secflavor &quot;</span>
				<span class="s">&quot;not supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
			<span class="cm">/* gcbp_service */</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
			<span class="cm">/* gcbp_handle_from_server */</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
			<span class="cm">/* gcbp_handle_from_client */</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">READ32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
			<span class="n">READ_BUF</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Illegal callback secflavor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_destroy_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">nfsd4_destroy_session</span> <span class="o">*</span><span class="n">destroy_session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">NFS4_MAX_SESSIONID_LEN</span><span class="p">);</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="n">destroy_session</span><span class="o">-&gt;</span><span class="n">sessionid</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_MAX_SESSIONID_LEN</span><span class="p">);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_free_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">nfsd4_free_stateid</span> <span class="o">*</span><span class="n">free_stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_t</span><span class="p">));</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">free_stateid</span><span class="o">-&gt;</span><span class="n">fr_stateid</span><span class="p">.</span><span class="n">si_generation</span><span class="p">);</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free_stateid</span><span class="o">-&gt;</span><span class="n">fr_stateid</span><span class="p">.</span><span class="n">si_opaque</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_opaque_t</span><span class="p">));</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">nfsd4_sequence</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">NFS4_MAX_SESSIONID_LEN</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">sessionid</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_MAX_SESSIONID_LEN</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">seqid</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">slotid</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">maxslots</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">cachethis</span><span class="p">);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_test_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_test_stateid</span> <span class="o">*</span><span class="n">test_stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_test_stateid_id</span> <span class="o">*</span><span class="n">stateid</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">test_stateid</span><span class="o">-&gt;</span><span class="n">ts_num_ids</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">test_stateid</span><span class="o">-&gt;</span><span class="n">ts_stateid_list</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">test_stateid</span><span class="o">-&gt;</span><span class="n">ts_num_ids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stateid</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_test_stateid_id</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stateid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfserrno</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">defer_free</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">kfree</span><span class="p">,</span> <span class="n">stateid</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stateid</span><span class="o">-&gt;</span><span class="n">ts_id_list</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stateid</span><span class="o">-&gt;</span><span class="n">ts_id_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">test_stateid</span><span class="o">-&gt;</span><span class="n">ts_stateid_list</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_decode_stateid</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stateid</span><span class="o">-&gt;</span><span class="n">ts_id_stateid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="nl">xdr_error:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFSD: xdr error (%s:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_bad_xdr</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_decode_destroy_clientid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_destroy_clientid</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">COPYMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">clientid</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_decode_reclaim_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_reclaim_complete</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>

	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rca_one_fs</span><span class="p">);</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_noop</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfs_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_notsupp</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfserr_notsupp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="n">__be32</span><span class="p">(</span><span class="o">*</span><span class="n">nfsd4_dec</span><span class="p">)(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="n">nfsd4_dec</span> <span class="n">nfsd4_dec_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">OP_ACCESS</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_access</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_CLOSE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_close</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_COMMIT</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_commit</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_CREATE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_create</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_DELEGPURGE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_DELEGRETURN</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_delegreturn</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_GETATTR</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_getattr</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_GETFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LINK</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_link</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOCK</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_lock</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOCKT</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_lockt</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOCKU</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_locku</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOOKUP</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_lookup</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOOKUPP</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_NVERIFY</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_verify</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_OPEN</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_open</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_OPENATTR</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_OPEN_CONFIRM</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_open_confirm</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_OPEN_DOWNGRADE</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_open_downgrade</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_PUTFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_putfh</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_PUTPUBFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_PUTROOTFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_READ</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_read</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_READDIR</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_readdir</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_READLINK</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_REMOVE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_remove</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_RENAME</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_rename</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_RENEW</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_renew</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_RESTOREFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SAVEFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SECINFO</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_secinfo</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SETATTR</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_setattr</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SETCLIENTID</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_setclientid</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SETCLIENTID_CONFIRM</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_setclientid_confirm</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_VERIFY</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_verify</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_WRITE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_write</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_RELEASE_LOCKOWNER</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_release_lockowner</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">nfsd4_dec</span> <span class="n">nfsd41_dec_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">OP_ACCESS</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_access</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_CLOSE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_close</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_COMMIT</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_commit</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_CREATE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_create</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_DELEGPURGE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_DELEGRETURN</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_delegreturn</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_GETATTR</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_getattr</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_GETFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LINK</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_link</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOCK</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_lock</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOCKT</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_lockt</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOCKU</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_locku</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOOKUP</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_lookup</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOOKUPP</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_NVERIFY</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_verify</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_OPEN</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_open</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_OPENATTR</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_OPEN_CONFIRM</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_OPEN_DOWNGRADE</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_open_downgrade</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_PUTFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_putfh</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_PUTPUBFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_PUTROOTFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_READ</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_read</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_READDIR</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_readdir</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_READLINK</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_REMOVE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_remove</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_RENAME</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_rename</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_RENEW</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_RESTOREFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SAVEFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SECINFO</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_secinfo</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SETATTR</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_setattr</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SETCLIENTID</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SETCLIENTID_CONFIRM</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_VERIFY</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_verify</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_WRITE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_write</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_RELEASE_LOCKOWNER</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>

	<span class="cm">/* new operations for NFSv4.1 */</span>
	<span class="p">[</span><span class="n">OP_BACKCHANNEL_CTL</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_BIND_CONN_TO_SESSION</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_bind_conn_to_session</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_EXCHANGE_ID</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_exchange_id</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_CREATE_SESSION</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_create_session</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_DESTROY_SESSION</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_destroy_session</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_FREE_STATEID</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_free_stateid</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_GET_DIR_DELEGATION</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_GETDEVICEINFO</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_GETDEVICELIST</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LAYOUTCOMMIT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LAYOUTGET</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LAYOUTRETURN</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SECINFO_NO_NAME</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_secinfo_no_name</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SEQUENCE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_sequence</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SET_SSV</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_TEST_STATEID</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_test_stateid</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_WANT_DELEGATION</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_notsupp</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_DESTROY_CLIENTID</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_destroy_clientid</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_RECLAIM_COMPLETE</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_dec</span><span class="p">)</span><span class="n">nfsd4_decode_reclaim_complete</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nfsd4_minorversion_ops</span> <span class="p">{</span>
	<span class="n">nfsd4_dec</span> <span class="o">*</span><span class="n">decoders</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nops</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfsd4_minorversion_ops</span> <span class="n">nfsd4_minorversion</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">nfsd4_dec_ops</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nfsd4_dec_ops</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">nfsd41_dec_ops</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nfsd41_dec_ops</span><span class="p">)</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_decode_compound</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECODE_HEAD</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_minorversion_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cachethis</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX: According to spec, we should check the tag</span>
<span class="cm">	 * for UTF-8 compliance.  I&#39;m postponing this for</span>
<span class="cm">	 * now because it seems that some clients do use</span>
<span class="cm">	 * binary tags.</span>
<span class="cm">	 */</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">taglen</span><span class="p">);</span>
	<span class="n">READ_BUF</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">taglen</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">SAVEMEM</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">taglen</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">);</span>
	<span class="n">READ32</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">opcnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">taglen</span> <span class="o">&gt;</span> <span class="n">NFSD4_MAX_TAGLEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">argp</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">argp</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsd: couldn&#39;t allocate room for COMPOUND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">xdr_error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">minorversion</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nfsd4_minorversion</span><span class="p">))</span>
		<span class="n">argp</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfsd4_minorversion</span><span class="p">[</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">opcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">replay</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * We can&#39;t use READ_BUF() here because we need to handle</span>
<span class="cm">		 * a missing opcode as an OP_WRITE + 1. So we need to check</span>
<span class="cm">		 * to see if we&#39;re truly at the end of our buffer or if there</span>
<span class="cm">		 * is another page we need to flip to.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">==</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* There isn&#39;t an opcode still on the wire */</span>
				<span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span> <span class="o">=</span> <span class="n">OP_WRITE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_bad_xdr</span><span class="p">;</span>
				<span class="n">argp</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * False alarm. We just hit a page boundary, but there</span>
<span class="cm">			 * is still data available.  Move pointer across page</span>
<span class="cm">			 * boundary.  *snip from READ_BUF*</span>
<span class="cm">			 */</span>
			<span class="n">argp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">argp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">);</span>
				<span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">argp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">);</span>
				<span class="n">argp</span><span class="o">-&gt;</span><span class="n">pagelen</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">++</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span> <span class="o">&gt;=</span> <span class="n">FIRST_NFS4_OP</span> <span class="o">&amp;&amp;</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span> <span class="o">&lt;=</span> <span class="n">LAST_NFS4_OP</span><span class="p">)</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">decoders</span><span class="p">[</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span><span class="p">](</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span> <span class="o">=</span> <span class="n">OP_ILLEGAL</span><span class="p">;</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_op_illegal</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">argp</span><span class="o">-&gt;</span><span class="n">opcnt</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * We&#39;ll try to cache the result in the DRC if any one</span>
<span class="cm">		 * op in the compound wants to be cached:</span>
<span class="cm">		 */</span>
		<span class="n">cachethis</span> <span class="o">|=</span> <span class="n">nfsd4_cache_this_op</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Sessions make the DRC unnecessary: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">)</span>
		<span class="n">cachethis</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">argp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_cachetype</span> <span class="o">=</span> <span class="n">cachethis</span> <span class="o">?</span> <span class="n">RC_REPLBUFF</span> <span class="o">:</span> <span class="n">RC_NOCACHE</span><span class="p">;</span>

	<span class="n">DECODE_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WRITE32(n)               *p++ = htonl(n)</span>
<span class="cp">#define WRITE64(n)               do {				\</span>
<span class="cp">	*p++ = htonl((u32)((n) &gt;&gt; 32));				\</span>
<span class="cp">	*p++ = htonl((u32)(n));					\</span>
<span class="cp">} while (0)</span>
<span class="cp">#define WRITEMEM(ptr,nbytes)     do { if (nbytes &gt; 0) {		\</span>
<span class="cp">	*(p + XDR_QUADLEN(nbytes) -1) = 0;                      \</span>
<span class="cp">	memcpy(p, ptr, nbytes);					\</span>
<span class="cp">	p += XDR_QUADLEN(nbytes);				\</span>
<span class="cp">}} while (0)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write32</span><span class="p">(</span><span class="n">__be32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write64</span><span class="p">(</span><span class="n">__be32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">write32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_change</span><span class="p">(</span><span class="n">__be32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstat</span> <span class="o">*</span><span class="n">stat</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_I_VERSION</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">write64</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_version</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">write32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
		<span class="n">write32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_cinfo</span><span class="p">(</span><span class="n">__be32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_change_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">atomic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">change_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write64</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">before_change</span><span class="p">);</span>
		<span class="n">write64</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">after_change</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">write32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">before_ctime_sec</span><span class="p">);</span>
		<span class="n">write32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">before_ctime_nsec</span><span class="p">);</span>
		<span class="n">write32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">after_ctime_sec</span><span class="p">);</span>
		<span class="n">write32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">after_ctime_nsec</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define RESERVE_SPACE(nbytes)	do {				\</span>
<span class="cp">	p = resp-&gt;p;						\</span>
<span class="cp">	BUG_ON(p + XDR_QUADLEN(nbytes) &gt; resp-&gt;end);		\</span>
<span class="cp">} while (0)</span>
<span class="cp">#define ADJUST_ARGS()		resp-&gt;p = p</span>

<span class="cm">/*</span>
<span class="cm"> * Header routine to setup seqid operation replay cache</span>
<span class="cm"> */</span>
<span class="cp">#define ENCODE_SEQID_OP_HEAD					\</span>
<span class="cp">	__be32 *save;						\</span>
<span class="cp">								\</span>
<span class="cp">	save = resp-&gt;p;</span>

<span class="cm">/*</span>
<span class="cm"> * Routine for encoding the result of a &quot;seqid-mutating&quot; NFSv4 operation.  This</span>
<span class="cm"> * is where sequence id&#39;s are incremented, and the replay cache is filled.</span>
<span class="cm"> * Note that we increment sequence id&#39;s here, at the last moment, so we&#39;re sure</span>
<span class="cm"> * we know whether the error to be returned is a sequence id mutating error.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">encode_seqid_op_tail</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">save</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_stateowner</span> <span class="o">*</span><span class="n">stateowner</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">replay_owner</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seqid_mutating_err</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">nfserr</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">stateowner</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stateowner</span><span class="o">-&gt;</span><span class="n">so_seqid</span><span class="o">++</span><span class="p">;</span>
		<span class="n">stateowner</span><span class="o">-&gt;</span><span class="n">so_replay</span><span class="p">.</span><span class="n">rp_status</span> <span class="o">=</span> <span class="n">nfserr</span><span class="p">;</span>
		<span class="n">stateowner</span><span class="o">-&gt;</span><span class="n">so_replay</span><span class="p">.</span><span class="n">rp_buflen</span> <span class="o">=</span>
			  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">save</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">stateowner</span><span class="o">-&gt;</span><span class="n">so_replay</span><span class="p">.</span><span class="n">rp_buf</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span>
			<span class="n">stateowner</span><span class="o">-&gt;</span><span class="n">so_replay</span><span class="p">.</span><span class="n">rp_buflen</span><span class="p">);</span>
		<span class="n">nfsd4_purge_closed_stateid</span><span class="p">(</span><span class="n">stateowner</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Encode as an array of strings the string given with components</span>
<span class="cm"> * separated @sep, escaped with esc_enter and esc_exit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_encode_components_esc</span><span class="p">(</span><span class="kt">char</span> <span class="n">sep</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">components</span><span class="p">,</span>
				   <span class="n">__be32</span> <span class="o">**</span><span class="n">pp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="n">esc_enter</span><span class="p">,</span> <span class="kt">char</span> <span class="n">esc_exit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">countp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">strlen</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsd4_encode_components(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">components</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_resource</span><span class="p">;</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* We will fill this in with @count later */</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">str</span> <span class="o">=</span> <span class="n">components</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">found_esc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* try to parse as esc_start, ..., esc_end, sep */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="n">esc_enter</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span> <span class="o">!=</span> <span class="n">esc_exit</span><span class="p">);</span> <span class="n">end</span><span class="o">++</span><span class="p">)</span>
				<span class="cm">/* find esc_exit or end of string */</span><span class="p">;</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!*</span><span class="n">next</span> <span class="o">||</span> <span class="o">*</span><span class="n">next</span> <span class="o">==</span> <span class="n">sep</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">str</span><span class="o">++</span><span class="p">;</span>
				<span class="n">found_esc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found_esc</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span> <span class="o">!=</span> <span class="n">sep</span><span class="p">);</span> <span class="n">end</span><span class="o">++</span><span class="p">)</span>
				<span class="cm">/* find sep or end of string */</span><span class="p">;</span>

		<span class="n">strlen</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">str</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">buflen</span> <span class="o">-=</span> <span class="p">((</span><span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">strlen</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">nfserr_resource</span><span class="p">;</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">strlen</span><span class="p">);</span>
			<span class="n">WRITEMEM</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">strlen</span><span class="p">);</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">end</span><span class="o">++</span><span class="p">;</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">countp</span><span class="p">;</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Encode as an array of strings the string given with components</span>
<span class="cm"> * separated @sep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_encode_components</span><span class="p">(</span><span class="kt">char</span> <span class="n">sep</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">components</span><span class="p">,</span>
				   <span class="n">__be32</span> <span class="o">**</span><span class="n">pp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfsd4_encode_components_esc</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * encode a location element of a fs_locations structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_encode_fs_location4</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_fs_location</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span>
				    <span class="n">__be32</span> <span class="o">**</span><span class="n">pp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_encode_components_esc</span><span class="p">(</span><span class="sc">&#39;:&#39;</span><span class="p">,</span> <span class="n">location</span><span class="o">-&gt;</span><span class="n">hosts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span>
						<span class="sc">&#39;[&#39;</span><span class="p">,</span> <span class="sc">&#39;]&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_encode_components</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">,</span> <span class="n">location</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Encode a path in RFC3530 &#39;pathname4&#39; format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_encode_path</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">**</span><span class="n">pp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">path</span> <span class="n">cur</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mnt</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">**</span><span class="n">components</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ncomponents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">err</span> <span class="o">=</span> <span class="n">nfserr_jukebox</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsd4_encode_components(&quot;</span><span class="p">);</span>

	<span class="n">path_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur</span><span class="p">);</span>
	<span class="cm">/* First walk the path up to the nfsd root, and store the</span>
<span class="cm">	 * dentries/path components in an array.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">dentry</span> <span class="o">==</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">&amp;&amp;</span> <span class="n">cur</span><span class="p">.</span><span class="n">mnt</span> <span class="o">==</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">dentry</span> <span class="o">==</span> <span class="n">cur</span><span class="p">.</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mnt_root</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">follow_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ncomponents</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dentry</span> <span class="o">**</span><span class="n">new</span><span class="p">;</span>
			<span class="n">new</span> <span class="o">=</span> <span class="n">krealloc</span><span class="p">(</span><span class="n">components</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ncomponents</span> <span class="o">+</span> <span class="mi">16</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="n">components</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">components</span><span class="p">[</span><span class="n">ncomponents</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="p">.</span><span class="n">dentry</span><span class="p">;</span>
		<span class="n">cur</span><span class="p">.</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">dget_parent</span><span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">dentry</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">ncomponents</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ncomponents</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">ncomponents</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

		<span class="o">*</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">WRITEMEM</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;/%s&quot;</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
		<span class="n">ncomponents</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ncomponents</span><span class="p">)</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="o">--</span><span class="n">ncomponents</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">components</span><span class="p">);</span>
	<span class="n">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_encode_fsloc_fsroot</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">**</span><span class="n">pp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp_ps</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">exp_ps</span> <span class="o">=</span> <span class="n">rqst_find_fsidzero_export</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">exp_ps</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserrno</span><span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">exp_ps</span><span class="p">));</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">nfsd4_encode_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp_ps</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">exp_put</span><span class="p">(</span><span class="n">exp_ps</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  encode a fs_locations structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_encode_fs_locations</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span><span class="p">,</span>
				     <span class="n">__be32</span> <span class="o">**</span><span class="n">pp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_fs_locations</span> <span class="o">*</span><span class="n">fslocs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_encode_fsloc_fsroot</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_resource</span><span class="p">;</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">fslocs</span><span class="o">-&gt;</span><span class="n">locations_count</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">fslocs</span><span class="o">-&gt;</span><span class="n">locations_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_encode_fs_location4</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fslocs</span><span class="o">-&gt;</span><span class="n">locations</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						   <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">nfs4_file_type</span><span class="p">(</span><span class="n">umode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">S_IFMT</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S_IFIFO</span>:	<span class="k">return</span> <span class="n">NF4FIFO</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S_IFCHR</span>:	<span class="k">return</span> <span class="n">NF4CHR</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S_IFDIR</span>:	<span class="k">return</span> <span class="n">NF4DIR</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S_IFBLK</span>:	<span class="k">return</span> <span class="n">NF4BLK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S_IFLNK</span>:	<span class="k">return</span> <span class="n">NF4LNK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S_IFREG</span>:	<span class="k">return</span> <span class="n">NF4REG</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S_IFSOCK</span>:	<span class="k">return</span> <span class="n">NF4SOCK</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="k">return</span> <span class="n">NF4BAD</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whotype</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">group</span><span class="p">,</span>
			<span class="n">__be32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">IDMAP_NAMESZ</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_resource</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">whotype</span> <span class="o">!=</span> <span class="n">NFS4_ACL_WHO_NAMED</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_acl_write_who</span><span class="p">(</span><span class="n">whotype</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">group</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_map_gid_to_name</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd_map_uid_to_name</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserrno</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">xdr_encode_opaque</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="o">*</span><span class="n">buflen</span> <span class="o">-=</span> <span class="p">(</span><span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">*</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfsd4_encode_name</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">NFS4_ACL_WHO_NAMED</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">gid</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfsd4_encode_name</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">NFS4_ACL_WHO_NAMED</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_aclname</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whotype</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">group</span><span class="p">,</span>
		<span class="n">__be32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfsd4_encode_name</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">whotype</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define WORD0_ABSENT_FS_ATTRS (FATTR4_WORD0_FS_LOCATIONS | FATTR4_WORD0_FSID | \</span>
<span class="cp">			      FATTR4_WORD0_RDATTR_ERROR)</span>
<span class="cp">#define WORD1_ABSENT_FS_ATTRS FATTR4_WORD1_MOUNTED_ON_FILEID</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">fattr_handle_absent_fs</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">bmval0</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">bmval1</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rdattr_err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* As per referral draft:  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WORD0_ABSENT_FS_ATTRS</span> <span class="o">||</span>
	    <span class="o">*</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WORD1_ABSENT_FS_ATTRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_RDATTR_ERROR</span> <span class="o">||</span>
	            <span class="o">*</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_FS_LOCATIONS</span><span class="p">)</span>
			<span class="o">*</span><span class="n">rdattr_err</span> <span class="o">=</span> <span class="n">NFSERR_MOVED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">nfserr_moved</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">bmval0</span> <span class="o">&amp;=</span> <span class="n">WORD0_ABSENT_FS_ATTRS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bmval1</span> <span class="o">&amp;=</span> <span class="n">WORD1_ABSENT_FS_ATTRS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Note: @fhp can be NULL; in this case, we might have to compose the filehandle</span>
<span class="cm"> * ourselves.</span>
<span class="cm"> *</span>
<span class="cm"> * @countp is the buffer size in _words_; upon successful return this becomes</span>
<span class="cm"> * replaced with the number of words written.</span>
<span class="cm"> */</span>
<span class="n">__be32</span>
<span class="nf">nfsd4_encode_fattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">fhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">countp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">bmval</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore_crossmnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bmval0</span> <span class="o">=</span> <span class="n">bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">bmval1</span> <span class="o">=</span> <span class="n">bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">bmval2</span> <span class="o">=</span> <span class="n">bmval</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">kstat</span> <span class="n">stat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_fh</span> <span class="n">tempfh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kstatfs</span> <span class="n">statfs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buflen</span> <span class="o">=</span> <span class="o">*</span><span class="n">countp</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">attrlenp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dummy</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dummy64</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rdattr_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aclsupport</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_acl</span> <span class="o">*</span><span class="n">acl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_resp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">minorversion</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">minorversion</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">path</span> <span class="n">path</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mnt</span>	<span class="o">=</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">.</span><span class="n">mnt</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dentry</span>	<span class="o">=</span> <span class="n">dentry</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">NFSD_WRITEONLY_ATTRS_WORD1</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">nfsd_suppattrs0</span><span class="p">(</span><span class="n">minorversion</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">nfsd_suppattrs1</span><span class="p">(</span><span class="n">minorversion</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bmval2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">nfsd_suppattrs2</span><span class="p">(</span><span class="n">minorversion</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">migrated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">fattr_handle_absent_fs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bmval0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmval1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdattr_err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">vfs_getattr</span><span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">.</span><span class="n">mnt</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nfserr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FATTR4_WORD0_FILES_FREE</span> <span class="o">|</span> <span class="n">FATTR4_WORD0_FILES_TOTAL</span> <span class="o">|</span>
			<span class="n">FATTR4_WORD0_MAXNAME</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FATTR4_WORD1_SPACE_AVAIL</span> <span class="o">|</span> <span class="n">FATTR4_WORD1_SPACE_FREE</span> <span class="o">|</span>
		       <span class="n">FATTR4_WORD1_SPACE_TOTAL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">vfs_statfs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">statfs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_nfserr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FATTR4_WORD0_FILEHANDLE</span> <span class="o">|</span> <span class="n">FATTR4_WORD0_FSID</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fhp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fh_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tempfh</span><span class="p">,</span> <span class="n">NFS4_FHSIZE</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">fh_compose</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tempfh</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">fhp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tempfh</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FATTR4_WORD0_ACL</span> <span class="o">|</span> <span class="n">FATTR4_WORD0_ACLSUPPORT</span>
			<span class="o">|</span> <span class="n">FATTR4_WORD0_SUPPORTED_ATTRS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfsd4_get_nfs4_acl</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acl</span><span class="p">);</span>
		<span class="n">aclsupport</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_ACL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span>
				<span class="n">bmval0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FATTR4_WORD0_ACL</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_attrnotsupp</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nfserr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bmval2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">bmval0</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">bmval1</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">bmval2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">bmval0</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">bmval1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">bmval0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">attrlenp</span> <span class="o">=</span> <span class="n">p</span><span class="o">++</span><span class="p">;</span>                <span class="cm">/* to be backfilled later */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_SUPPORTED_ATTRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">word0</span> <span class="o">=</span> <span class="n">nfsd_suppattrs0</span><span class="p">(</span><span class="n">minorversion</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">word1</span> <span class="o">=</span> <span class="n">nfsd_suppattrs1</span><span class="p">(</span><span class="n">minorversion</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">word2</span> <span class="o">=</span> <span class="n">nfsd_suppattrs2</span><span class="p">(</span><span class="n">minorversion</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aclsupport</span><span class="p">)</span>
			<span class="n">word0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FATTR4_WORD0_ACL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">word2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">word0</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">word1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">word0</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">word1</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">word2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">dummy</span> <span class="o">=</span> <span class="n">nfs4_file_type</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dummy</span> <span class="o">==</span> <span class="n">NF4BAD</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_serverfault</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_FH_EXPIRE_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_flags</span> <span class="o">&amp;</span> <span class="n">NFSEXP_NOSUBTREECHECK</span><span class="p">)</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">NFS4_FH_PERSISTENT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">NFS4_FH_PERSISTENT</span><span class="o">|</span><span class="n">NFS4_FH_VOL_RENAME</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_CHANGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">write_change</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE64</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_LINK_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_SYMLINK_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_NAMED_ATTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_FSID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">migrated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WRITE64</span><span class="p">(</span><span class="n">NFS4_REFERRAL_FSID_MAJOR</span><span class="p">);</span>
			<span class="n">WRITE64</span><span class="p">(</span><span class="n">NFS4_REFERRAL_FSID_MINOR</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">switch</span><span class="p">(</span><span class="n">fsid_source</span><span class="p">(</span><span class="n">fhp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FSIDSOURCE_FSID</span>:
			<span class="n">WRITE64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_fsid</span><span class="p">);</span>
			<span class="n">WRITE64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FSIDSOURCE_DEV</span>:
			<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">dev</span><span class="p">));</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">MINOR</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">dev</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FSIDSOURCE_UUID</span>:
			<span class="n">WRITEMEM</span><span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_uuid</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_UNIQUE_HANDLES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_LEASE_TIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">nfsd4_lease</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_RDATTR_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">rdattr_err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_ACL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs4_ace</span> <span class="o">*</span><span class="n">ace</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">acl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>

			<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_acl</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">naces</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ace</span> <span class="o">=</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">aces</span><span class="p">;</span> <span class="n">ace</span> <span class="o">&lt;</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">aces</span> <span class="o">+</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">naces</span><span class="p">;</span> <span class="n">ace</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">ace</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">ace</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">ace</span><span class="o">-&gt;</span><span class="n">access_mask</span> <span class="o">&amp;</span> <span class="n">NFS4_ACE_MASK_ALL</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_encode_aclname</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">ace</span><span class="o">-&gt;</span><span class="n">whotype</span><span class="p">,</span>
				<span class="n">ace</span><span class="o">-&gt;</span><span class="n">who</span><span class="p">,</span> <span class="n">ace</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">NFS4_ACE_IDENTIFIER_GROUP</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buflen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_resource</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out_acl:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_ACLSUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">aclsupport</span> <span class="o">?</span>
			<span class="n">ACL4_SUPPORT_ALLOW_ACL</span><span class="o">|</span><span class="n">ACL4_SUPPORT_DENY_ACL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_CANSETTIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_CASE_INSENSITIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_CASE_PRESERVING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_CHOWN_RESTRICTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_FILEHANDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buflen</span> <span class="o">-=</span> <span class="p">(</span><span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">fhp</span><span class="o">-&gt;</span><span class="n">fh_handle</span><span class="p">.</span><span class="n">fh_size</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">fhp</span><span class="o">-&gt;</span><span class="n">fh_handle</span><span class="p">.</span><span class="n">fh_size</span><span class="p">);</span>
		<span class="n">WRITEMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fhp</span><span class="o">-&gt;</span><span class="n">fh_handle</span><span class="p">.</span><span class="n">fh_base</span><span class="p">,</span> <span class="n">fhp</span><span class="o">-&gt;</span><span class="n">fh_handle</span><span class="p">.</span><span class="n">fh_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_FILEID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE64</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">ino</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_FILES_AVAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">statfs</span><span class="p">.</span><span class="n">f_ffree</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_FILES_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">statfs</span><span class="p">.</span><span class="n">f_ffree</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_FILES_TOTAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">statfs</span><span class="p">.</span><span class="n">f_files</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_FS_LOCATIONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_encode_fs_locations</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buflen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_resource</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_HOMOGENEOUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_MAXFILESIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE64</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_MAXLINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_MAXNAME</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">statfs</span><span class="p">.</span><span class="n">f_namelen</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_MAXREAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">svc_max_payload</span><span class="p">(</span><span class="n">rqstp</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval0</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_MAXWRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">svc_max_payload</span><span class="p">(</span><span class="n">rqstp</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">S_IALLUGO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_NO_TRUNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_NUMLINKS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">nlink</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_OWNER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_encode_user</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buflen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_resource</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_OWNER_GROUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_encode_group</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buflen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">nfserr_resource</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_RAWDEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">rdev</span><span class="p">));</span>
		<span class="n">WRITE32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">rdev</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_SPACE_AVAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">dummy64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">statfs</span><span class="p">.</span><span class="n">f_bavail</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">statfs</span><span class="p">.</span><span class="n">f_bsize</span><span class="p">;</span>
		<span class="n">WRITE64</span><span class="p">(</span><span class="n">dummy64</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_SPACE_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">dummy64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">statfs</span><span class="p">.</span><span class="n">f_bfree</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">statfs</span><span class="p">.</span><span class="n">f_bsize</span><span class="p">;</span>
		<span class="n">WRITE64</span><span class="p">(</span><span class="n">dummy64</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_SPACE_TOTAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">dummy64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">statfs</span><span class="p">.</span><span class="n">f_blocks</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">statfs</span><span class="p">.</span><span class="n">f_bsize</span><span class="p">;</span>
		<span class="n">WRITE64</span><span class="p">(</span><span class="n">dummy64</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_SPACE_USED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">dummy64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">stat</span><span class="p">.</span><span class="n">blocks</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">WRITE64</span><span class="p">(</span><span class="n">dummy64</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_TIME_ACCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">atime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">atime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_TIME_DELTA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_TIME_METADATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">ctime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">ctime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_TIME_MODIFY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">mtime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">mtime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval1</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_MOUNTED_ON_FILEID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                	<span class="k">goto</span> <span class="n">out_resource</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Get parent&#39;s attributes if not ignoring crossmount</span>
<span class="cm">		 * and this is the root of a cross-mounted filesystem.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ignore_crossmnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dentry</span> <span class="o">==</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">.</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mnt_root</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">;</span>
			<span class="n">path_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">follow_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span> <span class="o">!=</span> <span class="n">path</span><span class="p">.</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mnt_root</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">vfs_getattr</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">mnt</span><span class="p">,</span> <span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
			<span class="n">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nfserr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">WRITE64</span><span class="p">(</span><span class="n">stat</span><span class="p">.</span><span class="n">ino</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval2</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD2_SUPPATTR_EXCLCREAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">NFSD_SUPPATTR_EXCLCREAT_WORD0</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">NFSD_SUPPATTR_EXCLCREAT_WORD1</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">NFSD_SUPPATTR_EXCLCREAT_WORD2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">attrlenp</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">attrlenp</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="o">*</span><span class="n">countp</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fhp</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">tempfh</span><span class="p">)</span>
		<span class="n">fh_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tempfh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="nl">out_nfserr:</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserrno</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">out_resource:</span>
	<span class="o">*</span><span class="n">countp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_resource</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">out_serverfault:</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfserr_serverfault</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">attributes_need_mount</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">bmval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">FATTR4_WORD0_RDATTR_ERROR</span> <span class="o">|</span> <span class="n">FATTR4_WORD0_LEASE_TIME</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FATTR4_WORD1_MOUNTED_ON_FILEID</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_dirent_fattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_readdir</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">namlen</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span> <span class="o">=</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">rd_fhp</span><span class="o">-&gt;</span><span class="n">fh_export</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">nfserr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ignore_crossmnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dentry</span> <span class="o">=</span> <span class="n">lookup_one_len</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">rd_fhp</span><span class="o">-&gt;</span><span class="n">fh_dentry</span><span class="p">,</span> <span class="n">namlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserrno</span><span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * nfsd_buffered_readdir drops the i_mutex between</span>
<span class="cm">		 * readdir and calling this callback, leaving a window</span>
<span class="cm">		 * where this directory entry could have gone away.</span>
<span class="cm">		 */</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">nfserr_noent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">exp_get</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * In the case of a mountpoint, the client may be asking for</span>
<span class="cm">	 * attributes that are only properties of the underlying filesystem</span>
<span class="cm">	 * as opposed to the cross-mounted file system. In such a case,</span>
<span class="cm">	 * we will not follow the cross mount and will fill the attribtutes</span>
<span class="cm">	 * directly from the mountpoint dentry.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfsd_mountpoint</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">exp</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_flags</span> <span class="o">&amp;</span> <span class="n">NFSEXP_V4ROOT</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">attributes_need_mount</span><span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">rd_bmval</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ignore_crossmnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_encode</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Why the heck aren&#39;t we just using nfsd_lookup??</span>
<span class="cm">		 * Different &quot;.&quot;/&quot;..&quot; handling?  Something else?</span>
<span class="cm">		 * At least, add a comment here to explain....</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfsd_cross_mnt</span><span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">rd_rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nfserr</span> <span class="o">=</span> <span class="n">nfserrno</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nfserr</span> <span class="o">=</span> <span class="n">check_nfsd_access</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">rd_rqstp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>

	<span class="p">}</span>
<span class="nl">out_encode:</span>
	<span class="n">nfserr</span> <span class="o">=</span> <span class="n">nfsd4_encode_fattr</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">rd_bmval</span><span class="p">,</span>
					<span class="n">cd</span><span class="o">-&gt;</span><span class="n">rd_rqstp</span><span class="p">,</span> <span class="n">ignore_crossmnt</span><span class="p">);</span>
<span class="nl">out_put:</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">exp_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="o">*</span>
<span class="nf">nfsd4_encode_rdattr_error</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">attrlenp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FATTR4_WORD0_RDATTR_ERROR</span><span class="p">);</span> <span class="cm">/* bmval0 */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>			 <span class="cm">/* bmval1 */</span>

	<span class="n">attrlenp</span> <span class="o">=</span> <span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">nfserr</span><span class="p">;</span>       <span class="cm">/* no htonl */</span>
	<span class="o">*</span><span class="n">attrlenp</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">attrlenp</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nfsd4_encode_dirent</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ccdv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">namlen</span><span class="p">,</span>
		    <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ino</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">readdir_cd</span> <span class="o">*</span><span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_readdir</span> <span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_readdir</span><span class="p">,</span> <span class="n">common</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">buflen</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">cookiep</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">nfserr</span> <span class="o">=</span> <span class="n">nfserr_toosmall</span><span class="p">;</span>

	<span class="cm">/* In nfsv4, &quot;.&quot; and &quot;..&quot; never make it onto the wire.. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="n">isdotent</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namlen</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cd</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span>
		<span class="n">xdr_encode_hyper</span><span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">buflen</span> <span class="o">=</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">namlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">xdr_one</span><span class="p">;</span>                             <span class="cm">/* mark entry present */</span>
	<span class="n">cookiep</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">xdr_encode_hyper</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">NFS_OFFSET_MAX</span><span class="p">);</span>    <span class="cm">/* offset of next entry */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">xdr_encode_array</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namlen</span><span class="p">);</span>      <span class="cm">/* name length &amp; name */</span>

	<span class="n">nfserr</span> <span class="o">=</span> <span class="n">nfsd4_encode_dirent_fattr</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namlen</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buflen</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">nfs_ok</span>:
		<span class="n">p</span> <span class="o">+=</span> <span class="n">buflen</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">nfserr_resource</span>:
		<span class="n">nfserr</span> <span class="o">=</span> <span class="n">nfserr_toosmall</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">nfserr_noent</span>:
		<span class="k">goto</span> <span class="n">skip_entry</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the client requested the RDATTR_ERROR attribute,</span>
<span class="cm">		 * we stuff the error code into this attribute</span>
<span class="cm">		 * and continue.  If this attribute was not requested,</span>
<span class="cm">		 * then in accordance with the spec, we fail the</span>
<span class="cm">		 * entire READDIR operation(!)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">rd_bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_RDATTR_ERROR</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">nfsd4_encode_rdattr_error</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">nfserr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nfserr</span> <span class="o">=</span> <span class="n">nfserr_toosmall</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cd</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">-=</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">cd</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">cd</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">cookiep</span><span class="p">;</span>
<span class="nl">skip_entry:</span>
	<span class="n">cd</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">nfs_ok</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">cd</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">nfserr</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfsd4_encode_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">stateid_t</span> <span class="o">*</span><span class="n">sid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_t</span><span class="p">));</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sid</span><span class="o">-&gt;</span><span class="n">si_generation</span><span class="p">);</span>
	<span class="n">WRITEMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sid</span><span class="o">-&gt;</span><span class="n">si_opaque</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stateid_opaque_t</span><span class="p">));</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_access</span> <span class="o">*</span><span class="n">access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">access</span><span class="o">-&gt;</span><span class="n">ac_supported</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">access</span><span class="o">-&gt;</span><span class="n">ac_resp_access</span><span class="p">);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nfsd4_encode_bind_conn_to_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_bind_conn_to_session</span> <span class="o">*</span><span class="n">bcts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="n">NFS4_MAX_SESSIONID_LEN</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">WRITEMEM</span><span class="p">(</span><span class="n">bcts</span><span class="o">-&gt;</span><span class="n">sessionid</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_MAX_SESSIONID_LEN</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">bcts</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
		<span class="cm">/* XXX: ? */</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_close</span> <span class="o">*</span><span class="n">close</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ENCODE_SEQID_OP_HEAD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="n">nfsd4_encode_stateid</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">close</span><span class="o">-&gt;</span><span class="n">cl_stateid</span><span class="p">);</span>

	<span class="n">encode_seqid_op_tail</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">nfserr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_commit</span> <span class="o">*</span><span class="n">commit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>
		<span class="n">WRITEMEM</span><span class="p">(</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">co_verf</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_create</span> <span class="o">*</span><span class="n">create</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
		<span class="n">write_cinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_cinfo</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cr_bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_getattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_getattr</span> <span class="o">*</span><span class="n">getattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">fhp</span> <span class="o">=</span> <span class="n">getattr</span><span class="o">-&gt;</span><span class="n">ga_fhp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buflen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>

	<span class="n">buflen</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="n">COMPOUND_ERR_SLACK_SPACE</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">nfserr</span> <span class="o">=</span> <span class="n">nfsd4_encode_fattr</span><span class="p">(</span><span class="n">fhp</span><span class="p">,</span> <span class="n">fhp</span><span class="o">-&gt;</span><span class="n">fh_export</span><span class="p">,</span> <span class="n">fhp</span><span class="o">-&gt;</span><span class="n">fh_dentry</span><span class="p">,</span>
				    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buflen</span><span class="p">,</span> <span class="n">getattr</span><span class="o">-&gt;</span><span class="n">ga_bmval</span><span class="p">,</span>
				    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">+=</span> <span class="n">buflen</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_getfh</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">**</span><span class="n">fhpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">fhp</span> <span class="o">=</span> <span class="o">*</span><span class="n">fhpp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">fhp</span><span class="o">-&gt;</span><span class="n">fh_handle</span><span class="p">.</span><span class="n">fh_size</span><span class="p">;</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">WRITEMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fhp</span><span class="o">-&gt;</span><span class="n">fh_handle</span><span class="p">.</span><span class="n">fh_base</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* Including all fields other than the name, a LOCK4denied structure requires</span>
<span class="cm">*   8(clientid) + 4(namelen) + 8(offset) + 8(length) + 4(type) = 32 bytes.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfsd4_encode_lock_denied</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_lock_denied</span> <span class="o">*</span><span class="n">ld</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_owner</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">32</span> <span class="o">+</span> <span class="n">XDR_LEN</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
	<span class="n">WRITE64</span><span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_start</span><span class="p">);</span>
	<span class="n">WRITE64</span><span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_length</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRITEMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_clientid</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">WRITEMEM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>  <span class="cm">/* non - nfsv4 lock in conflict, no clientid nor owner */</span>
		<span class="n">WRITE64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* clientid */</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* length of owner name */</span>
	<span class="p">}</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ENCODE_SEQID_OP_HEAD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="n">nfsd4_encode_stateid</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_resp_stateid</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span> <span class="o">==</span> <span class="n">nfserr_denied</span><span class="p">)</span>
		<span class="n">nfsd4_encode_lock_denied</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lk_denied</span><span class="p">);</span>

	<span class="n">encode_seqid_op_tail</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">nfserr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_lockt</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_lockt</span> <span class="o">*</span><span class="n">lockt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span> <span class="o">==</span> <span class="n">nfserr_denied</span><span class="p">)</span>
		<span class="n">nfsd4_encode_lock_denied</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lockt</span><span class="o">-&gt;</span><span class="n">lt_denied</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_locku</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_locku</span> <span class="o">*</span><span class="n">locku</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ENCODE_SEQID_OP_HEAD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="n">nfsd4_encode_stateid</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">locku</span><span class="o">-&gt;</span><span class="n">lu_stateid</span><span class="p">);</span>

	<span class="n">encode_seqid_op_tail</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">nfserr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">write_cinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">li_cinfo</span><span class="p">);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open</span> <span class="o">*</span><span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">ENCODE_SEQID_OP_HEAD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">nfsd4_encode_stateid</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_stateid</span><span class="p">);</span>
	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="n">write_cinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_cinfo</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_rflags</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_type</span><span class="p">);</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFS4_OPEN_DELEGATE_NONE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_OPEN_DELEGATE_READ</span>:
		<span class="n">nfsd4_encode_stateid</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_stateid</span><span class="p">);</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_recall</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * TODO: ACE&#39;s in delegations</span>
<span class="cm">		 */</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">NFS4_ACE_ACCESS_ALLOWED_ACE_TYPE</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>   <span class="cm">/* XXX: is NULL principal ok? */</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_OPEN_DELEGATE_WRITE</span>:
		<span class="n">nfsd4_encode_stateid</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_delegate_stateid</span><span class="p">);</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * TODO: space_limit&#39;s in delegations</span>
<span class="cm">		 */</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">NFS4_LIMIT_SIZE</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * TODO: ACE&#39;s in delegations</span>
<span class="cm">		 */</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">NFS4_ACE_ACCESS_ALLOWED_ACE_TYPE</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>   <span class="cm">/* XXX: is NULL principal ok? */</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_OPEN_DELEGATE_NONE_EXT</span>: <span class="cm">/* 4.1 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_why_no_deleg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WND4_CONTENTION</span>:
		<span class="k">case</span> <span class="n">WND4_RESOURCE</span>:
			<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_why_no_deleg</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/* deleg signaling not supported yet */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">open</span><span class="o">-&gt;</span><span class="n">op_why_no_deleg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="cm">/* XXX save filehandle here */</span>
<span class="nl">out:</span>
	<span class="n">encode_seqid_op_tail</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">nfserr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_open_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open_confirm</span> <span class="o">*</span><span class="n">oc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ENCODE_SEQID_OP_HEAD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="n">nfsd4_encode_stateid</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">oc_resp_stateid</span><span class="p">);</span>

	<span class="n">encode_seqid_op_tail</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">nfserr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_open_downgrade</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_open_downgrade</span> <span class="o">*</span><span class="n">od</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ENCODE_SEQID_OP_HEAD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="n">nfsd4_encode_stateid</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">od</span><span class="o">-&gt;</span><span class="n">od_stateid</span><span class="p">);</span>

	<span class="n">encode_seqid_op_tail</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">nfserr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">nfsd4_read</span> <span class="o">*</span><span class="n">read</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">eof</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">pn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">maxcount</span><span class="p">;</span> 
	<span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">page_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_resource</span><span class="p">;</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span> <span class="cm">/* eof flag and byte count */</span>

	<span class="n">maxcount</span> <span class="o">=</span> <span class="n">svc_max_payload</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxcount</span> <span class="o">&gt;</span> <span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">)</span>
		<span class="n">maxcount</span> <span class="o">=</span> <span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">maxcount</span><span class="p">;</span>
	<span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pn</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_resused</span><span class="o">++</span><span class="p">;</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span>
			<span class="n">page_address</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span><span class="p">[</span><span class="n">pn</span><span class="p">]);</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span>
			<span class="n">len</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">v</span><span class="o">++</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_vlen</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">nfserr</span> <span class="o">=</span> <span class="n">nfsd_read_file</span><span class="p">(</span><span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_rqstp</span><span class="p">,</span> <span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_fhp</span><span class="p">,</span> <span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_filp</span><span class="p">,</span>
			<span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_offset</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">,</span> <span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_vlen</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">maxcount</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
	<span class="n">eof</span> <span class="o">=</span> <span class="p">(</span><span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_offset</span> <span class="o">+</span> <span class="n">maxcount</span> <span class="o">&gt;=</span>
	       <span class="n">read</span><span class="o">-&gt;</span><span class="n">rd_fhp</span><span class="o">-&gt;</span><span class="n">fh_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">);</span>

	<span class="n">WRITE32</span><span class="p">(</span><span class="n">eof</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">maxcount</span><span class="p">);</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">p</span>
					<span class="o">-</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">page_len</span> <span class="o">=</span> <span class="n">maxcount</span><span class="p">;</span>

	<span class="cm">/* Use rest of head for padding and remaining ops: */</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxcount</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">+=</span> <span class="n">maxcount</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">maxcount</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_readlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_readlink</span> <span class="o">*</span><span class="n">readlink</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">maxcount</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">page_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_resource</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span><span class="p">[</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_resused</span><span class="o">++</span><span class="p">]);</span>

	<span class="n">maxcount</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX: By default, the -&gt;readlink() VFS op will truncate symlinks</span>
<span class="cm">	 * if they would overflow the buffer.  Is this kosher in NFSv4?  If</span>
<span class="cm">	 * not, one easy fix is: if -&gt;readlink() precisely fills the buffer,</span>
<span class="cm">	 * assume that truncation occurred, and return NFS4ERR_RESOURCE.</span>
<span class="cm">	 */</span>
	<span class="n">nfserr</span> <span class="o">=</span> <span class="n">nfsd_readlink</span><span class="p">(</span><span class="n">readlink</span><span class="o">-&gt;</span><span class="n">rl_rqstp</span><span class="p">,</span> <span class="n">readlink</span><span class="o">-&gt;</span><span class="n">rl_fhp</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maxcount</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span> <span class="o">==</span> <span class="n">nfserr_isdir</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_inval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>

	<span class="n">WRITE32</span><span class="p">(</span><span class="n">maxcount</span><span class="p">);</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">p</span>
				<span class="o">-</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">page_len</span> <span class="o">=</span> <span class="n">maxcount</span><span class="p">;</span>

	<span class="cm">/* Use rest of head for padding and remaining ops: */</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxcount</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">+=</span> <span class="n">maxcount</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">maxcount</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_readdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_readdir</span> <span class="o">*</span><span class="n">readdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">maxcount</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="o">*</span><span class="n">savep</span><span class="p">,</span> <span class="o">*</span><span class="n">tailbase</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">page_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_resource</span><span class="p">;</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>
	<span class="n">savep</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="cm">/* XXX: Following NFSv3, we ignore the READDIR verifier for now. */</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">tailbase</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">maxcount</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxcount</span> <span class="o">&gt;</span> <span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_maxcount</span><span class="p">)</span>
		<span class="n">maxcount</span> <span class="o">=</span> <span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_maxcount</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert from bytes to words, account for the two words already</span>
<span class="cm">	 * written, make sure to leave two words at the end for the next</span>
<span class="cm">	 * pointer and eof field.</span>
<span class="cm">	 */</span>
	<span class="n">maxcount</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxcount</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxcount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfserr</span> <span class="o">=</span>  <span class="n">nfserr_toosmall</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_verf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span><span class="p">[</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_resused</span><span class="o">++</span><span class="p">]);</span>
	<span class="n">readdir</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">readdir</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">maxcount</span><span class="p">;</span>
	<span class="n">readdir</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">readdir</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_cookie</span><span class="p">;</span>
	<span class="n">nfserr</span> <span class="o">=</span> <span class="n">nfsd_readdir</span><span class="p">(</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_rqstp</span><span class="p">,</span> <span class="n">readdir</span><span class="o">-&gt;</span><span class="n">rd_fhp</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">,</span> <span class="n">nfsd4_encode_dirent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span> <span class="o">==</span> <span class="n">nfs_ok</span> <span class="o">&amp;&amp;</span>
	    <span class="n">readdir</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">err</span> <span class="o">==</span> <span class="n">nfserr_toosmall</span> <span class="o">&amp;&amp;</span>
	    <span class="n">readdir</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">==</span> <span class="n">page</span><span class="p">)</span> 
		<span class="n">nfserr</span> <span class="o">=</span> <span class="n">nfserr_toosmall</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_no_verf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span>
		<span class="n">xdr_encode_hyper</span><span class="p">(</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">readdir</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no more entries */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">err</span> <span class="o">==</span> <span class="n">nfserr_eof</span><span class="p">);</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">page_len</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">page_address</span><span class="p">(</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span><span class="p">[</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_resused</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* Use rest of head for padding and remaining ops: */</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">tailbase</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">xbuf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_no_verf:</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">savep</span><span class="p">;</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_remove</span> <span class="o">*</span><span class="n">remove</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">write_cinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remove</span><span class="o">-&gt;</span><span class="n">rm_cinfo</span><span class="p">);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_rename</span> <span class="o">*</span><span class="n">rename</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
		<span class="n">write_cinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_sinfo</span><span class="p">);</span>
		<span class="n">write_cinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rename</span><span class="o">-&gt;</span><span class="n">rn_tinfo</span><span class="p">);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_do_encode_secinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span>
			 <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span><span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nflavs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exp_flavor_info</span> <span class="o">*</span><span class="n">flavs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exp_flavor_info</span> <span class="n">def_flavs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_nflavors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flavs</span> <span class="o">=</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_flavors</span><span class="p">;</span>
		<span class="n">nflavs</span> <span class="o">=</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_nflavors</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Handling of some defaults in absence of real secinfo: */</span>
		<span class="n">flavs</span> <span class="o">=</span> <span class="n">def_flavs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_client</span><span class="o">-&gt;</span><span class="n">flavour</span><span class="o">-&gt;</span><span class="n">flavour</span> <span class="o">==</span> <span class="n">RPC_AUTH_UNIX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nflavs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">flavs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pseudoflavor</span> <span class="o">=</span> <span class="n">RPC_AUTH_UNIX</span><span class="p">;</span>
			<span class="n">flavs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pseudoflavor</span> <span class="o">=</span> <span class="n">RPC_AUTH_NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_client</span><span class="o">-&gt;</span><span class="n">flavour</span><span class="o">-&gt;</span><span class="n">flavour</span> <span class="o">==</span> <span class="n">RPC_AUTH_GSS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nflavs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">flavs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pseudoflavor</span>
					<span class="o">=</span> <span class="n">svcauth_gss_flavor</span><span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_client</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nflavs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">flavs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pseudoflavor</span>
					<span class="o">=</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_client</span><span class="o">-&gt;</span><span class="n">flavour</span><span class="o">-&gt;</span><span class="n">flavour</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">nflavs</span><span class="p">);</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nflavs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">flav</span> <span class="o">=</span> <span class="n">flavs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pseudoflavor</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">gss_api_mech</span> <span class="o">*</span><span class="n">gm</span> <span class="o">=</span> <span class="n">gss_mech_get_by_pseudoflavor</span><span class="p">(</span><span class="n">flav</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">RPC_AUTH_GSS</span><span class="p">);</span>
			<span class="n">ADJUST_ARGS</span><span class="p">();</span>
			<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">gm</span><span class="o">-&gt;</span><span class="n">gm_oid</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">gm</span><span class="o">-&gt;</span><span class="n">gm_oid</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
			<span class="n">WRITEMEM</span><span class="p">(</span><span class="n">gm</span><span class="o">-&gt;</span><span class="n">gm_oid</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">gm</span><span class="o">-&gt;</span><span class="n">gm_oid</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
			<span class="n">ADJUST_ARGS</span><span class="p">();</span>
			<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* qop */</span>
			<span class="n">ADJUST_ARGS</span><span class="p">();</span>
			<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">gss_pseudoflavor_to_service</span><span class="p">(</span><span class="n">gm</span><span class="p">,</span> <span class="n">flav</span><span class="p">));</span>
			<span class="n">ADJUST_ARGS</span><span class="p">();</span>
			<span class="n">gss_mech_put</span><span class="p">(</span><span class="n">gm</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">WRITE32</span><span class="p">(</span><span class="n">flav</span><span class="p">);</span>
			<span class="n">ADJUST_ARGS</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="p">)</span>
		<span class="n">exp_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_secinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nfsd4_secinfo</span> <span class="o">*</span><span class="n">secinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfsd4_do_encode_secinfo</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">nfserr</span><span class="p">,</span> <span class="n">secinfo</span><span class="o">-&gt;</span><span class="n">si_exp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_secinfo_no_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nfsd4_secinfo_no_name</span> <span class="o">*</span><span class="n">secinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfsd4_do_encode_secinfo</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">nfserr</span><span class="p">,</span> <span class="n">secinfo</span><span class="o">-&gt;</span><span class="n">sin_exp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The SETATTR encode routine is special -- it always encodes a bitmap,</span>
<span class="cm"> * regardless of the error status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_setattr</span> <span class="o">*</span><span class="n">setattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">setattr</span><span class="o">-&gt;</span><span class="n">sa_bmval</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">setattr</span><span class="o">-&gt;</span><span class="n">sa_bmval</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_setclientid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_setclientid</span> <span class="o">*</span><span class="n">scd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>
		<span class="n">WRITEMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scd</span><span class="o">-&gt;</span><span class="n">se_clientid</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">WRITEMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scd</span><span class="o">-&gt;</span><span class="n">se_confirm</span><span class="p">,</span> <span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span> <span class="o">==</span> <span class="n">nfserr_clid_inuse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_write</span> <span class="o">*</span><span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfserr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_bytes_written</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_how_written</span><span class="p">);</span>
		<span class="n">WRITEMEM</span><span class="p">(</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">wr_verifier</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_exchange_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">nfsd4_exchange_id</span> <span class="o">*</span><span class="n">exid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">major_id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">server_scope</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">major_id_sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">server_scope_sz</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">minor_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>

	<span class="n">major_id</span> <span class="o">=</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">;</span>
	<span class="n">major_id_sz</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">major_id</span><span class="p">);</span>
	<span class="n">server_scope</span> <span class="o">=</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">;</span>
	<span class="n">server_scope_sz</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">server_scope</span><span class="p">);</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span>
		<span class="mi">8</span> <span class="cm">/* eir_clientid */</span> <span class="o">+</span>
		<span class="mi">4</span> <span class="cm">/* eir_sequenceid */</span> <span class="o">+</span>
		<span class="mi">4</span> <span class="cm">/* eir_flags */</span> <span class="o">+</span>
		<span class="mi">4</span> <span class="cm">/* spr_how (SP4_NONE) */</span> <span class="o">+</span>
		<span class="mi">8</span> <span class="cm">/* so_minor_id */</span> <span class="o">+</span>
		<span class="mi">4</span> <span class="cm">/* so_major_id.len */</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">major_id_sz</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
		<span class="mi">4</span> <span class="cm">/* eir_server_scope.len */</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">server_scope_sz</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
		<span class="mi">4</span> <span class="cm">/* eir_server_impl_id.count (0) */</span><span class="p">);</span>

	<span class="n">WRITEMEM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exid</span><span class="o">-&gt;</span><span class="n">clientid</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">exid</span><span class="o">-&gt;</span><span class="n">seqid</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">exid</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* state_protect4_r. Currently only support SP4_NONE */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">exid</span><span class="o">-&gt;</span><span class="n">spa_how</span> <span class="o">!=</span> <span class="n">SP4_NONE</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">exid</span><span class="o">-&gt;</span><span class="n">spa_how</span><span class="p">);</span>

	<span class="cm">/* The server_owner struct */</span>
	<span class="n">WRITE64</span><span class="p">(</span><span class="n">minor_id</span><span class="p">);</span>      <span class="cm">/* Minor id */</span>
	<span class="cm">/* major id */</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">major_id_sz</span><span class="p">);</span>
	<span class="n">WRITEMEM</span><span class="p">(</span><span class="n">major_id</span><span class="p">,</span> <span class="n">major_id_sz</span><span class="p">);</span>

	<span class="cm">/* Server scope */</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">server_scope_sz</span><span class="p">);</span>
	<span class="n">WRITEMEM</span><span class="p">(</span><span class="n">server_scope</span><span class="p">,</span> <span class="n">server_scope_sz</span><span class="p">);</span>

	<span class="cm">/* Implementation id */</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/* zero length nfs_impl_id4 array */</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_create_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nfsd4_create_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>
	<span class="n">WRITEMEM</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">sessionid</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_MAX_SESSIONID_LEN</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">seqid</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">28</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* headerpadsz */</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">maxreq_sz</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">maxresp_sz</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">maxresp_cached</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">maxops</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">maxreqs</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">nr_rdma_attrs</span><span class="p">);</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">nr_rdma_attrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">fore_channel</span><span class="p">.</span><span class="n">rdma_attrs</span><span class="p">);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">28</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* headerpadsz */</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">maxreq_sz</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">maxresp_sz</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">maxresp_cached</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">maxops</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">maxreqs</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">nr_rdma_attrs</span><span class="p">);</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">nr_rdma_attrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">WRITE32</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">back_channel</span><span class="p">.</span><span class="n">rdma_attrs</span><span class="p">);</span>
		<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_destroy_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">nfsd4_destroy_session</span> <span class="o">*</span><span class="n">destroy_session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_free_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">nfsd4_free_stateid</span> <span class="o">*</span><span class="n">free_stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">nfserr</span><span class="p">;</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">nfsd4_sequence</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfserr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="n">NFS4_MAX_SESSIONID_LEN</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">WRITEMEM</span><span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">sessionid</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_MAX_SESSIONID_LEN</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">seqid</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">slotid</span><span class="p">);</span>
	<span class="cm">/* Note slotid&#39;s are numbered from zero: */</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">maxslots</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* sr_highest_slotid */</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">maxslots</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* sr_target_highest_slotid */</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">status_flags</span><span class="p">);</span>

	<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">datap</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span> <span class="cm">/* DRC cache data pointer */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_test_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">nfsd4_test_stateid</span> <span class="o">*</span><span class="n">test_stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd4_test_stateid_id</span> <span class="o">*</span><span class="n">stateid</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">test_stateid</span><span class="o">-&gt;</span><span class="n">ts_num_ids</span><span class="p">));</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">test_stateid</span><span class="o">-&gt;</span><span class="n">ts_num_ids</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">stateid</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">test_stateid</span><span class="o">-&gt;</span><span class="n">ts_stateid_list</span><span class="p">,</span> <span class="n">ts_id_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">stateid</span><span class="o">-&gt;</span><span class="n">ts_id_status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ADJUST_ARGS</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nfsd4_encode_noop</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">nfserr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="n">__be32</span><span class="p">(</span><span class="o">*</span> <span class="n">nfsd4_enc</span><span class="p">)(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="p">,</span> <span class="n">__be32</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Note: nfsd4_enc_ops vector is shared for v4.0 and v4.1</span>
<span class="cm"> * since we don&#39;t need to filter out obsolete ops as this is</span>
<span class="cm"> * done in the decoding phase.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">nfsd4_enc</span> <span class="n">nfsd4_enc_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">OP_ACCESS</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_access</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_CLOSE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_close</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_COMMIT</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_commit</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_CREATE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_create</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_DELEGPURGE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_DELEGRETURN</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_GETATTR</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_getattr</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_GETFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_getfh</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LINK</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_link</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOCK</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_lock</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOCKT</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_lockt</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOCKU</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_locku</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOOKUP</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LOOKUPP</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_NVERIFY</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_OPEN</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_open</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_OPENATTR</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_OPEN_CONFIRM</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_open_confirm</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_OPEN_DOWNGRADE</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_open_downgrade</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_PUTFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_PUTPUBFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_PUTROOTFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_READ</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_read</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_READDIR</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_readdir</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_READLINK</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_readlink</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_REMOVE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_remove</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_RENAME</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_rename</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_RENEW</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_RESTOREFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SAVEFH</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SECINFO</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_secinfo</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SETATTR</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_setattr</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SETCLIENTID</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_setclientid</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SETCLIENTID_CONFIRM</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_VERIFY</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_WRITE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_write</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_RELEASE_LOCKOWNER</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>

	<span class="cm">/* NFSv4.1 operations */</span>
	<span class="p">[</span><span class="n">OP_BACKCHANNEL_CTL</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_BIND_CONN_TO_SESSION</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_bind_conn_to_session</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_EXCHANGE_ID</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_exchange_id</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_CREATE_SESSION</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_create_session</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_DESTROY_SESSION</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_destroy_session</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_FREE_STATEID</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_free_stateid</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_GET_DIR_DELEGATION</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_GETDEVICEINFO</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_GETDEVICELIST</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LAYOUTCOMMIT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LAYOUTGET</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_LAYOUTRETURN</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SECINFO_NO_NAME</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_secinfo_no_name</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SEQUENCE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_sequence</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_SET_SSV</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_TEST_STATEID</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_test_stateid</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_WANT_DELEGATION</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_DESTROY_CLIENTID</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_RECLAIM_COMPLETE</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nfsd4_enc</span><span class="p">)</span><span class="n">nfsd4_encode_noop</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate the total amount of memory that the compound response has taken</span>
<span class="cm"> * after encoding the current operation with pad.</span>
<span class="cm"> *</span>
<span class="cm"> * pad: if operation is non-idempotent, pad was calculate by op_rsize_bop()</span>
<span class="cm"> *      which was specified at nfsd4_operation, else pad is zero.</span>
<span class="cm"> *</span>
<span class="cm"> * Compare this length to the session se_fmaxresp_sz and se_fmaxresp_cached.</span>
<span class="cm"> *</span>
<span class="cm"> * Our se_fmaxresp_cached will always be a multiple of PAGE_SIZE, and so</span>
<span class="cm"> * will be at least a page and will therefore hold the xdr_buf head.</span>
<span class="cm"> */</span>
<span class="n">__be32</span> <span class="nf">nfsd4_check_resp_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xdr_buf</span> <span class="o">*</span><span class="n">xb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">slot</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">,</span> <span class="n">tlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfsd4_has_session</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">session</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">.</span><span class="n">session</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xb</span><span class="o">-&gt;</span><span class="n">page_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">xb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">+</span> <span class="n">pad</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xb</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">&amp;&amp;</span> <span class="n">xb</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tlen</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">xb</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>

		<span class="n">length</span> <span class="o">=</span> <span class="n">xb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">+</span> <span class="n">xb</span><span class="o">-&gt;</span><span class="n">page_len</span> <span class="o">+</span> <span class="n">tlen</span> <span class="o">+</span> <span class="n">pad</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s length %u, xb-&gt;page_len %u tlen %u pad %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">length</span><span class="p">,</span> <span class="n">xb</span><span class="o">-&gt;</span><span class="n">page_len</span><span class="p">,</span> <span class="n">tlen</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">se_fchannel</span><span class="p">.</span><span class="n">maxresp_sz</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_rep_too_big</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_flags</span> <span class="o">&amp;</span> <span class="n">NFSD4_SLOT_CACHETHIS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">length</span> <span class="o">&gt;</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">se_fchannel</span><span class="p">.</span><span class="n">maxresp_cached</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfserr_rep_too_big_to_cache</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfsd4_encode_operation</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">statp</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span><span class="p">);</span>
	<span class="n">statp</span> <span class="o">=</span> <span class="n">p</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* to be backfilled at the end */</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span> <span class="o">==</span> <span class="n">OP_ILLEGAL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nfsd4_enc_ops</span><span class="p">)</span> <span class="o">||</span>
	       <span class="o">!</span><span class="n">nfsd4_enc_ops</span><span class="p">[</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span><span class="p">]);</span>
	<span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_enc_ops</span><span class="p">[</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span><span class="p">](</span><span class="n">resp</span><span class="p">,</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
	<span class="cm">/* nfsd4_check_drc_limit guarantees enough room for error status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nfsd4_check_resp_size</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">status:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Note: We write the status directly, instead of using WRITE32(),</span>
<span class="cm">	 * since it is already in network byte order.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">statp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> * Encode the reply stored in the stateowner reply cache </span>
<span class="cm"> * </span>
<span class="cm"> * XDR note: do not encode rp-&gt;rp_buflen: the buffer contains the</span>
<span class="cm"> * previously sent already encoded operation.</span>
<span class="cm"> *</span>
<span class="cm"> * called with nfs4_lock_state() held</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">nfsd4_encode_replay</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_replay</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">replay</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">rp</span><span class="p">);</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">WRITE32</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">opnum</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rp_status</span><span class="p">;</span>  <span class="cm">/* already xdr&#39;ed */</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>

	<span class="n">RESERVE_SPACE</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rp_buflen</span><span class="p">);</span>
	<span class="n">WRITEMEM</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rp_buf</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rp_buflen</span><span class="p">);</span>
	<span class="n">ADJUST_ARGS</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">nfs4svc_encode_voidres</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">xdr_ressize_check</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfsd4_release_compoundargs</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span> <span class="o">=</span> <span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_argp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">!=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">tmpp</span><span class="p">);</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">tmpp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">to_free</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tmpbuf</span> <span class="o">*</span><span class="n">tb</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">to_free</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">to_free</span> <span class="o">=</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">tb</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">nfs4svc_decode_compoundargs</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compoundargs</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">+</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">pagelist</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">pages</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">pagelen</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_len</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">tmpp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">to_free</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">rqstp</span> <span class="o">=</span> <span class="n">rqstp</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">nfsd4_decode_compound</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">nfs4svc_encode_compoundres</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_compoundres</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * All that remains is to write the tag and operation count...</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">nfsd4_compound_state</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">iov</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">tagp</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">taglen</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">taglen</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">taglen</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">opcnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_res</span><span class="p">.</span><span class="n">page_len</span><span class="p">)</span> 
		<span class="n">iov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_res</span><span class="p">.</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">iov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_res</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfsd4_has_session</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">nfserr_replay_cache</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nfsd4_store_cache_entry</span><span class="p">(</span><span class="n">resp</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">sl_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFSD4_SLOT_INUSE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Renew the clientid on success and on replay */</span>
		<span class="n">release_session_client</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">);</span>
		<span class="n">nfsd4_put_session</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> *  c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
