<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › nfsd › export.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>export.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * NFS exporting and validation.</span>
<span class="cm"> *</span>
<span class="cm"> * We maintain a list of clients, each of which has a list of</span>
<span class="cm"> * exports. To export an fs to a given client, you first have</span>
<span class="cm"> * to create the client entry with NFSCTL_ADDCLIENT, which</span>
<span class="cm"> * creates a client control block and adds it to the hash</span>
<span class="cm"> * table. Then, you call NFSCTL_EXPORT for each fs.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1995, 1996 Olaf Kirch, &lt;okir@monad.swb.de&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/exportfs.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/svc_xprt.h&gt;</span>

<span class="cp">#include &lt;net/ipv6.h&gt;</span>

<span class="cp">#include &quot;nfsd.h&quot;</span>
<span class="cp">#include &quot;nfsfh.h&quot;</span>
<span class="cp">#include &quot;netns.h&quot;</span>

<span class="cp">#define NFSDDBG_FACILITY	NFSDDBG_EXPORT</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">auth_domain</span>	<span class="n">svc_client</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">svc_export</span>	<span class="n">svc_export</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * We have two caches.</span>
<span class="cm"> * One maps client+vfsmnt+dentry to export options - the export map</span>
<span class="cm"> * The other maps client+filehandle-fragment to export options. - the expkey map</span>
<span class="cm"> *</span>
<span class="cm"> * The export options are actually stored in the first map, and the</span>
<span class="cm"> * second map contains a reference to the entry in the first map.</span>
<span class="cm"> */</span>

<span class="cp">#define	EXPKEY_HASHBITS		8</span>
<span class="cp">#define	EXPKEY_HASHMAX		(1 &lt;&lt; EXPKEY_HASHBITS)</span>
<span class="cp">#define	EXPKEY_HASHMASK		(EXPKEY_HASHMAX -1)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">expkey_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">ref</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CACHE_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CACHE_NEGATIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">ek_path</span><span class="p">);</span>
	<span class="n">auth_domain_put</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">ek_client</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">expkey_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">**</span><span class="n">bpp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">blen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* client fsidtype \xfsid */</span>
	<span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">ek</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">type</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">qword_add</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="n">blen</span><span class="p">,</span> <span class="n">ek</span><span class="o">-&gt;</span><span class="n">ek_client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">ek</span><span class="o">-&gt;</span><span class="n">ek_fsidtype</span><span class="p">);</span>
	<span class="n">qword_add</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="n">blen</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">qword_addhex</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="n">blen</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">ek</span><span class="o">-&gt;</span><span class="n">ek_fsid</span><span class="p">,</span> <span class="n">key_len</span><span class="p">(</span><span class="n">ek</span><span class="o">-&gt;</span><span class="n">ek_fsidtype</span><span class="p">));</span>
	<span class="p">(</span><span class="o">*</span><span class="n">bpp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">expkey_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sunrpc_cache_pipe_upcall</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">expkey_request</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">svc_expkey_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">old</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">svc_expkey_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">expkey_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mesg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* client fsidtype fsid [path] */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auth_domain</span> <span class="o">*</span><span class="n">dom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fsidtype</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_expkey</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">ek</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mesg</span><span class="p">[</span><span class="n">mlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mesg</span><span class="p">[</span><span class="n">mlen</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">len</span><span class="o">=</span><span class="n">qword_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">dom</span> <span class="o">=</span> <span class="n">auth_domain_find</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dom</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found domain %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">len</span><span class="o">=</span><span class="n">qword_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">fsidtype</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found fsidtype %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fsidtype</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_len</span><span class="p">(</span><span class="n">fsidtype</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="cm">/* invalid type */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">len</span><span class="o">=</span><span class="n">qword_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found fsid length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">key_len</span><span class="p">(</span><span class="n">fsidtype</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* OK, we seem to have a valid key */</span>
	<span class="n">key</span><span class="p">.</span><span class="n">h</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">h</span><span class="p">.</span><span class="n">expiry_time</span> <span class="o">=</span> <span class="n">get_expiry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">h</span><span class="p">.</span><span class="n">expiry_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">ek_client</span> <span class="o">=</span> <span class="n">dom</span><span class="p">;</span>	
	<span class="n">key</span><span class="p">.</span><span class="n">ek_fsidtype</span> <span class="o">=</span> <span class="n">fsidtype</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">ek_fsid</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">ek</span> <span class="o">=</span> <span class="n">svc_expkey_lookup</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ek</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* now we want a pathname, or empty meaning NEGATIVE  */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">qword_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Path seems to be &lt;%s&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CACHE_NEGATIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">h</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ek</span> <span class="o">=</span> <span class="n">svc_expkey_update</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">ek</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ek</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">kern_path</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">ek_path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Found the path %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="n">ek</span> <span class="o">=</span> <span class="n">svc_expkey_update</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">ek</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ek</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">ek_path</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cache_flush</span><span class="p">();</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ek</span><span class="p">)</span>
		<span class="n">cache_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ek</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">,</span> <span class="n">cd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dom</span><span class="p">)</span>
		<span class="n">auth_domain_put</span><span class="p">(</span><span class="n">dom</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">expkey_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">ek</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;#domain fsidtype fsid [path]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ek</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s %d 0x&quot;</span><span class="p">,</span> <span class="n">ek</span><span class="o">-&gt;</span><span class="n">ek_client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		   <span class="n">ek</span><span class="o">-&gt;</span><span class="n">ek_fsidtype</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">key_len</span><span class="p">(</span><span class="n">ek</span><span class="o">-&gt;</span><span class="n">ek_fsidtype</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%08x&quot;</span><span class="p">,</span> <span class="n">ek</span><span class="o">-&gt;</span><span class="n">ek_fsid</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CACHE_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CACHE_NEGATIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="n">seq_path</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ek</span><span class="o">-&gt;</span><span class="n">ek_path</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s"> </span><span class="se">\t\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">expkey_match</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">orig</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">ek_fsidtype</span> <span class="o">!=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">ek_fsidtype</span> <span class="o">||</span>
	    <span class="n">orig</span><span class="o">-&gt;</span><span class="n">ek_client</span> <span class="o">!=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">ek_client</span> <span class="o">||</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">ek_fsid</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">ek_fsid</span><span class="p">,</span> <span class="n">key_len</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">ek_fsidtype</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">expkey_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">cnew</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">citem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cnew</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">citem</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">ek_client</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ek_client</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ek_client</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ek_fsidtype</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ek_fsidtype</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">ek_fsid</span><span class="p">,</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ek_fsid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">ek_fsid</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">expkey_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">cnew</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">citem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cnew</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">citem</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ek_path</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ek_path</span><span class="p">;</span>
	<span class="n">path_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">ek_path</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="nf">expkey_alloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cache_detail</span> <span class="n">svc_expkey_cache_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hash_size</span>	<span class="o">=</span> <span class="n">EXPKEY_HASHMAX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;nfsd.fh&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache_put</span>	<span class="o">=</span> <span class="n">expkey_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache_upcall</span>	<span class="o">=</span> <span class="n">expkey_upcall</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache_parse</span>	<span class="o">=</span> <span class="n">expkey_parse</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache_show</span>	<span class="o">=</span> <span class="n">expkey_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">expkey_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">expkey_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update</span>       	<span class="o">=</span> <span class="n">expkey_update</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc</span>		<span class="o">=</span> <span class="n">expkey_alloc</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">svc_expkey_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ek_fsidtype</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">cp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">ek_fsid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">key_len</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">ek_fsidtype</span><span class="p">);</span>

	<span class="n">hash</span> <span class="o">^=</span> <span class="n">hash_mem</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">EXPKEY_HASHBITS</span><span class="p">);</span>
	<span class="n">hash</span> <span class="o">^=</span> <span class="n">hash_ptr</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">ek_client</span><span class="p">,</span> <span class="n">EXPKEY_HASHBITS</span><span class="p">);</span>
	<span class="n">hash</span> <span class="o">&amp;=</span> <span class="n">EXPKEY_HASHMASK</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hash</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span>
<span class="nf">svc_expkey_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">svc_expkey_hash</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">sunrpc_cache_lookup</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">,</span> <span class="n">hash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span>
<span class="nf">svc_expkey_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">svc_expkey_hash</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">sunrpc_cache_update</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">,</span> <span class="n">hash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_expkey</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define	EXPORT_HASHBITS		8</span>
<span class="cp">#define	EXPORT_HASHMAX		(1&lt;&lt; EXPORT_HASHBITS)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfsd4_fslocs_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_fs_locations</span> <span class="o">*</span><span class="n">fsloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">path</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hosts</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_export_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">ref</span><span class="p">);</span>
	<span class="n">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">);</span>
	<span class="n">auth_domain_put</span><span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_client</span><span class="p">);</span>
	<span class="n">nfsd4_fslocs_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_export_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">**</span><span class="n">bpp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">blen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*  client path */</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pth</span><span class="p">;</span>

	<span class="n">qword_add</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="n">blen</span><span class="p">,</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">pth</span> <span class="o">=</span> <span class="n">d_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">,</span> <span class="o">*</span><span class="n">bpp</span><span class="p">,</span> <span class="o">*</span><span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pth</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* is this correct? */</span>
		<span class="p">(</span><span class="o">*</span><span class="n">bpp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qword_add</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="n">blen</span><span class="p">,</span> <span class="n">pth</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">bpp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_export_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sunrpc_cache_pipe_upcall</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">svc_export_request</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">svc_export_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">old</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">svc_export_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_export</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uuid</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/*</span>
<span class="cm">	 * We currently export only dirs, regular files, and (for v4</span>
<span class="cm">	 * pseudoroot) symlinks.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">S_ISLNK</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTDIR</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mountd should never pass down a writeable V4ROOT export, but,</span>
<span class="cm">	 * just to make sure:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFSEXP_V4ROOT</span><span class="p">)</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFSEXP_READONLY</span><span class="p">;</span>

	<span class="cm">/* There are two requirements on a filesystem to be exportable.</span>
<span class="cm">	 * 1:  We must be able to identify the filesystem from a number.</span>
<span class="cm">	 *       either a device number (so FS_REQUIRES_DEV needed)</span>
<span class="cm">	 *       or an FSID number (so NFSEXP_FSID or -&gt;uuid is needed).</span>
<span class="cm">	 * 2:  We must be able to find an inode from a filehandle.</span>
<span class="cm">	 *       This means that s_export_op must be set.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_type</span><span class="o">-&gt;</span><span class="n">fs_flags</span> <span class="o">&amp;</span> <span class="n">FS_REQUIRES_DEV</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFSEXP_FSID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">uuid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;exp_export: export of non-dev fs without fsid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_export_op</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_export_op</span><span class="o">-&gt;</span><span class="n">fh_to_dentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;exp_export: export of invalid fs type.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NFSD_V4</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fsloc_parse</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">mesg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_fs_locations</span> <span class="o">*</span><span class="n">fsloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">migrated</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* listsize */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">get_int</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations_count</span> <span class="o">&gt;</span> <span class="n">MAX_FS_LOCATIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations_count</span>
			<span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfsd4_fs_location</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* colon separated host list */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">qword_get</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_all</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hosts</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hosts</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_all</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* slash separated path component list */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">qword_get</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_all</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">path</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">path</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_all</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* migrated */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">get_int</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">migrated</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_all</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">migrated</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">migrated</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_all</span><span class="p">;</span>
	<span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">migrated</span> <span class="o">=</span> <span class="n">migrated</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_free_all:</span>
	<span class="n">nfsd4_fslocs_free</span><span class="p">(</span><span class="n">fsloc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">secinfo_parse</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">mesg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">listsize</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exp_flavor_info</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">get_int</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">listsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">listsize</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">listsize</span> <span class="o">&gt;</span> <span class="n">MAX_SECINFO_LIST</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_flavors</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_flavors</span> <span class="o">+</span> <span class="n">listsize</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_int</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">pseudoflavor</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * XXX: It would be nice to also check whether this</span>
<span class="cm">		 * pseudoflavor is supported, so we can discover the</span>
<span class="cm">		 * problem at export time instead of when a client fails</span>
<span class="cm">		 * to authenticate.</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_int</span><span class="p">(</span><span class="n">mesg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="cm">/* Only some flags are allowed to differ between flavors: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">NFSEXP_SECINFO_FLAGS</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">^</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_flags</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_nflavors</span> <span class="o">=</span> <span class="n">listsize</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_NFSD_V4 */</span><span class="cp"></span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="n">fsloc_parse</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">mesg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_fs_locations</span> <span class="o">*</span><span class="n">fsloc</span><span class="p">){</span><span class="k">return</span> <span class="mi">0</span><span class="p">;}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="n">secinfo_parse</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">mesg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">svc_export_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mesg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* client path expiry [flags anonuid anongid fsid] */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auth_domain</span> <span class="o">*</span><span class="n">dom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="n">exp</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">*</span><span class="n">expp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">an_int</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mesg</span><span class="p">[</span><span class="n">mlen</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mesg</span><span class="p">[</span><span class="n">mlen</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* client */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">qword_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">dom</span> <span class="o">=</span> <span class="n">auth_domain_find</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dom</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* path */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">qword_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kern_path</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp</span><span class="p">.</span><span class="n">ex_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

	<span class="n">exp</span><span class="p">.</span><span class="n">ex_client</span> <span class="o">=</span> <span class="n">dom</span><span class="p">;</span>
	<span class="n">exp</span><span class="p">.</span><span class="n">cd</span> <span class="o">=</span> <span class="n">cd</span><span class="p">;</span>

	<span class="cm">/* expiry */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">exp</span><span class="p">.</span><span class="n">h</span><span class="p">.</span><span class="n">expiry_time</span> <span class="o">=</span> <span class="n">get_expiry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="p">.</span><span class="n">h</span><span class="p">.</span><span class="n">expiry_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>

	<span class="cm">/* flags */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">get_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">an_int</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CACHE_NEGATIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp</span><span class="p">.</span><span class="n">h</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="n">an_int</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
		<span class="n">exp</span><span class="p">.</span><span class="n">ex_flags</span><span class="o">=</span> <span class="n">an_int</span><span class="p">;</span>
	
		<span class="cm">/* anon uid */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">an_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
		<span class="n">exp</span><span class="p">.</span><span class="n">ex_anon_uid</span><span class="o">=</span> <span class="n">an_int</span><span class="p">;</span>

		<span class="cm">/* anon gid */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">an_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
		<span class="n">exp</span><span class="p">.</span><span class="n">ex_anon_gid</span><span class="o">=</span> <span class="n">an_int</span><span class="p">;</span>

		<span class="cm">/* fsid */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">an_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
		<span class="n">exp</span><span class="p">.</span><span class="n">ex_fsid</span> <span class="o">=</span> <span class="n">an_int</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">qword_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;fsloc&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">fsloc_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp</span><span class="p">.</span><span class="n">ex_fslocs</span><span class="p">);</span>
			<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;uuid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* expect a 16 byte uuid encoded as \xXXXX... */</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">qword_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
					<span class="n">err</span>  <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">exp</span><span class="p">.</span><span class="n">ex_uuid</span> <span class="o">=</span>
						<span class="n">kmemdup</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="p">.</span><span class="n">ex_uuid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
						<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;secinfo&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">secinfo_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="cm">/* quietly ignore unknown words and anything</span>
<span class="cm">				 * following. Newer user-space can try to set</span>
<span class="cm">				 * new values, then see what the result was.</span>
<span class="cm">				 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out4</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">check_export</span><span class="p">(</span><span class="n">exp</span><span class="p">.</span><span class="n">ex_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp</span><span class="p">.</span><span class="n">ex_flags</span><span class="p">,</span>
				   <span class="n">exp</span><span class="p">.</span><span class="n">ex_uuid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">expp</span> <span class="o">=</span> <span class="n">svc_export_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expp</span><span class="p">)</span>
		<span class="n">expp</span> <span class="o">=</span> <span class="n">svc_export_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="p">,</span> <span class="n">expp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cache_flush</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">exp_put</span><span class="p">(</span><span class="n">expp</span><span class="p">);</span>
<span class="nl">out4:</span>
	<span class="n">nfsd4_fslocs_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="p">.</span><span class="n">ex_fslocs</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">exp</span><span class="p">.</span><span class="n">ex_uuid</span><span class="p">);</span>
<span class="nl">out3:</span>
	<span class="n">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="p">.</span><span class="n">ex_path</span><span class="p">);</span>
<span class="nl">out1:</span>
	<span class="n">auth_domain_put</span><span class="p">(</span><span class="n">dom</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">exp_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fsid</span><span class="p">,</span>
		<span class="n">uid_t</span> <span class="n">anonu</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">anong</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_fs_locations</span> <span class="o">*</span><span class="n">fslocs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">show_secinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_export_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;#path domain(flags)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">exp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="n">seq_path</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">,</span> <span class="s">&quot; </span><span class="se">\t\n\\</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;\t&#39;</span><span class="p">);</span>
	<span class="n">seq_escape</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot; </span><span class="se">\t\n\\</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;(&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CACHE_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CACHE_NEGATIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">exp_flags</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_flags</span><span class="p">,</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_fsid</span><span class="p">,</span>
			  <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_anon_uid</span><span class="p">,</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_anon_gid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_uuid</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,uuid=&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="p">)</span>
					<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_uuid</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">show_secinfo</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">exp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_export_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">orig</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">orig</span><span class="o">-&gt;</span><span class="n">ex_client</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_client</span> <span class="o">&amp;&amp;</span>
		<span class="n">orig</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">.</span><span class="n">dentry</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">.</span><span class="n">dentry</span> <span class="o">&amp;&amp;</span>
		<span class="n">orig</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">.</span><span class="n">mnt</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">.</span><span class="n">mnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_export_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">cnew</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">citem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cnew</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">citem</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_client</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_client</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_client</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">.</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">.</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">.</span><span class="n">mnt</span> <span class="o">=</span> <span class="n">mntget</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">.</span><span class="n">mnt</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">locations</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">locations_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">migrated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">cd</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">cd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">export_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">cnew</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">citem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cnew</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">citem</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_flags</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_flags</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_anon_uid</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_anon_uid</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_anon_gid</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_anon_gid</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_fsid</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_fsid</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_uuid</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_uuid</span><span class="p">;</span>
	<span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_uuid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">locations</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">locations</span><span class="p">;</span>
	<span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">locations</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">locations_count</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">locations_count</span><span class="p">;</span>
	<span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">locations_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">migrated</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">migrated</span><span class="p">;</span>
	<span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_fslocs</span><span class="p">.</span><span class="n">migrated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_nflavors</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_nflavors</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SECINFO_LIST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">ex_flavors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ex_flavors</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="nf">svc_export_alloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cache_detail</span> <span class="n">svc_export_cache_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hash_size</span>	<span class="o">=</span> <span class="n">EXPORT_HASHMAX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;nfsd.export&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache_put</span>	<span class="o">=</span> <span class="n">svc_export_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache_upcall</span>	<span class="o">=</span> <span class="n">svc_export_upcall</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache_parse</span>	<span class="o">=</span> <span class="n">svc_export_parse</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache_show</span>	<span class="o">=</span> <span class="n">svc_export_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">svc_export_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">svc_export_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update</span>		<span class="o">=</span> <span class="n">export_update</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc</span>		<span class="o">=</span> <span class="n">svc_export_alloc</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">svc_export_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hash</span><span class="p">;</span>

	<span class="n">hash</span> <span class="o">=</span> <span class="n">hash_ptr</span><span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_client</span><span class="p">,</span> <span class="n">EXPORT_HASHBITS</span><span class="p">);</span>
	<span class="n">hash</span> <span class="o">^=</span> <span class="n">hash_ptr</span><span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">.</span><span class="n">dentry</span><span class="p">,</span> <span class="n">EXPORT_HASHBITS</span><span class="p">);</span>
	<span class="n">hash</span> <span class="o">^=</span> <span class="n">hash_ptr</span><span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">.</span><span class="n">mnt</span><span class="p">,</span> <span class="n">EXPORT_HASHBITS</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hash</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span>
<span class="nf">svc_export_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">svc_export_hash</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">sunrpc_cache_lookup</span><span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">cd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">,</span> <span class="n">hash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span>
<span class="nf">svc_export_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">svc_export_hash</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">sunrpc_cache_update</span><span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">cd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">,</span> <span class="n">hash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span>
<span class="nf">exp_find_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span> <span class="n">svc_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fsid_type</span><span class="p">,</span>
	     <span class="n">u32</span> <span class="o">*</span><span class="n">fsidv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cache_req</span> <span class="o">*</span><span class="n">reqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_expkey</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">ek</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>

	<span class="n">key</span><span class="p">.</span><span class="n">ek_client</span> <span class="o">=</span> <span class="n">clp</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">ek_fsidtype</span> <span class="o">=</span> <span class="n">fsid_type</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">ek_fsid</span><span class="p">,</span> <span class="n">fsidv</span><span class="p">,</span> <span class="n">key_len</span><span class="p">(</span><span class="n">fsid_type</span><span class="p">));</span>

	<span class="n">ek</span> <span class="o">=</span> <span class="n">svc_expkey_lookup</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ek</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cache_check</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ek</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">,</span> <span class="n">reqp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ek</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">svc_export</span> <span class="o">*</span><span class="nf">exp_get_by_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span> <span class="n">svc_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cache_req</span> <span class="o">*</span><span class="n">reqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span><span class="p">,</span> <span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>

	<span class="n">key</span><span class="p">.</span><span class="n">ex_client</span> <span class="o">=</span> <span class="n">clp</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">ex_path</span> <span class="o">=</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">cd</span> <span class="o">=</span> <span class="n">cd</span><span class="p">;</span>

	<span class="n">exp</span> <span class="o">=</span> <span class="n">svc_export_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cache_check</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">,</span> <span class="n">reqp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">exp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find the export entry for a given dentry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="nf">exp_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span> <span class="n">svc_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">saved</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span> <span class="o">=</span> <span class="n">exp_get_by_name</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ROOT</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dget_parent</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
		<span class="n">exp</span> <span class="o">=</span> <span class="n">exp_get_by_name</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">saved</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">exp</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Obtain the root fh on behalf of a client.</span>
<span class="cm"> * This could be done in user space, but I feel that it adds some safety</span>
<span class="cm"> * since its harder to fool a kernel module than a user space program.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">exp_rootfh</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="n">svc_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
	   <span class="k">struct</span> <span class="n">knfsd_fh</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_export</span>	<span class="o">*</span><span class="n">exp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">path</span>		<span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_fh</span>		<span class="n">fh</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd_net</span>		<span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nfsd_net_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cache_detail</span>	<span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_export_cache</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="cm">/* NB: we probably ought to check that it&#39;s NUL-terminated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kern_path</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nfsd: exp_rootfh path not found %s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsd: exp_rootfh(%s [%p] %s:%s/%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		 <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
	<span class="n">exp</span> <span class="o">=</span> <span class="n">exp_parent</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * fh must be initialized before calling fh_compose</span>
<span class="cm">	 */</span>
	<span class="n">fh_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh_compose</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="p">.</span><span class="n">fh_handle</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">knfsd_fh</span><span class="p">));</span>
	<span class="n">fh_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="p">);</span>
	<span class="n">exp_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="nf">exp_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">auth_domain</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fsid_type</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="o">*</span><span class="n">fsidv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cache_req</span> <span class="o">*</span><span class="n">reqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="n">nfsd_net_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">svc_expkey</span> <span class="o">*</span><span class="n">ek</span> <span class="o">=</span> <span class="n">exp_find_key</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_expkey_cache</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="n">fsid_type</span><span class="p">,</span> <span class="n">fsidv</span><span class="p">,</span> <span class="n">reqp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ek</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">ek</span><span class="p">);</span>

	<span class="n">exp</span> <span class="o">=</span> <span class="n">exp_get_by_name</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ek</span><span class="o">-&gt;</span><span class="n">ek_path</span><span class="p">,</span> <span class="n">reqp</span><span class="p">);</span>
	<span class="n">cache_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ek</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">,</span> <span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_expkey_cache</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">exp</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span> <span class="nf">check_nfsd_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exp_flavor_info</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exp_flavor_info</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_flavors</span> <span class="o">+</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_nflavors</span><span class="p">;</span>

	<span class="cm">/* legacy gss-only clients are always OK: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_client</span> <span class="o">==</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_gssclient</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* ip-address based client; check sec= export option: */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_flavors</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">pseudoflavor</span> <span class="o">==</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">.</span><span class="n">cr_flavor</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* defaults in absence of sec= options: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_nflavors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">.</span><span class="n">cr_flavor</span> <span class="o">==</span> <span class="n">RPC_AUTH_NULL</span> <span class="o">||</span>
		    <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">.</span><span class="n">cr_flavor</span> <span class="o">==</span> <span class="n">RPC_AUTH_UNIX</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfserr_wrongsec</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Uses rq_client and rq_gssclient to find an export; uses rq_client (an</span>
<span class="cm"> * auth_unix client) if it&#39;s available and has secinfo information;</span>
<span class="cm"> * otherwise, will try to use rq_gssclient.</span>
<span class="cm"> *</span>
<span class="cm"> * Called from functions that handle requests; functions that do work on</span>
<span class="cm"> * behalf of mountd are passed a single client name to use, and should</span>
<span class="cm"> * use exp_get_by_name() or exp_find().</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span>
<span class="nf">rqst_exp_get_by_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">gssexp</span><span class="p">,</span> <span class="o">*</span><span class="n">exp</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfsd_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="o">-&gt;</span><span class="n">xpt_net</span><span class="p">,</span> <span class="n">nfsd_net_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_export_cache</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_client</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">gss</span><span class="p">;</span>

	<span class="cm">/* First try the auth_unix client: */</span>
	<span class="n">exp</span> <span class="o">=</span> <span class="n">exp_get_by_name</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_client</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_chandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">gss</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">exp</span><span class="p">;</span>
	<span class="cm">/* If it has secinfo, assume there are no gss/... clients */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_nflavors</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">exp</span><span class="p">;</span>
<span class="nl">gss:</span>
	<span class="cm">/* Otherwise, try falling back on gss client */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_gssclient</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">exp</span><span class="p">;</span>
	<span class="n">gssexp</span> <span class="o">=</span> <span class="n">exp_get_by_name</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_gssclient</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_chandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gssexp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">exp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
		<span class="n">exp_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">gssexp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span>
<span class="nf">rqst_exp_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fsid_type</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">fsidv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">gssexp</span><span class="p">,</span> <span class="o">*</span><span class="n">exp</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfsd_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="o">-&gt;</span><span class="n">xpt_net</span><span class="p">,</span> <span class="n">nfsd_net_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_export_cache</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_client</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">gss</span><span class="p">;</span>

	<span class="cm">/* First try the auth_unix client: */</span>
	<span class="n">exp</span> <span class="o">=</span> <span class="n">exp_find</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_client</span><span class="p">,</span> <span class="n">fsid_type</span><span class="p">,</span>
		       <span class="n">fsidv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_chandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">gss</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">exp</span><span class="p">;</span>
	<span class="cm">/* If it has secinfo, assume there are no gss/... clients */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_nflavors</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">exp</span><span class="p">;</span>
<span class="nl">gss:</span>
	<span class="cm">/* Otherwise, try falling back on gss client */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_gssclient</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">exp</span><span class="p">;</span>
	<span class="n">gssexp</span> <span class="o">=</span> <span class="n">exp_find</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_gssclient</span><span class="p">,</span> <span class="n">fsid_type</span><span class="p">,</span> <span class="n">fsidv</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_chandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gssexp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">exp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
		<span class="n">exp_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">gssexp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span>
<span class="nf">rqst_exp_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">saved</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span> <span class="o">=</span> <span class="n">rqst_exp_get_by_name</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ROOT</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dget_parent</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
		<span class="n">exp</span> <span class="o">=</span> <span class="n">rqst_exp_get_by_name</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">saved</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">exp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="nf">rqst_find_fsidzero_export</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fsidv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">mk_fsid</span><span class="p">(</span><span class="n">FSID_NUM</span><span class="p">,</span> <span class="n">fsidv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rqst_exp_find</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">FSID_NUM</span><span class="p">,</span> <span class="n">fsidv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called when we need the filehandle for the root of the pseudofs,</span>
<span class="cm"> * for a given NFSv4 client.   The root is defined to be the</span>
<span class="cm"> * export point with fsid==0</span>
<span class="cm"> */</span>
<span class="n">__be32</span>
<span class="nf">exp_pseudoroot</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_fh</span> <span class="o">*</span><span class="n">fhp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">exp</span> <span class="o">=</span> <span class="n">rqst_find_fsidzero_export</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nfserrno</span><span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">exp</span><span class="p">));</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">fh_compose</span><span class="p">(</span><span class="n">fhp</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_path</span><span class="p">.</span><span class="n">dentry</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">exp_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Iterator */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">e_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(((</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hash_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loff_t</span> <span class="n">n</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">hash</span><span class="p">,</span> <span class="n">export</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cache_head</span> <span class="o">**</span><span class="n">export_table</span> <span class="o">=</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">hash_table</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">hash_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>
	<span class="n">hash</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">export</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1LL</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span><span class="o">=</span><span class="n">export_table</span><span class="p">[</span><span class="n">hash</span><span class="p">];</span> <span class="n">ch</span><span class="p">;</span> <span class="n">ch</span><span class="o">=</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">export</span><span class="o">--</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1LL</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">hash</span><span class="o">++</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">+=</span> <span class="mi">1LL</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">hash</span> <span class="o">&lt;</span> <span class="n">EXPORT_HASHMAX</span> <span class="o">&amp;&amp;</span> <span class="n">export_table</span><span class="p">[</span><span class="n">hash</span><span class="p">]</span><span class="o">==</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hash</span> <span class="o">&gt;=</span> <span class="n">EXPORT_HASHMAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">export_table</span><span class="p">[</span><span class="n">hash</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">e_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cache_head</span> <span class="o">**</span><span class="n">export_table</span> <span class="o">=</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">hash_table</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
		<span class="n">hash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hash</span><span class="o">++</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">+=</span> <span class="mi">1LL</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">pos</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1LL</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hash</span> <span class="o">&lt;</span> <span class="n">EXPORT_HASHMAX</span> <span class="o">&amp;&amp;</span> <span class="n">export_table</span><span class="p">[</span><span class="n">hash</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hash</span><span class="o">++</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">+=</span> <span class="mi">1LL</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hash</span> <span class="o">&gt;=</span> <span class="n">EXPORT_HASHMAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">export_table</span><span class="p">[</span><span class="n">hash</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(((</span><span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hash_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">hash_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">flags</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span> <span class="n">expflags</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">NFSEXP_READONLY</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;ro&quot;</span><span class="p">,</span> <span class="s">&quot;rw&quot;</span><span class="p">}},</span>
	<span class="p">{</span> <span class="n">NFSEXP_INSECURE_PORT</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;insecure&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">}},</span>
	<span class="p">{</span> <span class="n">NFSEXP_ROOTSQUASH</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;root_squash&quot;</span><span class="p">,</span> <span class="s">&quot;no_root_squash&quot;</span><span class="p">}},</span>
	<span class="p">{</span> <span class="n">NFSEXP_ALLSQUASH</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;all_squash&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">}},</span>
	<span class="p">{</span> <span class="n">NFSEXP_ASYNC</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;async&quot;</span><span class="p">,</span> <span class="s">&quot;sync&quot;</span><span class="p">}},</span>
	<span class="p">{</span> <span class="n">NFSEXP_GATHERED_WRITES</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;wdelay&quot;</span><span class="p">,</span> <span class="s">&quot;no_wdelay&quot;</span><span class="p">}},</span>
	<span class="p">{</span> <span class="n">NFSEXP_NOHIDE</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;nohide&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">}},</span>
	<span class="p">{</span> <span class="n">NFSEXP_CROSSMOUNT</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;crossmnt&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">}},</span>
	<span class="p">{</span> <span class="n">NFSEXP_NOSUBTREECHECK</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;no_subtree_check&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">}},</span>
	<span class="p">{</span> <span class="n">NFSEXP_NOAUTHNLM</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;insecure_locks&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">}},</span>
	<span class="p">{</span> <span class="n">NFSEXP_V4ROOT</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;v4root&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">}},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">}}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_expflags</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">flags</span> <span class="o">*</span><span class="n">flg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">flg</span> <span class="o">=</span> <span class="n">expflags</span><span class="p">;</span> <span class="n">flg</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">;</span> <span class="n">flg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flg</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">flg</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flg</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">state</span><span class="p">])</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">first</span><span class="o">++?</span><span class="s">&quot;,&quot;</span><span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">flg</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_secinfo_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
	<span class="n">show_expflags</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">NFSEXP_SECINFO_FLAGS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">secinfo_flags_equal</span><span class="p">(</span><span class="kt">int</span> <span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">g</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">f</span> <span class="o">&amp;=</span> <span class="n">NFSEXP_SECINFO_FLAGS</span><span class="p">;</span>
	<span class="n">g</span> <span class="o">&amp;=</span> <span class="n">NFSEXP_SECINFO_FLAGS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">f</span> <span class="o">==</span> <span class="n">g</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_secinfo_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">exp_flavor_info</span> <span class="o">**</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">exp_flavor_info</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,sec=%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pseudoflavor</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">fp</span> <span class="o">!=</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">secinfo_flags_equal</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;:%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pseudoflavor</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_secinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exp_flavor_info</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exp_flavor_info</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_flavors</span> <span class="o">+</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_nflavors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_nflavors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_flavors</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">show_secinfo_run</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">secinfo_flags_equal</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">ex_flags</span><span class="p">))</span>
		<span class="n">show_secinfo_flags</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">show_secinfo_run</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
		<span class="n">show_secinfo_flags</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">exp_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fsid</span><span class="p">,</span>
		<span class="n">uid_t</span> <span class="n">anonu</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">anong</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfsd4_fs_locations</span> <span class="o">*</span><span class="n">fsloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_expflags</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">NFSEXP_ALLFLAGS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">NFSEXP_FSID</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,fsid=%d&quot;</span><span class="p">,</span> <span class="n">fsid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">anonu</span> <span class="o">!=</span> <span class="p">(</span><span class="n">uid_t</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">anonu</span> <span class="o">!=</span> <span class="p">(</span><span class="mh">0x10000</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,anonuid=%u&quot;</span><span class="p">,</span> <span class="n">anonu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">anong</span> <span class="o">!=</span> <span class="p">(</span><span class="n">gid_t</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">anong</span> <span class="o">!=</span> <span class="p">(</span><span class="mh">0x10000</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,anongid=%u&quot;</span><span class="p">,</span> <span class="n">anong</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsloc</span> <span class="o">&amp;&amp;</span> <span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">loctype</span> <span class="o">=</span> <span class="p">(</span><span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">migrated</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;refer&quot;</span> <span class="o">:</span> <span class="s">&quot;replicas&quot;</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,%s=&quot;</span><span class="p">,</span> <span class="n">loctype</span><span class="p">);</span>
		<span class="n">seq_escape</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;,;@ </span><span class="se">\t\n\\</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;@&#39;</span><span class="p">);</span>
		<span class="n">seq_escape</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hosts</span><span class="p">,</span> <span class="s">&quot;,;@ </span><span class="se">\t\n\\</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;;&#39;</span><span class="p">);</span>
			<span class="n">seq_escape</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;,;@ </span><span class="se">\t\n\\</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;@&#39;</span><span class="p">);</span>
			<span class="n">seq_escape</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">fsloc</span><span class="o">-&gt;</span><span class="n">locations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hosts</span><span class="p">,</span> <span class="s">&quot;,;@ </span><span class="se">\t\n\\</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cache_head</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_export</span> <span class="o">*</span><span class="n">exp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_export</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cache_detail</span> <span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;# Version 1.1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;# Path Client(Flags) # IPs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cache_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cache_check</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">exp_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">svc_export_show</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">nfs_exports_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">e_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">e_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">e_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">e_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the exports module.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">nfsd_export_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfsd_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nfsd_net_id</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsd: initializing export module (net: %p).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>

	<span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_export_cache</span> <span class="o">=</span> <span class="n">cache_create_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svc_export_cache_template</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_export_cache</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_export_cache</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">cache_register_net</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_export_cache</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">destroy_export_cache</span><span class="p">;</span>

	<span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_expkey_cache</span> <span class="o">=</span> <span class="n">cache_create_net</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svc_expkey_cache_template</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_expkey_cache</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_expkey_cache</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unregister_export_cache</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">cache_register_net</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_expkey_cache</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">destroy_expkey_cache</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">destroy_expkey_cache:</span>
	<span class="n">cache_destroy_net</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_expkey_cache</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
<span class="nl">unregister_export_cache:</span>
	<span class="n">cache_unregister_net</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_export_cache</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
<span class="nl">destroy_export_cache:</span>
	<span class="n">cache_destroy_net</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_export_cache</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Flush exports table - called when last nfsd thread is killed</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">nfsd_export_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nfsd_net_id</span><span class="p">);</span>

	<span class="n">cache_purge</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_expkey_cache</span><span class="p">);</span>
	<span class="n">cache_purge</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_export_cache</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Shutdown the exports module.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">nfsd_export_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfsd_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nfsd_net_id</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsd: shutting down export module (net: %p).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>

	<span class="n">cache_unregister_net</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_expkey_cache</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="n">cache_unregister_net</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_export_cache</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="n">cache_destroy_net</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_expkey_cache</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="n">cache_destroy_net</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">svc_export_cache</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="n">svcauth_unix_purge</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfsd: export shutdown complete (net: %p).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
