<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › ecryptfs › inode.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>inode.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * eCryptfs: Linux filesystem encryption layer</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1997-2004 Erez Zadok</span>
<span class="cm"> * Copyright (C) 2001-2004 Stony Brook University</span>
<span class="cm"> * Copyright (C) 2004-2007 International Business Machines Corp.</span>
<span class="cm"> *   Author(s): Michael A. Halcrow &lt;mahalcro@us.ibm.com&gt;</span>
<span class="cm"> *              Michael C. Thompsion &lt;mcthomps@us.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of the</span>
<span class="cm"> * License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA</span>
<span class="cm"> * 02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/dcache.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/crypto.h&gt;</span>
<span class="cp">#include &lt;linux/fs_stack.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/xattr.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &quot;ecryptfs_kernel.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">lock_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>

	<span class="n">dir</span> <span class="o">=</span> <span class="n">dget_parent</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">),</span> <span class="n">I_MUTEX_PARENT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dir</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unlock_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_inode_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">lower_inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecryptfs_inode_to_lower</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">)</span><span class="n">lower_inode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_inode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">lower_inode</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>

	<span class="n">ecryptfs_set_inode_lower</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">lower_inode</span><span class="p">);</span>
	<span class="n">fsstack_copy_attr_all</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">lower_inode</span><span class="p">);</span>
	<span class="cm">/* i_size will be overwritten for encrypted regular files */</span>
	<span class="n">fsstack_copy_inode_size</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">lower_inode</span><span class="p">);</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">=</span> <span class="n">lower_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_version</span><span class="o">++</span><span class="p">;</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecryptfs_aops</span><span class="p">;</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_bdi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISLNK</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecryptfs_symlink_iops</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecryptfs_dir_iops</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecryptfs_main_iops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_fop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecryptfs_dir_fops</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">special_file</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="n">init_special_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rdev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_fop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecryptfs_main_fops</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">__ecryptfs_get_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">lower_inode</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lower_inode</span><span class="o">-&gt;</span><span class="n">i_sb</span> <span class="o">!=</span> <span class="n">ecryptfs_superblock_to_lower</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EXDEV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">igrab</span><span class="p">(</span><span class="n">lower_inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">);</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">iget5_locked</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">lower_inode</span><span class="p">,</span>
			     <span class="n">ecryptfs_inode_test</span><span class="p">,</span> <span class="n">ecryptfs_inode_set</span><span class="p">,</span>
			     <span class="n">lower_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">lower_inode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_state</span> <span class="o">&amp;</span> <span class="n">I_NEW</span><span class="p">))</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">lower_inode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">ecryptfs_get_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">lower_inode</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">__ecryptfs_get_inode</span><span class="p">(</span><span class="n">lower_inode</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_state</span> <span class="o">&amp;</span> <span class="n">I_NEW</span><span class="p">))</span>
		<span class="n">unlock_new_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_interpose</span>
<span class="cm"> * @lower_dentry: Existing dentry in the lower filesystem</span>
<span class="cm"> * @dentry: ecryptfs&#39; dentry</span>
<span class="cm"> * @sb: ecryptfs&#39;s super_block</span>
<span class="cm"> *</span>
<span class="cm"> * Interposes upper and lower dentries.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero otherwise</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_interpose</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">ecryptfs_get_inode</span><span class="p">(</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">d_instantiate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_do_create</span>
<span class="cm"> * @directory_inode: inode of the new file&#39;s dentry&#39;s parent in ecryptfs</span>
<span class="cm"> * @ecryptfs_dentry: New file&#39;s dentry in ecryptfs</span>
<span class="cm"> * @mode: The mode of the new file</span>
<span class="cm"> * @nd: nameidata of ecryptfs&#39; parent&#39;s dentry &amp; vfsmount</span>
<span class="cm"> *</span>
<span class="cm"> * Creates the underlying file and the eCryptfs inode which will link to</span>
<span class="cm"> * it. It will also update the eCryptfs directory inode to mimic the</span>
<span class="cm"> * stat of the lower directory inode.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the new eCryptfs inode on success; an ERR_PTR on error condition</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span>
<span class="nf">ecryptfs_do_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">directory_inode</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ecryptfs_dentry</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dir_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>

	<span class="n">lower_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">ecryptfs_dentry</span><span class="p">);</span>
	<span class="n">lower_dir_dentry</span> <span class="o">=</span> <span class="n">lock_parent</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">lower_dir_dentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error locking directory of &quot;</span>
				<span class="s">&quot;dentry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">inode</span> <span class="o">=</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">lower_dir_dentry</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">vfs_create</span><span class="p">(</span><span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">lower_dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failure to create dentry in lower fs; &quot;</span>
		       <span class="s">&quot;rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">inode</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_lock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">__ecryptfs_get_inode</span><span class="p">(</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span>
				     <span class="n">directory_inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_lock</span><span class="p">;</span>
	<span class="n">fsstack_copy_attr_times</span><span class="p">(</span><span class="n">directory_inode</span><span class="p">,</span> <span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">fsstack_copy_inode_size</span><span class="p">(</span><span class="n">directory_inode</span><span class="p">,</span> <span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
<span class="nl">out_lock:</span>
	<span class="n">unlock_dir</span><span class="p">(</span><span class="n">lower_dir_dentry</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_initialize_file</span>
<span class="cm"> *</span>
<span class="cm"> * Cause the file to be changed from a basic empty file to an ecryptfs</span>
<span class="cm"> * file with a header and first data page.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_initialize_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ecryptfs_dentry</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ecryptfs_inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">ecryptfs_inode_to_private</span><span class="p">(</span><span class="n">ecryptfs_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">crypt_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">ecryptfs_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;This is a directory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECRYPTFS_ENCRYPTED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;Initializing crypto context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_new_file_context</span><span class="p">(</span><span class="n">ecryptfs_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error creating new file &quot;</span>
				<span class="s">&quot;context; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_get_lower_file</span><span class="p">(</span><span class="n">ecryptfs_dentry</span><span class="p">,</span> <span class="n">ecryptfs_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error attempting to initialize &quot;</span>
			<span class="s">&quot;the lower file for the dentry with name &quot;</span>
			<span class="s">&quot;[%s]; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">ecryptfs_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_write_metadata</span><span class="p">(</span><span class="n">ecryptfs_dentry</span><span class="p">,</span> <span class="n">ecryptfs_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error writing headers; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="n">ecryptfs_put_lower_file</span><span class="p">(</span><span class="n">ecryptfs_inode</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_create</span>
<span class="cm"> * @dir: The inode of the directory in which to create the file.</span>
<span class="cm"> * @dentry: The eCryptfs dentry</span>
<span class="cm"> * @mode: The mode of the new file.</span>
<span class="cm"> * @nd: nameidata</span>
<span class="cm"> *</span>
<span class="cm"> * Creates a new file.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero on error condition</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ecryptfs_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">directory_inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ecryptfs_dentry</span><span class="p">,</span>
		<span class="n">umode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nameidata</span> <span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ecryptfs_inode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ecryptfs_inode</span> <span class="o">=</span> <span class="n">ecryptfs_do_create</span><span class="p">(</span><span class="n">directory_inode</span><span class="p">,</span> <span class="n">ecryptfs_dentry</span><span class="p">,</span>
					    <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ecryptfs_inode</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Failed to create file in&quot;</span>
				<span class="s">&quot;lower filesystem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ecryptfs_inode</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* At this point, a file exists on &quot;disk&quot;; we need to make sure</span>
<span class="cm">	 * that this on disk file is prepared to be an ecryptfs file */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_initialize_file</span><span class="p">(</span><span class="n">ecryptfs_dentry</span><span class="p">,</span> <span class="n">ecryptfs_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drop_nlink</span><span class="p">(</span><span class="n">ecryptfs_inode</span><span class="p">);</span>
		<span class="n">unlock_new_inode</span><span class="p">(</span><span class="n">ecryptfs_inode</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">ecryptfs_inode</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">d_instantiate</span><span class="p">(</span><span class="n">ecryptfs_dentry</span><span class="p">,</span> <span class="n">ecryptfs_inode</span><span class="p">);</span>
	<span class="n">unlock_new_inode</span><span class="p">(</span><span class="n">ecryptfs_inode</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_i_size_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_get_lower_file</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error attempting to initialize &quot;</span>
			<span class="s">&quot;the lower file for the dentry with name &quot;</span>
			<span class="s">&quot;[%s]; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crypt_stat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecryptfs_inode_to_private</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">crypt_stat</span><span class="p">;</span>
	<span class="cm">/* TODO: lock for crypt_stat comparison */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ECRYPTFS_POLICY_APPLIED</span><span class="p">))</span>
		<span class="n">ecryptfs_set_default_sizes</span><span class="p">(</span><span class="n">crypt_stat</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_read_and_validate_header_region</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">ecryptfs_put_lower_file</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_read_and_validate_xattr_region</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ECRYPTFS_METADATA_IN_XATTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Must return 0 to allow non-eCryptfs files to be looked up, too */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_lookup_interpose - Dentry interposition for a lookup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_lookup_interpose</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir_inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="o">*</span><span class="n">lower_inode</span> <span class="o">=</span> <span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_dentry_info</span> <span class="o">*</span><span class="n">dentry_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vfsmount</span> <span class="o">*</span><span class="n">lower_mnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lower_mnt</span> <span class="o">=</span> <span class="n">mntget</span><span class="p">(</span><span class="n">ecryptfs_dentry_to_lower_mnt</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="p">));</span>
	<span class="n">fsstack_copy_attr_atime</span><span class="p">(</span><span class="n">dir_inode</span><span class="p">,</span> <span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_count</span><span class="p">);</span>

	<span class="n">dentry_info</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">ecryptfs_dentry_info_cache</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ecryptfs_set_dentry_private</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">dentry_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dentry_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Out of memory whilst attempting &quot;</span>
		       <span class="s">&quot;to allocate ecryptfs_dentry_info struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
		<span class="n">mntput</span><span class="p">(</span><span class="n">lower_mnt</span><span class="p">);</span>
		<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ecryptfs_set_dentry_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">lower_dentry</span><span class="p">);</span>
	<span class="n">ecryptfs_set_dentry_lower_mnt</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">lower_mnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We want to add because we couldn&#39;t find in lower */</span>
		<span class="n">d_add</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">__ecryptfs_get_inode</span><span class="p">(</span><span class="n">lower_inode</span><span class="p">,</span> <span class="n">dir_inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error interposing; rc = [%ld]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_i_size_read</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">make_bad_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_state</span> <span class="o">&amp;</span> <span class="n">I_NEW</span><span class="p">)</span>
		<span class="n">unlock_new_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">d_add</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_lookup</span>
<span class="cm"> * @ecryptfs_dir_inode: The eCryptfs directory inode</span>
<span class="cm"> * @ecryptfs_dentry: The eCryptfs dentry that we are looking up</span>
<span class="cm"> * @ecryptfs_nd: nameidata; may be NULL</span>
<span class="cm"> *</span>
<span class="cm"> * Find a file on disk. If the file does not exist, then we&#39;ll add it to the</span>
<span class="cm"> * dentry cache and continue on to read it from the disk.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">ecryptfs_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ecryptfs_dir_inode</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ecryptfs_dentry</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">nameidata</span> <span class="o">*</span><span class="n">ecryptfs_nd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">encrypted_and_encoded_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">encrypted_and_encoded_name_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_mount_crypt_stat</span> <span class="o">*</span><span class="n">mount_crypt_stat</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dir_dentry</span><span class="p">,</span> <span class="o">*</span><span class="n">lower_dentry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ecryptfs_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="mi">1</span>
	     <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ecryptfs_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">))</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">ecryptfs_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="mi">2</span>
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ecryptfs_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;..&quot;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out_d_drop</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lower_dir_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">ecryptfs_dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="n">lower_dentry</span> <span class="o">=</span> <span class="n">lookup_one_len</span><span class="p">(</span><span class="n">ecryptfs_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				      <span class="n">lower_dir_dentry</span><span class="p">,</span>
				      <span class="n">ecryptfs_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;%s: lookup_one_len() returned &quot;</span>
				<span class="s">&quot;[%d] on lower_dentry = [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span>
				<span class="n">encrypted_and_encoded_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_d_drop</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">interpose</span><span class="p">;</span>
	<span class="n">mount_crypt_stat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecryptfs_superblock_to_private</span><span class="p">(</span>
				<span class="n">ecryptfs_dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mount_crypt_stat</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mount_crypt_stat</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ECRYPTFS_GLOBAL_ENCRYPT_FILENAMES</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">interpose</span><span class="p">;</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_encrypt_and_encode_filename</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">encrypted_and_encoded_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encrypted_and_encoded_name_size</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="n">mount_crypt_stat</span><span class="p">,</span> <span class="n">ecryptfs_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		<span class="n">ecryptfs_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error attempting to encrypt and encode &quot;</span>
		       <span class="s">&quot;filename; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_d_drop</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="n">lower_dentry</span> <span class="o">=</span> <span class="n">lookup_one_len</span><span class="p">(</span><span class="n">encrypted_and_encoded_name</span><span class="p">,</span>
				      <span class="n">lower_dir_dentry</span><span class="p">,</span>
				      <span class="n">encrypted_and_encoded_name_size</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;%s: lookup_one_len() returned &quot;</span>
				<span class="s">&quot;[%d] on lower_dentry = [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span>
				<span class="n">encrypted_and_encoded_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_d_drop</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">interpose:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_lookup_interpose</span><span class="p">(</span><span class="n">ecryptfs_dentry</span><span class="p">,</span> <span class="n">lower_dentry</span><span class="p">,</span>
				       <span class="n">ecryptfs_dir_inode</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">out_d_drop:</span>
	<span class="n">d_drop</span><span class="p">(</span><span class="n">ecryptfs_dentry</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">encrypted_and_encoded_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">old_dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">new_dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_old_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_new_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dir_dentry</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">file_size_save</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">file_size_save</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">old_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">lower_old_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">old_dentry</span><span class="p">);</span>
	<span class="n">lower_new_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">new_dentry</span><span class="p">);</span>
	<span class="n">dget</span><span class="p">(</span><span class="n">lower_old_dentry</span><span class="p">);</span>
	<span class="n">dget</span><span class="p">(</span><span class="n">lower_new_dentry</span><span class="p">);</span>
	<span class="n">lower_dir_dentry</span> <span class="o">=</span> <span class="n">lock_parent</span><span class="p">(</span><span class="n">lower_new_dentry</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">vfs_link</span><span class="p">(</span><span class="n">lower_old_dentry</span><span class="p">,</span> <span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span>
		      <span class="n">lower_new_dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="o">!</span><span class="n">lower_new_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_lock</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_interpose</span><span class="p">(</span><span class="n">lower_new_dentry</span><span class="p">,</span> <span class="n">new_dentry</span><span class="p">,</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_lock</span><span class="p">;</span>
	<span class="n">fsstack_copy_attr_times</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">fsstack_copy_inode_size</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">set_nlink</span><span class="p">(</span><span class="n">old_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span>
		  <span class="n">ecryptfs_inode_to_lower</span><span class="p">(</span><span class="n">old_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">);</span>
	<span class="n">i_size_write</span><span class="p">(</span><span class="n">new_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">file_size_save</span><span class="p">);</span>
<span class="nl">out_lock:</span>
	<span class="n">unlock_dir</span><span class="p">(</span><span class="n">lower_dir_dentry</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">lower_new_dentry</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">lower_old_dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_unlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">lower_dir_inode</span> <span class="o">=</span> <span class="n">ecryptfs_inode_to_lower</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dir_dentry</span><span class="p">;</span>

	<span class="n">dget</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
	<span class="n">lower_dir_dentry</span> <span class="o">=</span> <span class="n">lock_parent</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">vfs_unlink</span><span class="p">(</span><span class="n">lower_dir_inode</span><span class="p">,</span> <span class="n">lower_dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error in vfs_unlink; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fsstack_copy_attr_times</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">lower_dir_inode</span><span class="p">);</span>
	<span class="n">set_nlink</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span>
		  <span class="n">ecryptfs_inode_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">);</span>
	<span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_ctime</span><span class="p">;</span>
	<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">unlock_dir</span><span class="p">(</span><span class="n">lower_dir_dentry</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_symlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dir_dentry</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">encoded_symname</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">encoded_symlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_mount_crypt_stat</span> <span class="o">*</span><span class="n">mount_crypt_stat</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">lower_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">dget</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
	<span class="n">lower_dir_dentry</span> <span class="o">=</span> <span class="n">lock_parent</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
	<span class="n">mount_crypt_stat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecryptfs_superblock_to_private</span><span class="p">(</span>
		<span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mount_crypt_stat</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_encrypt_and_encode_filename</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoded_symname</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">encoded_symlen</span><span class="p">,</span>
						  <span class="nb">NULL</span><span class="p">,</span>
						  <span class="n">mount_crypt_stat</span><span class="p">,</span> <span class="n">symname</span><span class="p">,</span>
						  <span class="n">strlen</span><span class="p">(</span><span class="n">symname</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_lock</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">vfs_symlink</span><span class="p">(</span><span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">lower_dentry</span><span class="p">,</span>
			 <span class="n">encoded_symname</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">encoded_symname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="o">!</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_lock</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_interpose</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_lock</span><span class="p">;</span>
	<span class="n">fsstack_copy_attr_times</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">fsstack_copy_inode_size</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
<span class="nl">out_lock:</span>
	<span class="n">unlock_dir</span><span class="p">(</span><span class="n">lower_dir_dentry</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span>
		<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_mkdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dir_dentry</span><span class="p">;</span>

	<span class="n">lower_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">lower_dir_dentry</span> <span class="o">=</span> <span class="n">lock_parent</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">vfs_mkdir</span><span class="p">(</span><span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">lower_dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="o">!</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_interpose</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">fsstack_copy_attr_times</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">fsstack_copy_inode_size</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">set_nlink</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">unlock_dir</span><span class="p">(</span><span class="n">lower_dir_dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span>
		<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_rmdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dir_dentry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">lower_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">dget</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">lower_dir_dentry</span> <span class="o">=</span> <span class="n">lock_parent</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
	<span class="n">dget</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">vfs_rmdir</span><span class="p">(</span><span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">lower_dentry</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span>
		<span class="n">clear_nlink</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">fsstack_copy_attr_times</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">set_nlink</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">);</span>
	<span class="n">unlock_dir</span><span class="p">(</span><span class="n">lower_dir_dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ecryptfs_mknod</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dir_dentry</span><span class="p">;</span>

	<span class="n">lower_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">lower_dir_dentry</span> <span class="o">=</span> <span class="n">lock_parent</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">vfs_mknod</span><span class="p">(</span><span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">lower_dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="o">!</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_interpose</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">fsstack_copy_attr_times</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">fsstack_copy_inode_size</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">lower_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">unlock_dir</span><span class="p">(</span><span class="n">lower_dir_dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span>
		<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ecryptfs_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">old_dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">old_dentry</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">new_dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">new_dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_old_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_new_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_old_dir_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_new_dir_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">trap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">lower_old_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">old_dentry</span><span class="p">);</span>
	<span class="n">lower_new_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">new_dentry</span><span class="p">);</span>
	<span class="n">dget</span><span class="p">(</span><span class="n">lower_old_dentry</span><span class="p">);</span>
	<span class="n">dget</span><span class="p">(</span><span class="n">lower_new_dentry</span><span class="p">);</span>
	<span class="n">lower_old_dir_dentry</span> <span class="o">=</span> <span class="n">dget_parent</span><span class="p">(</span><span class="n">lower_old_dentry</span><span class="p">);</span>
	<span class="n">lower_new_dir_dentry</span> <span class="o">=</span> <span class="n">dget_parent</span><span class="p">(</span><span class="n">lower_new_dentry</span><span class="p">);</span>
	<span class="n">trap</span> <span class="o">=</span> <span class="n">lock_rename</span><span class="p">(</span><span class="n">lower_old_dir_dentry</span><span class="p">,</span> <span class="n">lower_new_dir_dentry</span><span class="p">);</span>
	<span class="cm">/* source should not be ancestor of target */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trap</span> <span class="o">==</span> <span class="n">lower_old_dentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_lock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* target should not be ancestor of source */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trap</span> <span class="o">==</span> <span class="n">lower_new_dentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTEMPTY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_lock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">vfs_rename</span><span class="p">(</span><span class="n">lower_old_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">lower_old_dentry</span><span class="p">,</span>
			<span class="n">lower_new_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">lower_new_dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_lock</span><span class="p">;</span>
	<span class="n">fsstack_copy_attr_all</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="n">lower_new_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_dir</span> <span class="o">!=</span> <span class="n">old_dir</span><span class="p">)</span>
		<span class="n">fsstack_copy_attr_all</span><span class="p">(</span><span class="n">old_dir</span><span class="p">,</span> <span class="n">lower_old_dir_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
<span class="nl">out_lock:</span>
	<span class="n">unlock_rename</span><span class="p">(</span><span class="n">lower_old_dir_dentry</span><span class="p">,</span> <span class="n">lower_new_dir_dentry</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">lower_new_dir_dentry</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">lower_old_dir_dentry</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">lower_new_dentry</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">lower_old_dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_readlink_lower</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="o">*</span><span class="n">bufsiz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">lower_buf</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">lower_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lower_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="o">-&gt;</span><span class="n">readlink</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">,</span>
						   <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">lower_buf</span><span class="p">,</span>
						   <span class="n">PATH_MAX</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_decode_and_decrypt_filename</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufsiz</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span>
						  <span class="n">lower_buf</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lower_buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ecryptfs_follow_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nameidata</span> <span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">PATH_MAX</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_readlink_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">fsstack_copy_attr_atime</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span>
				<span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">nd_set_link</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ecryptfs_put_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nameidata</span> <span class="o">*</span><span class="n">nd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">nd_get_link</span><span class="p">(</span><span class="n">nd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Free the char* */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * upper_size_to_lower_size</span>
<span class="cm"> * @crypt_stat: Crypt_stat associated with file</span>
<span class="cm"> * @upper_size: Size of the upper file</span>
<span class="cm"> *</span>
<span class="cm"> * Calculate the required size of the lower file based on the</span>
<span class="cm"> * specified size of the upper file. This calculation is based on the</span>
<span class="cm"> * number of headers in the underlying file and the extent size.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns Calculated size of the lower file.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">loff_t</span>
<span class="nf">upper_size_to_lower_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">,</span>
			 <span class="n">loff_t</span> <span class="n">upper_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loff_t</span> <span class="n">lower_size</span><span class="p">;</span>

	<span class="n">lower_size</span> <span class="o">=</span> <span class="n">ecryptfs_lower_header_size</span><span class="p">(</span><span class="n">crypt_stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">upper_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">loff_t</span> <span class="n">num_extents</span><span class="p">;</span>

		<span class="n">num_extents</span> <span class="o">=</span> <span class="n">upper_size</span> <span class="o">&gt;&gt;</span> <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">extent_shift</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">upper_size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">extent_mask</span><span class="p">)</span>
			<span class="n">num_extents</span><span class="o">++</span><span class="p">;</span>
		<span class="n">lower_size</span> <span class="o">+=</span> <span class="p">(</span><span class="n">num_extents</span> <span class="o">*</span> <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">extent_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">lower_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * truncate_upper</span>
<span class="cm"> * @dentry: The ecryptfs layer dentry</span>
<span class="cm"> * @ia: Address of the ecryptfs inode&#39;s attributes</span>
<span class="cm"> * @lower_ia: Address of the lower inode&#39;s attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Function to handle truncations modifying the size of the file. Note</span>
<span class="cm"> * that the file sizes are interpolated. When expanding, we are simply</span>
<span class="cm"> * writing strings of 0&#39;s out. When truncating, we truncate the upper</span>
<span class="cm"> * inode and update the lower_ia according to the page index</span>
<span class="cm"> * interpolations. If ATTR_SIZE is set in lower_ia-&gt;ia_valid upon return,</span>
<span class="cm"> * the caller must use lower_ia in a call to notify_change() to perform</span>
<span class="cm"> * the truncation of the lower inode.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero otherwise</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">truncate_upper</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">lower_ia</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">i_size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">loff_t</span> <span class="n">lower_size_before_truncate</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">lower_size_after_truncate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ia_size</span> <span class="o">==</span> <span class="n">i_size</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">lower_ia</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATTR_SIZE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_get_lower_file</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">crypt_stat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecryptfs_inode_to_private</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">crypt_stat</span><span class="p">;</span>
	<span class="cm">/* Switch on growing or shrinking file */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ia_size</span> <span class="o">&gt;</span> <span class="n">i_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">zero</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span> <span class="p">};</span>

		<span class="n">lower_ia</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATTR_SIZE</span><span class="p">;</span>
		<span class="cm">/* Write a single 0 at the last position of the file;</span>
<span class="cm">		 * this triggers code that will fill in 0&#39;s throughout</span>
<span class="cm">		 * the intermediate portion of the previous end of the</span>
<span class="cm">		 * file and the new and of the file */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_write</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ia_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* ia-&gt;ia_size &lt; i_size_read(inode) */</span>
		<span class="cm">/* We&#39;re chopping off all the pages down to the page</span>
<span class="cm">		 * in which ia-&gt;ia_size is located. Fill in the end of</span>
<span class="cm">		 * that page from (ia-&gt;ia_size &amp; ~PAGE_CACHE_MASK) to</span>
<span class="cm">		 * PAGE_CACHE_SIZE with zeros. */</span>
		<span class="kt">size_t</span> <span class="n">num_zeros</span> <span class="o">=</span> <span class="p">(</span><span class="n">PAGE_CACHE_SIZE</span>
				    <span class="o">-</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ia_size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_CACHE_MASK</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ECRYPTFS_ENCRYPTED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">truncate_setsize</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ia_size</span><span class="p">);</span>
			<span class="n">lower_ia</span><span class="o">-&gt;</span><span class="n">ia_size</span> <span class="o">=</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ia_size</span><span class="p">;</span>
			<span class="n">lower_ia</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">|=</span> <span class="n">ATTR_SIZE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_zeros</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">zeros_virt</span><span class="p">;</span>

			<span class="n">zeros_virt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">num_zeros</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zeros_virt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_write</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">zeros_virt</span><span class="p">,</span>
					    <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ia_size</span><span class="p">,</span> <span class="n">num_zeros</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">zeros_virt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error attempting to zero out &quot;</span>
				       <span class="s">&quot;the remainder of the end page on &quot;</span>
				       <span class="s">&quot;reducing truncate; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">truncate_setsize</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ia_size</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_write_inode_size_to_metadata</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>	<span class="s">&quot;Problem with &quot;</span>
			       <span class="s">&quot;ecryptfs_write_inode_size_to_metadata; &quot;</span>
			       <span class="s">&quot;rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* We are reducing the size of the ecryptfs file, and need to</span>
<span class="cm">		 * know if we need to reduce the size of the lower file. */</span>
		<span class="n">lower_size_before_truncate</span> <span class="o">=</span>
		    <span class="n">upper_size_to_lower_size</span><span class="p">(</span><span class="n">crypt_stat</span><span class="p">,</span> <span class="n">i_size</span><span class="p">);</span>
		<span class="n">lower_size_after_truncate</span> <span class="o">=</span>
		    <span class="n">upper_size_to_lower_size</span><span class="p">(</span><span class="n">crypt_stat</span><span class="p">,</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ia_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lower_size_after_truncate</span> <span class="o">&lt;</span> <span class="n">lower_size_before_truncate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lower_ia</span><span class="o">-&gt;</span><span class="n">ia_size</span> <span class="o">=</span> <span class="n">lower_size_after_truncate</span><span class="p">;</span>
			<span class="n">lower_ia</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">|=</span> <span class="n">ATTR_SIZE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">lower_ia</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATTR_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">ecryptfs_put_lower_file</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_inode_newsize_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">lower_oldsize</span><span class="p">,</span> <span class="n">lower_newsize</span><span class="p">;</span>

	<span class="n">crypt_stat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecryptfs_inode_to_private</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">crypt_stat</span><span class="p">;</span>
	<span class="n">lower_oldsize</span> <span class="o">=</span> <span class="n">upper_size_to_lower_size</span><span class="p">(</span><span class="n">crypt_stat</span><span class="p">,</span>
						 <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
	<span class="n">lower_newsize</span> <span class="o">=</span> <span class="n">upper_size_to_lower_size</span><span class="p">(</span><span class="n">crypt_stat</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lower_newsize</span> <span class="o">&gt;</span> <span class="n">lower_oldsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The eCryptfs inode and the new *lower* size are mixed here</span>
<span class="cm">		 * because we may not have the lower i_mutex held and/or it may</span>
<span class="cm">		 * not be appropriate to call inode_newsize_ok() with inodes</span>
<span class="cm">		 * from other filesystems.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">inode_newsize_ok</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">lower_newsize</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_truncate</span>
<span class="cm"> * @dentry: The ecryptfs layer dentry</span>
<span class="cm"> * @new_length: The length to expand the file to</span>
<span class="cm"> *</span>
<span class="cm"> * Simple function that handles the truncation of an eCryptfs inode and</span>
<span class="cm"> * its corresponding lower inode.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ecryptfs_truncate</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">new_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iattr</span> <span class="n">ia</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">ia_valid</span> <span class="o">=</span> <span class="n">ATTR_SIZE</span><span class="p">,</span> <span class="p">.</span><span class="n">ia_size</span> <span class="o">=</span> <span class="n">new_length</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">iattr</span> <span class="n">lower_ia</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">ia_valid</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_inode_newsize_ok</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">new_length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">truncate_upper</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ia</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lower_ia</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">lower_ia</span><span class="p">.</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">notify_change</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lower_ia</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ecryptfs_permission</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inode_permission</span><span class="p">(</span><span class="n">ecryptfs_inode_to_lower</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_setattr</span>
<span class="cm"> * @dentry: dentry handle to the inode to modify</span>
<span class="cm"> * @ia: Structure with flags of what to change and values</span>
<span class="cm"> *</span>
<span class="cm"> * Updates the metadata of an inode. If the update is to the size</span>
<span class="cm"> * i.e. truncation, then ecryptfs_truncate will handle the size modification</span>
<span class="cm"> * of both the ecryptfs inode and the lower inode.</span>
<span class="cm"> *</span>
<span class="cm"> * All other metadata changes will be passed right to the lower filesystem,</span>
<span class="cm"> * and we will just update our inode to look like the lower.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">ia</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iattr</span> <span class="n">lower_ia</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">lower_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">;</span>

	<span class="n">crypt_stat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecryptfs_inode_to_private</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">crypt_stat</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ECRYPTFS_STRUCT_INITIALIZED</span><span class="p">))</span>
		<span class="n">ecryptfs_init_crypt_stat</span><span class="p">(</span><span class="n">crypt_stat</span><span class="p">);</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="n">lower_inode</span> <span class="o">=</span> <span class="n">ecryptfs_inode_to_lower</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">lower_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cs_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECRYPTFS_ENCRYPTED</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ECRYPTFS_POLICY_APPLIED</span><span class="p">)</span>
		     <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ECRYPTFS_KEY_VALID</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ecryptfs_mount_crypt_stat</span> <span class="o">*</span><span class="n">mount_crypt_stat</span><span class="p">;</span>

		<span class="n">mount_crypt_stat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecryptfs_superblock_to_private</span><span class="p">(</span>
			<span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mount_crypt_stat</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_get_lower_file</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cs_mutex</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_read_metadata</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
		<span class="n">ecryptfs_put_lower_file</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span>
			      <span class="o">&amp;</span> <span class="n">ECRYPTFS_PLAINTEXT_PASSTHROUGH_ENABLED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Either the lower file &quot;</span>
				       <span class="s">&quot;is not in a valid eCryptfs format, &quot;</span>
				       <span class="s">&quot;or the key could not be retrieved. &quot;</span>
				       <span class="s">&quot;Plaintext passthrough mode is not &quot;</span>
				       <span class="s">&quot;enabled; returning -EIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cs_mutex</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECRYPTFS_I_SIZE_INITIALIZED</span>
					       <span class="o">|</span> <span class="n">ECRYPTFS_ENCRYPTED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cs_mutex</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">inode_change_ok</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">ia</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_inode_newsize_ok</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ia_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">filemap_write_and_wait</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">fsstack_copy_attr_all</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">lower_inode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_ia</span><span class="p">,</span> <span class="n">ia</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lower_ia</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_FILE</span><span class="p">)</span>
		<span class="n">lower_ia</span><span class="p">.</span><span class="n">ia_file</span> <span class="o">=</span> <span class="n">ecryptfs_file_to_lower</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ia_file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">truncate_upper</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">ia</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lower_ia</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * mode change is for clearing setuid/setgid bits. Allow lower fs</span>
<span class="cm">	 * to interpret this in its own way.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lower_ia</span><span class="p">.</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATTR_KILL_SUID</span> <span class="o">|</span> <span class="n">ATTR_KILL_SGID</span><span class="p">))</span>
		<span class="n">lower_ia</span><span class="p">.</span><span class="n">ia_valid</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATTR_MODE</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">notify_change</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lower_ia</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">fsstack_copy_attr_all</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">lower_inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ecryptfs_getattr_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">vfsmount</span> <span class="o">*</span><span class="n">mnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">kstat</span> <span class="o">*</span><span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ecryptfs_mount_crypt_stat</span> <span class="o">*</span><span class="n">mount_crypt_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mount_crypt_stat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecryptfs_superblock_to_private</span><span class="p">(</span>
						<span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mount_crypt_stat</span><span class="p">;</span>
	<span class="n">generic_fillattr</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ECRYPTFS_GLOBAL_ENCRYPT_FILENAMES</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">targetsiz</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_readlink_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">targetsiz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
			<span class="n">stat</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">targetsiz</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ecryptfs_getattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vfsmount</span> <span class="o">*</span><span class="n">mnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">kstat</span> <span class="o">*</span><span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kstat</span> <span class="n">lower_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">vfs_getattr</span><span class="p">(</span><span class="n">ecryptfs_dentry_to_lower_mnt</span><span class="p">(</span><span class="n">dentry</span><span class="p">),</span>
			 <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">lower_stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fsstack_copy_attr_all</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span>
				      <span class="n">ecryptfs_inode_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">));</span>
		<span class="n">generic_fillattr</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="n">stat</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">lower_stat</span><span class="p">.</span><span class="n">blocks</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">ecryptfs_setxattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
		  <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span><span class="p">;</span>

	<span class="n">lower_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="o">-&gt;</span><span class="n">setxattr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">vfs_setxattr</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">fsstack_copy_attr_all</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">ssize_t</span>
<span class="nf">ecryptfs_getxattr_lower</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="o">-&gt;</span><span class="n">getxattr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="o">-&gt;</span><span class="n">getxattr</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
						   <span class="n">size</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ecryptfs_getxattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
		  <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ecryptfs_getxattr_lower</span><span class="p">(</span><span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span>
				       <span class="n">value</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ecryptfs_listxattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span><span class="p">;</span>

	<span class="n">lower_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="o">-&gt;</span><span class="n">listxattr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="o">-&gt;</span><span class="n">listxattr</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_removexattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lower_dentry</span><span class="p">;</span>

	<span class="n">lower_dentry</span> <span class="o">=</span> <span class="n">ecryptfs_dentry_to_lower</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="o">-&gt;</span><span class="n">removexattr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="o">-&gt;</span><span class="n">removexattr</span><span class="p">(</span><span class="n">lower_dentry</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lower_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">inode_operations</span> <span class="n">ecryptfs_symlink_iops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">readlink</span> <span class="o">=</span> <span class="n">generic_readlink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">follow_link</span> <span class="o">=</span> <span class="n">ecryptfs_follow_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_link</span> <span class="o">=</span> <span class="n">ecryptfs_put_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">permission</span> <span class="o">=</span> <span class="n">ecryptfs_permission</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setattr</span> <span class="o">=</span> <span class="n">ecryptfs_setattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getattr</span> <span class="o">=</span> <span class="n">ecryptfs_getattr_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setxattr</span> <span class="o">=</span> <span class="n">ecryptfs_setxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getxattr</span> <span class="o">=</span> <span class="n">ecryptfs_getxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">listxattr</span> <span class="o">=</span> <span class="n">ecryptfs_listxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">removexattr</span> <span class="o">=</span> <span class="n">ecryptfs_removexattr</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">inode_operations</span> <span class="n">ecryptfs_dir_iops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">ecryptfs_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">ecryptfs_lookup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">ecryptfs_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlink</span> <span class="o">=</span> <span class="n">ecryptfs_unlink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">symlink</span> <span class="o">=</span> <span class="n">ecryptfs_symlink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mkdir</span> <span class="o">=</span> <span class="n">ecryptfs_mkdir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rmdir</span> <span class="o">=</span> <span class="n">ecryptfs_rmdir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mknod</span> <span class="o">=</span> <span class="n">ecryptfs_mknod</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rename</span> <span class="o">=</span> <span class="n">ecryptfs_rename</span><span class="p">,</span>
	<span class="p">.</span><span class="n">permission</span> <span class="o">=</span> <span class="n">ecryptfs_permission</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setattr</span> <span class="o">=</span> <span class="n">ecryptfs_setattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setxattr</span> <span class="o">=</span> <span class="n">ecryptfs_setxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getxattr</span> <span class="o">=</span> <span class="n">ecryptfs_getxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">listxattr</span> <span class="o">=</span> <span class="n">ecryptfs_listxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">removexattr</span> <span class="o">=</span> <span class="n">ecryptfs_removexattr</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">inode_operations</span> <span class="n">ecryptfs_main_iops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">permission</span> <span class="o">=</span> <span class="n">ecryptfs_permission</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setattr</span> <span class="o">=</span> <span class="n">ecryptfs_setattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getattr</span> <span class="o">=</span> <span class="n">ecryptfs_getattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setxattr</span> <span class="o">=</span> <span class="n">ecryptfs_setxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getxattr</span> <span class="o">=</span> <span class="n">ecryptfs_getxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">listxattr</span> <span class="o">=</span> <span class="n">ecryptfs_listxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">removexattr</span> <span class="o">=</span> <span class="n">ecryptfs_removexattr</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
