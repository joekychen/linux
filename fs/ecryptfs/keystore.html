<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › ecryptfs › keystore.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>keystore.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * eCryptfs: Linux filesystem encryption layer</span>
<span class="cm"> * In-kernel key management code.  Includes functions to parse and</span>
<span class="cm"> * write authentication token-related packets with the underlying</span>
<span class="cm"> * file.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004-2006 International Business Machines Corp.</span>
<span class="cm"> *   Author(s): Michael A. Halcrow &lt;mhalcrow@us.ibm.com&gt;</span>
<span class="cm"> *              Michael C. Thompson &lt;mcthomps@us.ibm.com&gt;</span>
<span class="cm"> *              Trevor S. Highland &lt;trevor.highland@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of the</span>
<span class="cm"> * License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA</span>
<span class="cm"> * 02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/key.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/crypto.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;ecryptfs_kernel.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * request_key returned an error instead of a valid key address;</span>
<span class="cm"> * determine the type of error, make appropriate log entries, and</span>
<span class="cm"> * return an error code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_request_key_err</span><span class="p">(</span><span class="kt">long</span> <span class="n">err_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">err_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOKEY</span>:
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;No key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EKEYEXPIRED</span>:
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Key expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EKEYREVOKED</span>:
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Key revoked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Unknown error code: &quot;</span>
				<span class="s">&quot;[0x%.16lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_find_global_auth_tok_for_sig_err</span><span class="p">(</span><span class="kt">int</span> <span class="n">err_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">err_code</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">err_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Missing auth tok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EINVAL</span>:
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Invalid auth tok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">process_request_key_err</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_parse_packet_length</span>
<span class="cm"> * @data: Pointer to memory containing length at offset</span>
<span class="cm"> * @size: This function writes the decoded size to this memory</span>
<span class="cm"> *        address; zero on error</span>
<span class="cm"> * @length_size: The number of bytes occupied by the encoded length</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero on error</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ecryptfs_parse_packet_length</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="o">*</span><span class="n">length_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">length_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">192</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* One-byte length */</span>
		<span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">(</span><span class="o">*</span><span class="n">length_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">224</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Two-byte length */</span>
		<span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">)</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">192</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">)</span> <span class="o">+=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">192</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">length_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If support is added, adjust ECRYPTFS_MAX_PKT_LEN_SIZE */</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Five-byte packet length not &quot;</span>
				<span class="s">&quot;supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error parsing packet length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_write_packet_length</span>
<span class="cm"> * @dest: The byte array target into which to write the length. Must</span>
<span class="cm"> *        have at least ECRYPTFS_MAX_PKT_LEN_SIZE bytes allocated.</span>
<span class="cm"> * @size: The length to write.</span>
<span class="cm"> * @packet_size_length: The number of bytes used to encode the packet</span>
<span class="cm"> *                      length is written to this address.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero on error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ecryptfs_write_packet_length</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="o">*</span><span class="n">packet_size_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">192</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">packet_size_length</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">65536</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">size</span> <span class="o">-</span> <span class="mi">192</span><span class="p">)</span> <span class="o">/</span> <span class="mi">256</span><span class="p">)</span> <span class="o">+</span> <span class="mi">192</span><span class="p">);</span>
		<span class="n">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">size</span> <span class="o">-</span> <span class="mi">192</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">packet_size_length</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If support is added, adjust ECRYPTFS_MAX_PKT_LEN_SIZE */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span>
				<span class="s">&quot;Unsupported packet size: [%zd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">write_tag_64_packet</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">signature</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ecryptfs_session_key</span> <span class="o">*</span><span class="n">session_key</span><span class="p">,</span>
		    <span class="kt">char</span> <span class="o">**</span><span class="n">packet</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">packet_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">packet_size_len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *              ***** TAG 64 Packet Format *****</span>
<span class="cm">	 *    | Content Type                       | 1 byte       |</span>
<span class="cm">	 *    | Key Identifier Size                | 1 or 2 bytes |</span>
<span class="cm">	 *    | Key Identifier                     | arbitrary    |</span>
<span class="cm">	 *    | Encrypted File Encryption Key Size | 1 or 2 bytes |</span>
<span class="cm">	 *    | Encrypted File Encryption Key      | arbitrary    |</span>
<span class="cm">	 */</span>
	<span class="n">data_len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="n">ECRYPTFS_SIG_SIZE_HEX</span>
		    <span class="o">+</span> <span class="n">session_key</span><span class="o">-&gt;</span><span class="n">encrypted_key_size</span><span class="p">);</span>
	<span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">data_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">message</span> <span class="o">=</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ECRYPTFS_TAG_64_PACKET_TYPE</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_write_packet_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ECRYPTFS_SIG_SIZE_HEX</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">packet_size_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error generating tag 64 packet &quot;</span>
				<span class="s">&quot;header; cannot generate packet length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">packet_size_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">signature</span><span class="p">,</span> <span class="n">ECRYPTFS_SIG_SIZE_HEX</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">ECRYPTFS_SIG_SIZE_HEX</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_write_packet_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					  <span class="n">session_key</span><span class="o">-&gt;</span><span class="n">encrypted_key_size</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">packet_size_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error generating tag 64 packet &quot;</span>
				<span class="s">&quot;header; cannot generate packet length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">packet_size_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">session_key</span><span class="o">-&gt;</span><span class="n">encrypted_key</span><span class="p">,</span>
	       <span class="n">session_key</span><span class="o">-&gt;</span><span class="n">encrypted_key_size</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">session_key</span><span class="o">-&gt;</span><span class="n">encrypted_key_size</span><span class="p">;</span>
	<span class="o">*</span><span class="n">packet_len</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">parse_tag_65_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecryptfs_session_key</span> <span class="o">*</span><span class="n">session_key</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cipher_code</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ecryptfs_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">m_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">message_len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">expected_checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *              ***** TAG 65 Packet Format *****</span>
<span class="cm">	 *         | Content Type             | 1 byte       |</span>
<span class="cm">	 *         | Status Indicator         | 1 byte       |</span>
<span class="cm">	 *         | File Encryption Key Size | 1 or 2 bytes |</span>
<span class="cm">	 *         | File Encryption Key      | arbitrary    |</span>
<span class="cm">	 */</span>
	<span class="n">message_len</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">message_len</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ECRYPTFS_TAG_65_PACKET_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Type should be ECRYPTFS_TAG_65</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Status indicator has non-zero value &quot;</span>
				<span class="s">&quot;[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_parse_packet_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">m_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Error parsing packet length; &quot;</span>
				<span class="s">&quot;rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">message_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">m_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;The message received from ecryptfsd &quot;</span>
				<span class="s">&quot;is shorter than expected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m_size</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;The decrypted key is not long enough to &quot;</span>
				<span class="s">&quot;include a cipher code and checksum</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">cipher_code</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
	<span class="cm">/* The decrypted key includes 1 byte cipher code and 2 byte checksum */</span>
	<span class="n">session_key</span><span class="o">-&gt;</span><span class="n">decrypted_key_size</span> <span class="o">=</span> <span class="n">m_size</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session_key</span><span class="o">-&gt;</span><span class="n">decrypted_key_size</span> <span class="o">&gt;</span> <span class="n">ECRYPTFS_MAX_KEY_BYTES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;key_size [%d] larger than &quot;</span>
				<span class="s">&quot;the maximum key size [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">session_key</span><span class="o">-&gt;</span><span class="n">decrypted_key_size</span><span class="p">,</span>
				<span class="n">ECRYPTFS_MAX_ENCRYPTED_KEY_BYTES</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">session_key</span><span class="o">-&gt;</span><span class="n">decrypted_key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
	       <span class="n">session_key</span><span class="o">-&gt;</span><span class="n">decrypted_key_size</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">session_key</span><span class="o">-&gt;</span><span class="n">decrypted_key_size</span><span class="p">;</span>
	<span class="n">expected_checksum</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">expected_checksum</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">session_key</span><span class="o">-&gt;</span><span class="n">decrypted_key_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">checksum</span> <span class="o">+=</span> <span class="n">session_key</span><span class="o">-&gt;</span><span class="n">decrypted_key</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expected_checksum</span> <span class="o">!=</span> <span class="n">checksum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Invalid checksum for file &quot;</span>
				<span class="s">&quot;encryption  key; expected [%x]; calculated &quot;</span>
				<span class="s">&quot;[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">expected_checksum</span><span class="p">,</span> <span class="n">checksum</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">write_tag_66_packet</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">signature</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cipher_code</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">packet</span><span class="p">,</span>
		    <span class="kt">size_t</span> <span class="o">*</span><span class="n">packet_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">packet_size_len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *              ***** TAG 66 Packet Format *****</span>
<span class="cm">	 *         | Content Type             | 1 byte       |</span>
<span class="cm">	 *         | Key Identifier Size      | 1 or 2 bytes |</span>
<span class="cm">	 *         | Key Identifier           | arbitrary    |</span>
<span class="cm">	 *         | File Encryption Key Size | 1 or 2 bytes |</span>
<span class="cm">	 *         | File Encryption Key      | arbitrary    |</span>
<span class="cm">	 */</span>
	<span class="n">data_len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="n">ECRYPTFS_SIG_SIZE_HEX</span> <span class="o">+</span> <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">);</span>
	<span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">data_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">message</span> <span class="o">=</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ECRYPTFS_TAG_66_PACKET_TYPE</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_write_packet_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ECRYPTFS_SIG_SIZE_HEX</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">packet_size_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error generating tag 66 packet &quot;</span>
				<span class="s">&quot;header; cannot generate packet length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">packet_size_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">signature</span><span class="p">,</span> <span class="n">ECRYPTFS_SIG_SIZE_HEX</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">ECRYPTFS_SIG_SIZE_HEX</span><span class="p">;</span>
	<span class="cm">/* The encrypted key includes 1 byte cipher code and 2 byte checksum */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_write_packet_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">packet_size_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error generating tag 66 packet &quot;</span>
				<span class="s">&quot;header; cannot generate packet length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">packet_size_len</span><span class="p">;</span>
	<span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cipher_code</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">checksum</span> <span class="o">+=</span> <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">/</span> <span class="mi">256</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">%</span> <span class="mi">256</span><span class="p">);</span>
	<span class="o">*</span><span class="n">packet_len</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">parse_tag_67_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecryptfs_key_record</span> <span class="o">*</span><span class="n">key_rec</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ecryptfs_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">message_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *              ***** TAG 65 Packet Format *****</span>
<span class="cm">	 *    | Content Type                       | 1 byte       |</span>
<span class="cm">	 *    | Status Indicator                   | 1 byte       |</span>
<span class="cm">	 *    | Encrypted File Encryption Key Size | 1 or 2 bytes |</span>
<span class="cm">	 *    | Encrypted File Encryption Key      | arbitrary    |</span>
<span class="cm">	 */</span>
	<span class="n">message_len</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="cm">/* verify that everything through the encrypted FEK size is present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">message_len</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: message_len is [%zd]; minimum acceptable &quot;</span>
		       <span class="s">&quot;message length is [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">message_len</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ECRYPTFS_TAG_67_PACKET_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Type should be ECRYPTFS_TAG_67</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Status indicator has non zero &quot;</span>
		       <span class="s">&quot;value [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_parse_packet_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">data_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Error parsing packet length; &quot;</span>
				<span class="s">&quot;rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">message_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: message_len [%zd]; max len is [%zd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">message_len</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span> <span class="o">&gt;</span> <span class="n">ECRYPTFS_MAX_ENCRYPTED_KEY_BYTES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Encrypted key_size [%zd] larger than &quot;</span>
		       <span class="s">&quot;the maximum key size [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">,</span>
		       <span class="n">ECRYPTFS_MAX_ENCRYPTED_KEY_BYTES</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_verify_version</span>
<span class="cm"> * @version: The version number to confirm</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on good version; non-zero otherwise</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecryptfs_verify_version</span><span class="p">(</span><span class="n">u16</span> <span class="n">version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">major</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">minor</span><span class="p">;</span>

	<span class="n">major</span> <span class="o">=</span> <span class="p">((</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">minor</span> <span class="o">=</span> <span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">major</span> <span class="o">!=</span> <span class="n">ECRYPTFS_VERSION_MAJOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Major version number mismatch. &quot;</span>
				<span class="s">&quot;Expected [%d]; got [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ECRYPTFS_VERSION_MAJOR</span><span class="p">,</span> <span class="n">major</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">!=</span> <span class="n">ECRYPTFS_VERSION_MINOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Minor version number mismatch. &quot;</span>
				<span class="s">&quot;Expected [%d]; got [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ECRYPTFS_VERSION_MINOR</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_verify_auth_tok_from_key</span>
<span class="cm"> * @auth_tok_key: key containing the authentication token</span>
<span class="cm"> * @auth_tok: authentication token</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on valid auth tok; -EINVAL otherwise</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ecryptfs_verify_auth_tok_from_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">auth_tok_key</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">**</span><span class="n">auth_tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">auth_tok</span><span class="p">)</span> <span class="o">=</span> <span class="n">ecryptfs_get_key_payload_data</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecryptfs_verify_version</span><span class="p">((</span><span class="o">*</span><span class="n">auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Data structure version mismatch. Userspace &quot;</span>
		       <span class="s">&quot;tools must match eCryptfs kernel module with major &quot;</span>
		       <span class="s">&quot;version [%d] and minor version [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ECRYPTFS_VERSION_MAJOR</span><span class="p">,</span> <span class="n">ECRYPTFS_VERSION_MINOR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">token_type</span> <span class="o">!=</span> <span class="n">ECRYPTFS_PASSWORD</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">token_type</span> <span class="o">!=</span> <span class="n">ECRYPTFS_PRIVATE_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid auth_tok structure &quot;</span>
		       <span class="s">&quot;returned from key query</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ecryptfs_find_global_auth_tok_for_sig</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">key</span> <span class="o">**</span><span class="n">auth_tok_key</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">**</span><span class="n">auth_tok</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ecryptfs_mount_crypt_stat</span> <span class="o">*</span><span class="n">mount_crypt_stat</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ecryptfs_global_auth_tok</span> <span class="o">*</span><span class="n">walker</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">auth_tok</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_auth_tok_list_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">walker</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_auth_tok_list</span><span class="p">,</span>
			    <span class="n">mount_crypt_stat_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">ECRYPTFS_SIG_SIZE_HEX</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ECRYPTFS_AUTH_TOK_INVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">key_validate</span><span class="p">(</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">global_auth_tok_key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EKEYEXPIRED</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_invalid_auth_tok</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">global_auth_tok_key</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_verify_auth_tok_from_key</span><span class="p">(</span>
				<span class="n">walker</span><span class="o">-&gt;</span><span class="n">global_auth_tok_key</span><span class="p">,</span> <span class="n">auth_tok</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_invalid_auth_tok_unlock</span><span class="p">;</span>

		<span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">)</span> <span class="o">=</span> <span class="n">walker</span><span class="o">-&gt;</span><span class="n">global_auth_tok_key</span><span class="p">;</span>
		<span class="n">key_get</span><span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">out_invalid_auth_tok_unlock:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">global_auth_tok_key</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">));</span>
<span class="nl">out_invalid_auth_tok:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Invalidating auth tok with sig = [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sig</span><span class="p">);</span>
	<span class="n">walker</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ECRYPTFS_AUTH_TOK_INVALID</span><span class="p">;</span>
	<span class="n">key_put</span><span class="p">(</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">global_auth_tok_key</span><span class="p">);</span>
	<span class="n">walker</span><span class="o">-&gt;</span><span class="n">global_auth_tok_key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_auth_tok_list_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_find_auth_tok_for_sig</span>
<span class="cm"> * @auth_tok: Set to the matching auth_tok; NULL if not found</span>
<span class="cm"> * @crypt_stat: inode crypt_stat crypto context</span>
<span class="cm"> * @sig: Sig of auth_tok to find</span>
<span class="cm"> *</span>
<span class="cm"> * For now, this function simply looks at the registered auth_tok&#39;s</span>
<span class="cm"> * linked off the mount_crypt_stat, so all the auth_toks that can be</span>
<span class="cm"> * used must be registered at mount time. This function could</span>
<span class="cm"> * potentially try a lot harder to find auth_tok&#39;s (e.g., by calling</span>
<span class="cm"> * out to ecryptfsd to dynamically retrieve an auth_tok object) so</span>
<span class="cm"> * that static registration of auth_tok&#39;s will no longer be necessary.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on no error; non-zero on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ecryptfs_find_auth_tok_for_sig</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">key</span> <span class="o">**</span><span class="n">auth_tok_key</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">**</span><span class="n">auth_tok</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ecryptfs_mount_crypt_stat</span> <span class="o">*</span><span class="n">mount_crypt_stat</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_find_global_auth_tok_for_sig</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="p">,</span> <span class="n">auth_tok</span><span class="p">,</span>
						   <span class="n">mount_crypt_stat</span><span class="p">,</span> <span class="n">sig</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if the flag ECRYPTFS_GLOBAL_MOUNT_AUTH_TOK_ONLY is set in the</span>
<span class="cm">		 * mount_crypt_stat structure, we prevent to use auth toks that</span>
<span class="cm">		 * are not inserted through the ecryptfs_add_global_auth_tok</span>
<span class="cm">		 * function.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span>
				<span class="o">&amp;</span> <span class="n">ECRYPTFS_GLOBAL_MOUNT_AUTH_TOK_ONLY</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_keyring_auth_tok_for_sig</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="p">,</span> <span class="n">auth_tok</span><span class="p">,</span>
						       <span class="n">sig</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * write_tag_70_packet can gobble a lot of stack space. We stuff most</span>
<span class="cm"> * of the function&#39;s parameters in a kmalloc&#39;d struct to help reduce</span>
<span class="cm"> * eCryptfs&#39; overall stack usage.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ecryptfs_write_tag_70_packet_silly_stack</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">cipher_code</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">max_packet_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">packet_size_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">block_aligned_filename_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">block_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">num_rand_bytes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="o">*</span><span class="n">tfm_mutex</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">block_aligned_filename</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">*</span><span class="n">auth_tok</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">src_sg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">dst_sg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">blkcipher_desc</span> <span class="n">desc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">iv</span><span class="p">[</span><span class="n">ECRYPTFS_MAX_IV_BYTES</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">hash</span><span class="p">[</span><span class="n">ECRYPTFS_TAG_70_DIGEST_SIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">tmp_hash</span><span class="p">[</span><span class="n">ECRYPTFS_TAG_70_DIGEST_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hash_desc</span> <span class="n">hash_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">hash_sg</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * write_tag_70_packet - Write encrypted filename (EFN) packet against FNEK</span>
<span class="cm"> * @filename: NULL-terminated filename string</span>
<span class="cm"> *</span>
<span class="cm"> * This is the simplest mechanism for achieving filename encryption in</span>
<span class="cm"> * eCryptfs. It encrypts the given filename with the mount-wide</span>
<span class="cm"> * filename encryption key (FNEK) and stores it in a packet to @dest,</span>
<span class="cm"> * which the callee will encode and write directly into the dentry</span>
<span class="cm"> * name.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ecryptfs_write_tag_70_packet</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">remaining_bytes</span><span class="p">,</span>
			     <span class="kt">size_t</span> <span class="o">*</span><span class="n">packet_size</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ecryptfs_mount_crypt_stat</span> <span class="o">*</span><span class="n">mount_crypt_stat</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">filename_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ecryptfs_write_tag_70_packet_silly_stack</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">auth_tok_key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Out of memory whilst trying to kmalloc &quot;</span>
		       <span class="s">&quot;[%zd] bytes of kernel memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CRYPTO_TFM_REQ_MAY_SLEEP</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_find_auth_tok_for_sig</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">auth_tok_key</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="p">,</span> <span class="n">mount_crypt_stat</span><span class="p">,</span>
		<span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_fnek_sig</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error attempting to find auth tok for &quot;</span>
		       <span class="s">&quot;fnek sig [%s]; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_fnek_sig</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_get_tfm_and_mutex_for_cipher_name</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">tfm</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tfm_mutex</span><span class="p">,</span> <span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_fn_cipher_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Internal error whilst attempting to get &quot;</span>
		       <span class="s">&quot;tfm and mutex for cipher name [%s]; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_fn_cipher_name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tfm_mutex</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">crypto_blkcipher_blocksize</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">tfm</span><span class="p">);</span>
	<span class="cm">/* Plus one for the \0 separator between the random prefix</span>
<span class="cm">	 * and the plaintext filename */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">num_rand_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ECRYPTFS_FILENAME_MIN_RANDOM_PREPEND_BYTES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">num_rand_bytes</span> <span class="o">+</span> <span class="n">filename_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span> <span class="o">%</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">num_rand_bytes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">block_size</span>
				      <span class="o">-</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span>
					 <span class="o">%</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">));</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">num_rand_bytes</span>
						  <span class="o">+</span> <span class="n">filename_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Octet 0: Tag 70 identifier</span>
<span class="cm">	 * Octets 1-N1: Tag 70 packet size (includes cipher identifier</span>
<span class="cm">	 *              and block-aligned encrypted filename size)</span>
<span class="cm">	 * Octets N1-N2: FNEK sig (ECRYPTFS_SIG_SIZE)</span>
<span class="cm">	 * Octet N2-N3: Cipher identifier (1 octet)</span>
<span class="cm">	 * Octets N3-N4: Block-aligned encrypted filename</span>
<span class="cm">	 *  - Consists of a minimum number of random characters, a \0</span>
<span class="cm">	 *    separator, and then the filename */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">max_packet_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ECRYPTFS_TAG_70_MAX_METADATA_SIZE</span>
			      <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">max_packet_size</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">max_packet_size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">*</span><span class="n">remaining_bytes</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Require [%zd] bytes to write; only &quot;</span>
		       <span class="s">&quot;[%zd] available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">max_packet_size</span><span class="p">,</span>
		       <span class="p">(</span><span class="o">*</span><span class="n">remaining_bytes</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">,</span>
					    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Out of kernel memory whilst attempting to &quot;</span>
		       <span class="s">&quot;kzalloc [%zd] bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dest</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ECRYPTFS_TAG_70_PACKET_TYPE</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_write_packet_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">],</span>
					  <span class="p">(</span><span class="n">ECRYPTFS_SIG_SIZE</span>
					   <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* Cipher code */</span>
					   <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_size_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error generating tag 70 packet &quot;</span>
		       <span class="s">&quot;header; cannot generate packet length; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span> <span class="o">+=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_size_len</span><span class="p">;</span>
	<span class="n">ecryptfs_from_hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">],</span>
			  <span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_fnek_sig</span><span class="p">,</span>
			  <span class="n">ECRYPTFS_SIG_SIZE</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span> <span class="o">+=</span> <span class="n">ECRYPTFS_SIG_SIZE</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">cipher_code</span> <span class="o">=</span> <span class="n">ecryptfs_code_for_cipher_string</span><span class="p">(</span>
		<span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_fn_cipher_name</span><span class="p">,</span>
		<span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_fn_cipher_key_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">cipher_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unable to generate code for &quot;</span>
		       <span class="s">&quot;cipher [%s] with key bytes [%zd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_fn_cipher_name</span><span class="p">,</span>
		       <span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_fn_cipher_key_bytes</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dest</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">cipher_code</span><span class="p">;</span>
	<span class="cm">/* TODO: Support other key modules than passphrase for</span>
<span class="cm">	 * filename encryption */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token_type</span> <span class="o">!=</span> <span class="n">ECRYPTFS_PASSWORD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Filename encryption only supports &quot;</span>
		       <span class="s">&quot;password tokens</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sg_init_one</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_sg</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">session_key_encryption_key</span><span class="p">,</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">session_key_encryption_key_bytes</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_desc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CRYPTO_TFM_REQ_MAY_SLEEP</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_desc</span><span class="p">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">crypto_alloc_hash</span><span class="p">(</span><span class="n">ECRYPTFS_TAG_70_DIGEST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					     <span class="n">CRYPTO_ALG_ASYNC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_desc</span><span class="p">.</span><span class="n">tfm</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_desc</span><span class="p">.</span><span class="n">tfm</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error attempting to &quot;</span>
			       <span class="s">&quot;allocate hash crypto context; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_hash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;%s: Error initializing crypto hash; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_hash_update</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_sg</span><span class="p">,</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">session_key_encryption_key_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;%s: Error updating crypto hash; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_hash_final</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_desc</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;%s: Error finalizing crypto hash; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">num_rand_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">[(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">j</span> <span class="o">%</span> <span class="n">ECRYPTFS_TAG_70_DIGEST_SIZE</span><span class="p">)];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">j</span> <span class="o">%</span> <span class="n">ECRYPTFS_TAG_70_DIGEST_SIZE</span><span class="p">)</span>
		    <span class="o">==</span> <span class="p">(</span><span class="n">ECRYPTFS_TAG_70_DIGEST_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_sg</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span>
				    <span class="n">ECRYPTFS_TAG_70_DIGEST_SIZE</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_hash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_desc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;%s: Error initializing crypto hash; &quot;</span>
				       <span class="s">&quot;rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_release_free_unlock</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_hash_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_sg</span><span class="p">,</span>
						<span class="n">ECRYPTFS_TAG_70_DIGEST_SIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;%s: Error updating crypto hash; &quot;</span>
				       <span class="s">&quot;rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_release_free_unlock</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_hash_final</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_desc</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">tmp_hash</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;%s: Error finalizing crypto hash; &quot;</span>
				       <span class="s">&quot;rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_release_free_unlock</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">tmp_hash</span><span class="p">,</span>
			       <span class="n">ECRYPTFS_TAG_70_DIGEST_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ECRYPTFS_NON_NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">num_rand_bytes</span><span class="p">],</span> <span class="n">filename</span><span class="p">,</span>
	       <span class="n">filename_size</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">virt_to_scatterlist</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename</span><span class="p">,</span>
				 <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">src_sg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Internal error whilst attempting to &quot;</span>
		       <span class="s">&quot;convert filename memory to scatterlist; rc = [%d]. &quot;</span>
		       <span class="s">&quot;block_aligned_filename_size = [%zd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span>
		       <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">virt_to_scatterlist</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">,</span>
				 <span class="n">s</span><span class="o">-&gt;</span><span class="n">dst_sg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Internal error whilst attempting to &quot;</span>
		       <span class="s">&quot;convert encrypted filename memory to scatterlist; &quot;</span>
		       <span class="s">&quot;rc = [%d]. block_aligned_filename_size = [%zd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* The characters in the first block effectively do the job</span>
<span class="cm">	 * of the IV here, so we just use 0&#39;s for the IV. Note the</span>
<span class="cm">	 * constraint that ECRYPTFS_FILENAME_MIN_RANDOM_PREPEND_BYTES</span>
<span class="cm">	 * &gt;= ECRYPTFS_MAX_IV_BYTES. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ECRYPTFS_MAX_IV_BYTES</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_blkcipher_setkey</span><span class="p">(</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">tfm</span><span class="p">,</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">session_key_encryption_key</span><span class="p">,</span>
		<span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_fn_cipher_key_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error setting key for crypto context; &quot;</span>
		       <span class="s">&quot;rc = [%d]. s-&gt;auth_tok-&gt;token.password.session_key_&quot;</span>
		       <span class="s">&quot;encryption_key = [0x%p]; mount_crypt_stat-&gt;&quot;</span>
		       <span class="s">&quot;global_default_fn_cipher_key_bytes = [%zd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">rc</span><span class="p">,</span>
		       <span class="n">s</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">session_key_encryption_key</span><span class="p">,</span>
		       <span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_fn_cipher_key_bytes</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_blkcipher_encrypt_iv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dst_sg</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">src_sg</span><span class="p">,</span>
					 <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error attempting to encrypt filename; &quot;</span>
		       <span class="s">&quot;rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span> <span class="o">+=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">remaining_bytes</span><span class="p">)</span> <span class="o">-=</span> <span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">);</span>
<span class="nl">out_release_free_unlock:</span>
	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hash_desc</span><span class="p">.</span><span class="n">tfm</span><span class="p">);</span>
<span class="nl">out_free_unlock:</span>
	<span class="n">kzfree</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tfm_mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">auth_tok_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">));</span>
		<span class="n">key_put</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ecryptfs_parse_tag_70_packet_silly_stack</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">cipher_code</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">max_packet_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">packet_size_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">parsed_tag_70_packet_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">block_aligned_filename_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">block_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="o">*</span><span class="n">tfm_mutex</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">decrypted_filename</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">*</span><span class="n">auth_tok</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">src_sg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">dst_sg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">blkcipher_desc</span> <span class="n">desc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">fnek_sig_hex</span><span class="p">[</span><span class="n">ECRYPTFS_SIG_SIZE_HEX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">iv</span><span class="p">[</span><span class="n">ECRYPTFS_MAX_IV_BYTES</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">cipher_string</span><span class="p">[</span><span class="n">ECRYPTFS_MAX_CIPHER_NAME_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * parse_tag_70_packet - Parse and process FNEK-encrypted passphrase packet</span>
<span class="cm"> * @filename: This function kmalloc&#39;s the memory for the filename</span>
<span class="cm"> * @filename_size: This function sets this to the amount of memory</span>
<span class="cm"> *                 kmalloc&#39;d for the filename</span>
<span class="cm"> * @packet_size: This function sets this to the the number of octets</span>
<span class="cm"> *               in the packet parsed</span>
<span class="cm"> * @mount_crypt_stat: The mount-wide cryptographic context</span>
<span class="cm"> * @data: The memory location containing the start of the tag 70</span>
<span class="cm"> *        packet</span>
<span class="cm"> * @max_packet_size: The maximum legal size of the packet to be parsed</span>
<span class="cm"> *                   from @data</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ecryptfs_parse_tag_70_packet</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">filename</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">filename_size</span><span class="p">,</span>
			     <span class="kt">size_t</span> <span class="o">*</span><span class="n">packet_size</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ecryptfs_mount_crypt_stat</span> <span class="o">*</span><span class="n">mount_crypt_stat</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">max_packet_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ecryptfs_parse_tag_70_packet_silly_stack</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">auth_tok_key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">filename_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Out of memory whilst trying to kmalloc &quot;</span>
		       <span class="s">&quot;[%zd] bytes of kernel memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CRYPTO_TFM_REQ_MAY_SLEEP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_packet_size</span> <span class="o">&lt;</span> <span class="n">ECRYPTFS_TAG_70_MIN_METADATA_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: max_packet_size is [%zd]; it must be &quot;</span>
		       <span class="s">&quot;at least [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">max_packet_size</span><span class="p">,</span>
		       <span class="n">ECRYPTFS_TAG_70_MIN_METADATA_SIZE</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Octet 0: Tag 70 identifier</span>
<span class="cm">	 * Octets 1-N1: Tag 70 packet size (includes cipher identifier</span>
<span class="cm">	 *              and block-aligned encrypted filename size)</span>
<span class="cm">	 * Octets N1-N2: FNEK sig (ECRYPTFS_SIG_SIZE)</span>
<span class="cm">	 * Octet N2-N3: Cipher identifier (1 octet)</span>
<span class="cm">	 * Octets N3-N4: Block-aligned encrypted filename</span>
<span class="cm">	 *  - Consists of a minimum number of random numbers, a \0</span>
<span class="cm">	 *    separator, and then the filename */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ECRYPTFS_TAG_70_PACKET_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Invalid packet tag [0x%.2x]; must be &quot;</span>
		       <span class="s">&quot;tag [0x%.2x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">data</span><span class="p">[((</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">ECRYPTFS_TAG_70_PACKET_TYPE</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_parse_packet_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span>
					  <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">parsed_tag_70_packet_size</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_size_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Error parsing packet length; &quot;</span>
		       <span class="s">&quot;rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">parsed_tag_70_packet_size</span>
					  <span class="o">-</span> <span class="n">ECRYPTFS_SIG_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_size_len</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">parsed_tag_70_packet_size</span><span class="p">)</span>
	    <span class="o">&gt;</span> <span class="n">max_packet_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: max_packet_size is [%zd]; real packet &quot;</span>
		       <span class="s">&quot;size is [%zd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">max_packet_size</span><span class="p">,</span>
		       <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_size_len</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_size_len</span><span class="p">;</span>
	<span class="n">ecryptfs_to_hex</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">fnek_sig_hex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span>
			<span class="n">ECRYPTFS_SIG_SIZE</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">fnek_sig_hex</span><span class="p">[</span><span class="n">ECRYPTFS_SIG_SIZE_HEX</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="n">ECRYPTFS_SIG_SIZE</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">cipher_code</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">];</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_cipher_code_to_string</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">cipher_string</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">cipher_code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Cipher code [%d] is invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">cipher_code</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_find_auth_tok_for_sig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">auth_tok_key</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="p">,</span> <span class="n">mount_crypt_stat</span><span class="p">,</span>
					    <span class="n">s</span><span class="o">-&gt;</span><span class="n">fnek_sig_hex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error attempting to find auth tok for &quot;</span>
		       <span class="s">&quot;fnek sig [%s]; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">fnek_sig_hex</span><span class="p">,</span>
		       <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_get_tfm_and_mutex_for_cipher_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">tfm</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tfm_mutex</span><span class="p">,</span>
							<span class="n">s</span><span class="o">-&gt;</span><span class="n">cipher_string</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Internal error whilst attempting to get &quot;</span>
		       <span class="s">&quot;tfm and mutex for cipher name [%s]; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">s</span><span class="o">-&gt;</span><span class="n">cipher_string</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tfm_mutex</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">virt_to_scatterlist</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span>
				 <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">src_sg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Internal error whilst attempting to &quot;</span>
		       <span class="s">&quot;convert encrypted filename memory to scatterlist; &quot;</span>
		       <span class="s">&quot;rc = [%d]. block_aligned_filename_size = [%zd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">decrypted_filename</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">decrypted_filename</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Out of memory whilst attempting to &quot;</span>
		       <span class="s">&quot;kmalloc [%zd] bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">virt_to_scatterlist</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">decrypted_filename</span><span class="p">,</span>
				 <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dst_sg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Internal error whilst attempting to &quot;</span>
		       <span class="s">&quot;convert decrypted filename memory to scatterlist; &quot;</span>
		       <span class="s">&quot;rc = [%d]. block_aligned_filename_size = [%zd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* The characters in the first block effectively do the job of</span>
<span class="cm">	 * the IV here, so we just use 0&#39;s for the IV. Note the</span>
<span class="cm">	 * constraint that ECRYPTFS_FILENAME_MIN_RANDOM_PREPEND_BYTES</span>
<span class="cm">	 * &gt;= ECRYPTFS_MAX_IV_BYTES. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ECRYPTFS_MAX_IV_BYTES</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">;</span>
	<span class="cm">/* TODO: Support other key modules than passphrase for</span>
<span class="cm">	 * filename encryption */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token_type</span> <span class="o">!=</span> <span class="n">ECRYPTFS_PASSWORD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Filename encryption only supports &quot;</span>
		       <span class="s">&quot;password tokens</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_blkcipher_setkey</span><span class="p">(</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">tfm</span><span class="p">,</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">session_key_encryption_key</span><span class="p">,</span>
		<span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_fn_cipher_key_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error setting key for crypto context; &quot;</span>
		       <span class="s">&quot;rc = [%d]. s-&gt;auth_tok-&gt;token.password.session_key_&quot;</span>
		       <span class="s">&quot;encryption_key = [0x%p]; mount_crypt_stat-&gt;&quot;</span>
		       <span class="s">&quot;global_default_fn_cipher_key_bytes = [%zd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">rc</span><span class="p">,</span>
		       <span class="n">s</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">session_key_encryption_key</span><span class="p">,</span>
		       <span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_fn_cipher_key_bytes</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_blkcipher_decrypt_iv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dst_sg</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">src_sg</span><span class="p">,</span>
					 <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error attempting to decrypt filename; &quot;</span>
		       <span class="s">&quot;rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">decrypted_filename</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span>
	       <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span> <span class="o">==</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Invalid tag 70 packet; could not &quot;</span>
		       <span class="s">&quot;find valid separator between random characters and &quot;</span>
		       <span class="s">&quot;the filename</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">filename_size</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">block_aligned_filename_size</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="o">*</span><span class="n">filename_size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">filename_size</span> <span class="o">&lt;</span> <span class="n">PATH_MAX</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Filename size is [%zd], which is &quot;</span>
		       <span class="s">&quot;invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">filename_size</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(((</span><span class="o">*</span><span class="n">filename_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">filename</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Out of memory whilst attempting to &quot;</span>
		       <span class="s">&quot;kmalloc [%zd] bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="p">((</span><span class="o">*</span><span class="n">filename_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="o">*</span><span class="n">filename</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">decrypted_filename</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="o">*</span><span class="n">filename_size</span><span class="p">));</span>
	<span class="p">(</span><span class="o">*</span><span class="n">filename</span><span class="p">)[(</span><span class="o">*</span><span class="n">filename_size</span><span class="p">)]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="nl">out_free_unlock:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">decrypted_filename</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tfm_mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">filename_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">auth_tok_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">));</span>
		<span class="n">key_put</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ecryptfs_get_auth_tok_sig</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">sig</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">*</span><span class="n">auth_tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">sig</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ECRYPTFS_PASSWORD</span>:
		<span class="p">(</span><span class="o">*</span><span class="n">sig</span><span class="p">)</span> <span class="o">=</span> <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">signature</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ECRYPTFS_PRIVATE_KEY</span>:
		<span class="p">(</span><span class="o">*</span><span class="n">sig</span><span class="p">)</span> <span class="o">=</span> <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">private_key</span><span class="p">.</span><span class="n">signature</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cannot get sig for auth_tok of type [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token_type</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * decrypt_pki_encrypted_session_key - Decrypt the session key with the given auth_tok.</span>
<span class="cm"> * @auth_tok: The key authentication token used to decrypt the session key</span>
<span class="cm"> * @crypt_stat: The cryptographic context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero error otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">decrypt_pki_encrypted_session_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">*</span><span class="n">auth_tok</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cipher_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_msg_ctx</span> <span class="o">*</span><span class="n">msg_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_message</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">auth_tok_sig</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">payload</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">payload_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_get_auth_tok_sig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">auth_tok_sig</span><span class="p">,</span> <span class="n">auth_tok</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unrecognized auth tok type: [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token_type</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">write_tag_64_packet</span><span class="p">(</span><span class="n">auth_tok_sig</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">),</span>
				 <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Failed to write tag 64 packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_send_message</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error sending message to &quot;</span>
				<span class="s">&quot;ecryptfsd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_wait_for_response</span><span class="p">(</span><span class="n">msg_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Failed to receive tag 65 packet &quot;</span>
				<span class="s">&quot;from the user space daemon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">parse_tag_65_packet</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">),</span>
				 <span class="o">&amp;</span><span class="n">cipher_code</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to parse tag 65 packet; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ECRYPTFS_CONTAINS_DECRYPTED_KEY</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">decrypted_key</span><span class="p">,</span>
	       <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">decrypted_key_size</span><span class="p">);</span>
	<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span> <span class="o">=</span> <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">decrypted_key_size</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_cipher_code_to_string</span><span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span> <span class="n">cipher_code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Cipher code [%d] is invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cipher_code</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ECRYPTFS_KEY_VALID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecryptfs_verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;Decrypted session key:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ecryptfs_dump_hex</span><span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
				  <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wipe_auth_tok_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">auth_tok_list_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ecryptfs_auth_tok_list_item</span> <span class="o">*</span><span class="n">auth_tok_list_item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_auth_tok_list_item</span> <span class="o">*</span><span class="n">auth_tok_list_item_tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">auth_tok_list_item</span><span class="p">,</span> <span class="n">auth_tok_list_item_tmp</span><span class="p">,</span>
				 <span class="n">auth_tok_list_head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">auth_tok_list_item</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ecryptfs_auth_tok_list_item_cache</span><span class="p">,</span>
				<span class="n">auth_tok_list_item</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">ecryptfs_auth_tok_list_item_cache</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * parse_tag_1_packet</span>
<span class="cm"> * @crypt_stat: The cryptographic context to modify based on packet contents</span>
<span class="cm"> * @data: The raw bytes of the packet.</span>
<span class="cm"> * @auth_tok_list: eCryptfs parses packets into authentication tokens;</span>
<span class="cm"> *                 a new authentication token will be placed at the</span>
<span class="cm"> *                 end of this list for this packet.</span>
<span class="cm"> * @new_auth_tok: Pointer to a pointer to memory that this function</span>
<span class="cm"> *                allocates; sets the memory address of the pointer to</span>
<span class="cm"> *                NULL on error. This object is added to the</span>
<span class="cm"> *                auth_tok_list.</span>
<span class="cm"> * @packet_size: This function writes the size of the parsed packet</span>
<span class="cm"> *               into this memory location; zero on error.</span>
<span class="cm"> * @max_packet_size: The maximum allowable packet size</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">parse_tag_1_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">auth_tok_list</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">**</span><span class="n">new_auth_tok</span><span class="p">,</span>
		   <span class="kt">size_t</span> <span class="o">*</span><span class="n">packet_size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">max_packet_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">body_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_auth_tok_list_item</span> <span class="o">*</span><span class="n">auth_tok_list_item</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">length_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * This format is inspired by OpenPGP; see RFC 2440</span>
<span class="cm">	 * packet tag 1</span>
<span class="cm">	 *</span>
<span class="cm">	 * Tag 1 identifier (1 byte)</span>
<span class="cm">	 * Max Tag 1 packet size (max 3 bytes)</span>
<span class="cm">	 * Version (1 byte)</span>
<span class="cm">	 * Key identifier (8 bytes; ECRYPTFS_SIG_SIZE)</span>
<span class="cm">	 * Cipher identifier (1 byte)</span>
<span class="cm">	 * Encrypted key size (arbitrary)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 12 bytes minimum packet size</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">max_packet_size</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid max packet size; must be &gt;=12</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ECRYPTFS_TAG_1_PACKET_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Enter w/ first byte != 0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ECRYPTFS_TAG_1_PACKET_TYPE</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Released: wipe_auth_tok_list called in ecryptfs_parse_packet_set or</span>
<span class="cm">	 * at end of function upon failure */</span>
	<span class="n">auth_tok_list_item</span> <span class="o">=</span>
		<span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">ecryptfs_auth_tok_list_item_cache</span><span class="p">,</span>
				  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">auth_tok_list_item</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">auth_tok_list_item</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_parse_packet_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span> <span class="o">&amp;</span><span class="n">body_size</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">length_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Error parsing packet length; &quot;</span>
		       <span class="s">&quot;rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">body_size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ECRYPTFS_SIG_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Invalid body size ([%td])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">body_size</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="n">length_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">body_size</span> <span class="o">&gt;</span> <span class="n">max_packet_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Packet size exceeds max</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x03</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unknown version number [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ecryptfs_to_hex</span><span class="p">((</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">private_key</span><span class="p">.</span><span class="n">signature</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span> <span class="n">ECRYPTFS_SIG_SIZE</span><span class="p">);</span>
	<span class="o">*</span><span class="n">packet_size</span> <span class="o">+=</span> <span class="n">ECRYPTFS_SIG_SIZE</span><span class="p">;</span>
	<span class="cm">/* This byte is skipped because the kernel does not need to</span>
<span class="cm">	 * know which public key encryption algorithm was used */</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span> <span class="o">=</span>
		<span class="n">body_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">ECRYPTFS_SIG_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span>
	    <span class="o">&gt;</span> <span class="n">ECRYPTFS_MAX_ENCRYPTED_KEY_BYTES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Tag 1 packet contains key larger &quot;</span>
		       <span class="s">&quot;than ECRYPTFS_MAX_ENCRYPTED_KEY_BYTES&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span> <span class="p">(</span><span class="n">body_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">ECRYPTFS_SIG_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)));</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span>
		<span class="o">~</span><span class="n">ECRYPTFS_CONTAINS_DECRYPTED_KEY</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
		<span class="n">ECRYPTFS_CONTAINS_ENCRYPTED_KEY</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">token_type</span> <span class="o">=</span> <span class="n">ECRYPTFS_PRIVATE_KEY</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span>
		<span class="o">~</span><span class="p">(</span><span class="n">ECRYPTFS_USERSPACE_SHOULD_TRY_TO_DECRYPT</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span>
		<span class="o">~</span><span class="p">(</span><span class="n">ECRYPTFS_USERSPACE_SHOULD_TRY_TO_ENCRYPT</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">auth_tok_list_item</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">auth_tok_list</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">auth_tok_list_item</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecryptfs_auth_tok_list_item</span><span class="p">));</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ecryptfs_auth_tok_list_item_cache</span><span class="p">,</span>
			<span class="n">auth_tok_list_item</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * parse_tag_3_packet</span>
<span class="cm"> * @crypt_stat: The cryptographic context to modify based on packet</span>
<span class="cm"> *              contents.</span>
<span class="cm"> * @data: The raw bytes of the packet.</span>
<span class="cm"> * @auth_tok_list: eCryptfs parses packets into authentication tokens;</span>
<span class="cm"> *                 a new authentication token will be placed at the end</span>
<span class="cm"> *                 of this list for this packet.</span>
<span class="cm"> * @new_auth_tok: Pointer to a pointer to memory that this function</span>
<span class="cm"> *                allocates; sets the memory address of the pointer to</span>
<span class="cm"> *                NULL on error. This object is added to the</span>
<span class="cm"> *                auth_tok_list.</span>
<span class="cm"> * @packet_size: This function writes the size of the parsed packet</span>
<span class="cm"> *               into this memory location; zero on error.</span>
<span class="cm"> * @max_packet_size: maximum number of bytes to parse</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">parse_tag_3_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">auth_tok_list</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">**</span><span class="n">new_auth_tok</span><span class="p">,</span>
		   <span class="kt">size_t</span> <span class="o">*</span><span class="n">packet_size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">max_packet_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">body_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_auth_tok_list_item</span> <span class="o">*</span><span class="n">auth_tok_list_item</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">length_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/**</span>
<span class="cm">	 *This format is inspired by OpenPGP; see RFC 2440</span>
<span class="cm">	 * packet tag 3</span>
<span class="cm">	 *</span>
<span class="cm">	 * Tag 3 identifier (1 byte)</span>
<span class="cm">	 * Max Tag 3 packet size (max 3 bytes)</span>
<span class="cm">	 * Version (1 byte)</span>
<span class="cm">	 * Cipher code (1 byte)</span>
<span class="cm">	 * S2K specifier (1 byte)</span>
<span class="cm">	 * Hash identifier (1 byte)</span>
<span class="cm">	 * Salt (ECRYPTFS_SALT_SIZE)</span>
<span class="cm">	 * Hash iterations (1 byte)</span>
<span class="cm">	 * Encrypted key (arbitrary)</span>
<span class="cm">	 *</span>
<span class="cm">	 * (ECRYPTFS_SALT_SIZE + 7) minimum packet size</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_packet_size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ECRYPTFS_SALT_SIZE</span> <span class="o">+</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Max packet size too large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ECRYPTFS_TAG_3_PACKET_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;First byte != 0x%.2x; invalid packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ECRYPTFS_TAG_3_PACKET_TYPE</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Released: wipe_auth_tok_list called in ecryptfs_parse_packet_set or</span>
<span class="cm">	 * at end of function upon failure */</span>
	<span class="n">auth_tok_list_item</span> <span class="o">=</span>
	    <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">ecryptfs_auth_tok_list_item_cache</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">auth_tok_list_item</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">auth_tok_list_item</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_parse_packet_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span> <span class="o">&amp;</span><span class="n">body_size</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">length_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Error parsing packet length; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">body_size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ECRYPTFS_SALT_SIZE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Invalid body size ([%td])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">body_size</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="n">length_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">body_size</span> <span class="o">&gt;</span> <span class="n">max_packet_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Packet size exceeds max</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">body_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">ECRYPTFS_SALT_SIZE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span>
	    <span class="o">&gt;</span> <span class="n">ECRYPTFS_MAX_ENCRYPTED_KEY_BYTES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Tag 3 packet contains key larger &quot;</span>
		       <span class="s">&quot;than ECRYPTFS_MAX_ENCRYPTED_KEY_BYTES</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x04</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unknown version number [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_cipher_code_to_string</span><span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="cm">/* A little extra work to differentiate among the AES key</span>
<span class="cm">	 * sizes; see RFC2440 */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RFC2440_CIPHER_AES_192</span>:
		<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span> <span class="o">=</span>
			<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_init_crypt_ctx</span><span class="p">(</span><span class="n">crypt_stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x03</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Only S2K ID 3 is currently supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* TODO: finish the hash mapping */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x01</span>: <span class="cm">/* See RFC2440 for these numbers and their mappings */</span>
		<span class="cm">/* Choose MD5 */</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">salt</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span> <span class="n">ECRYPTFS_SALT_SIZE</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="n">ECRYPTFS_SALT_SIZE</span><span class="p">;</span>
		<span class="cm">/* This conversion was taken straight from RFC2440 */</span>
		<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">hash_iterations</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">))</span>
				<span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* Friendly reminder:</span>
<span class="cm">		 * (*new_auth_tok)-&gt;session_key.encrypted_key_size =</span>
<span class="cm">		 *         (body_size - (ECRYPTFS_SALT_SIZE + 5)); */</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span>
		       <span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span>
			<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="n">ECRYPTFS_CONTAINS_DECRYPTED_KEY</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
			<span class="n">ECRYPTFS_CONTAINS_ENCRYPTED_KEY</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">hash_algo</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* MD5 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Unsupported hash algorithm: &quot;</span>
				<span class="s">&quot;[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">token_type</span> <span class="o">=</span> <span class="n">ECRYPTFS_PASSWORD</span><span class="p">;</span>
	<span class="cm">/* TODO: Parametarize; we might actually want userspace to</span>
<span class="cm">	 * decrypt the session key. */</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="p">(</span><span class="n">ECRYPTFS_USERSPACE_SHOULD_TRY_TO_DECRYPT</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="p">(</span><span class="n">ECRYPTFS_USERSPACE_SHOULD_TRY_TO_ENCRYPT</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">auth_tok_list_item</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">auth_tok_list</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="p">(</span><span class="o">*</span><span class="n">new_auth_tok</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">auth_tok_list_item</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecryptfs_auth_tok_list_item</span><span class="p">));</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ecryptfs_auth_tok_list_item_cache</span><span class="p">,</span>
			<span class="n">auth_tok_list_item</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * parse_tag_11_packet</span>
<span class="cm"> * @data: The raw bytes of the packet</span>
<span class="cm"> * @contents: This function writes the data contents of the literal</span>
<span class="cm"> *            packet into this memory location</span>
<span class="cm"> * @max_contents_bytes: The maximum number of bytes that this function</span>
<span class="cm"> *                      is allowed to write into contents</span>
<span class="cm"> * @tag_11_contents_size: This function writes the size of the parsed</span>
<span class="cm"> *                        contents into this memory location; zero on</span>
<span class="cm"> *                        error</span>
<span class="cm"> * @packet_size: This function writes the size of the parsed packet</span>
<span class="cm"> *               into this memory location; zero on error</span>
<span class="cm"> * @max_packet_size: maximum number of bytes to parse</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">parse_tag_11_packet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">contents</span><span class="p">,</span>
		    <span class="kt">size_t</span> <span class="n">max_contents_bytes</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">tag_11_contents_size</span><span class="p">,</span>
		    <span class="kt">size_t</span> <span class="o">*</span><span class="n">packet_size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">max_packet_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">body_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">length_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">tag_11_contents_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* This format is inspired by OpenPGP; see RFC 2440</span>
<span class="cm">	 * packet tag 11</span>
<span class="cm">	 *</span>
<span class="cm">	 * Tag 11 identifier (1 byte)</span>
<span class="cm">	 * Max Tag 11 packet size (max 3 bytes)</span>
<span class="cm">	 * Binary format specifier (1 byte)</span>
<span class="cm">	 * Filename length (1 byte)</span>
<span class="cm">	 * Filename (&quot;_CONSOLE&quot;) (8 bytes)</span>
<span class="cm">	 * Modification date (4 bytes)</span>
<span class="cm">	 * Literal data (arbitrary)</span>
<span class="cm">	 *</span>
<span class="cm">	 * We need at least 16 bytes of data for the packet to even be</span>
<span class="cm">	 * valid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_packet_size</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Maximum packet size too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ECRYPTFS_TAG_11_PACKET_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Invalid tag 11 packet format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_parse_packet_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span> <span class="o">&amp;</span><span class="n">body_size</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">length_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Invalid tag 11 packet format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">body_size</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Invalid body size ([%td])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">body_size</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="n">length_size</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">tag_11_contents_size</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">body_size</span> <span class="o">-</span> <span class="mi">14</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">body_size</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">max_packet_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Packet size exceeds max</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="o">*</span><span class="n">tag_11_contents_size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_contents_bytes</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Literal data section in tag 11 packet exceeds &quot;</span>
		       <span class="s">&quot;expected size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x62</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unrecognizable packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unrecognizable packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span> <span class="cm">/* Ignore filename and modification date */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span> <span class="p">(</span><span class="o">*</span><span class="n">tag_11_contents_size</span><span class="p">));</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">tag_11_contents_size</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">tag_11_contents_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ecryptfs_keyring_auth_tok_for_sig</span><span class="p">(</span><span class="k">struct</span> <span class="n">key</span> <span class="o">**</span><span class="n">auth_tok_key</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">**</span><span class="n">auth_tok</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="o">*</span><span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">)</span> <span class="o">=</span> <span class="n">request_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key_type_user</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">))</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">)</span> <span class="o">=</span> <span class="n">ecryptfs_get_encrypted_key</span><span class="p">(</span><span class="n">sig</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Could not find key with description: [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">sig</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">process_request_key_err</span><span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">));</span>
			<span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_verify_auth_tok_from_key</span><span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">,</span> <span class="n">auth_tok</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="n">key_put</span><span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">auth_tok_key</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * decrypt_passphrase_encrypted_session_key - Decrypt the session key with the given auth_tok.</span>
<span class="cm"> * @auth_tok: The passphrase authentication token to use to encrypt the FEK</span>
<span class="cm"> * @crypt_stat: The cryptographic context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero error otherwise</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">decrypt_passphrase_encrypted_session_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">*</span><span class="n">auth_tok</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">dst_sg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">src_sg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="o">*</span><span class="n">tfm_mutex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blkcipher_desc</span> <span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CRYPTO_TFM_REQ_MAY_SLEEP</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ecryptfs_verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span>
			<span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;Session key encryption key (size [%d]):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">session_key_encryption_key_bytes</span><span class="p">);</span>
		<span class="n">ecryptfs_dump_hex</span><span class="p">(</span>
			<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">session_key_encryption_key</span><span class="p">,</span>
			<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">session_key_encryption_key_bytes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_get_tfm_and_mutex_for_cipher_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">.</span><span class="n">tfm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tfm_mutex</span><span class="p">,</span>
							<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Internal error whilst attempting to get &quot;</span>
		       <span class="s">&quot;tfm and mutex for cipher name [%s]; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">virt_to_scatterlist</span><span class="p">(</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key</span><span class="p">,</span>
				 <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span><span class="p">,</span>
				 <span class="n">src_sg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Internal error whilst attempting to convert &quot;</span>
			<span class="s">&quot;auth_tok-&gt;session_key.encrypted_key to scatterlist; &quot;</span>
			<span class="s">&quot;expected rc = 1; got rc = [%d]. &quot;</span>
		       <span class="s">&quot;auth_tok-&gt;session_key.encrypted_key_size = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span>
			<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">decrypted_key_size</span> <span class="o">=</span>
		<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">virt_to_scatterlist</span><span class="p">(</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">decrypted_key</span><span class="p">,</span>
				 <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">decrypted_key_size</span><span class="p">,</span>
				 <span class="n">dst_sg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Internal error whilst attempting to convert &quot;</span>
			<span class="s">&quot;auth_tok-&gt;session_key.decrypted_key to scatterlist; &quot;</span>
			<span class="s">&quot;expected rc = 1; got rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">tfm_mutex</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_blkcipher_setkey</span><span class="p">(</span>
		<span class="n">desc</span><span class="p">.</span><span class="n">tfm</span><span class="p">,</span> <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">session_key_encryption_key</span><span class="p">,</span>
		<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">tfm_mutex</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error setting key for crypto context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_blkcipher_decrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="n">dst_sg</span><span class="p">,</span> <span class="n">src_sg</span><span class="p">,</span>
				      <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">tfm_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error decrypting; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ECRYPTFS_CONTAINS_DECRYPTED_KEY</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">decrypted_key</span><span class="p">,</span>
	       <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">decrypted_key_size</span><span class="p">);</span>
	<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ECRYPTFS_KEY_VALID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ecryptfs_verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;FEK of size [%zd]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">);</span>
		<span class="n">ecryptfs_dump_hex</span><span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
				  <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_parse_packet_set</span>
<span class="cm"> * @crypt_stat: The cryptographic context</span>
<span class="cm"> * @src: Virtual address of region of memory containing the packets</span>
<span class="cm"> * @ecryptfs_dentry: The eCryptfs dentry associated with the packet set</span>
<span class="cm"> *</span>
<span class="cm"> * Get crypt_stat to have the file&#39;s session key if the requisite key</span>
<span class="cm"> * is available to decrypt the session key.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns Zero if a valid authentication token was retrieved and</span>
<span class="cm"> * processed; negative value for file not encrypted or for error</span>
<span class="cm"> * conditions.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ecryptfs_parse_packet_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ecryptfs_dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">found_auth_tok</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">next_packet_is_auth_tok_packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">auth_tok_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">*</span><span class="n">matching_auth_tok</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">*</span><span class="n">candidate_auth_tok</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">candidate_auth_tok_sig</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">packet_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">*</span><span class="n">new_auth_tok</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sig_tmp_space</span><span class="p">[</span><span class="n">ECRYPTFS_SIG_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ecryptfs_auth_tok_list_item</span> <span class="o">*</span><span class="n">auth_tok_list_item</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">tag_11_contents_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">tag_11_packet_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">auth_tok_key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">auth_tok_list</span><span class="p">);</span>
	<span class="cm">/* Parse the header to find as many packets as we can; these will be</span>
<span class="cm">	 * added the our &amp;auth_tok_list */</span>
	<span class="n">next_packet_is_auth_tok_packet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">next_packet_is_auth_tok_packet</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">max_packet_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">PAGE_CACHE_SIZE</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ECRYPTFS_TAG_3_PACKET_TYPE</span>:
			<span class="n">rc</span> <span class="o">=</span> <span class="n">parse_tag_3_packet</span><span class="p">(</span><span class="n">crypt_stat</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">auth_tok_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_auth_tok</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">packet_size</span><span class="p">,</span> <span class="n">max_packet_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error parsing &quot;</span>
						<span class="s">&quot;tag 3 packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_wipe_list</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="n">packet_size</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">parse_tag_11_packet</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						 <span class="n">sig_tmp_space</span><span class="p">,</span>
						 <span class="n">ECRYPTFS_SIG_SIZE</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">tag_11_contents_size</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">tag_11_packet_size</span><span class="p">,</span>
						 <span class="n">max_packet_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;No valid &quot;</span>
						<span class="s">&quot;(ecryptfs-specific) literal &quot;</span>
						<span class="s">&quot;packet containing &quot;</span>
						<span class="s">&quot;authentication token &quot;</span>
						<span class="s">&quot;signature found after &quot;</span>
						<span class="s">&quot;tag 3 packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_wipe_list</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="n">tag_11_packet_size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ECRYPTFS_SIG_SIZE</span> <span class="o">!=</span> <span class="n">tag_11_contents_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Expected &quot;</span>
						<span class="s">&quot;signature of size [%d]; &quot;</span>
						<span class="s">&quot;read size [%zd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ECRYPTFS_SIG_SIZE</span><span class="p">,</span>
						<span class="n">tag_11_contents_size</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_wipe_list</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ecryptfs_to_hex</span><span class="p">(</span><span class="n">new_auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">signature</span><span class="p">,</span>
					<span class="n">sig_tmp_space</span><span class="p">,</span> <span class="n">tag_11_contents_size</span><span class="p">);</span>
			<span class="n">new_auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">signature</span><span class="p">[</span>
				<span class="n">ECRYPTFS_PASSWORD_SIG_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ECRYPTFS_ENCRYPTED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ECRYPTFS_TAG_1_PACKET_TYPE</span>:
			<span class="n">rc</span> <span class="o">=</span> <span class="n">parse_tag_1_packet</span><span class="p">(</span><span class="n">crypt_stat</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">auth_tok_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_auth_tok</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">packet_size</span><span class="p">,</span> <span class="n">max_packet_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error parsing &quot;</span>
						<span class="s">&quot;tag 1 packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_wipe_list</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="n">packet_size</span><span class="p">;</span>
			<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ECRYPTFS_ENCRYPTED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ECRYPTFS_TAG_11_PACKET_TYPE</span>:
			<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Invalid packet set &quot;</span>
					<span class="s">&quot;(Tag 11 not allowed by itself)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_wipe_list</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;No packet at offset [%zd] &quot;</span>
					<span class="s">&quot;of the file header; hex value of &quot;</span>
					<span class="s">&quot;character is [0x%.2x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">next_packet_is_auth_tok_packet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">auth_tok_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;The lower file appears to be a non-encrypted &quot;</span>
		       <span class="s">&quot;eCryptfs file; this is not supported in this version &quot;</span>
		       <span class="s">&quot;of the eCryptfs kernel module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* auth_tok_list contains the set of authentication tokens</span>
<span class="cm">	 * parsed from the metadata. We need to find a matching</span>
<span class="cm">	 * authentication token that has the secret component(s)</span>
<span class="cm">	 * necessary to decrypt the EFEK in the auth_tok parsed from</span>
<span class="cm">	 * the metadata. There may be several potential matches, but</span>
<span class="cm">	 * just one will be sufficient to decrypt to get the FEK. */</span>
<span class="nl">find_next_matching_auth_tok:</span>
	<span class="n">found_auth_tok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">auth_tok_list_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">auth_tok_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">candidate_auth_tok</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">auth_tok_list_item</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ecryptfs_verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
					<span class="s">&quot;Considering cadidate auth tok:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ecryptfs_dump_auth_tok</span><span class="p">(</span><span class="n">candidate_auth_tok</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_get_auth_tok_sig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">candidate_auth_tok_sig</span><span class="p">,</span>
					       <span class="n">candidate_auth_tok</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;Unrecognized candidate auth tok type: [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">candidate_auth_tok</span><span class="o">-&gt;</span><span class="n">token_type</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_wipe_list</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_find_auth_tok_for_sig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">auth_tok_key</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">matching_auth_tok</span><span class="p">,</span>
					       <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">mount_crypt_stat</span><span class="p">,</span>
					       <span class="n">candidate_auth_tok_sig</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found_auth_tok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">found_matching_auth_tok</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found_auth_tok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Could not find a usable &quot;</span>
				<span class="s">&quot;authentication token</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_wipe_list</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">found_matching_auth_tok:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">candidate_auth_tok</span><span class="o">-&gt;</span><span class="n">token_type</span> <span class="o">==</span> <span class="n">ECRYPTFS_PRIVATE_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">candidate_auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">private_key</span><span class="p">),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">matching_auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">private_key</span><span class="p">),</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecryptfs_private_key</span><span class="p">));</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">));</span>
		<span class="n">key_put</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">decrypt_pki_encrypted_session_key</span><span class="p">(</span><span class="n">candidate_auth_tok</span><span class="p">,</span>
						       <span class="n">crypt_stat</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">candidate_auth_tok</span><span class="o">-&gt;</span><span class="n">token_type</span> <span class="o">==</span> <span class="n">ECRYPTFS_PASSWORD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">candidate_auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">matching_auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">),</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecryptfs_password</span><span class="p">));</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">));</span>
		<span class="n">key_put</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">decrypt_passphrase_encrypted_session_key</span><span class="p">(</span>
			<span class="n">candidate_auth_tok</span><span class="p">,</span> <span class="n">crypt_stat</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">));</span>
		<span class="n">key_put</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ecryptfs_auth_tok_list_item</span> <span class="o">*</span><span class="n">auth_tok_list_item_tmp</span><span class="p">;</span>

		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Error decrypting the &quot;</span>
				<span class="s">&quot;session key for authentication token with sig &quot;</span>
				<span class="s">&quot;[%.*s]; rc = [%d]. Removing auth tok &quot;</span>
				<span class="s">&quot;candidate from the list and searching for &quot;</span>
				<span class="s">&quot;the next match.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ECRYPTFS_SIG_SIZE_HEX</span><span class="p">,</span>
				<span class="n">candidate_auth_tok_sig</span><span class="p">,</span>	<span class="n">rc</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">auth_tok_list_item</span><span class="p">,</span>
					 <span class="n">auth_tok_list_item_tmp</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">auth_tok_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">candidate_auth_tok</span>
			    <span class="o">==</span> <span class="o">&amp;</span><span class="n">auth_tok_list_item</span><span class="o">-&gt;</span><span class="n">auth_tok</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">auth_tok_list_item</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="n">kmem_cache_free</span><span class="p">(</span>
					<span class="n">ecryptfs_auth_tok_list_item_cache</span><span class="p">,</span>
					<span class="n">auth_tok_list_item</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">find_next_matching_auth_tok</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_compute_root_iv</span><span class="p">(</span><span class="n">crypt_stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error computing &quot;</span>
				<span class="s">&quot;the root IV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_wipe_list</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_init_crypt_ctx</span><span class="p">(</span><span class="n">crypt_stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error initializing crypto &quot;</span>
				<span class="s">&quot;context for cipher [%s]; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out_wipe_list:</span>
	<span class="n">wipe_auth_tok_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">auth_tok_list</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pki_encrypt_session_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">auth_tok_key</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">*</span><span class="n">auth_tok</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ecryptfs_key_record</span> <span class="o">*</span><span class="n">key_rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ecryptfs_msg_ctx</span> <span class="o">*</span><span class="n">msg_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">payload</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">write_tag_66_packet</span><span class="p">(</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">private_key</span><span class="p">.</span><span class="n">signature</span><span class="p">,</span>
				 <span class="n">ecryptfs_code_for_cipher_string</span><span class="p">(</span>
					 <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span>
					 <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">),</span>
				 <span class="n">crypt_stat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">));</span>
	<span class="n">key_put</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error generating tag 66 packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_send_message</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error sending message to &quot;</span>
				<span class="s">&quot;ecryptfsd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_wait_for_response</span><span class="p">(</span><span class="n">msg_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Failed to receive tag 67 packet &quot;</span>
				<span class="s">&quot;from the user space daemon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">parse_tag_67_packet</span><span class="p">(</span><span class="n">key_rec</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error parsing tag 67 packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * write_tag_1_packet - Write an RFC2440-compatible tag 1 (public key) packet</span>
<span class="cm"> * @dest: Buffer into which to write the packet</span>
<span class="cm"> * @remaining_bytes: Maximum number of bytes that can be writtn</span>
<span class="cm"> * @auth_tok_key: The authentication token key to unlock and put when done with</span>
<span class="cm"> *                @auth_tok</span>
<span class="cm"> * @auth_tok: The authentication token used for generating the tag 1 packet</span>
<span class="cm"> * @crypt_stat: The cryptographic context</span>
<span class="cm"> * @key_rec: The key record struct for the tag 1 packet</span>
<span class="cm"> * @packet_size: This function will write the number of bytes that end</span>
<span class="cm"> *               up constituting the packet; set to zero on error</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">write_tag_1_packet</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">remaining_bytes</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">auth_tok_key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">*</span><span class="n">auth_tok</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ecryptfs_key_record</span> <span class="o">*</span><span class="n">key_rec</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">packet_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">encrypted_session_key_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">packet_size_length</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">max_packet_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ecryptfs_from_hex</span><span class="p">(</span><span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">,</span> <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">private_key</span><span class="p">.</span><span class="n">signature</span><span class="p">,</span>
			  <span class="n">ECRYPTFS_SIG_SIZE</span><span class="p">);</span>
	<span class="n">encrypted_session_key_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">encrypted_session_key_valid</span> <span class="o">|=</span>
			<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">encrypted_session_key_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key</span><span class="p">,</span>
		       <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key</span><span class="p">,</span>
		       <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">));</span>
		<span class="n">key_put</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">encrypted_session_key_set</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span> <span class="o">=</span>
			<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">private_key</span><span class="p">.</span><span class="n">key_size</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pki_encrypt_session_key</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="p">,</span> <span class="n">auth_tok</span><span class="p">,</span> <span class="n">crypt_stat</span><span class="p">,</span>
				     <span class="n">key_rec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to encrypt session key via a key &quot;</span>
		       <span class="s">&quot;module; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecryptfs_verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;Encrypted key:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ecryptfs_dump_hex</span><span class="p">(</span><span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key</span><span class="p">,</span> <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">encrypted_session_key_set:</span>
	<span class="cm">/* This format is inspired by OpenPGP; see RFC 2440</span>
<span class="cm">	 * packet tag 1 */</span>
	<span class="n">max_packet_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span>                         <span class="cm">/* Tag 1 identifier */</span>
			   <span class="o">+</span> <span class="mi">3</span>                       <span class="cm">/* Max Tag 1 packet size */</span>
			   <span class="o">+</span> <span class="mi">1</span>                       <span class="cm">/* Version */</span>
			   <span class="o">+</span> <span class="n">ECRYPTFS_SIG_SIZE</span>       <span class="cm">/* Key identifier */</span>
			   <span class="o">+</span> <span class="mi">1</span>                       <span class="cm">/* Cipher identifier */</span>
			   <span class="o">+</span> <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">);</span> <span class="cm">/* Encrypted key size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_packet_size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">*</span><span class="n">remaining_bytes</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Packet length larger than maximum allowable; &quot;</span>
		       <span class="s">&quot;need up to [%td] bytes, but there are only [%td] &quot;</span>
		       <span class="s">&quot;available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_packet_size</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">remaining_bytes</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ECRYPTFS_TAG_1_PACKET_TYPE</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_write_packet_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span>
					  <span class="p">(</span><span class="n">max_packet_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">packet_size_length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error generating tag 1 packet &quot;</span>
				<span class="s">&quot;header; cannot generate packet length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="n">packet_size_length</span><span class="p">;</span>
	<span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* version 3 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span> <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">,</span> <span class="n">ECRYPTFS_SIG_SIZE</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="n">ECRYPTFS_SIG_SIZE</span><span class="p">;</span>
	<span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">RFC2440_CIPHER_RSA</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span> <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key</span><span class="p">,</span>
	       <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="p">(</span><span class="o">*</span><span class="n">remaining_bytes</span><span class="p">)</span> <span class="o">-=</span> <span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * write_tag_11_packet</span>
<span class="cm"> * @dest: Target into which Tag 11 packet is to be written</span>
<span class="cm"> * @remaining_bytes: Maximum packet length</span>
<span class="cm"> * @contents: Byte array of contents to copy in</span>
<span class="cm"> * @contents_length: Number of bytes in contents</span>
<span class="cm"> * @packet_length: Length of the Tag 11 packet written; zero on error</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">write_tag_11_packet</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">remaining_bytes</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">contents</span><span class="p">,</span>
		    <span class="kt">size_t</span> <span class="n">contents_length</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">packet_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">packet_size_length</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">max_packet_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">packet_length</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* This format is inspired by OpenPGP; see RFC 2440</span>
<span class="cm">	 * packet tag 11 */</span>
	<span class="n">max_packet_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span>                   <span class="cm">/* Tag 11 identifier */</span>
			   <span class="o">+</span> <span class="mi">3</span>                 <span class="cm">/* Max Tag 11 packet size */</span>
			   <span class="o">+</span> <span class="mi">1</span>                 <span class="cm">/* Binary format specifier */</span>
			   <span class="o">+</span> <span class="mi">1</span>                 <span class="cm">/* Filename length */</span>
			   <span class="o">+</span> <span class="mi">8</span>                 <span class="cm">/* Filename (&quot;_CONSOLE&quot;) */</span>
			   <span class="o">+</span> <span class="mi">4</span>                 <span class="cm">/* Modification date */</span>
			   <span class="o">+</span> <span class="n">contents_length</span><span class="p">);</span> <span class="cm">/* Literal data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_packet_size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">*</span><span class="n">remaining_bytes</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Packet length larger than maximum allowable; &quot;</span>
		       <span class="s">&quot;need up to [%td] bytes, but there are only [%td] &quot;</span>
		       <span class="s">&quot;available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_packet_size</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">remaining_bytes</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_length</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ECRYPTFS_TAG_11_PACKET_TYPE</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_write_packet_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_length</span><span class="p">)],</span>
					  <span class="p">(</span><span class="n">max_packet_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">packet_size_length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error generating tag 11 packet header; cannot &quot;</span>
		       <span class="s">&quot;generate packet length. rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_length</span><span class="p">)</span> <span class="o">+=</span> <span class="n">packet_size_length</span><span class="p">;</span>
	<span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_length</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x62</span><span class="p">;</span> <span class="cm">/* binary data format specifier */</span>
	<span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_length</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_length</span><span class="p">)],</span> <span class="s">&quot;_CONSOLE&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_length</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_length</span><span class="p">)],</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_length</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_length</span><span class="p">)],</span> <span class="n">contents</span><span class="p">,</span> <span class="n">contents_length</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_length</span><span class="p">)</span> <span class="o">+=</span> <span class="n">contents_length</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">packet_length</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="p">(</span><span class="o">*</span><span class="n">remaining_bytes</span><span class="p">)</span> <span class="o">-=</span> <span class="p">(</span><span class="o">*</span><span class="n">packet_length</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * write_tag_3_packet</span>
<span class="cm"> * @dest: Buffer into which to write the packet</span>
<span class="cm"> * @remaining_bytes: Maximum number of bytes that can be written</span>
<span class="cm"> * @auth_tok: Authentication token</span>
<span class="cm"> * @crypt_stat: The cryptographic context</span>
<span class="cm"> * @key_rec: encrypted key</span>
<span class="cm"> * @packet_size: This function will write the number of bytes that end</span>
<span class="cm"> *               up constituting the packet; set to zero on error</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">write_tag_3_packet</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">remaining_bytes</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">*</span><span class="n">auth_tok</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ecryptfs_key_record</span> <span class="o">*</span><span class="n">key_rec</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">packet_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">encrypted_session_key_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">session_key_encryption_key</span><span class="p">[</span><span class="n">ECRYPTFS_MAX_KEY_BYTES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">dst_sg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">src_sg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="o">*</span><span class="n">tfm_mutex</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cipher_code</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">packet_size_length</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">max_packet_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_mount_crypt_stat</span> <span class="o">*</span><span class="n">mount_crypt_stat</span> <span class="o">=</span>
		<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">mount_crypt_stat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blkcipher_desc</span> <span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CRYPTO_TFM_REQ_MAY_SLEEP</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ecryptfs_from_hex</span><span class="p">(</span><span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">,</span> <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">signature</span><span class="p">,</span>
			  <span class="n">ECRYPTFS_SIG_SIZE</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_get_tfm_and_mutex_for_cipher_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">.</span><span class="n">tfm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tfm_mutex</span><span class="p">,</span>
							<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Internal error whilst attempting to get &quot;</span>
		       <span class="s">&quot;tfm and mutex for cipher name [%s]; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_cipher_key_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">blkcipher_alg</span> <span class="o">*</span><span class="n">alg</span> <span class="o">=</span> <span class="n">crypto_blkcipher_alg</span><span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="n">tfm</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;No key size specified at mount; &quot;</span>
		       <span class="s">&quot;defaulting to [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">alg</span><span class="o">-&gt;</span><span class="n">max_keysize</span><span class="p">);</span>
		<span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_cipher_key_size</span> <span class="o">=</span>
			<span class="n">alg</span><span class="o">-&gt;</span><span class="n">max_keysize</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span> <span class="o">=</span>
			<span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_default_cipher_key_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span> <span class="o">=</span>
			<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span> <span class="o">==</span> <span class="mi">24</span>
	    <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;aes&quot;</span><span class="p">,</span> <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">((</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+</span> <span class="mi">24</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span> <span class="o">=</span> <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">;</span>
	<span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span> <span class="o">=</span>
		<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span><span class="p">;</span>
	<span class="n">encrypted_session_key_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">encrypted_session_key_valid</span> <span class="o">|=</span>
			<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">encrypted_session_key_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;encrypted_session_key_valid != 0; &quot;</span>
				<span class="s">&quot;using auth_tok-&gt;session_key.encrypted_key, &quot;</span>
				<span class="s">&quot;where key_rec-&gt;enc_key_size = [%zd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key</span><span class="p">,</span>
		       <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">encrypted_key</span><span class="p">,</span>
		       <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">encrypted_session_key_set</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span>
	    <span class="n">ECRYPTFS_SESSION_KEY_ENCRYPTION_KEY_SET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;Using previously generated &quot;</span>
				<span class="s">&quot;session key encryption key of size [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span>
				<span class="n">session_key_encryption_key_bytes</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">session_key_encryption_key</span><span class="p">,</span>
		       <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">session_key_encryption_key</span><span class="p">,</span>
		       <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">);</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
				<span class="s">&quot;Cached session key encryption key:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecryptfs_verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ecryptfs_dump_hex</span><span class="p">(</span><span class="n">session_key_encryption_key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ecryptfs_verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;Session key encryption key:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ecryptfs_dump_hex</span><span class="p">(</span><span class="n">session_key_encryption_key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">virt_to_scatterlist</span><span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">,</span>
				 <span class="n">src_sg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error generating scatterlist &quot;</span>
				<span class="s">&quot;for crypt_stat session key; expected rc = 1; &quot;</span>
				<span class="s">&quot;got rc = [%d]. key_rec-&gt;enc_key_size = [%zd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rc</span><span class="p">,</span> <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">virt_to_scatterlist</span><span class="p">(</span><span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key</span><span class="p">,</span> <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">,</span>
				 <span class="n">dst_sg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error generating scatterlist &quot;</span>
				<span class="s">&quot;for crypt_stat encrypted session key; &quot;</span>
				<span class="s">&quot;expected rc = 1; got rc = [%d]. &quot;</span>
				<span class="s">&quot;key_rec-&gt;enc_key_size = [%zd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span>
				<span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">tfm_mutex</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_blkcipher_setkey</span><span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="n">tfm</span><span class="p">,</span> <span class="n">session_key_encryption_key</span><span class="p">,</span>
				     <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">tfm_mutex</span><span class="p">);</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error setting key for crypto &quot;</span>
				<span class="s">&quot;context; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;Encrypting [%zd] bytes of the key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_blkcipher_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="n">dst_sg</span><span class="p">,</span> <span class="n">src_sg</span><span class="p">,</span>
				      <span class="p">(</span><span class="o">*</span><span class="n">key_rec</span><span class="p">).</span><span class="n">enc_key_size</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">tfm_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error encrypting; rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;This should be the encrypted key:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecryptfs_verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;EFEK of size [%zd]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">);</span>
		<span class="n">ecryptfs_dump_hex</span><span class="p">(</span><span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key</span><span class="p">,</span>
				  <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">encrypted_session_key_set:</span>
	<span class="cm">/* This format is inspired by OpenPGP; see RFC 2440</span>
<span class="cm">	 * packet tag 3 */</span>
	<span class="n">max_packet_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span>                         <span class="cm">/* Tag 3 identifier */</span>
			   <span class="o">+</span> <span class="mi">3</span>                       <span class="cm">/* Max Tag 3 packet size */</span>
			   <span class="o">+</span> <span class="mi">1</span>                       <span class="cm">/* Version */</span>
			   <span class="o">+</span> <span class="mi">1</span>                       <span class="cm">/* Cipher code */</span>
			   <span class="o">+</span> <span class="mi">1</span>                       <span class="cm">/* S2K specifier */</span>
			   <span class="o">+</span> <span class="mi">1</span>                       <span class="cm">/* Hash identifier */</span>
			   <span class="o">+</span> <span class="n">ECRYPTFS_SALT_SIZE</span>      <span class="cm">/* Salt */</span>
			   <span class="o">+</span> <span class="mi">1</span>                       <span class="cm">/* Hash iterations */</span>
			   <span class="o">+</span> <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">);</span> <span class="cm">/* Encrypted key size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_packet_size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">*</span><span class="n">remaining_bytes</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Packet too large; need up to [%td] bytes, but &quot;</span>
		       <span class="s">&quot;there are only [%td] available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_packet_size</span><span class="p">,</span>
		       <span class="p">(</span><span class="o">*</span><span class="n">remaining_bytes</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ECRYPTFS_TAG_3_PACKET_TYPE</span><span class="p">;</span>
	<span class="cm">/* Chop off the Tag 3 identifier(1) and Tag 3 packet size(3)</span>
<span class="cm">	 * to get the number of octets in the actual Tag 3 packet */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_write_packet_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span>
					  <span class="p">(</span><span class="n">max_packet_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">packet_size_length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error generating tag 3 packet header; cannot &quot;</span>
		       <span class="s">&quot;generate packet length. rc = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="n">packet_size_length</span><span class="p">;</span>
	<span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* version 4 */</span>
	<span class="cm">/* TODO: Break from RFC2440 so that arbitrary ciphers can be</span>
<span class="cm">	 * specified with strings */</span>
	<span class="n">cipher_code</span> <span class="o">=</span> <span class="n">ecryptfs_code_for_cipher_string</span><span class="p">(</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span>
						      <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cipher_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Unable to generate code for &quot;</span>
				<span class="s">&quot;cipher [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cipher_code</span><span class="p">;</span>
	<span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>	<span class="cm">/* S2K */</span>
	<span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* MD5 (TODO: parameterize) */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span> <span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">password</span><span class="p">.</span><span class="n">salt</span><span class="p">,</span>
	       <span class="n">ECRYPTFS_SALT_SIZE</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="n">ECRYPTFS_SALT_SIZE</span><span class="p">;</span>	<span class="cm">/* salt */</span>
	<span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>	<span class="cm">/* hash iterations (65536) */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">[(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)],</span> <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key</span><span class="p">,</span>
	       <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">+=</span> <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">enc_key_size</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="p">(</span><span class="o">*</span><span class="n">remaining_bytes</span><span class="p">)</span> <span class="o">-=</span> <span class="p">(</span><span class="o">*</span><span class="n">packet_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">ecryptfs_key_record_cache</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * ecryptfs_generate_key_packet_set</span>
<span class="cm"> * @dest_base: Virtual address from which to write the key record set</span>
<span class="cm"> * @crypt_stat: The cryptographic context from which the</span>
<span class="cm"> *              authentication tokens will be retrieved</span>
<span class="cm"> * @ecryptfs_dentry: The dentry, used to retrieve the mount crypt stat</span>
<span class="cm"> *                   for the global parameters</span>
<span class="cm"> * @len: The amount written</span>
<span class="cm"> * @max: The maximum amount of data allowed to be written</span>
<span class="cm"> *</span>
<span class="cm"> * Generates a key packet set and writes it to the virtual address</span>
<span class="cm"> * passed in.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success; non-zero on error.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ecryptfs_generate_key_packet_set</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dest_base</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ecryptfs_dentry</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">len</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ecryptfs_auth_tok</span> <span class="o">*</span><span class="n">auth_tok</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">auth_tok_key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_mount_crypt_stat</span> <span class="o">*</span><span class="n">mount_crypt_stat</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">ecryptfs_superblock_to_private</span><span class="p">(</span>
			<span class="n">ecryptfs_dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mount_crypt_stat</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">written</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_key_record</span> <span class="o">*</span><span class="n">key_rec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ecryptfs_key_sig</span> <span class="o">*</span><span class="n">key_sig</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">keysig_list_mutex</span><span class="p">);</span>
	<span class="n">key_rec</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">ecryptfs_key_record_cache</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key_rec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">key_sig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">keysig_list</span><span class="p">,</span>
			    <span class="n">crypt_stat_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">key_rec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">key_rec</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ecryptfs_find_global_auth_tok_for_sig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">auth_tok_key</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">auth_tok</span><span class="p">,</span>
							   <span class="n">mount_crypt_stat</span><span class="p">,</span>
							   <span class="n">key_sig</span><span class="o">-&gt;</span><span class="n">keysig</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unable to retrieve auth tok with &quot;</span>
			       <span class="s">&quot;sig = [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_sig</span><span class="o">-&gt;</span><span class="n">keysig</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">process_find_global_auth_tok_for_sig_err</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token_type</span> <span class="o">==</span> <span class="n">ECRYPTFS_PASSWORD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">write_tag_3_packet</span><span class="p">((</span><span class="n">dest_base</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">)),</span>
						<span class="o">&amp;</span><span class="n">max</span><span class="p">,</span> <span class="n">auth_tok</span><span class="p">,</span>
						<span class="n">crypt_stat</span><span class="p">,</span> <span class="n">key_rec</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">written</span><span class="p">);</span>
			<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">));</span>
			<span class="n">key_put</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Error &quot;</span>
						<span class="s">&quot;writing tag 3 packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">)</span> <span class="o">+=</span> <span class="n">written</span><span class="p">;</span>
			<span class="cm">/* Write auth tok signature packet */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">write_tag_11_packet</span><span class="p">((</span><span class="n">dest_base</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">,</span>
						 <span class="n">key_rec</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">,</span>
						 <span class="n">ECRYPTFS_SIG_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">written</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error writing &quot;</span>
						<span class="s">&quot;auth tok signature packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">)</span> <span class="o">+=</span> <span class="n">written</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">auth_tok</span><span class="o">-&gt;</span><span class="n">token_type</span> <span class="o">==</span> <span class="n">ECRYPTFS_PRIVATE_KEY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">write_tag_1_packet</span><span class="p">(</span><span class="n">dest_base</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">,</span>
						<span class="n">auth_tok_key</span><span class="p">,</span> <span class="n">auth_tok</span><span class="p">,</span>
						<span class="n">crypt_stat</span><span class="p">,</span> <span class="n">key_rec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">written</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Error &quot;</span>
						<span class="s">&quot;writing tag 1 packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">)</span> <span class="o">+=</span> <span class="n">written</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">));</span>
			<span class="n">key_put</span><span class="p">(</span><span class="n">auth_tok_key</span><span class="p">);</span>
			<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Unsupported &quot;</span>
					<span class="s">&quot;authentication token type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dest_base</span><span class="p">[(</span><span class="o">*</span><span class="n">len</span><span class="p">)]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ecryptfs_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error writing boundary byte</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out_free:</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ecryptfs_key_record_cache</span><span class="p">,</span> <span class="n">key_rec</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">keysig_list_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">ecryptfs_key_sig_cache</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">ecryptfs_add_keysig</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecryptfs_crypt_stat</span> <span class="o">*</span><span class="n">crypt_stat</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ecryptfs_key_sig</span> <span class="o">*</span><span class="n">new_key_sig</span><span class="p">;</span>

	<span class="n">new_key_sig</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">ecryptfs_key_sig_cache</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_key_sig</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;Error allocating from ecryptfs_key_sig_cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">new_key_sig</span><span class="o">-&gt;</span><span class="n">keysig</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">ECRYPTFS_SIG_SIZE_HEX</span><span class="p">);</span>
	<span class="n">new_key_sig</span><span class="o">-&gt;</span><span class="n">keysig</span><span class="p">[</span><span class="n">ECRYPTFS_SIG_SIZE_HEX</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="cm">/* Caller must hold keysig_list_mutex */</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_key_sig</span><span class="o">-&gt;</span><span class="n">crypt_stat_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crypt_stat</span><span class="o">-&gt;</span><span class="n">keysig_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">ecryptfs_global_auth_tok_cache</span><span class="p">;</span>

<span class="kt">int</span>
<span class="nf">ecryptfs_add_global_auth_tok</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecryptfs_mount_crypt_stat</span> <span class="o">*</span><span class="n">mount_crypt_stat</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">sig</span><span class="p">,</span> <span class="n">u32</span> <span class="n">global_auth_tok_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ecryptfs_global_auth_tok</span> <span class="o">*</span><span class="n">new_auth_tok</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">new_auth_tok</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">ecryptfs_global_auth_tok_cache</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_auth_tok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error allocating from &quot;</span>
		       <span class="s">&quot;ecryptfs_global_auth_tok_cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">new_auth_tok</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">ECRYPTFS_SIG_SIZE_HEX</span><span class="p">);</span>
	<span class="n">new_auth_tok</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">global_auth_tok_flags</span><span class="p">;</span>
	<span class="n">new_auth_tok</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="n">ECRYPTFS_SIG_SIZE_HEX</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_auth_tok_list_mutex</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_auth_tok</span><span class="o">-&gt;</span><span class="n">mount_crypt_stat_list</span><span class="p">,</span>
		 <span class="o">&amp;</span><span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_auth_tok_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mount_crypt_stat</span><span class="o">-&gt;</span><span class="n">global_auth_tok_list_mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
