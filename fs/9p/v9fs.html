<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › 9p › v9fs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>v9fs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/fs/9p/v9fs.c</span>
<span class="cm"> *</span>
<span class="cm"> *  This file contains functions assisting in mapping VFS to 9P2000</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2004-2008 by Eric Van Hensbergen &lt;ericvh@gmail.com&gt;</span>
<span class="cm"> *  Copyright (C) 2002 by Ron Minnich &lt;rminnich@lanl.gov&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License version 2</span>
<span class="cm"> *  as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to:</span>
<span class="cm"> *  Free Software Foundation</span>
<span class="cm"> *  51 Franklin Street, Fifth Floor</span>
<span class="cm"> *  Boston, MA  02111-1301  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/parser.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/9p/9p.h&gt;</span>
<span class="cp">#include &lt;net/9p/client.h&gt;</span>
<span class="cp">#include &lt;net/9p/transport.h&gt;</span>
<span class="cp">#include &quot;v9fs.h&quot;</span>
<span class="cp">#include &quot;v9fs_vfs.h&quot;</span>
<span class="cp">#include &quot;cache.h&quot;</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">v9fs_sessionlist_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">v9fs_sessionlist</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">v9fs_inode_cache</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Option Parsing (code inspired by NFS code)</span>
<span class="cm"> *  NOTE: each transport will parse its own options</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/* Options that take integer arguments */</span>
	<span class="n">Opt_debug</span><span class="p">,</span> <span class="n">Opt_dfltuid</span><span class="p">,</span> <span class="n">Opt_dfltgid</span><span class="p">,</span> <span class="n">Opt_afid</span><span class="p">,</span>
	<span class="cm">/* String options */</span>
	<span class="n">Opt_uname</span><span class="p">,</span> <span class="n">Opt_remotename</span><span class="p">,</span> <span class="n">Opt_trans</span><span class="p">,</span> <span class="n">Opt_cache</span><span class="p">,</span> <span class="n">Opt_cachetag</span><span class="p">,</span>
	<span class="cm">/* Options that take no arguments */</span>
	<span class="n">Opt_nodevmap</span><span class="p">,</span>
	<span class="cm">/* Cache options */</span>
	<span class="n">Opt_cache_loose</span><span class="p">,</span> <span class="n">Opt_fscache</span><span class="p">,</span>
	<span class="cm">/* Access options */</span>
	<span class="n">Opt_access</span><span class="p">,</span> <span class="n">Opt_posixacl</span><span class="p">,</span>
	<span class="cm">/* Error token */</span>
	<span class="n">Opt_err</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">Opt_debug</span><span class="p">,</span> <span class="s">&quot;debug=%x&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_dfltuid</span><span class="p">,</span> <span class="s">&quot;dfltuid=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_dfltgid</span><span class="p">,</span> <span class="s">&quot;dfltgid=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_afid</span><span class="p">,</span> <span class="s">&quot;afid=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_uname</span><span class="p">,</span> <span class="s">&quot;uname=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_remotename</span><span class="p">,</span> <span class="s">&quot;aname=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nodevmap</span><span class="p">,</span> <span class="s">&quot;nodevmap&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_cache</span><span class="p">,</span> <span class="s">&quot;cache=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_cache_loose</span><span class="p">,</span> <span class="s">&quot;loose&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_fscache</span><span class="p">,</span> <span class="s">&quot;fscache&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_cachetag</span><span class="p">,</span> <span class="s">&quot;cachetag=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_access</span><span class="p">,</span> <span class="s">&quot;access=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_posixacl</span><span class="p">,</span> <span class="s">&quot;posixacl&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Interpret mount options for cache mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_cache_mode</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">version</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;loose&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">version</span> <span class="o">=</span> <span class="n">CACHE_LOOSE</span><span class="p">;</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;Cache mode: loose</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;fscache&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">version</span> <span class="o">=</span> <span class="n">CACHE_FSCACHE</span><span class="p">;</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;Cache mode: fscache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">version</span> <span class="o">=</span> <span class="n">CACHE_NONE</span><span class="p">;</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;Cache mode: none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unknown Cache mode %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">version</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * v9fs_parse_options - parse mount options into session structure</span>
<span class="cm"> * @v9ses: existing v9fs session information</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 upon success, -ERRNO upon failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">v9fs_parse_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">v9fs_session_info</span> <span class="o">*</span><span class="n">v9ses</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">opts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_options</span><span class="p">;</span>
	<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">option</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* setup defaults */</span>
	<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">afid</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">cache</span> <span class="o">=</span> <span class="n">CACHE_NONE</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_9P_FSCACHE</span>
	<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">cachetag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opts</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tmp_options</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_options</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_option_alloc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">options</span> <span class="o">=</span> <span class="n">tmp_options</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">token</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">p</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">Opt_debug</span>:
			<span class="n">r</span> <span class="o">=</span> <span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span>
					 <span class="s">&quot;integer field, but no integer?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_NET_9P_DEBUG</span>
			<span class="n">p9_debug_level</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">Opt_dfltuid</span>:
			<span class="n">r</span> <span class="o">=</span> <span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span>
					 <span class="s">&quot;integer field, but no integer?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">dfltuid</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_dfltgid</span>:
			<span class="n">r</span> <span class="o">=</span> <span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span>
					 <span class="s">&quot;integer field, but no integer?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">dfltgid</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_afid</span>:
			<span class="n">r</span> <span class="o">=</span> <span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span>
					 <span class="s">&quot;integer field, but no integer?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">afid</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_uname</span>:
			<span class="n">match_strlcpy</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">uname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PATH_MAX</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_remotename</span>:
			<span class="n">match_strlcpy</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">aname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PATH_MAX</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nodevmap</span>:
			<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">nodev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_cache_loose</span>:
			<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">cache</span> <span class="o">=</span> <span class="n">CACHE_LOOSE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_fscache</span>:
			<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">cache</span> <span class="o">=</span> <span class="n">CACHE_FSCACHE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_cachetag</span>:
<span class="cp">#ifdef CONFIG_9P_FSCACHE</span>
			<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">cachetag</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_cache</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span>
					 <span class="s">&quot;problem allocating copy of cache arg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">free_and_return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_cache_mode</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">free_and_return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">cache</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">Opt_access</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span>
					 <span class="s">&quot;problem allocating copy of access arg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">free_and_return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V9FS_ACCESS_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;user&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V9FS_ACCESS_USER</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;any&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V9FS_ACCESS_ANY</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;client&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V9FS_ACCESS_CLIENT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V9FS_ACCESS_SINGLE</span><span class="p">;</span>
				<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unknown access argument %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">s</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">free_and_return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">Opt_posixacl</span>:
<span class="cp">#ifdef CONFIG_9P_FS_POSIX_ACL</span>
			<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V9FS_POSIX_ACL</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span>
				 <span class="s">&quot;Not defined CONFIG_9P_FS_POSIX_ACL. Ignoring posixacl option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">free_and_return:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tmp_options</span><span class="p">);</span>
<span class="nl">fail_option_alloc:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * v9fs_session_init - initialize session</span>
<span class="cm"> * @v9ses: session information structure</span>
<span class="cm"> * @dev_name: device being mounted</span>
<span class="cm"> * @data: options</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="nf">v9fs_session_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">v9fs_session_info</span> <span class="o">*</span><span class="n">v9ses</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">uname</span> <span class="o">=</span> <span class="n">__getname</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">uname</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">aname</span> <span class="o">=</span> <span class="n">__getname</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">aname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__putname</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">uname</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">rename_sem</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bdi_setup_and_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="p">,</span> <span class="s">&quot;9p&quot;</span><span class="p">,</span> <span class="n">BDI_CAP_MAP_COPY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__putname</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">aname</span><span class="p">);</span>
		<span class="n">__putname</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">uname</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9fs_sessionlist_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">slist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v9fs_sessionlist</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9fs_sessionlist_lock</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">uname</span><span class="p">,</span> <span class="n">V9FS_DEFUSER</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">aname</span><span class="p">,</span> <span class="n">V9FS_DEFANAME</span><span class="p">);</span>
	<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">dfltuid</span> <span class="o">=</span> <span class="n">V9FS_DEFUID</span><span class="p">;</span>
	<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">dfltgid</span> <span class="o">=</span> <span class="n">V9FS_DEFGID</span><span class="p">;</span>

	<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">clnt</span> <span class="o">=</span> <span class="n">p9_client_create</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">);</span>
		<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">clnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;problem initializing 9p client</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V9FS_ACCESS_USER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p9_is_proto_dotl</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V9FS_ACCESS_CLIENT</span><span class="p">;</span>
		<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V9FS_PROTO_2000L</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p9_is_proto_dotu</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V9FS_PROTO_2000U</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">v9fs_parse_options</span><span class="p">(</span><span class="n">v9ses</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">msize</span> <span class="o">-</span> <span class="n">P9_IOHDRSZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v9fs_proto_dotl</span><span class="p">(</span><span class="n">v9ses</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V9FS_ACCESS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">V9FS_ACCESS_CLIENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We support ACCESS_CLIENT only for dotl.</span>
<span class="cm">		 * Fall back to ACCESS_USER</span>
<span class="cm">		 */</span>
		<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V9FS_ACCESS_MASK</span><span class="p">;</span>
		<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V9FS_ACCESS_USER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*FIXME !! */</span>
	<span class="cm">/* for legacy mode, fall back to V9FS_ACCESS_ANY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">v9fs_proto_dotu</span><span class="p">(</span><span class="n">v9ses</span><span class="p">)</span> <span class="o">||</span> <span class="n">v9fs_proto_dotl</span><span class="p">(</span><span class="n">v9ses</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">&amp;</span><span class="n">V9FS_ACCESS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">V9FS_ACCESS_USER</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V9FS_ACCESS_MASK</span><span class="p">;</span>
		<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V9FS_ACCESS_ANY</span><span class="p">;</span>
		<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v9fs_proto_dotl</span><span class="p">(</span><span class="n">v9ses</span><span class="p">)</span> <span class="o">||</span>
		<span class="o">!</span><span class="p">((</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V9FS_ACCESS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">V9FS_ACCESS_CLIENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We support ACL checks on clinet only if the protocol is</span>
<span class="cm">		 * 9P2000.L and access is V9FS_ACCESS_CLIENT.</span>
<span class="cm">		 */</span>
		<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V9FS_ACL_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fid</span> <span class="o">=</span> <span class="n">p9_client_attach</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">uname</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span>
							<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">aname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
		<span class="n">fid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;cannot attach</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V9FS_ACCESS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">V9FS_ACCESS_SINGLE</span><span class="p">)</span>
		<span class="n">fid</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fid</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_9P_FSCACHE</span>
	<span class="cm">/* register the session for caching */</span>
	<span class="n">v9fs_cache_session_get_cookie</span><span class="p">(</span><span class="n">v9ses</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">fid</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">bdi_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * v9fs_session_close - shutdown a session</span>
<span class="cm"> * @v9ses: session information structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">v9fs_session_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">v9fs_session_info</span> <span class="o">*</span><span class="n">v9ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p9_client_destroy</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">);</span>
		<span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">clnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_9P_FSCACHE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v9fs_cache_session_put_cookie</span><span class="p">(</span><span class="n">v9ses</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">cachetag</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">__putname</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">uname</span><span class="p">);</span>
	<span class="n">__putname</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">aname</span><span class="p">);</span>

	<span class="n">bdi_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9fs_sessionlist_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">slist</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9fs_sessionlist_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * v9fs_session_cancel - terminate a session</span>
<span class="cm"> * @v9ses: session to terminate</span>
<span class="cm"> *</span>
<span class="cm"> * mark transport as disconnected and cancel all pending requests.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">v9fs_session_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">v9fs_session_info</span> <span class="o">*</span><span class="n">v9ses</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;cancel session %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">v9ses</span><span class="p">);</span>
	<span class="n">p9_client_disconnect</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * v9fs_session_begin_cancel - Begin terminate of a session</span>
<span class="cm"> * @v9ses: session to terminate</span>
<span class="cm"> *</span>
<span class="cm"> * After this call we don&#39;t allow any request other than clunk.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">v9fs_session_begin_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">v9fs_session_info</span> <span class="o">*</span><span class="n">v9ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;begin cancel session %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">v9ses</span><span class="p">);</span>
	<span class="n">p9_client_begin_disconnect</span><span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">v9fs_error_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">v9fs_kobj</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_9P_FSCACHE</span>
<span class="cm">/**</span>
<span class="cm"> * caches_show - list caches associated with a session</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the size of buffer written.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">caches_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v9fs_session_info</span> <span class="o">*</span><span class="n">v9ses</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9fs_sessionlist_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">v9ses</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v9fs_sessionlist</span><span class="p">,</span> <span class="n">slist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">cachetag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">v9ses</span><span class="o">-&gt;</span><span class="n">cachetag</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">count</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">limit</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9fs_sessionlist_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="n">v9fs_attr_cache</span> <span class="o">=</span> <span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">caches</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_9P_FSCACHE */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">v9fs_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_9P_FSCACHE</span>
	<span class="o">&amp;</span><span class="n">v9fs_attr_cache</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">v9fs_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">v9fs_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * v9fs_sysfs_init - Initialize the v9fs sysfs interface</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">v9fs_sysfs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v9fs_kobj</span> <span class="o">=</span> <span class="n">kobject_create_and_add</span><span class="p">(</span><span class="s">&quot;9p&quot;</span><span class="p">,</span> <span class="n">fs_kobj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v9fs_kobj</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_create_group</span><span class="p">(</span><span class="n">v9fs_kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v9fs_attr_group</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kobject_put</span><span class="p">(</span><span class="n">v9fs_kobj</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * v9fs_sysfs_cleanup - Unregister the v9fs sysfs interface</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">v9fs_sysfs_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="n">v9fs_kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v9fs_attr_group</span><span class="p">);</span>
	<span class="n">kobject_put</span><span class="p">(</span><span class="n">v9fs_kobj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">v9fs_inode_init_once</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">foo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v9fs_inode</span> <span class="o">*</span><span class="n">v9inode</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">v9fs_inode</span> <span class="o">*</span><span class="p">)</span><span class="n">foo</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_9P_FSCACHE</span>
	<span class="n">v9inode</span><span class="o">-&gt;</span><span class="n">fscache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9inode</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v9inode</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">));</span>
	<span class="n">inode_init_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9inode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * v9fs_init_inode_cache - initialize a cache for 9P</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">v9fs_init_inode_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v9fs_inode_cache</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;v9fs_inode_cache&quot;</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v9fs_inode</span><span class="p">),</span>
					  <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">SLAB_RECLAIM_ACCOUNT</span><span class="o">|</span>
					      <span class="n">SLAB_MEM_SPREAD</span><span class="p">),</span>
					  <span class="n">v9fs_inode_init_once</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v9fs_inode_cache</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * v9fs_destroy_inode_cache - destroy the cache of 9P inode</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">v9fs_destroy_inode_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">v9fs_inode_cache</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">v9fs_cache_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v9fs_init_inode_cache</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_9P_FSCACHE</span>
	<span class="k">return</span> <span class="n">fscache_register_netfs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9fs_cache_netfs</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">v9fs_cache_unregister</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v9fs_destroy_inode_cache</span><span class="p">();</span>
<span class="cp">#ifdef CONFIG_9P_FSCACHE</span>
	<span class="n">fscache_unregister_netfs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9fs_cache_netfs</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * init_v9fs - Initialize module</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_v9fs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Installing v9fs 9p2000 file system support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* TODO: Setup list of registered trasnport modules */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">v9fs_cache_register</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to register v9fs for caching</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">v9fs_sysfs_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to register with sysfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_cache</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9fs_fs_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to register filesystem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_sysfs_cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_sysfs_cleanup:</span>
	<span class="n">v9fs_sysfs_cleanup</span><span class="p">();</span>

<span class="nl">out_cache:</span>
	<span class="n">v9fs_cache_unregister</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * exit_v9fs - shutdown module</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_v9fs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v9fs_sysfs_cleanup</span><span class="p">();</span>
	<span class="n">v9fs_cache_unregister</span><span class="p">();</span>
	<span class="n">unregister_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9fs_fs_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_v9fs</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_v9fs</span><span class="p">)</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Latchesar Ionkov &lt;lucho@ionkov.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Eric Van Hensbergen &lt;ericvh@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ron Minnich &lt;rminnich@lanl.gov&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
