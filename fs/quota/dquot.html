<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › quota › dquot.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dquot.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Implementation of the diskquota system for the LINUX operating system. QUOTA</span>
<span class="cm"> * is implemented using the BSD system call interface as the means of</span>
<span class="cm"> * communication with the user level. This file contains the generic routines</span>
<span class="cm"> * called by the different filesystems on allocation of an inode or block.</span>
<span class="cm"> * These routines take care of the administration needed to have a consistent</span>
<span class="cm"> * diskquota tracking system. The ideas of both user and group quotas are based</span>
<span class="cm"> * on the Melbourne quota system as used on BSD derived systems. The internal</span>
<span class="cm"> * implementation is based on one of the several variants of the LINUX</span>
<span class="cm"> * inode-subsystem with added complexity of the diskquota system.</span>
<span class="cm"> * </span>
<span class="cm"> * Author:	Marco van Wieringen &lt;mvw@planets.elm.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Fixes:   Dmitry Gorodchanin &lt;pgmdsg@ibi.com&gt;, 11 Feb 96</span>
<span class="cm"> *</span>
<span class="cm"> *		Revised list management to avoid races</span>
<span class="cm"> *		-- Bill Hawes, &lt;whawes@star.net&gt;, 9/98</span>
<span class="cm"> *</span>
<span class="cm"> *		Fixed races in dquot_transfer(), dqget() and dquot_alloc_...().</span>
<span class="cm"> *		As the consequence the locking was moved from dquot_decr_...(),</span>
<span class="cm"> *		dquot_incr_...() to calling functions.</span>
<span class="cm"> *		invalidate_dquots() now writes modified dquots.</span>
<span class="cm"> *		Serialized quota_off() and quota_on() for mount point.</span>
<span class="cm"> *		Fixed a few bugs in grow_dquots().</span>
<span class="cm"> *		Fixed deadlock in write_dquot() - we no longer account quotas on</span>
<span class="cm"> *		quota files</span>
<span class="cm"> *		remove_dquot_ref() moved to inode.c - it now traverses through inodes</span>
<span class="cm"> *		add_dquot_ref() restarts after blocking</span>
<span class="cm"> *		Added check for bogus uid and fixed check for group in quotactl.</span>
<span class="cm"> *		Jan Kara, &lt;jack@suse.cz&gt;, sponsored by SuSE CR, 10-11/99</span>
<span class="cm"> *</span>
<span class="cm"> *		Used struct list_head instead of own list struct</span>
<span class="cm"> *		Invalidation of referenced dquots is no longer possible</span>
<span class="cm"> *		Improved free_dquots list management</span>
<span class="cm"> *		Quota and i_blocks are now updated in one place to avoid races</span>
<span class="cm"> *		Warnings are now delayed so we won&#39;t block in critical section</span>
<span class="cm"> *		Write updated not to require dquot lock</span>
<span class="cm"> *		Jan Kara, &lt;jack@suse.cz&gt;, 9/2000</span>
<span class="cm"> *</span>
<span class="cm"> *		Added dynamic quota structure allocation</span>
<span class="cm"> *		Jan Kara &lt;jack@suse.cz&gt; 12/2000</span>
<span class="cm"> *</span>
<span class="cm"> *		Rewritten quota interface. Implemented new quota format and</span>
<span class="cm"> *		formats registering.</span>
<span class="cm"> *		Jan Kara, &lt;jack@suse.cz&gt;, 2001,2002</span>
<span class="cm"> *</span>
<span class="cm"> *		New SMP locking.</span>
<span class="cm"> *		Jan Kara, &lt;jack@suse.cz&gt;, 10/2002</span>
<span class="cm"> *</span>
<span class="cm"> *		Added journalled quota support, fix lock inversion problems</span>
<span class="cm"> *		Jan Kara, &lt;jack@suse.cz&gt;, 2003,2004</span>
<span class="cm"> *</span>
<span class="cm"> * (C) Copyright 1994 - 1997 Marco van Wieringen </span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sysctl.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/security.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/quotaops.h&gt;</span>
<span class="cp">#include &quot;../internal.h&quot; </span><span class="cm">/* ugh */</span><span class="cp"></span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * There are three quota SMP locks. dq_list_lock protects all lists with quotas</span>
<span class="cm"> * and quota formats.</span>
<span class="cm"> * dq_data_lock protects data from dq_dqb and also mem_dqinfo structures and</span>
<span class="cm"> * also guards consistency of dquot-&gt;dq_dqb with inode-&gt;i_blocks, i_bytes.</span>
<span class="cm"> * i_blocks and i_bytes updates itself are guarded by i_lock acquired directly</span>
<span class="cm"> * in inode_add_bytes() and inode_sub_bytes(). dq_state_lock protects</span>
<span class="cm"> * modifications of quota state (on quotaon and quotaoff) and readers who care</span>
<span class="cm"> * about latest values take it as well.</span>
<span class="cm"> *</span>
<span class="cm"> * The spinlock ordering is hence: dq_data_lock &gt; dq_list_lock &gt; i_lock,</span>
<span class="cm"> *   dq_list_lock &gt; dq_state_lock</span>
<span class="cm"> *</span>
<span class="cm"> * Note that some things (eg. sb pointer, type, id) doesn&#39;t change during</span>
<span class="cm"> * the life of the dquot structure and so needn&#39;t to be protected by a lock</span>
<span class="cm"> *</span>
<span class="cm"> * Any operation working on dquots via inode pointers must hold dqptr_sem.  If</span>
<span class="cm"> * operation is just reading pointers from inode (or not using them at all) the</span>
<span class="cm"> * read lock is enough. If pointers are altered function must hold write lock.</span>
<span class="cm"> * Special care needs to be taken about S_NOQUOTA inode flag (marking that</span>
<span class="cm"> * inode is a quota file). Functions adding pointers from inode to dquots have</span>
<span class="cm"> * to check this flag under dqptr_sem and then (if S_NOQUOTA is not set) they</span>
<span class="cm"> * have to do all pointer modifications before dropping dqptr_sem. This makes</span>
<span class="cm"> * sure they cannot race with quotaon which first sets S_NOQUOTA flag and</span>
<span class="cm"> * then drops all pointers to dquots from an inode.</span>
<span class="cm"> *</span>
<span class="cm"> * Each dquot has its dq_lock mutex. Locked dquots might not be referenced</span>
<span class="cm"> * from inodes (dquot_alloc_space() and such don&#39;t check the dq_lock).</span>
<span class="cm"> * Currently dquot is locked only when it is being read to memory (or space for</span>
<span class="cm"> * it is being allocated) on the first dqget() and when it is being released on</span>
<span class="cm"> * the last dqput(). The allocation and release oparations are serialized by</span>
<span class="cm"> * the dq_lock and by checking the use count in dquot_release().  Write</span>
<span class="cm"> * operations on dquots don&#39;t hold dq_lock as they copy data under dq_data_lock</span>
<span class="cm"> * spinlock to internal buffers before writing.</span>
<span class="cm"> *</span>
<span class="cm"> * Lock ordering (including related VFS locks) is the following:</span>
<span class="cm"> *   dqonoff_mutex &gt; i_mutex &gt; journal_lock &gt; dqptr_sem &gt; dquot-&gt;dq_lock &gt;</span>
<span class="cm"> *   dqio_mutex</span>
<span class="cm"> * dqonoff_mutex &gt; i_mutex comes from dquot_quota_sync, dquot_enable, etc.</span>
<span class="cm"> * The lock ordering of dqptr_sem imposed by quota code is only dqonoff_sem &gt;</span>
<span class="cm"> * dqptr_sem. But filesystem has to count with the fact that functions such as</span>
<span class="cm"> * dquot_alloc_space() acquire dqptr_sem and they usually have to be called</span>
<span class="cm"> * from inside a transaction to keep filesystem consistency after a crash. Also</span>
<span class="cm"> * filesystems usually want to do some IO on dquot from -&gt;mark_dirty which is</span>
<span class="cm"> * called with dqptr_sem held.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">__cacheline_aligned_in_smp</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">dq_list_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">__cacheline_aligned_in_smp</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">dq_state_lock</span><span class="p">);</span>
<span class="n">__cacheline_aligned_in_smp</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">dq_data_lock</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dq_data_lock</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">__quota_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span> <span class="p">{</span>
		<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>

		<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

		<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
		<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Quota error (device %s): %s: %pV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

		<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__quota_error</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_QUOTA_DEBUG) || defined(CONFIG_PRINT_QUOTA_WARNING)</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">quotatypes</span><span class="p">[]</span> <span class="o">=</span> <span class="n">INITQFNAMES</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">quota_format_type</span> <span class="o">*</span><span class="n">quota_formats</span><span class="p">;</span>	<span class="cm">/* List of registered formats */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">quota_module_name</span> <span class="n">module_names</span><span class="p">[]</span> <span class="o">=</span> <span class="n">INIT_QUOTA_MODULE_NAMES</span><span class="p">;</span>

<span class="cm">/* SLAB cache for dquot structures */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">dquot_cachep</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">register_quota_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">quota_format_type</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">qf_next</span> <span class="o">=</span> <span class="n">quota_formats</span><span class="p">;</span>
	<span class="n">quota_formats</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">register_quota_format</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">unregister_quota_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">quota_format_type</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">quota_format_type</span> <span class="o">**</span><span class="n">actqf</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">actqf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quota_formats</span><span class="p">;</span> <span class="o">*</span><span class="n">actqf</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">actqf</span> <span class="o">!=</span> <span class="n">fmt</span><span class="p">;</span>
	     <span class="n">actqf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">actqf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">qf_next</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">actqf</span><span class="p">)</span>
		<span class="o">*</span><span class="n">actqf</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">actqf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">qf_next</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unregister_quota_format</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">quota_format_type</span> <span class="o">*</span><span class="nf">find_quota_format</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">quota_format_type</span> <span class="o">*</span><span class="n">actqf</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">actqf</span> <span class="o">=</span> <span class="n">quota_formats</span><span class="p">;</span> <span class="n">actqf</span> <span class="o">&amp;&amp;</span> <span class="n">actqf</span><span class="o">-&gt;</span><span class="n">qf_fmt_id</span> <span class="o">!=</span> <span class="n">id</span><span class="p">;</span>
	     <span class="n">actqf</span> <span class="o">=</span> <span class="n">actqf</span><span class="o">-&gt;</span><span class="n">qf_next</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">actqf</span> <span class="o">||</span> <span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">actqf</span><span class="o">-&gt;</span><span class="n">qf_owner</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">qm</span><span class="p">;</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		
		<span class="k">for</span> <span class="p">(</span><span class="n">qm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">module_names</span><span class="p">[</span><span class="n">qm</span><span class="p">].</span><span class="n">qm_fmt_id</span> <span class="o">&amp;&amp;</span>
			     <span class="n">module_names</span><span class="p">[</span><span class="n">qm</span><span class="p">].</span><span class="n">qm_fmt_id</span> <span class="o">!=</span> <span class="n">id</span><span class="p">;</span> <span class="n">qm</span><span class="o">++</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">module_names</span><span class="p">[</span><span class="n">qm</span><span class="p">].</span><span class="n">qm_fmt_id</span> <span class="o">||</span>
		    <span class="n">request_module</span><span class="p">(</span><span class="n">module_names</span><span class="p">[</span><span class="n">qm</span><span class="p">].</span><span class="n">qm_mod_name</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">actqf</span> <span class="o">=</span> <span class="n">quota_formats</span><span class="p">;</span> <span class="n">actqf</span> <span class="o">&amp;&amp;</span> <span class="n">actqf</span><span class="o">-&gt;</span><span class="n">qf_fmt_id</span> <span class="o">!=</span> <span class="n">id</span><span class="p">;</span>
		     <span class="n">actqf</span> <span class="o">=</span> <span class="n">actqf</span><span class="o">-&gt;</span><span class="n">qf_next</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">actqf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">actqf</span><span class="o">-&gt;</span><span class="n">qf_owner</span><span class="p">))</span>
			<span class="n">actqf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">actqf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_quota_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">quota_format_type</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">qf_owner</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Dquot List Management:</span>
<span class="cm"> * The quota code uses three lists for dquot management: the inuse_list,</span>
<span class="cm"> * free_dquots, and dquot_hash[] array. A single dquot structure may be</span>
<span class="cm"> * on all three lists, depending on its current state.</span>
<span class="cm"> *</span>
<span class="cm"> * All dquots are placed to the end of inuse_list when first created, and this</span>
<span class="cm"> * list is used for invalidate operation, which must look at every dquot.</span>
<span class="cm"> *</span>
<span class="cm"> * Unused dquots (dq_count == 0) are added to the free_dquots list when freed,</span>
<span class="cm"> * and this list is searched whenever we need an available dquot.  Dquots are</span>
<span class="cm"> * removed from the list as soon as they are used again, and</span>
<span class="cm"> * dqstats.free_dquots gives the number of dquots on the list. When</span>
<span class="cm"> * dquot is invalidated it&#39;s completely released from memory.</span>
<span class="cm"> *</span>
<span class="cm"> * Dquots with a specific identity (device, type and id) are placed on</span>
<span class="cm"> * one of the dquot_hash[] hash chains. The provides an efficient search</span>
<span class="cm"> * mechanism to locate a specific dquot.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">inuse_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">free_dquots</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dq_hash_bits</span><span class="p">,</span> <span class="n">dq_hash_mask</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">dquot_hash</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">dqstats</span> <span class="n">dqstats</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dqstats</span><span class="p">);</span>

<span class="k">static</span> <span class="n">qsize_t</span> <span class="n">inode_get_rsv_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__dquot_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">hashfn</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sb</span><span class="o">&gt;&gt;</span><span class="n">L1_CACHE_SHIFT</span><span class="p">)</span> <span class="o">^</span> <span class="n">id</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">MAXQUOTAS</span> <span class="o">-</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="n">dq_hash_bits</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">dq_hash_mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Following list functions expect dq_list_lock to be held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">insert_dquot_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">dquot_hash</span> <span class="o">+</span> <span class="n">hashfn</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">,</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_id</span><span class="p">,</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">);</span>
	<span class="n">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_hash</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">remove_dquot_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hlist_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_hash</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="nf">find_dquot</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hashent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">;</span>

	<span class="n">hlist_for_each</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">dquot_hash</span><span class="o">+</span><span class="n">hashent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dquot</span> <span class="o">=</span> <span class="n">hlist_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dquot</span><span class="p">,</span> <span class="n">dq_hash</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span> <span class="o">==</span> <span class="n">sb</span> <span class="o">&amp;&amp;</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_id</span> <span class="o">==</span> <span class="n">id</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">dquot</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add a dquot to the tail of the free list */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">put_dquot_last</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_free</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">free_dquots</span><span class="p">);</span>
	<span class="n">dqstats_inc</span><span class="p">(</span><span class="n">DQST_FREE_DQUOTS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">remove_free_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_free</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_free</span><span class="p">);</span>
	<span class="n">dqstats_dec</span><span class="p">(</span><span class="n">DQST_FREE_DQUOTS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">put_inuse</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We add to the back of inuse list so we don&#39;t have to restart</span>
<span class="cm">	 * when traversing this list and we block */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_inuse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inuse_list</span><span class="p">);</span>
	<span class="n">dqstats_inc</span><span class="p">(</span><span class="n">DQST_ALLOC_DQUOTS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">remove_inuse</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dqstats_dec</span><span class="p">(</span><span class="n">DQST_ALLOC_DQUOTS</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_inuse</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * End of list functions needing dq_list_lock</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_on_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dquot_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">DQ_MOD_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mark_dquot_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="o">-&gt;</span><span class="n">dq_op</span><span class="o">-&gt;</span><span class="n">mark_dirty</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Mark dquot dirty in atomic manner, and return it&#39;s old dirty flag state */</span>
<span class="kt">int</span> <span class="nf">dquot_mark_dquot_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* If quota is dirty already, we don&#39;t have to acquire dq_list_lock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DQ_MOD_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">DQ_MOD_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dirty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">)</span><span class="o">-&gt;</span>
				<span class="n">info</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">].</span><span class="n">dqi_dirty_list</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_mark_dquot_dirty</span><span class="p">);</span>

<span class="cm">/* Dirtify all the dquots - this can block when journalling */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mark_all_dquot_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span>
			<span class="cm">/* Even in case of error we have to continue */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mark_dquot_dirty</span><span class="p">(</span><span class="n">dquot</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dqput_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">**</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dqput</span><span class="p">(</span><span class="n">dquot</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* This function needs dq_list_lock */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">clear_dquot_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">DQ_MOD_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dirty</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mark_info_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">DQF_INFO_DIRTY_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">dqi_flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mark_info_dirty</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	Read dquot from disk and alloc space for it</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">dquot_acquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">quota_info</span> <span class="o">*</span><span class="n">dqopt</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_lock</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqio_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DQ_READ_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">read_dqblk</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_iolock</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">DQ_READ_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
	<span class="cm">/* Instantiate dquot if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DQ_ACTIVE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">commit_dqblk</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="cm">/* Write the info if needed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info_dirty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">ret2</span> <span class="o">=</span> <span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">write_file_info</span><span class="p">(</span>
						<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">,</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_iolock</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret2</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_iolock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">DQ_ACTIVE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
<span class="nl">out_iolock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqio_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_acquire</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	Write dquot to disk</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dquot_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">quota_info</span> <span class="o">*</span><span class="n">dqopt</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqio_mutex</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clear_dquot_dirty</span><span class="p">(</span><span class="n">dquot</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_sem</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="cm">/* Inactive dquot can be only if there was error during read/init</span>
<span class="cm">	 * =&gt; we have better not writing it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DQ_ACTIVE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">commit_dqblk</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="nl">out_sem:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqio_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_commit</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	Release dquot</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dquot_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">quota_info</span> <span class="o">*</span><span class="n">dqopt</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_lock</span><span class="p">);</span>
	<span class="cm">/* Check whether we are not racing with some other dqget() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_dqlock</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqio_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">release_dqblk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">release_dqblk</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="cm">/* Write the info */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info_dirty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">ret2</span> <span class="o">=</span> <span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">write_file_info</span><span class="p">(</span>
						<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">,</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DQ_ACTIVE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqio_mutex</span><span class="p">);</span>
<span class="nl">out_dqlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_release</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">dquot_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">dquot_cachep</span><span class="p">,</span> <span class="n">dquot</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_destroy</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">do_destroy_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="o">-&gt;</span><span class="n">dq_op</span><span class="o">-&gt;</span><span class="n">destroy_dquot</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Invalidate all dquots on the list. Note that this function is called after</span>
<span class="cm"> * quota is disabled and pointers from inodes removed so there cannot be new</span>
<span class="cm"> * quota users. There can still be some users of quotas due to inodes being</span>
<span class="cm"> * just deleted or pruned by prune_icache() (those are not attached to any</span>
<span class="cm"> * list) or parallel quotactl call. We have to wait for such users.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">invalidate_dquots</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

<span class="nl">restart:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">dquot</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inuse_list</span><span class="p">,</span> <span class="n">dq_inuse</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span> <span class="o">!=</span> <span class="n">sb</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Wait for dquot users */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">);</span>
			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_wait_unused</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span>
					<span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
			<span class="cm">/* Once dqput() wakes us up, we know it&#39;s time to free</span>
<span class="cm">			 * the dquot.</span>
<span class="cm">			 * IMPORTANT: we rely on the fact that there is always</span>
<span class="cm">			 * at most one process waiting for dquot to free.</span>
<span class="cm">			 * Otherwise dq_count would be &gt; 1 and we would never</span>
<span class="cm">			 * wake up.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">schedule</span><span class="p">();</span>
			<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_wait_unused</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
			<span class="n">dqput</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
			<span class="cm">/* At this moment dquot() need not exist (it could be</span>
<span class="cm">			 * reclaimed by prune_dqcache(). Hence we must</span>
<span class="cm">			 * restart. */</span>
			<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Quota now has no users and it has been written on last</span>
<span class="cm">		 * dqput()</span>
<span class="cm">		 */</span>
		<span class="n">remove_dquot_hash</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="n">remove_free_dquot</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="n">remove_inuse</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="n">do_destroy_dquot</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Call callback for every active dquot on given filesystem */</span>
<span class="kt">int</span> <span class="nf">dquot_scan_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">priv</span><span class="p">),</span>
		      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="o">*</span><span class="n">old_dquot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dquot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inuse_list</span><span class="p">,</span> <span class="n">dq_inuse</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DQ_ACTIVE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span> <span class="o">!=</span> <span class="n">sb</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Now we have active dquot so we can just increase use count */</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		<span class="n">dqstats_inc</span><span class="p">(</span><span class="n">DQST_LOOKUPS</span><span class="p">);</span>
		<span class="n">dqput</span><span class="p">(</span><span class="n">old_dquot</span><span class="p">);</span>
		<span class="n">old_dquot</span> <span class="o">=</span> <span class="n">dquot</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">dquot</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		<span class="cm">/* We are safe to continue now because our dquot could not</span>
<span class="cm">		 * be moved out of the inuse list while we hold the reference */</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">dqput</span><span class="p">(</span><span class="n">old_dquot</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_scan_active</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dquot_quota_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">dirty</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">quota_info</span> <span class="o">*</span><span class="n">dqopt</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_active</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		<span class="n">dirty</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">dqi_dirty_list</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">dirty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dquot</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">dirty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dquot</span><span class="p">,</span>
						 <span class="n">dq_dirty</span><span class="p">);</span>
			<span class="cm">/* Dirty and inactive can be only bad dquot... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DQ_ACTIVE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">clear_dquot_dirty</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Now we have active dquot from which someone is</span>
<span class="cm"> 			 * holding reference so we can safely just increase</span>
<span class="cm">			 * use count */</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
			<span class="n">dqstats_inc</span><span class="p">(</span><span class="n">DQST_LOOKUPS</span><span class="p">);</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">dq_op</span><span class="o">-&gt;</span><span class="n">write_dquot</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
			<span class="n">dqput</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cnt</span> <span class="o">==</span> <span class="n">type</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sb_has_quota_active</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="n">info_dirty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">cnt</span><span class="p">]))</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">dq_op</span><span class="o">-&gt;</span><span class="n">write_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="n">dqstats_inc</span><span class="p">(</span><span class="n">DQST_SYNCS</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait</span> <span class="o">||</span> <span class="p">(</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_QUOTA_SYS_FILE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This is not very clever (and fast) but currently I don&#39;t know about</span>
<span class="cm">	 * any other simple way of getting quota data to disk and we must get</span>
<span class="cm">	 * them there for userspace to be visible... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span><span class="o">-&gt;</span><span class="n">sync_fs</span><span class="p">)</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span><span class="o">-&gt;</span><span class="n">sync_fs</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sync_blockdev</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now when everything is written we can discard the pagecache so</span>
<span class="cm">	 * that userspace sees the changes.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_active</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
		<span class="n">truncate_inode_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_quota_sync</span><span class="p">);</span>

<span class="cm">/* Free unused dquots from cache */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prune_dqcache</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">free_dquots</span><span class="p">.</span><span class="n">prev</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">head</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">free_dquots</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dquot</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dquot</span><span class="p">,</span> <span class="n">dq_free</span><span class="p">);</span>
		<span class="n">remove_dquot_hash</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="n">remove_free_dquot</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="n">remove_inuse</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="n">do_destroy_dquot</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">free_dquots</span><span class="p">.</span><span class="n">prev</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is called from kswapd when we think we need some</span>
<span class="cm"> * more memory</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">shrink_dqcache_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">shrinker</span> <span class="o">*</span><span class="n">shrink</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">shrink_control</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">nr_to_scan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		<span class="n">prune_dqcache</span><span class="p">(</span><span class="n">nr</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span>
		<span class="n">percpu_counter_read_positive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqstats</span><span class="p">.</span><span class="n">counter</span><span class="p">[</span><span class="n">DQST_FREE_DQUOTS</span><span class="p">])</span>
		<span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">sysctl_vfs_cache_pressure</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">shrinker</span> <span class="n">dqcache_shrinker</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">shrink</span> <span class="o">=</span> <span class="n">shrink_dqcache_memory</span><span class="p">,</span>
	<span class="p">.</span><span class="n">seeks</span> <span class="o">=</span> <span class="n">DEFAULT_SEEKS</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Put reference to dquot</span>
<span class="cm"> * NOTE: If you change this function please check whether dqput_blocks() works right...</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dqput</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquot</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">quota_error</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">,</span> <span class="s">&quot;trying to free free dquot of %s %d&quot;</span><span class="p">,</span>
			    <span class="n">quotatypes</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">],</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_id</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">dqstats_inc</span><span class="p">(</span><span class="n">DQST_DROPS</span><span class="p">);</span>
<span class="nl">we_slept:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We have more than one user... nothing to do */</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">);</span>
		<span class="cm">/* Releasing dquot during quotaoff phase? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_active</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">,</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_wait_unused</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Need to release dquot? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DQ_ACTIVE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dquot_dirty</span><span class="p">(</span><span class="n">dquot</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		<span class="cm">/* Commit dquot before releasing */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="o">-&gt;</span><span class="n">dq_op</span><span class="o">-&gt;</span><span class="n">write_dquot</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">quota_error</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">,</span> <span class="s">&quot;Can&#39;t write quota structure&quot;</span>
				    <span class="s">&quot; (error %d). Quota may get out of sync!&quot;</span><span class="p">,</span>
				    <span class="n">ret</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * We clear dirty bit anyway, so that we avoid</span>
<span class="cm">			 * infinite loop here</span>
<span class="cm">			 */</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
			<span class="n">clear_dquot_dirty</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">we_slept</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Clear flag in case dquot was inactive (something bad happened) */</span>
	<span class="n">clear_dquot_dirty</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DQ_ACTIVE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="o">-&gt;</span><span class="n">dq_op</span><span class="o">-&gt;</span><span class="n">release_dquot</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">we_slept</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_QUOTA_DEBUG</span>
	<span class="cm">/* sanity check */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_free</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="n">put_dquot_last</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dqput</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="nf">dquot_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">dquot_cachep</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_alloc</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="nf">get_empty_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">;</span>

	<span class="n">dquot</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">dq_op</span><span class="o">-&gt;</span><span class="n">alloc_dquot</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dquot</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_free</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_inuse</span><span class="p">);</span>
	<span class="n">INIT_HLIST_NODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_hash</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dirty</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_wait_unused</span><span class="p">);</span>
	<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span> <span class="o">=</span> <span class="n">sb</span><span class="p">;</span>
	<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dquot</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get reference to dquot</span>
<span class="cm"> *</span>
<span class="cm"> * Locking is slightly tricky here. We are guarded from parallel quotaoff()</span>
<span class="cm"> * destroying our dquot by:</span>
<span class="cm"> *   a) checking for quota flags under dq_list_lock and</span>
<span class="cm"> *   b) getting a reference to dquot before we release dq_list_lock</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="nf">dqget</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hashent</span> <span class="o">=</span> <span class="n">hashfn</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">empty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_active</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">we_slept:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_state_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_active</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_state_lock</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_state_lock</span><span class="p">);</span>

	<span class="n">dquot</span> <span class="o">=</span> <span class="n">find_dquot</span><span class="p">(</span><span class="n">hashent</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquot</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">empty</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
			<span class="n">empty</span> <span class="o">=</span> <span class="n">get_empty_dquot</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">empty</span><span class="p">)</span>
				<span class="n">schedule</span><span class="p">();</span>	<span class="cm">/* Try to wait for a moment... */</span>
			<span class="k">goto</span> <span class="n">we_slept</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dquot</span> <span class="o">=</span> <span class="n">empty</span><span class="p">;</span>
		<span class="n">empty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
		<span class="cm">/* all dquots go on the inuse_list */</span>
		<span class="n">put_inuse</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="cm">/* hash it first so it can be found */</span>
		<span class="n">insert_dquot_hash</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		<span class="n">dqstats_inc</span><span class="p">(</span><span class="n">DQST_LOOKUPS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">))</span>
			<span class="n">remove_free_dquot</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
		<span class="n">dqstats_inc</span><span class="p">(</span><span class="n">DQST_CACHE_HITS</span><span class="p">);</span>
		<span class="n">dqstats_inc</span><span class="p">(</span><span class="n">DQST_LOOKUPS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Wait for dq_lock - after this we know that either dquot_release() is</span>
<span class="cm">	 * already finished or it will be canceled due to dq_count &gt; 1 test */</span>
	<span class="n">wait_on_dquot</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="cm">/* Read the dquot / allocate space in quota file */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DQ_ACTIVE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sb</span><span class="o">-&gt;</span><span class="n">dq_op</span><span class="o">-&gt;</span><span class="n">acquire_dquot</span><span class="p">(</span><span class="n">dquot</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dqput</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="n">dquot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_QUOTA_DEBUG</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">);</span>	<span class="cm">/* Has somebody invalidated entry under us? */</span>
<span class="cp">#endif</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">empty</span><span class="p">)</span>
		<span class="n">do_destroy_dquot</span><span class="p">(</span><span class="n">empty</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dquot</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dqget</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dqinit_needed</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_NOQUOTA</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">!</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This routine is guarded by dqonoff_mutex mutex */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_dquot_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="o">*</span><span class="n">old_inode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA_DEBUG</span>
	<span class="kt">int</span> <span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode_sb_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_inodes</span><span class="p">,</span> <span class="n">i_sb_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">I_FREEING</span><span class="o">|</span><span class="n">I_WILL_FREE</span><span class="o">|</span><span class="n">I_NEW</span><span class="p">))</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_writecount</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">dqinit_needed</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">__iget</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode_sb_list_lock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_QUOTA_DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">inode_get_rsv_space</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">reserved</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">old_inode</span><span class="p">);</span>
		<span class="n">__dquot_initialize</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * We hold a reference to &#39;inode&#39; so it couldn&#39;t have been</span>
<span class="cm">		 * removed from s_inodes list while we dropped the</span>
<span class="cm">		 * inode_sb_list_lock We cannot iput the inode now as we can be</span>
<span class="cm">		 * holding the last reference and we cannot iput it under</span>
<span class="cm">		 * inode_sb_list_lock. So we keep the reference and iput it</span>
<span class="cm">		 * later.</span>
<span class="cm">		 */</span>
		<span class="n">old_inode</span> <span class="o">=</span> <span class="n">inode</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode_sb_list_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode_sb_list_lock</span><span class="p">);</span>
	<span class="n">iput</span><span class="p">(</span><span class="n">old_inode</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_QUOTA_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reserved</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">quota_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Writes happened before quota was turned on &quot;</span>
			<span class="s">&quot;thus quota information is probably inconsistent. &quot;</span>
			<span class="s">&quot;Please run quotacheck(8)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return 0 if dqput() won&#39;t block.</span>
<span class="cm"> * (note that 1 doesn&#39;t necessarily mean blocking)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dqput_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove references to dquots from inode and add dquot to list for freeing</span>
<span class="cm"> * if we have the last reference to dquot</span>
<span class="cm"> * We can&#39;t race with anybody because we hold dqptr_sem for writing...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">remove_inode_dquot_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tofree_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>

	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dqput_blocks</span><span class="p">(</span><span class="n">dquot</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_QUOTA_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">quota_error</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="s">&quot;Adding dquot with &quot;</span>
					    <span class="s">&quot;dq_count %d to dispose list&quot;</span><span class="p">,</span>
					    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_count</span><span class="p">));</span>
<span class="cp">#endif</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
			<span class="cm">/* As dquot must have currently users it can&#39;t be on</span>
<span class="cm">			 * the free list... */</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_free</span><span class="p">,</span> <span class="n">tofree_head</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_list_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">dqput</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>   <span class="cm">/* We have guaranteed we won&#39;t block */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free list of dquots</span>
<span class="cm"> * Dquots are removed from inodes and no new references can be got so we are</span>
<span class="cm"> * the only ones holding reference</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_dquot_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tofree_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">act_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">;</span>

	<span class="n">act_head</span> <span class="o">=</span> <span class="n">tofree_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">act_head</span> <span class="o">!=</span> <span class="n">tofree_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dquot</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">act_head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dquot</span><span class="p">,</span> <span class="n">dq_free</span><span class="p">);</span>
		<span class="n">act_head</span> <span class="o">=</span> <span class="n">act_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="cm">/* Remove dquot from the list so we won&#39;t have problems... */</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_free</span><span class="p">);</span>
		<span class="n">dqput</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_dquot_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tofree_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode_sb_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_inodes</span><span class="p">,</span> <span class="n">i_sb_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  We have to scan also I_NEW inodes because they can already</span>
<span class="cm">		 *  have quota pointer initialized. Luckily, we need to touch</span>
<span class="cm">		 *  only quota pointers and these have separate locking</span>
<span class="cm">		 *  (dqptr_sem).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_NOQUOTA</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">inode_get_rsv_space</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">reserved</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">remove_inode_dquot_ref</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">tofree_head</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode_sb_list_lock</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_QUOTA_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reserved</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;VFS (%s): Writes happened after quota&quot;</span>
			<span class="s">&quot; was disabled thus quota information is probably &quot;</span>
			<span class="s">&quot;inconsistent. Please run quotacheck(8).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* Gather all references from inodes and drop them */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drop_dquot_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">tofree_head</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">dq_op</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
		<span class="n">remove_dquot_ref</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tofree_head</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
		<span class="n">put_dquot_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tofree_head</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dquot_incr_inodes</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curinodes</span> <span class="o">+=</span> <span class="n">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dquot_incr_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curspace</span> <span class="o">+=</span> <span class="n">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dquot_resv_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_rsvspace</span> <span class="o">+=</span> <span class="n">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Claim reserved quota space</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dquot_claim_reserved_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_rsvspace</span> <span class="o">&lt;</span> <span class="n">number</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">number</span> <span class="o">=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_rsvspace</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curspace</span> <span class="o">+=</span> <span class="n">number</span><span class="p">;</span>
	<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_rsvspace</span> <span class="o">-=</span> <span class="n">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">void</span> <span class="nf">dquot_free_reserved_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_rsvspace</span> <span class="o">&gt;=</span> <span class="n">number</span><span class="p">)</span>
		<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_rsvspace</span> <span class="o">-=</span> <span class="n">number</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_rsvspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dquot_decr_inodes</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_NEGATIVE_USAGE</span> <span class="o">||</span>
	    <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curinodes</span> <span class="o">&gt;=</span> <span class="n">number</span><span class="p">)</span>
		<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curinodes</span> <span class="o">-=</span> <span class="n">number</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curinodes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curinodes</span> <span class="o">&lt;=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_isoftlimit</span><span class="p">)</span>
		<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_itime</span> <span class="o">=</span> <span class="p">(</span><span class="kt">time_t</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DQ_INODES_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dquot_decr_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_NEGATIVE_USAGE</span> <span class="o">||</span>
	    <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curspace</span> <span class="o">&gt;=</span> <span class="n">number</span><span class="p">)</span>
		<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curspace</span> <span class="o">-=</span> <span class="n">number</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curspace</span> <span class="o">&lt;=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_bsoftlimit</span><span class="p">)</span>
		<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_btime</span> <span class="o">=</span> <span class="p">(</span><span class="kt">time_t</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DQ_BLKS_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dquot_warn</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">w_sb</span><span class="p">;</span>
	<span class="n">qid_t</span> <span class="n">w_dq_id</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">w_dq_type</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">w_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">warning_issued</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">warntype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">warntype</span> <span class="o">==</span> <span class="n">QUOTA_NL_BHARDWARN</span> <span class="o">||</span>
		<span class="n">warntype</span> <span class="o">==</span> <span class="n">QUOTA_NL_BSOFTLONGWARN</span><span class="p">)</span> <span class="o">?</span> <span class="n">DQ_BLKS_B</span> <span class="o">:</span>
		<span class="p">((</span><span class="n">warntype</span> <span class="o">==</span> <span class="n">QUOTA_NL_IHARDWARN</span> <span class="o">||</span>
		<span class="n">warntype</span> <span class="o">==</span> <span class="n">QUOTA_NL_ISOFTLONGWARN</span><span class="p">)</span> <span class="o">?</span> <span class="n">DQ_INODES_B</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flag</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PRINT_QUOTA_WARNING</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">flag_print_warnings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">need_print_warning</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot_warn</span> <span class="o">*</span><span class="n">warn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flag_print_warnings</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">warn</span><span class="o">-&gt;</span><span class="n">w_dq_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USRQUOTA</span>:
			<span class="k">return</span> <span class="n">current_fsuid</span><span class="p">()</span> <span class="o">==</span> <span class="n">warn</span><span class="o">-&gt;</span><span class="n">w_dq_id</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GRPQUOTA</span>:
			<span class="k">return</span> <span class="n">in_group_p</span><span class="p">(</span><span class="n">warn</span><span class="o">-&gt;</span><span class="n">w_dq_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Print warning to user which exceeded quota */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_warning</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot_warn</span> <span class="o">*</span><span class="n">warn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">warntype</span> <span class="o">=</span> <span class="n">warn</span><span class="o">-&gt;</span><span class="n">w_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">warntype</span> <span class="o">==</span> <span class="n">QUOTA_NL_IHARDBELOW</span> <span class="o">||</span>
	    <span class="n">warntype</span> <span class="o">==</span> <span class="n">QUOTA_NL_ISOFTBELOW</span> <span class="o">||</span>
	    <span class="n">warntype</span> <span class="o">==</span> <span class="n">QUOTA_NL_BHARDBELOW</span> <span class="o">||</span>
	    <span class="n">warntype</span> <span class="o">==</span> <span class="n">QUOTA_NL_BSOFTBELOW</span> <span class="o">||</span> <span class="o">!</span><span class="n">need_print_warning</span><span class="p">(</span><span class="n">warn</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">get_current_tty</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tty_write_message</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">warn</span><span class="o">-&gt;</span><span class="n">w_sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">warntype</span> <span class="o">==</span> <span class="n">QUOTA_NL_ISOFTWARN</span> <span class="o">||</span> <span class="n">warntype</span> <span class="o">==</span> <span class="n">QUOTA_NL_BSOFTWARN</span><span class="p">)</span>
		<span class="n">tty_write_message</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="s">&quot;: warning, &quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tty_write_message</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="s">&quot;: write failed, &quot;</span><span class="p">);</span>
	<span class="n">tty_write_message</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">quotatypes</span><span class="p">[</span><span class="n">warn</span><span class="o">-&gt;</span><span class="n">w_dq_type</span><span class="p">]);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">warntype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QUOTA_NL_IHARDWARN</span>:
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot; file limit reached.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QUOTA_NL_ISOFTLONGWARN</span>:
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot; file quota exceeded too long.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QUOTA_NL_ISOFTWARN</span>:
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot; file quota exceeded.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QUOTA_NL_BHARDWARN</span>:
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot; block limit reached.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QUOTA_NL_BSOFTLONGWARN</span>:
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot; block quota exceeded too long.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QUOTA_NL_BSOFTWARN</span>:
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot; block quota exceeded.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tty_write_message</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_warning</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot_warn</span> <span class="o">*</span><span class="n">warn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">warntype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">warning_issued</span><span class="p">(</span><span class="n">dquot</span><span class="p">,</span> <span class="n">warntype</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">warn</span><span class="o">-&gt;</span><span class="n">w_type</span> <span class="o">=</span> <span class="n">warntype</span><span class="p">;</span>
	<span class="n">warn</span><span class="o">-&gt;</span><span class="n">w_sb</span> <span class="o">=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">;</span>
	<span class="n">warn</span><span class="o">-&gt;</span><span class="n">w_dq_id</span> <span class="o">=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_id</span><span class="p">;</span>
	<span class="n">warn</span><span class="o">-&gt;</span><span class="n">w_dq_type</span> <span class="o">=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write warnings to the console and send warning messages over netlink.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that this function can call into tty and networking code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_warnings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot_warn</span> <span class="o">*</span><span class="n">warn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">warn</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w_type</span> <span class="o">==</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PRINT_QUOTA_WARNING</span>
		<span class="n">print_warning</span><span class="p">(</span><span class="o">&amp;</span><span class="n">warn</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="n">quota_send_warning</span><span class="p">(</span><span class="n">warn</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w_dq_type</span><span class="p">,</span> <span class="n">warn</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w_dq_id</span><span class="p">,</span>
				   <span class="n">warn</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w_sb</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">,</span> <span class="n">warn</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w_type</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ignore_hardlimit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_dqinfo</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RESOURCE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dqi_format</span><span class="o">-&gt;</span><span class="n">qf_fmt_id</span> <span class="o">!=</span> <span class="n">QFMT_VFS_OLD</span> <span class="o">||</span>
		<span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dqi_flags</span> <span class="o">&amp;</span> <span class="n">V1_DQF_RSQUASH</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* needs dq_data_lock */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_idq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">inodes</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">dquot_warn</span> <span class="o">*</span><span class="n">warn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qsize_t</span> <span class="n">newinodes</span> <span class="o">=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curinodes</span> <span class="o">+</span> <span class="n">inodes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_limits_enabled</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">,</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DQ_FAKE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_ihardlimit</span> <span class="o">&amp;&amp;</span>
	    <span class="n">newinodes</span> <span class="o">&gt;</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_ihardlimit</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">ignore_hardlimit</span><span class="p">(</span><span class="n">dquot</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prepare_warning</span><span class="p">(</span><span class="n">warn</span><span class="p">,</span> <span class="n">dquot</span><span class="p">,</span> <span class="n">QUOTA_NL_IHARDWARN</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDQUOT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_isoftlimit</span> <span class="o">&amp;&amp;</span>
	    <span class="n">newinodes</span> <span class="o">&gt;</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_isoftlimit</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_itime</span> <span class="o">&amp;&amp;</span>
	    <span class="n">get_seconds</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_itime</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">ignore_hardlimit</span><span class="p">(</span><span class="n">dquot</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prepare_warning</span><span class="p">(</span><span class="n">warn</span><span class="p">,</span> <span class="n">dquot</span><span class="p">,</span> <span class="n">QUOTA_NL_ISOFTLONGWARN</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDQUOT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_isoftlimit</span> <span class="o">&amp;&amp;</span>
	    <span class="n">newinodes</span> <span class="o">&gt;</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_isoftlimit</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_itime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prepare_warning</span><span class="p">(</span><span class="n">warn</span><span class="p">,</span> <span class="n">dquot</span><span class="p">,</span> <span class="n">QUOTA_NL_ISOFTWARN</span><span class="p">);</span>
		<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_itime</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">()</span> <span class="o">+</span>
		    <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">].</span><span class="n">dqi_igrace</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* needs dq_data_lock */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_bdq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">space</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prealloc</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">dquot_warn</span> <span class="o">*</span><span class="n">warn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qsize_t</span> <span class="n">tspace</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_limits_enabled</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DQ_FAKE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tspace</span> <span class="o">=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curspace</span> <span class="o">+</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_rsvspace</span>
		<span class="o">+</span> <span class="n">space</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_bhardlimit</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tspace</span> <span class="o">&gt;</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_bhardlimit</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">ignore_hardlimit</span><span class="p">(</span><span class="n">dquot</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prealloc</span><span class="p">)</span>
			<span class="n">prepare_warning</span><span class="p">(</span><span class="n">warn</span><span class="p">,</span> <span class="n">dquot</span><span class="p">,</span> <span class="n">QUOTA_NL_BHARDWARN</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDQUOT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_bsoftlimit</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tspace</span> <span class="o">&gt;</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_bsoftlimit</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_btime</span> <span class="o">&amp;&amp;</span>
	    <span class="n">get_seconds</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_btime</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">ignore_hardlimit</span><span class="p">(</span><span class="n">dquot</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prealloc</span><span class="p">)</span>
			<span class="n">prepare_warning</span><span class="p">(</span><span class="n">warn</span><span class="p">,</span> <span class="n">dquot</span><span class="p">,</span> <span class="n">QUOTA_NL_BSOFTLONGWARN</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDQUOT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_bsoftlimit</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tspace</span> <span class="o">&gt;</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_bsoftlimit</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_btime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prealloc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prepare_warning</span><span class="p">(</span><span class="n">warn</span><span class="p">,</span> <span class="n">dquot</span><span class="p">,</span> <span class="n">QUOTA_NL_BSOFTWARN</span><span class="p">);</span>
			<span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_btime</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">()</span> <span class="o">+</span>
			    <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">].</span><span class="n">dqi_bgrace</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="cm">/*</span>
<span class="cm">			 * We don&#39;t allow preallocation to exceed softlimit so exceeding will</span>
<span class="cm">			 * be always printed</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EDQUOT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">info_idq_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">inodes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qsize_t</span> <span class="n">newinodes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DQ_FAKE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curinodes</span> <span class="o">&lt;=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_isoftlimit</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">sb_has_quota_limits_enabled</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">,</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">;</span>

	<span class="n">newinodes</span> <span class="o">=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curinodes</span> <span class="o">-</span> <span class="n">inodes</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newinodes</span> <span class="o">&lt;=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_isoftlimit</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QUOTA_NL_ISOFTBELOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curinodes</span> <span class="o">&gt;=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_ihardlimit</span> <span class="o">&amp;&amp;</span>
	    <span class="n">newinodes</span> <span class="o">&lt;</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_ihardlimit</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QUOTA_NL_IHARDBELOW</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">info_bdq_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DQ_FAKE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curspace</span> <span class="o">&lt;=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_bsoftlimit</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curspace</span> <span class="o">-</span> <span class="n">space</span> <span class="o">&lt;=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_bsoftlimit</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QUOTA_NL_BSOFTBELOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curspace</span> <span class="o">&gt;=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_bhardlimit</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_curspace</span> <span class="o">-</span> <span class="n">space</span> <span class="o">&lt;</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">.</span><span class="n">dqb_bhardlimit</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QUOTA_NL_BHARDBELOW</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dquot_active</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_NOQUOTA</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sb_any_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">sb_any_quota_suspended</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize quota pointers in inode</span>
<span class="cm"> *</span>
<span class="cm"> * We do things in a bit complicated way but by that we avoid calling</span>
<span class="cm"> * dqget() and thus filesystem callbacks under dqptr_sem.</span>
<span class="cm"> *</span>
<span class="cm"> * It is better to call this function outside of any transaction as it</span>
<span class="cm"> * might need a lot of space in journal for dquot structure allocation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__dquot_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">got</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="n">qsize_t</span> <span class="n">rsv</span><span class="p">;</span>

	<span class="cm">/* First test before acquiring mutex - solves deadlocks when we</span>
<span class="cm">         * re-enter the quota code and are already holding the mutex */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquot_active</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* First get references to structures we might need. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">got</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USRQUOTA</span>:
			<span class="n">id</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_uid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GRPQUOTA</span>:
			<span class="n">id</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_gid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">got</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">dqget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_NOQUOTA</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Avoid races with quotaoff() */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_active</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* We could race with quotaon or dqget() could have failed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">got</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">got</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
			<span class="n">got</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Make quota reservation system happy if someone</span>
<span class="cm">			 * did a write before quota was turned on</span>
<span class="cm">			 */</span>
			<span class="n">rsv</span> <span class="o">=</span> <span class="n">inode_get_rsv_space</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rsv</span><span class="p">))</span>
				<span class="n">dquot_resv_space</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">rsv</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out_err:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="cm">/* Drop unused references */</span>
	<span class="n">dqput_all</span><span class="p">(</span><span class="n">got</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dquot_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__dquot_initialize</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_initialize</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * 	Release all quotas referenced by inode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__dquot_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">put</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="n">dqput_all</span><span class="p">(</span><span class="n">put</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dquot_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_NOQUOTA</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Test before calling to rule out calls from proc and such</span>
<span class="cm">	 * where we are not allowed to block. Note that this is</span>
<span class="cm">	 * actually reliable test even without the lock - the caller</span>
<span class="cm">	 * must assure that nobody can come after the DQUOT_DROP and</span>
<span class="cm">	 * add quota pointers back anyway.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">)</span>
		<span class="n">__dquot_drop</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_drop</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * inode_reserved_space is managed internally by quota, and protected by</span>
<span class="cm"> * i_lock similar to i_blocks+i_bytes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">qsize_t</span> <span class="o">*</span><span class="nf">inode_reserved_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span> <span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Filesystem must explicitly define it&#39;s own method in order to use</span>
<span class="cm">	 * quota reservation interface */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">dq_op</span><span class="o">-&gt;</span><span class="n">get_reserved_space</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">dq_op</span><span class="o">-&gt;</span><span class="n">get_reserved_space</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">inode_add_rsv_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">inode_reserved_space</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">+=</span> <span class="n">number</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">inode_add_rsv_space</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">inode_claim_rsv_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">inode_reserved_space</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">-=</span> <span class="n">number</span><span class="p">;</span>
	<span class="n">__inode_add_bytes</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">number</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">inode_claim_rsv_space</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">inode_sub_rsv_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">inode_reserved_space</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">-=</span> <span class="n">number</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">inode_sub_rsv_space</span><span class="p">);</span>

<span class="k">static</span> <span class="n">qsize_t</span> <span class="nf">inode_get_rsv_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qsize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">dq_op</span><span class="o">-&gt;</span><span class="n">get_reserved_space</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">*</span><span class="n">inode_reserved_space</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inode_incr_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">reserve</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reserve</span><span class="p">)</span>
		<span class="n">inode_add_rsv_space</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">number</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">inode_add_bytes</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">number</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inode_decr_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reserve</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reserve</span><span class="p">)</span>
		<span class="n">inode_sub_rsv_space</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">number</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">inode_sub_bytes</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">number</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This functions updates i_blocks+i_bytes fields and quota information</span>
<span class="cm"> * (together with appropriate checks).</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: We absolutely rely on the fact that caller dirties the inode</span>
<span class="cm"> * (usually helpers in quotaops.h care about this) and holds a handle for</span>
<span class="cm"> * the current transaction so that dquot write and inode write go into the</span>
<span class="cm"> * same transaction.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This operation can block, but only after everything is updated</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__dquot_alloc_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dquot_warn</span> <span class="n">warn</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">**</span><span class="n">dquots</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reserve</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_SPACE_RESERVE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First test before acquiring mutex - solves deadlocks when we</span>
<span class="cm">	 * re-enter the quota code and are already holding the mutex</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquot_active</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inode_incr_space</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">reserve</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="n">warn</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">w_type</span> <span class="o">=</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_bdq</span><span class="p">(</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">number</span><span class="p">,</span>
				<span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_SPACE_WARN</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">warn</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_SPACE_NOFAIL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_flush_warn</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reserve</span><span class="p">)</span>
			<span class="n">dquot_resv_space</span><span class="p">(</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">number</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dquot_incr_space</span><span class="p">(</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">number</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">inode_incr_space</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">reserve</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reserve</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_flush_warn</span><span class="p">;</span>
	<span class="n">mark_all_dquot_dirty</span><span class="p">(</span><span class="n">dquots</span><span class="p">);</span>
<span class="nl">out_flush_warn:</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="n">flush_warnings</span><span class="p">(</span><span class="n">warn</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__dquot_alloc_space</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This operation can block, but only after everything is updated</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dquot_alloc_inode</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dquot_warn</span> <span class="n">warn</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">dquots</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">;</span>

	<span class="cm">/* First test before acquiring mutex - solves deadlocks when we</span>
<span class="cm">         * re-enter the quota code and are already holding the mutex */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquot_active</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="n">warn</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">w_type</span> <span class="o">=</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">;</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_idq</span><span class="p">(</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">warn</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">warn_put_all</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dquot_incr_inodes</span><span class="p">(</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">warn_put_all:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mark_all_dquot_dirty</span><span class="p">(</span><span class="n">dquots</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="n">flush_warnings</span><span class="p">(</span><span class="n">warn</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_alloc_inode</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Convert in-memory reserved quotas to real consumed quotas</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dquot_claim_space_nodirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquot_active</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inode_claim_rsv_space</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="cm">/* Claim reserved quotas to allocated quotas */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span>
			<span class="n">dquot_claim_reserved_space</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span>
							<span class="n">number</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Update inode bytes */</span>
	<span class="n">inode_claim_rsv_space</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">number</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="n">mark_all_dquot_dirty</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_claim_space_nodirty</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This operation can block, but only after everything is updated</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__dquot_free_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">qsize_t</span> <span class="n">number</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dquot_warn</span> <span class="n">warn</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">**</span><span class="n">dquots</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reserve</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_SPACE_RESERVE</span><span class="p">;</span>

	<span class="cm">/* First test before acquiring mutex - solves deadlocks when we</span>
<span class="cm">         * re-enter the quota code and are already holding the mutex */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquot_active</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inode_decr_space</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">reserve</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">wtype</span><span class="p">;</span>

		<span class="n">warn</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">w_type</span> <span class="o">=</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">wtype</span> <span class="o">=</span> <span class="n">info_bdq_free</span><span class="p">(</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">number</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wtype</span> <span class="o">!=</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">)</span>
			<span class="n">prepare_warning</span><span class="p">(</span><span class="o">&amp;</span><span class="n">warn</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">wtype</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reserve</span><span class="p">)</span>
			<span class="n">dquot_free_reserved_space</span><span class="p">(</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">number</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dquot_decr_space</span><span class="p">(</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">number</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">inode_decr_space</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">reserve</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reserve</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="n">mark_all_dquot_dirty</span><span class="p">(</span><span class="n">dquots</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="n">flush_warnings</span><span class="p">(</span><span class="n">warn</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__dquot_free_space</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This operation can block, but only after everything is updated</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dquot_free_inode</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dquot_warn</span> <span class="n">warn</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">dquots</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">;</span>

	<span class="cm">/* First test before acquiring mutex - solves deadlocks when we</span>
<span class="cm">         * re-enter the quota code and are already holding the mutex */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquot_active</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">wtype</span><span class="p">;</span>

		<span class="n">warn</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">w_type</span> <span class="o">=</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">wtype</span> <span class="o">=</span> <span class="n">info_idq_free</span><span class="p">(</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wtype</span> <span class="o">!=</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">)</span>
			<span class="n">prepare_warning</span><span class="p">(</span><span class="o">&amp;</span><span class="n">warn</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">wtype</span><span class="p">);</span>
		<span class="n">dquot_decr_inodes</span><span class="p">(</span><span class="n">dquots</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="n">mark_all_dquot_dirty</span><span class="p">(</span><span class="n">dquots</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="n">flush_warnings</span><span class="p">(</span><span class="n">warn</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_free_inode</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Transfer the number of inode and blocks from one diskquota to an other.</span>
<span class="cm"> * On success, dquot references in transfer_to are consumed and references</span>
<span class="cm"> * to original dquots that need to be released are placed there. On failure,</span>
<span class="cm"> * references are kept untouched.</span>
<span class="cm"> *</span>
<span class="cm"> * This operation can block, but only after everything is updated</span>
<span class="cm"> * A transaction must be started when entering this function.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__dquot_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dquot</span> <span class="o">**</span><span class="n">transfer_to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qsize_t</span> <span class="n">space</span><span class="p">,</span> <span class="n">cur_space</span><span class="p">;</span>
	<span class="n">qsize_t</span> <span class="n">rsv_space</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">transfer_from</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">is_valid</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">struct</span> <span class="n">dquot_warn</span> <span class="n">warn_to</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dquot_warn</span> <span class="n">warn_from_inodes</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dquot_warn</span> <span class="n">warn_from_space</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>

	<span class="cm">/* First test before acquiring mutex - solves deadlocks when we</span>
<span class="cm">         * re-enter the quota code and are already holding the mutex */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_NOQUOTA</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Initialize the arrays */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warn_to</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">w_type</span> <span class="o">=</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">;</span>
		<span class="n">warn_from_inodes</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">w_type</span> <span class="o">=</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">;</span>
		<span class="n">warn_from_space</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">w_type</span> <span class="o">=</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_NOQUOTA</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* File without quota accounting? */</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="n">cur_space</span> <span class="o">=</span> <span class="n">inode_get_bytes</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">rsv_space</span> <span class="o">=</span> <span class="n">inode_get_rsv_space</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">space</span> <span class="o">=</span> <span class="n">cur_space</span> <span class="o">+</span> <span class="n">rsv_space</span><span class="p">;</span>
	<span class="cm">/* Build the transfer_from list and check the limits */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Skip changes for same uid or gid or for turned off quota-type.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">transfer_to</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Avoid races with quotaoff() */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_active</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">is_valid</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">transfer_from</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_idq</span><span class="p">(</span><span class="n">transfer_to</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">warn_to</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">over_quota</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_bdq</span><span class="p">(</span><span class="n">transfer_to</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">space</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">warn_to</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">over_quota</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Finally perform the needed transfer from transfer_from to transfer_to</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Due to IO error we might not have transfer_from[] structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">transfer_from</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">wtype</span><span class="p">;</span>
			<span class="n">wtype</span> <span class="o">=</span> <span class="n">info_idq_free</span><span class="p">(</span><span class="n">transfer_from</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wtype</span> <span class="o">!=</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">)</span>
				<span class="n">prepare_warning</span><span class="p">(</span><span class="o">&amp;</span><span class="n">warn_from_inodes</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span>
						<span class="n">transfer_from</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">wtype</span><span class="p">);</span>
			<span class="n">wtype</span> <span class="o">=</span> <span class="n">info_bdq_free</span><span class="p">(</span><span class="n">transfer_from</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">space</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wtype</span> <span class="o">!=</span> <span class="n">QUOTA_NL_NOWARN</span><span class="p">)</span>
				<span class="n">prepare_warning</span><span class="p">(</span><span class="o">&amp;</span><span class="n">warn_from_space</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span>
						<span class="n">transfer_from</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">wtype</span><span class="p">);</span>
			<span class="n">dquot_decr_inodes</span><span class="p">(</span><span class="n">transfer_from</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">dquot_decr_space</span><span class="p">(</span><span class="n">transfer_from</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">cur_space</span><span class="p">);</span>
			<span class="n">dquot_free_reserved_space</span><span class="p">(</span><span class="n">transfer_from</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span>
						  <span class="n">rsv_space</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dquot_incr_inodes</span><span class="p">(</span><span class="n">transfer_to</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dquot_incr_space</span><span class="p">(</span><span class="n">transfer_to</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">cur_space</span><span class="p">);</span>
		<span class="n">dquot_resv_space</span><span class="p">(</span><span class="n">transfer_to</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">rsv_space</span><span class="p">);</span>

		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dquot</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">transfer_to</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>

	<span class="n">mark_all_dquot_dirty</span><span class="p">(</span><span class="n">transfer_from</span><span class="p">);</span>
	<span class="n">mark_all_dquot_dirty</span><span class="p">(</span><span class="n">transfer_to</span><span class="p">);</span>
	<span class="n">flush_warnings</span><span class="p">(</span><span class="n">warn_to</span><span class="p">);</span>
	<span class="n">flush_warnings</span><span class="p">(</span><span class="n">warn_from_inodes</span><span class="p">);</span>
	<span class="n">flush_warnings</span><span class="p">(</span><span class="n">warn_from_space</span><span class="p">);</span>
	<span class="cm">/* Pass back references to put */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_valid</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span>
			<span class="n">transfer_to</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">transfer_from</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">over_quota:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqptr_sem</span><span class="p">);</span>
	<span class="n">flush_warnings</span><span class="p">(</span><span class="n">warn_to</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__dquot_transfer</span><span class="p">);</span>

<span class="cm">/* Wrapper for transferring ownership of an inode for uid/gid only</span>
<span class="cm"> * Called from FSXXX_setattr()</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dquot_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">iattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">transfer_to</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquot_active</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_UID</span> <span class="o">&amp;&amp;</span> <span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_uid</span> <span class="o">!=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_uid</span><span class="p">)</span>
		<span class="n">transfer_to</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">]</span> <span class="o">=</span> <span class="n">dqget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_uid</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_GID</span> <span class="o">&amp;&amp;</span> <span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_gid</span> <span class="o">!=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_gid</span><span class="p">)</span>
		<span class="n">transfer_to</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">]</span> <span class="o">=</span> <span class="n">dqget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">iattr</span><span class="o">-&gt;</span><span class="n">ia_gid</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__dquot_transfer</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">transfer_to</span><span class="p">);</span>
	<span class="n">dqput_all</span><span class="p">(</span><span class="n">transfer_to</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_transfer</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Write info of quota file to disk</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dquot_commit_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">quota_info</span> <span class="o">*</span><span class="n">dqopt</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqio_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">type</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">write_file_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqio_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_commit_info</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Definitions of diskquota operations.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">dquot_operations</span> <span class="n">dquot_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write_dquot</span>	<span class="o">=</span> <span class="n">dquot_commit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">acquire_dquot</span>	<span class="o">=</span> <span class="n">dquot_acquire</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_dquot</span>	<span class="o">=</span> <span class="n">dquot_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mark_dirty</span>	<span class="o">=</span> <span class="n">dquot_mark_dquot_dirty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_info</span>	<span class="o">=</span> <span class="n">dquot_commit_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_dquot</span>	<span class="o">=</span> <span class="n">dquot_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_dquot</span>	<span class="o">=</span> <span class="n">dquot_destroy</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_operations</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Generic helper for -&gt;open on filesystems supporting disk quotas.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dquot_file_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">generic_file_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span>
		<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_file_open</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Turn quota off on a device. type == -1 ==&gt; quotaoff for all types (umount)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dquot_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">quota_info</span> <span class="o">*</span><span class="n">dqopt</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">toputinode</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>

	<span class="cm">/* Cannot turn off usage accounting without turning off limits, or</span>
<span class="cm">	 * suspend quotas and simultaneously turn quotas off. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_USAGE_ENABLED</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_LIMITS_ENABLED</span><span class="p">))</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_SUSPENDED</span> <span class="o">&amp;&amp;</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DQUOT_LIMITS_ENABLED</span> <span class="o">|</span>
	    <span class="n">DQUOT_USAGE_ENABLED</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* We need to serialize quota_off() for device */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Skip everything if there&#39;s nothing to do. We have to do this because</span>
<span class="cm">	 * sometimes we are called when fill_super() failed and calling</span>
<span class="cm">	 * sync_fs() in such cases does no good.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_any_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">toputinode</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_SUSPENDED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_state_lock</span><span class="p">);</span>
			<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
				<span class="n">dquot_state_flag</span><span class="p">(</span><span class="n">DQUOT_SUSPENDED</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_state_lock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_state_lock</span><span class="p">);</span>
			<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dquot_state_flag</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
			<span class="cm">/* Turning off suspended quotas? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sb_has_quota_suspended</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span>	<span class="o">~</span><span class="n">dquot_state_flag</span><span class="p">(</span>
							<span class="n">DQUOT_SUSPENDED</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_state_lock</span><span class="p">);</span>
				<span class="n">iput</span><span class="p">(</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
				<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_state_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* We still have to keep quota loaded? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb_has_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_SUSPENDED</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Note: these are blocking operations */</span>
		<span class="n">drop_dquot_ref</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="n">invalidate_dquots</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Now all dquots should be invalidated, all writes done so we</span>
<span class="cm">		 * should be only users of the info. No locks needed.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info_dirty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">cnt</span><span class="p">]))</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">dq_op</span><span class="o">-&gt;</span><span class="n">write_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">free_file_info</span><span class="p">)</span>
			<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">free_file_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="n">put_quota_format</span><span class="p">(</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">dqi_format</span><span class="p">);</span>

		<span class="n">toputinode</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span>
			<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">dqi_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">dqi_igrace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">dqi_bgrace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>

	<span class="cm">/* Skip syncing and setting flags if quota files are hidden */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_QUOTA_SYS_FILE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put_inodes</span><span class="p">;</span>

	<span class="cm">/* Sync the superblock so that buffers with quota data are written to</span>
<span class="cm">	 * disk (and so userspace sees correct data afterwards). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span><span class="o">-&gt;</span><span class="n">sync_fs</span><span class="p">)</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span><span class="o">-&gt;</span><span class="n">sync_fs</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sync_blockdev</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">);</span>
	<span class="cm">/* Now the quota files are just ordinary files and we can set the</span>
<span class="cm">	 * inode flags back. Moreover we discard the pagecache so that</span>
<span class="cm">	 * userspace sees the writes we did bypassing the pagecache. We</span>
<span class="cm">	 * must also discard the blockdev buffers so that we see the</span>
<span class="cm">	 * changes done by userspace on the next quotaon() */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">toputinode</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
			<span class="cm">/* If quota was reenabled in the meantime, we have</span>
<span class="cm">			 * nothing to do */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">toputinode</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
				<span class="n">toputinode</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">S_IMMUTABLE</span> <span class="o">|</span>
				  <span class="n">S_NOATIME</span> <span class="o">|</span> <span class="n">S_NOQUOTA</span><span class="p">);</span>
				<span class="n">truncate_inode_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">toputinode</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">,</span>
						     <span class="mi">0</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">toputinode</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
				<span class="n">mark_inode_dirty_sync</span><span class="p">(</span><span class="n">toputinode</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">)</span>
		<span class="n">invalidate_bdev</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">);</span>
<span class="nl">put_inodes:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">toputinode</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* On remount RO, we keep the inode pointer so that we</span>
<span class="cm">			 * can reenable quota on the subsequent remount RW. We</span>
<span class="cm">			 * have to check &#39;flags&#39; variable and not use sb_has_</span>
<span class="cm">			 * function because another quotaon / quotaoff could</span>
<span class="cm">			 * change global state before we got here. We refuse</span>
<span class="cm">			 * to suspend quotas when there is pending delete on</span>
<span class="cm">			 * the quota file... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_SUSPENDED</span><span class="p">))</span>
				<span class="n">iput</span><span class="p">(</span><span class="n">toputinode</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">toputinode</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_disable</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dquot_quota_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dquot_disable</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
			     <span class="n">DQUOT_USAGE_ENABLED</span> <span class="o">|</span> <span class="n">DQUOT_LIMITS_ENABLED</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_quota_off</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	Turn quotas on on a device</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Helper function to turn quotas on when we already have the inode of</span>
<span class="cm"> * quota file and no quota information is loaded.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vfs_load_quota_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format_id</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">quota_format_type</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">find_quota_format</span><span class="p">(</span><span class="n">format_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">quota_info</span> <span class="o">*</span><span class="n">dqopt</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oldflags</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_fmt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_RDONLY</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_fmt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span><span class="o">-&gt;</span><span class="n">quota_write</span> <span class="o">||</span> <span class="o">!</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span><span class="o">-&gt;</span><span class="n">quota_read</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_fmt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Usage always has to be set... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_USAGE_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_fmt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_QUOTA_SYS_FILE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* As we bypass the pagecache we must now flush all the</span>
<span class="cm">		 * dirty data and invalidate caches so that kernel sees</span>
<span class="cm">		 * changes from userspace. It is not enough to just flush</span>
<span class="cm">		 * the quota file since if blocksize &lt; pagesize, invalidation</span>
<span class="cm">		 * of the cache could fail because of other unrelated dirty</span>
<span class="cm">		 * data */</span>
		<span class="n">sync_filesystem</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">invalidate_bdev</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb_has_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_lock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_QUOTA_SYS_FILE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We don&#39;t want quota and atime on quota files (deadlocks</span>
<span class="cm">		 * possible) Also nobody should write to the file - we use</span>
<span class="cm">		 * special IO operations which ignore the immutable bit. */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
		<span class="n">oldflags</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">S_NOATIME</span> <span class="o">|</span> <span class="n">S_IMMUTABLE</span> <span class="o">|</span>
					     <span class="n">S_NOQUOTA</span><span class="p">);</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">|=</span> <span class="n">S_NOQUOTA</span> <span class="o">|</span> <span class="n">S_NOATIME</span> <span class="o">|</span> <span class="n">S_IMMUTABLE</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * When S_NOQUOTA is set, remove dquot references as no more</span>
<span class="cm">		 * references can be added</span>
<span class="cm">		 */</span>
		<span class="n">__dquot_drop</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">igrab</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">type</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">out_lock</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">qf_ops</span><span class="o">-&gt;</span><span class="n">check_quota_file</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_file_init</span><span class="p">;</span>

	<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">qf_ops</span><span class="p">;</span>
	<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">dqi_format</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">dqi_fmt_id</span> <span class="o">=</span> <span class="n">format_id</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">dqi_dirty_list</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqio_mutex</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">type</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">read_file_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqio_mutex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_file_init</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_QUOTA_SYS_FILE</span><span class="p">)</span>
		<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">dqi_flags</span> <span class="o">|=</span> <span class="n">DQF_SYS_FILE</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqio_mutex</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_state_lock</span><span class="p">);</span>
	<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">dquot_state_flag</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_state_lock</span><span class="p">);</span>

	<span class="n">add_dquot_ref</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_file_init:</span>
	<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="nl">out_lock:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oldflags</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
		<span class="cm">/* Set the flags back (in the case of accidental quotaon()</span>
<span class="cm">		 * on a wrong file we don&#39;t want to mess up the flags) */</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">S_NOATIME</span> <span class="o">|</span> <span class="n">S_NOQUOTA</span> <span class="o">|</span> <span class="n">S_IMMUTABLE</span><span class="p">);</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">|=</span> <span class="n">oldflags</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
<span class="nl">out_fmt:</span>
	<span class="n">put_quota_format</span><span class="p">(</span><span class="n">fmt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span> 
<span class="p">}</span>

<span class="cm">/* Reenable quotas on remount RW */</span>
<span class="kt">int</span> <span class="nf">dquot_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">quota_info</span> <span class="o">*</span><span class="n">dqopt</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_suspended</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">inode</span> <span class="o">=</span> <span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
		<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_state_lock</span><span class="p">);</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">dquot_state_flag</span><span class="p">(</span><span class="n">DQUOT_USAGE_ENABLED</span> <span class="o">|</span>
							<span class="n">DQUOT_LIMITS_ENABLED</span><span class="p">,</span>
							<span class="n">cnt</span><span class="p">);</span>
		<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dquot_state_flag</span><span class="p">(</span><span class="n">DQUOT_STATE_FLAGS</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_state_lock</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="n">dquot_generic_flag</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vfs_load_quota_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span>
				<span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">dqi_fmt_id</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_resume</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dquot_quota_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format_id</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">security_quota_on</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/* Quota file not on the same filesystem? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span> <span class="o">!=</span> <span class="n">sb</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EXDEV</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">vfs_load_quota_inode</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
					     <span class="n">format_id</span><span class="p">,</span> <span class="n">DQUOT_USAGE_ENABLED</span> <span class="o">|</span>
					     <span class="n">DQUOT_LIMITS_ENABLED</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_quota_on</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * More powerful function for turning on quotas allowing setting</span>
<span class="cm"> * of individual quota flags</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dquot_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format_id</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">quota_info</span> <span class="o">*</span><span class="n">dqopt</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="cm">/* Just unsuspend quotas? */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_SUSPENDED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flags</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Just updating flags needed? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb_has_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
		<span class="cm">/* Now do a reliable test... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">load_quota</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_USAGE_ENABLED</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sb_has_quota_usage_enabled</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_lock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DQUOT_LIMITS_ENABLED</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sb_has_quota_limits_enabled</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_lock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_state_lock</span><span class="p">);</span>
		<span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">dquot_state_flag</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_state_lock</span><span class="p">);</span>
<span class="nl">out_lock:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqopt</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">load_quota:</span>
	<span class="k">return</span> <span class="n">vfs_load_quota_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">format_id</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_enable</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This function is used when filesystem needs to initialize quotas</span>
<span class="cm"> * during mount time.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dquot_quota_on_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">qf_name</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">format_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="n">dentry</span> <span class="o">=</span> <span class="n">lookup_one_len</span><span class="p">(</span><span class="n">qf_name</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">qf_name</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">security_quota_on</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">vfs_load_quota_inode</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">format_id</span><span class="p">,</span>
				<span class="n">DQUOT_USAGE_ENABLED</span> <span class="o">|</span> <span class="n">DQUOT_LIMITS_ENABLED</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_quota_on_mount</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">qsize_t</span> <span class="nf">qbtos</span><span class="p">(</span><span class="n">qsize_t</span> <span class="n">blocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">blocks</span> <span class="o">&lt;&lt;</span> <span class="n">QIF_DQBLKSIZE_BITS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">qsize_t</span> <span class="nf">stoqb</span><span class="p">(</span><span class="n">qsize_t</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">space</span> <span class="o">+</span> <span class="n">QIF_DQBLKSIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">QIF_DQBLKSIZE_BITS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Generic routine for getting common part of quota structure */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_get_dqblk</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fs_disk_quota</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_dqblk</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">di</span><span class="p">));</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">d_version</span> <span class="o">=</span> <span class="n">FS_DQUOT_VERSION</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">d_flags</span> <span class="o">=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span> <span class="o">==</span> <span class="n">USRQUOTA</span> <span class="o">?</span>
			<span class="n">FS_USER_QUOTA</span> <span class="o">:</span> <span class="n">FS_GROUP_QUOTA</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">d_id</span> <span class="o">=</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_id</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">d_blk_hardlimit</span> <span class="o">=</span> <span class="n">stoqb</span><span class="p">(</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_bhardlimit</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">d_blk_softlimit</span> <span class="o">=</span> <span class="n">stoqb</span><span class="p">(</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_bsoftlimit</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">d_ino_hardlimit</span> <span class="o">=</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_ihardlimit</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">d_ino_softlimit</span> <span class="o">=</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_isoftlimit</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">d_bcount</span> <span class="o">=</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_curspace</span> <span class="o">+</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_rsvspace</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">d_icount</span> <span class="o">=</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_curinodes</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">d_btimer</span> <span class="o">=</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_btime</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">d_itimer</span> <span class="o">=</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_itime</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dquot_get_dqblk</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">qid_t</span> <span class="n">id</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">fs_disk_quota</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">;</span>

	<span class="n">dquot</span> <span class="o">=</span> <span class="n">dqget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquot</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="n">do_get_dqblk</span><span class="p">(</span><span class="n">dquot</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>
	<span class="n">dqput</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_get_dqblk</span><span class="p">);</span>

<span class="cp">#define VFS_FS_DQ_MASK \</span>
<span class="cp">	(FS_DQ_BCOUNT | FS_DQ_BSOFT | FS_DQ_BHARD | \</span>
<span class="cp">	 FS_DQ_ICOUNT | FS_DQ_ISOFT | FS_DQ_IHARD | \</span>
<span class="cp">	 FS_DQ_BTIMER | FS_DQ_ITIMER)</span>

<span class="cm">/* Generic routine for setting common part of quota structure */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_set_dqblk</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fs_disk_quota</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_dqblk</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_dqb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">check_blim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">check_ilim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mem_dqinfo</span> <span class="o">*</span><span class="n">dqi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">VFS_FS_DQ_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BSOFT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_blk_softlimit</span> <span class="o">&gt;</span> <span class="n">dqi</span><span class="o">-&gt;</span><span class="n">dqi_maxblimit</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BHARD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_blk_hardlimit</span> <span class="o">&gt;</span> <span class="n">dqi</span><span class="o">-&gt;</span><span class="n">dqi_maxblimit</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_ISOFT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_ino_softlimit</span> <span class="o">&gt;</span> <span class="n">dqi</span><span class="o">-&gt;</span><span class="n">dqi_maxilimit</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_IHARD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_ino_hardlimit</span> <span class="o">&gt;</span> <span class="n">dqi</span><span class="o">-&gt;</span><span class="n">dqi_maxilimit</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BCOUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_curspace</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">d_bcount</span> <span class="o">-</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_rsvspace</span><span class="p">;</span>
		<span class="n">check_blim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DQ_LASTSET_B</span> <span class="o">+</span> <span class="n">QIF_SPACE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BSOFT</span><span class="p">)</span>
		<span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_bsoftlimit</span> <span class="o">=</span> <span class="n">qbtos</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_blk_softlimit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BHARD</span><span class="p">)</span>
		<span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_bhardlimit</span> <span class="o">=</span> <span class="n">qbtos</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_blk_hardlimit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FS_DQ_BSOFT</span> <span class="o">|</span> <span class="n">FS_DQ_BHARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">check_blim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DQ_LASTSET_B</span> <span class="o">+</span> <span class="n">QIF_BLIMITS_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_ICOUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_curinodes</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">d_icount</span><span class="p">;</span>
		<span class="n">check_ilim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DQ_LASTSET_B</span> <span class="o">+</span> <span class="n">QIF_INODES_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_ISOFT</span><span class="p">)</span>
		<span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_isoftlimit</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">d_ino_softlimit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_IHARD</span><span class="p">)</span>
		<span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_ihardlimit</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">d_ino_hardlimit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FS_DQ_ISOFT</span> <span class="o">|</span> <span class="n">FS_DQ_IHARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">check_ilim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DQ_LASTSET_B</span> <span class="o">+</span> <span class="n">QIF_ILIMITS_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BTIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_btime</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">d_btimer</span><span class="p">;</span>
		<span class="n">check_blim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DQ_LASTSET_B</span> <span class="o">+</span> <span class="n">QIF_BTIME_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_ITIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_itime</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">d_itimer</span><span class="p">;</span>
		<span class="n">check_ilim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DQ_LASTSET_B</span> <span class="o">+</span> <span class="n">QIF_ITIME_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_blim</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_bsoftlimit</span> <span class="o">||</span>
		    <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_curspace</span> <span class="o">&lt;</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_bsoftlimit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_btime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">DQ_BLKS_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BTIMER</span><span class="p">))</span>
			<span class="cm">/* Set grace only if user hasn&#39;t provided his own... */</span>
			<span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_btime</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">()</span> <span class="o">+</span> <span class="n">dqi</span><span class="o">-&gt;</span><span class="n">dqi_bgrace</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_ilim</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_isoftlimit</span> <span class="o">||</span>
		    <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_curinodes</span> <span class="o">&lt;</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_isoftlimit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_itime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">DQ_INODES_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_ITIMER</span><span class="p">))</span>
			<span class="cm">/* Set grace only if user hasn&#39;t provided his own... */</span>
			<span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_itime</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">()</span> <span class="o">+</span> <span class="n">dqi</span><span class="o">-&gt;</span><span class="n">dqi_igrace</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_bhardlimit</span> <span class="o">||</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_bsoftlimit</span> <span class="o">||</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_ihardlimit</span> <span class="o">||</span>
	    <span class="n">dm</span><span class="o">-&gt;</span><span class="n">dqb_isoftlimit</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">DQ_FAKE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DQ_FAKE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_flags</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="n">mark_dquot_dirty</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dquot_set_dqblk</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">qid_t</span> <span class="n">id</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">fs_disk_quota</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dquot</span> <span class="o">=</span> <span class="n">dqget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">do_set_dqblk</span><span class="p">(</span><span class="n">dquot</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>
	<span class="n">dqput</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_set_dqblk</span><span class="p">);</span>

<span class="cm">/* Generic routine for getting common part of quota file information */</span>
<span class="kt">int</span> <span class="nf">dquot_get_dqinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">if_dqinfo</span> <span class="o">*</span><span class="n">ii</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_dqinfo</span> <span class="o">*</span><span class="n">mi</span><span class="p">;</span>
  
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_active</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mi</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">+</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="n">ii</span><span class="o">-&gt;</span><span class="n">dqi_bgrace</span> <span class="o">=</span> <span class="n">mi</span><span class="o">-&gt;</span><span class="n">dqi_bgrace</span><span class="p">;</span>
	<span class="n">ii</span><span class="o">-&gt;</span><span class="n">dqi_igrace</span> <span class="o">=</span> <span class="n">mi</span><span class="o">-&gt;</span><span class="n">dqi_igrace</span><span class="p">;</span>
	<span class="n">ii</span><span class="o">-&gt;</span><span class="n">dqi_flags</span> <span class="o">=</span> <span class="n">mi</span><span class="o">-&gt;</span><span class="n">dqi_flags</span> <span class="o">&amp;</span> <span class="n">DQF_GETINFO_MASK</span><span class="p">;</span>
	<span class="n">ii</span><span class="o">-&gt;</span><span class="n">dqi_valid</span> <span class="o">=</span> <span class="n">IIF_ALL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_get_dqinfo</span><span class="p">);</span>

<span class="cm">/* Generic routine for setting common part of quota file information */</span>
<span class="kt">int</span> <span class="nf">dquot_set_dqinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">if_dqinfo</span> <span class="o">*</span><span class="n">ii</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_dqinfo</span> <span class="o">*</span><span class="n">mi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_has_quota_active</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mi</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">+</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ii</span><span class="o">-&gt;</span><span class="n">dqi_valid</span> <span class="o">&amp;</span> <span class="n">IIF_BGRACE</span><span class="p">)</span>
		<span class="n">mi</span><span class="o">-&gt;</span><span class="n">dqi_bgrace</span> <span class="o">=</span> <span class="n">ii</span><span class="o">-&gt;</span><span class="n">dqi_bgrace</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ii</span><span class="o">-&gt;</span><span class="n">dqi_valid</span> <span class="o">&amp;</span> <span class="n">IIF_IGRACE</span><span class="p">)</span>
		<span class="n">mi</span><span class="o">-&gt;</span><span class="n">dqi_igrace</span> <span class="o">=</span> <span class="n">ii</span><span class="o">-&gt;</span><span class="n">dqi_igrace</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ii</span><span class="o">-&gt;</span><span class="n">dqi_valid</span> <span class="o">&amp;</span> <span class="n">IIF_FLAGS</span><span class="p">)</span>
		<span class="n">mi</span><span class="o">-&gt;</span><span class="n">dqi_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">mi</span><span class="o">-&gt;</span><span class="n">dqi_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DQF_SETINFO_MASK</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">ii</span><span class="o">-&gt;</span><span class="n">dqi_flags</span> <span class="o">&amp;</span> <span class="n">DQF_SETINFO_MASK</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dq_data_lock</span><span class="p">);</span>
	<span class="n">mark_info_dirty</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="cm">/* Force write to disk */</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">dq_op</span><span class="o">-&gt;</span><span class="n">write_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dqonoff_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_set_dqinfo</span><span class="p">);</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">quotactl_ops</span> <span class="n">dquot_quotactl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quota_on</span>	<span class="o">=</span> <span class="n">dquot_quota_on</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quota_off</span>	<span class="o">=</span> <span class="n">dquot_quota_off</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quota_sync</span>	<span class="o">=</span> <span class="n">dquot_quota_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_info</span>	<span class="o">=</span> <span class="n">dquot_get_dqinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_info</span>	<span class="o">=</span> <span class="n">dquot_set_dqinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_dqblk</span>	<span class="o">=</span> <span class="n">dquot_get_dqblk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dqblk</span>	<span class="o">=</span> <span class="n">dquot_set_dqblk</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dquot_quotactl_ops</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_proc_dqstats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ctl_table</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span>
		     <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">lenp</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">dqstats</span><span class="p">.</span><span class="n">stat</span><span class="p">;</span>

	<span class="cm">/* Update global table */</span>
	<span class="n">dqstats</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">percpu_counter_sum_positive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqstats</span><span class="p">.</span><span class="n">counter</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">proc_dointvec</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">fs_dqstats_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;lookups&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dqstats</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="n">DQST_LOOKUPS</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">do_proc_dqstats</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;drops&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dqstats</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="n">DQST_DROPS</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">do_proc_dqstats</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;reads&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dqstats</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="n">DQST_READS</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">do_proc_dqstats</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;writes&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dqstats</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="n">DQST_WRITES</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">do_proc_dqstats</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;cache_hits&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dqstats</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="n">DQST_CACHE_HITS</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">do_proc_dqstats</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;allocated_dquots&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dqstats</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="n">DQST_ALLOC_DQUOTS</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">do_proc_dqstats</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;free_dquots&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dqstats</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="n">DQST_FREE_DQUOTS</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">do_proc_dqstats</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;syncs&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dqstats</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="n">DQST_SYNCS</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">do_proc_dqstats</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#ifdef CONFIG_PRINT_QUOTA_WARNING</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;warnings&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">flag_print_warnings</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">fs_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;quota&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0555</span><span class="p">,</span>
		<span class="p">.</span><span class="n">child</span>		<span class="o">=</span> <span class="n">fs_dqstats_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">sys_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;fs&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0555</span><span class="p">,</span>
		<span class="p">.</span><span class="n">child</span>		<span class="o">=</span> <span class="n">fs_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dquot_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_hash</span><span class="p">,</span> <span class="n">order</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;VFS: Disk quotas %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__DQUOT_VERSION__</span><span class="p">);</span>

	<span class="n">register_sysctl_table</span><span class="p">(</span><span class="n">sys_table</span><span class="p">);</span>

	<span class="n">dquot_cachep</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;dquot&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			<span class="p">(</span><span class="n">SLAB_HWCACHE_ALIGN</span><span class="o">|</span><span class="n">SLAB_RECLAIM_ACCOUNT</span><span class="o">|</span>
				<span class="n">SLAB_MEM_SPREAD</span><span class="o">|</span><span class="n">SLAB_PANIC</span><span class="p">),</span>
			<span class="nb">NULL</span><span class="p">);</span>

	<span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dquot_hash</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dquot_hash</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Cannot create dquot hash table&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_DQST_DQSTAT_LAST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">percpu_counter_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqstats</span><span class="p">.</span><span class="n">counter</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Cannot create dquot stat counters&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Find power-of-two hlist_heads which can fit into allocation */</span>
	<span class="n">nr_hash</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hlist_head</span><span class="p">);</span>
	<span class="n">dq_hash_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dq_hash_bits</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">nr_hash</span> <span class="o">&gt;&gt;</span> <span class="n">dq_hash_bits</span><span class="p">);</span>
	<span class="n">dq_hash_bits</span><span class="o">--</span><span class="p">;</span>

	<span class="n">nr_hash</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">dq_hash_bits</span><span class="p">;</span>
	<span class="n">dq_hash_mask</span> <span class="o">=</span> <span class="n">nr_hash</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_hash</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_HLIST_HEAD</span><span class="p">(</span><span class="n">dquot_hash</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Dquot-cache hash table entries: %ld (order %ld, %ld bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_hash</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">));</span>

	<span class="n">register_shrinker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqcache_shrinker</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">dquot_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
