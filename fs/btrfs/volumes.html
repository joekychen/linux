<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › btrfs › volumes.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>volumes.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2007 Oracle.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public</span>
<span class="cm"> * License v2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public</span>
<span class="cm"> * License along with this program; if not, write to the</span>
<span class="cm"> * Free Software Foundation, Inc., 59 Temple Place - Suite 330,</span>
<span class="cm"> * Boston, MA 021110-1307, USA.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/iocontext.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>
<span class="cp">#include &quot;compat.h&quot;</span>
<span class="cp">#include &quot;ctree.h&quot;</span>
<span class="cp">#include &quot;extent_map.h&quot;</span>
<span class="cp">#include &quot;disk-io.h&quot;</span>
<span class="cp">#include &quot;transaction.h&quot;</span>
<span class="cp">#include &quot;print-tree.h&quot;</span>
<span class="cp">#include &quot;volumes.h&quot;</span>
<span class="cp">#include &quot;async-thread.h&quot;</span>
<span class="cp">#include &quot;check-integrity.h&quot;</span>
<span class="cp">#include &quot;rcu-string.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">init_first_rw_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">btrfs_relocate_sys_chunks</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__btrfs_reset_dev_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">btrfs_dev_stat_print_on_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">uuid_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">fs_uuids</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lock_chunks</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unlock_chunks</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_fs_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">device</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">btrfs_device</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>
		<span class="n">rcu_string_free</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">btrfs_cleanup_fs_uuids</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_uuids</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fs_devices</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">fs_uuids</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">btrfs_fs_devices</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">free_fs_devices</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="nf">__find_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
						   <span class="n">u64</span> <span class="n">devid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">uuid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">==</span> <span class="n">devid</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">uuid</span> <span class="o">||</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">BTRFS_UUID_SIZE</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="nf">find_fsid</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">fsid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fs_uuids</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">fsid</span><span class="p">,</span> <span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="n">BTRFS_FSID_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">fs_devices</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">requeue_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_pending_bios</span> <span class="o">*</span><span class="n">pending_bios</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">tail</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">old_head</span><span class="p">;</span>

	<span class="n">old_head</span> <span class="o">=</span> <span class="n">pending_bios</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">pending_bios</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pending_bios</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span>
		<span class="n">tail</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="n">old_head</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pending_bios</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * we try to collect pending bios for a device so we don&#39;t get a large</span>
<span class="cm"> * number of procs sending bios down to the same device.  This greatly</span>
<span class="cm"> * improves the schedulers ability to collect and merge the bios.</span>
<span class="cm"> *</span>
<span class="cm"> * But, it also turns into a long list of bios to process and that is sure</span>
<span class="cm"> * to eventually make the worker thread block.  The solution here is to</span>
<span class="cm"> * make some progress and then put this work struct back at the end of</span>
<span class="cm"> * the list if the block device is congested.  This way, multiple devices</span>
<span class="cm"> * can make progress from a single worker thread.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline</span> <span class="kt">void</span> <span class="nf">run_scheduled_bios</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">pending</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">backing_dev_info</span> <span class="o">*</span><span class="n">bdi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_pending_bios</span> <span class="o">*</span><span class="n">pending_bios</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">again</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_run</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">batch_run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">limit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_waited</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">force_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sync_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blk_plug</span> <span class="n">plug</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * this function runs all the bios we&#39;ve collected for</span>
<span class="cm">	 * a particular device.  We don&#39;t want to wander off to</span>
<span class="cm">	 * another device without first sending all of these down.</span>
<span class="cm">	 * So, setup a plug here and finish it off before we return</span>
<span class="cm">	 */</span>
	<span class="n">blk_start_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>

	<span class="n">bdi</span> <span class="o">=</span> <span class="n">blk_get_backing_dev_info</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
	<span class="n">fs_info</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">;</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="n">btrfs_async_submit_limit</span><span class="p">(</span><span class="n">fs_info</span><span class="p">);</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>

<span class="nl">loop:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>

<span class="nl">loop_lock:</span>
	<span class="n">num_run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* take all the bios off the list at once and process them</span>
<span class="cm">	 * later on (without the lock held).  But, remember the</span>
<span class="cm">	 * tail and other pointers so the bios can be properly reinserted</span>
<span class="cm">	 * into the list if we hit congestion</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force_reg</span> <span class="o">&amp;&amp;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">pending_sync_bios</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pending_bios</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pending_sync_bios</span><span class="p">;</span>
		<span class="n">force_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pending_bios</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pending_bios</span><span class="p">;</span>
		<span class="n">force_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pending</span> <span class="o">=</span> <span class="n">pending_bios</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">tail</span> <span class="o">=</span> <span class="n">pending_bios</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">pending</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tail</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * if pending was null this time around, no bios need processing</span>
<span class="cm">	 * at all and we can stop.  Otherwise it&#39;ll loop back up again</span>
<span class="cm">	 * and do an additional check so no bios are missed.</span>
<span class="cm">	 *</span>
<span class="cm">	 * device-&gt;running_pending is used to synchronize with the</span>
<span class="cm">	 * schedule_bio code.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pending_sync_bios</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">device</span><span class="o">-&gt;</span><span class="n">pending_bios</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">again</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">running_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">again</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">running_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pending_bios</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pending_bios</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">rmb</span><span class="p">();</span>
		<span class="cm">/* we want to work on both lists, but do more bios on the</span>
<span class="cm">		 * sync list than the regular list</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">num_run</span> <span class="o">&gt;</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pending_bios</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pending_sync_bios</span> <span class="o">&amp;&amp;</span>
		    <span class="n">device</span><span class="o">-&gt;</span><span class="n">pending_sync_bios</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">num_run</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">&amp;&amp;</span> <span class="n">pending_bios</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pending_sync_bios</span> <span class="o">&amp;&amp;</span>
		    <span class="n">device</span><span class="o">-&gt;</span><span class="n">pending_bios</span><span class="p">.</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>
			<span class="n">requeue_list</span><span class="p">(</span><span class="n">pending_bios</span><span class="p">,</span> <span class="n">pending</span><span class="p">,</span> <span class="n">tail</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">loop_lock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cur</span> <span class="o">=</span> <span class="n">pending</span><span class="p">;</span>
		<span class="n">pending</span> <span class="o">=</span> <span class="n">pending</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">nr_async_bios</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">nr_async_bios</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="o">&amp;&amp;</span>
		    <span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">async_submit_wait</span><span class="p">))</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">async_submit_wait</span><span class="p">);</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bi_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * if we&#39;re doing the sync list, record that our</span>
<span class="cm">		 * plug has some sync requests on it</span>
<span class="cm">		 *</span>
<span class="cm">		 * If we&#39;re doing the regular list and there are</span>
<span class="cm">		 * sync requests sitting around, unplug before</span>
<span class="cm">		 * we add more</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pending_bios</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pending_sync_bios</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sync_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sync_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blk_finish_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>
			<span class="n">blk_start_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>
			<span class="n">sync_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">btrfsic_submit_bio</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bi_rw</span><span class="p">,</span> <span class="n">cur</span><span class="p">);</span>
		<span class="n">num_run</span><span class="o">++</span><span class="p">;</span>
		<span class="n">batch_run</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">())</span>
			<span class="n">cond_resched</span><span class="p">();</span>

		<span class="cm">/*</span>
<span class="cm">		 * we made progress, there is more work to do and the bdi</span>
<span class="cm">		 * is now congested.  Back off and let other work structs</span>
<span class="cm">		 * run instead</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;&amp;</span> <span class="n">bdi_write_congested</span><span class="p">(</span><span class="n">bdi</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">batch_run</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">open_devices</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">io_context</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>

			<span class="n">ioc</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">io_context</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * the main goal here is that we don&#39;t want to</span>
<span class="cm">			 * block if we&#39;re going to be able to submit</span>
<span class="cm">			 * more requests without blocking.</span>
<span class="cm">			 *</span>
<span class="cm">			 * This code does two great things, it pokes into</span>
<span class="cm">			 * the elevator code from a filesystem _and_</span>
<span class="cm">			 * it makes assumptions about how batching works.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span> <span class="o">&amp;&amp;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">nr_batch_requests</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">last_waited</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">50UL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">last_waited</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			     <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">last_waited</span> <span class="o">==</span> <span class="n">last_waited</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * we want to go through our batch of</span>
<span class="cm">				 * requests and stop.  So, we copy out</span>
<span class="cm">				 * the ioc-&gt;last_waited time and test</span>
<span class="cm">				 * against it before looping</span>
<span class="cm">				 */</span>
				<span class="n">last_waited</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">last_waited</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">())</span>
					<span class="n">cond_resched</span><span class="p">();</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>
			<span class="n">requeue_list</span><span class="p">(</span><span class="n">pending_bios</span><span class="p">,</span> <span class="n">pending</span><span class="p">,</span> <span class="n">tail</span><span class="p">);</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">running_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>
			<span class="n">btrfs_requeue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* unplug every 64 requests just for good measure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">batch_run</span> <span class="o">%</span> <span class="mi">64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blk_finish_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>
			<span class="n">blk_start_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>
			<span class="n">sync_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cond_resched</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">again</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">loop</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pending_bios</span><span class="p">.</span><span class="n">head</span> <span class="o">||</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">pending_sync_bios</span><span class="p">.</span><span class="n">head</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">loop_lock</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">blk_finish_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pending_bios_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_work</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btrfs_device</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="n">run_scheduled_bios</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">device_list_add</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">btrfs_super_block</span> <span class="o">*</span><span class="n">disk_super</span><span class="p">,</span>
			   <span class="n">u64</span> <span class="n">devid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">**</span><span class="n">fs_devices_ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcu_string</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">found_transid</span> <span class="o">=</span> <span class="n">btrfs_super_generation</span><span class="p">(</span><span class="n">disk_super</span><span class="p">);</span>

	<span class="n">fs_devices</span> <span class="o">=</span> <span class="n">find_fsid</span><span class="p">(</span><span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fs_devices</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_devices</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fs_devices</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fs_devices</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">alloc_list</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fs_uuids</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="n">BTRFS_FSID_SIZE</span><span class="p">);</span>
		<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_devid</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
		<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_trans</span> <span class="o">=</span> <span class="n">found_transid</span><span class="p">;</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>
		<span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">device</span> <span class="o">=</span> <span class="n">__find_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span>
				       <span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">dev_item</span><span class="p">.</span><span class="n">uuid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="n">device</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">device</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we can safely leave the fs_devices entry around */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_stats_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">pending_bios_fn</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">dev_item</span><span class="p">.</span><span class="n">uuid</span><span class="p">,</span>
		       <span class="n">BTRFS_UUID_SIZE</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>

		<span class="n">name</span> <span class="o">=</span> <span class="n">rcu_string_strdup</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_alloc_list</span><span class="p">);</span>

		<span class="cm">/* init readahead state */</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">reada_lock</span><span class="p">);</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">reada_curr_zone</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">reada_in_flight</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">reada_next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">INIT_RADIX_TREE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">reada_zones</span><span class="p">,</span> <span class="n">GFP_NOFS</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">__GFP_WAIT</span><span class="p">);</span>
		<span class="n">INIT_RADIX_TREE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">reada_extents</span><span class="p">,</span> <span class="n">GFP_NOFS</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">__GFP_WAIT</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>
		<span class="n">list_add_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>

		<span class="n">device</span><span class="o">-&gt;</span><span class="n">fs_devices</span> <span class="o">=</span> <span class="n">fs_devices</span><span class="p">;</span>
		<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">num_devices</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">rcu_string_strdup</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">rcu_string_free</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">missing</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">missing_devices</span><span class="o">--</span><span class="p">;</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">missing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found_transid</span> <span class="o">&gt;</span> <span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_trans</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_devid</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
		<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_trans</span> <span class="o">=</span> <span class="n">found_transid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">fs_devices_ret</span> <span class="o">=</span> <span class="n">fs_devices</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="nf">clone_fs_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">orig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">orig_dev</span><span class="p">;</span>

	<span class="n">fs_devices</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fs_devices</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fs_devices</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">alloc_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_devid</span> <span class="o">=</span> <span class="n">orig</span><span class="o">-&gt;</span><span class="n">latest_devid</span><span class="p">;</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_trans</span> <span class="o">=</span> <span class="n">orig</span><span class="o">-&gt;</span><span class="n">latest_trans</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="n">orig</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">));</span>

	<span class="cm">/* We have held the volume lock, it is safe to get the devices. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">orig_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rcu_string</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

		<span class="n">device</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">device</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * This is ok to do without rcu read locked because we hold the</span>
<span class="cm">		 * uuid mutex so nothing we touch in here is going to disappear.</span>
<span class="cm">		 */</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">rcu_string_strdup</span><span class="p">(</span><span class="n">orig_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

		<span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">=</span> <span class="n">orig_dev</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">pending_bios_fn</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">orig_dev</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">));</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_alloc_list</span><span class="p">);</span>

		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">fs_devices</span> <span class="o">=</span> <span class="n">fs_devices</span><span class="p">;</span>
		<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">num_devices</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">fs_devices</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">free_fs_devices</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">btrfs_close_extra_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">latest_bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">latest_devid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">latest_transid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>
<span class="nl">again:</span>
	<span class="cm">/* This is the initialized path, it is safe to release the devices. */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">in_fs_metadata</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">latest_transid</span> <span class="o">||</span>
			    <span class="n">device</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">&gt;</span> <span class="n">latest_transid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">latest_devid</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
				<span class="n">latest_transid</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">generation</span><span class="p">;</span>
				<span class="n">latest_bdev</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blkdev_put</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">open_devices</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_alloc_list</span><span class="p">);</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">rw_devices</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>
		<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">num_devices</span><span class="o">--</span><span class="p">;</span>
		<span class="n">rcu_string_free</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_devices</span> <span class="o">=</span> <span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_bdev</span> <span class="o">=</span> <span class="n">latest_bdev</span><span class="p">;</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_devid</span> <span class="o">=</span> <span class="n">latest_devid</span><span class="p">;</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_trans</span> <span class="o">=</span> <span class="n">latest_transid</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__free_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btrfs_device</span><span class="p">,</span> <span class="n">rcu_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">)</span>
		<span class="n">blkdev_put</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

	<span class="n">rcu_string_free</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btrfs_device</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">rcu_work</span><span class="p">,</span> <span class="n">__free_device</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">rcu_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__btrfs_close_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">new_device</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rcu_string</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">)</span>
			<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">open_devices</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_alloc_list</span><span class="p">);</span>
			<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">rw_devices</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">can_discard</span><span class="p">)</span>
			<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">num_can_discard</span><span class="o">--</span><span class="p">;</span>

		<span class="n">new_device</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_device</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">new_device</span><span class="p">);</span> <span class="cm">/* -ENOMEM */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">new_device</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_device</span><span class="p">));</span>

		<span class="cm">/* Safe because we are under uuid_mutex */</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">rcu_string_strdup</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">name</span><span class="p">);</span> <span class="cm">/* -ENOMEM */</span>
		<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">new_device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">new_device</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">new_device</span><span class="o">-&gt;</span><span class="n">writeable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">new_device</span><span class="o">-&gt;</span><span class="n">in_fs_metadata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">new_device</span><span class="o">-&gt;</span><span class="n">can_discard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_replace_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_device</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>

		<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">rcu</span><span class="p">,</span> <span class="n">free_device</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">open_devices</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">rw_devices</span><span class="p">);</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seeding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_close_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">seed_devices</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__btrfs_close_devices</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seed_devices</span> <span class="o">=</span> <span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">;</span>
		<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seed</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">seed_devices</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_devices</span> <span class="o">=</span> <span class="n">seed_devices</span><span class="p">;</span>
		<span class="n">seed_devices</span> <span class="o">=</span> <span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">;</span>
		<span class="n">__btrfs_close_devices</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">);</span>
		<span class="n">free_fs_devices</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__btrfs_open_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span><span class="p">,</span>
				<span class="n">fmode_t</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">holder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">latest_bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_super_block</span> <span class="o">*</span><span class="n">disk_super</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">latest_devid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">latest_transid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">devid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">seeding</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">|=</span> <span class="n">FMODE_EXCL</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">bdev</span> <span class="o">=</span> <span class="n">blkdev_get_by_path</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">holder</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;open %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">filemap_write_and_wait</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">);</span>
		<span class="n">invalidate_bdev</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
		<span class="n">set_blocksize</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>

		<span class="n">bh</span> <span class="o">=</span> <span class="n">btrfs_read_dev_super</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_close</span><span class="p">;</span>

		<span class="n">disk_super</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_super_block</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
		<span class="n">devid</span> <span class="o">=</span> <span class="n">btrfs_stack_device_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">dev_item</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devid</span> <span class="o">!=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_brelse</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">dev_item</span><span class="p">.</span><span class="n">uuid</span><span class="p">,</span>
			   <span class="n">BTRFS_UUID_SIZE</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error_brelse</span><span class="p">;</span>

		<span class="n">device</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">=</span> <span class="n">btrfs_super_generation</span><span class="p">(</span><span class="n">disk_super</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">latest_transid</span> <span class="o">||</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">&gt;</span> <span class="n">latest_transid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">latest_devid</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
			<span class="n">latest_transid</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">generation</span><span class="p">;</span>
			<span class="n">latest_bdev</span> <span class="o">=</span> <span class="n">bdev</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">btrfs_super_flags</span><span class="p">(</span><span class="n">disk_super</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BTRFS_SUPER_FLAG_SEEDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span> <span class="o">=</span> <span class="o">!</span><span class="n">bdev_read_only</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
			<span class="n">seeding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk_queue_discard</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">can_discard</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">num_can_discard</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">=</span> <span class="n">bdev</span><span class="p">;</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">in_fs_metadata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk_queue_nonrot</span><span class="p">(</span><span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">bdev</span><span class="p">)))</span>
			<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">rotating</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">open_devices</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">rw_devices</span><span class="o">++</span><span class="p">;</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_alloc_list</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">alloc_list</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">continue</span><span class="p">;</span>

<span class="nl">error_brelse:</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
<span class="nl">error_close:</span>
		<span class="n">blkdev_put</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">error:</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">open_devices</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seeding</span> <span class="o">=</span> <span class="n">seeding</span><span class="p">;</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_bdev</span> <span class="o">=</span> <span class="n">latest_bdev</span><span class="p">;</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_devid</span> <span class="o">=</span> <span class="n">latest_devid</span><span class="p">;</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_trans</span> <span class="o">=</span> <span class="n">latest_transid</span><span class="p">;</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">total_rw_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_open_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span><span class="p">,</span>
		       <span class="n">fmode_t</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">holder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">opened</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__btrfs_open_devices</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">holder</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_scan_one_device</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">holder</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">**</span><span class="n">fs_devices_ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_super_block</span> <span class="o">*</span><span class="n">disk_super</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">devid</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">transid</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">|=</span> <span class="n">FMODE_EXCL</span><span class="p">;</span>
	<span class="n">bdev</span> <span class="o">=</span> <span class="n">blkdev_get_by_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">holder</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_blocksize</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_close</span><span class="p">;</span>
	<span class="n">bh</span> <span class="o">=</span> <span class="n">btrfs_read_dev_super</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_close</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">disk_super</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_super_block</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="n">devid</span> <span class="o">=</span> <span class="n">btrfs_stack_device_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">dev_item</span><span class="p">);</span>
	<span class="n">transid</span> <span class="o">=</span> <span class="n">btrfs_super_generation</span><span class="p">(</span><span class="n">disk_super</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;device label %s &quot;</span><span class="p">,</span> <span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;device fsid %pU &quot;</span><span class="p">,</span> <span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;devid %llu transid %llu %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">devid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">transid</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_list_add</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">disk_super</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">fs_devices_ret</span><span class="p">);</span>

	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
<span class="nl">error_close:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>
	<span class="n">blkdev_put</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* helper to account the used device space in the range */</span>
<span class="kt">int</span> <span class="nf">btrfs_account_dev_extents_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">u64</span> <span class="n">start</span><span class="p">,</span>
				   <span class="n">u64</span> <span class="n">end</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_dev_extent</span> <span class="o">*</span><span class="n">dev_extent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">extent_end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>

	<span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">path</span><span class="o">-&gt;</span><span class="n">reada</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_DEV_EXTENT_KEY</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_previous_item</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">objectid</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">btrfs_header_nritems</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_next_leaf</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">btrfs_item_key_to_cpu</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">&lt;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">&gt;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">btrfs_key_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BTRFS_DEV_EXTENT_KEY</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>

		<span class="n">dev_extent</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btrfs_dev_extent</span><span class="p">);</span>
		<span class="n">extent_end</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">btrfs_dev_extent_length</span><span class="p">(</span><span class="n">l</span><span class="p">,</span>
								  <span class="n">dev_extent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">extent_end</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">extent_end</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">)</span>
			<span class="o">*</span><span class="n">length</span> <span class="o">+=</span> <span class="n">extent_end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">extent_end</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span>
			<span class="o">*</span><span class="n">length</span> <span class="o">+=</span> <span class="n">extent_end</span> <span class="o">-</span> <span class="n">key</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">length</span> <span class="o">+=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

<span class="nl">next:</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * find_free_dev_extent - find free space in the specified device</span>
<span class="cm"> * @device:	the device which we search the free space in</span>
<span class="cm"> * @num_bytes:	the size of the free space that we need</span>
<span class="cm"> * @start:	store the start of the free space.</span>
<span class="cm"> * @len:	the size of the free space. that we find, or the size of the max</span>
<span class="cm"> * 		free space if we don&#39;t find suitable free space</span>
<span class="cm"> *</span>
<span class="cm"> * this uses a pretty simple search, the expectation is that it is</span>
<span class="cm"> * called very infrequently and that a given device has a small number</span>
<span class="cm"> * of extents</span>
<span class="cm"> *</span>
<span class="cm"> * @start is used to store the start of the free space if we find. But if we</span>
<span class="cm"> * don&#39;t find suitable free space, it will be used to store the start position</span>
<span class="cm"> * of the max free space.</span>
<span class="cm"> *</span>
<span class="cm"> * @len is used to store the size of the free space that we find.</span>
<span class="cm"> * But if we don&#39;t find suitable free space, it is used to store the size of</span>
<span class="cm"> * the max free space.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">find_free_dev_extent</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">u64</span> <span class="n">num_bytes</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_dev_extent</span> <span class="o">*</span><span class="n">dev_extent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hole_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">max_hole_start</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">max_hole_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">extent_end</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">search_start</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">search_end</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>

	<span class="cm">/* FIXME use last free of some kind */</span>

	<span class="cm">/* we don&#39;t want to overwrite the superblock on the drive,</span>
<span class="cm">	 * so we make sure to start at an offset of at least 1MB</span>
<span class="cm">	 */</span>
	<span class="n">search_start</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">alloc_start</span><span class="p">,</span> <span class="mi">1024ull</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="n">max_hole_start</span> <span class="o">=</span> <span class="n">search_start</span><span class="p">;</span>
	<span class="n">max_hole_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hole_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">search_start</span> <span class="o">&gt;=</span> <span class="n">search_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">path</span><span class="o">-&gt;</span><span class="n">reada</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">search_start</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_DEV_EXTENT_KEY</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_previous_item</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">objectid</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">btrfs_header_nritems</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_next_leaf</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">btrfs_item_key_to_cpu</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">&lt;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">&gt;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">btrfs_key_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BTRFS_DEV_EXTENT_KEY</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">search_start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hole_size</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">-</span> <span class="n">search_start</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hole_size</span> <span class="o">&gt;</span> <span class="n">max_hole_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">max_hole_start</span> <span class="o">=</span> <span class="n">search_start</span><span class="p">;</span>
				<span class="n">max_hole_size</span> <span class="o">=</span> <span class="n">hole_size</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * If this free space is greater than which we need,</span>
<span class="cm">			 * it must be the max free space that we have found</span>
<span class="cm">			 * until now, so max_hole_start must point to the start</span>
<span class="cm">			 * of this free space and the length of this free space</span>
<span class="cm">			 * is stored in max_hole_size. Thus, we return</span>
<span class="cm">			 * max_hole_start and max_hole_size and go back to the</span>
<span class="cm">			 * caller.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hole_size</span> <span class="o">&gt;=</span> <span class="n">num_bytes</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">dev_extent</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btrfs_dev_extent</span><span class="p">);</span>
		<span class="n">extent_end</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">btrfs_dev_extent_length</span><span class="p">(</span><span class="n">l</span><span class="p">,</span>
								  <span class="n">dev_extent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">extent_end</span> <span class="o">&gt;</span> <span class="n">search_start</span><span class="p">)</span>
			<span class="n">search_start</span> <span class="o">=</span> <span class="n">extent_end</span><span class="p">;</span>
<span class="nl">next:</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point, search_start should be the end of</span>
<span class="cm">	 * allocated dev extents, and when shrinking the device,</span>
<span class="cm">	 * search_end may be smaller than search_start.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">search_end</span> <span class="o">&gt;</span> <span class="n">search_start</span><span class="p">)</span>
		<span class="n">hole_size</span> <span class="o">=</span> <span class="n">search_end</span> <span class="o">-</span> <span class="n">search_start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hole_size</span> <span class="o">&gt;</span> <span class="n">max_hole_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_hole_start</span> <span class="o">=</span> <span class="n">search_start</span><span class="p">;</span>
		<span class="n">max_hole_size</span> <span class="o">=</span> <span class="n">hole_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* See above. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hole_size</span> <span class="o">&lt;</span> <span class="n">num_bytes</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">max_hole_start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">max_hole_size</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">btrfs_free_dev_extent</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">found_key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_dev_extent</span> <span class="o">*</span><span class="n">extent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_DEV_EXTENT_KEY</span><span class="p">;</span>
<span class="nl">again:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_previous_item</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">objectid</span><span class="p">,</span>
					  <span class="n">BTRFS_DEV_EXTENT_KEY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">leaf</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">btrfs_item_key_to_cpu</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">found_key</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">extent</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="k">struct</span> <span class="n">btrfs_dev_extent</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">found_key</span><span class="p">.</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">start</span> <span class="o">||</span> <span class="n">found_key</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span>
		       <span class="n">btrfs_dev_extent_length</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">extent</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">);</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">found_key</span><span class="p">;</span>
		<span class="n">btrfs_release_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leaf</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">extent</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="k">struct</span> <span class="n">btrfs_dev_extent</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">btrfs_error</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="s">&quot;Slot search failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">bytes_used</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">len</span> <span class="o">=</span> <span class="n">btrfs_dev_extent_length</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">extent</span><span class="p">);</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">bytes_used</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_lock</span><span class="p">);</span>
		<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_space</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_del_item</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">btrfs_error</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span>
			    <span class="s">&quot;Failed to remove dev extent item&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_alloc_dev_extent</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			   <span class="n">u64</span> <span class="n">chunk_tree</span><span class="p">,</span> <span class="n">u64</span> <span class="n">chunk_objectid</span><span class="p">,</span>
			   <span class="n">u64</span> <span class="n">chunk_offset</span><span class="p">,</span> <span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">u64</span> <span class="n">num_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_dev_extent</span> <span class="o">*</span><span class="n">extent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">in_fs_metadata</span><span class="p">);</span>
	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_DEV_EXTENT_KEY</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_insert_empty_item</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">extent</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">leaf</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">extent</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="k">struct</span> <span class="n">btrfs_dev_extent</span><span class="p">);</span>
	<span class="n">btrfs_set_dev_extent_chunk_tree</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">chunk_tree</span><span class="p">);</span>
	<span class="n">btrfs_set_dev_extent_chunk_objectid</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">chunk_objectid</span><span class="p">);</span>
	<span class="n">btrfs_set_dev_extent_chunk_offset</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">);</span>

	<span class="n">write_extent_buffer</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_tree_uuid</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">btrfs_dev_extent_chunk_tree_uuid</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span>
		    <span class="n">BTRFS_UUID_SIZE</span><span class="p">);</span>

	<span class="n">btrfs_set_dev_extent_length</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">num_bytes</span><span class="p">);</span>
	<span class="n">btrfs_mark_buffer_dirty</span><span class="p">(</span><span class="n">leaf</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">find_next_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
				    <span class="n">u64</span> <span class="n">objectid</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">found_key</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">objectid</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_CHUNK_ITEM_KEY</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Corruption */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_previous_item</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BTRFS_CHUNK_ITEM_KEY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">btrfs_item_key_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">found_key</span><span class="p">,</span>
				      <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found_key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">!=</span> <span class="n">objectid</span><span class="p">)</span>
			<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">chunk</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					       <span class="k">struct</span> <span class="n">btrfs_chunk</span><span class="p">);</span>
			<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">found_key</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span>
				<span class="n">btrfs_chunk_length</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chunk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">find_next_devid</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">objectid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">found_key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">BTRFS_DEV_ITEMS_OBJECTID</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_DEV_ITEM_KEY</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Corruption */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_previous_item</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">BTRFS_DEV_ITEMS_OBJECTID</span><span class="p">,</span>
				  <span class="n">BTRFS_DEV_ITEM_KEY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">objectid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">btrfs_item_key_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">found_key</span><span class="p">,</span>
				      <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="o">*</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">found_key</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * the device information is stored in the chunk root</span>
<span class="cm"> * the btrfs_device struct should be fully filled in</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">btrfs_add_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_dev_item</span> <span class="o">*</span><span class="n">dev_item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">BTRFS_DEV_ITEMS_OBJECTID</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_DEV_ITEM_KEY</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_insert_empty_item</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev_item</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">leaf</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dev_item</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">struct</span> <span class="n">btrfs_dev_item</span><span class="p">);</span>

	<span class="n">btrfs_set_device_id</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">);</span>
	<span class="n">btrfs_set_device_generation</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">btrfs_set_device_type</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">btrfs_set_device_io_align</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">io_align</span><span class="p">);</span>
	<span class="n">btrfs_set_device_io_width</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">io_width</span><span class="p">);</span>
	<span class="n">btrfs_set_device_sector_size</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">);</span>
	<span class="n">btrfs_set_device_total_bytes</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">);</span>
	<span class="n">btrfs_set_device_bytes_used</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">bytes_used</span><span class="p">);</span>
	<span class="n">btrfs_set_device_group</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">btrfs_set_device_seek_speed</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">btrfs_set_device_bandwidth</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">btrfs_set_device_start_offset</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">btrfs_device_uuid</span><span class="p">(</span><span class="n">dev_item</span><span class="p">);</span>
	<span class="n">write_extent_buffer</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">BTRFS_UUID_SIZE</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">btrfs_device_fsid</span><span class="p">(</span><span class="n">dev_item</span><span class="p">);</span>
	<span class="n">write_extent_buffer</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">BTRFS_UUID_SIZE</span><span class="p">);</span>
	<span class="n">btrfs_mark_buffer_dirty</span><span class="p">(</span><span class="n">leaf</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">btrfs_rm_dev_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">trans</span> <span class="o">=</span> <span class="n">btrfs_start_transaction</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">trans</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">trans</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">BTRFS_DEV_ITEMS_OBJECTID</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_DEV_ITEM_KEY</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
	<span class="n">lock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_del_item</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="n">unlock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="n">btrfs_commit_transaction</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_rm_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">device_path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">next_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_super_block</span> <span class="o">*</span><span class="n">disk_super</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">cur_devices</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">all_avail</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">devid</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">num_devices</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dev_uuid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">clear_super</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>

	<span class="n">all_avail</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">avail_data_alloc_bits</span> <span class="o">|</span>
		<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">avail_system_alloc_bits</span> <span class="o">|</span>
		<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">avail_metadata_alloc_bits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">all_avail</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_RAID10</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">num_devices</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;btrfs: unable to go below four devices &quot;</span>
		       <span class="s">&quot;on raid10</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">all_avail</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_RAID1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">num_devices</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;btrfs: unable to go below two &quot;</span>
		       <span class="s">&quot;devices on raid1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">device_path</span><span class="p">,</span> <span class="s">&quot;missing&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">devices</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

		<span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">devices</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * It is safe to read the devices since the volume_mutex</span>
<span class="cm">		 * is held.</span>
<span class="cm">		 */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">in_fs_metadata</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">device</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">disk_super</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;btrfs: no missing devices found to &quot;</span>
			       <span class="s">&quot;remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bdev</span> <span class="o">=</span> <span class="n">blkdev_get_by_path</span><span class="p">(</span><span class="n">device_path</span><span class="p">,</span> <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_EXCL</span><span class="p">,</span>
					  <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">bdev_holder</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">set_blocksize</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
		<span class="n">invalidate_bdev</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">btrfs_read_dev_super</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_close</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">disk_super</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_super_block</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
		<span class="n">devid</span> <span class="o">=</span> <span class="n">btrfs_stack_device_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">dev_item</span><span class="p">);</span>
		<span class="n">dev_uuid</span> <span class="o">=</span> <span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">dev_item</span><span class="p">.</span><span class="n">uuid</span><span class="p">;</span>
		<span class="n">device</span> <span class="o">=</span> <span class="n">btrfs_find_device</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">dev_uuid</span><span class="p">,</span>
					   <span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_brelse</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span> <span class="o">&amp;&amp;</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">rw_devices</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;btrfs: unable to remove the only writeable &quot;</span>
		       <span class="s">&quot;device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_brelse</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_alloc_list</span><span class="p">);</span>
		<span class="n">unlock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">rw_devices</span><span class="o">--</span><span class="p">;</span>
		<span class="n">clear_super</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_shrink_device</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_undo</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_rm_dev_item</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_undo</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_lock</span><span class="p">);</span>
	<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_space</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">-</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">bytes_used</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_lock</span><span class="p">);</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">in_fs_metadata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">btrfs_scrub_cancel_dev</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * the device list mutex makes sure that we don&#39;t change</span>
<span class="cm">	 * the device list while someone else is writing out all</span>
<span class="cm">	 * the device supers.</span>
<span class="cm">	 */</span>

	<span class="n">cur_devices</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>
	<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">num_devices</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">missing</span><span class="p">)</span>
		<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">missing_devices</span><span class="o">--</span><span class="p">;</span>

	<span class="n">next_device</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">btrfs_device</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">==</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">)</span>
		<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span> <span class="o">=</span> <span class="n">next_device</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">==</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_bdev</span><span class="p">)</span>
		<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_bdev</span> <span class="o">=</span> <span class="n">next_device</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">)</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">open_devices</span><span class="o">--</span><span class="p">;</span>

	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">rcu</span><span class="p">,</span> <span class="n">free_device</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>

	<span class="n">num_devices</span> <span class="o">=</span> <span class="n">btrfs_super_num_devices</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">super_copy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">btrfs_set_super_num_devices</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">super_copy</span><span class="p">,</span> <span class="n">num_devices</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur_devices</span><span class="o">-&gt;</span><span class="n">open_devices</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span><span class="p">;</span>
		<span class="n">fs_devices</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">fs_devices</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seed</span> <span class="o">==</span> <span class="n">cur_devices</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">fs_devices</span> <span class="o">=</span> <span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seed</span> <span class="o">=</span> <span class="n">cur_devices</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">;</span>
		<span class="n">cur_devices</span><span class="o">-&gt;</span><span class="n">seed</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">lock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="n">__btrfs_close_devices</span><span class="p">(</span><span class="n">cur_devices</span><span class="p">);</span>
		<span class="n">unlock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="n">free_fs_devices</span><span class="p">(</span><span class="n">cur_devices</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * at this point, the device is zero sized.  We want to</span>
<span class="cm">	 * remove it from the devices list and zero out the old super</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear_super</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* make sure this device isn&#39;t detected as part of</span>
<span class="cm">		 * the FS anymore</span>
<span class="cm">		 */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">));</span>
		<span class="n">set_buffer_dirty</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">sync_dirty_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_brelse:</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
<span class="nl">error_close:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="p">)</span>
		<span class="n">blkdev_put</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_EXCL</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">error_undo:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_alloc_list</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">alloc_list</span><span class="p">);</span>
		<span class="n">unlock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">rw_devices</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">error_brelse</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * does all the dirty work required for changing file system&#39;s UUID.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">btrfs_prepare_sprout</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">old_devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">seed_devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_super_block</span> <span class="o">*</span><span class="n">disk_super</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">super_copy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">super_flags</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seeding</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">seed_devices</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fs_devices</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seed_devices</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">old_devices</span> <span class="o">=</span> <span class="n">clone_fs_devices</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">old_devices</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">seed_devices</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">old_devices</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_devices</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fs_uuids</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">seed_devices</span><span class="p">,</span> <span class="n">fs_devices</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">seed_devices</span><span class="p">));</span>
	<span class="n">seed_devices</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seed_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seed_devices</span><span class="o">-&gt;</span><span class="n">alloc_list</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seed_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>
	<span class="n">list_splice_init_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seed_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span>
			      <span class="n">synchronize_rcu</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>

	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">alloc_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seed_devices</span><span class="o">-&gt;</span><span class="n">alloc_list</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seed_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">fs_devices</span> <span class="o">=</span> <span class="n">seed_devices</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seeding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">num_devices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">open_devices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed_devices</span><span class="p">;</span>

	<span class="n">generate_random_uuid</span><span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="n">BTRFS_FSID_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">disk_super</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="n">BTRFS_FSID_SIZE</span><span class="p">);</span>
	<span class="n">super_flags</span> <span class="o">=</span> <span class="n">btrfs_super_flags</span><span class="p">(</span><span class="n">disk_super</span><span class="p">)</span> <span class="o">&amp;</span>
		      <span class="o">~</span><span class="n">BTRFS_SUPER_FLAG_SEEDING</span><span class="p">;</span>
	<span class="n">btrfs_set_super_flags</span><span class="p">(</span><span class="n">disk_super</span><span class="p">,</span> <span class="n">super_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * strore the expected generation for seed devices in device items.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">btrfs_finish_sprout</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_dev_item</span> <span class="o">*</span><span class="n">dev_item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fs_uuid</span><span class="p">[</span><span class="n">BTRFS_UUID_SIZE</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">dev_uuid</span><span class="p">[</span><span class="n">BTRFS_UUID_SIZE</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">devid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">BTRFS_DEV_ITEMS_OBJECTID</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_DEV_ITEM_KEY</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">leaf</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="nl">next_slot:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">btrfs_header_nritems</span><span class="p">(</span><span class="n">leaf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_next_leaf</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">leaf</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">btrfs_item_key_to_cpu</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">btrfs_release_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">btrfs_item_key_to_cpu</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">!=</span> <span class="n">BTRFS_DEV_ITEMS_OBJECTID</span> <span class="o">||</span>
		    <span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">BTRFS_DEV_ITEM_KEY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">dev_item</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					  <span class="k">struct</span> <span class="n">btrfs_dev_item</span><span class="p">);</span>
		<span class="n">devid</span> <span class="o">=</span> <span class="n">btrfs_device_id</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">);</span>
		<span class="n">read_extent_buffer</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_uuid</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">btrfs_device_uuid</span><span class="p">(</span><span class="n">dev_item</span><span class="p">),</span>
				   <span class="n">BTRFS_UUID_SIZE</span><span class="p">);</span>
		<span class="n">read_extent_buffer</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">fs_uuid</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">btrfs_device_fsid</span><span class="p">(</span><span class="n">dev_item</span><span class="p">),</span>
				   <span class="n">BTRFS_UUID_SIZE</span><span class="p">);</span>
		<span class="n">device</span> <span class="o">=</span> <span class="n">btrfs_find_device</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">dev_uuid</span><span class="p">,</span> <span class="n">fs_uuid</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">);</span> <span class="cm">/* Logic error */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seeding</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">btrfs_set_device_generation</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span>
						    <span class="n">device</span><span class="o">-&gt;</span><span class="n">generation</span><span class="p">);</span>
			<span class="n">btrfs_mark_buffer_dirty</span><span class="p">(</span><span class="n">leaf</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">next_slot</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_init_new_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">device_path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcu_string</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">total_bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">seeding_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seeding</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>

	<span class="n">bdev</span> <span class="o">=</span> <span class="n">blkdev_get_by_path</span><span class="p">(</span><span class="n">device_path</span><span class="p">,</span> <span class="n">FMODE_WRITE</span> <span class="o">|</span> <span class="n">FMODE_EXCL</span><span class="p">,</span>
				  <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">bdev_holder</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seeding</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seeding_dev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_umount</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">filemap_write_and_wait</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">);</span>

	<span class="n">devices</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * we have the volume lock, so we don&#39;t need the extra</span>
<span class="cm">	 * device list mutex while reading the list here.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">==</span> <span class="n">bdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">device</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we can safely leave the fs_devices entry around */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">name</span> <span class="o">=</span> <span class="n">rcu_string_strdup</span><span class="p">(</span><span class="n">device_path</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">find_next_devid</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_string_free</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trans</span> <span class="o">=</span> <span class="n">btrfs_start_transaction</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">trans</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rcu_string_free</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">trans</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk_queue_discard</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">can_discard</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">pending_bios_fn</span><span class="p">;</span>
	<span class="n">generate_random_uuid</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">=</span> <span class="n">trans</span><span class="o">-&gt;</span><span class="n">transid</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">io_width</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">sectorsize</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">io_align</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">sectorsize</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">sectorsize</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">disk_total_bytes</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">=</span> <span class="n">bdev</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">in_fs_metadata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">FMODE_EXCL</span><span class="p">;</span>
	<span class="n">set_blocksize</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seeding_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_RDONLY</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_prepare_sprout</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span> <span class="cm">/* -ENOMEM */</span>
	<span class="p">}</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">fs_devices</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we don&#39;t want write_supers to jump in here with our device</span>
<span class="cm">	 * half setup</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>
	<span class="n">list_add_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_alloc_list</span><span class="p">,</span>
		 <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">alloc_list</span><span class="p">);</span>
	<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">num_devices</span><span class="o">++</span><span class="p">;</span>
	<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">open_devices</span><span class="o">++</span><span class="p">;</span>
	<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">rw_devices</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">can_discard</span><span class="p">)</span>
		<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">num_can_discard</span><span class="o">++</span><span class="p">;</span>
	<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">total_rw_bytes</span> <span class="o">+=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_lock</span><span class="p">);</span>
	<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_space</span> <span class="o">+=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk_queue_nonrot</span><span class="p">(</span><span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">bdev</span><span class="p">)))</span>
		<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">rotating</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">total_bytes</span> <span class="o">=</span> <span class="n">btrfs_super_total_bytes</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">super_copy</span><span class="p">);</span>
	<span class="n">btrfs_set_super_total_bytes</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">super_copy</span><span class="p">,</span>
				    <span class="n">total_bytes</span> <span class="o">+</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">);</span>

	<span class="n">total_bytes</span> <span class="o">=</span> <span class="n">btrfs_super_num_devices</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">super_copy</span><span class="p">);</span>
	<span class="n">btrfs_set_super_num_devices</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">super_copy</span><span class="p">,</span>
				    <span class="n">total_bytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seeding_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">init_first_rw_device</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_trans</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_finish_sprout</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_trans</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_add_device</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_trans</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * we&#39;ve got more storage, clear any full flags on the space</span>
<span class="cm">	 * infos</span>
<span class="cm">	 */</span>
	<span class="n">btrfs_clear_space_info_full</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">);</span>

	<span class="n">unlock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_commit_transaction</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seeding_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_umount</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="cm">/* transaction commit */</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_relocate_sys_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">btrfs_error</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span>
				    <span class="s">&quot;Failed to relocate sys chunks after &quot;</span>
				    <span class="s">&quot;device initialization. This can be fixed &quot;</span>
				    <span class="s">&quot;using the </span><span class="se">\&quot;</span><span class="s">btrfs balance</span><span class="se">\&quot;</span><span class="s"> command.&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">error_trans:</span>
	<span class="n">unlock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="n">btrfs_abort_transaction</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">btrfs_end_transaction</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
	<span class="n">rcu_string_free</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">blkdev_put</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">FMODE_EXCL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seeding_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_umount</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">btrfs_update_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_dev_item</span> <span class="o">*</span><span class="n">dev_item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">BTRFS_DEV_ITEMS_OBJECTID</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_DEV_ITEM_KEY</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">leaf</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dev_item</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">struct</span> <span class="n">btrfs_dev_item</span><span class="p">);</span>

	<span class="n">btrfs_set_device_id</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">);</span>
	<span class="n">btrfs_set_device_type</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">btrfs_set_device_io_align</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">io_align</span><span class="p">);</span>
	<span class="n">btrfs_set_device_io_width</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">io_width</span><span class="p">);</span>
	<span class="n">btrfs_set_device_sector_size</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">);</span>
	<span class="n">btrfs_set_device_total_bytes</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">disk_total_bytes</span><span class="p">);</span>
	<span class="n">btrfs_set_device_bytes_used</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">bytes_used</span><span class="p">);</span>
	<span class="n">btrfs_mark_buffer_dirty</span><span class="p">(</span><span class="n">leaf</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__btrfs_grow_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">u64</span> <span class="n">new_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_super_block</span> <span class="o">*</span><span class="n">super_copy</span> <span class="o">=</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">super_copy</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">old_total</span> <span class="o">=</span> <span class="n">btrfs_super_total_bytes</span><span class="p">(</span><span class="n">super_copy</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">new_size</span> <span class="o">-</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">&lt;=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">btrfs_set_super_total_bytes</span><span class="p">(</span><span class="n">super_copy</span><span class="p">,</span> <span class="n">old_total</span> <span class="o">+</span> <span class="n">diff</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">total_rw_bytes</span> <span class="o">+=</span> <span class="n">diff</span><span class="p">;</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">new_size</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">disk_total_bytes</span> <span class="o">=</span> <span class="n">new_size</span><span class="p">;</span>
	<span class="n">btrfs_clear_space_info_full</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">btrfs_update_device</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_grow_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">u64</span> <span class="n">new_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">lock_chunks</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__btrfs_grow_device</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">new_size</span><span class="p">);</span>
	<span class="n">unlock_chunks</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">btrfs_free_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
			    <span class="n">u64</span> <span class="n">chunk_tree</span><span class="p">,</span> <span class="n">u64</span> <span class="n">chunk_objectid</span><span class="p">,</span>
			    <span class="n">u64</span> <span class="n">chunk_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">;</span>
	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">chunk_objectid</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">chunk_offset</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_CHUNK_ITEM_KEY</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Logic error or corruption */</span>
		<span class="n">btrfs_error</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">,</span>
			    <span class="s">&quot;Failed lookup while freeing chunk.&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_del_item</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">btrfs_error</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span>
			    <span class="s">&quot;Failed to delete chunk item.&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">btrfs_del_sys_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="n">u64</span> <span class="n">chunk_objectid</span><span class="p">,</span> <span class="n">u64</span>
			<span class="n">chunk_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_super_block</span> <span class="o">*</span><span class="n">super_copy</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">super_copy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_disk_key</span> <span class="o">*</span><span class="n">disk_key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_stripes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">array_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">array_size</span> <span class="o">=</span> <span class="n">btrfs_super_sys_array_size</span><span class="p">(</span><span class="n">super_copy</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">super_copy</span><span class="o">-&gt;</span><span class="n">sys_chunk_array</span><span class="p">;</span>
	<span class="n">cur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&lt;</span> <span class="n">array_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">disk_key</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_disk_key</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
		<span class="n">btrfs_disk_key_to_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">disk_key</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">disk_key</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BTRFS_CHUNK_ITEM_KEY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chunk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="p">)(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">num_stripes</span> <span class="o">=</span> <span class="n">btrfs_stack_chunk_num_stripes</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">btrfs_chunk_item_size</span><span class="p">(</span><span class="n">num_stripes</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">==</span> <span class="n">chunk_objectid</span> <span class="o">&amp;&amp;</span>
		    <span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">==</span> <span class="n">chunk_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">array_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">cur</span> <span class="o">+</span> <span class="n">len</span><span class="p">));</span>
			<span class="n">array_size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">btrfs_set_super_sys_array_size</span><span class="p">(</span><span class="n">super_copy</span><span class="p">,</span> <span class="n">array_size</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">cur</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">btrfs_relocate_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="n">chunk_tree</span><span class="p">,</span> <span class="n">u64</span> <span class="n">chunk_objectid</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="n">chunk_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">extent_map_tree</span> <span class="o">*</span><span class="n">em_tree</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">extent_root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_map</span> <span class="o">*</span><span class="n">em</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">;</span>
	<span class="n">extent_root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">extent_root</span><span class="p">;</span>
	<span class="n">em_tree</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">mapping_tree</span><span class="p">.</span><span class="n">map_tree</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_can_relocate</span><span class="p">(</span><span class="n">extent_root</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="cm">/* step one, relocate all the extents inside this chunk */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_relocate_block_group</span><span class="p">(</span><span class="n">extent_root</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">trans</span> <span class="o">=</span> <span class="n">btrfs_start_transaction</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">trans</span><span class="p">));</span>

	<span class="n">lock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * step two, delete the device extents and the</span>
<span class="cm">	 * chunk tree entries</span>
<span class="cm">	 */</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em_tree</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">em</span> <span class="o">=</span> <span class="n">lookup_extent_mapping</span><span class="p">(</span><span class="n">em_tree</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em_tree</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">em</span> <span class="o">||</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">chunk_offset</span> <span class="o">||</span>
	       <span class="n">em</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">chunk_offset</span><span class="p">);</span>
	<span class="n">map</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="p">)</span><span class="n">em</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_free_dev_extent</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">physical</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_update_device</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_free_chunk</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">chunk_tree</span><span class="p">,</span> <span class="n">chunk_objectid</span><span class="p">,</span>
			       <span class="n">chunk_offset</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>

	<span class="n">trace_btrfs_chunk_free</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">,</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_del_sys_chunk</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">chunk_objectid</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_remove_block_group</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">extent_root</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em_tree</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">remove_extent_mapping</span><span class="p">(</span><span class="n">em_tree</span><span class="p">,</span> <span class="n">em</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em_tree</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
	<span class="n">em</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* once for the tree */</span>
	<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>
	<span class="cm">/* once for us */</span>
	<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>

	<span class="n">unlock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="n">btrfs_end_transaction</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">btrfs_relocate_sys_chunks</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">chunk_root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">found_key</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">chunk_tree</span> <span class="o">=</span> <span class="n">chunk_root</span><span class="o">-&gt;</span><span class="n">root_key</span><span class="p">.</span><span class="n">objectid</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">chunk_type</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">retried</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="nl">again:</span>
	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">BTRFS_FIRST_CHUNK_TREE_OBJECTID</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_CHUNK_ITEM_KEY</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">chunk_root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Corruption */</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_previous_item</span><span class="p">(</span><span class="n">chunk_root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">objectid</span><span class="p">,</span>
					  <span class="n">key</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">leaf</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">btrfs_item_key_to_cpu</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">found_key</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">chunk</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				       <span class="k">struct</span> <span class="n">btrfs_chunk</span><span class="p">);</span>
		<span class="n">chunk_type</span> <span class="o">=</span> <span class="n">btrfs_chunk_type</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
		<span class="n">btrfs_release_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chunk_type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_relocate_chunk</span><span class="p">(</span><span class="n">chunk_root</span><span class="p">,</span> <span class="n">chunk_tree</span><span class="p">,</span>
						   <span class="n">found_key</span><span class="p">.</span><span class="n">objectid</span><span class="p">,</span>
						   <span class="n">found_key</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span>
				<span class="n">failed</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found_key</span><span class="p">.</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">found_key</span><span class="p">.</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">failed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">retried</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">retried</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">failed</span> <span class="o">&amp;&amp;</span> <span class="n">retried</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">insert_balance_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">btrfs_balance_control</span> <span class="o">*</span><span class="n">bctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_balance_item</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_disk_balance_args</span> <span class="n">disk_bargs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">trans</span> <span class="o">=</span> <span class="n">btrfs_start_transaction</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">trans</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">trans</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">BTRFS_BALANCE_OBJECTID</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_BALANCE_ITEM_KEY</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_insert_empty_item</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">leaf</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">item</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">struct</span> <span class="n">btrfs_balance_item</span><span class="p">);</span>

	<span class="n">memset_extent_buffer</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">item</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">));</span>

	<span class="n">btrfs_cpu_balance_args_to_disk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_bargs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">btrfs_set_balance_data</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disk_bargs</span><span class="p">);</span>
	<span class="n">btrfs_cpu_balance_args_to_disk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_bargs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">);</span>
	<span class="n">btrfs_set_balance_meta</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disk_bargs</span><span class="p">);</span>
	<span class="n">btrfs_cpu_balance_args_to_disk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_bargs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">);</span>
	<span class="n">btrfs_set_balance_sys</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disk_bargs</span><span class="p">);</span>

	<span class="n">btrfs_set_balance_flags</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">bctl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">btrfs_mark_buffer_dirty</span><span class="p">(</span><span class="n">leaf</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">btrfs_commit_transaction</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">del_balance_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">trans</span> <span class="o">=</span> <span class="n">btrfs_start_transaction</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">trans</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">trans</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">BTRFS_BALANCE_OBJECTID</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_BALANCE_ITEM_KEY</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_del_item</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">btrfs_commit_transaction</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is a heuristic used to reduce the number of chunks balanced on</span>
<span class="cm"> * resume after balance was interrupted.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_balance_args</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_balance_control</span> <span class="o">*</span><span class="n">bctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Turn on soft mode for chunk types that were being converted.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_CONVERT</span><span class="p">)</span>
		<span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BTRFS_BALANCE_ARGS_SOFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_CONVERT</span><span class="p">)</span>
		<span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BTRFS_BALANCE_ARGS_SOFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_CONVERT</span><span class="p">)</span>
		<span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BTRFS_BALANCE_ARGS_SOFT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Turn on usage filter if is not already used.  The idea is</span>
<span class="cm">	 * that chunks that we have already balanced should be</span>
<span class="cm">	 * reasonably full.  Don&#39;t do it for chunks that are being</span>
<span class="cm">	 * converted - that will keep us from relocating unconverted</span>
<span class="cm">	 * (albeit full) chunks.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_USAGE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_CONVERT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BTRFS_BALANCE_ARGS_USAGE</span><span class="p">;</span>
		<span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">usage</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_USAGE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_CONVERT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BTRFS_BALANCE_ARGS_USAGE</span><span class="p">;</span>
		<span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">.</span><span class="n">usage</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_USAGE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_CONVERT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BTRFS_BALANCE_ARGS_USAGE</span><span class="p">;</span>
		<span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">usage</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Should be called with both balance and volume mutexes held to</span>
<span class="cm"> * serialize other volume operations (add_dev/rm_dev/resize) with</span>
<span class="cm"> * restriper.  Same goes for unset_balance_control.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_balance_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_balance_control</span> <span class="o">*</span><span class="n">bctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span> <span class="o">=</span> <span class="n">bctl</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_ctl</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_lock</span><span class="p">);</span>
	<span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_ctl</span> <span class="o">=</span> <span class="n">bctl</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unset_balance_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_balance_control</span> <span class="o">*</span><span class="n">bctl</span> <span class="o">=</span> <span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_ctl</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_ctl</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_lock</span><span class="p">);</span>
	<span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_ctl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_lock</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">bctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Balance filters.  Return 1 if chunk should be filtered out</span>
<span class="cm"> * (should not be balanced).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">chunk_profiles_filter</span><span class="p">(</span><span class="n">u64</span> <span class="n">chunk_type</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">btrfs_balance_args</span> <span class="o">*</span><span class="n">bargs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chunk_type</span> <span class="o">=</span> <span class="n">chunk_to_extended</span><span class="p">(</span><span class="n">chunk_type</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">BTRFS_EXTENDED_PROFILE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bargs</span><span class="o">-&gt;</span><span class="n">profiles</span> <span class="o">&amp;</span> <span class="n">chunk_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">div_factor_fine</span><span class="p">(</span><span class="n">u64</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">factor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">factor</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">factor</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">num</span><span class="p">;</span>

	<span class="n">num</span> <span class="o">*=</span> <span class="n">factor</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">chunk_usage_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span><span class="p">,</span> <span class="n">u64</span> <span class="n">chunk_offset</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">btrfs_balance_args</span> <span class="o">*</span><span class="n">bargs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_block_group_cache</span> <span class="o">*</span><span class="n">cache</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">chunk_used</span><span class="p">,</span> <span class="n">user_thresh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cache</span> <span class="o">=</span> <span class="n">btrfs_lookup_block_group</span><span class="p">(</span><span class="n">fs_info</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">);</span>
	<span class="n">chunk_used</span> <span class="o">=</span> <span class="n">btrfs_block_group_used</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">item</span><span class="p">);</span>

	<span class="n">user_thresh</span> <span class="o">=</span> <span class="n">div_factor_fine</span><span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">bargs</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chunk_used</span> <span class="o">&lt;</span> <span class="n">user_thresh</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">btrfs_put_block_group</span><span class="p">(</span><span class="n">cache</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">chunk_devid_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">btrfs_balance_args</span> <span class="o">*</span><span class="n">bargs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_stripe</span> <span class="o">*</span><span class="n">stripe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_stripes</span> <span class="o">=</span> <span class="n">btrfs_chunk_num_stripes</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_stripes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stripe</span> <span class="o">=</span> <span class="n">btrfs_stripe_nr</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">btrfs_stripe_devid</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">stripe</span><span class="p">)</span> <span class="o">==</span> <span class="n">bargs</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* [pstart, pend) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">chunk_drange_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="n">chunk_offset</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">btrfs_balance_args</span> <span class="o">*</span><span class="n">bargs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_stripe</span> <span class="o">*</span><span class="n">stripe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_stripes</span> <span class="o">=</span> <span class="n">btrfs_chunk_num_stripes</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">stripe_offset</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stripe_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">factor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bargs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_DEVID</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btrfs_chunk_type</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BTRFS_BLOCK_GROUP_DUP</span> <span class="o">|</span>
	     <span class="n">BTRFS_BLOCK_GROUP_RAID1</span> <span class="o">|</span> <span class="n">BTRFS_BLOCK_GROUP_RAID10</span><span class="p">))</span>
		<span class="n">factor</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">factor</span> <span class="o">=</span> <span class="n">num_stripes</span> <span class="o">/</span> <span class="n">factor</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_stripes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stripe</span> <span class="o">=</span> <span class="n">btrfs_stripe_nr</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">btrfs_stripe_devid</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">stripe</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bargs</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">stripe_offset</span> <span class="o">=</span> <span class="n">btrfs_stripe_offset</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">stripe</span><span class="p">);</span>
		<span class="n">stripe_length</span> <span class="o">=</span> <span class="n">btrfs_chunk_length</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">stripe_length</span><span class="p">,</span> <span class="n">factor</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stripe_offset</span> <span class="o">&lt;</span> <span class="n">bargs</span><span class="o">-&gt;</span><span class="n">pend</span> <span class="o">&amp;&amp;</span>
		    <span class="n">stripe_offset</span> <span class="o">+</span> <span class="n">stripe_length</span> <span class="o">&gt;</span> <span class="n">bargs</span><span class="o">-&gt;</span><span class="n">pstart</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* [vstart, vend) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">chunk_vrange_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="n">chunk_offset</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">btrfs_balance_args</span> <span class="o">*</span><span class="n">bargs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chunk_offset</span> <span class="o">&lt;</span> <span class="n">bargs</span><span class="o">-&gt;</span><span class="n">vend</span> <span class="o">&amp;&amp;</span>
	    <span class="n">chunk_offset</span> <span class="o">+</span> <span class="n">btrfs_chunk_length</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bargs</span><span class="o">-&gt;</span><span class="n">vstart</span><span class="p">)</span>
		<span class="cm">/* at least part of the chunk is inside this vrange */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">chunk_soft_convert_filter</span><span class="p">(</span><span class="n">u64</span> <span class="n">chunk_type</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">btrfs_balance_args</span> <span class="o">*</span><span class="n">bargs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bargs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_CONVERT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chunk_type</span> <span class="o">=</span> <span class="n">chunk_to_extended</span><span class="p">(</span><span class="n">chunk_type</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">BTRFS_EXTENDED_PROFILE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bargs</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">==</span> <span class="n">chunk_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">should_balance_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">,</span> <span class="n">u64</span> <span class="n">chunk_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_balance_control</span> <span class="o">*</span><span class="n">bctl</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_ctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_balance_args</span> <span class="o">*</span><span class="n">bargs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">chunk_type</span> <span class="o">=</span> <span class="n">btrfs_chunk_type</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>

	<span class="cm">/* type filter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">chunk_type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_TYPE_MASK</span><span class="p">)</span> <span class="o">&amp;</span>
	      <span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_TYPE_MASK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chunk_type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_DATA</span><span class="p">)</span>
		<span class="n">bargs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chunk_type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_SYSTEM</span><span class="p">)</span>
		<span class="n">bargs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chunk_type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_METADATA</span><span class="p">)</span>
		<span class="n">bargs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">;</span>

	<span class="cm">/* profiles filter */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bargs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_PROFILES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">chunk_profiles_filter</span><span class="p">(</span><span class="n">chunk_type</span><span class="p">,</span> <span class="n">bargs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* usage filter */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bargs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_USAGE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">chunk_usage_filter</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">,</span> <span class="n">bargs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* devid filter */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bargs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_DEVID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">chunk_devid_filter</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">bargs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* drange filter, makes sense only with devid filter */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bargs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_DRANGE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">chunk_drange_filter</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">,</span> <span class="n">bargs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* vrange filter */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bargs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_VRANGE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">chunk_vrange_filter</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">,</span> <span class="n">bargs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* soft profile changing mode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bargs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_SOFT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">chunk_soft_convert_filter</span><span class="p">(</span><span class="n">chunk_type</span><span class="p">,</span> <span class="n">bargs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">div_factor</span><span class="p">(</span><span class="n">u64</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">factor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">factor</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">num</span> <span class="o">*=</span> <span class="n">factor</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__btrfs_balance</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_balance_control</span> <span class="o">*</span><span class="n">bctl</span> <span class="o">=</span> <span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_ctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">chunk_root</span> <span class="o">=</span> <span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">dev_root</span> <span class="o">=</span> <span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">old_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">size_to_free</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">found_key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enospc_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">counting</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* step one make some room on all the devices */</span>
	<span class="n">devices</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old_size</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">;</span>
		<span class="n">size_to_free</span> <span class="o">=</span> <span class="n">div_factor</span><span class="p">(</span><span class="n">old_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">size_to_free</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size_to_free</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span> <span class="o">||</span>
		    <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">-</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">bytes_used</span> <span class="o">&gt;</span> <span class="n">size_to_free</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_shrink_device</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">old_size</span> <span class="o">-</span> <span class="n">size_to_free</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>

		<span class="n">trans</span> <span class="o">=</span> <span class="n">btrfs_start_transaction</span><span class="p">(</span><span class="n">dev_root</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">trans</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_grow_device</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">old_size</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>

		<span class="n">btrfs_end_transaction</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">dev_root</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* step two, relocate all the chunks */</span>
	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* zero out stat counters */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_lock</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">));</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_lock</span><span class="p">);</span>
<span class="nl">again:</span>
	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">BTRFS_FIRST_CHUNK_TREE_OBJECTID</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_CHUNK_ITEM_KEY</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">counting</span> <span class="o">&amp;&amp;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_pause_req</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_cancel_req</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">chunk_root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * this shouldn&#39;t happen, it means the last relocate</span>
<span class="cm">		 * failed</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span> <span class="cm">/* FIXME break ? */</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_previous_item</span><span class="p">(</span><span class="n">chunk_root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="n">BTRFS_CHUNK_ITEM_KEY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">leaf</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">btrfs_item_key_to_cpu</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">found_key</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found_key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">!=</span> <span class="n">key</span><span class="p">.</span><span class="n">objectid</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* chunk zero is special */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found_key</span><span class="p">.</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">chunk</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btrfs_chunk</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">counting</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_lock</span><span class="p">);</span>
			<span class="n">bctl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">considered</span><span class="o">++</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">should_balance_chunk</span><span class="p">(</span><span class="n">chunk_root</span><span class="p">,</span> <span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span>
					   <span class="n">found_key</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">btrfs_release_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">loop</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">counting</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_lock</span><span class="p">);</span>
			<span class="n">bctl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">expected</span><span class="o">++</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_lock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">loop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_relocate_chunk</span><span class="p">(</span><span class="n">chunk_root</span><span class="p">,</span>
					   <span class="n">chunk_root</span><span class="o">-&gt;</span><span class="n">root_key</span><span class="p">.</span><span class="n">objectid</span><span class="p">,</span>
					   <span class="n">found_key</span><span class="p">.</span><span class="n">objectid</span><span class="p">,</span>
					   <span class="n">found_key</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enospc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_lock</span><span class="p">);</span>
			<span class="n">bctl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">completed</span><span class="o">++</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_lock</span><span class="p">);</span>
		<span class="p">}</span>
<span class="nl">loop:</span>
		<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">found_key</span><span class="p">.</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">counting</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">btrfs_release_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
		<span class="n">counting</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enospc_errors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;btrfs: %d enospc errors during balance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">enospc_errors</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * alloc_profile_is_valid - see if a given profile is valid and reduced</span>
<span class="cm"> * @flags: profile to validate</span>
<span class="cm"> * @extended: if true @flags is treated as an extended profile</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_profile_is_valid</span><span class="p">(</span><span class="n">u64</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">extended</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">extended</span> <span class="o">?</span> <span class="n">BTRFS_EXTENDED_PROFILE_MASK</span> <span class="o">:</span>
			       <span class="n">BTRFS_BLOCK_GROUP_PROFILE_MASK</span><span class="p">);</span>

	<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BTRFS_BLOCK_GROUP_TYPE_MASK</span><span class="p">;</span>

	<span class="cm">/* 1) check that all other bits are zeroed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* 2) see if profile is reduced */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">!</span><span class="n">extended</span><span class="p">;</span> <span class="cm">/* &quot;0&quot; is valid for usual profiles */</span>

	<span class="cm">/* true if exactly one bit set */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">balance_need_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* cancel requested || normal exit path */</span>
	<span class="k">return</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_cancel_req</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_pause_req</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		 <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_cancel_req</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__cancel_balance</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">unset_balance_control</span><span class="p">(</span><span class="n">fs_info</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">del_balance_item</span><span class="p">(</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">tree_root</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">update_ioctl_balance_args</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">btrfs_ioctl_balance_args</span> <span class="o">*</span><span class="n">bargs</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Should be called with both balance and volume mutexes held</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">btrfs_balance</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_balance_control</span> <span class="o">*</span><span class="n">bctl</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">btrfs_ioctl_balance_args</span> <span class="o">*</span><span class="n">bargs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span> <span class="o">=</span> <span class="n">bctl</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">allowed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btrfs_fs_closing</span><span class="p">(</span><span class="n">fs_info</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_pause_req</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_cancel_req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">allowed</span> <span class="o">=</span> <span class="n">btrfs_super_incompat_flags</span><span class="p">(</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">super_copy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">allowed</span> <span class="o">&amp;</span> <span class="n">BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS</span><span class="p">)</span>
		<span class="n">mixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In case of mixed groups both data and meta should be picked,</span>
<span class="cm">	 * and identical options should be given for both of them.</span>
<span class="cm">	 */</span>
	<span class="n">allowed</span> <span class="o">=</span> <span class="n">BTRFS_BALANCE_DATA</span> <span class="o">|</span> <span class="n">BTRFS_BALANCE_METADATA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mixed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">allowed</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_DATA</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_METADATA</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;btrfs: with mixed groups data and &quot;</span>
			       <span class="s">&quot;metadata balance options must be the same</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">allowed</span> <span class="o">=</span> <span class="n">BTRFS_AVAIL_ALLOC_BIT_SINGLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">num_devices</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">allowed</span> <span class="o">|=</span> <span class="n">BTRFS_BLOCK_GROUP_DUP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">num_devices</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">allowed</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BTRFS_BLOCK_GROUP_RAID0</span> <span class="o">|</span> <span class="n">BTRFS_BLOCK_GROUP_RAID1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">allowed</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BTRFS_BLOCK_GROUP_RAID0</span> <span class="o">|</span> <span class="n">BTRFS_BLOCK_GROUP_RAID1</span> <span class="o">|</span>
				<span class="n">BTRFS_BLOCK_GROUP_RAID10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_CONVERT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">alloc_profile_is_valid</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">target</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">allowed</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;btrfs: unable to start balance with target &quot;</span>
		       <span class="s">&quot;data profile %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_CONVERT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">alloc_profile_is_valid</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">target</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">allowed</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;btrfs: unable to start balance with target &quot;</span>
		       <span class="s">&quot;metadata profile %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_CONVERT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">alloc_profile_is_valid</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">.</span><span class="n">target</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">allowed</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;btrfs: unable to start balance with target &quot;</span>
		       <span class="s">&quot;system profile %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allow dup&#39;ed data chunks only in mixed mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mixed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_CONVERT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">target</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_DUP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;btrfs: dup for data is not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allow to reduce meta or sys integrity only if force set */</span>
	<span class="n">allowed</span> <span class="o">=</span> <span class="n">BTRFS_BLOCK_GROUP_DUP</span> <span class="o">|</span> <span class="n">BTRFS_BLOCK_GROUP_RAID1</span> <span class="o">|</span>
			<span class="n">BTRFS_BLOCK_GROUP_RAID10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_CONVERT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">avail_system_alloc_bits</span> <span class="o">&amp;</span> <span class="n">allowed</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">.</span><span class="n">target</span> <span class="o">&amp;</span> <span class="n">allowed</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_ARGS_CONVERT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">avail_metadata_alloc_bits</span> <span class="o">&amp;</span> <span class="n">allowed</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">target</span> <span class="o">&amp;</span> <span class="n">allowed</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_FORCE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;btrfs: force reducing metadata &quot;</span>
			       <span class="s">&quot;integrity</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;btrfs: balance will reduce metadata &quot;</span>
			       <span class="s">&quot;integrity, use force if you want this</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">insert_balance_item</span><span class="p">(</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">tree_root</span><span class="p">,</span> <span class="n">bctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_RESUME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">);</span>
		<span class="n">set_balance_control</span><span class="p">(</span><span class="n">bctl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_lock</span><span class="p">);</span>
		<span class="n">update_balance_args</span><span class="p">(</span><span class="n">bctl</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_running</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__btrfs_balance</span><span class="p">(</span><span class="n">fs_info</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_running</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bargs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">bargs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bargs</span><span class="p">));</span>
		<span class="n">update_ioctl_balance_args</span><span class="p">(</span><span class="n">fs_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bargs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ECANCELED</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">balance_need_close</span><span class="p">(</span><span class="n">fs_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__cancel_balance</span><span class="p">(</span><span class="n">fs_info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_wait_q</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTRFS_BALANCE_RESUME</span><span class="p">)</span>
		<span class="n">__cancel_balance</span><span class="p">(</span><span class="n">fs_info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bctl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">balance_kthread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_balance_control</span> <span class="o">*</span><span class="n">bctl</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_balance_control</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span> <span class="o">=</span> <span class="n">bctl</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">volume_mutex</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>

	<span class="n">set_balance_control</span><span class="p">(</span><span class="n">bctl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btrfs_test_opt</span><span class="p">(</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">tree_root</span><span class="p">,</span> <span class="n">SKIP_BALANCE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;btrfs: force skipping balance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;btrfs: continuing balance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_balance</span><span class="p">(</span><span class="n">bctl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">volume_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_recover_balance</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">tree_root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_balance_control</span> <span class="o">*</span><span class="n">bctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_balance_item</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_disk_balance_args</span> <span class="n">disk_bargs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">bctl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bctl</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">BTRFS_BALANCE_OBJECTID</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_BALANCE_ITEM_KEY</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">tree_root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_bctl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ret = -ENOENT; */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_bctl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">leaf</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">item</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">struct</span> <span class="n">btrfs_balance_item</span><span class="p">);</span>

	<span class="n">bctl</span><span class="o">-&gt;</span><span class="n">fs_info</span> <span class="o">=</span> <span class="n">tree_root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">;</span>
	<span class="n">bctl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">btrfs_balance_flags</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="o">|</span> <span class="n">BTRFS_BALANCE_RESUME</span><span class="p">;</span>

	<span class="n">btrfs_balance_data</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disk_bargs</span><span class="p">);</span>
	<span class="n">btrfs_disk_balance_args_to_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disk_bargs</span><span class="p">);</span>
	<span class="n">btrfs_balance_meta</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disk_bargs</span><span class="p">);</span>
	<span class="n">btrfs_disk_balance_args_to_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disk_bargs</span><span class="p">);</span>
	<span class="n">btrfs_balance_sys</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disk_bargs</span><span class="p">);</span>
	<span class="n">btrfs_disk_balance_args_to_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bctl</span><span class="o">-&gt;</span><span class="n">sys</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disk_bargs</span><span class="p">);</span>

	<span class="n">tsk</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">balance_kthread</span><span class="p">,</span> <span class="n">bctl</span><span class="p">,</span> <span class="s">&quot;btrfs-balance&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tsk</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tsk</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out_bctl:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bctl</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_pause_balance</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_ctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_running</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_pause_req</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>

		<span class="n">wait_event</span><span class="p">(</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_wait_q</span><span class="p">,</span>
			   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_running</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>
		<span class="cm">/* we are good with balance_ctl ripped off from under us */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_running</span><span class="p">));</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_pause_req</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_cancel_balance</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_ctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_cancel_req</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * if we are running just wait and return, balance item is</span>
<span class="cm">	 * deleted in btrfs_balance in this case</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_running</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_wait_q</span><span class="p">,</span>
			   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_running</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* __cancel_balance needs volume_mutex */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">volume_mutex</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_ctl</span><span class="p">)</span>
			<span class="n">__cancel_balance</span><span class="p">(</span><span class="n">fs_info</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">volume_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_ctl</span> <span class="o">||</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_running</span><span class="p">));</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_cancel_req</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">balance_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * shrinking a device means finding all of the device extents past</span>
<span class="cm"> * the new size, and then following the back refs to the chunks.</span>
<span class="cm"> * The chunk relocation code actually frees the device extent</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">btrfs_shrink_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">u64</span> <span class="n">new_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_dev_extent</span> <span class="o">*</span><span class="n">dev_extent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">chunk_tree</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">chunk_objectid</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">chunk_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">retried</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_super_block</span> <span class="o">*</span><span class="n">super_copy</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">super_copy</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">old_total</span> <span class="o">=</span> <span class="n">btrfs_super_total_bytes</span><span class="p">(</span><span class="n">super_copy</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">old_size</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">-</span> <span class="n">new_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">&gt;=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">path</span><span class="o">-&gt;</span><span class="n">reada</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">lock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">new_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">total_rw_bytes</span> <span class="o">-=</span> <span class="n">diff</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_lock</span><span class="p">);</span>
		<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_space</span> <span class="o">-=</span> <span class="n">diff</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">unlock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>

<span class="nl">again:</span>
	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_DEV_EXTENT_KEY</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_previous_item</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">btrfs_release_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">l</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">btrfs_item_key_to_cpu</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">!=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">btrfs_release_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_extent</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btrfs_dev_extent</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">btrfs_dev_extent_length</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">dev_extent</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="n">new_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">btrfs_release_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chunk_tree</span> <span class="o">=</span> <span class="n">btrfs_dev_extent_chunk_tree</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">dev_extent</span><span class="p">);</span>
		<span class="n">chunk_objectid</span> <span class="o">=</span> <span class="n">btrfs_dev_extent_chunk_objectid</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">dev_extent</span><span class="p">);</span>
		<span class="n">chunk_offset</span> <span class="o">=</span> <span class="n">btrfs_dev_extent_chunk_offset</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">dev_extent</span><span class="p">);</span>
		<span class="n">btrfs_release_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_relocate_chunk</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">chunk_tree</span><span class="p">,</span> <span class="n">chunk_objectid</span><span class="p">,</span>
					   <span class="n">chunk_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span>
			<span class="n">failed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">offset</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">failed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">retried</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">retried</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">failed</span> <span class="o">&amp;&amp;</span> <span class="n">retried</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="n">lock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>

		<span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">old_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span><span class="p">)</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">total_rw_bytes</span> <span class="o">+=</span> <span class="n">diff</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_lock</span><span class="p">);</span>
		<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_space</span> <span class="o">+=</span> <span class="n">diff</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_lock</span><span class="p">);</span>
		<span class="n">unlock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Shrinking succeeded, else we would be at &quot;done&quot;. */</span>
	<span class="n">trans</span> <span class="o">=</span> <span class="n">btrfs_start_transaction</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">trans</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">trans</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">disk_total_bytes</span> <span class="o">=</span> <span class="n">new_size</span><span class="p">;</span>
	<span class="cm">/* Now btrfs_update_device() will change the on-disk size. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_update_device</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unlock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="n">btrfs_end_transaction</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="n">old_total</span><span class="p">);</span>
	<span class="n">btrfs_set_super_total_bytes</span><span class="p">(</span><span class="n">super_copy</span><span class="p">,</span> <span class="n">old_total</span> <span class="o">-</span> <span class="n">diff</span><span class="p">);</span>
	<span class="n">unlock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="n">btrfs_end_transaction</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">btrfs_add_system_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">btrfs_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">item_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_super_block</span> <span class="o">*</span><span class="n">super_copy</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">super_copy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_disk_key</span> <span class="n">disk_key</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">array_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">array_size</span> <span class="o">=</span> <span class="n">btrfs_super_sys_array_size</span><span class="p">(</span><span class="n">super_copy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">array_size</span> <span class="o">+</span> <span class="n">item_size</span> <span class="o">&gt;</span> <span class="n">BTRFS_SYSTEM_CHUNK_ARRAY_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">super_copy</span><span class="o">-&gt;</span><span class="n">sys_chunk_array</span> <span class="o">+</span> <span class="n">array_size</span><span class="p">;</span>
	<span class="n">btrfs_cpu_key_to_disk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_key</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disk_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disk_key</span><span class="p">));</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disk_key</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">item_size</span><span class="p">);</span>
	<span class="n">item_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disk_key</span><span class="p">);</span>
	<span class="n">btrfs_set_super_sys_array_size</span><span class="p">(</span><span class="n">super_copy</span><span class="p">,</span> <span class="n">array_size</span> <span class="o">+</span> <span class="n">item_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sort the devices in descending order by max_avail, total_avail</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">btrfs_cmp_device_info</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">btrfs_device_info</span> <span class="o">*</span><span class="n">di_a</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">btrfs_device_info</span> <span class="o">*</span><span class="n">di_b</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di_a</span><span class="o">-&gt;</span><span class="n">max_avail</span> <span class="o">&gt;</span> <span class="n">di_b</span><span class="o">-&gt;</span><span class="n">max_avail</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di_a</span><span class="o">-&gt;</span><span class="n">max_avail</span> <span class="o">&lt;</span> <span class="n">di_b</span><span class="o">-&gt;</span><span class="n">max_avail</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di_a</span><span class="o">-&gt;</span><span class="n">total_avail</span> <span class="o">&gt;</span> <span class="n">di_b</span><span class="o">-&gt;</span><span class="n">total_avail</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di_a</span><span class="o">-&gt;</span><span class="n">total_avail</span> <span class="o">&lt;</span> <span class="n">di_b</span><span class="o">-&gt;</span><span class="n">total_avail</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__btrfs_alloc_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">extent_root</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">**</span><span class="n">map_ret</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="o">*</span><span class="n">num_bytes_out</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">stripe_size_out</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">u64</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">extent_root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_map_tree</span> <span class="o">*</span><span class="n">em_tree</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_map</span> <span class="o">*</span><span class="n">em</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_device_info</span> <span class="o">*</span><span class="n">devices_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">total_avail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_stripes</span><span class="p">;</span>	<span class="cm">/* total number of stripes to allocate */</span>
	<span class="kt">int</span> <span class="n">sub_stripes</span><span class="p">;</span>	<span class="cm">/* sub_stripes info for map */</span>
	<span class="kt">int</span> <span class="n">dev_stripes</span><span class="p">;</span>	<span class="cm">/* stripes per dev */</span>
	<span class="kt">int</span> <span class="n">devs_max</span><span class="p">;</span>		<span class="cm">/* max devs to use */</span>
	<span class="kt">int</span> <span class="n">devs_min</span><span class="p">;</span>		<span class="cm">/* min devs needed */</span>
	<span class="kt">int</span> <span class="n">devs_increment</span><span class="p">;</span>	<span class="cm">/* ndevs has to be a multiple of this */</span>
	<span class="kt">int</span> <span class="n">ncopies</span><span class="p">;</span>		<span class="cm">/* how many copies to data has */</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">max_stripe_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">max_chunk_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stripe_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">num_bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ndevs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">alloc_profile_is_valid</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">alloc_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="n">sub_stripes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev_stripes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">devs_increment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ncopies</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">devs_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* 0 == as many as possible */</span>
	<span class="n">devs_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * define the properties of each RAID type.</span>
<span class="cm">	 * FIXME: move this to a global table and use it in all RAID</span>
<span class="cm">	 * calculation code</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BTRFS_BLOCK_GROUP_DUP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_stripes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ncopies</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">devs_max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BTRFS_BLOCK_GROUP_RAID0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">devs_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BTRFS_BLOCK_GROUP_RAID1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">devs_increment</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ncopies</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">devs_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">devs_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BTRFS_BLOCK_GROUP_RAID10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sub_stripes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">devs_increment</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ncopies</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">devs_min</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devs_max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_stripe_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">max_chunk_size</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">max_stripe_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_METADATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for larger filesystems, use larger metadata chunks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">total_rw_bytes</span> <span class="o">&gt;</span> <span class="mi">50ULL</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
			<span class="n">max_stripe_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">max_stripe_size</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">max_chunk_size</span> <span class="o">=</span> <span class="n">max_stripe_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_stripe_size</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">max_chunk_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">max_stripe_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;btrfs: invalid chunk type 0x%llx requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">type</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* we don&#39;t want a chunk larger than 10% of writeable space */</span>
	<span class="n">max_chunk_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">div_factor</span><span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">total_rw_bytes</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			     <span class="n">max_chunk_size</span><span class="p">);</span>

	<span class="n">devices_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">devices_info</span><span class="p">)</span> <span class="o">*</span> <span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">rw_devices</span><span class="p">,</span>
			       <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devices_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cur</span> <span class="o">=</span> <span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">alloc_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * in the first pass through the devices list, we gather information</span>
<span class="cm">	 * about the available holes on each device.</span>
<span class="cm">	 */</span>
	<span class="n">ndevs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cur</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">alloc_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">max_avail</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">dev_offset</span><span class="p">;</span>

		<span class="n">device</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btrfs_device</span><span class="p">,</span> <span class="n">dev_alloc_list</span><span class="p">);</span>

		<span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;btrfs: read-only device in alloc_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">in_fs_metadata</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">&gt;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">bytes_used</span><span class="p">)</span>
			<span class="n">total_avail</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">-</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">bytes_used</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">total_avail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* If there is no space on this device, skip it. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total_avail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">find_free_dev_extent</span><span class="p">(</span><span class="n">device</span><span class="p">,</span>
					   <span class="n">max_stripe_size</span> <span class="o">*</span> <span class="n">dev_stripes</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_avail</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">max_avail</span> <span class="o">=</span> <span class="n">max_stripe_size</span> <span class="o">*</span> <span class="n">dev_stripes</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max_avail</span> <span class="o">&lt;</span> <span class="n">BTRFS_STRIPE_LEN</span> <span class="o">*</span> <span class="n">dev_stripes</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">devices_info</span><span class="p">[</span><span class="n">ndevs</span><span class="p">].</span><span class="n">dev_offset</span> <span class="o">=</span> <span class="n">dev_offset</span><span class="p">;</span>
		<span class="n">devices_info</span><span class="p">[</span><span class="n">ndevs</span><span class="p">].</span><span class="n">max_avail</span> <span class="o">=</span> <span class="n">max_avail</span><span class="p">;</span>
		<span class="n">devices_info</span><span class="p">[</span><span class="n">ndevs</span><span class="p">].</span><span class="n">total_avail</span> <span class="o">=</span> <span class="n">total_avail</span><span class="p">;</span>
		<span class="n">devices_info</span><span class="p">[</span><span class="n">ndevs</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
		<span class="o">++</span><span class="n">ndevs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * now sort the devices by hole size / available space</span>
<span class="cm">	 */</span>
	<span class="n">sort</span><span class="p">(</span><span class="n">devices_info</span><span class="p">,</span> <span class="n">ndevs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_device_info</span><span class="p">),</span>
	     <span class="n">btrfs_cmp_device_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* round down to number of usable stripes */</span>
	<span class="n">ndevs</span> <span class="o">-=</span> <span class="n">ndevs</span> <span class="o">%</span> <span class="n">devs_increment</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndevs</span> <span class="o">&lt;</span> <span class="n">devs_increment</span> <span class="o">*</span> <span class="n">sub_stripes</span> <span class="o">||</span> <span class="n">ndevs</span> <span class="o">&lt;</span> <span class="n">devs_min</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devs_max</span> <span class="o">&amp;&amp;</span> <span class="n">ndevs</span> <span class="o">&gt;</span> <span class="n">devs_max</span><span class="p">)</span>
		<span class="n">ndevs</span> <span class="o">=</span> <span class="n">devs_max</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * the primary goal is to maximize the number of stripes, so use as many</span>
<span class="cm">	 * devices as possible, even if the stripes are not maximum sized.</span>
<span class="cm">	 */</span>
	<span class="n">stripe_size</span> <span class="o">=</span> <span class="n">devices_info</span><span class="p">[</span><span class="n">ndevs</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">max_avail</span><span class="p">;</span>
	<span class="n">num_stripes</span> <span class="o">=</span> <span class="n">ndevs</span> <span class="o">*</span> <span class="n">dev_stripes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stripe_size</span> <span class="o">*</span> <span class="n">ndevs</span> <span class="o">&gt;</span> <span class="n">max_chunk_size</span> <span class="o">*</span> <span class="n">ncopies</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stripe_size</span> <span class="o">=</span> <span class="n">max_chunk_size</span> <span class="o">*</span> <span class="n">ncopies</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">stripe_size</span><span class="p">,</span> <span class="n">ndevs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">do_div</span><span class="p">(</span><span class="n">stripe_size</span><span class="p">,</span> <span class="n">dev_stripes</span><span class="p">);</span>

	<span class="cm">/* align to BTRFS_STRIPE_LEN */</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">stripe_size</span><span class="p">,</span> <span class="n">BTRFS_STRIPE_LEN</span><span class="p">);</span>
	<span class="n">stripe_size</span> <span class="o">*=</span> <span class="n">BTRFS_STRIPE_LEN</span><span class="p">;</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">map_lookup_size</span><span class="p">(</span><span class="n">num_stripes</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span> <span class="o">=</span> <span class="n">num_stripes</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ndevs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">dev_stripes</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dev_stripes</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
			<span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">devices_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>
			<span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">physical</span> <span class="o">=</span> <span class="n">devices_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_offset</span> <span class="o">+</span>
						   <span class="n">j</span> <span class="o">*</span> <span class="n">stripe_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">=</span> <span class="n">extent_root</span><span class="o">-&gt;</span><span class="n">sectorsize</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span> <span class="o">=</span> <span class="n">BTRFS_STRIPE_LEN</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">io_align</span> <span class="o">=</span> <span class="n">BTRFS_STRIPE_LEN</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">io_width</span> <span class="o">=</span> <span class="n">BTRFS_STRIPE_LEN</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">sub_stripes</span> <span class="o">=</span> <span class="n">sub_stripes</span><span class="p">;</span>

	<span class="o">*</span><span class="n">map_ret</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span>
	<span class="n">num_bytes</span> <span class="o">=</span> <span class="n">stripe_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_stripes</span> <span class="o">/</span> <span class="n">ncopies</span><span class="p">);</span>

	<span class="o">*</span><span class="n">stripe_size_out</span> <span class="o">=</span> <span class="n">stripe_size</span><span class="p">;</span>
	<span class="o">*</span><span class="n">num_bytes_out</span> <span class="o">=</span> <span class="n">num_bytes</span><span class="p">;</span>

	<span class="n">trace_btrfs_chunk_alloc</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">num_bytes</span><span class="p">);</span>

	<span class="n">em</span> <span class="o">=</span> <span class="n">alloc_extent_map</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">em</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">em</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="p">)</span><span class="n">map</span><span class="p">;</span>
	<span class="n">em</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">em</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">num_bytes</span><span class="p">;</span>
	<span class="n">em</span><span class="o">-&gt;</span><span class="n">block_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">em</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">=</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">em_tree</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">extent_root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">mapping_tree</span><span class="p">.</span><span class="n">map_tree</span><span class="p">;</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em_tree</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">add_extent_mapping</span><span class="p">(</span><span class="n">em_tree</span><span class="p">,</span> <span class="n">em</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em_tree</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_make_block_group</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">extent_root</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
				     <span class="n">BTRFS_FIRST_CHUNK_TREE_OBJECTID</span><span class="p">,</span>
				     <span class="n">start</span><span class="p">,</span> <span class="n">num_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">dev_offset</span><span class="p">;</span>

		<span class="n">device</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">dev_offset</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">physical</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_alloc_dev_extent</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="o">-&gt;</span><span class="n">root_key</span><span class="p">.</span><span class="n">objectid</span><span class="p">,</span>
				<span class="n">BTRFS_FIRST_CHUNK_TREE_OBJECTID</span><span class="p">,</span>
				<span class="n">start</span><span class="p">,</span> <span class="n">dev_offset</span><span class="p">,</span> <span class="n">stripe_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">btrfs_abort_transaction</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">extent_root</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">devices_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">devices_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__finish_chunk_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">extent_root</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="n">u64</span> <span class="n">chunk_offset</span><span class="p">,</span>
				<span class="n">u64</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">u64</span> <span class="n">stripe_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">dev_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">chunk_root</span> <span class="o">=</span> <span class="n">extent_root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_stripe</span> <span class="o">*</span><span class="n">stripe</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">item_size</span> <span class="o">=</span> <span class="n">btrfs_chunk_item_size</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">chunk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">item_size</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chunk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">bytes_used</span> <span class="o">+=</span> <span class="n">stripe_size</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_update_device</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">extent_root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_lock</span><span class="p">);</span>
	<span class="n">extent_root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_space</span> <span class="o">-=</span> <span class="p">(</span><span class="n">stripe_size</span> <span class="o">*</span>
						   <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">extent_root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_lock</span><span class="p">);</span>

	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stripe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">stripe</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">dev_offset</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">physical</span><span class="p">;</span>

		<span class="n">btrfs_set_stack_stripe_devid</span><span class="p">(</span><span class="n">stripe</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">);</span>
		<span class="n">btrfs_set_stack_stripe_offset</span><span class="p">(</span><span class="n">stripe</span><span class="p">,</span> <span class="n">dev_offset</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">stripe</span><span class="o">-&gt;</span><span class="n">dev_uuid</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">BTRFS_UUID_SIZE</span><span class="p">);</span>
		<span class="n">stripe</span><span class="o">++</span><span class="p">;</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">btrfs_set_stack_chunk_length</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">);</span>
	<span class="n">btrfs_set_stack_chunk_owner</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">extent_root</span><span class="o">-&gt;</span><span class="n">root_key</span><span class="p">.</span><span class="n">objectid</span><span class="p">);</span>
	<span class="n">btrfs_set_stack_chunk_stripe_len</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span><span class="p">);</span>
	<span class="n">btrfs_set_stack_chunk_type</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">btrfs_set_stack_chunk_num_stripes</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">);</span>
	<span class="n">btrfs_set_stack_chunk_io_align</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span><span class="p">);</span>
	<span class="n">btrfs_set_stack_chunk_io_width</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span><span class="p">);</span>
	<span class="n">btrfs_set_stack_chunk_sector_size</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">extent_root</span><span class="o">-&gt;</span><span class="n">sectorsize</span><span class="p">);</span>
	<span class="n">btrfs_set_stack_chunk_sub_stripes</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">sub_stripes</span><span class="p">);</span>

	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">BTRFS_FIRST_CHUNK_TREE_OBJECTID</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_CHUNK_ITEM_KEY</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">chunk_offset</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_insert_item</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">chunk_root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">item_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TODO: Cleanup of inserted chunk root in case of</span>
<span class="cm">		 * failure.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_add_system_chunk</span><span class="p">(</span><span class="n">chunk_root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span>
					     <span class="n">item_size</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Chunk allocation falls into two parts. The first part does works</span>
<span class="cm"> * that make the new allocated chunk useable, but not do any operation</span>
<span class="cm"> * that modifies the chunk tree. The second part does the works that</span>
<span class="cm"> * require modifying the chunk tree. This division is important for the</span>
<span class="cm"> * bootstrap process of adding storage to a seed btrfs.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">btrfs_alloc_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">extent_root</span><span class="p">,</span> <span class="n">u64</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">chunk_offset</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">chunk_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stripe_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">chunk_root</span> <span class="o">=</span> <span class="n">extent_root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">find_next_chunk</span><span class="p">(</span><span class="n">chunk_root</span><span class="p">,</span> <span class="n">BTRFS_FIRST_CHUNK_TREE_OBJECTID</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">chunk_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__btrfs_alloc_chunk</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">extent_root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chunk_size</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">stripe_size</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__finish_chunk_alloc</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">extent_root</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">,</span>
				   <span class="n">chunk_size</span><span class="p">,</span> <span class="n">stripe_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">init_first_rw_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">chunk_offset</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sys_chunk_offset</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">chunk_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sys_chunk_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stripe_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sys_stripe_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">alloc_profile</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="n">sys_map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">extent_root</span> <span class="o">=</span> <span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">extent_root</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">find_next_chunk</span><span class="p">(</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">,</span>
			      <span class="n">BTRFS_FIRST_CHUNK_TREE_OBJECTID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chunk_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">alloc_profile</span> <span class="o">=</span> <span class="n">BTRFS_BLOCK_GROUP_METADATA</span> <span class="o">|</span>
				<span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">avail_metadata_alloc_bits</span><span class="p">;</span>
	<span class="n">alloc_profile</span> <span class="o">=</span> <span class="n">btrfs_reduce_alloc_profile</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">alloc_profile</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__btrfs_alloc_chunk</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">extent_root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chunk_size</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">stripe_size</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">,</span> <span class="n">alloc_profile</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sys_chunk_offset</span> <span class="o">=</span> <span class="n">chunk_offset</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">;</span>

	<span class="n">alloc_profile</span> <span class="o">=</span> <span class="n">BTRFS_BLOCK_GROUP_SYSTEM</span> <span class="o">|</span>
				<span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">avail_system_alloc_bits</span><span class="p">;</span>
	<span class="n">alloc_profile</span> <span class="o">=</span> <span class="n">btrfs_reduce_alloc_profile</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">alloc_profile</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__btrfs_alloc_chunk</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">extent_root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sys_map</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">sys_chunk_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sys_stripe_size</span><span class="p">,</span>
				  <span class="n">sys_chunk_offset</span><span class="p">,</span> <span class="n">alloc_profile</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_add_device</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Modifying chunk tree needs allocating new blocks from both</span>
<span class="cm">	 * system block group and metadata block group. So we only can</span>
<span class="cm">	 * do operations require modifying the chunk tree after both</span>
<span class="cm">	 * block groups were created.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__finish_chunk_alloc</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">extent_root</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">,</span>
				   <span class="n">chunk_size</span><span class="p">,</span> <span class="n">stripe_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__finish_chunk_alloc</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">extent_root</span><span class="p">,</span> <span class="n">sys_map</span><span class="p">,</span>
				   <span class="n">sys_chunk_offset</span><span class="p">,</span> <span class="n">sys_chunk_size</span><span class="p">,</span>
				   <span class="n">sys_stripe_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">abort:</span>
	<span class="n">btrfs_abort_transaction</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_chunk_readonly</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="n">u64</span> <span class="n">chunk_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">extent_map</span> <span class="o">*</span><span class="n">em</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_mapping_tree</span> <span class="o">*</span><span class="n">map_tree</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">mapping_tree</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">readonly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map_tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">em</span> <span class="o">=</span> <span class="n">lookup_extent_mapping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map_tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">,</span> <span class="n">chunk_offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map_tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">em</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btrfs_test_opt</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">DEGRADED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">map</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="p">)</span><span class="n">em</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">writeable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">readonly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">readonly</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">btrfs_mapping_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_mapping_tree</span> <span class="o">*</span><span class="n">tree</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">extent_map_tree_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">btrfs_mapping_tree_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_mapping_tree</span> <span class="o">*</span><span class="n">tree</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">extent_map</span> <span class="o">*</span><span class="n">em</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">em</span> <span class="o">=</span> <span class="n">lookup_extent_mapping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">em</span><span class="p">)</span>
			<span class="n">remove_extent_mapping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">,</span> <span class="n">em</span><span class="p">);</span>
		<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">em</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">em</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
		<span class="cm">/* once for us */</span>
		<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>
		<span class="cm">/* once for the tree */</span>
		<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_num_copies</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_mapping_tree</span> <span class="o">*</span><span class="n">map_tree</span><span class="p">,</span> <span class="n">u64</span> <span class="n">logical</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">extent_map</span> <span class="o">*</span><span class="n">em</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_map_tree</span> <span class="o">*</span><span class="n">em_tree</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">map_tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em_tree</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">em</span> <span class="o">=</span> <span class="n">lookup_extent_mapping</span><span class="p">(</span><span class="n">em_tree</span><span class="p">,</span> <span class="n">logical</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em_tree</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">em</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">em</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">logical</span> <span class="o">||</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">logical</span><span class="p">);</span>
	<span class="n">map</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="p">)</span><span class="n">em</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BTRFS_BLOCK_GROUP_DUP</span> <span class="o">|</span> <span class="n">BTRFS_BLOCK_GROUP_RAID1</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_RAID10</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">sub_stripes</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_live_mirror</span><span class="p">(</span><span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">optimal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">optimal</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">optimal</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">first</span> <span class="o">+</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* we couldn&#39;t find one that doesn&#39;t fail.  Just return something</span>
<span class="cm">	 * and the io error handling code will clean up eventually</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">optimal</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__btrfs_map_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_mapping_tree</span> <span class="o">*</span><span class="n">map_tree</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">,</span>
			     <span class="n">u64</span> <span class="n">logical</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">length</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">btrfs_bio</span> <span class="o">**</span><span class="n">bbio_ret</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">mirror_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">extent_map</span> <span class="o">*</span><span class="n">em</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_map_tree</span> <span class="o">*</span><span class="n">em_tree</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">map_tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stripe_offset</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stripe_end_offset</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stripe_nr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stripe_nr_orig</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stripe_nr_end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stripe_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_stripes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_bio</span> <span class="o">*</span><span class="n">bbio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em_tree</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">em</span> <span class="o">=</span> <span class="n">lookup_extent_mapping</span><span class="p">(</span><span class="n">em_tree</span><span class="p">,</span> <span class="n">logical</span><span class="p">,</span> <span class="o">*</span><span class="n">length</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em_tree</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">em</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;unable to find logical %llu len %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">logical</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">length</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">em</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">logical</span> <span class="o">||</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">logical</span><span class="p">);</span>
	<span class="n">map</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="p">)</span><span class="n">em</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">logical</span> <span class="o">-</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mirror_num</span> <span class="o">&gt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">)</span>
		<span class="n">mirror_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">stripe_nr</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * stripe_nr counts the total number of stripes we have to stride</span>
<span class="cm">	 * to get to this block</span>
<span class="cm">	 */</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">stripe_nr</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span><span class="p">);</span>

	<span class="n">stripe_offset</span> <span class="o">=</span> <span class="n">stripe_nr</span> <span class="o">*</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">stripe_offset</span><span class="p">);</span>

	<span class="cm">/* stripe_offset is the offset of this block in its stripe*/</span>
	<span class="n">stripe_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">stripe_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">REQ_DISCARD</span><span class="p">)</span>
		<span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="o">*</span><span class="n">length</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_PROFILE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we limit the length of each bio to what fits in a stripe */</span>
		<span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
				<span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span> <span class="o">-</span> <span class="n">stripe_offset</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bbio_ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">num_stripes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stripe_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stripe_nr_orig</span> <span class="o">=</span> <span class="n">stripe_nr</span><span class="p">;</span>
	<span class="n">stripe_nr_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="o">*</span><span class="n">length</span> <span class="o">+</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">stripe_nr_end</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span><span class="p">);</span>
	<span class="n">stripe_end_offset</span> <span class="o">=</span> <span class="n">stripe_nr_end</span> <span class="o">*</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span> <span class="o">-</span>
			    <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="o">*</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_RAID0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">REQ_DISCARD</span><span class="p">)</span>
			<span class="n">num_stripes</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">,</span>
					    <span class="n">stripe_nr_end</span> <span class="o">-</span> <span class="n">stripe_nr_orig</span><span class="p">);</span>
		<span class="n">stripe_index</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">stripe_nr</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_RAID1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">REQ_WRITE</span> <span class="o">|</span> <span class="n">REQ_DISCARD</span><span class="p">))</span>
			<span class="n">num_stripes</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mirror_num</span><span class="p">)</span>
			<span class="n">stripe_index</span> <span class="o">=</span> <span class="n">mirror_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">stripe_index</span> <span class="o">=</span> <span class="n">find_live_mirror</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">,</span>
					    <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">%</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">);</span>
			<span class="n">mirror_num</span> <span class="o">=</span> <span class="n">stripe_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_DUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">REQ_WRITE</span> <span class="o">|</span> <span class="n">REQ_DISCARD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">num_stripes</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mirror_num</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stripe_index</span> <span class="o">=</span> <span class="n">mirror_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mirror_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_RAID10</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">factor</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span> <span class="o">/</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">sub_stripes</span><span class="p">;</span>

		<span class="n">stripe_index</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">stripe_nr</span><span class="p">,</span> <span class="n">factor</span><span class="p">);</span>
		<span class="n">stripe_index</span> <span class="o">*=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">sub_stripes</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">REQ_WRITE</span><span class="p">)</span>
			<span class="n">num_stripes</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">sub_stripes</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">REQ_DISCARD</span><span class="p">)</span>
			<span class="n">num_stripes</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">sub_stripes</span> <span class="o">*</span>
					    <span class="p">(</span><span class="n">stripe_nr_end</span> <span class="o">-</span> <span class="n">stripe_nr_orig</span><span class="p">),</span>
					    <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mirror_num</span><span class="p">)</span>
			<span class="n">stripe_index</span> <span class="o">+=</span> <span class="n">mirror_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">old_stripe_index</span> <span class="o">=</span> <span class="n">stripe_index</span><span class="p">;</span>
			<span class="n">stripe_index</span> <span class="o">=</span> <span class="n">find_live_mirror</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">stripe_index</span><span class="p">,</span>
					      <span class="n">map</span><span class="o">-&gt;</span><span class="n">sub_stripes</span><span class="p">,</span> <span class="n">stripe_index</span> <span class="o">+</span>
					      <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">%</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">sub_stripes</span><span class="p">);</span>
			<span class="n">mirror_num</span> <span class="o">=</span> <span class="n">stripe_index</span> <span class="o">-</span> <span class="n">old_stripe_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * after this do_div call, stripe_nr is the number of stripes</span>
<span class="cm">		 * on this device we have to walk to find the data, and</span>
<span class="cm">		 * stripe_index is the number of our device in the stripe array</span>
<span class="cm">		 */</span>
		<span class="n">stripe_index</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">stripe_nr</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">);</span>
		<span class="n">mirror_num</span> <span class="o">=</span> <span class="n">stripe_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">stripe_index</span> <span class="o">&gt;=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">);</span>

	<span class="n">bbio</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">btrfs_bio_size</span><span class="p">(</span><span class="n">num_stripes</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bbio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bbio</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">REQ_DISCARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">factor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">sub_stripes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">stripes_per_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">remaining_stripes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">last_stripe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">BTRFS_BLOCK_GROUP_RAID0</span> <span class="o">|</span> <span class="n">BTRFS_BLOCK_GROUP_RAID10</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_RAID0</span><span class="p">)</span>
				<span class="n">sub_stripes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">sub_stripes</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">sub_stripes</span><span class="p">;</span>

			<span class="n">factor</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span> <span class="o">/</span> <span class="n">sub_stripes</span><span class="p">;</span>
			<span class="n">stripes_per_dev</span> <span class="o">=</span> <span class="n">div_u64_rem</span><span class="p">(</span><span class="n">stripe_nr_end</span> <span class="o">-</span>
						      <span class="n">stripe_nr_orig</span><span class="p">,</span>
						      <span class="n">factor</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">remaining_stripes</span><span class="p">);</span>
			<span class="n">div_u64_rem</span><span class="p">(</span><span class="n">stripe_nr_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">last_stripe</span><span class="p">);</span>
			<span class="n">last_stripe</span> <span class="o">*=</span> <span class="n">sub_stripes</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_stripes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">physical</span> <span class="o">=</span>
				<span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">stripe_index</span><span class="p">].</span><span class="n">physical</span> <span class="o">+</span>
				<span class="n">stripe_offset</span> <span class="o">+</span> <span class="n">stripe_nr</span> <span class="o">*</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span><span class="p">;</span>
			<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">stripe_index</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BTRFS_BLOCK_GROUP_RAID0</span> <span class="o">|</span>
					 <span class="n">BTRFS_BLOCK_GROUP_RAID10</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">stripes_per_dev</span> <span class="o">*</span>
							  <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">sub_stripes</span> <span class="o">&lt;</span> <span class="n">remaining_stripes</span><span class="p">)</span>
					<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">+=</span>
						<span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * Special for the first stripe and</span>
<span class="cm">				 * the last stripe:</span>
<span class="cm">				 *</span>
<span class="cm">				 * |-------|...|-------|</span>
<span class="cm">				 *     |----------|</span>
<span class="cm">				 *    off     end_off</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">sub_stripes</span><span class="p">)</span>
					<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">-=</span>
						<span class="n">stripe_offset</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">stripe_index</span> <span class="o">&gt;=</span> <span class="n">last_stripe</span> <span class="o">&amp;&amp;</span>
				    <span class="n">stripe_index</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">last_stripe</span> <span class="o">+</span>
						     <span class="n">sub_stripes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
					<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">-=</span>
						<span class="n">stripe_end_offset</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">sub_stripes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">stripe_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="o">*</span><span class="n">length</span><span class="p">;</span>

			<span class="n">stripe_index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stripe_index</span> <span class="o">==</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* This could only happen for RAID0/10 */</span>
				<span class="n">stripe_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">stripe_nr</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_stripes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">physical</span> <span class="o">=</span>
				<span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">stripe_index</span><span class="p">].</span><span class="n">physical</span> <span class="o">+</span>
				<span class="n">stripe_offset</span> <span class="o">+</span>
				<span class="n">stripe_nr</span> <span class="o">*</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span><span class="p">;</span>
			<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span>
				<span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">stripe_index</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>
			<span class="n">stripe_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">REQ_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BTRFS_BLOCK_GROUP_RAID1</span> <span class="o">|</span>
				 <span class="n">BTRFS_BLOCK_GROUP_RAID10</span> <span class="o">|</span>
				 <span class="n">BTRFS_BLOCK_GROUP_DUP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">max_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">bbio_ret</span> <span class="o">=</span> <span class="n">bbio</span><span class="p">;</span>
	<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">num_stripes</span> <span class="o">=</span> <span class="n">num_stripes</span><span class="p">;</span>
	<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">max_errors</span> <span class="o">=</span> <span class="n">max_errors</span><span class="p">;</span>
	<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">mirror_num</span> <span class="o">=</span> <span class="n">mirror_num</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_map_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_mapping_tree</span> <span class="o">*</span><span class="n">map_tree</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">,</span>
		      <span class="n">u64</span> <span class="n">logical</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">length</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">btrfs_bio</span> <span class="o">**</span><span class="n">bbio_ret</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mirror_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__btrfs_map_block</span><span class="p">(</span><span class="n">map_tree</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="n">logical</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">bbio_ret</span><span class="p">,</span>
				 <span class="n">mirror_num</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_rmap_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_mapping_tree</span> <span class="o">*</span><span class="n">map_tree</span><span class="p">,</span>
		     <span class="n">u64</span> <span class="n">chunk_start</span><span class="p">,</span> <span class="n">u64</span> <span class="n">physical</span><span class="p">,</span> <span class="n">u64</span> <span class="n">devid</span><span class="p">,</span>
		     <span class="n">u64</span> <span class="o">**</span><span class="n">logical</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">naddrs</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">stripe_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">extent_map_tree</span> <span class="o">*</span><span class="n">em_tree</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">map_tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_map</span> <span class="o">*</span><span class="n">em</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bytenr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stripe_nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em_tree</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">em</span> <span class="o">=</span> <span class="n">lookup_extent_mapping</span><span class="p">(</span><span class="n">em_tree</span><span class="p">,</span> <span class="n">chunk_start</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em_tree</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">em</span> <span class="o">||</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">!=</span> <span class="n">chunk_start</span><span class="p">);</span>
	<span class="n">map</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="p">)</span><span class="n">em</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_RAID10</span><span class="p">)</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span> <span class="o">/</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">sub_stripes</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_RAID0</span><span class="p">)</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">);</span> <span class="cm">/* -ENOMEM */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devid</span> <span class="o">&amp;&amp;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">!=</span> <span class="n">devid</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">physical</span> <span class="o">&gt;</span> <span class="n">physical</span> <span class="o">||</span>
		    <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">physical</span> <span class="o">+</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="n">physical</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">stripe_nr</span> <span class="o">=</span> <span class="n">physical</span> <span class="o">-</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">physical</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">stripe_nr</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_RAID10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stripe_nr</span> <span class="o">=</span> <span class="n">stripe_nr</span> <span class="o">*</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">do_div</span><span class="p">(</span><span class="n">stripe_nr</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">sub_stripes</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BTRFS_BLOCK_GROUP_RAID0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stripe_nr</span> <span class="o">=</span> <span class="n">stripe_nr</span> <span class="o">*</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bytenr</span> <span class="o">=</span> <span class="n">chunk_start</span> <span class="o">+</span> <span class="n">stripe_nr</span> <span class="o">*</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">nr</span> <span class="o">&gt;=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">bytenr</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">nr</span> <span class="o">&gt;=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">nr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">bytenr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">logical</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="o">*</span><span class="n">naddrs</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
	<span class="o">*</span><span class="n">stripe_len</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span><span class="p">;</span>

	<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">merge_stripe_index_into_bio_private</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bi_private</span><span class="p">,</span>
						 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stripe_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * with single, dup, RAID0, RAID1 and RAID10, stripe_index is</span>
<span class="cm">	 * at most 1.</span>
<span class="cm">	 * The alternative solution (instead of stealing bits from the</span>
<span class="cm">	 * pointer) would be to allocate an intermediate structure</span>
<span class="cm">	 * that contains the old private pointer plus the stripe_index.</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">((((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">bi_private</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">stripe_index</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">bi_private</span><span class="p">)</span> <span class="o">|</span> <span class="n">stripe_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">btrfs_bio</span> <span class="o">*</span><span class="nf">extract_bbio_from_bio_private</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bi_private</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_bio</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">bi_private</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="mi">3</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">extract_stripe_index_from_bio_private</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bi_private</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">bi_private</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">btrfs_end_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_bio</span> <span class="o">*</span><span class="n">bbio</span> <span class="o">=</span> <span class="n">extract_bbio_from_bio_private</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">is_orig_bio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bbio</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stripe_index</span> <span class="o">=</span>
				<span class="n">extract_stripe_index_from_bio_private</span><span class="p">(</span>
					<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">stripe_index</span> <span class="o">&gt;=</span> <span class="n">bbio</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">);</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">stripe_index</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">WRITE</span><span class="p">)</span>
				<span class="n">btrfs_dev_stat_inc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						   <span class="n">BTRFS_DEV_STAT_WRITE_ERRS</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">btrfs_dev_stat_inc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						   <span class="n">BTRFS_DEV_STAT_READ_ERRS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">WRITE_FLUSH</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE_FLUSH</span><span class="p">)</span>
				<span class="n">btrfs_dev_stat_inc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						   <span class="n">BTRFS_DEV_STAT_FLUSH_ERRS</span><span class="p">);</span>
			<span class="n">btrfs_dev_stat_print_on_error</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span> <span class="o">==</span> <span class="n">bbio</span><span class="o">-&gt;</span><span class="n">orig_bio</span><span class="p">)</span>
		<span class="n">is_orig_bio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes_pending</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_orig_bio</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">bbio</span><span class="o">-&gt;</span><span class="n">orig_bio</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">bbio</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">bbio</span><span class="o">-&gt;</span><span class="n">end_io</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="p">)</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bbio</span><span class="o">-&gt;</span><span class="n">mirror_num</span><span class="p">;</span>
		<span class="cm">/* only send an error to the higher layers if it is</span>
<span class="cm">		 * beyond the tolerance of the multi-bio</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bbio</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bbio</span><span class="o">-&gt;</span><span class="n">max_errors</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * this bio is actually up to date, we didn&#39;t</span>
<span class="cm">			 * go over the max number of errors</span>
<span class="cm">			 */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bbio</span><span class="p">);</span>

		<span class="n">bio_endio</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_orig_bio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">async_sched</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_work</span> <span class="n">work</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * see run_scheduled_bios for a description of why bios are collected for</span>
<span class="cm"> * async submit.</span>
<span class="cm"> *</span>
<span class="cm"> * This will add one bio to the pending list for a device and make sure</span>
<span class="cm"> * the work struct is scheduled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline</span> <span class="kt">void</span> <span class="nf">schedule_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">rw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">should_queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_pending_bios</span> <span class="o">*</span><span class="n">pending_bios</span><span class="p">;</span>

	<span class="cm">/* don&#39;t bother with additional async steps for reads, right now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">REQ_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bio_get</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
		<span class="n">btrfsic_submit_bio</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
		<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * nr_async_bios allows us to reliably return congestion to the</span>
<span class="cm">	 * higher layers.  Otherwise, the async bio makes it appear we have</span>
<span class="cm">	 * made progress against dirty pages when we&#39;ve really just put it</span>
<span class="cm">	 * on a queue for later</span>
<span class="cm">	 */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">nr_async_bios</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">);</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">|=</span> <span class="n">rw</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_SYNC</span><span class="p">)</span>
		<span class="n">pending_bios</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pending_sync_bios</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pending_bios</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pending_bios</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pending_bios</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span>
		<span class="n">pending_bios</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>

	<span class="n">pending_bios</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pending_bios</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span>
		<span class="n">pending_bios</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">running_pending</span><span class="p">)</span>
		<span class="n">should_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">should_queue</span><span class="p">)</span>
		<span class="n">btrfs_queue_worker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">submit_workers</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_map_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">mirror_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">async_submit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_mapping_tree</span> <span class="o">*</span><span class="n">map_tree</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">first_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">logical</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">map_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev_nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total_devs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_bio</span> <span class="o">*</span><span class="n">bbio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">;</span>
	<span class="n">map_tree</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">mapping_tree</span><span class="p">;</span>
	<span class="n">map_length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_map_block</span><span class="p">(</span><span class="n">map_tree</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="n">logical</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map_length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bbio</span><span class="p">,</span>
			      <span class="n">mirror_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="cm">/* -ENOMEM */</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">total_devs</span> <span class="o">=</span> <span class="n">bbio</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map_length</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;mapping failed logical %llu bio len %llu &quot;</span>
		       <span class="s">&quot;len %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">logical</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">length</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">map_length</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">orig_bio</span> <span class="o">=</span> <span class="n">first_bio</span><span class="p">;</span>
	<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">first_bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="n">bbio</span><span class="o">-&gt;</span><span class="n">end_io</span> <span class="o">=</span> <span class="n">first_bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes_pending</span><span class="p">,</span> <span class="n">bbio</span><span class="o">-&gt;</span><span class="n">num_stripes</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dev_nr</span> <span class="o">&lt;</span> <span class="n">total_devs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_nr</span> <span class="o">&lt;</span> <span class="n">total_devs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_clone</span><span class="p">(</span><span class="n">first_bio</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">);</span> <span class="cm">/* -ENOMEM */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">first_bio</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">bbio</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">merge_stripe_index_into_bio_private</span><span class="p">(</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">dev_nr</span><span class="p">);</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">btrfs_end_bio</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">dev_nr</span><span class="p">].</span><span class="n">physical</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">dev_nr</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rw</span> <span class="o">!=</span> <span class="n">WRITE</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">writeable</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
			<span class="k">struct</span> <span class="n">rcu_string</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

			<span class="n">rcu_read_lock</span><span class="p">();</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;btrfs_map_bio: rw %d, secor=%llu, dev=%lu &quot;</span>
				 <span class="s">&quot;(%s id %llu), size=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">,</span>
				 <span class="n">name</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">,</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">);</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="cp">#endif</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">async_submit</span><span class="p">)</span>
				<span class="n">schedule_bio</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">btrfsic_submit_bio</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">latest_bdev</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">logical</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
			<span class="n">bio_endio</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_nr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="nf">btrfs_find_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="n">u64</span> <span class="n">devid</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="o">*</span><span class="n">uuid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">fsid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">cur_devices</span><span class="p">;</span>

	<span class="n">cur_devices</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cur_devices</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsid</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">cur_devices</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="n">fsid</span><span class="p">,</span> <span class="n">BTRFS_UUID_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">device</span> <span class="o">=</span> <span class="n">__find_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span>
					       <span class="n">devid</span><span class="p">,</span> <span class="n">uuid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">device</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cur_devices</span> <span class="o">=</span> <span class="n">cur_devices</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="nf">add_missing_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
					    <span class="n">u64</span> <span class="n">devid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dev_uuid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">device</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span>
		 <span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">pending_bios_fn</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">fs_devices</span> <span class="o">=</span> <span class="n">fs_devices</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">missing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">num_devices</span><span class="o">++</span><span class="p">;</span>
	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">missing_devices</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_alloc_list</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">dev_uuid</span><span class="p">,</span> <span class="n">BTRFS_UUID_SIZE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">device</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_one_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btrfs_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_mapping_tree</span> <span class="o">*</span><span class="n">map_tree</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">mapping_tree</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map_lookup</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_map</span> <span class="o">*</span><span class="n">em</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">logical</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">devid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">uuid</span><span class="p">[</span><span class="n">BTRFS_UUID_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">num_stripes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">logical</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">btrfs_chunk_length</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map_tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">em</span> <span class="o">=</span> <span class="n">lookup_extent_mapping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map_tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">,</span> <span class="n">logical</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map_tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* already mapped? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">em</span> <span class="o">&amp;&amp;</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">logical</span> <span class="o">&amp;&amp;</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">logical</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">em</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">em</span> <span class="o">=</span> <span class="n">alloc_extent_map</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">em</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">num_stripes</span> <span class="o">=</span> <span class="n">btrfs_chunk_num_stripes</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
	<span class="n">map</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">map_lookup_size</span><span class="p">(</span><span class="n">num_stripes</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">em</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="p">)</span><span class="n">map</span><span class="p">;</span>
	<span class="n">em</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">logical</span><span class="p">;</span>
	<span class="n">em</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">em</span><span class="o">-&gt;</span><span class="n">block_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">em</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">=</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">num_stripes</span> <span class="o">=</span> <span class="n">num_stripes</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">io_width</span> <span class="o">=</span> <span class="n">btrfs_chunk_io_width</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">io_align</span> <span class="o">=</span> <span class="n">btrfs_chunk_io_align</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">=</span> <span class="n">btrfs_chunk_sector_size</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">stripe_len</span> <span class="o">=</span> <span class="n">btrfs_chunk_stripe_len</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">btrfs_chunk_type</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">sub_stripes</span> <span class="o">=</span> <span class="n">btrfs_chunk_sub_stripes</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_stripes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">physical</span> <span class="o">=</span>
			<span class="n">btrfs_stripe_offset_nr</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">devid</span> <span class="o">=</span> <span class="n">btrfs_stripe_devid_nr</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">read_extent_buffer</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
				   <span class="n">btrfs_stripe_dev_uuid_nr</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
				   <span class="n">BTRFS_UUID_SIZE</span><span class="p">);</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">btrfs_find_device</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span>
							<span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">btrfs_test_opt</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">DEGRADED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
			<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span>
				<span class="n">add_missing_dev</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">uuid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
				<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_fs_metadata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map_tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">add_extent_mapping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map_tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">,</span> <span class="n">em</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map_tree</span><span class="o">-&gt;</span><span class="n">map_tree</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span> <span class="cm">/* Tree corruption */</span>
	<span class="n">free_extent_map</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_device_from_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">btrfs_dev_item</span> <span class="o">*</span><span class="n">dev_item</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">=</span> <span class="n">btrfs_device_id</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">disk_total_bytes</span> <span class="o">=</span> <span class="n">btrfs_device_total_bytes</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">disk_total_bytes</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">bytes_used</span> <span class="o">=</span> <span class="n">btrfs_device_bytes_used</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">btrfs_device_type</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">io_align</span> <span class="o">=</span> <span class="n">btrfs_device_io_align</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">io_width</span> <span class="o">=</span> <span class="n">btrfs_device_io_width</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">=</span> <span class="n">btrfs_device_sector_size</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">btrfs_device_uuid</span><span class="p">(</span><span class="n">dev_item</span><span class="p">);</span>
	<span class="n">read_extent_buffer</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">BTRFS_UUID_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">open_seed_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">fsid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">));</span>

	<span class="n">fs_devices</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">fs_devices</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="n">fsid</span><span class="p">,</span> <span class="n">BTRFS_UUID_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fs_devices</span> <span class="o">=</span> <span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fs_devices</span> <span class="o">=</span> <span class="n">find_fsid</span><span class="p">(</span><span class="n">fsid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fs_devices</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fs_devices</span> <span class="o">=</span> <span class="n">clone_fs_devices</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__btrfs_open_devices</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">,</span> <span class="n">FMODE_READ</span><span class="p">,</span>
				   <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">bdev_holder</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_fs_devices</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seeding</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__btrfs_close_devices</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">);</span>
		<span class="n">free_fs_devices</span><span class="p">(</span><span class="n">fs_devices</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seed</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">;</span>
	<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">seed</span> <span class="o">=</span> <span class="n">fs_devices</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_one_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">btrfs_dev_item</span> <span class="o">*</span><span class="n">dev_item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">devid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fs_uuid</span><span class="p">[</span><span class="n">BTRFS_UUID_SIZE</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">dev_uuid</span><span class="p">[</span><span class="n">BTRFS_UUID_SIZE</span><span class="p">];</span>

	<span class="n">devid</span> <span class="o">=</span> <span class="n">btrfs_device_id</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">);</span>
	<span class="n">read_extent_buffer</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_uuid</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">btrfs_device_uuid</span><span class="p">(</span><span class="n">dev_item</span><span class="p">),</span>
			   <span class="n">BTRFS_UUID_SIZE</span><span class="p">);</span>
	<span class="n">read_extent_buffer</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">fs_uuid</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">btrfs_device_fsid</span><span class="p">(</span><span class="n">dev_item</span><span class="p">),</span>
			   <span class="n">BTRFS_UUID_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">fs_uuid</span><span class="p">,</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="n">BTRFS_UUID_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">open_seed_devices</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">fs_uuid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">btrfs_test_opt</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">DEGRADED</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">btrfs_find_device</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">dev_uuid</span><span class="p">,</span> <span class="n">fs_uuid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span> <span class="o">||</span> <span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">btrfs_test_opt</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">DEGRADED</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;warning devid %llu missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">devid</span><span class="p">);</span>
			<span class="n">device</span> <span class="o">=</span> <span class="n">add_missing_dev</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">dev_uuid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">missing</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * this happens when a device that was properly setup</span>
<span class="cm">			 * in the device info lists suddenly goes bad.</span>
<span class="cm">			 * device-&gt;bdev is NULL, and so we have to set</span>
<span class="cm">			 * device-&gt;missing to one here</span>
<span class="cm">			 */</span>
			<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">missing_devices</span><span class="o">++</span><span class="p">;</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">missing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">fs_devices</span> <span class="o">!=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">!=</span>
		    <span class="n">btrfs_device_generation</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fill_device_from_item</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">in_fs_metadata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">writeable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">total_rw_bytes</span> <span class="o">+=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_lock</span><span class="p">);</span>
		<span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_space</span> <span class="o">+=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">-</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">bytes_used</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">free_chunk_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_read_sys_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_super_block</span> <span class="o">*</span><span class="n">super_copy</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">super_copy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_disk_key</span> <span class="o">*</span><span class="n">disk_key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sb_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_stripes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">array_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">btrfs_find_create_tree_block</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">BTRFS_SUPER_INFO_OFFSET</span><span class="p">,</span>
					  <span class="n">BTRFS_SUPER_INFO_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">btrfs_set_buffer_uptodate</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">btrfs_set_buffer_lockdep_class</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">root_key</span><span class="p">.</span><span class="n">objectid</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * The sb extent buffer is artifical and just used to read the system array.</span>
<span class="cm">	 * btrfs_set_buffer_uptodate() call does not properly mark all it&#39;s</span>
<span class="cm">	 * pages up-to-date when the page is larger: extent does not cover the</span>
<span class="cm">	 * whole page and consequently check_page_uptodate does not find all</span>
<span class="cm">	 * the page&#39;s extents up-to-date (the hole beyond sb),</span>
<span class="cm">	 * write_extent_buffer then triggers a WARN_ON.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Regular short extents go through mark_extent_buffer_dirty/writeback cycle,</span>
<span class="cm">	 * but sb spans only this function. Add an explicit SetPageUptodate call</span>
<span class="cm">	 * to silence the warning eg. on PowerPC 64.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PAGE_CACHE_SIZE</span> <span class="o">&gt;</span> <span class="n">BTRFS_SUPER_INFO_SIZE</span><span class="p">)</span>
		<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">write_extent_buffer</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">super_copy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BTRFS_SUPER_INFO_SIZE</span><span class="p">);</span>
	<span class="n">array_size</span> <span class="o">=</span> <span class="n">btrfs_super_sys_array_size</span><span class="p">(</span><span class="n">super_copy</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">super_copy</span><span class="o">-&gt;</span><span class="n">sys_chunk_array</span><span class="p">;</span>
	<span class="n">sb_ptr</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_super_block</span><span class="p">,</span> <span class="n">sys_chunk_array</span><span class="p">);</span>
	<span class="n">cur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&lt;</span> <span class="n">array_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">disk_key</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_disk_key</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
		<span class="n">btrfs_disk_key_to_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">disk_key</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">disk_key</span><span class="p">);</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sb_ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">cur</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BTRFS_CHUNK_ITEM_KEY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chunk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="p">)</span><span class="n">sb_ptr</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">read_one_chunk</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">num_stripes</span> <span class="o">=</span> <span class="n">btrfs_chunk_num_stripes</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">btrfs_chunk_item_size</span><span class="p">(</span><span class="n">num_stripes</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sb_ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">cur</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">free_extent_buffer</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="nf">btrfs_find_device_for_logical</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
						   <span class="n">u64</span> <span class="n">logical</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mirror_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_mapping_tree</span> <span class="o">*</span><span class="n">map_tree</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">mapping_tree</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">map_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_bio</span> <span class="o">*</span><span class="n">bbio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mirror_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_map_block</span><span class="p">(</span><span class="n">map_tree</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">,</span> <span class="n">logical</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map_length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bbio</span><span class="p">,</span>
			      <span class="n">mirror_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bbio</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mirror_num</span> <span class="o">!=</span> <span class="n">bbio</span><span class="o">-&gt;</span><span class="n">mirror_num</span><span class="p">);</span>
	<span class="n">device</span> <span class="o">=</span> <span class="n">bbio</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">[</span><span class="n">mirror_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bbio</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">device</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_read_chunk_tree</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">found_key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">chunk_root</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>
	<span class="n">lock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>

	<span class="cm">/* first we search for all of the device items, and then we</span>
<span class="cm">	 * read in all of the chunk items.  This way we can create chunk</span>
<span class="cm">	 * mappings that reference all of the devices that are afound</span>
<span class="cm">	 */</span>
	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">BTRFS_DEV_ITEMS_OBJECTID</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">again:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leaf</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">btrfs_header_nritems</span><span class="p">(</span><span class="n">leaf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_next_leaf</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">btrfs_item_key_to_cpu</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">found_key</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">==</span> <span class="n">BTRFS_DEV_ITEMS_OBJECTID</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">found_key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">!=</span> <span class="n">BTRFS_DEV_ITEMS_OBJECTID</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">found_key</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BTRFS_DEV_ITEM_KEY</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">btrfs_dev_item</span> <span class="o">*</span><span class="n">dev_item</span><span class="p">;</span>
				<span class="n">dev_item</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">btrfs_dev_item</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">read_one_dev</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">leaf</span><span class="p">,</span> <span class="n">dev_item</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">found_key</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BTRFS_CHUNK_ITEM_KEY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">btrfs_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
			<span class="n">chunk</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btrfs_chunk</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">read_one_chunk</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">found_key</span><span class="p">,</span> <span class="n">leaf</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">==</span> <span class="n">BTRFS_DEV_ITEMS_OBJECTID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">btrfs_release_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">unlock_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_mutex</span><span class="p">);</span>

	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__btrfs_reset_dev_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BTRFS_DEV_STAT_VALUES_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">btrfs_dev_stat_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_init_dev_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">found_key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">dev_root</span> <span class="o">=</span> <span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span> <span class="o">=</span> <span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">eb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">item_size</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">btrfs_dev_stats_item</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

		<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_DEV_STATS_KEY</span><span class="p">;</span>
		<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">dev_root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk_in_rcu</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;btrfs: no dev_stats entry found for device %s (devid %llu) (OK on first mount after mkfs)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">rcu_str_deref</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
				      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">);</span>
			<span class="n">__btrfs_reset_dev_stats</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_stats_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">btrfs_release_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">eb</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">btrfs_item_key_to_cpu</span><span class="p">(</span><span class="n">eb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">found_key</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">item_size</span> <span class="o">=</span> <span class="n">btrfs_item_size_nr</span><span class="p">(</span><span class="n">eb</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">eb</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">btrfs_dev_stats_item</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BTRFS_DEV_STAT_VALUES_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">item_size</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">))</span>
				<span class="n">btrfs_dev_stat_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="n">btrfs_dev_stats_value</span><span class="p">(</span><span class="n">eb</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">btrfs_dev_stat_reset</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_stats_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">btrfs_dev_stat_print_on_load</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="n">btrfs_release_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_dev_stat_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">dev_root</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extent_buffer</span> <span class="o">*</span><span class="n">eb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_dev_stats_item</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BTRFS_DEV_STATS_KEY</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">btrfs_alloc_path</span><span class="p">();</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_search_slot</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">dev_root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk_in_rcu</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;btrfs: error %d while searching for dev_stats item for device %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ret</span><span class="p">,</span> <span class="n">rcu_str_deref</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">btrfs_item_size_nr</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* need to delete old one and insert a new one */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_del_item</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">dev_root</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk_in_rcu</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;btrfs: delete too small dev_stats item for device %s failed %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">rcu_str_deref</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* need to insert a new item */</span>
		<span class="n">btrfs_release_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">btrfs_insert_empty_item</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">dev_root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk_in_rcu</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;btrfs: insert dev_stats item for device %s failed %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">rcu_str_deref</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">eb</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">btrfs_item_ptr</span><span class="p">(</span><span class="n">eb</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">struct</span> <span class="n">btrfs_dev_stats_item</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BTRFS_DEV_STAT_VALUES_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">btrfs_set_dev_stats_value</span><span class="p">(</span><span class="n">eb</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					  <span class="n">btrfs_dev_stat_read</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="n">btrfs_mark_buffer_dirty</span><span class="p">(</span><span class="n">eb</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">btrfs_free_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called from commit_transaction. Writes all changed device stats to disk.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">btrfs_run_dev_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_trans_handle</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">btrfs_fs_info</span> <span class="o">*</span><span class="n">fs_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">dev_root</span> <span class="o">=</span> <span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">dev_root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span> <span class="o">=</span> <span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_stats_valid</span> <span class="o">||</span> <span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_stats_dirty</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">update_dev_stat_item</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">dev_root</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">dev_stats_dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">btrfs_dev_stat_inc_and_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">btrfs_dev_stat_inc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">btrfs_dev_stat_print_on_error</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">btrfs_dev_stat_print_on_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_stats_valid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">printk_ratelimited_in_rcu</span><span class="p">(</span><span class="n">KERN_ERR</span>
			   <span class="s">&quot;btrfs: bdev %s errs: wr %u, rd %u, flush %u, corrupt %u, gen %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rcu_str_deref</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			   <span class="n">btrfs_dev_stat_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTRFS_DEV_STAT_WRITE_ERRS</span><span class="p">),</span>
			   <span class="n">btrfs_dev_stat_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTRFS_DEV_STAT_READ_ERRS</span><span class="p">),</span>
			   <span class="n">btrfs_dev_stat_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTRFS_DEV_STAT_FLUSH_ERRS</span><span class="p">),</span>
			   <span class="n">btrfs_dev_stat_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">BTRFS_DEV_STAT_CORRUPTION_ERRS</span><span class="p">),</span>
			   <span class="n">btrfs_dev_stat_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">BTRFS_DEV_STAT_GENERATION_ERRS</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">btrfs_dev_stat_print_on_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk_in_rcu</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;btrfs: bdev %s errs: wr %u, rd %u, flush %u, corrupt %u, gen %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">rcu_str_deref</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
	       <span class="n">btrfs_dev_stat_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTRFS_DEV_STAT_WRITE_ERRS</span><span class="p">),</span>
	       <span class="n">btrfs_dev_stat_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTRFS_DEV_STAT_READ_ERRS</span><span class="p">),</span>
	       <span class="n">btrfs_dev_stat_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTRFS_DEV_STAT_FLUSH_ERRS</span><span class="p">),</span>
	       <span class="n">btrfs_dev_stat_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTRFS_DEV_STAT_CORRUPTION_ERRS</span><span class="p">),</span>
	       <span class="n">btrfs_dev_stat_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTRFS_DEV_STAT_GENERATION_ERRS</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">btrfs_get_dev_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">btrfs_ioctl_get_dev_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">reset_after_read</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btrfs_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btrfs_fs_devices</span> <span class="o">*</span><span class="n">fs_devices</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">fs_info</span><span class="o">-&gt;</span><span class="n">fs_devices</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">btrfs_find_device</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_devices</span><span class="o">-&gt;</span><span class="n">device_list_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;btrfs: get dev_stats failed, device not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_stats_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;btrfs: get dev_stats failed, not yet valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reset_after_read</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BTRFS_DEV_STAT_VALUES_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">nr_items</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">btrfs_dev_stat_read_and_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">btrfs_dev_stat_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BTRFS_DEV_STAT_VALUES_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">nr_items</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">btrfs_dev_stat_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">nr_items</span> <span class="o">&gt;</span> <span class="n">BTRFS_DEV_STAT_VALUES_MAX</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">nr_items</span> <span class="o">=</span> <span class="n">BTRFS_DEV_STAT_VALUES_MAX</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
