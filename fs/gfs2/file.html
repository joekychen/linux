<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › gfs2 › file.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>file.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) Sistina Software, Inc.  1997-2003 All rights reserved.</span>
<span class="cm"> * Copyright (C) 2004-2006 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This copyrighted material is made available to anyone wishing to use,</span>
<span class="cm"> * modify, copy, or redistribute it subject to the terms and conditions</span>
<span class="cm"> * of the GNU General Public License version 2.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/uio.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/gfs2_ondisk.h&gt;</span>
<span class="cp">#include &lt;linux/falloc.h&gt;</span>
<span class="cp">#include &lt;linux/swap.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/writeback.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/dlm.h&gt;</span>
<span class="cp">#include &lt;linux/dlm_plock.h&gt;</span>

<span class="cp">#include &quot;gfs2.h&quot;</span>
<span class="cp">#include &quot;incore.h&quot;</span>
<span class="cp">#include &quot;bmap.h&quot;</span>
<span class="cp">#include &quot;dir.h&quot;</span>
<span class="cp">#include &quot;glock.h&quot;</span>
<span class="cp">#include &quot;glops.h&quot;</span>
<span class="cp">#include &quot;inode.h&quot;</span>
<span class="cp">#include &quot;log.h&quot;</span>
<span class="cp">#include &quot;meta_io.h&quot;</span>
<span class="cp">#include &quot;quota.h&quot;</span>
<span class="cp">#include &quot;rgrp.h&quot;</span>
<span class="cp">#include &quot;trans.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_llseek - seek to a location in a file</span>
<span class="cm"> * @file: the file</span>
<span class="cm"> * @offset: the offset</span>
<span class="cm"> * @origin: Where to seek from (SEEK_SET, SEEK_CUR, or SEEK_END)</span>
<span class="cm"> *</span>
<span class="cm"> * SEEK_END requires the glock for the file because it references the</span>
<span class="cm"> * file&#39;s size.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: The new offset, or errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">loff_t</span> <span class="nf">gfs2_llseek</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">origin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">i_gh</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">origin</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEEK_END</span>: <span class="cm">/* These reference inode-&gt;i_size */</span>
	<span class="k">case</span> <span class="n">SEEK_DATA</span>:
	<span class="k">case</span> <span class="n">SEEK_HOLE</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="n">LM_FLAG_ANY</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">generic_file_llseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">origin</span><span class="p">);</span>
			<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEEK_CUR</span>:
	<span class="k">case</span> <span class="n">SEEK_SET</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">generic_file_llseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">origin</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_readdir - Read directory entries from a directory</span>
<span class="cm"> * @file: The directory to read from</span>
<span class="cm"> * @dirent: Buffer for dirents</span>
<span class="cm"> * @filldir: Function used to do the copying</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_readdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dirent</span><span class="p">,</span> <span class="n">filldir_t</span> <span class="n">filldir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">d_gh</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">gfs2_holder_init</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d_gh</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_gh</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_dir_read</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="n">dirent</span><span class="p">,</span> <span class="n">filldir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_ra</span><span class="p">);</span>

	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_gh</span><span class="p">);</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsflags_cvt</span>
<span class="cm"> * @table: A table of 32 u32 flags</span>
<span class="cm"> * @val: a 32 bit value to convert</span>
<span class="cm"> *</span>
<span class="cm"> * This function can be used to convert between fsflags values and</span>
<span class="cm"> * GFS2&#39;s own flags values.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: the converted flags</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">fsflags_cvt</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">|=</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
		<span class="n">table</span><span class="o">++</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">fsflags_to_gfs2</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">GFS2_DIF_SYNC</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">GFS2_DIF_IMMUTABLE</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">GFS2_DIF_APPENDONLY</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">GFS2_DIF_NOATIME</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">GFS2_DIF_EXHASH</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">GFS2_DIF_INHERIT_JDATA</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">gfs2_to_fsflags</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">gfs2fl_Sync</span><span class="p">]</span> <span class="o">=</span> <span class="n">FS_SYNC_FL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">gfs2fl_Immutable</span><span class="p">]</span> <span class="o">=</span> <span class="n">FS_IMMUTABLE_FL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">gfs2fl_AppendOnly</span><span class="p">]</span> <span class="o">=</span> <span class="n">FS_APPEND_FL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">gfs2fl_NoAtime</span><span class="p">]</span> <span class="o">=</span> <span class="n">FS_NOATIME_FL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">gfs2fl_ExHash</span><span class="p">]</span> <span class="o">=</span> <span class="n">FS_INDEX_FL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">gfs2fl_InheritJdata</span><span class="p">]</span> <span class="o">=</span> <span class="n">FS_JOURNAL_DATA_FL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_get_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fsflags</span><span class="p">;</span>

	<span class="n">gfs2_holder_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">fsflags</span> <span class="o">=</span> <span class="n">fsflags_cvt</span><span class="p">(</span><span class="n">gfs2_to_fsflags</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_JDATA</span><span class="p">)</span>
		<span class="n">fsflags</span> <span class="o">|=</span> <span class="n">FS_JOURNAL_DATA_FL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">fsflags</span><span class="p">,</span> <span class="n">ptr</span><span class="p">))</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_set_inode_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">S_SYNC</span><span class="o">|</span><span class="n">S_APPEND</span><span class="o">|</span><span class="n">S_IMMUTABLE</span><span class="o">|</span><span class="n">S_NOATIME</span><span class="o">|</span><span class="n">S_DIRSYNC</span><span class="o">|</span><span class="n">S_NOSEC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_eattr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_sxid</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">|=</span> <span class="n">S_NOSEC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_IMMUTABLE</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">S_IMMUTABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_APPENDONLY</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">S_APPEND</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_NOATIME</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">S_NOATIME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_SYNC</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">S_SYNC</span><span class="p">;</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Flags that can be set by user space */</span>
<span class="cp">#define GFS2_FLAGS_USER_SET (GFS2_DIF_JDATA|			\</span>
<span class="cp">			     GFS2_DIF_IMMUTABLE|		\</span>
<span class="cp">			     GFS2_DIF_APPENDONLY|		\</span>
<span class="cp">			     GFS2_DIF_NOATIME|			\</span>
<span class="cp">			     GFS2_DIF_SYNC|			\</span>
<span class="cp">			     GFS2_DIF_SYSTEM|			\</span>
<span class="cp">			     GFS2_DIF_INHERIT_JDATA)</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_set_flags - set flags on an inode</span>
<span class="cm"> * @inode: The inode</span>
<span class="cm"> * @flags: The flags to set</span>
<span class="cm"> * @mask: Indicates which flags are valid</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_gfs2_set_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reqflags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_flags</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mnt_want_write_file</span><span class="p">(</span><span class="n">filp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_drop_write</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inode_owner_or_capable</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span><span class="p">;</span>
	<span class="n">new_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">reqflags</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_flags</span> <span class="o">^</span> <span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_flags</span> <span class="o">^</span> <span class="n">flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GFS2_FLAGS_USER_SET</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IMMUTABLE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_IMMUTABLE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_APPEND</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_APPENDONLY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">new_flags</span> <span class="o">^</span> <span class="n">flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_IMMUTABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_LINUX_IMMUTABLE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_IMMUTABLE</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_permission</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">MAY_WRITE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">^</span> <span class="n">new_flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_JDATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_JDATA</span><span class="p">)</span>
			<span class="n">gfs2_log_flush</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">filemap_fdatawrite</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">filemap_fdatawait</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">RES_DINODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_trans_end</span><span class="p">;</span>
	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">=</span> <span class="n">new_flags</span><span class="p">;</span>
	<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">gfs2_set_inode_flags</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">gfs2_set_aops</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="nl">out_trans_end:</span>
	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
<span class="nl">out_drop_write:</span>
	<span class="n">mnt_drop_write_file</span><span class="p">(</span><span class="n">filp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_set_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fsflags</span><span class="p">,</span> <span class="n">gfsflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">fsflags</span><span class="p">,</span> <span class="n">ptr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">gfsflags</span> <span class="o">=</span> <span class="n">fsflags_cvt</span><span class="p">(</span><span class="n">fsflags_to_gfs2</span><span class="p">,</span> <span class="n">fsflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfsflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_INHERIT_JDATA</span><span class="p">)</span>
			<span class="n">gfsflags</span> <span class="o">^=</span> <span class="p">(</span><span class="n">GFS2_DIF_JDATA</span> <span class="o">|</span> <span class="n">GFS2_DIF_INHERIT_JDATA</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">do_gfs2_set_flags</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">gfsflags</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">do_gfs2_set_flags</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">gfsflags</span><span class="p">,</span> <span class="o">~</span><span class="n">GFS2_DIF_JDATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">gfs2_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FS_IOC_GETFLAGS</span>:
		<span class="k">return</span> <span class="n">gfs2_get_flags</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">FS_IOC_SETFLAGS</span>:
		<span class="k">return</span> <span class="n">gfs2_set_flags</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">FITRIM</span>:
		<span class="k">return</span> <span class="n">gfs2_fitrim</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_allocate_page_backing - Use bmap to allocate blocks</span>
<span class="cm"> * @page: The (locked) page to allocate backing for</span>
<span class="cm"> *</span>
<span class="cm"> * We try to allocate all the blocks required for the page in</span>
<span class="cm"> * one go. This might fail for various reasons, so we keep</span>
<span class="cm"> * trying until all the blocks to back this page are allocated.</span>
<span class="cm"> * If some of the blocks are already allocated, thats ok too.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_allocate_page_backing</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="n">bh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">lblock</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_CACHE_SHIFT</span> <span class="o">-</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">bh</span><span class="p">.</span><span class="n">b_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bh</span><span class="p">.</span><span class="n">b_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">gfs2_block_map</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_mapped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bh</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">bh</span><span class="p">.</span><span class="n">b_size</span><span class="p">;</span>
		<span class="n">lblock</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bh</span><span class="p">.</span><span class="n">b_size</span> <span class="o">&gt;&gt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_page_mkwrite - Make a shared, mmap()ed, page writable</span>
<span class="cm"> * @vma: The virtual memory area</span>
<span class="cm"> * @page: The page which is about to become writable</span>
<span class="cm"> *</span>
<span class="cm"> * When the page becomes writable, we need to ensure that we have</span>
<span class="cm"> * blocks allocated on disk to back that page.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_page_mkwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_fault</span> <span class="o">*</span><span class="n">vmf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">vmf</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_index</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_blocks</span><span class="p">,</span> <span class="n">ind_blocks</span><span class="p">,</span> <span class="n">rblocks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">gh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_qadata</span> <span class="o">*</span><span class="n">qa</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Wait if fs is frozen. This is racy so we check again later on</span>
<span class="cm">	 * and retry if the fs has been frozen after the page lock has</span>
<span class="cm">	 * been acquired</span>
<span class="cm">	 */</span>
	<span class="n">vfs_check_frozen</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">SB_FREEZE_WRITE</span><span class="p">);</span>

	<span class="n">gfs2_holder_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_glock_nq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_DIRTY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">GIF_SW_PAGED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_write_alloc_required</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">||</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">!=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">qa</span> <span class="o">=</span> <span class="n">gfs2_qadata_get</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qa</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_quota_lock_check</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_alloc_put</span><span class="p">;</span>
	<span class="n">gfs2_write_calc_reserv</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_blocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ind_blocks</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_inplace_reserve</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">data_blocks</span> <span class="o">+</span> <span class="n">ind_blocks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_quota_unlock</span><span class="p">;</span>

	<span class="n">rblocks</span> <span class="o">=</span> <span class="n">RES_DINODE</span> <span class="o">+</span> <span class="n">ind_blocks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_jdata</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">rblocks</span> <span class="o">+=</span> <span class="n">data_blocks</span> <span class="o">?</span> <span class="n">data_blocks</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ind_blocks</span> <span class="o">||</span> <span class="n">data_blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rblocks</span> <span class="o">+=</span> <span class="n">RES_STATFS</span> <span class="o">+</span> <span class="n">RES_QUOTA</span><span class="p">;</span>
		<span class="n">rblocks</span> <span class="o">+=</span> <span class="n">gfs2_rg_blocks</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">rblocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_trans_fail</span><span class="p">;</span>

	<span class="n">lock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">last_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="cm">/* Check page index against inode size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">last_index</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_trans_end</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="cm">/* If truncated, we must retry the operation, we may have raced</span>
<span class="cm">	 * with the glock demotion code.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">||</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">!=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_trans_end</span><span class="p">;</span>

	<span class="cm">/* Unstuff, if required, and allocate backing blocks for page */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_unstuff_dinode</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_allocate_page_backing</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

<span class="nl">out_trans_end:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
<span class="nl">out_trans_fail:</span>
	<span class="n">gfs2_inplace_release</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="nl">out_quota_unlock:</span>
	<span class="n">gfs2_quota_unlock</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="nl">out_alloc_put:</span>
	<span class="n">gfs2_qadata_put</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_page_dirty</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="cm">/* This check must be post dropping of transaction lock */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_frozen</span> <span class="o">==</span> <span class="n">SB_UNFROZEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wait_on_page_writeback</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">block_page_mkwrite_return</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vm_operations_struct</span> <span class="n">gfs2_vm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fault</span> <span class="o">=</span> <span class="n">filemap_fault</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page_mkwrite</span> <span class="o">=</span> <span class="n">gfs2_page_mkwrite</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_mmap -</span>
<span class="cm"> * @file: The file to map</span>
<span class="cm"> * @vma: The VMA which described the mapping</span>
<span class="cm"> *</span>
<span class="cm"> * There is no need to get a lock here unless we should be updating</span>
<span class="cm"> * atime. We ignore any locking errors since the only consequence is</span>
<span class="cm"> * a missed atime update (which will just be deferred until later).</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NOATIME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">IS_NOATIME</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">i_gh</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">gfs2_holder_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="n">LM_FLAG_ANY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">file_accessed</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
			<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gfs2_vm_ops</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_CAN_NONLINEAR</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_open - open a file</span>
<span class="cm"> * @inode: the inode to open</span>
<span class="cm"> * @file: the struct file for this opening</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">i_gh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_file</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">f_fl_mutex</span><span class="p">);</span>

	<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="n">LM_FLAG_ANY</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_LARGEFILE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_NON_LFS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_gunlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_gunlock:</span>
	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_release - called to close a struct file</span>
<span class="cm"> * @inode: the inode the struct file belongs to</span>
<span class="cm"> * @file: the struct file being closed</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_file</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_fsync - sync the dirty data for a file (across the cluster)</span>
<span class="cm"> * @file: the file that points to the dentry</span>
<span class="cm"> * @start: the start position in the file to sync</span>
<span class="cm"> * @end: the end position in the file to sync</span>
<span class="cm"> * @datasync: set if we can ignore timestamp changes</span>
<span class="cm"> *</span>
<span class="cm"> * We split the data flushing here so that we don&#39;t wait for the data</span>
<span class="cm"> * until after we&#39;ve also sent the metadata to disk. Note that for</span>
<span class="cm"> * data=ordered, we will write &amp; wait for the data at the log flush</span>
<span class="cm"> * stage anyway, so this is unlikely to make much of a difference</span>
<span class="cm"> * except in the data=writeback case.</span>
<span class="cm"> *</span>
<span class="cm"> * If the fdatawrite fails due to any reason except -EIO, we will</span>
<span class="cm"> * continue the remainder of the fsync, although we&#39;ll still report</span>
<span class="cm"> * the error at the end. This is to match filemap_write_and_wait_range()</span>
<span class="cm"> * behaviour.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_fsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">end</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">datasync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sync_state</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">I_DIRTY_SYNC</span><span class="o">|</span><span class="n">I_DIRTY_DATASYNC</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">nrpages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret1</span> <span class="o">=</span> <span class="n">filemap_fdatawrite_range</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">datasync</span><span class="p">)</span>
		<span class="n">sync_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I_DIRTY_SYNC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sync_inode_metadata</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_jdata</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
			<span class="n">filemap_write_and_wait</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
		<span class="n">gfs2_ail_flush</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">nrpages</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">filemap_fdatawait_range</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">ret1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_file_aio_write - Perform a write to a file</span>
<span class="cm"> * @iocb: The io context</span>
<span class="cm"> * @iov: The data to write</span>
<span class="cm"> * @nr_segs: Number of @iov segments</span>
<span class="cm"> * @pos: The file position</span>
<span class="cm"> *</span>
<span class="cm"> * We have to do a lock/unlock here to refresh the inode size for</span>
<span class="cm"> * O_APPEND writes, otherwise we can land up writing at the wrong</span>
<span class="cm"> * offset. There is still a race, but provided the app is using its</span>
<span class="cm"> * own file locking, this will make O_APPEND work as expected.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">gfs2_file_aio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_APPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">gh</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">generic_file_aio_write</span><span class="p">(</span><span class="n">iocb</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fallocate_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">len</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_blks</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">lblock</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_unstuff_dinode</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">buffer_head</span> <span class="n">bh_map</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">b_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">b_blocknr</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>
		<span class="n">bh_map</span><span class="p">.</span><span class="n">b_size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">set_buffer_zeronew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bh_map</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_block_map</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh_map</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">bh_map</span><span class="p">.</span><span class="n">b_size</span><span class="p">;</span>
		<span class="n">nr_blks</span> <span class="o">=</span> <span class="n">bh_map</span><span class="p">.</span><span class="n">b_size</span> <span class="o">&gt;&gt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">;</span>
		<span class="n">lblock</span> <span class="o">+=</span> <span class="n">nr_blks</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bh_map</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">buffer_zeronew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bh_map</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FALLOC_FL_KEEP_SIZE</span><span class="p">))</span>
		<span class="n">i_size_write</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calc_max_reserv</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">max</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">len</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data_blocks</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ind_blocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_blocks</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rgd</span><span class="o">-&gt;</span><span class="n">rd_free_clone</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">max_data</span> <span class="o">=</span> <span class="n">max_blocks</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_max_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">max_data</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_diptrs</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_inptrs</span><span class="p">);</span>
		<span class="n">max_data</span> <span class="o">-=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* This calculation isn&#39;t the exact reverse of gfs2_write_calc_reserve,</span>
<span class="cm">	   so it might end up with fewer data blocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_data</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">data_blocks</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data_blocks</span> <span class="o">=</span> <span class="n">max_data</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ind_blocks</span> <span class="o">=</span> <span class="n">max_blocks</span> <span class="o">-</span> <span class="n">max_data</span><span class="p">;</span>
	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">loff_t</span><span class="p">)</span><span class="n">max_data</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize_shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
		<span class="n">gfs2_write_calc_reserv</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">data_blocks</span><span class="p">,</span> <span class="n">ind_blocks</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">gfs2_fallocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span>
			   <span class="n">loff_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ind_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rblocks</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_qadata</span> <span class="o">*</span><span class="n">qa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">loff_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">loff_t</span> <span class="n">count</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">bsize_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">loff_t</span><span class="p">)</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">loff_t</span> <span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize_shift</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">max_chunk_size</span> <span class="o">=</span> <span class="n">UINT_MAX</span> <span class="o">&amp;</span> <span class="n">bsize_mask</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="n">next</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize_shift</span><span class="p">;</span>

	<span class="cm">/* We only support the FALLOC_FL_KEEP_SIZE mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FALLOC_FL_KEEP_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">&amp;=</span> <span class="n">bsize_mask</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">next</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">bytes</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_max_rg_data</span> <span class="o">*</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bytes</span><span class="p">)</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">;</span>
	<span class="n">bytes</span> <span class="o">&amp;=</span> <span class="n">bsize_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span><span class="p">;</span>

	<span class="n">gfs2_holder_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_uninit</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">bytes</span><span class="p">)</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_write_alloc_required</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytes</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qa</span> <span class="o">=</span> <span class="n">gfs2_qadata_get</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qa</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_quota_lock_check</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_alloc_put</span><span class="p">;</span>

<span class="nl">retry:</span>
		<span class="n">gfs2_write_calc_reserv</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_blocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ind_blocks</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_inplace_reserve</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">data_blocks</span> <span class="o">+</span> <span class="n">ind_blocks</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span> <span class="o">&amp;&amp;</span> <span class="n">bytes</span> <span class="o">&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bytes</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">bytes</span> <span class="o">&amp;=</span> <span class="n">bsize_mask</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">bytes</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out_qunlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">max_bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="n">calc_max_reserv</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">max_chunk_size</span><span class="p">)</span><span class="o">?</span> <span class="n">max_chunk_size</span><span class="o">:</span> <span class="n">len</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">max_bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_blocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ind_blocks</span><span class="p">);</span>

		<span class="n">rblocks</span> <span class="o">=</span> <span class="n">RES_DINODE</span> <span class="o">+</span> <span class="n">ind_blocks</span> <span class="o">+</span> <span class="n">RES_STATFS</span> <span class="o">+</span> <span class="n">RES_QUOTA</span> <span class="o">+</span>
			  <span class="n">RES_RG_HDR</span> <span class="o">+</span> <span class="n">gfs2_rg_blocks</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_jdata</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
			<span class="n">rblocks</span> <span class="o">+=</span> <span class="n">data_blocks</span> <span class="o">?</span> <span class="n">data_blocks</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">rblocks</span><span class="p">,</span>
					 <span class="n">PAGE_CACHE_SIZE</span><span class="o">/</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_trans_fail</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">fallocate_chunk</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_trans_fail</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">max_bytes</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">max_bytes</span><span class="p">;</span>
		<span class="n">gfs2_inplace_release</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">gfs2_quota_unlock</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">gfs2_qadata_put</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">generic_write_sync</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

<span class="nl">out_trans_fail:</span>
	<span class="n">gfs2_inplace_release</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="nl">out_qunlock:</span>
	<span class="n">gfs2_quota_unlock</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="nl">out_alloc_put:</span>
	<span class="n">gfs2_qadata_put</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
<span class="nl">out_uninit:</span>
	<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_GFS2_FS_LOCKING_DLM</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_setlease - acquire/release a file lease</span>
<span class="cm"> * @file: the file pointer</span>
<span class="cm"> * @arg: lease type</span>
<span class="cm"> * @fl: file lock</span>
<span class="cm"> *</span>
<span class="cm"> * We don&#39;t currently have a way to enforce a lease across the whole</span>
<span class="cm"> * cluster; until we do, disable leases (by just returning -EINVAL),</span>
<span class="cm"> * unless the administrator has requested purely local locking.</span>
<span class="cm"> *</span>
<span class="cm"> * Locking: called under lock_flocks</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_setlease</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">**</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_lock - acquire/release a posix lock on a file</span>
<span class="cm"> * @file: the file pointer</span>
<span class="cm"> * @cmd: either modify or retrieve lock state, possibly wait</span>
<span class="cm"> * @fl: type and range of lock</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm_lockstruct</span> <span class="o">*</span><span class="n">ls</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_lockstruct</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">&amp;</span> <span class="n">FL_POSIX</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__mandatory_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">!=</span> <span class="n">F_UNLCK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">F_CANCELLK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Hack: */</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">F_SETLK</span><span class="p">;</span>
		<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">F_UNLCK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SDF_SHUTDOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GETLK</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">dlm_posix_get</span><span class="p">(</span><span class="n">ls</span><span class="o">-&gt;</span><span class="n">ls_dlm</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">==</span> <span class="n">F_UNLCK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dlm_posix_unlock</span><span class="p">(</span><span class="n">ls</span><span class="o">-&gt;</span><span class="n">ls_dlm</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">dlm_posix_lock</span><span class="p">(</span><span class="n">ls</span><span class="o">-&gt;</span><span class="n">ls_dlm</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_flock</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_file</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">fl_gh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">f_fl_gh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">==</span> <span class="n">F_WRLCK</span><span class="p">)</span> <span class="o">?</span> <span class="n">LM_ST_EXCLUSIVE</span> <span class="o">:</span> <span class="n">LM_ST_SHARED</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">IS_SETLKW</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">LM_FLAG_TRY</span><span class="p">)</span> <span class="o">|</span> <span class="n">GL_EXACT</span> <span class="o">|</span> <span class="n">GL_NOCACHE</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">f_fl_mutex</span><span class="p">);</span>

	<span class="n">gl</span> <span class="o">=</span> <span class="n">fl_gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fl_gh</span><span class="o">-&gt;</span><span class="n">gh_state</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">flock_lock_file_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span><span class="p">){.</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">F_UNLCK</span><span class="p">});</span>
		<span class="n">gfs2_glock_dq_wait</span><span class="p">(</span><span class="n">fl_gh</span><span class="p">);</span>
		<span class="n">gfs2_holder_reinit</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">fl_gh</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_get</span><span class="p">(</span><span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">),</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">gfs2_flock_glops</span><span class="p">,</span> <span class="n">CREATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">gfs2_holder_init</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">fl_gh</span><span class="p">);</span>
		<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq</span><span class="p">(</span><span class="n">fl_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="n">fl_gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">GLR_TRYFAILED</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">flock_lock_file_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
		<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">),</span> <span class="o">!</span><span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">f_fl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_unflock</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_file</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">fl_gh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">f_fl_gh</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">f_fl_mutex</span><span class="p">);</span>
	<span class="n">flock_lock_file_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fl_gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_glock_dq_wait</span><span class="p">(</span><span class="n">fl_gh</span><span class="p">);</span>
		<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="n">fl_gh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">f_fl_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_flock - acquire/release a flock lock on a file</span>
<span class="cm"> * @file: the file pointer</span>
<span class="cm"> * @cmd: either modify or retrieve lock state, possibly wait</span>
<span class="cm"> * @fl: type and range of lock</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_flock</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">&amp;</span> <span class="n">FL_FLOCK</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">&amp;</span> <span class="n">LOCK_MAND</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">==</span> <span class="n">F_UNLCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_unflock</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">do_flock</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">gfs2_file_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">gfs2_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">do_sync_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">aio_read</span>	<span class="o">=</span> <span class="n">generic_file_aio_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">do_sync_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">aio_write</span>	<span class="o">=</span> <span class="n">gfs2_file_aio_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">gfs2_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">gfs2_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">gfs2_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">gfs2_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fsync</span>		<span class="o">=</span> <span class="n">gfs2_fsync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock</span>		<span class="o">=</span> <span class="n">gfs2_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flock</span>		<span class="o">=</span> <span class="n">gfs2_flock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">splice_read</span>	<span class="o">=</span> <span class="n">generic_file_splice_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">splice_write</span>	<span class="o">=</span> <span class="n">generic_file_splice_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setlease</span>	<span class="o">=</span> <span class="n">gfs2_setlease</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fallocate</span>	<span class="o">=</span> <span class="n">gfs2_fallocate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">gfs2_dir_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">readdir</span>	<span class="o">=</span> <span class="n">gfs2_readdir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">gfs2_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">gfs2_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">gfs2_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fsync</span>		<span class="o">=</span> <span class="n">gfs2_fsync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock</span>		<span class="o">=</span> <span class="n">gfs2_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flock</span>		<span class="o">=</span> <span class="n">gfs2_flock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_GFS2_FS_LOCKING_DLM */</span><span class="cp"></span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">gfs2_file_fops_nolock</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">gfs2_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">do_sync_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">aio_read</span>	<span class="o">=</span> <span class="n">generic_file_aio_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">do_sync_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">aio_write</span>	<span class="o">=</span> <span class="n">gfs2_file_aio_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">gfs2_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">gfs2_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">gfs2_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">gfs2_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fsync</span>		<span class="o">=</span> <span class="n">gfs2_fsync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">splice_read</span>	<span class="o">=</span> <span class="n">generic_file_splice_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">splice_write</span>	<span class="o">=</span> <span class="n">generic_file_splice_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setlease</span>	<span class="o">=</span> <span class="n">generic_setlease</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fallocate</span>	<span class="o">=</span> <span class="n">gfs2_fallocate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">gfs2_dir_fops_nolock</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">readdir</span>	<span class="o">=</span> <span class="n">gfs2_readdir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">gfs2_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">gfs2_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">gfs2_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fsync</span>		<span class="o">=</span> <span class="n">gfs2_fsync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
