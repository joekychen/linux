<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › gfs2 › quota.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>quota.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) Sistina Software, Inc.  1997-2003 All rights reserved.</span>
<span class="cm"> * Copyright (C) 2004-2007 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This copyrighted material is made available to anyone wishing to use,</span>
<span class="cm"> * modify, copy, or redistribute it subject to the terms and conditions</span>
<span class="cm"> * of the GNU General Public License version 2.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Quota change tags are associated with each transaction that allocates or</span>
<span class="cm"> * deallocates space.  Those changes are accumulated locally to each node (in a</span>
<span class="cm"> * per-node file) and then are periodically synced to the quota file.  This</span>
<span class="cm"> * avoids the bottleneck of constantly touching the quota file, but introduces</span>
<span class="cm"> * fuzziness in the current usage value of IDs that are being used on different</span>
<span class="cm"> * nodes in the cluster simultaneously.  So, it is possible for a user on</span>
<span class="cm"> * multiple nodes to overrun their quota, but that overrun is controlable.</span>
<span class="cm"> * Since quota tags are part of transactions, there is no need for a quota check</span>
<span class="cm"> * program to be run on node crashes or anything like that.</span>
<span class="cm"> *</span>
<span class="cm"> * There are couple of knobs that let the administrator manage the quota</span>
<span class="cm"> * fuzziness.  &quot;quota_quantum&quot; sets the maximum time a quota change can be</span>
<span class="cm"> * sitting on one node before being synced to the quota file.  (The default is</span>
<span class="cm"> * 60 seconds.)  Another knob, &quot;quota_scale&quot; controls how quickly the frequency</span>
<span class="cm"> * of quota file syncs increases as the user moves closer to their limit.  The</span>
<span class="cm"> * more frequent the syncs, the more accurate the quota enforcement, but that</span>
<span class="cm"> * means that there is more contention between the nodes for the quota file.</span>
<span class="cm"> * The default value is one.  This sets the maximum theoretical quota overrun</span>
<span class="cm"> * (with infinite node with infinite bandwidth) to twice the user&#39;s limit.  (In</span>
<span class="cm"> * practice, the maximum overrun you see should be much less.)  A &quot;quota_scale&quot;</span>
<span class="cm"> * number greater than one makes quota syncs more frequent and reduces the</span>
<span class="cm"> * maximum overrun.  Numbers less than one (but greater than zero) make quota</span>
<span class="cm"> * syncs less frequent.</span>
<span class="cm"> *</span>
<span class="cm"> * GFS quotas also use per-ID Lock Value Blocks (LVBs) to cache the contents of</span>
<span class="cm"> * the quota file, so it is not being constantly read.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/sort.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#include &lt;linux/gfs2_ondisk.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/quota.h&gt;</span>
<span class="cp">#include &lt;linux/dqblk_xfs.h&gt;</span>

<span class="cp">#include &quot;gfs2.h&quot;</span>
<span class="cp">#include &quot;incore.h&quot;</span>
<span class="cp">#include &quot;bmap.h&quot;</span>
<span class="cp">#include &quot;glock.h&quot;</span>
<span class="cp">#include &quot;glops.h&quot;</span>
<span class="cp">#include &quot;log.h&quot;</span>
<span class="cp">#include &quot;meta_io.h&quot;</span>
<span class="cp">#include &quot;quota.h&quot;</span>
<span class="cp">#include &quot;rgrp.h&quot;</span>
<span class="cp">#include &quot;super.h&quot;</span>
<span class="cp">#include &quot;trans.h&quot;</span>
<span class="cp">#include &quot;inode.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>

<span class="cp">#define QUOTA_USER 1</span>
<span class="cp">#define QUOTA_GROUP 0</span>

<span class="k">struct</span> <span class="n">gfs2_quota_change_host</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">qc_change</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qc_flags</span><span class="p">;</span> <span class="cm">/* GFS2_QCF_... */</span>
	<span class="n">u32</span> <span class="n">qc_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">qd_lru_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">qd_lru_count</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">qd_lru_lock</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">gfs2_shrink_qd_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">shrinker</span> <span class="o">*</span><span class="n">shrink</span><span class="p">,</span> <span class="k">struct</span> <span class="n">shrink_control</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_to_scan</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">nr_to_scan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_to_scan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">gfp_mask</span> <span class="o">&amp;</span> <span class="n">__GFP_FS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nr_to_scan</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qd</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">qd_lru_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">gfs2_quota_data</span><span class="p">,</span> <span class="n">qd_reclaim</span><span class="p">);</span>
		<span class="n">sdp</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>

		<span class="cm">/* Free from the filesystem-specific list */</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_list</span><span class="p">);</span>

		<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_change</span><span class="p">);</span>
		<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot_count</span><span class="p">);</span>
		<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_bh_count</span><span class="p">);</span>

		<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_count</span><span class="p">);</span>

		<span class="cm">/* Delete it from the common reclaim list */</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_reclaim</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_count</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">gfs2_quotad_cachep</span><span class="p">,</span> <span class="n">qd</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
		<span class="n">nr_to_scan</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_count</span><span class="p">)</span> <span class="o">*</span> <span class="n">sysctl_vfs_cache_pressure</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">qd2offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_id</span> <span class="o">+</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">*=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qd_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">**</span><span class="n">qdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">qd</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">gfs2_quotad_cachep</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">QDF_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">);</span>
	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_reclaim</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">id</span> <span class="o">+</span> <span class="o">!</span><span class="n">user</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">gfs2_quota_glops</span><span class="p">,</span> <span class="n">CREATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="o">*</span><span class="n">qdp</span> <span class="o">=</span> <span class="n">qd</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">gfs2_quotad_cachep</span><span class="p">,</span> <span class="n">qd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qd_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">**</span><span class="n">qdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">new_qd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="n">found</span><span class="p">;</span>

	<span class="o">*</span><span class="n">qdp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">qd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_list</span><span class="p">,</span> <span class="n">qd_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_id</span> <span class="o">==</span> <span class="n">id</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">)</span> <span class="o">==</span> <span class="o">!</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_reclaim</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* Remove it from reclaim list */</span>
					<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_reclaim</span><span class="p">);</span>
					<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_count</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_count</span><span class="p">);</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
			<span class="n">qd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qd</span> <span class="o">&amp;&amp;</span> <span class="n">new_qd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qd</span> <span class="o">=</span> <span class="n">new_qd</span><span class="p">;</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_list</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_count</span><span class="p">);</span>
			<span class="n">new_qd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_qd</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">new_qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="p">);</span>
				<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">gfs2_quotad_cachep</span><span class="p">,</span> <span class="n">new_qd</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">qdp</span> <span class="o">=</span> <span class="n">qd</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">qd_alloc</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_qd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qd_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>
	<span class="n">gfs2_assert</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_count</span><span class="p">));</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qd_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Add to the reclaim list */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_reclaim</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd_lru_list</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_count</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slot_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot_count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_chunks</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">o</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">o</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">byte</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_bitmap</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">o</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">byte</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

<span class="nl">found:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">b</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="n">o</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot</span> <span class="o">&gt;=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_slots</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_bitmap</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">o</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slot_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
	<span class="n">gfs2_assert</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot_count</span><span class="p">);</span>
	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slot_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
	<span class="n">gfs2_assert</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_icbit_munge</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_bitmap</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_qc_inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="n">bh_map</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">b_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">b_blocknr</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_bh_count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot</span> <span class="o">/</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_qc_per_block</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot</span> <span class="o">%</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_qc_per_block</span><span class="p">;</span>

	<span class="n">bh_map</span><span class="p">.</span><span class="n">b_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_blkbits</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_block_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_read</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh_map</span><span class="p">.</span><span class="n">b_blocknr</span><span class="p">,</span> <span class="n">DIO_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_metatype_check</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="n">GFS2_METATYPE_QC</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_brelse</span><span class="p">;</span>

	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_bh</span> <span class="o">=</span> <span class="n">bh</span><span class="p">;</span>
	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_bh_qc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_change</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">)</span> <span class="o">+</span>
		 <span class="n">offset</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_change</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_brelse:</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_bh_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bh_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_mutex</span><span class="p">);</span>
	<span class="n">gfs2_assert</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_bh_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_bh_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_bh</span><span class="p">);</span>
		<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_bh_qc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qd_fish</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">**</span><span class="n">qdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">qdp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">qd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_list</span><span class="p">,</span> <span class="n">qd_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_CHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_sync_gen</span> <span class="o">&gt;=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_sync_gen</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_list</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">QDF_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">);</span>
		<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_count</span><span class="p">));</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_count</span><span class="p">);</span>
		<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_change_sync</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_change</span><span class="p">;</span>
		<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot_count</span><span class="p">);</span>
		<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="n">qd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_change_sync</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">bh_get</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">QDF_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">);</span>
			<span class="n">slot_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
			<span class="n">qd_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">qdp</span> <span class="o">=</span> <span class="n">qd</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qd_trylock</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_CHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_list</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">QDF_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">);</span>
	<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_count</span><span class="p">));</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_count</span><span class="p">);</span>
	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_change_sync</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_change</span><span class="p">;</span>
	<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot_count</span><span class="p">);</span>
	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>

	<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_change_sync</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bh_get</span><span class="p">(</span><span class="n">qd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">QDF_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">);</span>
		<span class="n">slot_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
		<span class="n">qd_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qd_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">,</span>
			 <span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">));</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QDF_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">);</span>
	<span class="n">bh_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
	<span class="n">slot_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
	<span class="n">qd_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qdsb_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">**</span><span class="n">qdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">qd_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">qdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">slot_get</span><span class="p">(</span><span class="o">*</span><span class="n">qdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">bh_get</span><span class="p">(</span><span class="o">*</span><span class="n">qdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_slot</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_slot:</span>
	<span class="n">slot_put</span><span class="p">(</span><span class="o">*</span><span class="n">qdp</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">qd_put</span><span class="p">(</span><span class="o">*</span><span class="n">qdp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qdsb_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bh_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
	<span class="n">slot_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
	<span class="n">qd_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_quota_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">uid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_qadata</span> <span class="o">*</span><span class="n">qa</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_qadata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">**</span><span class="n">qd</span> <span class="o">=</span> <span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_num</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GIF_QD_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_quota</span> <span class="o">==</span> <span class="n">GFS2_QUOTA_OFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">qdsb_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">QUOTA_USER</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_uid</span><span class="p">,</span> <span class="n">qd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_num</span><span class="o">++</span><span class="p">;</span>
	<span class="n">qd</span><span class="o">++</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">qdsb_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">QUOTA_GROUP</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_gid</span><span class="p">,</span> <span class="n">qd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_num</span><span class="o">++</span><span class="p">;</span>
	<span class="n">qd</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uid</span> <span class="o">!=</span> <span class="n">NO_QUOTA_CHANGE</span> <span class="o">&amp;&amp;</span> <span class="n">uid</span> <span class="o">!=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_uid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">qdsb_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">QUOTA_USER</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">qd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_num</span><span class="o">++</span><span class="p">;</span>
		<span class="n">qd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gid</span> <span class="o">!=</span> <span class="n">NO_QUOTA_CHANGE</span> <span class="o">&amp;&amp;</span> <span class="n">gid</span> <span class="o">!=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_gid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">qdsb_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">QUOTA_GROUP</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">qd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_num</span><span class="o">++</span><span class="p">;</span>
		<span class="n">qd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">gfs2_quota_unhold</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_quota_unhold</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_qadata</span> <span class="o">*</span><span class="n">qa</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_qadata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GIF_QD_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_num</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qdsb_put</span><span class="p">(</span><span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
		<span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sort_qd</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd_a</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">**</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd_b</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">**</span><span class="p">)</span><span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd_a</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd_b</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd_a</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qd_a</span><span class="o">-&gt;</span><span class="n">qd_id</span> <span class="o">&lt;</span> <span class="n">qd_b</span><span class="o">-&gt;</span><span class="n">qd_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qd_a</span><span class="o">-&gt;</span><span class="n">qd_id</span> <span class="o">&gt;</span> <span class="n">qd_b</span><span class="o">-&gt;</span><span class="n">qd_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_qc</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">,</span> <span class="n">s64</span> <span class="n">change</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_qc_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_change</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_bh_qc</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_mutex</span><span class="p">);</span>
	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_CHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">qc_change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">qc_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">))</span>
			<span class="n">qc</span><span class="o">-&gt;</span><span class="n">qc_flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_QCF_USER</span><span class="p">);</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">qc_id</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">qc_change</span><span class="p">)</span> <span class="o">+</span> <span class="n">change</span><span class="p">;</span>
	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">qc_change</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_change</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_CHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">));</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">QDF_CHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">);</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">qc_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">qc_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">slot_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
		<span class="n">qd_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">QDF_CHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qd_hold</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
		<span class="n">slot_hold</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_adjust_quota - adjust record of current block usage</span>
<span class="cm"> * @ip: The quota inode</span>
<span class="cm"> * @loc: Offset of the entry in the quota file</span>
<span class="cm"> * @change: The amount of usage change to record</span>
<span class="cm"> * @qd: The quota data</span>
<span class="cm"> * @fdq: The updated limits to record</span>
<span class="cm"> *</span>
<span class="cm"> * This function was mostly borrowed from gfs2_block_truncate_page which was</span>
<span class="cm"> * in turn mostly borrowed from ext3</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 or -ve on error</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_adjust_quota</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">loc</span><span class="p">,</span>
			     <span class="n">s64</span> <span class="n">change</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fs_disk_quota</span> <span class="o">*</span><span class="n">fdq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span> <span class="o">=</span> <span class="n">loc</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">loc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_CACHE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">iblock</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_quota</span> <span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">qp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">gfs2_unstuff_dinode</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">gfs2_internal_read</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">loc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">qp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">q</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">qu_value</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">qu_value</span><span class="p">);</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">qu_value</span> <span class="o">+=</span> <span class="n">change</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">qu_value</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">qu_value</span><span class="p">);</span>
	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_value</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">qu_value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BSOFT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">qu_warn</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_blk_softlimit</span> <span class="o">&gt;&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_fsb2bb_shift</span><span class="p">);</span>
			<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_warn</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">qu_warn</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BHARD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">qu_limit</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_blk_hardlimit</span> <span class="o">&gt;&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_fsb2bb_shift</span><span class="p">);</span>
			<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_limit</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">qu_limit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BCOUNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">qu_value</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_bcount</span> <span class="o">&gt;&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_fsb2bb_shift</span><span class="p">);</span>
			<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_value</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">qu_value</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Write the quota into the quota file on disk */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">qp</span><span class="p">;</span>
	<span class="n">nbytes</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota</span><span class="p">);</span>
<span class="nl">get_a_page:</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">find_or_create_page</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">blocksize</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="n">iblock</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_CACHE_SHIFT</span> <span class="o">-</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page_has_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">create_empty_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_this_page</span><span class="p">;</span>
		<span class="n">iblock</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_mapped</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfs2_block_map</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">iblock</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_mapped</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unlock_out</span><span class="p">;</span>
		<span class="cm">/* If it&#39;s a newly allocated disk block for quota, zero it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer_new</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
			<span class="n">zero_user</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">set_buffer_uptodate</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_uptodate</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ll_rw_block</span><span class="p">(</span><span class="n">READ</span> <span class="o">|</span> <span class="n">REQ_META</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">wait_on_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_uptodate</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unlock_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">)</span>
		<span class="n">nbytes</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">kaddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
	<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">kaddr</span><span class="p">);</span>
	<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="cm">/* If quota straddles page boundary, we need to update the rest of the</span>
<span class="cm">	 * quota at the beginning of the next page */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">nbytes</span><span class="p">;</span>
		<span class="n">nbytes</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota</span><span class="p">)</span> <span class="o">-</span> <span class="n">nbytes</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">get_a_page</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">loc</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span>
		<span class="n">i_size_write</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_atime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unlock_out:</span>
	<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_sync</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_qd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">**</span><span class="n">qda</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">qda</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_blocks</span><span class="p">,</span> <span class="n">ind_blocks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">ghs</span><span class="p">,</span> <span class="n">i_gh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qx</span><span class="p">,</span> <span class="n">x</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nalloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blocks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">gfs2_write_calc_reserv</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota</span><span class="p">),</span>
			      <span class="o">&amp;</span><span class="n">data_blocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ind_blocks</span><span class="p">);</span>

	<span class="n">ghs</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">num_qd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ghs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sort</span><span class="p">(</span><span class="n">qda</span><span class="p">,</span> <span class="n">num_qd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="p">),</span> <span class="n">sort_qd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mutex</span><span class="p">,</span> <span class="n">I_MUTEX_QUOTA</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">qx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qx</span> <span class="o">&lt;</span> <span class="n">num_qd</span><span class="p">;</span> <span class="n">qx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">qda</span><span class="p">[</span><span class="n">qx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span>
					   <span class="n">GL_NOCACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ghs</span><span class="p">[</span><span class="n">qx</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">num_qd</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">qd2offset</span><span class="p">(</span><span class="n">qda</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_write_alloc_required</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota</span><span class="p">)))</span>
			<span class="n">nalloc</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* </span>
<span class="cm">	 * 1 blk for unstuffing inode if stuffed. We add this extra</span>
<span class="cm">	 * block to the reservation unconditionally. If the inode</span>
<span class="cm">	 * doesn&#39;t need unstuffing, the block will be released to the </span>
<span class="cm">	 * rgrp since it won&#39;t be allocated during the transaction</span>
<span class="cm">	 */</span>
	<span class="cm">/* +3 in the end for unstuffing block, inode size update block</span>
<span class="cm">	 * and another block in case quota straddles page boundary and </span>
<span class="cm">	 * two blocks need to be updated instead of 1 */</span>
	<span class="n">blocks</span> <span class="o">=</span> <span class="n">num_qd</span> <span class="o">*</span> <span class="n">data_blocks</span> <span class="o">+</span> <span class="n">RES_DINODE</span> <span class="o">+</span> <span class="n">num_qd</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_inplace_reserve</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span>
				     <span class="p">(</span><span class="n">nalloc</span> <span class="o">*</span> <span class="p">(</span><span class="n">data_blocks</span> <span class="o">+</span> <span class="n">ind_blocks</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_alloc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nalloc</span><span class="p">)</span>
		<span class="n">blocks</span> <span class="o">+=</span> <span class="n">gfs2_rg_blocks</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="n">nalloc</span> <span class="o">*</span> <span class="n">ind_blocks</span> <span class="o">+</span> <span class="n">RES_STATFS</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_ipres</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">num_qd</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qd</span> <span class="o">=</span> <span class="n">qda</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">qd2offset</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_adjust_quota</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_change_sync</span><span class="p">,</span> <span class="n">qd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_end_trans</span><span class="p">;</span>

		<span class="n">do_qc</span><span class="p">(</span><span class="n">qd</span><span class="p">,</span> <span class="o">-</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_change_sync</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">QDF_REFRESH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_end_trans:</span>
	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
<span class="nl">out_ipres:</span>
	<span class="n">gfs2_inplace_release</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="nl">out_alloc:</span>
	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">qx</span><span class="o">--</span><span class="p">)</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ghs</span><span class="p">[</span><span class="n">qx</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ghs</span><span class="p">);</span>
	<span class="n">gfs2_log_flush</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_qd</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_quota</span> <span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_lvb</span> <span class="o">*</span><span class="n">qlvb</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota</span><span class="p">));</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">qd2offset</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_internal_read</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">qlvb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_lvb</span> <span class="o">*</span><span class="p">)</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_lvb</span><span class="p">;</span>
	<span class="n">qlvb</span><span class="o">-&gt;</span><span class="n">qb_magic</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_MAGIC</span><span class="p">);</span>
	<span class="n">qlvb</span><span class="o">-&gt;</span><span class="n">__pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qlvb</span><span class="o">-&gt;</span><span class="n">qb_limit</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">qu_limit</span><span class="p">;</span>
	<span class="n">qlvb</span><span class="o">-&gt;</span><span class="n">qb_warn</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">qu_warn</span><span class="p">;</span>
	<span class="n">qlvb</span><span class="o">-&gt;</span><span class="n">qb_value</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">qu_value</span><span class="p">;</span>
	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span> <span class="o">=</span> <span class="o">*</span><span class="n">qlvb</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_glock</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force_refresh</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">q_gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">i_gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">restart:</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_lvb</span> <span class="o">*</span><span class="p">)</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_lvb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">force_refresh</span> <span class="o">||</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_magic</span> <span class="o">!=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_MAGIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="n">q_gh</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span>
					   <span class="n">GL_NOCACHE</span><span class="p">,</span> <span class="n">q_gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">update_qd</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">qd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_gunlock</span><span class="p">;</span>

		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="n">q_gh</span><span class="p">);</span>
		<span class="n">force_refresh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_gunlock:</span>
	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="n">q_gh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_quota_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">uid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_qadata</span> <span class="o">*</span><span class="n">qa</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_qadata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_quota_hold</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RESOURCE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_quota</span> <span class="o">!=</span> <span class="n">GFS2_QUOTA_ON</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sort</span><span class="p">(</span><span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd</span><span class="p">,</span> <span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_num</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="p">),</span>
	     <span class="n">sort_qd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_num</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">force</span> <span class="o">=</span> <span class="n">NO_FORCE</span><span class="p">;</span>
		<span class="n">qd</span> <span class="o">=</span> <span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">QDF_REFRESH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">))</span>
			<span class="n">force</span> <span class="o">=</span> <span class="n">FORCE</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">do_glock</span><span class="p">(</span><span class="n">qd</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_ghs</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">GIF_QD_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">x</span><span class="o">--</span><span class="p">)</span>
			<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_ghs</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
		<span class="n">gfs2_quota_unhold</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">need_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_tune</span> <span class="o">*</span><span class="n">gt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_tune</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_limit</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_change</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_spin</span><span class="p">);</span>
	<span class="n">num</span> <span class="o">=</span> <span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_quota_scale_num</span><span class="p">;</span>
	<span class="n">den</span> <span class="o">=</span> <span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_quota_scale_den</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_spin</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">do_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">s64</span><span class="p">)</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_value</span><span class="p">)</span> <span class="o">&gt;=</span>
		 <span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_limit</span><span class="p">))</span>
		<span class="n">do_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">*=</span> <span class="n">gfs2_jindex_size</span><span class="p">(</span><span class="n">sdp</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">div_s64</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">den</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_limit</span><span class="p">))</span>
			<span class="n">do_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">do_sync</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_quota_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_qadata</span> <span class="o">*</span><span class="n">qa</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_qadata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qda</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">GIF_QD_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_num</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">sync</span><span class="p">;</span>

		<span class="n">qd</span> <span class="o">=</span> <span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
		<span class="n">sync</span> <span class="o">=</span> <span class="n">need_sync</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>

		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_ghs</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sync</span> <span class="o">&amp;&amp;</span> <span class="n">qd_trylock</span><span class="p">(</span><span class="n">qd</span><span class="p">))</span>
			<span class="n">qda</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">qd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_sync</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">qda</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
			<span class="n">qd_unlock</span><span class="p">(</span><span class="n">qda</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">gfs2_quota_unhold</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MAX_LINE 256</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">print_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;GFS2: fsid=%s: quota %s for %s %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_fsname</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;user&quot;</span> <span class="o">:</span> <span class="s">&quot;group&quot;</span><span class="p">,</span>
	       <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_quota_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">uid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_qadata</span> <span class="o">*</span><span class="n">qa</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_qadata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GIF_QD_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_quota</span> <span class="o">!=</span> <span class="n">GFS2_QUOTA_ON</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_num</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qd</span> <span class="o">=</span> <span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_id</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">))</span> <span class="o">||</span>
		      <span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_id</span> <span class="o">==</span> <span class="n">gid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">))))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_value</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">+=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_change</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_limit</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_limit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_message</span><span class="p">(</span><span class="n">qd</span><span class="p">,</span> <span class="s">&quot;exceeded&quot;</span><span class="p">);</span>
			<span class="n">quota_send_warning</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">)</span> <span class="o">?</span>
					   <span class="n">USRQUOTA</span> <span class="o">:</span> <span class="n">GRPQUOTA</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_id</span><span class="p">,</span>
					   <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">,</span> <span class="n">QUOTA_NL_BHARDWARN</span><span class="p">);</span>

			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EDQUOT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_warn</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_warn</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">value</span> <span class="o">&amp;&amp;</span>
			   <span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_last_warn</span> <span class="o">+</span>
					 <span class="n">gfs2_tune_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span>
						<span class="n">gt_quota_warn_period</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">quota_send_warning</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">)</span> <span class="o">?</span>
					   <span class="n">USRQUOTA</span> <span class="o">:</span> <span class="n">GRPQUOTA</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_id</span><span class="p">,</span>
					   <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">,</span> <span class="n">QUOTA_NL_BSOFTWARN</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">print_message</span><span class="p">(</span><span class="n">qd</span><span class="p">,</span> <span class="s">&quot;warning&quot;</span><span class="p">);</span>
			<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_last_warn</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_quota_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">s64</span> <span class="n">change</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">uid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_qadata</span> <span class="o">*</span><span class="n">qa</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_qadata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">),</span> <span class="n">change</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_SYSTEM</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd_num</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qd</span> <span class="o">=</span> <span class="n">qa</span><span class="o">-&gt;</span><span class="n">qa_qd</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_id</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_id</span> <span class="o">==</span> <span class="n">gid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">do_qc</span><span class="p">(</span><span class="n">qd</span><span class="p">,</span> <span class="n">change</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_quota_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">**</span><span class="n">qda</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_qd</span> <span class="o">=</span> <span class="n">gfs2_tune_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">gt_quota_simul_sync</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_qd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_sync_gen</span><span class="o">++</span><span class="p">;</span>

	<span class="n">qda</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">max_qd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qda</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">num_qd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">qd_fish</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">qda</span> <span class="o">+</span> <span class="n">num_qd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="o">!</span><span class="n">qda</span><span class="p">[</span><span class="n">num_qd</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">num_qd</span> <span class="o">==</span> <span class="n">max_qd</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num_qd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">do_sync</span><span class="p">(</span><span class="n">num_qd</span><span class="p">,</span> <span class="n">qda</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">num_qd</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
					<span class="n">qda</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">qd_sync_gen</span> <span class="o">=</span>
						<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_sync_gen</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">num_qd</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
				<span class="n">qd_unlock</span><span class="p">(</span><span class="n">qda</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">num_qd</span> <span class="o">==</span> <span class="n">max_qd</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">qda</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_quota_sync_timeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gfs2_quota_sync</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_quota_refresh</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">q_gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">qd_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">do_glock</span><span class="p">(</span><span class="n">qd</span><span class="p">,</span> <span class="n">FORCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q_gh</span><span class="p">);</span>

	<span class="n">qd_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_quota_change_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_change_host</span> <span class="o">*</span><span class="n">qc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_quota_change</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">qc_change</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">qc_change</span><span class="p">);</span>
	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">qc_flags</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">qc_flags</span><span class="p">);</span>
	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">qc_id</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">qc_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_quota_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_qc_inode</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_qc_inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blocks</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize_shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dblock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">extlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_check_internal_file_size</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_qc_inode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_slots</span> <span class="o">=</span> <span class="n">blocks</span> <span class="o">*</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_qc_per_block</span><span class="p">;</span>
	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_chunks</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_slots</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_bitmap</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_chunks</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_bitmap</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_chunks</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_bitmap</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_bitmap</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">blocks</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">extlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_extent_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">extlen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">gfs2_meta_ra</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="n">extlen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_metatype_check</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="n">GFS2_METATYPE_QC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_qc_per_block</span> <span class="o">&amp;&amp;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_slots</span><span class="p">;</span>
		     <span class="n">y</span><span class="o">++</span><span class="p">,</span> <span class="n">slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">gfs2_quota_change_host</span> <span class="n">qc</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">;</span>

			<span class="n">gfs2_quota_change_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qc</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">)</span> <span class="o">+</span>
					  <span class="n">y</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_change</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qc</span><span class="p">.</span><span class="n">qc_change</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">qd_alloc</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="p">(</span><span class="n">qc</span><span class="p">.</span><span class="n">qc_flags</span> <span class="o">&amp;</span> <span class="n">GFS2_QCF_USER</span><span class="p">),</span>
					 <span class="n">qc</span><span class="p">.</span><span class="n">qc_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">QDF_CHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">);</span>
			<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_change</span> <span class="o">=</span> <span class="n">qc</span><span class="p">.</span><span class="n">qc_change</span><span class="p">;</span>
			<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
			<span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
			<span class="n">gfs2_icbit_munge</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_bitmap</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_list</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_count</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>

			<span class="n">found</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">dblock</span><span class="o">++</span><span class="p">;</span>
		<span class="n">extlen</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
		<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;found %u quota changes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">found</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">gfs2_quota_cleanup</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_quota_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qd</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_quota_data</span><span class="p">,</span> <span class="n">qd_list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QDF_CHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_list</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_list</span><span class="p">);</span>
		<span class="cm">/* Also remove if this qd exists in the reclaim list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_reclaim</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_reclaim</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_count</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_count</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_change</span><span class="p">);</span>
			<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot_count</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_slot_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_bh_count</span><span class="p">);</span>

		<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">gfs2_quotad_cachep</span><span class="p">,</span> <span class="n">qd</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_lock</span><span class="p">);</span>

	<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_count</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_bitmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_chunks</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_bitmap</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_bitmap</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">quotad_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SDF_SHUTDOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">))</span>
		<span class="n">fs_err</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;gfs2_quotad: %s error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">quotad_check_timeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fxn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">),</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">timeo</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">new_timeo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="o">*</span><span class="n">timeo</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">fxn</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">quotad_error</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="o">*</span><span class="n">timeo</span> <span class="o">=</span> <span class="n">gfs2_tune_get_i</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_tune</span><span class="p">,</span> <span class="n">new_timeo</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">timeo</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">quotad_check_trunc_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_trunc_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_trunc_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ip</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_trunc_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">gfs2_inode</span><span class="p">,</span> <span class="n">i_trunc_list</span><span class="p">);</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_trunc_list</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_trunc_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">gfs2_glock_finish_truncate</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_wake_up_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_force_sync</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_force_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_wait</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * gfs2_quotad - Write cached quota changes into the quota file</span>
<span class="cm"> * @sdp: Pointer to GFS2 superblock</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_quotad</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_tune</span> <span class="o">*</span><span class="n">tune</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_tune</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">statfs_timeo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">quotad_timeo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">empty</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>

		<span class="cm">/* Update the master statfs file */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_force_sync</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_statfs_sync</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">quotad_error</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;statfs&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="n">statfs_timeo</span> <span class="o">=</span> <span class="n">gfs2_tune_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">gt_statfs_quantum</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">quotad_check_timeo</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;statfs&quot;</span><span class="p">,</span> <span class="n">gfs2_statfs_sync</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span>
				   	   <span class="o">&amp;</span><span class="n">statfs_timeo</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">tune</span><span class="o">-&gt;</span><span class="n">gt_statfs_quantum</span><span class="p">);</span>

		<span class="cm">/* Update quota file */</span>
		<span class="n">quotad_check_timeo</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;sync&quot;</span><span class="p">,</span> <span class="n">gfs2_quota_sync_timeo</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">quotad_timeo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tune</span><span class="o">-&gt;</span><span class="n">gt_quota_quantum</span><span class="p">);</span>

		<span class="cm">/* Check for &amp; recover partially truncated inodes */</span>
		<span class="n">quotad_check_trunc_list</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>

		<span class="n">try_to_freeze</span><span class="p">();</span>

		<span class="n">t</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">quotad_timeo</span><span class="p">,</span> <span class="n">statfs_timeo</span><span class="p">);</span>

		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_trunc_lock</span><span class="p">);</span>
		<span class="n">empty</span> <span class="o">=</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_trunc_list</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_trunc_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">empty</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_force_sync</span><span class="p">)</span>
			<span class="n">t</span> <span class="o">-=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_quota_get_xstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">fs_quota_stat</span> <span class="o">*</span><span class="n">fqs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fqs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fs_quota_stat</span><span class="p">));</span>
	<span class="n">fqs</span><span class="o">-&gt;</span><span class="n">qs_version</span> <span class="o">=</span> <span class="n">FS_QSTAT_VERSION</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_quota</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GFS2_QUOTA_ON</span>:
		<span class="n">fqs</span><span class="o">-&gt;</span><span class="n">qs_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FS_QUOTA_UDQ_ENFD</span> <span class="o">|</span> <span class="n">FS_QUOTA_GDQ_ENFD</span><span class="p">);</span>
		<span class="cm">/*FALLTHRU*/</span>
	<span class="k">case</span> <span class="n">GFS2_QUOTA_ACCOUNT</span>:
		<span class="n">fqs</span><span class="o">-&gt;</span><span class="n">qs_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FS_QUOTA_UDQ_ACCT</span> <span class="o">|</span> <span class="n">FS_QUOTA_GDQ_ACCT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GFS2_QUOTA_OFF</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_inode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fqs</span><span class="o">-&gt;</span><span class="n">qs_uquota</span><span class="p">.</span><span class="n">qfs_ino</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">;</span>
		<span class="n">fqs</span><span class="o">-&gt;</span><span class="n">qs_uquota</span><span class="p">.</span><span class="n">qfs_nblks</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_inode</span><span class="o">-&gt;</span><span class="n">i_blocks</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fqs</span><span class="o">-&gt;</span><span class="n">qs_uquota</span><span class="p">.</span><span class="n">qfs_nextents</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* unsupported */</span>
	<span class="n">fqs</span><span class="o">-&gt;</span><span class="n">qs_gquota</span> <span class="o">=</span> <span class="n">fqs</span><span class="o">-&gt;</span><span class="n">qs_uquota</span><span class="p">;</span> <span class="cm">/* its the same inode in both cases */</span>
	<span class="n">fqs</span><span class="o">-&gt;</span><span class="n">qs_incoredqs</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd_lru_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_get_dqblk</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">qid_t</span> <span class="n">id</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">fs_disk_quota</span> <span class="o">*</span><span class="n">fdq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_lvb</span> <span class="o">*</span><span class="n">qlvb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">q_gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fdq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fs_disk_quota</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_quota</span> <span class="o">==</span> <span class="n">GFS2_QUOTA_OFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span> <span class="cm">/* Crazy XFS error code */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">USRQUOTA</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">QUOTA_USER</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">GRPQUOTA</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">QUOTA_GROUP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">qd_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">do_glock</span><span class="p">(</span><span class="n">qd</span><span class="p">,</span> <span class="n">FORCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">qlvb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota_lvb</span> <span class="o">*</span><span class="p">)</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="o">-&gt;</span><span class="n">gl_lvb</span><span class="p">;</span>
	<span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_version</span> <span class="o">=</span> <span class="n">FS_DQUOT_VERSION</span><span class="p">;</span>
	<span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">QUOTA_USER</span><span class="p">)</span> <span class="o">?</span> <span class="n">FS_USER_QUOTA</span> <span class="o">:</span> <span class="n">FS_GROUP_QUOTA</span><span class="p">;</span>
	<span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_blk_hardlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qlvb</span><span class="o">-&gt;</span><span class="n">qb_limit</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_fsb2bb_shift</span><span class="p">;</span>
	<span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_blk_softlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qlvb</span><span class="o">-&gt;</span><span class="n">qb_warn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_fsb2bb_shift</span><span class="p">;</span>
	<span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_bcount</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qlvb</span><span class="o">-&gt;</span><span class="n">qb_value</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_fsb2bb_shift</span><span class="p">;</span>

	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q_gh</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">qd_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* GFS2 only supports a subset of the XFS fields */</span>
<span class="cp">#define GFS2_FIELDMASK (FS_DQ_BSOFT|FS_DQ_BHARD|FS_DQ_BCOUNT)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_set_dqblk</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">qid_t</span> <span class="n">id</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">fs_disk_quota</span> <span class="o">*</span><span class="n">fdq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_quota_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">q_gh</span><span class="p">,</span> <span class="n">i_gh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_blocks</span><span class="p">,</span> <span class="n">ind_blocks</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alloc_required</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_quota</span> <span class="o">==</span> <span class="n">GFS2_QUOTA_OFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span> <span class="cm">/* Crazy XFS error code */</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USRQUOTA</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="n">QUOTA_USER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_flags</span> <span class="o">!=</span> <span class="n">FS_USER_QUOTA</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GRPQUOTA</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="n">QUOTA_GROUP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_flags</span> <span class="o">!=</span> <span class="n">FS_GROUP_QUOTA</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GFS2_FIELDMASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_id</span> <span class="o">!=</span> <span class="n">id</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">qd_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_q</span><span class="p">;</span>

	<span class="cm">/* Check for existing entry, if none then alloc new blocks */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">update_qd</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">qd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_i</span><span class="p">;</span>

	<span class="cm">/* If nothing has changed, this is a no-op */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BSOFT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_blk_softlimit</span> <span class="o">&gt;&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_fsb2bb_shift</span><span class="p">)</span> <span class="o">==</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_warn</span><span class="p">)))</span>
		<span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">^=</span> <span class="n">FS_DQ_BSOFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BHARD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_blk_hardlimit</span> <span class="o">&gt;&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_fsb2bb_shift</span><span class="p">)</span> <span class="o">==</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_limit</span><span class="p">)))</span>
		<span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">^=</span> <span class="n">FS_DQ_BHARD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BCOUNT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_bcount</span> <span class="o">&gt;&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_fsb2bb_shift</span><span class="p">)</span> <span class="o">==</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">qd_qb</span><span class="p">.</span><span class="n">qb_value</span><span class="p">)))</span>
		<span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">^=</span> <span class="n">FS_DQ_BCOUNT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fdq</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_i</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">qd2offset</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
	<span class="n">alloc_required</span> <span class="o">=</span> <span class="n">gfs2_write_alloc_required</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">alloc_required</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_required</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_write_calc_reserv</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_quota</span><span class="p">),</span>
				       <span class="o">&amp;</span><span class="n">data_blocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ind_blocks</span><span class="p">);</span>
		<span class="n">blocks</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">data_blocks</span> <span class="o">+</span> <span class="n">ind_blocks</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_inplace_reserve</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">blocks</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_i</span><span class="p">;</span>
		<span class="n">blocks</span> <span class="o">+=</span> <span class="n">gfs2_rg_blocks</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Some quotas span block boundaries and can update two blocks,</span>
<span class="cm">	   adding an extra block to the transaction to handle such quotas */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">blocks</span> <span class="o">+</span> <span class="n">RES_DINODE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_release</span><span class="p">;</span>

	<span class="cm">/* Apply changes */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_adjust_quota</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qd</span><span class="p">,</span> <span class="n">fdq</span><span class="p">);</span>

	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
<span class="nl">out_release:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_required</span><span class="p">)</span>
		<span class="n">gfs2_inplace_release</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="nl">out_i:</span>
	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
<span class="nl">out_q:</span>
	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q_gh</span><span class="p">);</span>
<span class="nl">out_put:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="n">qd_put</span><span class="p">(</span><span class="n">qd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">quotactl_ops</span> <span class="n">gfs2_quotactl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quota_sync</span>     <span class="o">=</span> <span class="n">gfs2_quota_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_xstate</span>     <span class="o">=</span> <span class="n">gfs2_quota_get_xstate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_dqblk</span>	<span class="o">=</span> <span class="n">gfs2_get_dqblk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dqblk</span>	<span class="o">=</span> <span class="n">gfs2_set_dqblk</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
