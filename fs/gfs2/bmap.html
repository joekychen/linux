<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › gfs2 › bmap.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>bmap.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) Sistina Software, Inc.  1997-2003 All rights reserved.</span>
<span class="cm"> * Copyright (C) 2004-2006 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This copyrighted material is made available to anyone wishing to use,</span>
<span class="cm"> * modify, copy, or redistribute it subject to the terms and conditions</span>
<span class="cm"> * of the GNU General Public License version 2.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/gfs2_ondisk.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>

<span class="cp">#include &quot;gfs2.h&quot;</span>
<span class="cp">#include &quot;incore.h&quot;</span>
<span class="cp">#include &quot;bmap.h&quot;</span>
<span class="cp">#include &quot;glock.h&quot;</span>
<span class="cp">#include &quot;inode.h&quot;</span>
<span class="cp">#include &quot;meta_io.h&quot;</span>
<span class="cp">#include &quot;quota.h&quot;</span>
<span class="cp">#include &quot;rgrp.h&quot;</span>
<span class="cp">#include &quot;super.h&quot;</span>
<span class="cp">#include &quot;trans.h&quot;</span>
<span class="cp">#include &quot;dir.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;trace_gfs2.h&quot;</span>

<span class="cm">/* This doesn&#39;t need to be that large as max 64 bit pointers in a 4k</span>
<span class="cm"> * block is 512, so __u16 is fine for that. It saves stack space to</span>
<span class="cm"> * keep it small.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">metapath</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">GFS2_MAX_META_HEIGHT</span><span class="p">];</span>
	<span class="n">__u16</span> <span class="n">mp_list</span><span class="p">[</span><span class="n">GFS2_MAX_META_HEIGHT</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">strip_mine</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">sm_first</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sm_height</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_unstuffer_page - unstuff a stuffed inode into a block cached by a page</span>
<span class="cm"> * @ip: the inode</span>
<span class="cm"> * @dibh: the dinode buffer</span>
<span class="cm"> * @block: the block number that was allocated</span>
<span class="cm"> * @page: The (optional) page. This is looked up if @page is NULL</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_unstuffer_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="n">block</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span> <span class="o">||</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">find_or_create_page</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">release</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">u64</span> <span class="n">dsize</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
 
		<span class="k">if</span> <span class="p">(</span><span class="n">dsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">)))</span>
			<span class="n">dsize</span> <span class="o">=</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">kaddr</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">),</span> <span class="n">dsize</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">kaddr</span> <span class="o">+</span> <span class="n">dsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">-</span> <span class="n">dsize</span><span class="p">);</span>
		<span class="n">kunmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page_has_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">create_empty_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">,</span>
				     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BH_Uptodate</span><span class="p">));</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_mapped</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
		<span class="n">map_bh</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>

	<span class="n">set_buffer_uptodate</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_is_jdata</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">mark_buffer_dirty</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_is_writeback</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">release</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_unstuff_dinode - Unstuff a dinode when the data has grown too big</span>
<span class="cm"> * @ip: The GFS2 inode to unstuff</span>
<span class="cm"> * @page: The (optional) page. This is looked up if the @page is NULL</span>
<span class="cm"> *</span>
<span class="cm"> * This routine unstuffs a dinode and returns it to a &quot;normal&quot; state such</span>
<span class="cm"> * that the height can be grown in the traditional way.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_unstuff_dinode</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_dinode</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">isdir</span> <span class="o">=</span> <span class="n">gfs2_is_dir</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rw_mutex</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i_size_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Get a free block, fill it with the stuffed data,</span>
<span class="cm">		   and write it out to disk */</span>

		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_alloc_blocks</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_brelse</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isdir</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gfs2_trans_add_unrevoke</span><span class="p">(</span><span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">),</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_dir_get_new_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_brelse</span><span class="p">;</span>
			<span class="n">gfs2_buffer_copy_tail</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">),</span>
					      <span class="n">dibh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_unstuffer_page</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_brelse</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*  Set up the pointer to the new block  */</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span> <span class="o">*</span><span class="p">)</span><span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="n">gfs2_buffer_clear_tail</span><span class="p">(</span><span class="n">dibh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i_size_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">di</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
		<span class="n">gfs2_add_inode_blocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">di_blocks</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">gfs2_get_inode_blocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">di_height</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nl">out_brelse:</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rw_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * find_metapath - Find path through the metadata tree</span>
<span class="cm"> * @sdp: The superblock</span>
<span class="cm"> * @mp: The metapath to return the result in</span>
<span class="cm"> * @block: The disk block to look up</span>
<span class="cm"> * @height: The pre-calculated height of the metadata tree</span>
<span class="cm"> *</span>
<span class="cm"> *   This routine returns a struct metapath structure that defines a path</span>
<span class="cm"> *   through the metadata of inode &quot;ip&quot; to get to block &quot;block&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> *   Example:</span>
<span class="cm"> *   Given:  &quot;ip&quot; is a height 3 file, &quot;offset&quot; is 101342453, and this is a</span>
<span class="cm"> *   filesystem with a blocksize of 4096.</span>
<span class="cm"> *</span>
<span class="cm"> *   find_metapath() would return a struct metapath structure set to:</span>
<span class="cm"> *   mp_offset = 101342453, mp_height = 3, mp_list[0] = 0, mp_list[1] = 48,</span>
<span class="cm"> *   and mp_list[2] = 165.</span>
<span class="cm"> *</span>
<span class="cm"> *   That means that in order to get to the block containing the byte at</span>
<span class="cm"> *   offset 101342453, we would load the indirect block pointed to by pointer</span>
<span class="cm"> *   0 in the dinode.  We would then load the indirect block pointed to by</span>
<span class="cm"> *   pointer 48 in that indirect block.  We would then load the data block</span>
<span class="cm"> *   pointed to by pointer 165 in that indirect block.</span>
<span class="cm"> *</span>
<span class="cm"> *             ----------------------------------------</span>
<span class="cm"> *             | Dinode |                             |</span>
<span class="cm"> *             |        |                            4|</span>
<span class="cm"> *             |        |0 1 2 3 4 5                 9|</span>
<span class="cm"> *             |        |                            6|</span>
<span class="cm"> *             ----------------------------------------</span>
<span class="cm"> *                       |</span>
<span class="cm"> *                       |</span>
<span class="cm"> *                       V</span>
<span class="cm"> *             ----------------------------------------</span>
<span class="cm"> *             | Indirect Block                       |</span>
<span class="cm"> *             |                                     5|</span>
<span class="cm"> *             |            4 4 4 4 4 5 5            1|</span>
<span class="cm"> *             |0           5 6 7 8 9 0 1            2|</span>
<span class="cm"> *             ----------------------------------------</span>
<span class="cm"> *                                |</span>
<span class="cm"> *                                |</span>
<span class="cm"> *                                V</span>
<span class="cm"> *             ----------------------------------------</span>
<span class="cm"> *             | Indirect Block                       |</span>
<span class="cm"> *             |                         1 1 1 1 1   5|</span>
<span class="cm"> *             |                         6 6 6 6 6   1|</span>
<span class="cm"> *             |0                        3 4 5 6 7   2|</span>
<span class="cm"> *             ----------------------------------------</span>
<span class="cm"> *                                           |</span>
<span class="cm"> *                                           |</span>
<span class="cm"> *                                           V</span>
<span class="cm"> *             ----------------------------------------</span>
<span class="cm"> *             | Data block containing offset         |</span>
<span class="cm"> *             |            101342453                 |</span>
<span class="cm"> *             |                                      |</span>
<span class="cm"> *             |                                      |</span>
<span class="cm"> *             ----------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">find_metapath</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">block</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">metapath</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_inptrs</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">metapath_branch_start</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">metapath</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * metapointer - Return pointer to start of metadata in a buffer</span>
<span class="cm"> * @height: The metadata height (0 = dinode)</span>
<span class="cm"> * @mp: The metapath</span>
<span class="cm"> *</span>
<span class="cm"> * Return a pointer to the block number of the next height of the metadata</span>
<span class="cm"> * tree given a buffer containing the pointer to the current height of the</span>
<span class="cm"> * metadata tree.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be64</span> <span class="o">*</span><span class="nf">metapointer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">metapath</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">height</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">head_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">)</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">head_size</span><span class="p">))</span> <span class="o">+</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_list</span><span class="p">[</span><span class="n">height</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_metapath_ra</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="k">const</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">rabh</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">endp</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">endp</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">t</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">rabh</span> <span class="o">=</span> <span class="n">gfs2_getbuf</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">),</span> <span class="n">CREATE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trylock_buffer</span><span class="p">(</span><span class="n">rabh</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_uptodate</span><span class="p">(</span><span class="n">rabh</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rabh</span><span class="o">-&gt;</span><span class="n">b_end_io</span> <span class="o">=</span> <span class="n">end_buffer_read_sync</span><span class="p">;</span>
				<span class="n">submit_bh</span><span class="p">(</span><span class="n">READA</span> <span class="o">|</span> <span class="n">REQ_META</span><span class="p">,</span> <span class="n">rabh</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">unlock_buffer</span><span class="p">(</span><span class="n">rabh</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">rabh</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lookup_metapath - Walk the metadata tree to a specific point</span>
<span class="cm"> * @ip: The inode</span>
<span class="cm"> * @mp: The metapath</span>
<span class="cm"> *</span>
<span class="cm"> * Assumes that the inode&#39;s buffer has already been looked up and</span>
<span class="cm"> * hooked onto mp-&gt;mp_bh[0] and that the metapath has been initialised</span>
<span class="cm"> * by find_metapath().</span>
<span class="cm"> *</span>
<span class="cm"> * If this function encounters part of the tree which has not been</span>
<span class="cm"> * allocated, it returns the current height of the tree at the point</span>
<span class="cm"> * at which it found the unallocated block. Blocks which are found are</span>
<span class="cm"> * added to the mp-&gt;mp_bh[] list.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: error or height of metadata tree</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lookup_metapath</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">metapath</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">end_of_metadata</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dblock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">end_of_metadata</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">metapointer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mp</span><span class="p">);</span>
		<span class="n">dblock</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dblock</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_meta_indirect_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">release_metapath</span><span class="p">(</span><span class="k">struct</span> <span class="n">metapath</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GFS2_MAX_META_HEIGHT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_extent_length - Returns length of an extent of blocks</span>
<span class="cm"> * @start: Start of the buffer</span>
<span class="cm"> * @len: Length of the buffer in bytes</span>
<span class="cm"> * @ptr: Current position in the buffer</span>
<span class="cm"> * @limit: Max extent length to return (0 = unlimited)</span>
<span class="cm"> * @eob: Set to 1 if we hit &quot;end of block&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * If the first block is zero (unallocated) it will return the number of</span>
<span class="cm"> * unallocated blocks in the extent, otherwise it will return the number</span>
<span class="cm"> * of contiguous blocks in the extent.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: The length of the extent (minimum of one block)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">gfs2_extent_length</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">limit</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">d</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

	<span class="o">*</span><span class="n">eob</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">limit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span>
			<span class="n">d</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span>
		<span class="o">*</span><span class="n">eob</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">-</span> <span class="n">first</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bmap_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">create</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">create</span><span class="p">)</span>
		<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rw_mutex</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rw_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bmap_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">create</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">create</span><span class="p">)</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rw_mutex</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rw_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be64</span> <span class="o">*</span><span class="nf">gfs2_indirect_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">metapath</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u64</span> <span class="n">bn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span>
		       <span class="p">((</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">)</span> <span class="o">:</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">)));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gfs2_meta_new</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">bn</span><span class="p">);</span>
	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_metatype_set</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">GFS2_METATYPE_IN</span><span class="p">,</span> <span class="n">GFS2_FORMAT_IN</span><span class="p">);</span>
	<span class="n">gfs2_buffer_clear_tail</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">));</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">bn</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">alloc_state</span> <span class="p">{</span>
	<span class="n">ALLOC_DATA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">ALLOC_GROW_DEPTH</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ALLOC_GROW_HEIGHT</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="cm">/* ALLOC_UNSTUFF = 3,   TBD and rather complicated */</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_bmap_alloc - Build a metadata tree of the requested height</span>
<span class="cm"> * @inode: The GFS2 inode</span>
<span class="cm"> * @lblock: The logical starting block of the extent</span>
<span class="cm"> * @bh_map: This is used to return the mapping details</span>
<span class="cm"> * @mp: The metapath</span>
<span class="cm"> * @sheight: The starting height (i.e. whats already mapped)</span>
<span class="cm"> * @height: The height to build to</span>
<span class="cm"> * @maxlen: The max number of data blocks to alloc</span>
<span class="cm"> *</span>
<span class="cm"> * In this routine we may have to alloc:</span>
<span class="cm"> *   i) Indirect blocks to grow the metadata tree height</span>
<span class="cm"> *  ii) Indirect blocks to fill in lower part of the metadata tree</span>
<span class="cm"> * iii) Data blocks</span>
<span class="cm"> *</span>
<span class="cm"> * The function is in two parts. The first part works out the total</span>
<span class="cm"> * number of blocks which we need. The second part does the actual</span>
<span class="cm"> * allocation asking for an extent at a time (if enough contiguous free</span>
<span class="cm"> * blocks are available, there will only be one request per bmap call)</span>
<span class="cm"> * and uses the state machine to initialise the blocks in order.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno on error</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_bmap_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">const</span> <span class="n">sector_t</span> <span class="n">lblock</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh_map</span><span class="p">,</span> <span class="k">struct</span> <span class="n">metapath</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sheight</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">bn</span><span class="p">,</span> <span class="n">dblock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">blks</span><span class="p">,</span> <span class="n">alloced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iblks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">branch_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">dblks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ptrs_per_blk</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">end_of_metadata</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eob</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">alloc_state</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">zero_bn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sheight</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dibh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">==</span> <span class="n">sheight</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
		<span class="cm">/* Bottom indirect block exists, find unalloced extent size */</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">metapointer</span><span class="p">(</span><span class="n">end_of_metadata</span><span class="p">,</span> <span class="n">mp</span><span class="p">);</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">end_of_metadata</span><span class="p">];</span>
		<span class="n">dblks</span> <span class="o">=</span> <span class="n">gfs2_extent_length</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">eob</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dblks</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">ALLOC_DATA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Need to allocate indirect blocks */</span>
		<span class="n">ptrs_per_blk</span> <span class="o">=</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_inptrs</span> <span class="o">:</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_diptrs</span><span class="p">;</span>
		<span class="n">dblks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">maxlen</span><span class="p">,</span> <span class="n">ptrs_per_blk</span> <span class="o">-</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_list</span><span class="p">[</span><span class="n">end_of_metadata</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">==</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Writing into existing tree, extend tree down */</span>
			<span class="n">iblks</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="n">sheight</span><span class="p">;</span>
			<span class="n">state</span> <span class="o">=</span> <span class="n">ALLOC_GROW_DEPTH</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Building up tree height */</span>
			<span class="n">state</span> <span class="o">=</span> <span class="n">ALLOC_GROW_HEIGHT</span><span class="p">;</span>
			<span class="n">iblks</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span><span class="p">;</span>
			<span class="n">branch_start</span> <span class="o">=</span> <span class="n">metapath_branch_start</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="n">iblks</span> <span class="o">+=</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">branch_start</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* start of the second part of the function (state machine) */</span>

	<span class="n">blks</span> <span class="o">=</span> <span class="n">dblks</span> <span class="o">+</span> <span class="n">iblks</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">sheight</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">blks</span> <span class="o">-</span> <span class="n">alloced</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_alloc_blocks</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">alloced</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ALLOC_DATA</span> <span class="o">||</span> <span class="n">gfs2_is_jdata</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
			<span class="n">gfs2_trans_add_unrevoke</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Growing height of tree */</span>
		<span class="k">case</span> <span class="n">ALLOC_GROW_HEIGHT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>
				<span class="n">zero_bn</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">height</span> <span class="o">-</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">n</span><span class="o">--</span><span class="p">)</span>
				<span class="n">gfs2_indirect_init</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bn</span><span class="o">++</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">height</span> <span class="o">-</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>
				<span class="n">gfs2_buffer_copy_tail</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">),</span>
						<span class="n">dibh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>
				<span class="n">gfs2_buffer_clear_tail</span><span class="p">(</span><span class="n">dibh</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">)</span> <span class="o">+</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">__be64</span><span class="p">));</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">));</span>
				<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">zero_bn</span><span class="p">;</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">ALLOC_GROW_DEPTH</span><span class="p">;</span>
				<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">branch_start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">brelse</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">branch_start</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Branching from existing tree */</span>
		<span class="k">case</span> <span class="n">ALLOC_GROW_DEPTH</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">)</span>
				<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">n</span><span class="o">--</span><span class="p">)</span>
				<span class="n">gfs2_indirect_init</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						   <span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_list</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bn</span><span class="o">++</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">height</span><span class="p">)</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">ALLOC_DATA</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Tree complete, adding data blocks */</span>
		<span class="k">case</span> <span class="n">ALLOC_DATA</span>:
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">dblks</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">end_of_metadata</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">end_of_metadata</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">dblks</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">metapointer</span><span class="p">(</span><span class="n">end_of_metadata</span><span class="p">,</span> <span class="n">mp</span><span class="p">);</span>
			<span class="n">dblock</span> <span class="o">=</span> <span class="n">bn</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">bn</span><span class="o">++</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buffer_zeronew</span><span class="p">(</span><span class="n">bh_map</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">sb_issue_zeroout</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="n">dblks</span><span class="p">,</span>
						       <span class="n">GFP_NOFS</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fs_err</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span>
					       <span class="s">&quot;Failed to zero data buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">clear_buffer_zeronew</span><span class="p">(</span><span class="n">bh_map</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ALLOC_DATA</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">dblock</span><span class="p">);</span>

	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">gfs2_add_inode_blocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="n">alloced</span><span class="p">);</span>
	<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_bh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
	<span class="n">map_bh</span><span class="p">(</span><span class="n">bh_map</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">dblock</span><span class="p">);</span>
	<span class="n">bh_map</span><span class="o">-&gt;</span><span class="n">b_size</span> <span class="o">=</span> <span class="n">dblks</span> <span class="o">&lt;&lt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">;</span>
	<span class="n">set_buffer_new</span><span class="p">(</span><span class="n">bh_map</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_block_map - Map a block from an inode to a disk block</span>
<span class="cm"> * @inode: The inode</span>
<span class="cm"> * @lblock: The logical block number</span>
<span class="cm"> * @bh_map: The bh to be mapped</span>
<span class="cm"> * @create: True if its ok to alloc blocks to satify the request</span>
<span class="cm"> *</span>
<span class="cm"> * Sets buffer_mapped() if successful, sets buffer_boundary() if a</span>
<span class="cm"> * read of metadata will be required before the next block can be</span>
<span class="cm"> * mapped. Sets buffer_new() if new blocks were allocated.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_block_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">lblock</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh_map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">create</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bsize</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxlen</span> <span class="o">=</span> <span class="n">bh_map</span><span class="o">-&gt;</span><span class="n">b_size</span> <span class="o">&gt;&gt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">arr</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_heightsize</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapath</span> <span class="n">mp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eob</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">height</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">maxlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mp</span><span class="p">.</span><span class="n">mp_bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mp</span><span class="p">.</span><span class="n">mp_bh</span><span class="p">));</span>
	<span class="n">bmap_lock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">create</span><span class="p">);</span>
	<span class="n">clear_buffer_mapped</span><span class="p">(</span><span class="n">bh_map</span><span class="p">);</span>
	<span class="n">clear_buffer_new</span><span class="p">(</span><span class="n">bh_map</span><span class="p">);</span>
	<span class="n">clear_buffer_boundary</span><span class="p">(</span><span class="n">bh_map</span><span class="p">);</span>
	<span class="n">trace_gfs2_bmap</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bh_map</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="n">create</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_dir</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bsize</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jbsize</span><span class="p">;</span>
		<span class="n">arr</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jheightsize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="p">.</span><span class="n">mp_bh</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">height</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">lblock</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">bsize</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">arr</span><span class="p">[</span><span class="n">height</span><span class="p">])</span>
		<span class="n">height</span><span class="o">++</span><span class="p">;</span>
	<span class="n">find_metapath</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span> <span class="o">||</span> <span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">do_alloc</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lookup_metapath</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_alloc</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">metapointer</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_alloc</span><span class="p">;</span>
	<span class="n">map_bh</span><span class="p">(</span><span class="n">bh_map</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">));</span>
	<span class="n">bh</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="n">mp_bh</span><span class="p">[</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">gfs2_extent_length</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eob</span><span class="p">);</span>
	<span class="n">bh_map</span><span class="o">-&gt;</span><span class="n">b_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eob</span><span class="p">)</span>
		<span class="n">set_buffer_boundary</span><span class="p">(</span><span class="n">bh_map</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_metapath</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">trace_gfs2_bmap</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bh_map</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="n">create</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">bmap_unlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">create</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">do_alloc:</span>
	<span class="cm">/* All allocations are done here, firstly check create flag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">create</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* At this point ret is the tree depth of already allocated blocks */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_bmap_alloc</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="n">bh_map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Deprecated: do not use in new code</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gfs2_extent_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">u64</span> <span class="n">lblock</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">dblock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">extlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="n">bh</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">b_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">b_blocknr</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">create</span> <span class="o">=</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">extlen</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dblock</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">);</span>

	<span class="n">bh</span><span class="p">.</span><span class="n">b_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span> <span class="o">+</span> <span class="p">(</span><span class="n">create</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">5</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_block_map</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">,</span> <span class="n">create</span><span class="p">);</span>
	<span class="o">*</span><span class="n">extlen</span> <span class="o">=</span> <span class="n">bh</span><span class="p">.</span><span class="n">b_size</span> <span class="o">&gt;&gt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">;</span>
	<span class="o">*</span><span class="n">dblock</span> <span class="o">=</span> <span class="n">bh</span><span class="p">.</span><span class="n">b_blocknr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bh</span><span class="p">))</span>
		<span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_strip - Look for a layer a particular layer of the file and strip it off</span>
<span class="cm"> * @ip: the inode</span>
<span class="cm"> * @dibh: the dinode buffer</span>
<span class="cm"> * @bh: A buffer of pointers</span>
<span class="cm"> * @top: The first pointer in the buffer</span>
<span class="cm"> * @bottom: One more than the last pointer</span>
<span class="cm"> * @height: the height this buffer is at</span>
<span class="cm"> * @data: a pointer to a struct strip_mine</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_strip</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">top</span><span class="p">,</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">bottom</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strip_mine</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrp_list</span> <span class="n">rlist</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bn</span><span class="p">,</span> <span class="n">bstart</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">blen</span><span class="p">,</span> <span class="n">btotal</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rg_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">metadata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">revokes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_rindex_update</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">top</span><span class="p">)</span>
		<span class="n">sm</span><span class="o">-&gt;</span><span class="n">sm_first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">!=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">sm_height</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">sm_first</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">top</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sm</span><span class="o">-&gt;</span><span class="n">sm_first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">metadata</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">!=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
		<span class="n">revokes</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span><span class="p">)</span> <span class="o">?</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_inptrs</span> <span class="o">:</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_diptrs</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="p">)</span>
		<span class="n">revokes</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_inptrs</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rlist</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrp_list</span><span class="p">));</span>
	<span class="n">bstart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">blen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">top</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">bottom</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">p</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">bn</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bstart</span> <span class="o">+</span> <span class="n">blen</span> <span class="o">==</span> <span class="n">bn</span><span class="p">)</span>
			<span class="n">blen</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bstart</span><span class="p">)</span>
				<span class="n">gfs2_rlist_add</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlist</span><span class="p">,</span> <span class="n">bstart</span><span class="p">);</span>

			<span class="n">bstart</span> <span class="o">=</span> <span class="n">bn</span><span class="p">;</span>
			<span class="n">blen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bstart</span><span class="p">)</span>
		<span class="n">gfs2_rlist_add</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlist</span><span class="p">,</span> <span class="n">bstart</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* Nothing to do */</span>

	<span class="n">gfs2_rlist_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rlist</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">rlist</span><span class="p">.</span><span class="n">rl_rgrps</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">;</span>
		<span class="n">rgd</span> <span class="o">=</span> <span class="n">rlist</span><span class="p">.</span><span class="n">rl_ghs</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_object</span><span class="p">;</span>
		<span class="n">rg_blocks</span> <span class="o">+=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_m</span><span class="p">(</span><span class="n">rlist</span><span class="p">.</span><span class="n">rl_rgrps</span><span class="p">,</span> <span class="n">rlist</span><span class="p">.</span><span class="n">rl_ghs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_rlist</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">rg_blocks</span> <span class="o">+</span> <span class="n">RES_DINODE</span> <span class="o">+</span>
				 <span class="n">RES_INDIRECT</span> <span class="o">+</span> <span class="n">RES_STATFS</span> <span class="o">+</span> <span class="n">RES_QUOTA</span><span class="p">,</span>
				 <span class="n">revokes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_rg_gunlock</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rw_mutex</span><span class="p">);</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">bstart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">blen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">btotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">top</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">bottom</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">p</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">bn</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bstart</span> <span class="o">+</span> <span class="n">blen</span> <span class="o">==</span> <span class="n">bn</span><span class="p">)</span>
			<span class="n">blen</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bstart</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">__gfs2_free_blocks</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bstart</span><span class="p">,</span> <span class="n">blen</span><span class="p">,</span> <span class="n">metadata</span><span class="p">);</span>
				<span class="n">btotal</span> <span class="o">+=</span> <span class="n">blen</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">bstart</span> <span class="o">=</span> <span class="n">bn</span><span class="p">;</span>
			<span class="n">blen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gfs2_add_inode_blocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bstart</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__gfs2_free_blocks</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bstart</span><span class="p">,</span> <span class="n">blen</span><span class="p">,</span> <span class="n">metadata</span><span class="p">);</span>
		<span class="n">btotal</span> <span class="o">+=</span> <span class="n">blen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gfs2_statfs_change</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">btotal</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gfs2_quota_change</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">btotal</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_uid</span><span class="p">,</span>
			  <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_gid</span><span class="p">);</span>

	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>

	<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>

	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rw_mutex</span><span class="p">);</span>

	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>

<span class="nl">out_rg_gunlock:</span>
	<span class="n">gfs2_glock_dq_m</span><span class="p">(</span><span class="n">rlist</span><span class="p">.</span><span class="n">rl_rgrps</span><span class="p">,</span> <span class="n">rlist</span><span class="p">.</span><span class="n">rl_ghs</span><span class="p">);</span>
<span class="nl">out_rlist:</span>
	<span class="n">gfs2_rlist_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rlist</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * recursive_scan - recursively scan through the end of a file</span>
<span class="cm"> * @ip: the inode</span>
<span class="cm"> * @dibh: the dinode buffer</span>
<span class="cm"> * @mp: the path through the metadata to the point to start</span>
<span class="cm"> * @height: the height the recursion is at</span>
<span class="cm"> * @block: the indirect block to look at</span>
<span class="cm"> * @first: 1 if this is the first block</span>
<span class="cm"> * @sm: data opaque to this function to pass to @bc</span>
<span class="cm"> *</span>
<span class="cm"> * When this is first called @height and @block should be zero and</span>
<span class="cm"> * @first should be 1.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">recursive_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">metapath</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">block</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strip_mine</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">top</span><span class="p">,</span> <span class="o">*</span><span class="n">bottom</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mh_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">height</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">dibh</span> <span class="o">=</span> <span class="n">bh</span><span class="p">;</span>

		<span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">))</span> <span class="o">+</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">bottom</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">))</span> <span class="o">+</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_diptrs</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_indirect_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">mh_size</span><span class="p">)</span> <span class="o">+</span>
				  <span class="p">(</span><span class="n">first</span> <span class="o">?</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">mp_list</span><span class="p">[</span><span class="n">height</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">bottom</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">mh_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_inptrs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">do_strip</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">sm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">gfs2_metapath_ra</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="n">top</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">top</span> <span class="o">&lt;</span> <span class="n">bottom</span><span class="p">;</span> <span class="n">top</span><span class="o">++</span><span class="p">,</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">top</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">bn</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">top</span><span class="p">);</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">recursive_scan</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span>
					       <span class="n">first</span><span class="p">,</span> <span class="n">sm</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * gfs2_block_truncate_page - Deal with zeroing out data for truncate</span>
<span class="cm"> *</span>
<span class="cm"> * This is partly borrowed from ext3.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_block_truncate_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span> <span class="o">=</span> <span class="n">from</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">from</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_CACHE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">iblock</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">find_or_create_page</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">blocksize</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">blocksize</span> <span class="o">-</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">iblock</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_CACHE_SHIFT</span> <span class="o">-</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page_has_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">create_empty_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Find the buffer that contains &quot;offset&quot; */</span>
	<span class="n">bh</span> <span class="o">=</span> <span class="n">page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_this_page</span><span class="p">;</span>
		<span class="n">iblock</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_mapped</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfs2_block_map</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">iblock</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* unmapped? It&#39;s a hole - nothing to do */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_mapped</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ok, it&#39;s mapped. Make sure it&#39;s up-to-date */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">set_buffer_uptodate</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_uptodate</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">ll_rw_block</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">wait_on_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="cm">/* Uhhuh. Read error. Complain and punt. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_uptodate</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_is_writeback</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">zero_user</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">mark_buffer_dirty</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">trunc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">u64</span> <span class="n">oldsize</span><span class="p">,</span> <span class="n">u64</span> <span class="n">newsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">journaled</span> <span class="o">=</span> <span class="n">gfs2_is_jdata</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span>
				 <span class="n">RES_DINODE</span> <span class="o">+</span> <span class="p">(</span><span class="n">journaled</span> <span class="o">?</span> <span class="n">RES_JDATA</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfs2_buffer_clear_tail</span><span class="p">(</span><span class="n">dibh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">)</span> <span class="o">+</span> <span class="n">newsize</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newsize</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_block_truncate_page</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">newsize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_brelse</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">|=</span> <span class="n">GFS2_DIF_TRUNC_IN_PROG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i_size_write</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">newsize</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>

	<span class="n">truncate_pagecache</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">oldsize</span><span class="p">,</span> <span class="n">newsize</span><span class="p">);</span>
<span class="nl">out_brelse:</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">trunc_dealloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">u64</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">lblock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapath</span> <span class="n">mp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span>
		<span class="n">lblock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lblock</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize_shift</span><span class="p">;</span>

	<span class="n">find_metapath</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_qadata_get</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_quota_hold</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">NO_QUOTA_CHANGE</span><span class="p">,</span> <span class="n">NO_QUOTA_CHANGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">strip_mine</span> <span class="n">sm</span><span class="p">;</span>
		<span class="n">sm</span><span class="p">.</span><span class="n">sm_first</span> <span class="o">=</span> <span class="o">!!</span><span class="n">size</span><span class="p">;</span>
		<span class="n">sm</span><span class="p">.</span><span class="n">sm_height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">recursive_scan</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gfs2_quota_unhold</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">gfs2_qadata_put</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">trunc_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">RES_DINODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rw_mutex</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i_size_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_goal</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">;</span>
		<span class="n">gfs2_buffer_clear_tail</span><span class="p">(</span><span class="n">dibh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GFS2_DIF_TRUNC_IN_PROG</span><span class="p">;</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rw_mutex</span><span class="p">);</span>
	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_shrink - make a file smaller</span>
<span class="cm"> * @inode: the inode</span>
<span class="cm"> * @oldsize: the current inode size</span>
<span class="cm"> * @newsize: the size to make the file</span>
<span class="cm"> *</span>
<span class="cm"> * Called with an exclusive lock on @inode. The @size must</span>
<span class="cm"> * be equal to or smaller than the current inode size.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_shrink</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">u64</span> <span class="n">oldsize</span><span class="p">,</span> <span class="n">u64</span> <span class="n">newsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">trunc_start</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">oldsize</span><span class="p">,</span> <span class="n">newsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">trunc_dealloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">newsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">trunc_end</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_trim_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">size</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_shrink</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_grow - Touch and update inode size</span>
<span class="cm"> * @inode: The inode</span>
<span class="cm"> * @size: The new size</span>
<span class="cm"> *</span>
<span class="cm"> * This function updates the timestamps on the inode and</span>
<span class="cm"> * may also increase the size of the inode. This function</span>
<span class="cm"> * must not be called with @size any smaller than the current</span>
<span class="cm"> * inode size.</span>
<span class="cm"> *</span>
<span class="cm"> * Although it is not strictly required to unstuff files here,</span>
<span class="cm"> * earlier versions of GFS2 have a bug in the stuffed file reading</span>
<span class="cm"> * code which will result in a buffer overrun if the size is larger</span>
<span class="cm"> * than the max stuffed file size. In order to prevent this from</span>
<span class="cm"> * occurring, such files are unstuffed, but in other cases we can</span>
<span class="cm"> * just update the inode size directly.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, or -ve on error</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_grow</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">u64</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_qadata</span> <span class="o">*</span><span class="n">qa</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unstuff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">qa</span> <span class="o">=</span> <span class="n">gfs2_qadata_get</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qa</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_quota_lock_check</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">do_grow_alloc_put</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_inplace_reserve</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">do_grow_qunlock</span><span class="p">;</span>
		<span class="n">unstuff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">RES_DINODE</span> <span class="o">+</span> <span class="n">RES_STATFS</span> <span class="o">+</span> <span class="n">RES_RG_BIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_grow_release</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unstuff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_unstuff_dinode</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">do_end_trans</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_end_trans</span><span class="p">;</span>

	<span class="n">i_size_write</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>

<span class="nl">do_end_trans:</span>
	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
<span class="nl">do_grow_release:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unstuff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_inplace_release</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="nl">do_grow_qunlock:</span>
		<span class="n">gfs2_quota_unlock</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="nl">do_grow_alloc_put:</span>
		<span class="n">gfs2_qadata_put</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_setattr_size - make a file a given size</span>
<span class="cm"> * @inode: the inode</span>
<span class="cm"> * @newsize: the size to make the file</span>
<span class="cm"> *</span>
<span class="cm"> * The file size can grow, shrink, or stay the same size. This</span>
<span class="cm"> * is called holding i_mutex and an exclusive glock on the inode</span>
<span class="cm"> * in question.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_setattr_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">u64</span> <span class="n">newsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">oldsize</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">inode_newsize_ok</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">newsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">inode_dio_wait</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">oldsize</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newsize</span> <span class="o">&gt;=</span> <span class="n">oldsize</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">do_grow</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">newsize</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">do_shrink</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">oldsize</span><span class="p">,</span> <span class="n">newsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_truncatei_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">trunc_dealloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">i_size_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">trunc_end</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_file_dealloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">trunc_dealloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_write_alloc_required - figure out if a write will require an allocation</span>
<span class="cm"> * @ip: the file being written to</span>
<span class="cm"> * @offset: the offset to write to</span>
<span class="cm"> * @len: the number of bytes being written</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 1 if an alloc is required, 0 otherwise</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_write_alloc_required</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="n">bh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">lblock</span><span class="p">,</span> <span class="n">lblock_stop</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">end_of_file</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span>
		    <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">shift</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize_shift</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">gfs2_is_dir</span><span class="p">(</span><span class="n">ip</span><span class="p">));</span>
	<span class="n">end_of_file</span> <span class="o">=</span> <span class="p">(</span><span class="n">i_size_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">)</span> <span class="o">+</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">lblock</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">lblock_stop</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lblock_stop</span> <span class="o">&gt;</span> <span class="n">end_of_file</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">lblock_stop</span> <span class="o">-</span> <span class="n">lblock</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">bh</span><span class="p">.</span><span class="n">b_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bh</span><span class="p">.</span><span class="n">b_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">gfs2_block_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_mapped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bh</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">bh</span><span class="p">.</span><span class="n">b_size</span><span class="p">;</span>
		<span class="n">lblock</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bh</span><span class="p">.</span><span class="n">b_size</span> <span class="o">&gt;&gt;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_blkbits</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
