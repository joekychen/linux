<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › gfs2 › aops.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>aops.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) Sistina Software, Inc.  1997-2003 All rights reserved.</span>
<span class="cm"> * Copyright (C) 2004-2008 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This copyrighted material is made available to anyone wishing to use,</span>
<span class="cm"> * modify, copy, or redistribute it subject to the terms and conditions</span>
<span class="cm"> * of the GNU General Public License version 2.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/pagevec.h&gt;</span>
<span class="cp">#include &lt;linux/mpage.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/writeback.h&gt;</span>
<span class="cp">#include &lt;linux/swap.h&gt;</span>
<span class="cp">#include &lt;linux/gfs2_ondisk.h&gt;</span>
<span class="cp">#include &lt;linux/backing-dev.h&gt;</span>

<span class="cp">#include &quot;gfs2.h&quot;</span>
<span class="cp">#include &quot;incore.h&quot;</span>
<span class="cp">#include &quot;bmap.h&quot;</span>
<span class="cp">#include &quot;glock.h&quot;</span>
<span class="cp">#include &quot;inode.h&quot;</span>
<span class="cp">#include &quot;log.h&quot;</span>
<span class="cp">#include &quot;meta_io.h&quot;</span>
<span class="cp">#include &quot;quota.h&quot;</span>
<span class="cp">#include &quot;trans.h&quot;</span>
<span class="cp">#include &quot;rgrp.h&quot;</span>
<span class="cp">#include &quot;super.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;glops.h&quot;</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_page_add_databufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">from</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bsize</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bh</span> <span class="o">=</span> <span class="n">head</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bh</span> <span class="o">!=</span> <span class="n">head</span> <span class="o">||</span> <span class="o">!</span><span class="n">start</span><span class="p">;</span>
	     <span class="n">bh</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_this_page</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">bsize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">from</span> <span class="o">||</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">to</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_jdata</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
			<span class="n">set_buffer_uptodate</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_get_block_noalloc - Fills in a buffer head with details about a block</span>
<span class="cm"> * @inode: The inode</span>
<span class="cm"> * @lblock: The block number to look up</span>
<span class="cm"> * @bh_result: The buffer head to return the result in</span>
<span class="cm"> * @create: Non-zero if we may add block to the file</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_get_block_noalloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">lblock</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh_result</span><span class="p">,</span> <span class="kt">int</span> <span class="n">create</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_block_map</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="n">bh_result</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_mapped</span><span class="p">(</span><span class="n">bh_result</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_get_block_direct</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">lblock</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh_result</span><span class="p">,</span> <span class="kt">int</span> <span class="n">create</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gfs2_block_map</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="n">bh_result</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_writepage_common - Common bits of writepage</span>
<span class="cm"> * @page: The page to be written</span>
<span class="cm"> * @wbc: The writeback control</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 1 if writepage is ok, otherwise an error code or zero if no error.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_writepage_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">writeback_control</span> <span class="o">*</span><span class="n">wbc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">loff_t</span> <span class="n">i_size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">pgoff_t</span> <span class="n">end_index</span> <span class="o">=</span> <span class="n">i_size</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_assert_withdraw</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">gfs2_glock_is_held_excl</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">journal_info</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">redirty</span><span class="p">;</span>
	<span class="cm">/* Is the page fully outside i_size? (truncate in progress) */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">i_size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_CACHE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">end_index</span> <span class="o">||</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">end_index</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">invalidatepage</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">redirty:</span>
	<span class="n">redirty_page_for_writepage</span><span class="p">(</span><span class="n">wbc</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_writeback_writepage - Write page for writeback mappings</span>
<span class="cm"> * @page: The page</span>
<span class="cm"> * @wbc: The writeback control</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_writeback_writepage</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">writeback_control</span> <span class="o">*</span><span class="n">wbc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_writepage_common</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">wbc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nobh_writepage</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">gfs2_get_block_noalloc</span><span class="p">,</span> <span class="n">wbc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_ordered_writepage - Write page for ordered data files</span>
<span class="cm"> * @page: The page to write</span>
<span class="cm"> * @wbc: The writeback control</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_ordered_writepage</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">writeback_control</span> <span class="o">*</span><span class="n">wbc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_writepage_common</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">wbc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page_has_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">create_empty_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">,</span>
				     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BH_Dirty</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BH_Uptodate</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">gfs2_page_add_databufs</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">block_write_full_page</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">gfs2_get_block_noalloc</span><span class="p">,</span> <span class="n">wbc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __gfs2_jdata_writepage - The core of jdata writepage</span>
<span class="cm"> * @page: The page to write</span>
<span class="cm"> * @wbc: The writeback control</span>
<span class="cm"> *</span>
<span class="cm"> * This is shared between writepage and writepages and implements the</span>
<span class="cm"> * core of the writepage operation. If a transaction is required then</span>
<span class="cm"> * PageChecked will have been set and the transaction will have</span>
<span class="cm"> * already been started before this is called.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__gfs2_jdata_writepage</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="k">struct</span> <span class="n">writeback_control</span> <span class="o">*</span><span class="n">wbc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PageChecked</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ClearPageChecked</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page_has_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">create_empty_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">,</span>
					     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BH_Dirty</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BH_Uptodate</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">gfs2_page_add_databufs</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">block_write_full_page</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">gfs2_get_block_noalloc</span><span class="p">,</span> <span class="n">wbc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_jdata_writepage - Write complete page</span>
<span class="cm"> * @page: Page to write</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_jdata_writepage</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="k">struct</span> <span class="n">writeback_control</span> <span class="o">*</span><span class="n">wbc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done_trans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PageChecked</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wbc</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">!=</span> <span class="n">WB_SYNC_ALL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_ignore</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">RES_DINODE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_ignore</span><span class="p">;</span>
		<span class="n">done_trans</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_writepage_common</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">wbc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__gfs2_jdata_writepage</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">wbc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">done_trans</span><span class="p">)</span>
		<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">out_ignore:</span>
	<span class="n">redirty_page_for_writepage</span><span class="p">(</span><span class="n">wbc</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_writeback_writepages - Write a bunch of dirty pages back to disk</span>
<span class="cm"> * @mapping: The mapping to write</span>
<span class="cm"> * @wbc: Write-back control</span>
<span class="cm"> *</span>
<span class="cm"> * For the data=writeback case we can already ignore buffer heads</span>
<span class="cm"> * and write whole extents at once. This is a big reduction in the</span>
<span class="cm"> * number of I/O requests we send and the bmap calls we make in this case.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_writeback_writepages</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">writeback_control</span> <span class="o">*</span><span class="n">wbc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mpage_writepages</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">wbc</span><span class="p">,</span> <span class="n">gfs2_get_block_noalloc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_write_jdata_pagevec - Write back a pagevec&#39;s worth of pages</span>
<span class="cm"> * @mapping: The mapping</span>
<span class="cm"> * @wbc: The writeback control</span>
<span class="cm"> * @writepage: The writepage function to call for each page</span>
<span class="cm"> * @pvec: The vector of pages</span>
<span class="cm"> * @nr_pages: The number of pages to write</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: non-zero if loop should terminate, zero otherwise</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_write_jdata_pagevec</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">writeback_control</span> <span class="o">*</span><span class="n">wbc</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">pagevec</span> <span class="o">*</span><span class="n">pvec</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="n">pgoff_t</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">loff_t</span> <span class="n">i_size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">pgoff_t</span> <span class="n">end_index</span> <span class="o">=</span> <span class="n">i_size</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">i_size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_CACHE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">nrblocks</span> <span class="o">=</span> <span class="n">nr_pages</span> <span class="o">*</span> <span class="p">(</span><span class="n">PAGE_CACHE_SIZE</span><span class="o">/</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">nrblocks</span><span class="p">,</span> <span class="n">nrblocks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">pvec</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">lock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">!=</span> <span class="n">mapping</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wbc</span><span class="o">-&gt;</span><span class="n">range_cyclic</span> <span class="o">&amp;&amp;</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wbc</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">!=</span> <span class="n">WB_SYNC_NONE</span><span class="p">)</span>
			<span class="n">wait_on_page_writeback</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">PageWriteback</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">clear_page_dirty_for_io</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Is the page fully outside i_size? (truncate in progress) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">end_index</span> <span class="o">||</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">end_index</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">invalidatepage</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">__gfs2_jdata_writepage</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">wbc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="p">(</span><span class="o">--</span><span class="p">(</span><span class="n">wbc</span><span class="o">-&gt;</span><span class="n">nr_to_write</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_write_cache_jdata - Like write_cache_pages but different</span>
<span class="cm"> * @mapping: The mapping to write</span>
<span class="cm"> * @wbc: The writeback control</span>
<span class="cm"> * @writepage: The writepage function to call</span>
<span class="cm"> * @data: The data to pass to writepage</span>
<span class="cm"> *</span>
<span class="cm"> * The reason that we use our own function here is that we need to</span>
<span class="cm"> * start transactions before we grab page locks. This allows us</span>
<span class="cm"> * to get the ordering right.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_write_cache_jdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">writeback_control</span> <span class="o">*</span><span class="n">wbc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pagevec</span> <span class="n">pvec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_pages</span><span class="p">;</span>
	<span class="n">pgoff_t</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">pgoff_t</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scanned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">range_whole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pagevec_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pvec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wbc</span><span class="o">-&gt;</span><span class="n">range_cyclic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">writeback_index</span><span class="p">;</span> <span class="cm">/* Start from prev offset */</span>
		<span class="n">end</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">wbc</span><span class="o">-&gt;</span><span class="n">range_start</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">wbc</span><span class="o">-&gt;</span><span class="n">range_end</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wbc</span><span class="o">-&gt;</span><span class="n">range_start</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">wbc</span><span class="o">-&gt;</span><span class="n">range_end</span> <span class="o">==</span> <span class="n">LLONG_MAX</span><span class="p">)</span>
			<span class="n">range_whole</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scanned</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">retry:</span>
	 <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="n">pagevec_lookup_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pvec</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">,</span>
					       <span class="n">PAGECACHE_TAG_DIRTY</span><span class="p">,</span>
					       <span class="n">min</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">pgoff_t</span><span class="p">)</span><span class="n">PAGEVEC_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">scanned</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_write_jdata_pagevec</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">wbc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pvec</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pagevec_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pvec</span><span class="p">);</span>
		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scanned</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We hit the last page and there is more work to be done: wrap</span>
<span class="cm">		 * back to the start of the file</span>
<span class="cm">		 */</span>
		<span class="n">scanned</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wbc</span><span class="o">-&gt;</span><span class="n">range_cyclic</span> <span class="o">||</span> <span class="p">(</span><span class="n">range_whole</span> <span class="o">&amp;&amp;</span> <span class="n">wbc</span><span class="o">-&gt;</span><span class="n">nr_to_write</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">mapping</span><span class="o">-&gt;</span><span class="n">writeback_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * gfs2_jdata_writepages - Write a bunch of dirty pages back to disk</span>
<span class="cm"> * @mapping: The mapping to write</span>
<span class="cm"> * @wbc: The writeback control</span>
<span class="cm"> * </span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_jdata_writepages</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">writeback_control</span> <span class="o">*</span><span class="n">wbc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_write_cache_jdata</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">wbc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">wbc</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">==</span> <span class="n">WB_SYNC_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_log_flush</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_write_cache_jdata</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">wbc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * stuffed_readpage - Fill in a Linux page with stuffed file data</span>
<span class="cm"> * @ip: the inode</span>
<span class="cm"> * @page: the page</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stuffed_readpage</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dsize</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Due to the order of unstuffing files and -&gt;fault(), we can be</span>
<span class="cm">	 * asked for a zero page in the case of a stuffed file being extended,</span>
<span class="cm">	 * so we need to supply one here. It doesn&#39;t happen often.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">zero_user</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">);</span>
		<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">)))</span>
		<span class="n">dsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">kaddr</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">),</span> <span class="n">dsize</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">kaddr</span> <span class="o">+</span> <span class="n">dsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">-</span> <span class="n">dsize</span><span class="p">);</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">kaddr</span><span class="p">);</span>
	<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>
	<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * __gfs2_readpage - readpage</span>
<span class="cm"> * @file: The file to read a page for</span>
<span class="cm"> * @page: The page to read</span>
<span class="cm"> *</span>
<span class="cm"> * This is the core of gfs2&#39;s readpage. Its used by the internal file</span>
<span class="cm"> * reading code as in that case we already hold the glock. Also its</span>
<span class="cm"> * called by gfs2_readpage() once the required lock has been granted.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__gfs2_readpage</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">stuffed_readpage</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">mpage_readpage</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">gfs2_block_map</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SDF_SHUTDOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_readpage - read a page of a file</span>
<span class="cm"> * @file: The file to read</span>
<span class="cm"> * @page: The page of the file</span>
<span class="cm"> *</span>
<span class="cm"> * This deals with the locking required. We have to unlock and</span>
<span class="cm"> * relock the page in order to get the locking in the right</span>
<span class="cm"> * order.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_readpage</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">gfs2_holder_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">AOP_TRUNCATED_PAGE</span><span class="p">;</span>
	<span class="n">lock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">==</span> <span class="n">mapping</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">__gfs2_readpage</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">error</span> <span class="o">!=</span> <span class="n">AOP_TRUNCATED_PAGE</span><span class="p">)</span>
		<span class="n">lock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_internal_read - read an internal file</span>
<span class="cm"> * @ip: The gfs2 inode</span>
<span class="cm"> * @buf: The buffer to fill</span>
<span class="cm"> * @pos: The file position</span>
<span class="cm"> * @size: The amount to read</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_internal_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span>
                       <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mapping</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span> <span class="o">/</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_CACHE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">amt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">amt</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">copied</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">)</span>
			<span class="n">amt</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">read_cache_page</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">__gfs2_readpage</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">copied</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">amt</span><span class="p">);</span>
		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">mark_page_accessed</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">copied</span> <span class="o">+=</span> <span class="n">amt</span><span class="p">;</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">copied</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_readpages - Read a bunch of pages at once</span>
<span class="cm"> *</span>
<span class="cm"> * Some notes:</span>
<span class="cm"> * 1. This is only for readahead, so we can simply ignore any things</span>
<span class="cm"> *    which are slightly inconvenient (such as locking conflicts between</span>
<span class="cm"> *    the page lock and the glock) and return having done no I/O. Its</span>
<span class="cm"> *    obviously not something we&#39;d want to do on too regular a basis.</span>
<span class="cm"> *    Any I/O we ignore at this time will be done via readpage later.</span>
<span class="cm"> * 2. We don&#39;t handle stuffed files here we let readpage do the honours.</span>
<span class="cm"> * 3. mpage_readpages() does most of the heavy lifting in the common case.</span>
<span class="cm"> * 4. gfs2_block_map() is relied upon to set BH_Boundary in the right places.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_readpages</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pages</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nr_pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">gfs2_holder_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_glock_nq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_uninit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mpage_readpages</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="n">gfs2_block_map</span><span class="p">);</span>
	<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
<span class="nl">out_uninit:</span>
	<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SDF_SHUTDOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">)))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_write_begin - Begin to write to a file</span>
<span class="cm"> * @file: The file to write to</span>
<span class="cm"> * @mapping: The mapping in which to write</span>
<span class="cm"> * @pos: The file offset at which to start writing</span>
<span class="cm"> * @len: Length of the write</span>
<span class="cm"> * @flags: Various flags</span>
<span class="cm"> * @pagep: Pointer to return the page</span>
<span class="cm"> * @fsdata: Pointer to return fs data (unused by GFS2)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_write_begin</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
			    <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pagep</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">fsdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">m_ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ind_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rblocks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alloc_required</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_qadata</span> <span class="o">*</span><span class="n">qa</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pgoff_t</span> <span class="n">index</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">from</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_CACHE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="n">gfs2_holder_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_uninit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span> <span class="o">==</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">m_ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span>
					   <span class="n">GL_NOCACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_uninit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">alloc_required</span> <span class="o">=</span> <span class="n">gfs2_write_alloc_required</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_required</span> <span class="o">||</span> <span class="n">gfs2_is_jdata</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">gfs2_write_calc_reserv</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_blocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ind_blocks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_required</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qa</span> <span class="o">=</span> <span class="n">gfs2_qadata_get</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qa</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_quota_lock_check</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_alloc_put</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_inplace_reserve</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">data_blocks</span> <span class="o">+</span> <span class="n">ind_blocks</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_qunlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rblocks</span> <span class="o">=</span> <span class="n">RES_DINODE</span> <span class="o">+</span> <span class="n">ind_blocks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_jdata</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">rblocks</span> <span class="o">+=</span> <span class="n">data_blocks</span> <span class="o">?</span> <span class="n">data_blocks</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ind_blocks</span> <span class="o">||</span> <span class="n">data_blocks</span><span class="p">)</span>
		<span class="n">rblocks</span> <span class="o">+=</span> <span class="n">RES_STATFS</span> <span class="o">+</span> <span class="n">RES_QUOTA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span> <span class="o">==</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex</span><span class="p">)</span>
		<span class="n">rblocks</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">RES_STATFS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_required</span><span class="p">)</span>
		<span class="n">rblocks</span> <span class="o">+=</span> <span class="n">gfs2_rg_blocks</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">rblocks</span><span class="p">,</span>
				 <span class="n">PAGE_CACHE_SIZE</span><span class="o">/</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_trans_fail</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">AOP_FLAG_NOFS</span><span class="p">;</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">grab_cache_page_write_begin</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pagep</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_endtrans</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_unstuff_dinode</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">prepare_write</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">stuffed_readpage</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">prepare_write:</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">__block_write_begin</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">gfs2_block_map</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_size</span><span class="p">)</span>
		<span class="n">gfs2_trim_blocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out_trans_fail</span><span class="p">;</span>

<span class="nl">out_endtrans:</span>
	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
<span class="nl">out_trans_fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_required</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_inplace_release</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="nl">out_qunlock:</span>
		<span class="n">gfs2_quota_unlock</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="nl">out_alloc_put:</span>
		<span class="n">gfs2_qadata_put</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out_unlock:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span> <span class="o">==</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
		<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
<span class="nl">out_uninit:</span>
	<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * adjust_fs_space - Adjusts the free space available due to gfs2_grow</span>
<span class="cm"> * @inode: the rindex inode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adjust_fs_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">m_ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">l_ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sc_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">m_sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">l_sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">m_bh</span><span class="p">,</span> <span class="o">*</span><span class="n">l_bh</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fs_total</span><span class="p">,</span> <span class="n">new_free</span><span class="p">;</span>

	<span class="cm">/* Total up the file system space, according to the latest rindex. */</span>
	<span class="n">fs_total</span> <span class="o">=</span> <span class="n">gfs2_ri_total</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">m_ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_bh</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>
	<span class="n">gfs2_statfs_change_in</span><span class="p">(</span><span class="n">m_sc</span><span class="p">,</span> <span class="n">m_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fs_total</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">m_sc</span><span class="o">-&gt;</span><span class="n">sc_total</span> <span class="o">+</span> <span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_total</span><span class="p">))</span>
		<span class="n">new_free</span> <span class="o">=</span> <span class="n">fs_total</span> <span class="o">-</span> <span class="p">(</span><span class="n">m_sc</span><span class="o">-&gt;</span><span class="n">sc_total</span> <span class="o">+</span> <span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_total</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">new_free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>
	<span class="n">fs_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;File system extended by %llu blocks.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">new_free</span><span class="p">);</span>
	<span class="n">gfs2_statfs_change</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">new_free</span><span class="p">,</span> <span class="n">new_free</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">l_ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l_bh</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">update_statfs</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">m_bh</span><span class="p">,</span> <span class="n">l_bh</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">l_bh</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">m_bh</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_stuffed_write_end - Write end for stuffed files</span>
<span class="cm"> * @inode: The inode</span>
<span class="cm"> * @dibh: The buffer_head containing the on-disk inode</span>
<span class="cm"> * @pos: The file position</span>
<span class="cm"> * @len: The length of the write</span>
<span class="cm"> * @copied: How much was actually copied by the VFS</span>
<span class="cm"> * @page: The page</span>
<span class="cm"> *</span>
<span class="cm"> * This copies the data from the page into the inode block after</span>
<span class="cm"> * the inode data structure itself.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_stuffed_write_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">,</span>
				  <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">copied</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">m_ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_inode</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">to</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">copied</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">pos</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">)));</span>
	<span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">kaddr</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">copied</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">kaddr</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">copied</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">copied</span><span class="p">);</span>
	<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">kaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copied</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&lt;</span> <span class="n">to</span><span class="p">)</span>
			<span class="n">i_size_write</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
		<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span> <span class="o">==</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adjust_fs_space</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_uptodate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>
	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span> <span class="o">==</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
		<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">copied</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_write_end</span>
<span class="cm"> * @file: The file to write to</span>
<span class="cm"> * @mapping: The address space to write to</span>
<span class="cm"> * @pos: The file position</span>
<span class="cm"> * @len: The length of the data</span>
<span class="cm"> * @copied:</span>
<span class="cm"> * @page: The page that has been written</span>
<span class="cm"> * @fsdata: The fsdata (unused in GFS2)</span>
<span class="cm"> *</span>
<span class="cm"> * The main write_end function for GFS2. We have a separate one for</span>
<span class="cm"> * stuffed files as they are slightly different, otherwise we just</span>
<span class="cm"> * put our locking around the VFS provided functions.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_write_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
			  <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">copied</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fsdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">m_ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_qadata</span> <span class="o">*</span><span class="n">qa</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_qadata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">from</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_CACHE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">to</span> <span class="o">=</span> <span class="n">from</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">gfs2_glock_is_locked_by_me</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">gfs2_stuffed_write_end</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">copied</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_is_writeback</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">gfs2_page_add_databufs</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">generic_write_end</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">copied</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">fsdata</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span> <span class="o">==</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adjust_fs_space</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_uptodate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>
<span class="nl">failed:</span>
	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_res</span><span class="p">)</span>
		<span class="n">gfs2_inplace_release</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_quota_unlock</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">gfs2_qadata_put</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span> <span class="o">==</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
		<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_set_page_dirty - Page dirtying function</span>
<span class="cm"> * @page: The page to dirty</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 1 if it dirtyed the page, or 0 otherwise</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_set_page_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SetPageChecked</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__set_page_dirty_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_bmap - Block map function</span>
<span class="cm"> * @mapping: Address space info</span>
<span class="cm"> * @lblock: The block to map</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: The disk address for the block or 0 on hole or error</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">sector_t</span> <span class="nf">gfs2_bmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">lblock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">i_gh</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">dblock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="n">LM_FLAG_ANY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">dblock</span> <span class="o">=</span> <span class="n">generic_block_bmap</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="n">gfs2_block_map</span><span class="p">);</span>

	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i_gh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dblock</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_discard</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_bufdata</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>

	<span class="n">lock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">gfs2_log_lock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="n">clear_buffer_dirty</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">bd</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_list</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">buffer_pinned</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_list</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">gfs2_remove_from_journal</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">journal_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clear_buffer_mapped</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">clear_buffer_req</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">clear_buffer_new</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">gfs2_log_unlock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="n">unlock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_invalidatepage</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">PageLocked</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ClearPageChecked</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page_has_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">head</span> <span class="o">=</span> <span class="n">page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">pos</span><span class="p">)</span>
			<span class="n">gfs2_discard</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">;</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_this_page</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bh</span> <span class="o">!=</span> <span class="n">head</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">try_to_release_page</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_ok_for_dio - check that dio is valid on this file</span>
<span class="cm"> * @ip: The inode</span>
<span class="cm"> * @rw: READ or WRITE</span>
<span class="cm"> * @offset: The offset at which we are reading or writing</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 (to ignore the i/o request and thus fall back to buffered i/o)</span>
<span class="cm"> *          1 (to accept the i/o request)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_ok_for_dio</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Should we return an error here? I can&#39;t see that O_DIRECT for</span>
<span class="cm">	 * a stuffed file makes any sense. For now we&#39;ll silently fall</span>
<span class="cm">	 * back to buffered I/O</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">gfs2_direct_IO</span><span class="p">(</span><span class="kt">int</span> <span class="n">rw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_segs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Deferred lock, even if its a write, since we do no allocation</span>
<span class="cm">	 * on this path. All we need change is atime, and this lock mode</span>
<span class="cm">	 * ensures that other nodes have flushed their buffered read caches</span>
<span class="cm">	 * (i.e. their page cache entries for this inode). We do not,</span>
<span class="cm">	 * unfortunately have the option of only flushing a range like</span>
<span class="cm">	 * the VFS does.</span>
<span class="cm">	 */</span>
	<span class="n">gfs2_holder_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_DEFERRED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">gfs2_glock_nq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">gfs2_ok_for_dio</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* dio not valid, fall back to buffered i/o */</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">__blockdev_direct_IO</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span>
				  <span class="n">offset</span><span class="p">,</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">gfs2_get_block_direct</span><span class="p">,</span>
				  <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">gfs2_glock_dq_m</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_releasepage - free the metadata associated with a page</span>
<span class="cm"> * @page: the page that&#39;s being released</span>
<span class="cm"> * @gfp_mask: passed from Linux VFS, ignored by us</span>
<span class="cm"> *</span>
<span class="cm"> * Call try_to_free_buffers() if the buffers in this page can be</span>
<span class="cm"> * released.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_releasepage</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">gfs2_mapping2sbd</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_bufdata</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page_has_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">gfs2_log_lock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_ail_lock</span><span class="p">);</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">bh</span> <span class="o">=</span> <span class="n">page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_count</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">cannot_release</span><span class="p">;</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_private</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bd</span> <span class="o">&amp;&amp;</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_ail</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cannot_release</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer_pinned</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">||</span> <span class="n">buffer_dirty</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">not_possible</span><span class="p">;</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_this_page</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">bh</span> <span class="o">!=</span> <span class="n">head</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_ail_lock</span><span class="p">);</span>
	<span class="n">gfs2_log_unlock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">bh</span> <span class="o">=</span> <span class="n">page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">gfs2_log_lock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_private</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span> <span class="o">==</span> <span class="n">bh</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_list</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_pinned</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
					<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_list</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">bd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="p">)</span>
				<span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">gfs2_log_unlock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="p">)</span>
			<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">gfs2_bufdata_cachep</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>

		<span class="n">bh</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_this_page</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bh</span> <span class="o">!=</span> <span class="n">head</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">try_to_free_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

<span class="nl">not_possible:</span> <span class="cm">/* Should never happen */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">buffer_dirty</span><span class="p">(</span><span class="n">bh</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">buffer_pinned</span><span class="p">(</span><span class="n">bh</span><span class="p">));</span>
<span class="nl">cannot_release:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_ail_lock</span><span class="p">);</span>
	<span class="n">gfs2_log_unlock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">address_space_operations</span> <span class="n">gfs2_writeback_aops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">writepage</span> <span class="o">=</span> <span class="n">gfs2_writeback_writepage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">writepages</span> <span class="o">=</span> <span class="n">gfs2_writeback_writepages</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readpage</span> <span class="o">=</span> <span class="n">gfs2_readpage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readpages</span> <span class="o">=</span> <span class="n">gfs2_readpages</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_begin</span> <span class="o">=</span> <span class="n">gfs2_write_begin</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_end</span> <span class="o">=</span> <span class="n">gfs2_write_end</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmap</span> <span class="o">=</span> <span class="n">gfs2_bmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invalidatepage</span> <span class="o">=</span> <span class="n">gfs2_invalidatepage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">releasepage</span> <span class="o">=</span> <span class="n">gfs2_releasepage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">direct_IO</span> <span class="o">=</span> <span class="n">gfs2_direct_IO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">migratepage</span> <span class="o">=</span> <span class="n">buffer_migrate_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_partially_uptodate</span> <span class="o">=</span> <span class="n">block_is_partially_uptodate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_remove_page</span> <span class="o">=</span> <span class="n">generic_error_remove_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">address_space_operations</span> <span class="n">gfs2_ordered_aops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">writepage</span> <span class="o">=</span> <span class="n">gfs2_ordered_writepage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readpage</span> <span class="o">=</span> <span class="n">gfs2_readpage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readpages</span> <span class="o">=</span> <span class="n">gfs2_readpages</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_begin</span> <span class="o">=</span> <span class="n">gfs2_write_begin</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_end</span> <span class="o">=</span> <span class="n">gfs2_write_end</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_page_dirty</span> <span class="o">=</span> <span class="n">gfs2_set_page_dirty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmap</span> <span class="o">=</span> <span class="n">gfs2_bmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invalidatepage</span> <span class="o">=</span> <span class="n">gfs2_invalidatepage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">releasepage</span> <span class="o">=</span> <span class="n">gfs2_releasepage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">direct_IO</span> <span class="o">=</span> <span class="n">gfs2_direct_IO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">migratepage</span> <span class="o">=</span> <span class="n">buffer_migrate_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_partially_uptodate</span> <span class="o">=</span> <span class="n">block_is_partially_uptodate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_remove_page</span> <span class="o">=</span> <span class="n">generic_error_remove_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">address_space_operations</span> <span class="n">gfs2_jdata_aops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">writepage</span> <span class="o">=</span> <span class="n">gfs2_jdata_writepage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">writepages</span> <span class="o">=</span> <span class="n">gfs2_jdata_writepages</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readpage</span> <span class="o">=</span> <span class="n">gfs2_readpage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readpages</span> <span class="o">=</span> <span class="n">gfs2_readpages</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_begin</span> <span class="o">=</span> <span class="n">gfs2_write_begin</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_end</span> <span class="o">=</span> <span class="n">gfs2_write_end</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_page_dirty</span> <span class="o">=</span> <span class="n">gfs2_set_page_dirty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmap</span> <span class="o">=</span> <span class="n">gfs2_bmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invalidatepage</span> <span class="o">=</span> <span class="n">gfs2_invalidatepage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">releasepage</span> <span class="o">=</span> <span class="n">gfs2_releasepage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_partially_uptodate</span> <span class="o">=</span> <span class="n">block_is_partially_uptodate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_remove_page</span> <span class="o">=</span> <span class="n">generic_error_remove_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">gfs2_set_aops</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_writeback</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gfs2_writeback_aops</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_ordered</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gfs2_ordered_aops</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_jdata</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gfs2_jdata_aops</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">BUG</span><span class="p">();</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
