<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › gfs2 › rgrp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>rgrp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) Sistina Software, Inc.  1997-2003 All rights reserved.</span>
<span class="cm"> * Copyright (C) 2004-2008 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This copyrighted material is made available to anyone wishing to use,</span>
<span class="cm"> * modify, copy, or redistribute it subject to the terms and conditions</span>
<span class="cm"> * of the GNU General Public License version 2.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/gfs2_ondisk.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/rbtree.h&gt;</span>

<span class="cp">#include &quot;gfs2.h&quot;</span>
<span class="cp">#include &quot;incore.h&quot;</span>
<span class="cp">#include &quot;glock.h&quot;</span>
<span class="cp">#include &quot;glops.h&quot;</span>
<span class="cp">#include &quot;lops.h&quot;</span>
<span class="cp">#include &quot;meta_io.h&quot;</span>
<span class="cp">#include &quot;quota.h&quot;</span>
<span class="cp">#include &quot;rgrp.h&quot;</span>
<span class="cp">#include &quot;super.h&quot;</span>
<span class="cp">#include &quot;trans.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;log.h&quot;</span>
<span class="cp">#include &quot;inode.h&quot;</span>
<span class="cp">#include &quot;trace_gfs2.h&quot;</span>

<span class="cp">#define BFITNOENT ((u32)~0)</span>
<span class="cp">#define NO_BLOCK ((u64)~0)</span>

<span class="cp">#if BITS_PER_LONG == 32</span>
<span class="cp">#define LBITMASK   (0x55555555UL)</span>
<span class="cp">#define LBITSKIP55 (0x55555555UL)</span>
<span class="cp">#define LBITSKIP00 (0x00000000UL)</span>
<span class="cp">#else</span>
<span class="cp">#define LBITMASK   (0x5555555555555555UL)</span>
<span class="cp">#define LBITSKIP55 (0x5555555555555555UL)</span>
<span class="cp">#define LBITSKIP00 (0x0000000000000000UL)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * These routines are used by the resource group routines (rgrp.c)</span>
<span class="cm"> * to keep track of block allocation.  Each block is represented by two</span>
<span class="cm"> * bits.  So, each byte represents GFS2_NBBY (i.e. 4) blocks.</span>
<span class="cm"> *</span>
<span class="cm"> * 0 = Free</span>
<span class="cm"> * 1 = Used (not metadata)</span>
<span class="cm"> * 2 = Unlinked (still in use) inode</span>
<span class="cm"> * 3 = Used (metadata)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">valid_change</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	        <span class="cm">/* current */</span>
	<span class="cm">/* n */</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	<span class="cm">/* e */</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* w */</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	        <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">rgblk_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">goal</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_state</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">**</span><span class="n">rbi</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_setbit - Set a bit in the bitmaps</span>
<span class="cm"> * @rgd: the resource group descriptor</span>
<span class="cm"> * @buf2: the clone buffer that holds the bitmaps</span>
<span class="cm"> * @bi: the bitmap structure</span>
<span class="cm"> * @block: the block to set</span>
<span class="cm"> * @new_state: the new state of the block</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gfs2_setbit</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf2</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">block</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">byte1</span><span class="p">,</span> <span class="o">*</span><span class="n">byte2</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="n">cur_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buflen</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">%</span> <span class="n">GFS2_NBBY</span><span class="p">)</span> <span class="o">*</span> <span class="n">GFS2_BIT_SIZE</span><span class="p">;</span>

	<span class="n">byte1</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">block</span> <span class="o">/</span> <span class="n">GFS2_NBBY</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span> <span class="o">+</span> <span class="n">buflen</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">byte1</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">);</span>

	<span class="n">cur_state</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">byte1</span> <span class="o">&gt;&gt;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GFS2_BIT_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">valid_change</span><span class="p">[</span><span class="n">new_state</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">cur_state</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;GFS2: buf_blk = 0x%llx old_state=%d, &quot;</span>
		       <span class="s">&quot;new_state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">block</span><span class="p">,</span> <span class="n">cur_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;GFS2: rgrp=0x%llx bi_start=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_addr</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;GFS2: bi_offset=0x%lx bi_len=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
		<span class="n">gfs2_consist_rgrpd</span><span class="p">(</span><span class="n">rgd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">byte1</span> <span class="o">^=</span> <span class="p">(</span><span class="n">cur_state</span> <span class="o">^</span> <span class="n">new_state</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">byte2</span> <span class="o">=</span> <span class="n">buf2</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">block</span> <span class="o">/</span> <span class="n">GFS2_NBBY</span><span class="p">);</span>
		<span class="n">cur_state</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">byte2</span> <span class="o">&gt;&gt;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GFS2_BIT_MASK</span><span class="p">;</span>
		<span class="o">*</span><span class="n">byte2</span> <span class="o">^=</span> <span class="p">(</span><span class="n">cur_state</span> <span class="o">^</span> <span class="n">new_state</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_testbit - test a bit in the bitmaps</span>
<span class="cm"> * @rgd: the resource group descriptor</span>
<span class="cm"> * @buffer: the buffer that holds the bitmaps</span>
<span class="cm"> * @buflen: the length (in bytes) of the buffer</span>
<span class="cm"> * @block: the block to read</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">gfs2_testbit</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">u32</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">byte</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cur_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>

	<span class="n">byte</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">block</span> <span class="o">/</span> <span class="n">GFS2_NBBY</span><span class="p">);</span>
	<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">%</span> <span class="n">GFS2_NBBY</span><span class="p">)</span> <span class="o">*</span> <span class="n">GFS2_BIT_SIZE</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">buflen</span><span class="p">;</span>

	<span class="n">gfs2_assert</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_sbd</span><span class="p">,</span> <span class="n">byte</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">);</span>

	<span class="n">cur_state</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GFS2_BIT_MASK</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cur_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_bit_search</span>
<span class="cm"> * @ptr: Pointer to bitmap data</span>
<span class="cm"> * @mask: Mask to use (normally 0x55555.... but adjusted for search start)</span>
<span class="cm"> * @state: The state we are searching for</span>
<span class="cm"> *</span>
<span class="cm"> * We xor the bitmap data with a patter which is the bitwise opposite</span>
<span class="cm"> * of what we are looking for, this gives rise to a pattern of ones</span>
<span class="cm"> * wherever there is a match. Since we have two bits per entry, we</span>
<span class="cm"> * take this pattern, shift it down by one place and then and it with</span>
<span class="cm"> * the original. All the even bit positions (0,2,4, etc) then represent</span>
<span class="cm"> * successful matches, so we mask with 0x55555..... to remove the unwanted</span>
<span class="cm"> * odd bit positions.</span>
<span class="cm"> *</span>
<span class="cm"> * This allows searching of a whole u64 at once (32 blocks) with a</span>
<span class="cm"> * single test (on 64 bit arches).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">gfs2_bit_search</span><span class="p">(</span><span class="k">const</span> <span class="n">__le64</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">search</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffffffffffffULL</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xaaaaaaaaaaaaaaaaULL</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5555555555555555ULL</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0000000000000000ULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="o">^</span> <span class="n">search</span><span class="p">[</span><span class="n">state</span><span class="p">];</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_bitfit - Search an rgrp&#39;s bitmap buffer to find a bit-pair representing</span>
<span class="cm"> *       a block in a given allocation state.</span>
<span class="cm"> * @buf: the buffer that holds the bitmaps</span>
<span class="cm"> * @len: the length (in bytes) of the buffer</span>
<span class="cm"> * @goal: start search at this block&#39;s bit-pair (within @buffer)</span>
<span class="cm"> * @state: GFS2_BLKST_XXX the state of the block we&#39;re looking for.</span>
<span class="cm"> *</span>
<span class="cm"> * Scope of @goal and returned block number is only within this bitmap buffer,</span>
<span class="cm"> * not entire rgrp or filesystem.  @buffer will be offset from the actual</span>
<span class="cm"> * beginning of a bitmap block buffer, skipping any header structures, but</span>
<span class="cm"> * headers are always a multiple of 64 bits long so that the buffer is</span>
<span class="cm"> * always aligned to a 64 bit boundary.</span>
<span class="cm"> *</span>
<span class="cm"> * The size of the buffer is in bytes, but is it assumed that it is</span>
<span class="cm"> * always ok to read a complete multiple of 64 bits at the end</span>
<span class="cm"> * of the block in case the end is no aligned to a natural boundary.</span>
<span class="cm"> *</span>
<span class="cm"> * Return: the block number (bitmap buffer scope) that was found</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">gfs2_bitfit</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">goal</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">spoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">goal</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">8</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">__le64</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">((</span><span class="n">__le64</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">goal</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">__le64</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le64</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)));</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x5555555555555555ULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bit</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">state</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* Mask off bits we don&#39;t care about at the start of the search */</span>
	<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="n">spoint</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">gfs2_bit_search</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">gfs2_bit_search</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0x5555555555555555ULL</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Mask off any bits which are more than len bytes from the start */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))));</span>
	<span class="cm">/* Didn&#39;t find anything, so return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFITNOENT</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">--</span><span class="p">;</span>
	<span class="n">bit</span> <span class="o">=</span> <span class="n">__ffs64</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">bit</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* two bits per entry in the bitmap */</span>
	<span class="k">return</span> <span class="p">(((</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">-</span> <span class="n">buf</span><span class="p">)</span> <span class="o">*</span> <span class="n">GFS2_NBBY</span><span class="p">)</span> <span class="o">+</span> <span class="n">bit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_bitcount - count the number of bits in a certain state</span>
<span class="cm"> * @rgd: the resource group descriptor</span>
<span class="cm"> * @buffer: the buffer that holds the bitmaps</span>
<span class="cm"> * @buflen: the length (in bytes) of the buffer</span>
<span class="cm"> * @state: the state of the block we&#39;re looking for</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: The number of bits</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">gfs2_bitcount</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">byte</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">buflen</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">state1</span> <span class="o">=</span> <span class="n">state</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">state2</span> <span class="o">=</span> <span class="n">state</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">state3</span> <span class="o">=</span> <span class="n">state</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">byte</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">byte</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">byte</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">byte</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="o">==</span> <span class="n">state1</span><span class="p">)</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">byte</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="n">state2</span><span class="p">)</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">byte</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">==</span> <span class="n">state3</span><span class="p">)</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_rgrp_verify - Verify that a resource group is consistent</span>
<span class="cm"> * @rgd: the rgrp</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_rgrp_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf</span><span class="p">,</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="cm">/* Count # blocks in each of 4 possible allocation states */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buf</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bi</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">+</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
			<span class="n">count</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gfs2_bitcount</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span>
						  <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span>
						  <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span><span class="p">,</span>
						  <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_consist_rgrpd</span><span class="p">(</span><span class="n">rgd</span><span class="p">))</span>
			<span class="n">fs_err</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;free data mismatch:  %u != %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data</span> <span class="o">-</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free</span> <span class="o">-</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_dinodes</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_consist_rgrpd</span><span class="p">(</span><span class="n">rgd</span><span class="p">))</span>
			<span class="n">fs_err</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;used data mismatch:  %u != %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">count</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_dinodes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_consist_rgrpd</span><span class="p">(</span><span class="n">rgd</span><span class="p">))</span>
			<span class="n">fs_err</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;used metadata mismatch:  %u != %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">count</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_dinodes</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rgrp_contains_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">first</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">last</span> <span class="o">=</span> <span class="n">first</span> <span class="o">+</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">first</span> <span class="o">&lt;=</span> <span class="n">block</span> <span class="o">&amp;&amp;</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="n">last</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_blk2rgrpd - Find resource group for a given data/meta block number</span>
<span class="cm"> * @sdp: The GFS2 superblock</span>
<span class="cm"> * @blk: The data block number</span>
<span class="cm"> * @exact: True if this needs to be an exact match</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: The resource group, or NULL if not found</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="nf">gfs2_blk2rgrpd</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">blk</span><span class="p">,</span> <span class="n">bool</span> <span class="n">exact</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_spin</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_tree</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_rgrpd</span><span class="p">,</span> <span class="n">rd_node</span><span class="p">);</span>
		<span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">rd_addr</span><span class="p">)</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">&gt;=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">rd_data0</span> <span class="o">+</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">rd_data</span><span class="p">)</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_spin</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exact</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">rd_addr</span><span class="p">)</span>
					<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">&gt;=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">rd_data0</span> <span class="o">+</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">rd_data</span><span class="p">)</span>
					<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">cur</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_spin</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_rgrpd_get_first - get the first Resource Group in the filesystem</span>
<span class="cm"> * @sdp: The GFS2 superblock</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: The first rgrp in the filesystem</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="nf">gfs2_rgrpd_get_first</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_spin</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_tree</span><span class="p">);</span>
	<span class="n">rgd</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_rgrpd</span><span class="p">,</span> <span class="n">rd_node</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_spin</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rgd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_rgrpd_get_next - get the next RG</span>
<span class="cm"> * @rgd: the resource group descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: The next rgrp</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="nf">gfs2_rgrpd_get_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_sbd</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_spin</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_tree</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_node</span> <span class="o">==</span> <span class="n">n</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_spin</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rgd</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_rgrpd</span><span class="p">,</span> <span class="n">rd_node</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_spin</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rgd</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_free_clones</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_clone</span><span class="p">);</span>
		<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_clone</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_clear_rgrpd</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_tree</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rgd</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_rgrpd</span><span class="p">,</span> <span class="n">rd_node</span><span class="p">);</span>
		<span class="n">gl</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">;</span>

		<span class="n">rb_erase</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_tree</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
			<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_object</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
			<span class="n">gfs2_glock_add_to_lru</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
			<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">gfs2_free_clones</span><span class="p">(</span><span class="n">rgd</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">gfs2_rgrpd_cachep</span><span class="p">,</span> <span class="n">rgd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_rindex_print</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  ri_addr = %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_addr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  ri_length = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  ri_data0 = %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  ri_data = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  ri_bitbytes = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bitbytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_compute_bitstructs - Compute the bitmap sizes</span>
<span class="cm"> * @rgd: The resource group descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Calculates bitmap descriptors, one for each block that contains bitmap data</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compute_bitstructs</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">;</span> <span class="cm">/* # blocks in hdr &amp; bitmap */</span>
	<span class="n">u32</span> <span class="n">bytes_left</span><span class="p">,</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_bitmap</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">bytes_left</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bitbytes</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bi</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>

		<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* small rgrp; bitmap stored completely in header block */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">bytes_left</span><span class="p">;</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrp</span><span class="p">);</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="cm">/* header block */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrp</span><span class="p">);</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrp</span><span class="p">);</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="cm">/* last block */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">bytes_left</span><span class="p">;</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">);</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bitbytes</span> <span class="o">-</span> <span class="n">bytes_left</span><span class="p">;</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="cm">/* other blocks */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">);</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">);</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bitbytes</span> <span class="o">-</span> <span class="n">bytes_left</span><span class="p">;</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bytes_left</span> <span class="o">-=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bytes_left</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_consist_rgrpd</span><span class="p">(</span><span class="n">rgd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bi</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span><span class="p">)</span> <span class="o">*</span> <span class="n">GFS2_NBBY</span> <span class="o">!=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_consist_rgrpd</span><span class="p">(</span><span class="n">rgd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">gfs2_rindex_print</span><span class="p">(</span><span class="n">rgd</span><span class="p">);</span>
			<span class="n">fs_err</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;start=%u len=%u offset=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span><span class="p">,</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span><span class="p">,</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_ri_total - Total up the file system space, according to the rindex.</span>
<span class="cm"> * @sdp: the filesystem</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">u64</span> <span class="nf">gfs2_ri_total</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">total_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rindex</span><span class="p">)];</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="n">rgrps</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rgrps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="n">rgrps</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">loff_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">rgrps</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rindex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rindex</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_internal_read</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rindex</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rindex</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">total_data</span> <span class="o">+=</span> <span class="n">be32_to_cpu</span><span class="p">(((</span><span class="k">struct</span> <span class="n">gfs2_rindex</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri_data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">total_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rgd_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">newn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_tree</span><span class="p">.</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Figure out where to put new node */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">newn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="o">*</span><span class="n">newn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_rgrpd</span><span class="p">,</span>
						  <span class="n">rd_node</span><span class="p">);</span>

		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">newn</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_addr</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">rd_addr</span><span class="p">)</span>
			<span class="n">newn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">newn</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_addr</span> <span class="o">&gt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">rd_addr</span><span class="p">)</span>
			<span class="n">newn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">newn</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">newn</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_tree</span><span class="p">);</span>
	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rgrps</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * read_rindex_entry - Pull in a new resource index entry from the disk</span>
<span class="cm"> * @ip: Pointer to the rindex inode</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, &gt; 0 on EOF, error code otherwise</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_rindex_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="n">loff_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rgrps</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rindex</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_rindex</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_internal_read</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rindex</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rindex</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">rgd</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">gfs2_rgrpd_cachep</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rgd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_sbd</span> <span class="o">=</span> <span class="n">sdp</span><span class="p">;</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_addr</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">ri_addr</span><span class="p">);</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_length</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">ri_length</span><span class="p">);</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data0</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">ri_data0</span><span class="p">);</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">ri_data</span><span class="p">);</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bitbytes</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">ri_bitbytes</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">compute_bitstructs</span><span class="p">(</span><span class="n">rgd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_addr</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">gfs2_rgrp_glops</span><span class="p">,</span> <span class="n">CREATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="o">-&gt;</span><span class="n">gl_object</span> <span class="o">=</span> <span class="n">rgd</span><span class="p">;</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GFS2_RDF_UPTODATE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data</span> <span class="o">&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_max_rg_data</span><span class="p">)</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_max_rg_data</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_spin</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">rgd_insert</span><span class="p">(</span><span class="n">rgd</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_spin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* someone else read in the rgrp; free it and ignore it */</span>
	<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">);</span>

<span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">gfs2_rgrpd_cachep</span><span class="p">,</span> <span class="n">rgd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_ri_update - Pull in a new resource index from the disk</span>
<span class="cm"> * @ip: pointer to the rindex inode</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on successful update, error code otherwise</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_ri_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">read_rindex_entry</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_uptodate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_rindex_update - Update the rindex if required</span>
<span class="cm"> * @sdp: The GFS2 superblock</span>
<span class="cm"> *</span>
<span class="cm"> * We grab a lock on the rindex inode to make sure that it doesn&#39;t</span>
<span class="cm"> * change whilst we are performing an operation. We keep this lock</span>
<span class="cm"> * for quite long periods of time compared to other locks. This</span>
<span class="cm"> * doesn&#39;t matter, since it is shared and it is very, very rarely</span>
<span class="cm"> * accessed in the exclusive mode (i.e. only when expanding the filesystem).</span>
<span class="cm"> *</span>
<span class="cm"> * This makes sure that we&#39;re using the latest copy of the resource index</span>
<span class="cm"> * special file, which might have been updated if someone expanded the</span>
<span class="cm"> * filesystem (via gfs2_grow utility), which adds new resource groups.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on succeess, error code otherwise</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_rindex_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">ri_gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unlock_required</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Read new copy from disk if we don&#39;t have the latest */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_glock_is_locked_by_me</span><span class="p">(</span><span class="n">gl</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ri_gh</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">unlock_required</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_uptodate</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_ri_update</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlock_required</span><span class="p">)</span>
			<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ri_gh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_rgrp_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_rgrp</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rg_flags</span><span class="p">;</span>

	<span class="n">rg_flags</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">rg_flags</span><span class="p">);</span>
	<span class="n">rg_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GFS2_RDF_MASK</span><span class="p">;</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_flags</span> <span class="o">&amp;=</span> <span class="n">GFS2_RDF_MASK</span><span class="p">;</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_flags</span> <span class="o">|=</span> <span class="n">rg_flags</span><span class="p">;</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">rg_free</span><span class="p">);</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_dinodes</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">rg_dinodes</span><span class="p">);</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_igeneration</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">rg_igeneration</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_rgrp_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrp</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">str</span><span class="o">-&gt;</span><span class="n">rg_flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GFS2_RDF_MASK</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">rg_free</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">rg_dinodes</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_dinodes</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">__pad</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">rg_igeneration</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_igeneration</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">rg_reserved</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">rg_reserved</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_rgrp_go_lock - Read in a RG&#39;s header and bitmaps</span>
<span class="cm"> * @gh: The glock holder for the resource group</span>
<span class="cm"> *</span>
<span class="cm"> * Read in all of a Resource Group&#39;s header and bitmap blocks.</span>
<span class="cm"> * Caller must eventually call gfs2_rgrp_relse() to free the bitmaps.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_rgrp_go_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span> <span class="o">=</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_object</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bi</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_read</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_addr</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span> <span class="n">y</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">bi</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">+</span> <span class="n">y</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_wait</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_metatype_check</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="p">,</span> <span class="n">y</span> <span class="o">?</span> <span class="n">GFS2_METATYPE_RB</span> <span class="o">:</span>
					      <span class="n">GFS2_METATYPE_RG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_flags</span> <span class="o">&amp;</span> <span class="n">GFS2_RDF_UPTODATE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">GBF_FULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">bi_flags</span><span class="p">);</span>
		<span class="n">gfs2_rgrp_in</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bi_bh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
		<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">GFS2_RDF_UPTODATE</span> <span class="o">|</span> <span class="n">GFS2_RDF_CHECK</span><span class="p">);</span>
		<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free_clone</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">x</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bi</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="p">);</span>
		<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_clone</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_rgrp_go_unlock - Release RG bitmaps read in with gfs2_rgrp_bh_get()</span>
<span class="cm"> * @gh: The glock holder for the resource group</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_rgrp_go_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span> <span class="o">=</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_object</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="p">);</span>
		<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_rgrp_send_discards</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">minlen</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">ptrimmed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sects_per_blk</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">/</span>
					   <span class="n">bdev_logical_block_size</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">blk</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">nr_sects</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">trimmed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">diff</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">clone</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_clone</span> <span class="o">?</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_clone</span> <span class="o">:</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
		<span class="n">clone</span> <span class="o">+=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span><span class="p">;</span>
		<span class="n">clone</span> <span class="o">+=</span> <span class="n">x</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">orig</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">orig</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">clone</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">clone</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="o">*</span><span class="n">clone</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">clone</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">diff</span> <span class="o">&amp;=</span> <span class="mh">0x55</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">blk</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="p">((</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">GFS2_NBBY</span><span class="p">);</span>
		<span class="n">blk</span> <span class="o">*=</span> <span class="n">sects_per_blk</span><span class="p">;</span> <span class="cm">/* convert to sectors */</span>
		<span class="k">while</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nr_sects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">start_new_extent</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">start</span> <span class="o">+</span> <span class="n">nr_sects</span><span class="p">)</span> <span class="o">!=</span> <span class="n">blk</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">nr_sects</span> <span class="o">&gt;=</span> <span class="n">minlen</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">rv</span> <span class="o">=</span> <span class="n">blkdev_issue_discard</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span>
							<span class="n">start</span><span class="p">,</span> <span class="n">nr_sects</span><span class="p">,</span>
							<span class="n">GFP_NOFS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
							<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
						<span class="n">trimmed</span> <span class="o">+=</span> <span class="n">nr_sects</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">nr_sects</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">start_new_extent:</span>
					<span class="n">start</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">nr_sects</span> <span class="o">+=</span> <span class="n">sects_per_blk</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">diff</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">blk</span> <span class="o">+=</span> <span class="n">sects_per_blk</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_sects</span> <span class="o">&gt;=</span> <span class="n">minlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">blkdev_issue_discard</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">nr_sects</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">trimmed</span> <span class="o">+=</span> <span class="n">nr_sects</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptrimmed</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ptrimmed</span> <span class="o">=</span> <span class="n">trimmed</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_discard</span><span class="p">)</span>
		<span class="n">fs_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;error %d on discard request, turning discards off for this filesystem&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_discard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_fitrim - Generate discard requests for unused bits of the filesystem</span>
<span class="cm"> * @filp: Any file on the filesystem</span>
<span class="cm"> * @argp: Pointer to the arguments (also used to pass result)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, otherwise error code</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_fitrim</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd_end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">gh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fstrim_range</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">amt</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">trimmed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk_queue_discard</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">r</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ULLONG_MAX</span><span class="p">;</span>
		<span class="n">r</span><span class="p">.</span><span class="n">minlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_rindex_update</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rgd</span> <span class="o">=</span> <span class="n">gfs2_blk2rgrpd</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rgd_end</span> <span class="o">=</span> <span class="n">gfs2_blk2rgrpd</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">r</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_flags</span> <span class="o">&amp;</span> <span class="n">GFS2_RGF_TRIMMED</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Trim each bitmap in the rgrp */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_rgrp_send_discards</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">minlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amt</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">trimmed</span> <span class="o">+=</span> <span class="n">amt</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Mark rgrp as having been trimmed */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">RES_RG_HDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bh</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bi_bh</span><span class="p">;</span>
				<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_flags</span> <span class="o">|=</span> <span class="n">GFS2_RGF_TRIMMED</span><span class="p">;</span>
				<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">gfs2_rgrp_out</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
				<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rgd</span> <span class="o">==</span> <span class="n">rgd_end</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rgd</span> <span class="o">=</span> <span class="n">gfs2_rgrpd_get_next</span><span class="p">(</span><span class="n">rgd</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">r</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">trimmed</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argp</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_qadata_get - get the struct gfs2_qadata structure for an inode</span>
<span class="cm"> * @ip: the incore GFS2 inode structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: the struct gfs2_qadata</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">gfs2_qadata</span> <span class="o">*</span><span class="nf">gfs2_qadata_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_qadata</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_qadata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_qadata</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_rindex_update</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">fs_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;rindex update returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_qadata</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_blkrsv_get - get the struct gfs2_blkreserv structure for an inode</span>
<span class="cm"> * @ip: the incore GFS2 inode structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: the struct gfs2_qadata</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_blkrsv_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_res</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_res</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">gfs2_rsrv_cachep</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * try_rgrp_fit - See if a given reservation will fit in a given RG</span>
<span class="cm"> * @rgd: the RG data</span>
<span class="cm"> * @ip: the inode</span>
<span class="cm"> *</span>
<span class="cm"> * If there&#39;s room for the requested blocks to be allocated from the RG:</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 1 on success (it fits), 0 on failure (it doesn&#39;t fit)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_rgrp_fit</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_blkreserv</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GFS2_RGF_NOALLOC</span> <span class="o">|</span> <span class="n">GFS2_RDF_ERROR</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free_clone</span> <span class="o">&gt;=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_requested</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">gfs2_bi2rgd_blk</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span> <span class="o">*</span> <span class="n">GFS2_NBBY</span><span class="p">)</span> <span class="o">+</span> <span class="n">blk</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * try_rgrp_unlink - Look for any unlinked, allocated, but unused inodes</span>
<span class="cm"> * @rgd: The rgrp</span>
<span class="cm"> * @last_unlinked: block address of the last dinode we unlinked</span>
<span class="cm"> * @skip: block address we should explicitly not unlink</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 if no error</span>
<span class="cm"> *          The inode, if one has been found, in inode.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">try_rgrp_unlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">last_unlinked</span><span class="p">,</span> <span class="n">u64</span> <span class="n">skip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">goal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">block</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">no_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">goal</span> <span class="o">&lt;</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_flush_lock</span><span class="p">);</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">rgblk_search</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> <span class="n">GFS2_BLKST_UNLINKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_flush_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">==</span> <span class="n">BFITNOENT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">block</span> <span class="o">=</span> <span class="n">gfs2_bi2rgd_blk</span><span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="cm">/* rgblk_search can return a block &lt; goal, so we need to</span>
<span class="cm">		   keep it marching forward. */</span>
		<span class="n">no_addr</span> <span class="o">=</span> <span class="n">block</span> <span class="o">+</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data0</span><span class="p">;</span>
		<span class="n">goal</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">goal</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">last_unlinked</span> <span class="o">!=</span> <span class="n">NO_BLOCK</span> <span class="o">&amp;&amp;</span> <span class="n">no_addr</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">last_unlinked</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">no_addr</span> <span class="o">==</span> <span class="n">skip</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="o">*</span><span class="n">last_unlinked</span> <span class="o">=</span> <span class="n">no_addr</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">no_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gfs2_inode_glops</span><span class="p">,</span> <span class="n">CREATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* If the inode is already in cache, we can ignore it here</span>
<span class="cm">		 * because the existing inode disposal code will deal with</span>
<span class="cm">		 * it when all refs have gone away. Accessing gl_object like</span>
<span class="cm">		 * this is not safe in general. Here it is ok because we do</span>
<span class="cm">		 * not dereference the pointer, and we only need an approx</span>
<span class="cm">		 * answer to whether it is NULL or not.</span>
<span class="cm">		 */</span>
		<span class="n">ip</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_object</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span> <span class="o">||</span> <span class="n">queue_work</span><span class="p">(</span><span class="n">gfs2_delete_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_delete</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">found</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Limit reclaim to sensible number of tasks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&gt;</span> <span class="n">NR_CPUS</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GFS2_RDF_CHECK</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * get_local_rgrp - Choose and lock a rgrp for allocation</span>
<span class="cm"> * @ip: the inode to reserve space for</span>
<span class="cm"> * @last_unlinked: the last unlinked block</span>
<span class="cm"> *</span>
<span class="cm"> * Try to acquire rgrp in way which avoids contending with others.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_local_rgrp</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">last_unlinked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span> <span class="o">*</span><span class="n">begin</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_blkreserv</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="n">rg_locked</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">LM_FLAG_TRY</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rgd</span> <span class="o">&amp;&amp;</span> <span class="n">rgrp_contains_block</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rgd</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_goal</span><span class="p">))</span>
		<span class="n">rgd</span> <span class="o">=</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rgd</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rgd</span> <span class="o">=</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">gfs2_blk2rgrpd</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_goal</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rgd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADSLT</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">loops</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rg_locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_glock_is_locked_by_me</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rg_locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span>
						   <span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rgd_gh</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">try_rgrp_fit</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rgd</span> <span class="o">=</span> <span class="n">rgd</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_flags</span> <span class="o">&amp;</span> <span class="n">GFS2_RDF_CHECK</span><span class="p">)</span>
				<span class="n">try_rgrp_unlink</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">last_unlinked</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rg_locked</span><span class="p">)</span>
				<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rgd_gh</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">GLR_TRYFAILED</span>:
			<span class="n">rgd</span> <span class="o">=</span> <span class="n">gfs2_rgrpd_get_next</span><span class="p">(</span><span class="n">rgd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rgd</span> <span class="o">==</span> <span class="n">begin</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">loops</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_blkrsv_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">gfs2_rsrv_cachep</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_res</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_inplace_reserve - Reserve space in the filesystem</span>
<span class="cm"> * @ip: the inode to reserve space for</span>
<span class="cm"> * @requested: the number of blocks to be reserved</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_inplace_reserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">requested</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_blkreserv</span> <span class="o">*</span><span class="n">rs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">last_unlinked</span> <span class="o">=</span> <span class="n">NO_BLOCK</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_blkrsv_get</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">rs</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_res</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_requested</span> <span class="o">=</span> <span class="n">requested</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">requested</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">get_local_rgrp</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">last_unlinked</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Check that fs hasn&#39;t grown if writing to rindex */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span> <span class="o">==</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex_uptodate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_ri_update</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Flushing the log may release space */</span>
		<span class="n">gfs2_log_flush</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tries</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">gfs2_blkrsv_put</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_inplace_release - release an inplace reservation</span>
<span class="cm"> * @ip: the inode the reservation was taken out on</span>
<span class="cm"> *</span>
<span class="cm"> * Release a reservation made by gfs2_inplace_reserve().</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_inplace_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_blkreserv</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rgd_gh</span><span class="p">.</span><span class="n">gh_gl</span><span class="p">)</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rgd_gh</span><span class="p">);</span>
	<span class="n">gfs2_blkrsv_put</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_get_block_type - Check a block in a RG is of given type</span>
<span class="cm"> * @rgd: the resource group holding the block</span>
<span class="cm"> * @block: the block number</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: The block type (GFS2_BLKST_*)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">gfs2_get_block_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">,</span> <span class="n">rgrp_block</span><span class="p">,</span> <span class="n">buf_block</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">;</span>
	<span class="n">rgrp_block</span> <span class="o">=</span> <span class="n">block</span> <span class="o">-</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buf</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bi</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">+</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rgrp_block</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span><span class="p">)</span> <span class="o">*</span> <span class="n">GFS2_NBBY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gfs2_assert</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_sbd</span><span class="p">,</span> <span class="n">buf</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">buf_block</span> <span class="o">=</span> <span class="n">rgrp_block</span> <span class="o">-</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span> <span class="o">*</span> <span class="n">GFS2_NBBY</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">gfs2_testbit</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span><span class="p">,</span>
			   <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span><span class="p">,</span> <span class="n">buf_block</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rgblk_search - find a block in @state</span>
<span class="cm"> * @rgd: the resource group descriptor</span>
<span class="cm"> * @goal: the goal block within the RG (start here to search for avail block)</span>
<span class="cm"> * @state: GFS2_BLKST_XXX the before-allocation state to find</span>
<span class="cm"> * @rbi: address of the pointer to the bitmap containing the block found</span>
<span class="cm"> *</span>
<span class="cm"> * Walk rgrp&#39;s bitmap to find bits that represent a block in @state.</span>
<span class="cm"> *</span>
<span class="cm"> * This function never fails, because we wouldn&#39;t call it unless we</span>
<span class="cm"> * know (from reservation results, etc.) that a block is available.</span>
<span class="cm"> *</span>
<span class="cm"> * Scope of @goal is just within rgrp, not the whole filesystem.</span>
<span class="cm"> * Scope of @returned block is just within bitmap, not the whole filesystem.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: the block number found relative to the bitmap rbi</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">rgblk_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">goal</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">**</span><span class="n">rbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">length</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">biblk</span> <span class="o">=</span> <span class="n">BFITNOENT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf</span><span class="p">,</span> <span class="n">x</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rbi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* Find bitmap block that contains bits for goal block */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buf</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bi</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">+</span> <span class="n">buf</span><span class="p">;</span>
		<span class="cm">/* Convert scope of &quot;goal&quot; from rgrp-wide to within found bit block */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span><span class="p">)</span> <span class="o">*</span> <span class="n">GFS2_NBBY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">goal</span> <span class="o">-=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span> <span class="o">*</span> <span class="n">GFS2_NBBY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">do_search</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">goal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">do_search:</span>
	<span class="cm">/* Search (up to entire) bitmap in this rgrp for allocatable block.</span>
<span class="cm">	   &quot;x &lt;= length&quot;, instead of &quot;x &lt; length&quot;, because we typically start</span>
<span class="cm">	   the search in the middle of a bit block, but if we can&#39;t find an</span>
<span class="cm">	   allocatable block anywhere else, we want to be able wrap around and</span>
<span class="cm">	   search in the first part of our first-searched bit block.  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">length</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bi</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">+</span> <span class="n">buf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GBF_FULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">GFS2_BLKST_FREE</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>

		<span class="cm">/* The GFS2_BLKST_UNLINKED state doesn&#39;t apply to the clone</span>
<span class="cm">		   bitmaps, so we must search the originals for that. */</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">buffer_uptodate</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">GFS2_BLKST_UNLINKED</span> <span class="o">&amp;&amp;</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_clone</span><span class="p">)</span>
			<span class="n">buffer</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_clone</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span><span class="p">;</span>

		<span class="n">biblk</span> <span class="o">=</span> <span class="n">gfs2_bitfit</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">biblk</span> <span class="o">!=</span> <span class="n">BFITNOENT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">goal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">GFS2_BLKST_FREE</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">GBF_FULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>

		<span class="cm">/* Try next bitmap block (wrap back to rgrp header if at end) */</span>
<span class="nl">skip:</span>
		<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">%=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">goal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">biblk</span> <span class="o">!=</span> <span class="n">BFITNOENT</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rbi</span> <span class="o">=</span> <span class="n">bi</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">biblk</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_alloc_extent - allocate an extent from a given bitmap</span>
<span class="cm"> * @rgd: the resource group descriptor</span>
<span class="cm"> * @bi: the bitmap within the rgrp</span>
<span class="cm"> * @blk: the block within the bitmap</span>
<span class="cm"> * @dinode: TRUE if the first block we allocate is for a dinode</span>
<span class="cm"> * @n: The extent length</span>
<span class="cm"> *</span>
<span class="cm"> * Add the found bitmap buffer to the transaction.</span>
<span class="cm"> * Set the found bits to @new_state to change block&#39;s allocation state.</span>
<span class="cm"> * Returns: starting block number of the extent (fs scope)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u64</span> <span class="nf">gfs2_alloc_extent</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">blk</span><span class="p">,</span> <span class="n">bool</span> <span class="n">dinode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">elen</span> <span class="o">=</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">goal</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span><span class="p">;</span>
	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">,</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_setbit</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_clone</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span>
		    <span class="n">dinode</span> <span class="o">?</span> <span class="n">GFS2_BLKST_DINODE</span> <span class="o">:</span> <span class="n">GFS2_BLKST_USED</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="n">goal</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">elen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">goal</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span> <span class="o">*</span> <span class="n">GFS2_NBBY</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_testbit</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span><span class="p">,</span> <span class="n">goal</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">GFS2_BLKST_FREE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">gfs2_setbit</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_clone</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> <span class="n">GFS2_BLKST_USED</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">gfs2_bi2rgd_blk</span><span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="n">blk</span><span class="p">);</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_last_alloc</span> <span class="o">=</span> <span class="n">blk</span> <span class="o">+</span> <span class="o">*</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data0</span> <span class="o">+</span> <span class="n">blk</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rgblk_free - Change alloc state of given block(s)</span>
<span class="cm"> * @sdp: the filesystem</span>
<span class="cm"> * @bstart: the start of a run of blocks to free</span>
<span class="cm"> * @blen: the length of the block run (all must lie within ONE RG!)</span>
<span class="cm"> * @new_state: GFS2_BLKST_XXX the after-allocation block state</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:  Resource group containing the block(s)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="nf">rgblk_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">bstart</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">blen</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">,</span> <span class="n">rgrp_blk</span><span class="p">,</span> <span class="n">buf_blk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">rgd</span> <span class="o">=</span> <span class="n">gfs2_blk2rgrpd</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bstart</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rgd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_consist</span><span class="p">(</span><span class="n">sdp</span><span class="p">))</span>
			<span class="n">fs_err</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;block = %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bstart</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">;</span>

	<span class="n">rgrp_blk</span> <span class="o">=</span> <span class="n">bstart</span> <span class="o">-</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">blen</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buf</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bi</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">+</span> <span class="n">buf</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rgrp_blk</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span><span class="p">)</span> <span class="o">*</span> <span class="n">GFS2_NBBY</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gfs2_assert</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_sbd</span><span class="p">,</span> <span class="n">buf</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">);</span>

		<span class="n">buf_blk</span> <span class="o">=</span> <span class="n">rgrp_blk</span> <span class="o">-</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_start</span> <span class="o">*</span> <span class="n">GFS2_NBBY</span><span class="p">;</span>
		<span class="n">rgrp_blk</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_clone</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_clone</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">,</span>
					       <span class="n">GFP_NOFS</span> <span class="o">|</span> <span class="n">__GFP_NOFAIL</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_clone</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span><span class="p">,</span>
			       <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span><span class="p">,</span>
			       <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">,</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gfs2_setbit</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">buf_blk</span><span class="p">,</span> <span class="n">new_state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rgd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_rgrp_dump - print out an rgrp</span>
<span class="cm"> * @seq: The iterator</span>
<span class="cm"> * @gl: The glock in question</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_rgrp_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_object</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rgd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gfs2_print_dbg</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; R: n:%llu f:%02x b:%u/%u i:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_addr</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_flags</span><span class="p">,</span>
		       <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free_clone</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_dinodes</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_rgrp_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_sbd</span><span class="p">;</span>
	<span class="n">fs_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;rgrp %llu has an error, marking it readonly until umount</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_addr</span><span class="p">);</span>
	<span class="n">fs_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;umount on all nodes and run fsck.gfs2 to fix the error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gfs2_rgrp_dump</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">);</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_flags</span> <span class="o">|=</span> <span class="n">GFS2_RDF_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_alloc_blocks - Allocate one or more blocks of data and/or a dinode</span>
<span class="cm"> * @ip: the inode to allocate the block for</span>
<span class="cm"> * @bn: Used to return the starting block number</span>
<span class="cm"> * @ndata: requested number of blocks/extent length (value/result)</span>
<span class="cm"> * @dinode: 1 if we&#39;re allocating a dinode block, else 0</span>
<span class="cm"> * @generation: the generation number of the inode</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 or error</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_alloc_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">bn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nblocks</span><span class="p">,</span>
		      <span class="n">bool</span> <span class="n">dinode</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">generation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ndata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">goal</span><span class="p">,</span> <span class="n">blk</span><span class="p">;</span> <span class="cm">/* block, within the rgrp scope */</span>
	<span class="n">u64</span> <span class="n">block</span><span class="p">;</span> <span class="cm">/* block, within the file system scope */</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>

	<span class="cm">/* Only happens if there is a bug in gfs2, return something distinctive</span>
<span class="cm">	 * to ensure that it is noticed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">;</span>

	<span class="n">rgd</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rgd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dinode</span> <span class="o">&amp;&amp;</span> <span class="n">rgrp_contains_block</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_goal</span><span class="p">))</span>
		<span class="n">goal</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_goal</span> <span class="o">-</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">goal</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_last_alloc</span><span class="p">;</span>

	<span class="n">blk</span> <span class="o">=</span> <span class="n">rgblk_search</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> <span class="n">GFS2_BLKST_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="p">);</span>

	<span class="cm">/* Since all blocks are reserved in advance, this shouldn&#39;t happen */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">==</span> <span class="n">BFITNOENT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rgrp_error</span><span class="p">;</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">gfs2_alloc_extent</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="n">dinode</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">);</span>
	<span class="n">ndata</span> <span class="o">=</span> <span class="o">*</span><span class="n">nblocks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dinode</span><span class="p">)</span>
		<span class="n">ndata</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dinode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_goal</span> <span class="o">=</span> <span class="n">block</span> <span class="o">+</span> <span class="n">ndata</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">gfs2_dinode</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span> <span class="o">*</span><span class="p">)</span><span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
			<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">di_goal_meta</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">di_goal_data</span> <span class="o">=</span>
				<span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_goal</span><span class="p">);</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nblocks</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rgrp_error</span><span class="p">;</span>

	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free</span> <span class="o">-=</span> <span class="o">*</span><span class="n">nblocks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dinode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_dinodes</span><span class="o">++</span><span class="p">;</span>
		<span class="o">*</span><span class="n">generation</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_igeneration</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">generation</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">generation</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_igeneration</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bi_bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_rgrp_out</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bi_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>

	<span class="n">gfs2_statfs_change</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="o">*</span><span class="n">nblocks</span><span class="p">,</span> <span class="n">dinode</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dinode</span><span class="p">)</span>
		<span class="n">gfs2_trans_add_unrevoke</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This needs reviewing to see why we cannot do the quota change</span>
<span class="cm">	 * at this point in the dinode case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndata</span><span class="p">)</span>
		<span class="n">gfs2_quota_change</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ndata</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_uid</span><span class="p">,</span>
				  <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_gid</span><span class="p">);</span>

	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free_clone</span> <span class="o">-=</span> <span class="o">*</span><span class="n">nblocks</span><span class="p">;</span>
	<span class="n">trace_gfs2_block_alloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">rgd</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">*</span><span class="n">nblocks</span><span class="p">,</span>
			       <span class="n">dinode</span> <span class="o">?</span> <span class="n">GFS2_BLKST_DINODE</span> <span class="o">:</span> <span class="n">GFS2_BLKST_USED</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bn</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">rgrp_error:</span>
	<span class="n">gfs2_rgrp_error</span><span class="p">(</span><span class="n">rgd</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __gfs2_free_blocks - free a contiguous run of block(s)</span>
<span class="cm"> * @ip: the inode these blocks are being freed from</span>
<span class="cm"> * @bstart: first block of a run of contiguous blocks</span>
<span class="cm"> * @blen: the length of the block run</span>
<span class="cm"> * @meta: 1 if the blocks represent metadata</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">__gfs2_free_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">u64</span> <span class="n">bstart</span><span class="p">,</span> <span class="n">u32</span> <span class="n">blen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">meta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">;</span>

	<span class="n">rgd</span> <span class="o">=</span> <span class="n">rgblk_free</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bstart</span><span class="p">,</span> <span class="n">blen</span><span class="p">,</span> <span class="n">GFS2_BLKST_FREE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rgd</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">trace_gfs2_block_alloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">rgd</span><span class="p">,</span> <span class="n">bstart</span><span class="p">,</span> <span class="n">blen</span><span class="p">,</span> <span class="n">GFS2_BLKST_FREE</span><span class="p">);</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free</span> <span class="o">+=</span> <span class="n">blen</span><span class="p">;</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GFS2_RGF_TRIMMED</span><span class="p">;</span>
	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bi_bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_rgrp_out</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bi_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>

	<span class="cm">/* Directories keep their data in the metadata address space */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">meta</span> <span class="o">||</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="p">)</span>
		<span class="n">gfs2_meta_wipe</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bstart</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_free_meta - free a contiguous run of data block(s)</span>
<span class="cm"> * @ip: the inode these blocks are being freed from</span>
<span class="cm"> * @bstart: first block of a run of contiguous blocks</span>
<span class="cm"> * @blen: the length of the block run</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_free_meta</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">u64</span> <span class="n">bstart</span><span class="p">,</span> <span class="n">u32</span> <span class="n">blen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>

	<span class="n">__gfs2_free_blocks</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bstart</span><span class="p">,</span> <span class="n">blen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_statfs_change</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">blen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gfs2_quota_change</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">blen</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_uid</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_gid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_unlink_di</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">blkno</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">;</span>

	<span class="n">rgd</span> <span class="o">=</span> <span class="n">rgblk_free</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">blkno</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFS2_BLKST_UNLINKED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rgd</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">trace_gfs2_block_alloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">rgd</span><span class="p">,</span> <span class="n">blkno</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFS2_BLKST_UNLINKED</span><span class="p">);</span>
	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bi_bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_rgrp_out</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bi_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_free_uninit_di</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">blkno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">tmp_rgd</span><span class="p">;</span>

	<span class="n">tmp_rgd</span> <span class="o">=</span> <span class="n">rgblk_free</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">blkno</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFS2_BLKST_FREE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_rgd</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">gfs2_assert_withdraw</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">rgd</span> <span class="o">==</span> <span class="n">tmp_rgd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_dinodes</span><span class="p">)</span>
		<span class="n">gfs2_consist_rgrpd</span><span class="p">(</span><span class="n">rgd</span><span class="p">);</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_dinodes</span><span class="o">--</span><span class="p">;</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free</span><span class="o">++</span><span class="p">;</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bi_bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_rgrp_out</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bi_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>

	<span class="n">gfs2_statfs_change</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">gfs2_free_di</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gfs2_free_uninit_di</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">);</span>
	<span class="n">trace_gfs2_block_alloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">rgd</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFS2_BLKST_FREE</span><span class="p">);</span>
	<span class="n">gfs2_quota_change</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_uid</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_gid</span><span class="p">);</span>
	<span class="n">gfs2_meta_wipe</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_check_blk_type - Check the type of a block</span>
<span class="cm"> * @sdp: The superblock</span>
<span class="cm"> * @no_addr: The block number to check</span>
<span class="cm"> * @type: The block type we are looking for</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 if the block type matches the expected type</span>
<span class="cm"> *          -ESTALE if it doesn&#39;t match</span>
<span class="cm"> *          or -ve errno if something went wrong while checking</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_check_blk_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">no_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">rgd_gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rgd</span> <span class="o">=</span> <span class="n">gfs2_blk2rgrpd</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">no_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rgd</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rgd_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_get_block_type</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">no_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>

	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rgd_gh</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_rlist_add - add a RG to a list of RGs</span>
<span class="cm"> * @ip: the inode</span>
<span class="cm"> * @rlist: the list of resource groups</span>
<span class="cm"> * @block: the block</span>
<span class="cm"> *</span>
<span class="cm"> * Figure out what RG a block belongs to and add that RG to the list</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: Don&#39;t use NOFAIL</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_rlist_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_rgrp_list</span> <span class="o">*</span><span class="n">rlist</span><span class="p">,</span>
		    <span class="n">u64</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">**</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_space</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_ghs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rgd</span> <span class="o">&amp;&amp;</span> <span class="n">rgrp_contains_block</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rgd</span><span class="p">,</span> <span class="n">block</span><span class="p">))</span>
		<span class="n">rgd</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rgd</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rgd</span> <span class="o">=</span> <span class="n">gfs2_blk2rgrpd</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rgd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_err</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;rlist_add: no rgrp for block %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">block</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rgd</span> <span class="o">=</span> <span class="n">rgd</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_rgrps</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_rgd</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="n">rgd</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_rgrps</span> <span class="o">==</span> <span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_space</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_space</span> <span class="o">=</span> <span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_space</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">new_space</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="p">),</span>
			      <span class="n">GFP_NOFS</span> <span class="o">|</span> <span class="n">__GFP_NOFAIL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_rgd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_rgd</span><span class="p">,</span>
			       <span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_space</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_rgd</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_space</span> <span class="o">=</span> <span class="n">new_space</span><span class="p">;</span>
		<span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_rgd</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_rgd</span><span class="p">[</span><span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_rgrps</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_rlist_alloc - all RGs have been added to the rlist, now allocate</span>
<span class="cm"> *      and initialize an array of glock holders for them</span>
<span class="cm"> * @rlist: the list of resource groups</span>
<span class="cm"> * @state: the lock state to acquire the RG lock in</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: Don&#39;t use NOFAIL</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_rlist_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrp_list</span> <span class="o">*</span><span class="n">rlist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_ghs</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_rgrps</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span><span class="p">),</span>
				<span class="n">GFP_NOFS</span> <span class="o">|</span> <span class="n">__GFP_NOFAIL</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_rgrps</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
		<span class="n">gfs2_holder_init</span><span class="p">(</span><span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_rgd</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">,</span>
				<span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_ghs</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_rlist_free - free a resource group list</span>
<span class="cm"> * @list: the list of resource groups</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_rlist_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrp_list</span> <span class="o">*</span><span class="n">rlist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_rgd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_ghs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_rgrps</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
			<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_ghs</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rlist</span><span class="o">-&gt;</span><span class="n">rl_ghs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
