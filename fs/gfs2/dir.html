<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › gfs2 › dir.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dir.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) Sistina Software, Inc.  1997-2003 All rights reserved.</span>
<span class="cm"> * Copyright (C) 2004-2006 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This copyrighted material is made available to anyone wishing to use,</span>
<span class="cm"> * modify, copy, or redistribute it subject to the terms and conditions</span>
<span class="cm"> * of the GNU General Public License version 2.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Implements Extendible Hashing as described in:</span>
<span class="cm"> *   &quot;Extendible Hashing&quot; by Fagin, et al in</span>
<span class="cm"> *     __ACM Trans. on Database Systems__, Sept 1979.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Here&#39;s the layout of dirents which is essentially the same as that of ext2</span>
<span class="cm"> * within a single block. The field de_name_len is the number of bytes</span>
<span class="cm"> * actually required for the name (no null terminator). The field de_rec_len</span>
<span class="cm"> * is the number of bytes allocated to the dirent. The offset of the next</span>
<span class="cm"> * dirent in the block is (dirent + dirent-&gt;de_rec_len). When a dirent is</span>
<span class="cm"> * deleted, the preceding dirent inherits its allocated space, ie</span>
<span class="cm"> * prev-&gt;de_rec_len += deleted-&gt;de_rec_len. Since the next dirent is obtained</span>
<span class="cm"> * by adding de_rec_len to the current dirent, this essentially causes the</span>
<span class="cm"> * deleted dirent to get jumped over when iterating through all the dirents.</span>
<span class="cm"> *</span>
<span class="cm"> * When deleting the first dirent in a block, there is no previous dirent so</span>
<span class="cm"> * the field de_ino is set to zero to designate it as deleted. When allocating</span>
<span class="cm"> * a dirent, gfs2_dirent_alloc iterates through the dirents in a block. If the</span>
<span class="cm"> * first dirent has (de_ino == 0) and de_rec_len is large enough, this first</span>
<span class="cm"> * dirent is allocated. Otherwise it must go through all the &#39;used&#39; dirents</span>
<span class="cm"> * searching for one in which the amount of total space minus the amount of</span>
<span class="cm"> * used space will provide enough space for the new dirent.</span>
<span class="cm"> *</span>
<span class="cm"> * There are two types of blocks in which dirents reside. In a stuffed dinode,</span>
<span class="cm"> * the dirents begin at offset sizeof(struct gfs2_dinode) from the beginning of</span>
<span class="cm"> * the block.  In leaves, they begin at offset sizeof(struct gfs2_leaf) from the</span>
<span class="cm"> * beginning of the leaf block. The dirents reside in leaves when</span>
<span class="cm"> *</span>
<span class="cm"> * dip-&gt;i_diskflags &amp; GFS2_DIF_EXHASH is true</span>
<span class="cm"> *</span>
<span class="cm"> * Otherwise, the dirents are &quot;linear&quot;, within a single stuffed dinode block.</span>
<span class="cm"> *</span>
<span class="cm"> * When the dirents are in leaves, the actual contents of the directory file are</span>
<span class="cm"> * used as an array of 64-bit block pointers pointing to the leaf blocks. The</span>
<span class="cm"> * dirents are NOT in the directory file itself. There can be more than one</span>
<span class="cm"> * block pointer in the array that points to the same leaf. In fact, when a</span>
<span class="cm"> * directory is first converted from linear to exhash, all of the pointers</span>
<span class="cm"> * point to the same leaf.</span>
<span class="cm"> *</span>
<span class="cm"> * When a leaf is completely full, the size of the hash table can be</span>
<span class="cm"> * doubled unless it is already at the maximum size which is hard coded into</span>
<span class="cm"> * GFS2_DIR_MAX_DEPTH. After that, leaves are chained together in a linked list,</span>
<span class="cm"> * but never before the maximum hash table size has been reached.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/sort.h&gt;</span>
<span class="cp">#include &lt;linux/gfs2_ondisk.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &quot;gfs2.h&quot;</span>
<span class="cp">#include &quot;incore.h&quot;</span>
<span class="cp">#include &quot;dir.h&quot;</span>
<span class="cp">#include &quot;glock.h&quot;</span>
<span class="cp">#include &quot;inode.h&quot;</span>
<span class="cp">#include &quot;meta_io.h&quot;</span>
<span class="cp">#include &quot;quota.h&quot;</span>
<span class="cp">#include &quot;rgrp.h&quot;</span>
<span class="cp">#include &quot;trans.h&quot;</span>
<span class="cp">#include &quot;bmap.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>

<span class="cp">#define IS_LEAF     1 </span><span class="cm">/* Hashed (leaf) directory */</span><span class="cp"></span>
<span class="cp">#define IS_DINODE   2 </span><span class="cm">/* Linear (stuffed dinode block) directory */</span><span class="cp"></span>

<span class="cp">#define MAX_RA_BLOCKS 32 </span><span class="cm">/* max read-ahead blocks */</span><span class="cp"></span>

<span class="cp">#define gfs2_disk_hash2offset(h) (((u64)(h)) &gt;&gt; 1)</span>
<span class="cp">#define gfs2_dir_offset2hash(p) ((u32)(((u64)(p)) &lt;&lt; 1))</span>

<span class="k">struct</span> <span class="n">qstr</span> <span class="n">gfs2_qdot</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">qstr</span> <span class="n">gfs2_qdotdot</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">gfs2_dscan_t</span><span class="p">)(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">gfs2_dir_get_new_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">u64</span> <span class="n">block</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">**</span><span class="n">bhp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">gfs2_meta_new</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_metatype_set</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">GFS2_METATYPE_JD</span><span class="p">,</span> <span class="n">GFS2_FORMAT_JD</span><span class="p">);</span>
	<span class="n">gfs2_buffer_clear_tail</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">));</span>
	<span class="o">*</span><span class="n">bhp</span> <span class="o">=</span> <span class="n">bh</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_dir_get_existing_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">u64</span> <span class="n">block</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">**</span><span class="n">bhp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_read</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">DIO_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_metatype_check</span><span class="p">(</span><span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">),</span> <span class="n">bh</span><span class="p">,</span> <span class="n">GFS2_METATYPE_JD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">bhp</span> <span class="o">=</span> <span class="n">bh</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_dir_write_stuffed</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_size</span> <span class="o">&lt;</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">i_size_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>

	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> * gfs2_dir_write_data - Write directory information to the inode</span>
<span class="cm"> * @ip: The GFS2 inode</span>
<span class="cm"> * @buf: The buffer containing information to be written</span>
<span class="cm"> * @offset: The file offset to start writing at</span>
<span class="cm"> * @size: The amount of data to write</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: The number of bytes correctly written or error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_dir_write_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">lblock</span><span class="p">,</span> <span class="n">dblock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">extlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">o</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">gfs2_dir_write_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">offset</span><span class="p">,</span>
					      <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">gfs2_is_jdata</span><span class="p">(</span><span class="n">ip</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_unstuff_dinode</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lblock</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">o</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">lblock</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jbsize</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">amount</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>

		<span class="n">amount</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">copied</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">-</span> <span class="n">o</span><span class="p">)</span>
			<span class="n">amount</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">-</span> <span class="n">o</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">extlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_extent_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">extlen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_assert_withdraw</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">dblock</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">==</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jbsize</span> <span class="o">||</span> <span class="n">new</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_dir_get_new_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_dir_get_existing_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">o</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
		<span class="n">copied</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
		<span class="n">lblock</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dblock</span><span class="o">++</span><span class="p">;</span>
		<span class="n">extlen</span><span class="o">--</span><span class="p">;</span>

		<span class="n">o</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_size</span> <span class="o">&lt;</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">copied</span><span class="p">)</span>
		<span class="n">i_size_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">copied</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">copied</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copied</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_dir_read_stuffed</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">),</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">?</span> <span class="n">error</span> <span class="o">:</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * gfs2_dir_read_data - Read a data from a directory inode</span>
<span class="cm"> * @ip: The GFS2 Inode</span>
<span class="cm"> * @buf: The buffer to place result into</span>
<span class="cm"> * @size: Amount of data to transfer</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: The amount of data actually copied or the error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_dir_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">lblock</span><span class="p">,</span> <span class="n">dblock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">extlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">o</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">gfs2_dir_read_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">gfs2_is_jdata</span><span class="p">(</span><span class="n">ip</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">lblock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">o</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">lblock</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jbsize</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">amount</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">new</span><span class="p">;</span>

		<span class="n">amount</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">copied</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">-</span> <span class="n">o</span><span class="p">)</span>
			<span class="n">amount</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">-</span> <span class="n">o</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">extlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_extent_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">extlen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="o">!</span><span class="n">dblock</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">extlen</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">bh</span> <span class="o">=</span> <span class="n">gfs2_meta_ra</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="n">extlen</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_read</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="n">DIO_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_metatype_check</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="n">GFS2_METATYPE_JD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dblock</span><span class="o">++</span><span class="p">;</span>
		<span class="n">extlen</span><span class="o">--</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">o</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="p">(</span><span class="n">amount</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">__be64</span><span class="p">));</span>
		<span class="n">copied</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
		<span class="n">lblock</span><span class="o">++</span><span class="p">;</span>
		<span class="n">o</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">copied</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">copied</span><span class="p">)</span> <span class="o">?</span> <span class="n">copied</span> <span class="o">:</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_dir_get_hash_table - Get pointer to the dir hash table</span>
<span class="cm"> * @ip: The inode in question</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: The hash table or an error</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">__be64</span> <span class="o">*</span><span class="nf">gfs2_dir_get_hash_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hsize</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_EXHASH</span><span class="p">));</span>

	<span class="n">hc</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_hash_cache</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hc</span><span class="p">;</span>

	<span class="n">hsize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="p">;</span>
	<span class="n">hsize</span> <span class="o">*=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hsize</span> <span class="o">!=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">hsize</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_dir_read_data</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">hc</span><span class="p">,</span> <span class="n">hsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_hash_cache</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_hash_cache</span> <span class="o">=</span> <span class="n">hc</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_hash_cache</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_dir_hash_inval - Invalidate dir hash</span>
<span class="cm"> * @ip: The directory inode</span>
<span class="cm"> *</span>
<span class="cm"> * Must be called with an exclusive glock, or during glock invalidation.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gfs2_dir_hash_inval</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_hash_cache</span><span class="p">;</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_hash_cache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gfs2_dirent_sentinel</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_inum</span><span class="p">.</span><span class="n">no_addr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_inum</span><span class="p">.</span><span class="n">no_formal_ino</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">__gfs2_dirent_find</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_dirent_sentinel</span><span class="p">(</span><span class="n">dent</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_hash</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&amp;&amp;</span>
	    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_name_len</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;&amp;</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">dent</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_dirent_find</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__gfs2_dirent_find</span><span class="p">(</span><span class="n">dent</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_dirent_prev</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__gfs2_dirent_find</span><span class="p">(</span><span class="n">dent</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * name-&gt;name holds ptr to start of block.</span>
<span class="cm"> * name-&gt;len holds size of block.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_dirent_last</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dent</span> <span class="o">+</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_rec_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_dirent_find_space</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">required</span> <span class="o">=</span> <span class="n">GFS2_DIRENT_SIZE</span><span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">actual</span> <span class="o">=</span> <span class="n">GFS2_DIRENT_SIZE</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_name_len</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="n">totlen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_rec_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_dirent_sentinel</span><span class="p">(</span><span class="n">dent</span><span class="p">))</span>
		<span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">-</span> <span class="n">actual</span> <span class="o">&gt;=</span> <span class="n">required</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dirent_gather</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">**</span><span class="n">pdent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_dirent_gather</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dirent_gather</span> <span class="o">*</span><span class="n">g</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_dirent_sentinel</span><span class="p">(</span><span class="n">dent</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">g</span><span class="o">-&gt;</span><span class="n">pdent</span><span class="p">[</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dent</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Other possible things to check:</span>
<span class="cm"> * - Inode located within filesystem size (and on valid block)</span>
<span class="cm"> * - Valid directory entry type</span>
<span class="cm"> * Not sure how heavy-weight we want to make this... could also check</span>
<span class="cm"> * hash is correct for example, but that would take a lot of extra time.</span>
<span class="cm"> * For now the most important thing is to check that the various sizes</span>
<span class="cm"> * are correct.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_check_dirent</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;gfs2_dirent too small&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dirent</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;gfs2_dirent misaligned&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;gfs2_dirent points beyond end of block&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;zero inode number&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">first</span> <span class="o">&amp;&amp;</span> <span class="n">gfs2_dirent_sentinel</span><span class="p">(</span><span class="n">dent</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;name length is greater than space in dirent&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_dirent_sentinel</span><span class="p">(</span><span class="n">dent</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">unlikely</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dirent</span><span class="p">)</span><span class="o">+</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_name_len</span><span class="p">)</span> <span class="o">&gt;</span>
		     <span class="n">size</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;gfs2_check_dirent: %s (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
	       <span class="n">first</span> <span class="o">?</span> <span class="s">&quot;first in block&quot;</span> <span class="o">:</span> <span class="s">&quot;not first in block&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_dirent_offset</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_meta_header</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">mh_type</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GFS2_METATYPE_LF</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GFS2_METATYPE_DI</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">wrong_type</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="nl">wrong_type:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;gfs2_scan_dirent: wrong block type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">mh_type</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="nf">gfs2_dirent_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">gfs2_dscan_t</span> <span class="n">scan</span><span class="p">,</span>
					    <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
					    <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_dirent_offset</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">consist_inode</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dent</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_rec_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_check_dirent</span><span class="p">(</span><span class="n">dent</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">consist_inode</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">scan</span><span class="p">(</span><span class="n">dent</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">opaque</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">dent</span><span class="p">;</span>
		<span class="n">dent</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_rec_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_check_dirent</span><span class="p">(</span><span class="n">dent</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">consist_inode</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">dent</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">prev</span> <span class="o">?</span> <span class="n">prev</span> <span class="o">:</span> <span class="n">dent</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">consist_inode:</span>
	<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dirent_check_reclen</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rec_len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">de_rec_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rec_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dirent</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">broken</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="n">rec_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">end_p</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rec_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">end_p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="nl">broken:</span>
	<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dirent_next - Next dirent</span>
<span class="cm"> * @dip: the directory</span>
<span class="cm"> * @bh: The buffer</span>
<span class="cm"> * @dent: Pointer to list of dirents</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, error code otherwise</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dirent_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">**</span><span class="n">dent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="o">*</span><span class="n">dent</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bh_end</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dirent_check_reclen</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">cur</span><span class="p">,</span> <span class="n">bh_end</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cur</span> <span class="o">+</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dirent_check_reclen</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">bh_end</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

        <span class="cm">/* Only the first dent could ever have de_inum.no_addr == 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_dirent_sentinel</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">dent</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dirent_del - Delete a dirent</span>
<span class="cm"> * @dip: The GFS2 inode</span>
<span class="cm"> * @bh: The buffer</span>
<span class="cm"> * @prev: The previous dirent</span>
<span class="cm"> * @cur: The current dirent</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dirent_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">cur_rec_len</span><span class="p">,</span> <span class="n">prev_rec_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_dirent_sentinel</span><span class="p">(</span><span class="n">cur</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* If there is no prev entry, this is the first entry in the block.</span>
<span class="cm">	   The de_rec_len is already as big as it needs to be.  Just zero</span>
<span class="cm">	   out the inode number and return.  */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">de_inum</span><span class="p">.</span><span class="n">no_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">de_inum</span><span class="p">.</span><span class="n">no_formal_ino</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Combine this dentry with the previous one.  */</span>

	<span class="n">prev_rec_len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">de_rec_len</span><span class="p">);</span>
	<span class="n">cur_rec_len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">de_rec_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">prev</span> <span class="o">+</span> <span class="n">prev_rec_len</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cur</span><span class="p">)</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cur</span> <span class="o">+</span> <span class="n">cur_rec_len</span> <span class="o">&gt;</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">)</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>

	<span class="n">prev_rec_len</span> <span class="o">+=</span> <span class="n">cur_rec_len</span><span class="p">;</span>
	<span class="n">prev</span><span class="o">-&gt;</span><span class="n">de_rec_len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">prev_rec_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Takes a dent from which to grab space as an argument. Returns the</span>
<span class="cm"> * newly created dent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="nf">gfs2_init_dirent</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">,</span>
					    <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">ndent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">totlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_dirent_sentinel</span><span class="p">(</span><span class="n">dent</span><span class="p">))</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">GFS2_DIRENT_SIZE</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_name_len</span><span class="p">));</span>
	<span class="n">totlen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_rec_len</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">totlen</span><span class="p">);</span>
	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ndent</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dent</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_rec_len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">gfs2_qstr2dirent</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">totlen</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ndent</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="nf">gfs2_dirent_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span>
					     <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>
	<span class="n">dent</span> <span class="o">=</span> <span class="n">gfs2_dirent_scan</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">,</span>
				<span class="n">gfs2_dirent_find_space</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dent</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">dent</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">gfs2_init_dirent</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">dent</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_leaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="n">u64</span> <span class="n">leaf_no</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">**</span><span class="n">bhp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_read</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">leaf_no</span><span class="p">,</span> <span class="n">DIO_WAIT</span><span class="p">,</span> <span class="n">bhp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">gfs2_metatype_check</span><span class="p">(</span><span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">),</span> <span class="o">*</span><span class="n">bhp</span><span class="p">,</span> <span class="n">GFS2_METATYPE_LF</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* printk(KERN_INFO &quot;block num=%llu\n&quot;, leaf_no); */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * get_leaf_nr - Get a leaf number associated with the index</span>
<span class="cm"> * @dip: The GFS2 inode</span>
<span class="cm"> * @index:</span>
<span class="cm"> * @leaf_out:</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, error code otherwise</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_leaf_nr</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">,</span>
		       <span class="n">u64</span> <span class="o">*</span><span class="n">leaf_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">hash</span><span class="p">;</span>

	<span class="n">hash</span> <span class="o">=</span> <span class="n">gfs2_dir_get_hash_table</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hash</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
	<span class="o">*</span><span class="n">leaf_out</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">hash</span> <span class="o">+</span> <span class="n">index</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_first_leaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">**</span><span class="n">bh_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">leaf_no</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">get_leaf_nr</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">leaf_no</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">get_leaf</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">leaf_no</span><span class="p">,</span> <span class="n">bh_out</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="nf">gfs2_dirent_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
					      <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
					      <span class="n">gfs2_dscan_t</span> <span class="n">scan</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">**</span><span class="n">pbh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_EXHASH</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">hsize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">ln</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hsize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">!=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">index</span> <span class="o">=</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">get_first_leaf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">dent</span> <span class="o">=</span> <span class="n">gfs2_dirent_scan</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">,</span>
						<span class="n">scan</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dent</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">got_dent</span><span class="p">;</span>
			<span class="n">leaf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
			<span class="n">ln</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">lf_next</span><span class="p">);</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ln</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">get_leaf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">error</span> <span class="o">?</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
	<span class="n">dent</span> <span class="o">=</span> <span class="n">gfs2_dirent_scan</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">got_dent:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">pbh</span> <span class="o">=</span> <span class="n">bh</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="nf">new_leaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">**</span><span class="n">pbh</span><span class="p">,</span> <span class="n">u16</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qstr</span> <span class="n">name</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="p">};</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_alloc_blocks</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bh</span> <span class="o">=</span> <span class="n">gfs2_meta_new</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">gfs2_trans_add_unrevoke</span><span class="p">(</span><span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">bn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_metatype_set</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">GFS2_METATYPE_LF</span><span class="p">,</span> <span class="n">GFS2_FORMAT_LF</span><span class="p">);</span>
	<span class="n">leaf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="n">leaf</span><span class="o">-&gt;</span><span class="n">lf_depth</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
	<span class="n">leaf</span><span class="o">-&gt;</span><span class="n">lf_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">leaf</span><span class="o">-&gt;</span><span class="n">lf_dirent_format</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_FORMAT_DE</span><span class="p">);</span>
	<span class="n">leaf</span><span class="o">-&gt;</span><span class="n">lf_next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">lf_reserved</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">lf_reserved</span><span class="p">));</span>
	<span class="n">dent</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="p">)(</span><span class="n">leaf</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_qstr2dirent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span><span class="p">),</span> <span class="n">dent</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pbh</span> <span class="o">=</span> <span class="n">bh</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">leaf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dir_make_exhash - Convert a stuffed directory into an ExHash directory</span>
<span class="cm"> * @dip: The GFS2 inode</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, error code otherwise</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dir_make_exhash</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qstr</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*  Turn over a new leaf  */</span>

	<span class="n">leaf</span> <span class="o">=</span> <span class="n">new_leaf</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">leaf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="n">bn</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">;</span>

	<span class="n">gfs2_assert</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_entries</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">leaf</span><span class="o">-&gt;</span><span class="n">lf_entries</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_entries</span><span class="p">);</span>

	<span class="cm">/*  Copy dirents  */</span>

	<span class="n">gfs2_buffer_copy_tail</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span><span class="p">),</span> <span class="n">dibh</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>

	<span class="cm">/*  Find last entry  */</span>

	<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">)</span> <span class="o">+</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span><span class="p">);</span>
	<span class="n">args</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="n">dent</span> <span class="o">=</span> <span class="n">gfs2_dirent_scan</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">,</span>
				<span class="n">gfs2_dirent_last</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*  Adjust the last dirent&#39;s record length</span>
<span class="cm">	   (Remember that dent still points to the last entry.)  */</span>

	<span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_rec_len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_rec_len</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">)</span> <span class="o">-</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span><span class="p">));</span>

	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>

	<span class="cm">/*  We&#39;re done with the new leaf block, now setup the new</span>
<span class="cm">	    hash table.  */</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_buffer_clear_tail</span><span class="p">(</span><span class="n">dibh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_hash_ptrs</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">;</span> <span class="n">lp</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">bn</span><span class="p">);</span>

	<span class="n">i_size_write</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">gfs2_add_inode_blocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">|=</span> <span class="n">GFS2_DIF_EXHASH</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_hash_ptrs</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">x</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_depth</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>

	<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>

	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dir_split_leaf - Split a leaf block into two</span>
<span class="cm"> * @dip: The GFS2 inode</span>
<span class="cm"> * @index:</span>
<span class="cm"> * @leaf_no:</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, error code on failure</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dir_split_leaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">nbh</span><span class="p">,</span> <span class="o">*</span><span class="n">obh</span><span class="p">,</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="n">nleaf</span><span class="p">,</span> <span class="o">*</span><span class="n">oleaf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">half_len</span><span class="p">,</span> <span class="n">divider</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bn</span><span class="p">,</span> <span class="n">leaf_no</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">moved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">get_leaf_nr</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">leaf_no</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*  Get the old leaf block  */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">get_leaf</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">leaf_no</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">oleaf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="p">)</span><span class="n">obh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_depth</span> <span class="o">==</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">oleaf</span><span class="o">-&gt;</span><span class="n">lf_depth</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">obh</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* can&#39;t split */</span>
	<span class="p">}</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">obh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">nleaf</span> <span class="o">=</span> <span class="n">new_leaf</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nbh</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">oleaf</span><span class="o">-&gt;</span><span class="n">lf_depth</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nleaf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">obh</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bn</span> <span class="o">=</span> <span class="n">nbh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">;</span>

	<span class="cm">/*  Compute the start and len of leaf pointers in the hash table.  */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_depth</span> <span class="o">-</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">oleaf</span><span class="o">-&gt;</span><span class="n">lf_depth</span><span class="p">));</span>
	<span class="n">half_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">half_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;i_depth %u lf_depth %u index %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">oleaf</span><span class="o">-&gt;</span><span class="n">lf_depth</span><span class="p">),</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_brelse</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Change the pointers.</span>
<span class="cm">	   Don&#39;t bother distinguishing stuffed from non-stuffed.</span>
<span class="cm">	   This code is complicated enough already. */</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">half_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be64</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_brelse</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Change the pointers  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">half_len</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">bn</span><span class="p">);</span>

	<span class="n">gfs2_dir_hash_inval</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_dir_write_data</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">lp</span><span class="p">,</span> <span class="n">start</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span>
				    <span class="n">half_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">half_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_lpfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="cm">/*  Compute the divider  */</span>
	<span class="n">divider</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">half_len</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="p">);</span>

	<span class="cm">/*  Copy the entries  */</span>
	<span class="n">dent</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="p">)(</span><span class="n">obh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">dent</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dirent_next</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">obh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">))</span>
			<span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_dirent_sentinel</span><span class="p">(</span><span class="n">dent</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_hash</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">divider</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">qstr</span> <span class="n">str</span><span class="p">;</span>
			<span class="n">str</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">dent</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">str</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_name_len</span><span class="p">);</span>
			<span class="n">str</span><span class="p">.</span><span class="n">hash</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_hash</span><span class="p">);</span>
			<span class="n">new</span> <span class="o">=</span> <span class="n">gfs2_dirent_alloc</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">nbh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">new</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">new</span><span class="o">-&gt;</span><span class="n">de_inum</span> <span class="o">=</span> <span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_inum</span><span class="p">;</span> <span class="cm">/* No endian worries */</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">de_type</span> <span class="o">=</span> <span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_type</span><span class="p">;</span> <span class="cm">/* No endian worries */</span>
			<span class="n">be16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nleaf</span><span class="o">-&gt;</span><span class="n">lf_entries</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">dirent_del</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">obh</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">dent</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oleaf</span><span class="o">-&gt;</span><span class="n">lf_entries</span><span class="p">)</span>
				<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
			<span class="n">be16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oleaf</span><span class="o">-&gt;</span><span class="n">lf_entries</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev</span><span class="p">)</span>
				<span class="n">prev</span> <span class="o">=</span> <span class="n">dent</span><span class="p">;</span>

			<span class="n">moved</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">dent</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dent</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">dent</span><span class="p">);</span>

	<span class="n">oleaf</span><span class="o">-&gt;</span><span class="n">lf_depth</span> <span class="o">=</span> <span class="n">nleaf</span><span class="o">-&gt;</span><span class="n">lf_depth</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_assert_withdraw</span><span class="p">(</span><span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">),</span> <span class="o">!</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gfs2_add_inode_blocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">brelse</span><span class="p">(</span><span class="n">obh</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">nbh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">fail_lpfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

<span class="nl">fail_brelse:</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">obh</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">nbh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dir_double_exhash - Double size of ExHash table</span>
<span class="cm"> * @dip: The GFS2 dinode</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, error code on failure</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dir_double_exhash</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hsize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hsize_bytes</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">hc2</span><span class="p">,</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hsize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="p">;</span>
	<span class="n">hsize_bytes</span> <span class="o">=</span> <span class="n">hsize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be64</span><span class="p">);</span>

	<span class="n">hc</span> <span class="o">=</span> <span class="n">gfs2_dir_get_hash_table</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

	<span class="n">h</span> <span class="o">=</span> <span class="n">hc2</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">hsize_bytes</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">hsize</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">h</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
		<span class="o">*</span><span class="n">h</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_dir_write_data</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hc2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hsize_bytes</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="p">(</span><span class="n">hsize_bytes</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">gfs2_dir_hash_inval</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
	<span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_hash_cache</span> <span class="o">=</span> <span class="n">hc2</span><span class="p">;</span>
	<span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="o">++</span><span class="p">;</span>
	<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="cm">/* Replace original hash table &amp; size */</span>
	<span class="n">gfs2_dir_write_data</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hsize_bytes</span><span class="p">);</span>
	<span class="n">i_size_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="n">hsize_bytes</span><span class="p">);</span>
	<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>
<span class="nl">out_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hc2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * compare_dents - compare directory entries by hash value</span>
<span class="cm"> * @a: first dent</span>
<span class="cm"> * @b: second dent</span>
<span class="cm"> *</span>
<span class="cm"> * When comparing the hash entries of @a to @b:</span>
<span class="cm"> *   gt: returns 1</span>
<span class="cm"> *   lt: returns -1</span>
<span class="cm"> *   eq: returns 0</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compare_dents</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent_a</span><span class="p">,</span> <span class="o">*</span><span class="n">dent_b</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hash_a</span><span class="p">,</span> <span class="n">hash_b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dent_a</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">**</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
	<span class="n">hash_a</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dent_a</span><span class="o">-&gt;</span><span class="n">de_hash</span><span class="p">);</span>

	<span class="n">dent_b</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">**</span><span class="p">)</span><span class="n">b</span><span class="p">;</span>
	<span class="n">hash_b</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dent_b</span><span class="o">-&gt;</span><span class="n">de_hash</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hash_a</span> <span class="o">&gt;</span> <span class="n">hash_b</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hash_a</span> <span class="o">&lt;</span> <span class="n">hash_b</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len_a</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent_a</span><span class="o">-&gt;</span><span class="n">de_name_len</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len_b</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent_b</span><span class="o">-&gt;</span><span class="n">de_name_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len_a</span> <span class="o">&gt;</span> <span class="n">len_b</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len_a</span> <span class="o">&lt;</span> <span class="n">len_b</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">dent_a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dent_b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len_a</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_filldir_main - read out directory entries</span>
<span class="cm"> * @dip: The GFS2 inode</span>
<span class="cm"> * @offset: The offset in the file to read from</span>
<span class="cm"> * @opaque: opaque data to pass to filldir</span>
<span class="cm"> * @filldir: The function to pass entries to</span>
<span class="cm"> * @darr: an array of struct gfs2_dirent pointers to read</span>
<span class="cm"> * @entries: the number of entries in darr</span>
<span class="cm"> * @copied: pointer to int that&#39;s non-zero if a entry has been copied out</span>
<span class="cm"> *</span>
<span class="cm"> * Jump through some hoops to make sure that if there are hash collsions,</span>
<span class="cm"> * they are read out at the beginning of a buffer.  We want to minimize</span>
<span class="cm"> * the possibility that they will fall into different readdir buffers or</span>
<span class="cm"> * that someone will want to seek to that location.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno, &gt;0 on exception from filldir</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_filldir_main</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">,</span> <span class="n">filldir_t</span> <span class="n">filldir</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">**</span><span class="n">darr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">entries</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="o">*</span><span class="n">copied</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">,</span> <span class="o">*</span><span class="n">dent_next</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="n">off_next</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sort</span><span class="p">(</span><span class="n">darr</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="p">),</span> <span class="n">compare_dents</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">dent_next</span> <span class="o">=</span> <span class="n">darr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">off_next</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dent_next</span><span class="o">-&gt;</span><span class="n">de_hash</span><span class="p">);</span>
	<span class="n">off_next</span> <span class="o">=</span> <span class="n">gfs2_disk_hash2offset</span><span class="p">(</span><span class="n">off_next</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">,</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dent</span> <span class="o">=</span> <span class="n">dent_next</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">off_next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dent_next</span> <span class="o">=</span> <span class="n">darr</span><span class="p">[</span><span class="n">y</span><span class="p">];</span>
			<span class="n">off_next</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dent_next</span><span class="o">-&gt;</span><span class="n">de_hash</span><span class="p">);</span>
			<span class="n">off_next</span> <span class="o">=</span> <span class="n">gfs2_disk_hash2offset</span><span class="p">(</span><span class="n">off_next</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">off_next</span> <span class="o">==</span> <span class="n">off</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">copied</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">run</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">run</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">filldir</span><span class="p">(</span><span class="n">opaque</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">dent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_name_len</span><span class="p">),</span>
				<span class="n">off</span><span class="p">,</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_inum</span><span class="p">.</span><span class="n">no_addr</span><span class="p">),</span>
				<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_type</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="o">*</span><span class="n">copied</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Increment the *offset by one, so the next time we come into the</span>
<span class="cm">	   do_filldir fxn, we get the next entry instead of the last one in the</span>
<span class="cm">	   current leaf */</span>

	<span class="p">(</span><span class="o">*</span><span class="n">offset</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">gfs2_alloc_sort_buffer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">KMALLOC_MAX_SIZE</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_NOFS</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">__vmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">PAGE_KERNEL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_free_sort_buffer</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_vmalloc_addr</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_dir_read_leaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">,</span>
			      <span class="n">filldir_t</span> <span class="n">filldir</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">copied</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">depth</span><span class="p">,</span>
			      <span class="n">u64</span> <span class="n">leaf_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="n">lf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">entries2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">leaves</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">**</span><span class="n">darr</span><span class="p">,</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dirent_gather</span> <span class="n">g</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">**</span><span class="n">larr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">leaf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">lfn</span> <span class="o">=</span> <span class="n">leaf_no</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">get_leaf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lfn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">lf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">leaves</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">lf</span><span class="o">-&gt;</span><span class="n">lf_depth</span><span class="p">);</span>
		<span class="n">entries</span> <span class="o">+=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">lf</span><span class="o">-&gt;</span><span class="n">lf_entries</span><span class="p">);</span>
		<span class="n">leaves</span><span class="o">++</span><span class="p">;</span>
		<span class="n">lfn</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">lf</span><span class="o">-&gt;</span><span class="n">lf_next</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">lfn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entries</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The extra 99 entries are not normally used, but are a buffer</span>
<span class="cm">	 * zone in case the number of entries in the leaf is corrupt.</span>
<span class="cm">	 * 99 is the maximum number of entries that can fit in a single</span>
<span class="cm">	 * leaf block.</span>
<span class="cm">	 */</span>
	<span class="n">larr</span> <span class="o">=</span> <span class="n">gfs2_alloc_sort_buffer</span><span class="p">((</span><span class="n">leaves</span> <span class="o">+</span> <span class="n">entries</span> <span class="o">+</span> <span class="mi">99</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">larr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">darr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">**</span><span class="p">)(</span><span class="n">larr</span> <span class="o">+</span> <span class="n">leaves</span><span class="p">);</span>
	<span class="n">g</span><span class="p">.</span><span class="n">pdent</span> <span class="o">=</span> <span class="n">darr</span><span class="p">;</span>
	<span class="n">g</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lfn</span> <span class="o">=</span> <span class="n">leaf_no</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">get_leaf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lfn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="n">lf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
		<span class="n">lfn</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">lf</span><span class="o">-&gt;</span><span class="n">lf_next</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lf</span><span class="o">-&gt;</span><span class="n">lf_entries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">entries2</span> <span class="o">+=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">lf</span><span class="o">-&gt;</span><span class="n">lf_entries</span><span class="p">);</span>
			<span class="n">dent</span> <span class="o">=</span> <span class="n">gfs2_dirent_scan</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">,</span>
						<span class="n">gfs2_dirent_gather</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">entries2</span> <span class="o">!=</span> <span class="n">g</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fs_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;Number of entries corrupt in dir &quot;</span>
						<span class="s">&quot;leaf %llu, entries2 (%u) != &quot;</span>
						<span class="s">&quot;g.offset (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">,</span>
					<span class="n">entries2</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
					
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">larr</span><span class="p">[</span><span class="n">leaf</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">bh</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">lfn</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">entries2</span> <span class="o">!=</span> <span class="n">entries</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">do_filldir_main</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">opaque</span><span class="p">,</span> <span class="n">filldir</span><span class="p">,</span> <span class="n">darr</span><span class="p">,</span>
				<span class="n">entries</span><span class="p">,</span> <span class="n">copied</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">leaf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">larr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">gfs2_free_sort_buffer</span><span class="p">(</span><span class="n">larr</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_dir_readahead - Issue read-ahead requests for leaf blocks.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: we can&#39;t calculate each index like dir_e_read can because we don&#39;t</span>
<span class="cm"> * have the leaf, and therefore we don&#39;t have the depth, and therefore we</span>
<span class="cm"> * don&#39;t have the length. So we have to just read enough ahead to make up</span>
<span class="cm"> * for the loss of information.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_dir_readahead</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">hsize</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">file_ra_state</span> <span class="o">*</span><span class="n">f_ra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">blocknr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* First check if we&#39;ve already read-ahead for the whole range. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">MAX_RA_BLOCKS</span> <span class="o">&lt;</span> <span class="n">f_ra</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">f_ra</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">max</span><span class="p">((</span><span class="n">pgoff_t</span><span class="p">)</span><span class="n">index</span><span class="p">,</span> <span class="n">f_ra</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">MAX_RA_BLOCKS</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f_ra</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">hsize</span><span class="p">)</span> <span class="cm">/* if exceeded the hash table */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">last</span> <span class="o">=</span> <span class="n">blocknr</span><span class="p">;</span>
		<span class="n">blocknr</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_hash_cache</span><span class="p">[</span><span class="n">f_ra</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">]);</span>
		<span class="n">f_ra</span><span class="o">-&gt;</span><span class="n">start</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blocknr</span> <span class="o">==</span> <span class="n">last</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">bh</span> <span class="o">=</span> <span class="n">gfs2_getbuf</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">blocknr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trylock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buffer_uptodate</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">unlock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
				<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_end_io</span> <span class="o">=</span> <span class="n">end_buffer_read_sync</span><span class="p">;</span>
			<span class="n">submit_bh</span><span class="p">(</span><span class="n">READA</span> <span class="o">|</span> <span class="n">REQ_META</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dir_e_read - Reads the entries from a directory into a filldir buffer</span>
<span class="cm"> * @dip: dinode pointer</span>
<span class="cm"> * @offset: the hash of the last entry read shifted to the right once</span>
<span class="cm"> * @opaque: buffer for the filldir function to fill</span>
<span class="cm"> * @filldir: points to the filldir function to use</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dir_e_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">,</span>
		      <span class="n">filldir_t</span> <span class="n">filldir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_ra_state</span> <span class="o">*</span><span class="n">f_ra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">hsize</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hash</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hsize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="p">;</span>
	<span class="n">hash</span> <span class="o">=</span> <span class="n">gfs2_dir_offset2hash</span><span class="p">(</span><span class="o">*</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_hash_cache</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">f_ra</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">gfs2_dir_get_hash_table</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="n">gfs2_dir_readahead</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">hsize</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">f_ra</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">hsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_dir_read_leaf</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">opaque</span><span class="p">,</span> <span class="n">filldir</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">copied</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">depth</span><span class="p">,</span>
					   <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="p">[</span><span class="n">index</span><span class="p">]));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_depth</span> <span class="o">-</span> <span class="n">depth</span><span class="p">);</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_dir_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">,</span>
		  <span class="n">filldir_t</span> <span class="n">filldir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_ra_state</span> <span class="o">*</span><span class="n">f_ra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dirent_gather</span> <span class="n">g</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">**</span><span class="n">darr</span><span class="p">,</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_entries</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_EXHASH</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dir_e_read</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">opaque</span><span class="p">,</span> <span class="n">filldir</span><span class="p">,</span> <span class="n">f_ra</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">dip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="cm">/* 96 is max number of dirents which can be stuffed into an inode */</span>
	<span class="n">darr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">96</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">darr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">g</span><span class="p">.</span><span class="n">pdent</span> <span class="o">=</span> <span class="n">darr</span><span class="p">;</span>
		<span class="n">g</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dent</span> <span class="o">=</span> <span class="n">gfs2_dirent_scan</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">,</span>
					<span class="n">gfs2_dirent_gather</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_entries</span> <span class="o">!=</span> <span class="n">g</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fs_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;Number of entries corrupt in dir %llu, &quot;</span>
				<span class="s">&quot;ip-&gt;i_entries (%u) != g.offset (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">,</span>
				<span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_entries</span><span class="p">,</span>
				<span class="n">g</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">do_filldir_main</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">opaque</span><span class="p">,</span> <span class="n">filldir</span><span class="p">,</span> <span class="n">darr</span><span class="p">,</span>
					<span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_entries</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">copied</span><span class="p">);</span>
<span class="nl">out:</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">darr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_dir_search - Search a directory</span>
<span class="cm"> * @dip: The GFS2 inode</span>
<span class="cm"> * @filename:</span>
<span class="cm"> * @inode:</span>
<span class="cm"> *</span>
<span class="cm"> * This routine searches a directory for a file or another directory.</span>
<span class="cm"> * Assumes a glock is held on dip.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">gfs2_dir_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">gfs2_dirent_search</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">gfs2_dirent_find</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dent</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">dent</span><span class="p">);</span>
		<span class="n">inode</span> <span class="o">=</span> <span class="n">gfs2_inode_lookup</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> 
				<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_type</span><span class="p">),</span>
				<span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_inum</span><span class="p">.</span><span class="n">no_addr</span><span class="p">),</span>
				<span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_inum</span><span class="p">.</span><span class="n">no_formal_ino</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_dir_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">gfs2_dirent_search</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">gfs2_dirent_find</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dent</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_inum</span><span class="p">.</span><span class="n">no_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_inum</span><span class="p">.</span><span class="n">no_formal_ino</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_formal_ino</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">IF2DT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_type</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">GFS2_I</span><span class="p">(</span><span class="n">dir</span><span class="p">));</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dir_new_leaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="o">*</span><span class="n">obh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="n">leaf</span><span class="p">,</span> <span class="o">*</span><span class="n">oleaf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bn</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">get_first_leaf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">oleaf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="p">)</span><span class="n">obh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
		<span class="n">bn</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">oleaf</span><span class="o">-&gt;</span><span class="n">lf_next</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bn</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">obh</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">get_leaf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">obh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">leaf</span> <span class="o">=</span> <span class="n">new_leaf</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">oleaf</span><span class="o">-&gt;</span><span class="n">lf_depth</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">leaf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">obh</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">oleaf</span><span class="o">-&gt;</span><span class="n">lf_next</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">obh</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_add_inode_blocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_dir_add - Add new filename into directory</span>
<span class="cm"> * @dip: The GFS2 inode</span>
<span class="cm"> * @filename: The new name</span>
<span class="cm"> * @inode: The inode number of the entry</span>
<span class="cm"> * @type: The type of the entry</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, error code on failure</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_dir_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		 <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">nip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dent</span> <span class="o">=</span> <span class="n">gfs2_dirent_search</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">gfs2_dirent_find_space</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dent</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">);</span>
			<span class="n">dent</span> <span class="o">=</span> <span class="n">gfs2_init_dirent</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">dent</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
			<span class="n">gfs2_inum_out</span><span class="p">(</span><span class="n">nip</span><span class="p">,</span> <span class="n">dent</span><span class="p">);</span>
			<span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">IF2DT</span><span class="p">(</span><span class="n">nip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mode</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_EXHASH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">leaf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
				<span class="n">be16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">lf_entries</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_entries</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">nip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mode</span><span class="p">))</span>
				<span class="n">inc_nlink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
			<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_EXHASH</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">dir_make_exhash</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">dir_split_leaf</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_depth</span> <span class="o">&lt;</span> <span class="n">GFS2_DIR_MAX_DEPTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">dir_double_exhash</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">dir_split_leaf</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">dir_new_leaf</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * gfs2_dir_del - Delete a directory entry</span>
<span class="cm"> * @dip: The GFS2 inode</span>
<span class="cm"> * @filename: The filename</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, error code on failure</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_dir_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>

	<span class="cm">/* Returns _either_ the entry (if its first in block) or the</span>
<span class="cm">	   previous entry otherwise */</span>
	<span class="n">dent</span> <span class="o">=</span> <span class="n">gfs2_dirent_search</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">gfs2_dirent_prev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* If not first in block, adjust pointers accordingly */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_dirent_find</span><span class="p">(</span><span class="n">dent</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">dent</span><span class="p">;</span>
		<span class="n">dent</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dent</span> <span class="o">+</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">de_rec_len</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">dirent_del</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">dent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_EXHASH</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="n">leaf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">entries</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">lf_entries</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entries</span><span class="p">)</span>
			<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
		<span class="n">leaf</span><span class="o">-&gt;</span><span class="n">lf_entries</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="o">--</span><span class="n">entries</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_entries</span><span class="p">)</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
	<span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_entries</span><span class="o">--</span><span class="p">;</span>
	<span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="n">drop_nlink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_dir_mvino - Change inode number of directory entry</span>
<span class="cm"> * @dip: The GFS2 inode</span>
<span class="cm"> * @filename:</span>
<span class="cm"> * @new_inode:</span>
<span class="cm"> *</span>
<span class="cm"> * This routine changes the inode number of a directory entry.  It&#39;s used</span>
<span class="cm"> * by rename to change &quot;..&quot; when a directory is moved.</span>
<span class="cm"> * Assumes a glock is held on dvp.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_dir_mvino</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">nip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">gfs2_dirent_search</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">gfs2_dirent_find</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">);</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_inum_out</span><span class="p">(</span><span class="n">nip</span><span class="p">,</span> <span class="n">dent</span><span class="p">);</span>
	<span class="n">dent</span><span class="o">-&gt;</span><span class="n">de_type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">new_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_EXHASH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * leaf_dealloc - Deallocate a directory leaf</span>
<span class="cm"> * @dip: the directory</span>
<span class="cm"> * @index: the hash table offset in the directory</span>
<span class="cm"> * @len: the number of pointers to this leaf</span>
<span class="cm"> * @leaf_no: the leaf number</span>
<span class="cm"> * @leaf_bh: buffer_head for the starting leaf</span>
<span class="cm"> * last_dealloc: 1 if this is the final dealloc for the leaf, else 0</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">leaf_dealloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span>
			<span class="n">u64</span> <span class="n">leaf_no</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">leaf_bh</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">last_dealloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="n">tmp_leaf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrp_list</span> <span class="n">rlist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="o">*</span><span class="n">dibh</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">blk</span><span class="p">,</span> <span class="n">nblk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rg_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">l_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ht</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_rindex_update</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rlist</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrp_list</span><span class="p">));</span>

	<span class="n">ht</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ht</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_qadata_get</span><span class="p">(</span><span class="n">dip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_quota_hold</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">NO_QUOTA_CHANGE</span><span class="p">,</span> <span class="n">NO_QUOTA_CHANGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>

	<span class="cm">/*  Count the number of leaves  */</span>
	<span class="n">bh</span> <span class="o">=</span> <span class="n">leaf_bh</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">blk</span> <span class="o">=</span> <span class="n">leaf_no</span><span class="p">;</span> <span class="n">blk</span><span class="p">;</span> <span class="n">blk</span> <span class="o">=</span> <span class="n">nblk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">!=</span> <span class="n">leaf_no</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">get_leaf</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_rlist</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp_leaf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
		<span class="n">nblk</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">tmp_leaf</span><span class="o">-&gt;</span><span class="n">lf_next</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">!=</span> <span class="n">leaf_no</span><span class="p">)</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>

		<span class="n">gfs2_rlist_add</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlist</span><span class="p">,</span> <span class="n">blk</span><span class="p">);</span>
		<span class="n">l_blocks</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gfs2_rlist_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rlist</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">rlist</span><span class="p">.</span><span class="n">rl_rgrps</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">;</span>
		<span class="n">rgd</span> <span class="o">=</span> <span class="n">rlist</span><span class="p">.</span><span class="n">rl_ghs</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_object</span><span class="p">;</span>
		<span class="n">rg_blocks</span> <span class="o">+=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_m</span><span class="p">(</span><span class="n">rlist</span><span class="p">.</span><span class="n">rl_rgrps</span><span class="p">,</span> <span class="n">rlist</span><span class="p">.</span><span class="n">rl_ghs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_rlist</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span>
			<span class="n">rg_blocks</span> <span class="o">+</span> <span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jbsize</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">RES_DINODE</span> <span class="o">+</span> <span class="n">RES_STATFS</span> <span class="o">+</span> <span class="n">RES_QUOTA</span><span class="p">,</span> <span class="n">l_blocks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_rg_gunlock</span><span class="p">;</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">leaf_bh</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">blk</span> <span class="o">=</span> <span class="n">leaf_no</span><span class="p">;</span> <span class="n">blk</span><span class="p">;</span> <span class="n">blk</span> <span class="o">=</span> <span class="n">nblk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">!=</span> <span class="n">leaf_no</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">get_leaf</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_end_trans</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp_leaf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
		<span class="n">nblk</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">tmp_leaf</span><span class="o">-&gt;</span><span class="n">lf_next</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">!=</span> <span class="n">leaf_no</span><span class="p">)</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>

		<span class="n">gfs2_free_meta</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gfs2_add_inode_blocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_dir_write_data</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">index</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_end_trans</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dibh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_end_trans</span><span class="p">;</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">dibh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* On the last dealloc, make this a regular file in case we crash.</span>
<span class="cm">	   (We don&#39;t want to free these blocks a second time.)  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_dealloc</span><span class="p">)</span>
		<span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mode</span> <span class="o">=</span> <span class="n">S_IFREG</span><span class="p">;</span>
	<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">dibh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">dibh</span><span class="p">);</span>

<span class="nl">out_end_trans:</span>
	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
<span class="nl">out_rg_gunlock:</span>
	<span class="n">gfs2_glock_dq_m</span><span class="p">(</span><span class="n">rlist</span><span class="p">.</span><span class="n">rl_rgrps</span><span class="p">,</span> <span class="n">rlist</span><span class="p">.</span><span class="n">rl_ghs</span><span class="p">);</span>
<span class="nl">out_rlist:</span>
	<span class="n">gfs2_rlist_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rlist</span><span class="p">);</span>
	<span class="n">gfs2_quota_unhold</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
<span class="nl">out_put:</span>
	<span class="n">gfs2_qadata_put</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ht</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_dir_exhash_dealloc - free all the leaf blocks in a directory</span>
<span class="cm"> * @dip: the directory</span>
<span class="cm"> *</span>
<span class="cm"> * Dealloc all on-disk directory leaves to FREEMETA state</span>
<span class="cm"> * Change on-disk inode type to &quot;regular file&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_dir_exhash_dealloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hsize</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">next_index</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">leaf_no</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>

	<span class="n">hsize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">gfs2_dir_get_hash_table</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">hsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leaf_no</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">leaf_no</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">get_leaf</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">leaf_no</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">leaf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_leaf</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_depth</span> <span class="o">-</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">lf_depth</span><span class="p">));</span>

			<span class="n">next_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">last</span> <span class="o">=</span> <span class="p">((</span><span class="n">next_index</span> <span class="o">&gt;=</span> <span class="n">hsize</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">leaf_dealloc</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">leaf_no</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span>
					     <span class="n">last</span><span class="p">);</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">next_index</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="n">hsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_diradd_alloc_required - find if adding entry will require an allocation</span>
<span class="cm"> * @ip: the file being written to</span>
<span class="cm"> * @filname: the filename that&#39;s going to be added</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 1 if alloc required, 0 if not, -ve on error</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_diradd_alloc_required</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_dirent</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">gfs2_dirent_search</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">gfs2_dirent_find_space</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dent</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
