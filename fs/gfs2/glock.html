<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › gfs2 › glock.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>glock.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) Sistina Software, Inc.  1997-2003 All rights reserved.</span>
<span class="cm"> * Copyright (C) 2004-2008 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This copyrighted material is made available to anyone wishing to use,</span>
<span class="cm"> * modify, copy, or redistribute it subject to the terms and conditions</span>
<span class="cm"> * of the GNU General Public License version 2.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/sort.h&gt;</span>
<span class="cp">#include &lt;linux/jhash.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/gfs2_ondisk.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/rcupdate.h&gt;</span>
<span class="cp">#include &lt;linux/rculist_bl.h&gt;</span>
<span class="cp">#include &lt;linux/bit_spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/percpu.h&gt;</span>

<span class="cp">#include &quot;gfs2.h&quot;</span>
<span class="cp">#include &quot;incore.h&quot;</span>
<span class="cp">#include &quot;glock.h&quot;</span>
<span class="cp">#include &quot;glops.h&quot;</span>
<span class="cp">#include &quot;inode.h&quot;</span>
<span class="cp">#include &quot;lops.h&quot;</span>
<span class="cp">#include &quot;meta_io.h&quot;</span>
<span class="cp">#include &quot;quota.h&quot;</span>
<span class="cp">#include &quot;super.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;bmap.h&quot;</span>
<span class="cp">#define CREATE_TRACE_POINTS</span>
<span class="cp">#include &quot;trace_gfs2.h&quot;</span>

<span class="k">struct</span> <span class="n">gfs2_glock_iter</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">hash</span><span class="p">;</span>			<span class="cm">/* hash bucket index         */</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">;</span>		<span class="cm">/* incore superblock         */</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">;</span>		<span class="cm">/* current glock struct      */</span>
	<span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>		<span class="cm">/* scratch space             */</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">glock_examiner</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span> <span class="n">gl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__dump_glock</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">);</span>
<span class="cp">#define GLOCK_BUG_ON(gl,x) do { if (unlikely(x)) { __dump_glock(NULL, gl); BUG(); } } while(0)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">do_xmote</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">target</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">gfs2_root</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">glock_workqueue</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">gfs2_delete_workqueue</span><span class="p">;</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">lru_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">lru_count</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lru_lock</span><span class="p">);</span>

<span class="cp">#define GFS2_GL_HASH_SHIFT      15</span>
<span class="cp">#define GFS2_GL_HASH_SIZE       (1 &lt;&lt; GFS2_GL_HASH_SHIFT)</span>
<span class="cp">#define GFS2_GL_HASH_MASK       (GFS2_GL_HASH_SIZE - 1)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hlist_bl_head</span> <span class="n">gl_hash_table</span><span class="p">[</span><span class="n">GFS2_GL_HASH_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">gfs2_root</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * gl_hash() - Turn glock number into hash bucket number</span>
<span class="cm"> * @lock: The glock number</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: The number of the corresponding hash bucket</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">gl_hash</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">lm_lockname</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">h</span> <span class="o">=</span> <span class="n">jhash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">ln_number</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">jhash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">ln_type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> <span class="n">h</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">jhash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="p">),</span> <span class="n">h</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">&amp;=</span> <span class="n">GFS2_GL_HASH_MASK</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">h</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">spin_lock_bucket</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hlist_bl_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">spin_unlock_bucket</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hlist_bl_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_glock_dealloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">rcu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">rcu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_glock</span><span class="p">,</span> <span class="n">gl_rcu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ops</span><span class="o">-&gt;</span><span class="n">go_flags</span> <span class="o">&amp;</span> <span class="n">GLOF_ASPACE</span><span class="p">)</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">gfs2_glock_aspace_cachep</span><span class="p">,</span> <span class="n">gl</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">gfs2_glock_cachep</span><span class="p">,</span> <span class="n">gl</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_glock_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>

	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_rcu</span><span class="p">,</span> <span class="n">gfs2_glock_dealloc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_glock_disposal</span><span class="p">))</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_glock_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_hold() - increment reference count on glock</span>
<span class="cm"> * @gl: The glock to hold</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_glock_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">GLOCK_BUG_ON</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ref</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ref</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * demote_ok - Check to see if it&#39;s ok to unlock a glock</span>
<span class="cm"> * @gl: the glock</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 1 if it&#39;s ok</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">demote_ok</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock_operations</span> <span class="o">*</span><span class="n">glops</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span> <span class="o">==</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_demote_ok</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_demote_ok</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">gfs2_glock_add_to_lru</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lru_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_lru</span><span class="p">))</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_lru</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lru_count</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lru_list</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_LRU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lru_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__gfs2_glock_remove_from_lru</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_lru</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_lru</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lru_count</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_LRU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_glock_remove_from_lru</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lru_lock</span><span class="p">);</span>
	<span class="n">__gfs2_glock_remove_from_lru</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lru_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __gfs2_glock_schedule_for_reclaim - Add a glock to the reclaim list</span>
<span class="cm"> * @gl: the glock</span>
<span class="cm"> *</span>
<span class="cm"> * If the glock is demotable, then we add it (or move it) to the end</span>
<span class="cm"> * of the glock LRU list.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__gfs2_glock_schedule_for_reclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">demote_ok</span><span class="p">(</span><span class="n">gl</span><span class="p">))</span>
		<span class="n">gfs2_glock_add_to_lru</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_put_nolock() - Decrement reference count on glock</span>
<span class="cm"> * @gl: The glock to put</span>
<span class="cm"> *</span>
<span class="cm"> * This function should only be used if the caller has its own reference</span>
<span class="cm"> * to the glock, in addition to the one it is dropping.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_glock_put_nolock</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ref</span><span class="p">))</span>
		<span class="n">GLOCK_BUG_ON</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_put() - Decrement reference count on glock</span>
<span class="cm"> * @gl: The glock to put</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_glock_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">gfs2_glock2aspace</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ref</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lru_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__gfs2_glock_remove_from_lru</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lru_lock</span><span class="p">);</span>
		<span class="n">spin_lock_bucket</span><span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_hash</span><span class="p">);</span>
		<span class="n">hlist_bl_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_list</span><span class="p">);</span>
		<span class="n">spin_unlock_bucket</span><span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_hash</span><span class="p">);</span>
		<span class="n">GLOCK_BUG_ON</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">));</span>
		<span class="n">GLOCK_BUG_ON</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">&amp;&amp;</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">nrpages</span><span class="p">);</span>
		<span class="n">trace_gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_lockstruct</span><span class="p">.</span><span class="n">ls_ops</span><span class="o">-&gt;</span><span class="n">lm_put_lock</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * search_bucket() - Find struct gfs2_glock by lock number</span>
<span class="cm"> * @bucket: the bucket to search</span>
<span class="cm"> * @name: The lock name</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: NULL, or the struct gfs2_glock with the requested number</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="nf">search_bucket</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">lm_lockname</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_bl_node</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>

	<span class="n">hlist_bl_for_each_entry_rcu</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">],</span> <span class="n">gl_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lm_name_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span> <span class="o">!=</span> <span class="n">sdp</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_not_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ref</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">gl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * may_grant - check if its ok to grant a new lock</span>
<span class="cm"> * @gl: The glock</span>
<span class="cm"> * @gh: The lock request which we wish to grant</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: true if its ok to grant the lock</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">may_grant</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh_head</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_holder</span><span class="p">,</span> <span class="n">gh_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_state</span> <span class="o">==</span> <span class="n">LM_ST_EXCLUSIVE</span> <span class="o">||</span>
	     <span class="n">gh_head</span><span class="o">-&gt;</span><span class="n">gh_state</span> <span class="o">==</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">gh</span> <span class="o">!=</span> <span class="n">gh_head</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span> <span class="o">==</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_state</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;</span> <span class="n">GL_EXACT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span> <span class="o">==</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_state</span> <span class="o">==</span> <span class="n">LM_ST_SHARED</span> <span class="o">&amp;&amp;</span> <span class="n">gh_head</span><span class="o">-&gt;</span><span class="n">gh_state</span> <span class="o">==</span> <span class="n">LM_ST_SHARED</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_state</span> <span class="o">==</span> <span class="n">LM_ST_DEFERRED</span> <span class="o">&amp;&amp;</span> <span class="n">gh_head</span><span class="o">-&gt;</span><span class="n">gh_state</span> <span class="o">==</span> <span class="n">LM_ST_DEFERRED</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span> <span class="o">!=</span> <span class="n">LM_ST_UNLOCKED</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;</span> <span class="n">LM_FLAG_ANY</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_holder_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">HIF_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
	<span class="n">wake_up_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span><span class="p">,</span> <span class="n">HIF_WAIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_error - Something unexpected has happened during a lock request</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">do_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">,</span> <span class="n">gh_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HIF_HOLDER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">LM_OUT_ERROR</span><span class="p">)</span>
			<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LM_FLAG_TRY</span> <span class="o">|</span> <span class="n">LM_FLAG_TRY_1CB</span><span class="p">))</span>
			<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_error</span> <span class="o">=</span> <span class="n">GLR_TRYFAILED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_list</span><span class="p">);</span>
		<span class="n">trace_gfs2_glock_queue</span><span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gfs2_holder_wake</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_promote - promote as many requests as possible on the current queue</span>
<span class="cm"> * @gl: The glock</span>
<span class="cm"> * </span>
<span class="cm"> * Returns: 1 if there is a blocked holder at the head of the list, or 2</span>
<span class="cm"> *          if a type specific operation is underway.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_promote</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock_operations</span> <span class="o">*</span><span class="n">glops</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">restart:</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">,</span> <span class="n">gh_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HIF_HOLDER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">may_grant</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">gh</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_list</span><span class="p">.</span><span class="n">prev</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span> <span class="o">&amp;&amp;</span>
			    <span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_lock</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
				<span class="cm">/* FIXME: eliminate this eventually */</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_lock</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
						<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_error</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
					<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_list</span><span class="p">);</span>
					<span class="n">trace_gfs2_glock_queue</span><span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">gfs2_holder_wake</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">HIF_HOLDER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span><span class="p">);</span>
				<span class="n">trace_gfs2_promote</span><span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">gfs2_holder_wake</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">HIF_HOLDER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span><span class="p">);</span>
			<span class="n">trace_gfs2_promote</span><span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">gfs2_holder_wake</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_list</span><span class="p">.</span><span class="n">prev</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">do_error</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * find_first_waiter - find the first gh that&#39;s waiting for the glock</span>
<span class="cm"> * @gl: the glock</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="nf">find_first_waiter</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">,</span> <span class="n">gh_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HIF_HOLDER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">gh</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * state_change - record that the glock is now in a different state</span>
<span class="cm"> * @gl: the glock</span>
<span class="cm"> * @new_state the new state</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">state_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">held1</span><span class="p">,</span> <span class="n">held2</span><span class="p">;</span>

	<span class="n">held1</span> <span class="o">=</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span> <span class="o">!=</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">);</span>
	<span class="n">held2</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">!=</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">held1</span> <span class="o">!=</span> <span class="n">held2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">held2</span><span class="p">)</span>
			<span class="n">gfs2_glock_hold</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">gfs2_glock_put_nolock</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">held1</span> <span class="o">&amp;&amp;</span> <span class="n">held2</span> <span class="o">&amp;&amp;</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">))</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_QUEUED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">!=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_target</span><span class="p">)</span>
		<span class="cm">/* shorten our minimum hold time */</span>
		<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_hold_time</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_hold_time</span> <span class="o">-</span> <span class="n">GL_GLOCK_HOLD_DECR</span><span class="p">,</span>
				       <span class="n">GL_GLOCK_MIN_HOLD</span><span class="p">);</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_tchange</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_demote_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_state</span> <span class="o">=</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
	<span class="n">wake_up_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">,</span> <span class="n">GLF_DEMOTE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * finish_xmote - The DLM has replied to one of our lock requests</span>
<span class="cm"> * @gl: The glock</span>
<span class="cm"> * @ret: The status from the DLM</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">finish_xmote</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock_operations</span> <span class="o">*</span><span class="n">glops</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">state</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">&amp;</span> <span class="n">LM_OUT_ST_MASK</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="n">trace_gfs2_glock_state_change</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">state_change</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">gh</span> <span class="o">=</span> <span class="n">find_first_waiter</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>

	<span class="cm">/* Demote to UN request arrived during demote to SH or DF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">state</span> <span class="o">!=</span> <span class="n">LM_ST_UNLOCKED</span> <span class="o">&amp;&amp;</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_state</span> <span class="o">==</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">)</span>
		<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_target</span> <span class="o">=</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">;</span>

	<span class="cm">/* Check for state != intended state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_target</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gh</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* move to back of queue and try next entry */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">LM_OUT_CANCELED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;</span> <span class="n">LM_FLAG_PRIORITY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">);</span>
				<span class="n">gh</span> <span class="o">=</span> <span class="n">find_first_waiter</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
				<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_target</span> <span class="o">=</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_state</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Some error or failed &quot;try lock&quot; - report it */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">LM_OUT_ERROR</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LM_FLAG_TRY</span> <span class="o">|</span> <span class="n">LM_FLAG_TRY_1CB</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_target</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span><span class="p">;</span>
				<span class="n">do_error</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Unlocked due to conversion deadlock, try again */</span>
		<span class="k">case</span> <span class="n">LM_ST_UNLOCKED</span>:
<span class="nl">retry:</span>
			<span class="n">do_xmote</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">gh</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_target</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Conversion fails, unlock and try again */</span>
		<span class="k">case</span> <span class="n">LM_ST_SHARED</span>:
		<span class="k">case</span> <span class="n">LM_ST_DEFERRED</span>:
			<span class="n">do_xmote</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">gh</span><span class="p">,</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="cm">/* Everything else */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;GFS2: wanted %u got %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_target</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
			<span class="n">GLOCK_BUG_ON</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fast path - we got what we asked for */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span>
		<span class="n">gfs2_demote_wake</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_xmote_bh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_xmote_bh</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">gh</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">do_error</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">do_promote</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_locked</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
<span class="nl">out_locked:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_xmote - Calls the DLM to change the state of a lock</span>
<span class="cm"> * @gl: The lock state</span>
<span class="cm"> * @gh: The holder (only for promotes)</span>
<span class="cm"> * @target: The target lock state</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_xmote</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock_operations</span> <span class="o">*</span><span class="n">glops</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lck_flags</span> <span class="o">=</span> <span class="n">gh</span> <span class="o">?</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lck_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">LM_FLAG_TRY</span> <span class="o">|</span> <span class="n">LM_FLAG_TRY_1CB</span> <span class="o">|</span> <span class="n">LM_FLAG_NOEXP</span> <span class="o">|</span>
		      <span class="n">LM_FLAG_PRIORITY</span><span class="p">);</span>
	<span class="n">GLOCK_BUG_ON</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span> <span class="o">==</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">GLOCK_BUG_ON</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span> <span class="o">==</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">target</span> <span class="o">==</span> <span class="n">LM_ST_UNLOCKED</span> <span class="o">||</span> <span class="n">target</span> <span class="o">==</span> <span class="n">LM_ST_DEFERRED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_inval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_INVALIDATE_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
		<span class="n">do_error</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Fail queued try locks */</span>
	<span class="p">}</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_req</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_BLOCKING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_req</span> <span class="o">==</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span> <span class="o">==</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">lck_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LM_FLAG_TRY</span><span class="o">|</span><span class="n">LM_FLAG_TRY_1CB</span><span class="p">)))</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_BLOCKING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_xmote_th</span><span class="p">)</span>
		<span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_xmote_th</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_INVALIDATE_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span>
		<span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_inval</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">target</span> <span class="o">==</span> <span class="n">LM_ST_DEFERRED</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">DIO_METADATA</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_INVALIDATE_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>

	<span class="n">gfs2_glock_hold</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_lockstruct</span><span class="p">.</span><span class="n">ls_ops</span><span class="o">-&gt;</span><span class="n">lm_lock</span><span class="p">)</span>	<span class="p">{</span>
		<span class="cm">/* lock_dlm */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_lockstruct</span><span class="p">.</span><span class="n">ls_ops</span><span class="o">-&gt;</span><span class="n">lm_lock</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lck_flags</span><span class="p">);</span>
		<span class="n">GLOCK_BUG_ON</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* lock_nolock */</span>
		<span class="n">finish_xmote</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">glock_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * find_first_holder - find the first &quot;holder&quot; gh</span>
<span class="cm"> * @gl: the glock</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="nf">find_first_holder</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gh</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_holder</span><span class="p">,</span> <span class="n">gh_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HIF_HOLDER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">gh</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * run_queue - do all outstanding tasks related to a glock</span>
<span class="cm"> * @gl: The glock in question</span>
<span class="cm"> * @nonblock: True if we must not block in run_queue</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">run_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">nonblock</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">GLF_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">GLOCK_BUG_ON</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_state</span> <span class="o">!=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">find_first_holder</span><span class="p">(</span><span class="n">gl</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_sched</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
		<span class="n">GLOCK_BUG_ON</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_state</span> <span class="o">==</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">);</span>
		<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_target</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_state</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span>
			<span class="n">gfs2_demote_wake</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">do_promote</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">gh</span> <span class="o">=</span> <span class="n">find_first_waiter</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
		<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_target</span> <span class="o">=</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_state</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LM_FLAG_TRY</span> <span class="o">|</span> <span class="n">LM_FLAG_TRY_1CB</span><span class="p">)))</span>
			<span class="n">do_error</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Fail queued try locks */</span>
	<span class="p">}</span>
	<span class="n">do_xmote</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">gh</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_target</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_sched:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
	<span class="n">gfs2_glock_hold</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">glock_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gfs2_glock_put_nolock</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">delete_work_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_glock</span><span class="p">,</span> <span class="n">gl_delete</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">no_addr</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">.</span><span class="n">ln_number</span><span class="p">;</span>

	<span class="n">ip</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_object</span><span class="p">;</span>
	<span class="cm">/* Note: Unsafe to dereference ip as we don&#39;t hold right refs/locks */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="p">)</span>
		<span class="n">inode</span> <span class="o">=</span> <span class="n">gfs2_ilookup</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="p">,</span> <span class="n">no_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">inode</span> <span class="o">=</span> <span class="n">gfs2_lookup_by_inum</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">no_addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFS2_BLKST_UNLINKED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">d_prune_aliases</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">glock_work_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_glock</span><span class="p">,</span> <span class="n">gl_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">drop_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">GLF_REPLY_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">finish_xmote</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_reply</span><span class="p">);</span>
		<span class="n">drop_ref</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_PENDING_DEMOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span> <span class="o">!=</span> <span class="n">LM_ST_UNLOCKED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_state</span> <span class="o">!=</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">holdtime</span><span class="p">,</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

		<span class="n">holdtime</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_tchange</span> <span class="o">+</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_hold_time</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">holdtime</span><span class="p">))</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="n">holdtime</span> <span class="o">-</span> <span class="n">now</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_PENDING_DEMOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">run_queue</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delay</span><span class="p">)</span>
		<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">.</span><span class="n">ln_type</span> <span class="o">!=</span> <span class="n">LM_TYPE_INODE</span><span class="p">)</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">glock_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_work</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drop_ref</span><span class="p">)</span>
		<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_get() - Get a glock, or create one if one doesn&#39;t exist</span>
<span class="cm"> * @sdp: The GFS2 superblock</span>
<span class="cm"> * @number: the lock number</span>
<span class="cm"> * @glops: The glock_operations to use</span>
<span class="cm"> * @create: If 0, don&#39;t create the glock if it doesn&#39;t exist</span>
<span class="cm"> * @glp: the glock is returned here</span>
<span class="cm"> *</span>
<span class="cm"> * This does not lock a glock, just finds/creates structures for one.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_glock_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">number</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock_operations</span> <span class="o">*</span><span class="n">glops</span><span class="p">,</span> <span class="kt">int</span> <span class="n">create</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">**</span><span class="n">glp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm_lockname</span> <span class="n">name</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">ln_number</span> <span class="o">=</span> <span class="n">number</span><span class="p">,</span> <span class="p">.</span><span class="n">ln_type</span> <span class="o">=</span> <span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_type</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">gl_hash</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">cachep</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">gl</span> <span class="o">=</span> <span class="n">search_bucket</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">sdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="o">*</span><span class="n">glp</span> <span class="o">=</span> <span class="n">gl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">create</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_flags</span> <span class="o">&amp;</span> <span class="n">GLOF_ASPACE</span><span class="p">)</span>
		<span class="n">cachep</span> <span class="o">=</span> <span class="n">gfs2_glock_aspace_cachep</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cachep</span> <span class="o">=</span> <span class="n">gfs2_glock_cachep</span><span class="p">;</span>
	<span class="n">gl</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">cachep</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_glock_disposal</span><span class="p">);</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span> <span class="o">=</span> <span class="n">sdp</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ref</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span> <span class="o">=</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_target</span> <span class="o">=</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_state</span> <span class="o">=</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_hash</span> <span class="o">=</span> <span class="n">hash</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ops</span> <span class="o">=</span> <span class="n">glops</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_dstamp</span> <span class="o">=</span> <span class="n">ktime_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">preempt_disable</span><span class="p">();</span>
	<span class="cm">/* We use the global stats to estimate the initial per-glock stats */</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_stats</span> <span class="o">=</span> <span class="n">this_cpu_ptr</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_lkstats</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lkstats</span><span class="p">[</span><span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_type</span><span class="p">];</span>
	<span class="n">preempt_enable</span><span class="p">();</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_stats</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="n">GFS2_LKS_DCOUNT</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_stats</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="n">GFS2_LKS_QCOUNT</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_lksb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_lksb</span><span class="p">));</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_lksb</span><span class="p">.</span><span class="n">sb_lvbptr</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_lvb</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_tchange</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_object</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_hold_time</span> <span class="o">=</span> <span class="n">GL_GLOCK_DFT_HOLD</span><span class="p">;</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_work</span><span class="p">,</span> <span class="n">glock_work_func</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_delete</span><span class="p">,</span> <span class="n">delete_work_func</span><span class="p">);</span>

	<span class="n">mapping</span> <span class="o">=</span> <span class="n">gfs2_glock2aspace</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gfs2_meta_aops</span><span class="p">;</span>
		<span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">;</span>
		<span class="n">mapping</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mapping_set_gfp_mask</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="n">mapping</span><span class="o">-&gt;</span><span class="n">assoc_mapping</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mapping</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_bdi</span><span class="p">;</span>
		<span class="n">mapping</span><span class="o">-&gt;</span><span class="n">writeback_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bucket</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">search_bucket</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">sdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bucket</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">cachep</span><span class="p">,</span> <span class="n">gl</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_glock_disposal</span><span class="p">);</span>
		<span class="n">gl</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hlist_bl_add_head_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">]);</span>
		<span class="n">spin_unlock_bucket</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">glp</span> <span class="o">=</span> <span class="n">gl</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_holder_init - initialize a struct gfs2_holder in the default way</span>
<span class="cm"> * @gl: the glock</span>
<span class="cm"> * @state: the state we&#39;re requesting</span>
<span class="cm"> * @flags: the modifier flags</span>
<span class="cm"> * @gh: the holder structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_holder_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_list</span><span class="p">);</span>
	<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span> <span class="o">=</span> <span class="n">gl</span><span class="p">;</span>
	<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_ip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_owner_pid</span> <span class="o">=</span> <span class="n">get_pid</span><span class="p">(</span><span class="n">task_pid</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
	<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gfs2_glock_hold</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_holder_reinit - reinitialize a struct gfs2_holder so we can requeue it</span>
<span class="cm"> * @state: the state we&#39;re requesting</span>
<span class="cm"> * @flags: the modifier flags</span>
<span class="cm"> * @gh: the holder structure</span>
<span class="cm"> *</span>
<span class="cm"> * Don&#39;t mess with the glock.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_holder_reinit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_ip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_owner_pid</span><span class="p">)</span>
		<span class="n">put_pid</span><span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_owner_pid</span><span class="p">);</span>
	<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_owner_pid</span> <span class="o">=</span> <span class="n">get_pid</span><span class="p">(</span><span class="n">task_pid</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_holder_uninit - uninitialize a holder structure (drop glock reference)</span>
<span class="cm"> * @gh: the holder structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_holder_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">put_pid</span><span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_owner_pid</span><span class="p">);</span>
	<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="p">);</span>
	<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_ip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_holder_wait</span>
<span class="cm"> * @word: unused</span>
<span class="cm"> *</span>
<span class="cm"> * This function and gfs2_glock_demote_wait both show up in the WCHAN</span>
<span class="cm"> * field. Thus I&#39;ve separated these otherwise identical functions in</span>
<span class="cm"> * order to be more informative to the user.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_glock_holder_wait</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">word</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">schedule</span><span class="p">();</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_glock_demote_wait</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">word</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_on_holder</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time1</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>
	<span class="n">wait_on_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span><span class="p">,</span> <span class="n">HIF_WAIT</span><span class="p">,</span> <span class="n">gfs2_glock_holder_wait</span><span class="p">,</span> <span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">time1</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">))</span> <span class="cm">/* have we waited &gt; a second? */</span>
		<span class="cm">/* Lengthen the minimum hold time. */</span>
		<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_hold_time</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_hold_time</span> <span class="o">+</span>
					      <span class="n">GL_GLOCK_HOLD_INCR</span><span class="p">,</span>
					      <span class="n">GL_GLOCK_MAX_HOLD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_on_demote</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">might_sleep</span><span class="p">();</span>
	<span class="n">wait_on_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">,</span> <span class="n">GLF_DEMOTE</span><span class="p">,</span> <span class="n">gfs2_glock_demote_wait</span><span class="p">,</span> <span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * handle_callback - process a demote request</span>
<span class="cm"> * @gl: the glock</span>
<span class="cm"> * @state: the state the caller wants us to change to</span>
<span class="cm"> *</span>
<span class="cm"> * There are only two requests that we are going to see in actual</span>
<span class="cm"> * practise: LM_ST_SHARED and LM_ST_UNLOCKED</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">delay</span> <span class="o">?</span> <span class="n">GLF_PENDING_DEMOTE</span> <span class="o">:</span> <span class="n">GLF_DEMOTE</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_state</span> <span class="o">==</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
		<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_state</span> <span class="o">!=</span> <span class="n">LM_ST_UNLOCKED</span> <span class="o">&amp;&amp;</span>
			<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_state</span> <span class="o">=</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ops</span><span class="o">-&gt;</span><span class="n">go_callback</span><span class="p">)</span>
		<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ops</span><span class="o">-&gt;</span><span class="n">go_callback</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="n">trace_gfs2_demote_rq</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_wait - wait on a glock acquisition</span>
<span class="cm"> * @gh: the glock holder</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_glock_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wait_on_holder</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_print_dbg</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gfs2_glock_iter</span> <span class="o">*</span><span class="n">gi</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
		<span class="n">vsprintf</span><span class="p">(</span><span class="n">gi</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">gi</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
		<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; %pV&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * add_to_queue - Add a holder to the wait queue (but look for recursion)</span>
<span class="cm"> * @gh: the holder structure to add</span>
<span class="cm"> *</span>
<span class="cm"> * Eventually we should move the recursive locking trap to a</span>
<span class="cm"> * debugging option or something like that. This is the fast</span>
<span class="cm"> * path and needs to have the minimum number of distractions.</span>
<span class="cm"> * </span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">add_to_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">insert_pt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">try_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_owner_pid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HIF_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LM_FLAG_TRY</span> <span class="o">|</span> <span class="n">LM_FLAG_TRY_1CB</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span>
			<span class="n">try_lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_INVALIDATE_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">gh2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">,</span> <span class="n">gh_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">gh2</span><span class="o">-&gt;</span><span class="n">gh_owner_pid</span> <span class="o">==</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_owner_pid</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_ops</span><span class="o">-&gt;</span><span class="n">go_type</span> <span class="o">!=</span> <span class="n">LM_TYPE_FLOCK</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">trap_recursive</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">try_lock</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">gh2</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LM_FLAG_TRY</span> <span class="o">|</span> <span class="n">LM_FLAG_TRY_1CB</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">may_grant</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">gh</span><span class="p">))</span> <span class="p">{</span>
<span class="nl">fail:</span>
			<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_error</span> <span class="o">=</span> <span class="n">GLR_TRYFAILED</span><span class="p">;</span>
			<span class="n">gfs2_holder_wake</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HIF_HOLDER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh2</span><span class="o">-&gt;</span><span class="n">gh_iflags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;</span> <span class="n">LM_FLAG_PRIORITY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">insert_pt</span><span class="p">))</span>
			<span class="n">insert_pt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gh2</span><span class="o">-&gt;</span><span class="n">gh_list</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_QUEUED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">trace_gfs2_glock_queue</span><span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_glstats_inc</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">GFS2_LKS_QCOUNT</span><span class="p">);</span>
	<span class="n">gfs2_sbstats_inc</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">GFS2_LKS_QCOUNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">insert_pt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;</span> <span class="n">LM_FLAG_PRIORITY</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">do_cancel</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_list</span><span class="p">,</span> <span class="n">insert_pt</span><span class="p">);</span>
<span class="nl">do_cancel:</span>
	<span class="n">gh</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_holder</span><span class="p">,</span> <span class="n">gh_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;</span> <span class="n">LM_FLAG_PRIORITY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_lockstruct</span><span class="p">.</span><span class="n">ls_ops</span><span class="o">-&gt;</span><span class="n">lm_cancel</span><span class="p">)</span>
			<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_lockstruct</span><span class="p">.</span><span class="n">ls_ops</span><span class="o">-&gt;</span><span class="n">lm_cancel</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">trap_recursive:</span>
	<span class="n">print_symbol</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;original: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gh2</span><span class="o">-&gt;</span><span class="n">gh_ip</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pid_nr</span><span class="p">(</span><span class="n">gh2</span><span class="o">-&gt;</span><span class="n">gh_owner_pid</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;lock type: %d req lock state : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">gh2</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">.</span><span class="n">ln_type</span><span class="p">,</span> <span class="n">gh2</span><span class="o">-&gt;</span><span class="n">gh_state</span><span class="p">);</span>
	<span class="n">print_symbol</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;new: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_ip</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pid_nr</span><span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_owner_pid</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;lock type: %d req lock state : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">.</span><span class="n">ln_type</span><span class="p">,</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_state</span><span class="p">);</span>
	<span class="n">__dump_glock</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">gl</span><span class="p">);</span>
	<span class="n">BUG</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_nq - enqueue a struct gfs2_holder onto a glock (acquire a glock)</span>
<span class="cm"> * @gh: the holder structure</span>
<span class="cm"> *</span>
<span class="cm"> * if (gh-&gt;gh_flags &amp; GL_ASYNC), this never returns an error</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0, GLR_TRYFAILED, or errno on failure</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_glock_nq</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SDF_SHUTDOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_LRU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span>
		<span class="n">gfs2_glock_remove_from_lru</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="n">add_to_queue</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">LM_FLAG_NOEXP</span> <span class="o">&amp;</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">GLF_FROZEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_REPLY_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">run_queue</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;</span> <span class="n">GL_ASYNC</span><span class="p">))</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_wait</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_poll - poll to see if an async request has been completed</span>
<span class="cm"> * @gh: the holder</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 1 if the request is ready to be gfs2_glock_wait()ed on</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_glock_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">HIF_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_dq - dequeue a struct gfs2_holder from a glock (release a glock)</span>
<span class="cm"> * @gh: the glock holder</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_glock_dq</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock_operations</span> <span class="o">*</span><span class="n">glops</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ops</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fast_path</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;</span> <span class="n">GL_NOCACHE</span><span class="p">)</span>
		<span class="n">handle_callback</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">find_first_holder</span><span class="p">(</span><span class="n">gl</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_unlock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">GLOCK_BUG_ON</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">GLF_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">));</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
			<span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_unlock</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_PENDING_DEMOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span>
			<span class="n">fast_path</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_LFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span>
		<span class="n">__gfs2_glock_schedule_for_reclaim</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="n">trace_gfs2_glock_queue</span><span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">fast_path</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">gfs2_glock_hold</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_PENDING_DEMOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">.</span><span class="n">ln_type</span> <span class="o">==</span> <span class="n">LM_TYPE_INODE</span><span class="p">)</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_hold_time</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">glock_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_work</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_glock_dq_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="p">;</span>
	<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
	<span class="n">wait_on_demote</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_dq_uninit - dequeue a holder from a glock and initialize it</span>
<span class="cm"> * @gh: the holder structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
	<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_nq_num - acquire a glock based on lock number</span>
<span class="cm"> * @sdp: the filesystem</span>
<span class="cm"> * @number: the lock number</span>
<span class="cm"> * @glops: the glock operations for the type of glock</span>
<span class="cm"> * @state: the state to acquire the glock in</span>
<span class="cm"> * @flags: modifier flags for the acquisition</span>
<span class="cm"> * @gh: the struct gfs2_holder</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_glock_nq_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">number</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock_operations</span> <span class="o">*</span><span class="n">glops</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">glops</span><span class="p">,</span> <span class="n">CREATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">gh</span><span class="p">);</span>
		<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * glock_compare - Compare two struct gfs2_glock structures for sorting</span>
<span class="cm"> * @arg_a: the first structure</span>
<span class="cm"> * @arg_b: the second structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">glock_compare</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg_a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg_b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh_a</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">**</span><span class="p">)</span><span class="n">arg_a</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh_b</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">**</span><span class="p">)</span><span class="n">arg_b</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">lm_lockname</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gh_a</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">lm_lockname</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gh_b</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ln_number</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">ln_number</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ln_number</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">ln_number</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">gh_a</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_ops</span><span class="o">-&gt;</span><span class="n">go_type</span> <span class="o">==</span> <span class="n">gh_b</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_ops</span><span class="o">-&gt;</span><span class="n">go_type</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nq_m_sync - synchonously acquire more than one glock in deadlock free order</span>
<span class="cm"> * @num_gh: the number of structures</span>
<span class="cm"> * @ghs: an array of struct gfs2_holder structures</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success (all glocks acquired),</span>
<span class="cm"> *          errno on failure (no glocks acquired)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nq_m_sync</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_gh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">ghs</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">**</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">num_gh</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
		<span class="n">p</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ghs</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>

	<span class="n">sort</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">num_gh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="p">),</span> <span class="n">glock_compare</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">num_gh</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LM_FLAG_TRY</span> <span class="o">|</span> <span class="n">GL_ASYNC</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">x</span><span class="o">--</span><span class="p">)</span>
				<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_nq_m - acquire multiple glocks</span>
<span class="cm"> * @num_gh: the number of structures</span>
<span class="cm"> * @ghs: an array of struct gfs2_holder structures</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success (all glocks acquired),</span>
<span class="cm"> *          errno on failure (no glocks acquired)</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_glock_nq_m</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_gh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">ghs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">**</span><span class="n">pph</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">num_gh</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ghs</span><span class="o">-&gt;</span><span class="n">gh_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LM_FLAG_TRY</span> <span class="o">|</span> <span class="n">GL_ASYNC</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">gfs2_glock_nq</span><span class="p">(</span><span class="n">ghs</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_gh</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pph</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">num_gh</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pph</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nq_m_sync</span><span class="p">(</span><span class="n">num_gh</span><span class="p">,</span> <span class="n">ghs</span><span class="p">,</span> <span class="n">pph</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pph</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pph</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_dq_m - release multiple glocks</span>
<span class="cm"> * @num_gh: the number of structures</span>
<span class="cm"> * @ghs: an array of struct gfs2_holder structures</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_glock_dq_m</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_gh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">ghs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">num_gh</span><span class="o">--</span><span class="p">)</span>
		<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ghs</span><span class="p">[</span><span class="n">num_gh</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_dq_uninit_m - release multiple glocks</span>
<span class="cm"> * @num_gh: the number of structures</span>
<span class="cm"> * @ghs: an array of struct gfs2_holder structures</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_glock_dq_uninit_m</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_gh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">ghs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">num_gh</span><span class="o">--</span><span class="p">)</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ghs</span><span class="p">[</span><span class="n">num_gh</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_glock_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">holdtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">gfs2_glock_hold</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="n">holdtime</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_tchange</span> <span class="o">+</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_hold_time</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_QUEUED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">.</span><span class="n">ln_type</span> <span class="o">==</span> <span class="n">LM_TYPE_INODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">holdtime</span><span class="p">))</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="n">holdtime</span> <span class="o">-</span> <span class="n">now</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_REPLY_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_hold_time</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="n">handle_callback</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">glock_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_work</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_should_freeze - Figure out if glock should be frozen</span>
<span class="cm"> * @gl: The glock in question</span>
<span class="cm"> *</span>
<span class="cm"> * Glocks are not frozen if (a) the result of the dlm operation is</span>
<span class="cm"> * an error, (b) the locking operation was an unlock operation or</span>
<span class="cm"> * (c) if there is a &quot;noexp&quot; flagged request anywhere in the queue</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 1 if freezing should occur, 0 otherwise</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_should_freeze</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_reply</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LM_OUT_ST_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_target</span> <span class="o">==</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">,</span> <span class="n">gh_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HIF_HOLDER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">LM_FLAG_NOEXP</span> <span class="o">&amp;</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_complete - Callback used by locking</span>
<span class="cm"> * @gl: Pointer to the glock</span>
<span class="cm"> * @ret: The return value from the dlm</span>
<span class="cm"> *</span>
<span class="cm"> * The gl_reply field is under the gl_spin lock so that it is ok</span>
<span class="cm"> * to use a bitfield shared with other glock state fields.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_glock_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm_lockstruct</span> <span class="o">*</span><span class="n">ls</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="o">-&gt;</span><span class="n">sd_lockstruct</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_reply</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DFL_BLOCK_LOCKS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ls</span><span class="o">-&gt;</span><span class="n">ls_recover_flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_should_freeze</span><span class="p">(</span><span class="n">gl</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_FROZEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_REPLY_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">gfs2_glock_hold</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">glock_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_shrink_glock_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">shrinker</span> <span class="o">*</span><span class="n">shrink</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">shrink_control</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">may_demote</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_skipped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">nr_to_scan</span><span class="p">;</span>
	<span class="n">gfp_t</span> <span class="n">gfp_mask</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">gfp_mask</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">skipped</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gfp_mask</span> <span class="o">&amp;</span> <span class="n">__GFP_FS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lru_lock</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">nr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lru_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gl</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">lru_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_glock</span><span class="p">,</span> <span class="n">gl_lru</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_lru</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_LRU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lru_count</span><span class="p">);</span>

		<span class="cm">/* Test for being demotable */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">GLF_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">gfs2_glock_hold</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lru_lock</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
			<span class="n">may_demote</span> <span class="o">=</span> <span class="n">demote_ok</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">may_demote</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">handle_callback</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">nr</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
			<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">glock_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">gfs2_glock_put_nolock</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lru_lock</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nr_skipped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skipped</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_LRU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skipped</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lru_list</span><span class="p">);</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">nr_skipped</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lru_count</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lru_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lru_count</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">sysctl_vfs_cache_pressure</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">shrinker</span> <span class="n">glock_shrinker</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">shrink</span> <span class="o">=</span> <span class="n">gfs2_shrink_glock_memory</span><span class="p">,</span>
	<span class="p">.</span><span class="n">seeks</span> <span class="o">=</span> <span class="n">DEFAULT_SEEKS</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * examine_bucket - Call a function for glock in a hash bucket</span>
<span class="cm"> * @examiner: the function</span>
<span class="cm"> * @sdp: the filesystem</span>
<span class="cm"> * @bucket: the bucket</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">examine_bucket</span><span class="p">(</span><span class="n">glock_examiner</span> <span class="n">examiner</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_bl_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gl_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hlist_bl_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">hlist_bl_for_each_entry_rcu</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">gl_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span> <span class="o">==</span> <span class="n">sdp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ref</span><span class="p">))</span>
			<span class="n">examiner</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">cond_resched</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">glock_hash_walk</span><span class="p">(</span><span class="n">glock_examiner</span> <span class="n">examiner</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">GFS2_GL_HASH_SIZE</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
		<span class="n">examine_bucket</span><span class="p">(</span><span class="n">examiner</span><span class="p">,</span> <span class="n">sdp</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * thaw_glock - thaw out a glock which has an unprocessed reply waiting</span>
<span class="cm"> * @gl: The glock to thaw</span>
<span class="cm"> *</span>
<span class="cm"> * N.B. When we freeze a glock, we leave a ref to the glock outstanding,</span>
<span class="cm"> * so this has to result in the ref count being dropped by one.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">thaw_glock</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">GLF_FROZEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_REPLY_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">gfs2_glock_hold</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">glock_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * clear_glock - look at a glock and see if we can free it from glock cache</span>
<span class="cm"> * @gl: the glock to look at</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_glock</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gfs2_glock_remove_from_lru</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span> <span class="o">!=</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">)</span>
		<span class="n">handle_callback</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">LM_ST_UNLOCKED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="n">gfs2_glock_hold</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">glock_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_glock_thaw - Thaw any frozen glocks</span>
<span class="cm"> * @sdp: The super block</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_glock_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">glock_hash_walk</span><span class="p">(</span><span class="n">thaw_glock</span><span class="p">,</span> <span class="n">sdp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dump_glock</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__dump_glock</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">gl</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_glock_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_glock</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">gl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_gl_hash_clear - Empty out the glock hash table</span>
<span class="cm"> * @sdp: the filesystem</span>
<span class="cm"> * @wait: wait until it&#39;s all gone</span>
<span class="cm"> *</span>
<span class="cm"> * Called when unmounting the filesystem.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_gl_hash_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">glock_hash_walk</span><span class="p">(</span><span class="n">clear_glock</span><span class="p">,</span> <span class="n">sdp</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">glock_workqueue</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_glock_wait</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_glock_disposal</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">glock_hash_walk</span><span class="p">(</span><span class="n">dump_glock_func</span><span class="p">,</span> <span class="n">sdp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_glock_finish_truncate</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_truncatei_resume</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="n">gfs2_assert_withdraw</span><span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">,</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">run_queue</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_spin</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">state2str</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LM_ST_UNLOCKED</span>:
		<span class="k">return</span> <span class="s">&quot;UN&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LM_ST_SHARED</span>:
		<span class="k">return</span> <span class="s">&quot;SH&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LM_ST_DEFERRED</span>:
		<span class="k">return</span> <span class="s">&quot;DF&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LM_ST_EXCLUSIVE</span>:
		<span class="k">return</span> <span class="s">&quot;EX&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;??&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">hflags2str</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM_FLAG_TRY</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;t&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM_FLAG_TRY_1CB</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;T&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM_FLAG_NOEXP</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;e&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM_FLAG_ANY</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM_FLAG_PRIORITY</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;p&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GL_ASYNC</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GL_EXACT</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;E&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GL_NOCACHE</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;c&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HIF_HOLDER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;H&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HIF_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;W&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HIF_FIRST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;F&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dump_holder - print information about a glock holder</span>
<span class="cm"> * @seq: the seq_file struct</span>
<span class="cm"> * @gh: the glock holder</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, -ENOBUFS when we run out of space</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dump_holder</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">gh_owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">flags_buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_owner_pid</span><span class="p">)</span>
		<span class="n">gh_owner</span> <span class="o">=</span> <span class="n">pid_task</span><span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_owner_pid</span><span class="p">,</span> <span class="n">PIDTYPE_PID</span><span class="p">);</span>
	<span class="n">gfs2_print_dbg</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; H: s:%s f:%s e:%d p:%ld [%s] %pS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">state2str</span><span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_state</span><span class="p">),</span>
		       <span class="n">hflags2str</span><span class="p">(</span><span class="n">flags_buf</span><span class="p">,</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_flags</span><span class="p">,</span> <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_iflags</span><span class="p">),</span>
		       <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_error</span><span class="p">,</span>
		       <span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_owner_pid</span> <span class="o">?</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">pid_nr</span><span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_owner_pid</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		       <span class="n">gh_owner</span> <span class="o">?</span> <span class="n">gh_owner</span><span class="o">-&gt;</span><span class="n">comm</span> <span class="o">:</span> <span class="s">&quot;(ended)&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_ip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">gflags2str</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">gflags</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_LOCK</span><span class="p">,</span> <span class="n">gflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;l&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE</span><span class="p">,</span> <span class="n">gflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;D&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_PENDING_DEMOTE</span><span class="p">,</span> <span class="n">gflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;d&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE_IN_PROGRESS</span><span class="p">,</span> <span class="n">gflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;p&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_DIRTY</span><span class="p">,</span> <span class="n">gflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;y&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_LFLUSH</span><span class="p">,</span> <span class="n">gflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;f&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_INVALIDATE_IN_PROGRESS</span><span class="p">,</span> <span class="n">gflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;i&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_REPLY_PENDING</span><span class="p">,</span> <span class="n">gflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;r&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_INITIAL</span><span class="p">,</span> <span class="n">gflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;I&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_FROZEN</span><span class="p">,</span> <span class="n">gflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;F&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_QUEUED</span><span class="p">,</span> <span class="n">gflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;q&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_LRU</span><span class="p">,</span> <span class="n">gflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;L&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_object</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;o&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_BLOCKING</span><span class="p">,</span> <span class="n">gflags</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;b&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __dump_glock - print information about a glock</span>
<span class="cm"> * @seq: The seq_file struct</span>
<span class="cm"> * @gl: the glock</span>
<span class="cm"> *</span>
<span class="cm"> * The file format is as follows:</span>
<span class="cm"> * One line per object, capital letters are used to indicate objects</span>
<span class="cm"> * G = glock, I = Inode, R = rgrp, H = holder. Glocks are not indented,</span>
<span class="cm"> * other objects are indented by a single space and follow the glock to</span>
<span class="cm"> * which they are related. Fields are indicated by lower case letters</span>
<span class="cm"> * followed by a colon and the field value, except for strings which are in</span>
<span class="cm"> * [] so that its possible to see if they are composed of spaces for</span>
<span class="cm"> * example. The field&#39;s are n = number (id of the object), f = flags,</span>
<span class="cm"> * t = type, s = state, r = refcount, e = error, p = pid.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, -ENOBUFS when we run out of space</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__dump_glock</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_glock_operations</span> <span class="o">*</span><span class="n">glops</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ops</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">dtime</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gh</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">gflags_buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dtime</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_time</span><span class="p">;</span>
	<span class="n">dtime</span> <span class="o">*=</span> <span class="mi">1000000</span><span class="o">/</span><span class="n">HZ</span><span class="p">;</span> <span class="cm">/* demote time in uSec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span>
		<span class="n">dtime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gfs2_print_dbg</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;G:  s:%s n:%u/%llx f:%s t:%s d:%s/%llu a:%d v:%d r:%d m:%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">state2str</span><span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span><span class="p">),</span>
		  <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">.</span><span class="n">ln_type</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">.</span><span class="n">ln_number</span><span class="p">,</span>
		  <span class="n">gflags2str</span><span class="p">(</span><span class="n">gflags_buf</span><span class="p">,</span> <span class="n">gl</span><span class="p">),</span>
		  <span class="n">state2str</span><span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_target</span><span class="p">),</span>
		  <span class="n">state2str</span><span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_demote_state</span><span class="p">),</span> <span class="n">dtime</span><span class="p">,</span>
		  <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ail_count</span><span class="p">),</span>
		  <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_revokes</span><span class="p">),</span>
		  <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ref</span><span class="p">),</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_hold_time</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_holders</span><span class="p">,</span> <span class="n">gh_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">dump_holder</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_state</span> <span class="o">!=</span> <span class="n">LM_ST_UNLOCKED</span> <span class="o">&amp;&amp;</span> <span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_dump</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">glops</span><span class="o">-&gt;</span><span class="n">go_dump</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">gl</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_glstats_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">iter_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">iter_ptr</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;G: n:%u/%llx rtt:%lld/%lld rttb:%lld/%lld irt:%lld/%lld dcnt: %lld qcnt: %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">.</span><span class="n">ln_type</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">.</span><span class="n">ln_number</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_stats</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="n">GFS2_LKS_SRTT</span><span class="p">],</span>
		   <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_stats</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="n">GFS2_LKS_SRTTVAR</span><span class="p">],</span>
		   <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_stats</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="n">GFS2_LKS_SRTTB</span><span class="p">],</span>
		   <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_stats</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="n">GFS2_LKS_SRTTVARB</span><span class="p">],</span>
		   <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_stats</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="n">GFS2_LKS_SIRT</span><span class="p">],</span>
		   <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_stats</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="n">GFS2_LKS_SIRTVAR</span><span class="p">],</span>
		   <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_stats</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="n">GFS2_LKS_DCOUNT</span><span class="p">],</span>
		   <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_stats</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="n">GFS2_LKS_QCOUNT</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">gfs2_gltype</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;type&quot;</span><span class="p">,</span>
	<span class="s">&quot;reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;nondisk&quot;</span><span class="p">,</span>
	<span class="s">&quot;inode&quot;</span><span class="p">,</span>
	<span class="s">&quot;rgrp&quot;</span><span class="p">,</span>
	<span class="s">&quot;meta&quot;</span><span class="p">,</span>
	<span class="s">&quot;iopen&quot;</span><span class="p">,</span>
	<span class="s">&quot;flock&quot;</span><span class="p">,</span>
	<span class="s">&quot;plock&quot;</span><span class="p">,</span>
	<span class="s">&quot;quota&quot;</span><span class="p">,</span>
	<span class="s">&quot;journal&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">gfs2_stype</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">GFS2_LKS_SRTT</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;srtt&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">GFS2_LKS_SRTTVAR</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;srttvar&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">GFS2_LKS_SRTTB</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;srttb&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">GFS2_LKS_SRTTVARB</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;srttvarb&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">GFS2_LKS_SIRT</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;sirt&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">GFS2_LKS_SIRTVAR</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;sirtvar&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">GFS2_LKS_DCOUNT</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;dlm&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">GFS2_LKS_QCOUNT</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;queue&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define GFS2_NR_SBSTATS (ARRAY_SIZE(gfs2_gltype) * ARRAY_SIZE(gfs2_stype))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_sbstats_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">iter_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock_iter</span> <span class="o">*</span><span class="n">gi</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">gi</span><span class="o">-&gt;</span><span class="n">sdp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">index</span> <span class="o">=</span> <span class="n">gi</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">subindex</span> <span class="o">=</span> <span class="n">gi</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">subindex</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%-10s %8s:&quot;</span><span class="p">,</span> <span class="n">gfs2_gltype</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
		   <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;cpu&quot;</span><span class="o">:</span> <span class="n">gfs2_stype</span><span class="p">[</span><span class="n">subindex</span><span class="p">]);</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_pcpu_lkstats</span> <span class="o">*</span><span class="n">lkstats</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_lkstats</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">lkstats</span><span class="o">-&gt;</span><span class="n">lkstats</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">stats</span><span class="p">[</span><span class="n">subindex</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %15lld&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_putc</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">gfs2_glock_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GFS2_GL_HASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_HLIST_BL_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl_hash_table</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">glock_workqueue</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;glock_workqueue&quot;</span><span class="p">,</span> <span class="n">WQ_MEM_RECLAIM</span> <span class="o">|</span>
					  <span class="n">WQ_HIGHPRI</span> <span class="o">|</span> <span class="n">WQ_FREEZABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">glock_workqueue</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">glock_workqueue</span><span class="p">);</span>
	<span class="n">gfs2_delete_workqueue</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;delete_workqueue&quot;</span><span class="p">,</span>
						<span class="n">WQ_MEM_RECLAIM</span> <span class="o">|</span> <span class="n">WQ_FREEZABLE</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gfs2_delete_workqueue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">glock_workqueue</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gfs2_delete_workqueue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">register_shrinker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">glock_shrinker</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_glock_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_shrinker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">glock_shrinker</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">glock_workqueue</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">gfs2_delete_workqueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="nf">glock_hash_chain</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">hash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hlist_bl_entry</span><span class="p">(</span><span class="n">hlist_bl_first_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">]),</span>
			      <span class="k">struct</span> <span class="n">gfs2_glock</span><span class="p">,</span> <span class="n">gl_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="nf">glock_hash_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hlist_bl_entry</span><span class="p">(</span><span class="n">rcu_dereference</span><span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_list</span><span class="p">.</span><span class="n">next</span><span class="p">),</span>
			      <span class="k">struct</span> <span class="n">gfs2_glock</span><span class="p">,</span> <span class="n">gl_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_glock_iter_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock_iter</span> <span class="o">*</span><span class="n">gi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">gl</span> <span class="o">=</span> <span class="n">gi</span><span class="o">-&gt;</span><span class="n">gl</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gi</span><span class="o">-&gt;</span><span class="n">gl</span> <span class="o">=</span> <span class="n">glock_hash_next</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">gi</span><span class="o">-&gt;</span><span class="n">gl</span> <span class="o">=</span> <span class="n">glock_hash_chain</span><span class="p">(</span><span class="n">gi</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">gi</span><span class="o">-&gt;</span><span class="n">gl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gi</span><span class="o">-&gt;</span><span class="n">hash</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gi</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&gt;=</span> <span class="n">GFS2_GL_HASH_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rcu_read_unlock</span><span class="p">();</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">gi</span><span class="o">-&gt;</span><span class="n">gl</span> <span class="o">=</span> <span class="n">glock_hash_chain</span><span class="p">(</span><span class="n">gi</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="cm">/* Skip entries for other sb and dead entries */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">gi</span><span class="o">-&gt;</span><span class="n">sdp</span> <span class="o">!=</span> <span class="n">gi</span><span class="o">-&gt;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span> <span class="o">||</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gi</span><span class="o">-&gt;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ref</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">gfs2_glock_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock_iter</span> <span class="o">*</span><span class="n">gi</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">n</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="n">gi</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_glock_iter_next</span><span class="p">(</span><span class="n">gi</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">gi</span><span class="o">-&gt;</span><span class="n">gl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">gfs2_glock_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">iter_ptr</span><span class="p">,</span>
				 <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock_iter</span> <span class="o">*</span><span class="n">gi</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_glock_iter_next</span><span class="p">(</span><span class="n">gi</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">gi</span><span class="o">-&gt;</span><span class="n">gl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_glock_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">iter_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock_iter</span> <span class="o">*</span><span class="n">gi</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gi</span><span class="o">-&gt;</span><span class="n">gl</span><span class="p">)</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">gi</span><span class="o">-&gt;</span><span class="n">gl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_glock_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">iter_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dump_glock</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">iter_ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">gfs2_sbstats_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock_iter</span> <span class="o">*</span><span class="n">gi</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">gi</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">GFS2_NR_SBSTATS</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">preempt_disable</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">gfs2_sbstats_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">iter_ptr</span><span class="p">,</span>
				   <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock_iter</span> <span class="o">*</span><span class="n">gi</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="n">gi</span><span class="o">-&gt;</span><span class="n">hash</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gi</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&gt;=</span> <span class="n">GFS2_NR_SBSTATS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">preempt_enable</span><span class="p">();</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_sbstats_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">iter_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">preempt_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">gfs2_glock_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">gfs2_glock_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>  <span class="o">=</span> <span class="n">gfs2_glock_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>  <span class="o">=</span> <span class="n">gfs2_glock_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>  <span class="o">=</span> <span class="n">gfs2_glock_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">gfs2_glstats_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">gfs2_glock_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>  <span class="o">=</span> <span class="n">gfs2_glock_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>  <span class="o">=</span> <span class="n">gfs2_glock_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>  <span class="o">=</span> <span class="n">gfs2_glstats_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">gfs2_sbstats_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">gfs2_sbstats_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>  <span class="o">=</span> <span class="n">gfs2_sbstats_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>  <span class="o">=</span> <span class="n">gfs2_sbstats_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>  <span class="o">=</span> <span class="n">gfs2_sbstats_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_glocks_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">seq_open_private</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gfs2_glock_seq_ops</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock_iter</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">gfs2_glock_iter</span> <span class="o">*</span><span class="n">gi</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
		<span class="n">gi</span><span class="o">-&gt;</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_glstats_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">seq_open_private</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gfs2_glstats_seq_ops</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock_iter</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">gfs2_glock_iter</span> <span class="o">*</span><span class="n">gi</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
		<span class="n">gi</span><span class="o">-&gt;</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_sbstats_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">seq_open_private</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gfs2_sbstats_seq_ops</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_glock_iter</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">gfs2_glock_iter</span> <span class="o">*</span><span class="n">gi</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
		<span class="n">gi</span><span class="o">-&gt;</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">gfs2_glocks_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">gfs2_glocks_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">seq_release_private</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">gfs2_glstats_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">gfs2_glstats_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">seq_release_private</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">gfs2_sbstats_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	 <span class="o">=</span> <span class="n">gfs2_sbstats_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">seq_release_private</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">gfs2_create_debugfs_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_table_name</span><span class="p">,</span> <span class="n">gfs2_root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_glocks</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;glocks&quot;</span><span class="p">,</span>
							 <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
							 <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">,</span> <span class="n">sdp</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">gfs2_glocks_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_glocks</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_glstats</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;glstats&quot;</span><span class="p">,</span>
							<span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
							<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">,</span> <span class="n">sdp</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">gfs2_glstats_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_glstats</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_sbstats</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;sbstats&quot;</span><span class="p">,</span>
							<span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
							<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">,</span> <span class="n">sdp</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">gfs2_sbstats_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_sbstats</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">gfs2_delete_debugfs_file</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_delete_debugfs_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_glocks</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_glocks</span><span class="p">);</span>
			<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_glocks</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_glstats</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_glstats</span><span class="p">);</span>
			<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_glstats</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_sbstats</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_sbstats</span><span class="p">);</span>
			<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_sbstats</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">);</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_register_debugfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gfs2_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;gfs2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">gfs2_root</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_unregister_debugfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">gfs2_root</span><span class="p">);</span>
	<span class="n">gfs2_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
