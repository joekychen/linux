<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › gfs2 › recovery.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>recovery.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) Sistina Software, Inc.  1997-2003 All rights reserved.</span>
<span class="cm"> * Copyright (C) 2004-2006 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This copyrighted material is made available to anyone wishing to use,</span>
<span class="cm"> * modify, copy, or redistribute it subject to the terms and conditions</span>
<span class="cm"> * of the GNU General Public License version 2.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/gfs2_ondisk.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>

<span class="cp">#include &quot;gfs2.h&quot;</span>
<span class="cp">#include &quot;incore.h&quot;</span>
<span class="cp">#include &quot;bmap.h&quot;</span>
<span class="cp">#include &quot;glock.h&quot;</span>
<span class="cp">#include &quot;glops.h&quot;</span>
<span class="cp">#include &quot;lops.h&quot;</span>
<span class="cp">#include &quot;meta_io.h&quot;</span>
<span class="cp">#include &quot;recovery.h&quot;</span>
<span class="cp">#include &quot;super.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;dir.h&quot;</span>

<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">gfs_recovery_wq</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">gfs2_replay_read_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blk</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">**</span><span class="n">bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dblock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">extlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_extent_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">extlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dblock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">bh</span> <span class="o">=</span> <span class="n">gfs2_meta_ra</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="n">extlen</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_revoke_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">blkno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">where</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_revoke_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_revoke_replay</span> <span class="o">*</span><span class="n">rr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">rr_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">rr_blkno</span> <span class="o">==</span> <span class="n">blkno</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rr</span><span class="o">-&gt;</span><span class="n">rr_where</span> <span class="o">=</span> <span class="n">where</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_revoke_replay</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rr</span><span class="o">-&gt;</span><span class="n">rr_blkno</span> <span class="o">=</span> <span class="n">blkno</span><span class="p">;</span>
	<span class="n">rr</span><span class="o">-&gt;</span><span class="n">rr_where</span> <span class="o">=</span> <span class="n">where</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">rr_list</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_revoke_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">blkno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">where</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_revoke_replay</span> <span class="o">*</span><span class="n">rr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wrap</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">revoke</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_revoke_list</span><span class="p">,</span> <span class="n">rr_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">rr_blkno</span> <span class="o">==</span> <span class="n">blkno</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wrap</span> <span class="o">=</span> <span class="p">(</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">rr_where</span> <span class="o">&lt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_replay_tail</span><span class="p">);</span>
	<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_replay_tail</span> <span class="o">&lt;</span> <span class="n">where</span><span class="p">);</span>
	<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">where</span> <span class="o">&lt;</span> <span class="n">rr</span><span class="o">-&gt;</span><span class="n">rr_where</span><span class="p">);</span>
	<span class="n">revoke</span> <span class="o">=</span> <span class="p">(</span><span class="n">wrap</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">a</span> <span class="o">||</span> <span class="n">b</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">b</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">revoke</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_revoke_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_revoke_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_revoke_replay</span> <span class="o">*</span><span class="n">rr</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_revoke_replay</span><span class="p">,</span> <span class="n">rr_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">rr_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_log_header_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="o">*</span><span class="n">lh</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_log_header</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">lh_header</span><span class="p">.</span><span class="n">mh_magic</span> <span class="o">!=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_MAGIC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">str</span><span class="o">-&gt;</span><span class="n">lh_header</span><span class="p">.</span><span class="n">mh_type</span> <span class="o">!=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_METATYPE_LH</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">lh_sequence</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">lh_sequence</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">lh_flags</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">lh_flags</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">lh_tail</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">lh_tail</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">lh_blkno</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">lh_blkno</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">lh_hash</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">lh_hash</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * get_log_header - read the log header for a given segment</span>
<span class="cm"> * @jd: the journal</span>
<span class="cm"> * @blk: the block to look at</span>
<span class="cm"> * @lh: the log header to return</span>
<span class="cm"> *</span>
<span class="cm"> * Read the log header for a given segement in a given journal.  Do a few</span>
<span class="cm"> * sanity checks on it.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success,</span>
<span class="cm"> *          1 if the header was invalid or incomplete,</span>
<span class="cm"> *          errno on error</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_log_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blk</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">lh</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">nothing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hash</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_replay_read_block</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">hash</span> <span class="o">=</span> <span class="n">crc32_le</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_log_header</span><span class="p">)</span> <span class="o">-</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">hash</span> <span class="o">=</span> <span class="n">crc32_le</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nothing</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nothing</span><span class="p">));</span>
	<span class="n">hash</span> <span class="o">^=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_log_header_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lh</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="n">lh</span><span class="p">.</span><span class="n">lh_blkno</span> <span class="o">!=</span> <span class="n">blk</span> <span class="o">||</span> <span class="n">lh</span><span class="p">.</span><span class="n">lh_hash</span> <span class="o">!=</span> <span class="n">hash</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">lh</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * find_good_lh - find a good log header</span>
<span class="cm"> * @jd: the journal</span>
<span class="cm"> * @blk: the segment to start searching from</span>
<span class="cm"> * @lh: the log header to fill in</span>
<span class="cm"> * @forward: if true search forward in the log, else search backward</span>
<span class="cm"> *</span>
<span class="cm"> * Call get_log_header() to get a log header for a segment, but if the</span>
<span class="cm"> * segment is bad, either scan forward or backward until we find a good one.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_good_lh</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">orig_blk</span> <span class="o">=</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">get_log_header</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++*</span><span class="n">blk</span> <span class="o">==</span> <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_blocks</span><span class="p">)</span>
			<span class="o">*</span><span class="n">blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">blk</span> <span class="o">==</span> <span class="n">orig_blk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">GFS2_I</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * jhead_scan - make sure we&#39;ve found the head of the log</span>
<span class="cm"> * @jd: the journal</span>
<span class="cm"> * @head: this is filled in with the log descriptor of the head</span>
<span class="cm"> *</span>
<span class="cm"> * At this point, seg and lh should be either the head of the log or just</span>
<span class="cm"> * before.  Scan forward until we find the head.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jhead_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blk</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">lh_blkno</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="n">lh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">blk</span> <span class="o">==</span> <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_blocks</span><span class="p">)</span>
			<span class="n">blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">get_log_header</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lh</span><span class="p">.</span><span class="n">lh_sequence</span> <span class="o">==</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">lh_sequence</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">GFS2_I</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lh</span><span class="p">.</span><span class="n">lh_sequence</span> <span class="o">&lt;</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">lh_sequence</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">lh</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_find_jhead - find the head of a log</span>
<span class="cm"> * @jd: the journal</span>
<span class="cm"> * @head: the log descriptor for the head of the log is returned here</span>
<span class="cm"> *</span>
<span class="cm"> * Do a binary search of a journal and find the valid log entry with the</span>
<span class="cm"> * highest sequence number.  (i.e. the log head)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_find_jhead</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="n">lh_1</span><span class="p">,</span> <span class="n">lh_m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">blk_1</span><span class="p">,</span> <span class="n">blk_2</span><span class="p">,</span> <span class="n">blk_m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">blk_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">blk_2</span> <span class="o">=</span> <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_blocks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">blk_m</span> <span class="o">=</span> <span class="p">(</span><span class="n">blk_1</span> <span class="o">+</span> <span class="n">blk_2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">find_good_lh</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lh_1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">find_good_lh</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk_m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lh_m</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blk_1</span> <span class="o">==</span> <span class="n">blk_m</span> <span class="o">||</span> <span class="n">blk_m</span> <span class="o">==</span> <span class="n">blk_2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lh_1</span><span class="p">.</span><span class="n">lh_sequence</span> <span class="o">&lt;=</span> <span class="n">lh_m</span><span class="p">.</span><span class="n">lh_sequence</span><span class="p">)</span>
			<span class="n">blk_1</span> <span class="o">=</span> <span class="n">blk_m</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">blk_2</span> <span class="o">=</span> <span class="n">blk_m</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">jhead_scan</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lh_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">lh_1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * foreach_descriptor - go through the active part of the log</span>
<span class="cm"> * @jd: the journal</span>
<span class="cm"> * @start: the first log header in the active region</span>
<span class="cm"> * @end: the last log header (don&#39;t process the contents of this entry))</span>
<span class="cm"> *</span>
<span class="cm"> * Call a given function once for every log descriptor in the active</span>
<span class="cm"> * portion of the log.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">foreach_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">end</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pass</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_log_descriptor</span> <span class="o">*</span><span class="n">ld</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_log_descriptor</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">__be64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_replay_read_block</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_meta_check</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bh</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ld</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_log_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_length</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_header</span><span class="p">.</span><span class="n">mh_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">GFS2_METATYPE_LH</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="n">lh</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">get_log_header</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lh</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gfs2_replay_incr_blk</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
				<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">GFS2_I</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">));</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gfs2_metatype_check</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="n">GFS2_METATYPE_LD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">lops_scan_elements</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">ld</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">length</span><span class="o">--</span><span class="p">)</span>
			<span class="n">gfs2_replay_incr_blk</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>

		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * clean_journal - mark a dirty journal as being clean</span>
<span class="cm"> * @sdp: the filesystem</span>
<span class="cm"> * @jd: the journal</span>
<span class="cm"> * @gl: the journal&#39;s glock</span>
<span class="cm"> * @head: the head journal to start from</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clean_journal</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lblock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_log_header</span> <span class="o">*</span><span class="n">lh</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="n">bh_map</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">b_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">b_blocknr</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">lblock</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">lh_blkno</span><span class="p">;</span>
	<span class="n">gfs2_replay_incr_blk</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lblock</span><span class="p">);</span>
	<span class="n">bh_map</span><span class="p">.</span><span class="n">b_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_blkbits</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_block_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">,</span> <span class="n">lblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh_map</span><span class="p">.</span><span class="n">b_blocknr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">sb_getblk</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="p">,</span> <span class="n">bh_map</span><span class="p">.</span><span class="n">b_blocknr</span><span class="p">);</span>
	<span class="n">lock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">);</span>
	<span class="n">set_buffer_uptodate</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">clear_buffer_dirty</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">unlock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>

	<span class="n">lh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_log_header</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_log_header</span><span class="p">));</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">lh_header</span><span class="p">.</span><span class="n">mh_magic</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_MAGIC</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">lh_header</span><span class="p">.</span><span class="n">mh_type</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_METATYPE_LH</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">lh_header</span><span class="p">.</span><span class="n">__pad0</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">lh_header</span><span class="p">.</span><span class="n">mh_format</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_FORMAT_LH</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">lh_header</span><span class="p">.</span><span class="n">mh_jid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jdesc</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">lh_sequence</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">lh_sequence</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">lh_flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_LOG_HEAD_UNMOUNT</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">lh_blkno</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">lblock</span><span class="p">);</span>
	<span class="n">hash</span> <span class="o">=</span> <span class="n">gfs2_disk_hash</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">lh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_log_header</span><span class="p">));</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">lh_hash</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>

	<span class="n">set_buffer_dirty</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_dirty_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
		<span class="n">gfs2_io_error_bh</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_recovery_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">jid</span><span class="p">,</span>
                               <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">env_jid</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">env_status</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">envp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">env_jid</span><span class="p">,</span> <span class="n">env_status</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">lm_lockstruct</span> <span class="o">*</span><span class="n">ls</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_lockstruct</span><span class="p">;</span>

        <span class="n">ls</span><span class="o">-&gt;</span><span class="n">ls_recover_jid_done</span> <span class="o">=</span> <span class="n">jid</span><span class="p">;</span>
        <span class="n">ls</span><span class="o">-&gt;</span><span class="n">ls_recover_jid_status</span> <span class="o">=</span> <span class="n">message</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">env_jid</span><span class="p">,</span> <span class="s">&quot;JID=%d&quot;</span><span class="p">,</span> <span class="n">jid</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">env_status</span><span class="p">,</span> <span class="s">&quot;RECOVERY=%s&quot;</span><span class="p">,</span>
		<span class="n">message</span> <span class="o">==</span> <span class="n">LM_RD_SUCCESS</span> <span class="o">?</span> <span class="s">&quot;Done&quot;</span> <span class="o">:</span> <span class="s">&quot;Failed&quot;</span><span class="p">);</span>
        <span class="n">kobject_uevent_env</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_lockstruct</span><span class="p">.</span><span class="n">ls_ops</span><span class="o">-&gt;</span><span class="n">lm_recovery_result</span><span class="p">)</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_lockstruct</span><span class="p">.</span><span class="n">ls_ops</span><span class="o">-&gt;</span><span class="n">lm_recovery_result</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_recover_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_jdesc</span><span class="p">,</span> <span class="n">jd_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">j_gh</span><span class="p">,</span> <span class="n">ji_gh</span><span class="p">,</span> <span class="n">t_gh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ro</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pass</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">jlocked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_spectator</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span> <span class="o">!=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_lockstruct</span><span class="p">.</span><span class="n">ls_jid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;jid=%u: Trying to acquire journal lock...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">);</span>
		<span class="n">jlocked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Acquire the journal lock so we can do recovery */</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_num</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gfs2_journal_glops</span><span class="p">,</span>
					  <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span>
					  <span class="n">LM_FLAG_NOEXP</span> <span class="o">|</span> <span class="n">LM_FLAG_TRY</span> <span class="o">|</span> <span class="n">GL_NOCACHE</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">j_gh</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">GLR_TRYFAILED</span>:
			<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;jid=%u: Busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">};</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span>
					   <span class="n">LM_FLAG_NOEXP</span> <span class="o">|</span> <span class="n">GL_NOCACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ji_gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_gunlock_j</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;jid=%u, already locked for use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;jid=%u: Looking at journal...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_jdesc_check</span><span class="p">(</span><span class="n">jd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_gunlock_ji</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_find_jhead</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_gunlock_ji</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">lh_flags</span> <span class="o">&amp;</span> <span class="n">GFS2_LOG_HEAD_UNMOUNT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;jid=%u: Acquiring the transaction lock...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">);</span>

		<span class="n">t</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

		<span class="cm">/* Acquire a shared hold on the transaction lock */</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_trans_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span>
					   <span class="n">LM_FLAG_NOEXP</span> <span class="o">|</span> <span class="n">LM_FLAG_PRIORITY</span> <span class="o">|</span>
					   <span class="n">GL_NOCACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t_gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_gunlock_ji</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SDF_RORECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ro</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SDF_JOURNAL_CHECKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SDF_JOURNAL_LIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">))</span>
				<span class="n">ro</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* check if device itself is read-only */</span>
				<span class="n">ro</span> <span class="o">=</span> <span class="n">bdev_read_only</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ro</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;recovery required on &quot;</span>
						<span class="s">&quot;read-only filesystem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;write access will be &quot;</span>
						<span class="s">&quot;enabled during recovery.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fs_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;jid=%u: Can&#39;t replay: read-only block &quot;</span>
				<span class="s">&quot;device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_gunlock_tr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;jid=%u: Replaying journal...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">pass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pass</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">pass</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lops_before_scan</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">foreach_descriptor</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">head</span><span class="p">.</span><span class="n">lh_tail</span><span class="p">,</span>
						   <span class="n">head</span><span class="p">.</span><span class="n">lh_blkno</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
			<span class="n">lops_after_scan</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail_gunlock_tr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">clean_journal</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_gunlock_tr</span><span class="p">;</span>

		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_gh</span><span class="p">);</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;jid=%u: Journal replayed in %lus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gfs2_recovery_done</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">,</span> <span class="n">LM_RD_SUCCESS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jlocked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ji_gh</span><span class="p">);</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">j_gh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;jid=%u: Done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="nl">fail_gunlock_tr:</span>
	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_gh</span><span class="p">);</span>
<span class="nl">fail_gunlock_ji:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jlocked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ji_gh</span><span class="p">);</span>
<span class="nl">fail_gunlock_j:</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">j_gh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;jid=%u: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">,</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Failed&quot;</span> <span class="o">:</span> <span class="s">&quot;Done&quot;</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_recover_error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">gfs2_recovery_done</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">,</span> <span class="n">LM_RD_GAVEUP</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">JDF_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_flags</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
	<span class="n">wake_up_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_flags</span><span class="p">,</span> <span class="n">JDF_RECOVERY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_recovery_wait</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">word</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_recover_journal</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span> <span class="n">bool</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">JDF_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* we have JDF_RECOVERY, queue should always succeed */</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">queue_work</span><span class="p">(</span><span class="n">gfs_recovery_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_work</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span>
		<span class="n">wait_on_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_flags</span><span class="p">,</span> <span class="n">JDF_RECOVERY</span><span class="p">,</span> <span class="n">gfs2_recovery_wait</span><span class="p">,</span>
			    <span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wait</span> <span class="o">?</span> <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_recover_error</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
