<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › gfs2 › lops.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>lops.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) Sistina Software, Inc.  1997-2003 All rights reserved.</span>
<span class="cm"> * Copyright (C) 2004-2006 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This copyrighted material is made available to anyone wishing to use,</span>
<span class="cm"> * modify, copy, or redistribute it subject to the terms and conditions</span>
<span class="cm"> * of the GNU General Public License version 2.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/mempool.h&gt;</span>
<span class="cp">#include &lt;linux/gfs2_ondisk.h&gt;</span>
<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>

<span class="cp">#include &quot;gfs2.h&quot;</span>
<span class="cp">#include &quot;incore.h&quot;</span>
<span class="cp">#include &quot;inode.h&quot;</span>
<span class="cp">#include &quot;glock.h&quot;</span>
<span class="cp">#include &quot;log.h&quot;</span>
<span class="cp">#include &quot;lops.h&quot;</span>
<span class="cp">#include &quot;meta_io.h&quot;</span>
<span class="cp">#include &quot;recovery.h&quot;</span>
<span class="cp">#include &quot;rgrp.h&quot;</span>
<span class="cp">#include &quot;trans.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;trace_gfs2.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_pin - Pin a buffer in memory</span>
<span class="cm"> * @sdp: The superblock</span>
<span class="cm"> * @bh: The buffer to be pinned</span>
<span class="cm"> *</span>
<span class="cm"> * The log lock must be held when calling this function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_bufdata</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">journal_info</span><span class="p">);</span>

	<span class="n">clear_buffer_dirty</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_set_buffer_pinned</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
		<span class="n">gfs2_assert_withdraw</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_uptodate</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
		<span class="n">gfs2_io_error_bh</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
	<span class="n">bd</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_private</span><span class="p">;</span>
	<span class="cm">/* If this buffer is in the AIL and it has already been written</span>
<span class="cm">	 * to in-place disk block, remove it from the AIL.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_ail_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_ail</span><span class="p">)</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_ail_st_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_ail</span><span class="o">-&gt;</span><span class="n">ai_ail2_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_ail_lock</span><span class="p">);</span>
	<span class="n">get_bh</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_pinned</span><span class="p">);</span>
	<span class="n">trace_gfs2_pin</span><span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">buffer_is_rgrp</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_bufdata</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">.</span><span class="n">ln_type</span> <span class="o">==</span> <span class="n">LM_TYPE_RGRP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">maybe_release_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_bufdata</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_gl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_sbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_object</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span> <span class="o">-</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_name</span><span class="p">.</span><span class="n">ln_number</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_bitmap</span> <span class="o">*</span><span class="n">bi</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_bits</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_clone</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_discard</span><span class="p">)</span>
		<span class="n">gfs2_rgrp_send_discards</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data0</span><span class="p">,</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_clone</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span><span class="p">,</span>
	       <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_offset</span><span class="p">,</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_len</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">GBF_FULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free_clone</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_unpin - Unpin a buffer</span>
<span class="cm"> * @sdp: the filesystem the buffer belongs to</span>
<span class="cm"> * @bh: The buffer to unpin</span>
<span class="cm"> * @ai:</span>
<span class="cm"> * @flags: The inode dirty flags</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_unpin</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">gfs2_ail</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_bufdata</span> <span class="o">*</span><span class="n">bd</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_private</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">buffer_uptodate</span><span class="p">(</span><span class="n">bh</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">buffer_pinned</span><span class="p">(</span><span class="n">bh</span><span class="p">));</span>

	<span class="n">lock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">mark_buffer_dirty</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">clear_buffer_pinned</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_is_rgrp</span><span class="p">(</span><span class="n">bd</span><span class="p">))</span>
		<span class="n">maybe_release_space</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_ail_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_ail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_ail_st_list</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_gl</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_ail_gl_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ail_list</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_ail_count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_ail</span> <span class="o">=</span> <span class="n">ai</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_ail_st_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">ai_ail1_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_ail_lock</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_LFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">trace_gfs2_pin</span><span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">unlock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_pinned</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_log_incr_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_flush_head</span> <span class="o">==</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_tail</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_flush_head</span> <span class="o">!=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_head</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_flush_head</span> <span class="o">==</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jdesc</span><span class="o">-&gt;</span><span class="n">jd_blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_flush_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_flush_wrapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">gfs2_log_bmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lbn</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_flush_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_journal_extent</span> <span class="o">*</span><span class="n">je</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">block</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">je</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jdesc</span><span class="o">-&gt;</span><span class="n">extent_list</span><span class="p">,</span> <span class="n">extent_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lbn</span> <span class="o">&gt;=</span> <span class="n">je</span><span class="o">-&gt;</span><span class="n">lblock</span> <span class="o">&amp;&amp;</span> <span class="n">lbn</span> <span class="o">&lt;</span> <span class="n">je</span><span class="o">-&gt;</span><span class="n">lblock</span> <span class="o">+</span> <span class="n">je</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">block</span> <span class="o">=</span> <span class="n">je</span><span class="o">-&gt;</span><span class="n">dblock</span> <span class="o">+</span> <span class="n">lbn</span> <span class="o">-</span> <span class="n">je</span><span class="o">-&gt;</span><span class="n">lblock</span><span class="p">;</span>
			<span class="n">gfs2_log_incr_head</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">block</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_end_log_write_bh - end log write of pagecache data with buffers</span>
<span class="cm"> * @sdp: The superblock</span>
<span class="cm"> * @bvec: The bio_vec</span>
<span class="cm"> * @error: The i/o status</span>
<span class="cm"> *</span>
<span class="cm"> * This finds the relavent buffers and unlocks then and sets the</span>
<span class="cm"> * error flag according to the status of the i/o request. This is</span>
<span class="cm"> * used when the log is writing data which has an in-place version</span>
<span class="cm"> * that is pinned in the pagecache.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_end_log_write_bh</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bh_offset</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">)</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_this_page</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="n">set_buffer_write_io_error</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">unlock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_this_page</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">;</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">bh</span> <span class="o">&amp;&amp;</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_end_log_write - end of i/o to the log</span>
<span class="cm"> * @bio: The bio</span>
<span class="cm"> * @error: Status of i/o request</span>
<span class="cm"> *</span>
<span class="cm"> * Each bio_vec contains either data from the pagecache or data</span>
<span class="cm"> * relating to the log itself. Here we iterate over the bio_vec</span>
<span class="cm"> * array, processing both kinds of data.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_end_log_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">fs_err</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;Error %d writing to log</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bio_for_each_segment</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page_has_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
			<span class="n">gfs2_end_log_write_bh</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bvec</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mempool_free</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">gfs2_page_pool</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_in_flight</span><span class="p">))</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_flush_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_log_flush_bio - Submit any pending log bio</span>
<span class="cm"> * @sdp: The superblock</span>
<span class="cm"> * @rw: The rw flags</span>
<span class="cm"> *</span>
<span class="cm"> * Submit any pending part-built or full bio to the block device. If</span>
<span class="cm"> * there is no pending bio, then this is a no-op.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_log_flush_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_bio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_in_flight</span><span class="p">);</span>
		<span class="n">submit_bio</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_bio</span><span class="p">);</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_log_alloc_bio - Allocate a new bio for log writing</span>
<span class="cm"> * @sdp: The superblock</span>
<span class="cm"> * @blkno: The next device block number we want to write to</span>
<span class="cm"> *</span>
<span class="cm"> * This should never be called when there is a cached bio in the</span>
<span class="cm"> * super block. When it returns, there will be a cached bio in the</span>
<span class="cm"> * super block which will have as many bio_vecs as the device is</span>
<span class="cm"> * happy to handle.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: Newly allocated bio</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="nf">gfs2_log_alloc_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">blkno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">nrvecs</span> <span class="o">=</span> <span class="n">bio_get_nr_vecs</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_bio</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_alloc</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">nrvecs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">bio</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">nrvecs</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">nrvecs</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1U</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">blkno</span> <span class="o">*</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">gfs2_end_log_write</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">sdp</span><span class="p">;</span>

	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bio</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_log_get_bio - Get cached log bio, or allocate a new one</span>
<span class="cm"> * @sdp: The superblock</span>
<span class="cm"> * @blkno: The device block number we want to write to</span>
<span class="cm"> *</span>
<span class="cm"> * If there is a cached bio, then if the next block number is sequential</span>
<span class="cm"> * with the previous one, return it, otherwise flush the bio to the</span>
<span class="cm"> * device. If there is not a cached bio, or we just flushed it, then</span>
<span class="cm"> * allocate a new one.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: The bio to use for log writes</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="nf">gfs2_log_get_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">blkno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_bio</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">nblk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nblk</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">bio_sectors</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
		<span class="n">nblk</span> <span class="o">&gt;&gt;=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_fsb2bb_shift</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blkno</span> <span class="o">==</span> <span class="n">nblk</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">bio</span><span class="p">;</span>
		<span class="n">gfs2_log_flush_bio</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">gfs2_log_alloc_bio</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">blkno</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * gfs2_log_write - write to log</span>
<span class="cm"> * @sdp: the filesystem</span>
<span class="cm"> * @page: the page to write</span>
<span class="cm"> * @size: the size of the data to write</span>
<span class="cm"> * @offset: the offset within the page </span>
<span class="cm"> *</span>
<span class="cm"> * Try and add the page segment to the current bio. If that fails,</span>
<span class="cm"> * submit the current bio to the device and create a new one, and</span>
<span class="cm"> * then add the page segment to that.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_log_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">blkno</span> <span class="o">=</span> <span class="n">gfs2_log_bmap</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">bio</span> <span class="o">=</span> <span class="n">gfs2_log_get_bio</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">blkno</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bio_add_page</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_log_flush_bio</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">);</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">gfs2_log_alloc_bio</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">blkno</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">bio_add_page</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_log_write_bh - write a buffer&#39;s content to the log</span>
<span class="cm"> * @sdp: The super block</span>
<span class="cm"> * @bh: The buffer pointing to the in-place location</span>
<span class="cm"> * </span>
<span class="cm"> * This writes the content of the buffer to the next available location</span>
<span class="cm"> * in the log. The buffer will be unlocked once the i/o to the log has</span>
<span class="cm"> * completed.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_log_write_bh</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gfs2_log_write</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_page</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">,</span> <span class="n">bh_offset</span><span class="p">(</span><span class="n">bh</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_log_write_page - write one block stored in a page, into the log</span>
<span class="cm"> * @sdp: The superblock</span>
<span class="cm"> * @page: The struct page</span>
<span class="cm"> *</span>
<span class="cm"> * This writes the first block-sized part of the page into the log. Note</span>
<span class="cm"> * that the page must have been allocated from the gfs2_page_pool mempool</span>
<span class="cm"> * and that after this has been called, ownership has been transferred and</span>
<span class="cm"> * the page may be freed at any time.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_log_write_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="p">;</span>
	<span class="n">gfs2_log_write</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">gfs2_get_log_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ld_type</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">ld_length</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ld_data1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">gfs2_page_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_log_descriptor</span> <span class="o">*</span><span class="n">ld</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">clear_page</span><span class="p">(</span><span class="n">ld</span><span class="p">);</span>
	<span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_header</span><span class="p">.</span><span class="n">mh_magic</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_MAGIC</span><span class="p">);</span>
	<span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_header</span><span class="p">.</span><span class="n">mh_type</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_METATYPE_LD</span><span class="p">);</span>
	<span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_header</span><span class="p">.</span><span class="n">mh_format</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_FORMAT_LD</span><span class="p">);</span>
	<span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_type</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ld_type</span><span class="p">);</span>
	<span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ld_length</span><span class="p">);</span>
	<span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_data1</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ld_data1</span><span class="p">);</span>
	<span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_data2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">buf_lo_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_bufdata</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_meta_header</span> <span class="o">*</span><span class="n">mh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_trans</span> <span class="o">*</span><span class="n">tr</span><span class="p">;</span>

	<span class="n">lock_buffer</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">);</span>
	<span class="n">gfs2_log_lock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="n">tr</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">journal_info</span><span class="p">;</span>
	<span class="n">tr</span><span class="o">-&gt;</span><span class="n">tr_touched</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_list</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_LFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_DIRTY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">gfs2_meta_check</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">);</span>
	<span class="n">gfs2_pin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">);</span>
	<span class="n">mh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="n">mh</span><span class="o">-&gt;</span><span class="n">__pad0</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">mh</span><span class="o">-&gt;</span><span class="n">mh_jid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jdesc</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">);</span>
	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_num_buf</span><span class="o">++</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_le_buf</span><span class="p">);</span>
	<span class="n">tr</span><span class="o">-&gt;</span><span class="n">tr_num_buf_new</span><span class="o">++</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">gfs2_log_unlock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="n">unlock_buffer</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_check_magic</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">clear_buffer_escaped</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_page</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">kaddr</span> <span class="o">+</span> <span class="n">bh_offset</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_MAGIC</span><span class="p">))</span>
		<span class="n">set_buffer_escaped</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">kaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_before_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">blist</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">is_databuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_log_descriptor</span> <span class="o">*</span><span class="n">ld</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_bufdata</span> <span class="o">*</span><span class="n">bd1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">bd2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">gfs2_log_lock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="n">bd1</span> <span class="o">=</span> <span class="n">bd2</span> <span class="o">=</span> <span class="n">list_prepare_entry</span><span class="p">(</span><span class="n">bd1</span><span class="p">,</span> <span class="n">blist</span><span class="p">,</span> <span class="n">bd_list</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">)</span>
			<span class="n">num</span> <span class="o">=</span> <span class="n">limit</span><span class="p">;</span>
		<span class="n">gfs2_log_unlock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">gfs2_get_log_desc</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">GFS2_LOG_DESC_METADATA</span><span class="p">,</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="n">ld</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">gfs2_log_lock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">ld</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each_entry_continue</span><span class="p">(</span><span class="n">bd1</span><span class="p">,</span> <span class="n">blist</span><span class="p">,</span> <span class="n">bd_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">bd1</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_databuf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gfs2_check_magic</span><span class="p">(</span><span class="n">bd1</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">);</span>
				<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">buffer_escaped</span><span class="p">(</span><span class="n">bd1</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gfs2_log_unlock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
		<span class="n">gfs2_log_write_page</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="n">gfs2_log_lock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>

		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each_entry_continue</span><span class="p">(</span><span class="n">bd2</span><span class="p">,</span> <span class="n">blist</span><span class="p">,</span> <span class="n">bd_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">get_bh</span><span class="p">(</span><span class="n">bd2</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">);</span>
			<span class="n">gfs2_log_unlock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
			<span class="n">lock_buffer</span><span class="p">(</span><span class="n">bd2</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">buffer_escaped</span><span class="p">(</span><span class="n">bd2</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">;</span>
				<span class="n">page</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">gfs2_page_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
				<span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">bd2</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="o">-&gt;</span><span class="n">b_page</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">kaddr</span> <span class="o">+</span> <span class="n">bh_offset</span><span class="p">(</span><span class="n">bd2</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">),</span>
				       <span class="n">bd2</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">);</span>
				<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">kaddr</span><span class="p">);</span>
				<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">clear_buffer_escaped</span><span class="p">(</span><span class="n">bd2</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">);</span>
				<span class="n">unlock_buffer</span><span class="p">(</span><span class="n">bd2</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">);</span>
				<span class="n">brelse</span><span class="p">(</span><span class="n">bd2</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">);</span>
				<span class="n">gfs2_log_write_page</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">gfs2_log_write_bh</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bd2</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">gfs2_log_lock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">total</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">);</span>
		<span class="n">total</span> <span class="o">-=</span> <span class="n">num</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gfs2_log_unlock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">buf_lo_before_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">buf_limit</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span> <span class="cm">/* 503 for 4k blocks */</span>

	<span class="n">gfs2_before_commit</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_num_buf</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_le_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">buf_lo_after_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_ail</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_le_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_bufdata</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_bufdata</span><span class="p">,</span> <span class="n">bd_list</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_list</span><span class="p">);</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_num_buf</span><span class="o">--</span><span class="p">;</span>

		<span class="n">gfs2_unpin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">,</span> <span class="n">ai</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_num_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">buf_lo_before_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pass</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_found_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_replayed_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">buf_lo_scan_elements</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">gfs2_log_descriptor</span> <span class="o">*</span><span class="n">ld</span><span class="p">,</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">pass</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blks</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_data1</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh_log</span><span class="p">,</span> <span class="o">*</span><span class="n">bh_ip</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">blkno</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_type</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GFS2_LOG_DESC_METADATA</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">gfs2_replay_incr_blk</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">blks</span><span class="p">;</span> <span class="n">gfs2_replay_incr_blk</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">),</span> <span class="n">blks</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blkno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>

		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_found_blocks</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_revoke_check</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">blkno</span><span class="p">,</span> <span class="n">start</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_replay_read_block</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh_log</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">bh_ip</span> <span class="o">=</span> <span class="n">gfs2_meta_new</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">blkno</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bh_ip</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">bh_log</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">bh_log</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_meta_check</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bh_ip</span><span class="p">))</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mark_buffer_dirty</span><span class="p">(</span><span class="n">bh_ip</span><span class="p">);</span>

		<span class="n">brelse</span><span class="p">(</span><span class="n">bh_log</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh_ip</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_replayed_blocks</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">buf_lo_after_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pass</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_meta_sync</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">gfs2_meta_sync</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">);</span>

	<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;jid=%u: Replayed %u of %u blocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	        <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_replayed_blocks</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_found_blocks</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">revoke_lo_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_bufdata</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_gl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_trans</span> <span class="o">*</span><span class="n">tr</span><span class="p">;</span>

	<span class="n">tr</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">journal_info</span><span class="p">;</span>
	<span class="n">tr</span><span class="o">-&gt;</span><span class="n">tr_touched</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tr</span><span class="o">-&gt;</span><span class="n">tr_num_revoke</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_num_revoke</span><span class="o">++</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_revokes</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_LFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_le_revoke</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">revoke_lo_before_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_log_descriptor</span> <span class="o">*</span><span class="n">ld</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_meta_header</span> <span class="o">*</span><span class="n">mh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_le_revoke</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_bufdata</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_num_revoke</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">gfs2_struct2blk</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_num_revoke</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">gfs2_get_log_desc</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">GFS2_LOG_DESC_REVOKE</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_num_revoke</span><span class="p">);</span>
	<span class="n">ld</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_log_descriptor</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">bd_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_num_revoke</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">gfs2_log_write_page</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">gfs2_page_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
			<span class="n">mh</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">clear_page</span><span class="p">(</span><span class="n">mh</span><span class="p">);</span>
			<span class="n">mh</span><span class="o">-&gt;</span><span class="n">mh_magic</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_MAGIC</span><span class="p">);</span>
			<span class="n">mh</span><span class="o">-&gt;</span><span class="n">mh_type</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_METATYPE_LB</span><span class="p">);</span>
			<span class="n">mh</span><span class="o">-&gt;</span><span class="n">mh_format</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_FORMAT_LB</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_blkno</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">gfs2_assert_withdraw</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_num_revoke</span><span class="p">);</span>

	<span class="n">gfs2_log_write_page</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">revoke_lo_after_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_ail</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_le_revoke</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_bufdata</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_bufdata</span><span class="p">,</span> <span class="n">bd_list</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_list</span><span class="p">);</span>
		<span class="n">gl</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_gl</span><span class="p">;</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_revokes</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_LFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">gfs2_bufdata_cachep</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">revoke_lo_before_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pass</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_found_revokes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_replay_tail</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">lh_tail</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">revoke_lo_scan_elements</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">gfs2_log_descriptor</span> <span class="o">*</span><span class="n">ld</span><span class="p">,</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">pass</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blks</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_length</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">revokes</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_data1</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">blkno</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_type</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GFS2_LOG_DESC_REVOKE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_log_descriptor</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">blks</span><span class="p">;</span> <span class="n">gfs2_replay_incr_blk</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">),</span> <span class="n">blks</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_replay_read_block</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span>
			<span class="n">gfs2_metatype_check</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="n">GFS2_METATYPE_LB</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blkno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_revoke_add</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">blkno</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_found_revokes</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">revokes</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_meta_header</span><span class="p">);</span>
		<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">revoke_lo_after_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pass</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_revoke_clean</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;jid=%u: Found %u revoke tags</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	        <span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_found_revokes</span><span class="p">);</span>

	<span class="n">gfs2_revoke_clean</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * databuf_lo_add - Add a databuf to the transaction.</span>
<span class="cm"> *</span>
<span class="cm"> * This is used in two distinct cases:</span>
<span class="cm"> * i) In ordered write mode</span>
<span class="cm"> *    We put the data buffer on a list so that we can ensure that its</span>
<span class="cm"> *    synced to disk at the right time</span>
<span class="cm"> * ii) In journaled data mode</span>
<span class="cm"> *    We need to journal the data block in the same way as metadata in</span>
<span class="cm"> *    the functions above. The difference is that here we have a tag</span>
<span class="cm"> *    which is two __be64&#39;s being the block number (as per meta data)</span>
<span class="cm"> *    and a flag which says whether the data block needs escaping or</span>
<span class="cm"> *    not. This means we need a new log entry for each 251 or so data</span>
<span class="cm"> *    blocks, which isn&#39;t an enormous overhead but twice as much as</span>
<span class="cm"> *    for normal metadata blocks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">databuf_lo_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_bufdata</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_trans</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">journal_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="o">-&gt;</span><span class="n">b_page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">lock_buffer</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">);</span>
	<span class="n">gfs2_log_lock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tr</span><span class="p">)</span>
		<span class="n">tr</span><span class="o">-&gt;</span><span class="n">tr_touched</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_list</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_LFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">GLF_DIRTY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_is_jdata</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfs2_pin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">);</span>
		<span class="n">tr</span><span class="o">-&gt;</span><span class="n">tr_num_databuf_new</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_num_databuf</span><span class="o">++</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_le_databuf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_le_ordered</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">gfs2_log_unlock</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="n">unlock_buffer</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * databuf_lo_before_commit - Scan the data buffers, writing as we go</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">databuf_lo_before_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">buf_limit</span><span class="p">(</span><span class="n">sdp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">gfs2_before_commit</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_num_databuf</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_le_databuf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">databuf_lo_scan_elements</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">gfs2_log_descriptor</span> <span class="o">*</span><span class="n">ld</span><span class="p">,</span>
				    <span class="n">__be64</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pass</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blks</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_data1</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh_log</span><span class="p">,</span> <span class="o">*</span><span class="n">bh_ip</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">blkno</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">esc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ld_type</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GFS2_LOG_DESC_JDATA</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">gfs2_replay_incr_blk</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">blks</span><span class="p">;</span> <span class="n">gfs2_replay_incr_blk</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">),</span> <span class="n">blks</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blkno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>
		<span class="n">esc</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>

		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_found_blocks</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_revoke_check</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">blkno</span><span class="p">,</span> <span class="n">start</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_replay_read_block</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh_log</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">bh_ip</span> <span class="o">=</span> <span class="n">gfs2_meta_new</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">blkno</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bh_ip</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">bh_log</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">bh_log</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">);</span>

		<span class="cm">/* Unescape */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__be32</span> <span class="o">*</span><span class="n">eptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">bh_ip</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
			<span class="o">*</span><span class="n">eptr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_MAGIC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mark_buffer_dirty</span><span class="p">(</span><span class="n">bh_ip</span><span class="p">);</span>

		<span class="n">brelse</span><span class="p">(</span><span class="n">bh_log</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh_ip</span><span class="p">);</span>

		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_replayed_blocks</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME: sort out accounting for log blocks etc. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">databuf_lo_after_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pass</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_meta_sync</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* data sync? */</span>
	<span class="n">gfs2_meta_sync</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">);</span>

	<span class="n">fs_info</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;jid=%u: Replayed %u of %u data blocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_replayed_blocks</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_found_blocks</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">databuf_lo_after_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_ail</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_le_databuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_bufdata</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_bufdata</span><span class="p">,</span> <span class="n">bd_list</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_list</span><span class="p">);</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_num_databuf</span><span class="o">--</span><span class="p">;</span>
		<span class="n">gfs2_unpin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_bh</span><span class="p">,</span> <span class="n">ai</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">gfs2_assert_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_num_databuf</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_log_operations</span> <span class="n">gfs2_buf_lops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">lo_add</span> <span class="o">=</span> <span class="n">buf_lo_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_before_commit</span> <span class="o">=</span> <span class="n">buf_lo_before_commit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_after_commit</span> <span class="o">=</span> <span class="n">buf_lo_after_commit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_before_scan</span> <span class="o">=</span> <span class="n">buf_lo_before_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_scan_elements</span> <span class="o">=</span> <span class="n">buf_lo_scan_elements</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_after_scan</span> <span class="o">=</span> <span class="n">buf_lo_after_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_name</span> <span class="o">=</span> <span class="s">&quot;buf&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_log_operations</span> <span class="n">gfs2_revoke_lops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">lo_add</span> <span class="o">=</span> <span class="n">revoke_lo_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_before_commit</span> <span class="o">=</span> <span class="n">revoke_lo_before_commit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_after_commit</span> <span class="o">=</span> <span class="n">revoke_lo_after_commit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_before_scan</span> <span class="o">=</span> <span class="n">revoke_lo_before_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_scan_elements</span> <span class="o">=</span> <span class="n">revoke_lo_scan_elements</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_after_scan</span> <span class="o">=</span> <span class="n">revoke_lo_after_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_name</span> <span class="o">=</span> <span class="s">&quot;revoke&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_log_operations</span> <span class="n">gfs2_rg_lops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">lo_name</span> <span class="o">=</span> <span class="s">&quot;rg&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_log_operations</span> <span class="n">gfs2_databuf_lops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">lo_add</span> <span class="o">=</span> <span class="n">databuf_lo_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_before_commit</span> <span class="o">=</span> <span class="n">databuf_lo_before_commit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_after_commit</span> <span class="o">=</span> <span class="n">databuf_lo_after_commit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_scan_elements</span> <span class="o">=</span> <span class="n">databuf_lo_scan_elements</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_after_scan</span> <span class="o">=</span> <span class="n">databuf_lo_after_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lo_name</span> <span class="o">=</span> <span class="s">&quot;databuf&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_log_operations</span> <span class="o">*</span><span class="n">gfs2_log_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">gfs2_databuf_lops</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">gfs2_buf_lops</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">gfs2_rg_lops</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">gfs2_revoke_lops</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
