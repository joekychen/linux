<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › gfs2 › super.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>super.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) Sistina Software, Inc.  1997-2003 All rights reserved.</span>
<span class="cm"> * Copyright (C) 2004-2007 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This copyrighted material is made available to anyone wishing to use,</span>
<span class="cm"> * modify, copy, or redistribute it subject to the terms and conditions</span>
<span class="cm"> * of the GNU General Public License version 2.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/statfs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/gfs2_ondisk.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/writeback.h&gt;</span>
<span class="cp">#include &lt;linux/backing-dev.h&gt;</span>

<span class="cp">#include &quot;gfs2.h&quot;</span>
<span class="cp">#include &quot;incore.h&quot;</span>
<span class="cp">#include &quot;bmap.h&quot;</span>
<span class="cp">#include &quot;dir.h&quot;</span>
<span class="cp">#include &quot;glock.h&quot;</span>
<span class="cp">#include &quot;glops.h&quot;</span>
<span class="cp">#include &quot;inode.h&quot;</span>
<span class="cp">#include &quot;log.h&quot;</span>
<span class="cp">#include &quot;meta_io.h&quot;</span>
<span class="cp">#include &quot;quota.h&quot;</span>
<span class="cp">#include &quot;recovery.h&quot;</span>
<span class="cp">#include &quot;rgrp.h&quot;</span>
<span class="cp">#include &quot;super.h&quot;</span>
<span class="cp">#include &quot;trans.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;sys.h&quot;</span>
<span class="cp">#include &quot;xattr.h&quot;</span>

<span class="cp">#define args_neq(a1, a2, x) ((a1)-&gt;ar_##x != (a2)-&gt;ar_##x)</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">Opt_lockproto</span><span class="p">,</span>
	<span class="n">Opt_locktable</span><span class="p">,</span>
	<span class="n">Opt_hostdata</span><span class="p">,</span>
	<span class="n">Opt_spectator</span><span class="p">,</span>
	<span class="n">Opt_ignore_local_fs</span><span class="p">,</span>
	<span class="n">Opt_localflocks</span><span class="p">,</span>
	<span class="n">Opt_localcaching</span><span class="p">,</span>
	<span class="n">Opt_debug</span><span class="p">,</span>
	<span class="n">Opt_nodebug</span><span class="p">,</span>
	<span class="n">Opt_upgrade</span><span class="p">,</span>
	<span class="n">Opt_acl</span><span class="p">,</span>
	<span class="n">Opt_noacl</span><span class="p">,</span>
	<span class="n">Opt_quota_off</span><span class="p">,</span>
	<span class="n">Opt_quota_account</span><span class="p">,</span>
	<span class="n">Opt_quota_on</span><span class="p">,</span>
	<span class="n">Opt_quota</span><span class="p">,</span>
	<span class="n">Opt_noquota</span><span class="p">,</span>
	<span class="n">Opt_suiddir</span><span class="p">,</span>
	<span class="n">Opt_nosuiddir</span><span class="p">,</span>
	<span class="n">Opt_data_writeback</span><span class="p">,</span>
	<span class="n">Opt_data_ordered</span><span class="p">,</span>
	<span class="n">Opt_meta</span><span class="p">,</span>
	<span class="n">Opt_discard</span><span class="p">,</span>
	<span class="n">Opt_nodiscard</span><span class="p">,</span>
	<span class="n">Opt_commit</span><span class="p">,</span>
	<span class="n">Opt_err_withdraw</span><span class="p">,</span>
	<span class="n">Opt_err_panic</span><span class="p">,</span>
	<span class="n">Opt_statfs_quantum</span><span class="p">,</span>
	<span class="n">Opt_statfs_percent</span><span class="p">,</span>
	<span class="n">Opt_quota_quantum</span><span class="p">,</span>
	<span class="n">Opt_barrier</span><span class="p">,</span>
	<span class="n">Opt_nobarrier</span><span class="p">,</span>
	<span class="n">Opt_error</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">Opt_lockproto</span><span class="p">,</span> <span class="s">&quot;lockproto=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_locktable</span><span class="p">,</span> <span class="s">&quot;locktable=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_hostdata</span><span class="p">,</span> <span class="s">&quot;hostdata=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_spectator</span><span class="p">,</span> <span class="s">&quot;spectator&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_spectator</span><span class="p">,</span> <span class="s">&quot;norecovery&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_ignore_local_fs</span><span class="p">,</span> <span class="s">&quot;ignore_local_fs&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_localflocks</span><span class="p">,</span> <span class="s">&quot;localflocks&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_localcaching</span><span class="p">,</span> <span class="s">&quot;localcaching&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_debug</span><span class="p">,</span> <span class="s">&quot;debug&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nodebug</span><span class="p">,</span> <span class="s">&quot;nodebug&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_upgrade</span><span class="p">,</span> <span class="s">&quot;upgrade&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_acl</span><span class="p">,</span> <span class="s">&quot;acl&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noacl</span><span class="p">,</span> <span class="s">&quot;noacl&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_quota_off</span><span class="p">,</span> <span class="s">&quot;quota=off&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_quota_account</span><span class="p">,</span> <span class="s">&quot;quota=account&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_quota_on</span><span class="p">,</span> <span class="s">&quot;quota=on&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_quota</span><span class="p">,</span> <span class="s">&quot;quota&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noquota</span><span class="p">,</span> <span class="s">&quot;noquota&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_suiddir</span><span class="p">,</span> <span class="s">&quot;suiddir&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nosuiddir</span><span class="p">,</span> <span class="s">&quot;nosuiddir&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_writeback</span><span class="p">,</span> <span class="s">&quot;data=writeback&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_ordered</span><span class="p">,</span> <span class="s">&quot;data=ordered&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_meta</span><span class="p">,</span> <span class="s">&quot;meta&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_discard</span><span class="p">,</span> <span class="s">&quot;discard&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nodiscard</span><span class="p">,</span> <span class="s">&quot;nodiscard&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_commit</span><span class="p">,</span> <span class="s">&quot;commit=%d&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err_withdraw</span><span class="p">,</span> <span class="s">&quot;errors=withdraw&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err_panic</span><span class="p">,</span> <span class="s">&quot;errors=panic&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_statfs_quantum</span><span class="p">,</span> <span class="s">&quot;statfs_quantum=%d&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_statfs_percent</span><span class="p">,</span> <span class="s">&quot;statfs_percent=%d&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_quota_quantum</span><span class="p">,</span> <span class="s">&quot;quota_quantum=%d&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_barrier</span><span class="p">,</span> <span class="s">&quot;barrier&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nobarrier</span><span class="p">,</span> <span class="s">&quot;nobarrier&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_error</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_mount_args - Parse mount options</span>
<span class="cm"> * @args: The structure into which the parsed options will be written</span>
<span class="cm"> * @options: The options to parse</span>
<span class="cm"> *</span>
<span class="cm"> * Return: errno</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_mount_args</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">o</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">token</span><span class="p">;</span>
	<span class="n">substring_t</span> <span class="n">tmp</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="cm">/* Split the options into tokens with the &quot;,&quot; character and</span>
<span class="cm">	   process them */</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">o</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">o</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">Opt_lockproto</span>:
			<span class="n">match_strlcpy</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_lockproto</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				      <span class="n">GFS2_LOCKNAME_LEN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_locktable</span>:
			<span class="n">match_strlcpy</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_locktable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				      <span class="n">GFS2_LOCKNAME_LEN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_hostdata</span>:
			<span class="n">match_strlcpy</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_hostdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				      <span class="n">GFS2_LOCKNAME_LEN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_spectator</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_spectator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_ignore_local_fs</span>:
			<span class="cm">/* Retained for backwards compat only */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_localflocks</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_localflocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_localcaching</span>:
			<span class="cm">/* Retained for backwards compat only */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_debug</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_errors</span> <span class="o">==</span> <span class="n">GFS2_ERRORS_PANIC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;GFS2: -o debug and -o errors=panic &quot;</span>
				       <span class="s">&quot;are mutually exclusive.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nodebug</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_upgrade</span>:
			<span class="cm">/* Retained for backwards compat only */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_acl</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_posix_acl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noacl</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_posix_acl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_quota_off</span>:
		<span class="k">case</span> <span class="n">Opt_noquota</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_quota</span> <span class="o">=</span> <span class="n">GFS2_QUOTA_OFF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_quota_account</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_quota</span> <span class="o">=</span> <span class="n">GFS2_QUOTA_ACCOUNT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_quota_on</span>:
		<span class="k">case</span> <span class="n">Opt_quota</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_quota</span> <span class="o">=</span> <span class="n">GFS2_QUOTA_ON</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_suiddir</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_suiddir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nosuiddir</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_suiddir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_data_writeback</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_data</span> <span class="o">=</span> <span class="n">GFS2_DATA_WRITEBACK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_data_ordered</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_data</span> <span class="o">=</span> <span class="n">GFS2_DATA_ORDERED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_meta</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_meta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_discard</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_discard</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nodiscard</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_discard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_commit</span>:
			<span class="n">rv</span> <span class="o">=</span> <span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_commit</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">||</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_commit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;GFS2: commit mount option requires a positive numeric argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rv</span> <span class="o">?</span> <span class="n">rv</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_statfs_quantum</span>:
			<span class="n">rv</span> <span class="o">=</span> <span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_statfs_quantum</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">||</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_statfs_quantum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;GFS2: statfs_quantum mount option requires a non-negative numeric argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rv</span> <span class="o">?</span> <span class="n">rv</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_quota_quantum</span>:
			<span class="n">rv</span> <span class="o">=</span> <span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_quota_quantum</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">||</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_quota_quantum</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;GFS2: quota_quantum mount option requires a positive numeric argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rv</span> <span class="o">?</span> <span class="n">rv</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_statfs_percent</span>:
			<span class="n">rv</span> <span class="o">=</span> <span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_statfs_percent</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">||</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_statfs_percent</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_statfs_percent</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;statfs_percent mount option requires a numeric argument between 0 and 100</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rv</span> <span class="o">?</span> <span class="n">rv</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_err_withdraw</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_errors</span> <span class="o">=</span> <span class="n">GFS2_ERRORS_WITHDRAW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_err_panic</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_debug</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;GFS2: -o debug and -o errors=panic &quot;</span>
					<span class="s">&quot;are mutually exclusive.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_errors</span> <span class="o">=</span> <span class="n">GFS2_ERRORS_PANIC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_barrier</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_nobarrier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nobarrier</span>:
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_nobarrier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_error</span>:
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;GFS2: invalid mount option: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">o</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_jindex_free - Clear all the journal index information</span>
<span class="cm"> * @sdp: The GFS2 superblock</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_jindex_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">,</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_journal_extent</span> <span class="o">*</span><span class="n">jext</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jindex_spin</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jindex_list</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jindex_list</span><span class="p">);</span>
	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_journals</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jindex_spin</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">jd</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_jdesc</span><span class="p">,</span> <span class="n">jd_list</span><span class="p">);</span>
		<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">extent_list</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">jext</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">gfs2_journal_extent</span><span class="p">,</span>
					  <span class="n">extent_list</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jext</span><span class="o">-&gt;</span><span class="n">extent_list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">jext</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_list</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">jd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="nf">jdesc_find_i</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">jid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">jd_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_jid</span> <span class="o">==</span> <span class="n">jid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="n">jd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">jd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="nf">gfs2_jdesc_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">jid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jindex_spin</span><span class="p">);</span>
	<span class="n">jd</span> <span class="o">=</span> <span class="n">jdesc_find_i</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jindex_list</span><span class="p">,</span> <span class="n">jid</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jindex_spin</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">jd</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_jdesc_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_check_internal_file_size</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">,</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_blocks</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize_shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_write_alloc_required</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_make_fs_rw - Turn a Read-Only FS into a Read-Write one</span>
<span class="cm"> * @sdp: the filesystem</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_make_fs_rw</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jdesc</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">j_gl</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">t_gh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="n">head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_trans_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">j_gl</span><span class="o">-&gt;</span><span class="n">gl_ops</span><span class="o">-&gt;</span><span class="n">go_inval</span><span class="p">(</span><span class="n">j_gl</span><span class="p">,</span> <span class="n">DIO_METADATA</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_find_jhead</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jdesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">lh_flags</span> <span class="o">&amp;</span> <span class="n">GFS2_LOG_HEAD_UNMOUNT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfs2_consist</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Initialize some head of the log stuff  */</span>
	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_log_sequence</span> <span class="o">=</span> <span class="n">head</span><span class="p">.</span><span class="n">lh_sequence</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gfs2_log_pointers_init</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">head</span><span class="p">.</span><span class="n">lh_blkno</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_quota_init</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">SDF_JOURNAL_LIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">);</span>

	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_gh</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">t_gh</span><span class="p">.</span><span class="n">gh_flags</span> <span class="o">|=</span> <span class="n">GL_NOCACHE</span><span class="p">;</span>
	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_gh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_statfs_change_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_statfs_change</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_total</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">sc_total</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_free</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">sc_free</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_dinodes</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">sc_dinodes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_statfs_change_out</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_statfs_change</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">str</span><span class="o">-&gt;</span><span class="n">sc_total</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_total</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">sc_free</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_free</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">sc_dinodes</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_dinodes</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_statfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">m_ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">m_sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">l_ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sc_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">l_sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">m_bh</span><span class="p">,</span> <span class="o">*</span><span class="n">l_bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">m_ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span> <span class="n">GL_NOCACHE</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">m_ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_spectator</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>
		<span class="n">gfs2_statfs_change_in</span><span class="p">(</span><span class="n">m_sc</span><span class="p">,</span> <span class="n">m_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">l_ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l_bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_m_bh</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>
		<span class="n">gfs2_statfs_change_in</span><span class="p">(</span><span class="n">m_sc</span><span class="p">,</span> <span class="n">m_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>
		<span class="n">gfs2_statfs_change_in</span><span class="p">(</span><span class="n">l_sc</span><span class="p">,</span> <span class="n">l_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>

		<span class="n">brelse</span><span class="p">(</span><span class="n">l_bh</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out_m_bh:</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">m_bh</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_statfs_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="n">s64</span> <span class="n">total</span><span class="p">,</span> <span class="n">s64</span> <span class="n">free</span><span class="p">,</span>
			<span class="n">s64</span> <span class="n">dinodes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">l_ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sc_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">l_sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">m_sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">l_bh</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">l_ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">l_ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">l_bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>
	<span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_total</span> <span class="o">+=</span> <span class="n">total</span><span class="p">;</span>
	<span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_free</span> <span class="o">+=</span> <span class="n">free</span><span class="p">;</span>
	<span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_dinodes</span> <span class="o">+=</span> <span class="n">dinodes</span><span class="p">;</span>
	<span class="n">gfs2_statfs_change_out</span><span class="p">(</span><span class="n">l_sc</span><span class="p">,</span> <span class="n">l_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_statfs_percent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_free</span><span class="p">;</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">m_sc</span><span class="o">-&gt;</span><span class="n">sc_free</span> <span class="o">*</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_statfs_percent</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">y</span> <span class="o">||</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">y</span><span class="p">)</span>
			<span class="n">need_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>

	<span class="n">brelse</span><span class="p">(</span><span class="n">l_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_sync</span><span class="p">)</span>
		<span class="n">gfs2_wake_up_statfs</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">update_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">m_bh</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">l_bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">m_ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">l_ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sc_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">m_sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">l_sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_local</span><span class="p">;</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">l_ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">l_bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>
	<span class="n">m_sc</span><span class="o">-&gt;</span><span class="n">sc_total</span> <span class="o">+=</span> <span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_total</span><span class="p">;</span>
	<span class="n">m_sc</span><span class="o">-&gt;</span><span class="n">sc_free</span> <span class="o">+=</span> <span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_free</span><span class="p">;</span>
	<span class="n">m_sc</span><span class="o">-&gt;</span><span class="n">sc_dinodes</span> <span class="o">+=</span> <span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_dinodes</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">l_sc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_statfs_change</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">l_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">),</span>
	       <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_statfs_change</span><span class="p">));</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>

	<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">m_ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">m_bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_statfs_change_out</span><span class="p">(</span><span class="n">m_sc</span><span class="p">,</span> <span class="n">m_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gfs2_statfs_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">m_ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">l_ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sc_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">m_sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">l_sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">gh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">m_bh</span><span class="p">,</span> <span class="o">*</span><span class="n">l_bh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">m_ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span> <span class="n">GL_NOCACHE</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">m_ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>
	<span class="n">gfs2_statfs_change_in</span><span class="p">(</span><span class="n">m_sc</span><span class="p">,</span> <span class="n">m_bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_dinode</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_total</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_free</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_dinodes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_bh</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">l_ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l_bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_bh</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">RES_DINODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_bh2</span><span class="p">;</span>

	<span class="n">update_statfs</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">m_bh</span><span class="p">,</span> <span class="n">l_bh</span><span class="p">);</span>
	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_force_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>

<span class="nl">out_bh2:</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">l_bh</span><span class="p">);</span>
<span class="nl">out_bh:</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">m_bh</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">lfcc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">gh</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_lock_fs_check_clean - Stop all writes to the FS and check that all</span>
<span class="cm"> *                            journals are clean</span>
<span class="cm"> * @sdp: the file system</span>
<span class="cm"> * @state: the state to put the transaction lock into</span>
<span class="cm"> * @t_gh: the hold on the transaction lock</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_lock_fs_check_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">t_gh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lfcc</span> <span class="o">*</span><span class="n">lfcc</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_log_header_host</span> <span class="n">lh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jindex_list</span><span class="p">,</span> <span class="n">jd_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lfcc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lfcc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lfcc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_inode</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lfcc</span><span class="o">-&gt;</span><span class="n">gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">lfcc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lfcc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_trans_gl</span><span class="p">,</span> <span class="n">LM_ST_DEFERRED</span><span class="p">,</span>
				   <span class="n">GL_NOCACHE</span><span class="p">,</span> <span class="n">t_gh</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jindex_list</span><span class="p">,</span> <span class="n">jd_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_jdesc_check</span><span class="p">(</span><span class="n">jd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_find_jhead</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lh</span><span class="p">.</span><span class="n">lh_flags</span> <span class="o">&amp;</span> <span class="n">GFS2_LOG_HEAD_UNMOUNT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="n">t_gh</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lfcc</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lfcc</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lfcc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lfcc</span><span class="o">-&gt;</span><span class="n">gh</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">lfcc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_freeze_fs - freezes the file system</span>
<span class="cm"> * @sdp: the file system</span>
<span class="cm"> *</span>
<span class="cm"> * This function flushes data and meta data for all machines by</span>
<span class="cm"> * acquiring the transaction log exclusively.  All journals are</span>
<span class="cm"> * ensured to be in a clean state as well.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">gfs2_freeze_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_freeze_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_freeze_count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_lock_fs_check_clean</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_freeze_gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_freeze_count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_freeze_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_unfreeze_fs - unfreezes the file system</span>
<span class="cm"> * @sdp: the file system</span>
<span class="cm"> *</span>
<span class="cm"> * This function allows the file system to proceed by unlocking</span>
<span class="cm"> * the exclusively held transaction lock.  Other GFS2 nodes are</span>
<span class="cm"> * now free to acquire the lock shared and go on with their lives.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">gfs2_unfreeze_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_freeze_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_freeze_count</span> <span class="o">&amp;&amp;</span> <span class="o">!--</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_freeze_count</span><span class="p">)</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_freeze_gh</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_freeze_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gfs2_dinode_out</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_dinode</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_header</span><span class="p">.</span><span class="n">mh_magic</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_MAGIC</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_header</span><span class="p">.</span><span class="n">mh_type</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_METATYPE_DI</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_header</span><span class="p">.</span><span class="n">mh_format</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">GFS2_FORMAT_DI</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_num</span><span class="p">.</span><span class="n">no_addr</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_num</span><span class="p">.</span><span class="n">no_formal_ino</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_formal_ino</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_mode</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mode</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_uid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_uid</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_gid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_gid</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_nlink</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_nlink</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_size</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">i_size_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">));</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_blocks</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">gfs2_get_inode_blocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">));</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_atime</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_atime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_mtime</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mtime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_ctime</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_ctime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>

	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_goal_meta</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_goal</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_goal_data</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_goal</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_generation</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_generation</span><span class="p">);</span>

	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_height</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_height</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_payload_format</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					     <span class="o">!</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_EXHASH</span><span class="p">)</span> <span class="o">?</span>
					     <span class="n">GFS2_FORMAT_DE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_depth</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_depth</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_entries</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_entries</span><span class="p">);</span>

	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_eattr</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_eattr</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_atime_nsec</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_atime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_mtime_nsec</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_mtime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
	<span class="n">str</span><span class="o">-&gt;</span><span class="n">di_ctime_nsec</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">.</span><span class="n">i_ctime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_write_inode - Make sure the inode is stable on the disk</span>
<span class="cm"> * @inode: The inode</span>
<span class="cm"> * @wbc: The writeback control structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_write_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">writeback_control</span> <span class="o">*</span><span class="n">wbc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">metamapping</span> <span class="o">=</span> <span class="n">gfs2_glock2aspace</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">backing_dev_info</span> <span class="o">*</span><span class="n">bdi</span> <span class="o">=</span> <span class="n">metamapping</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wbc</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">==</span> <span class="n">WB_SYNC_ALL</span><span class="p">)</span>
		<span class="n">gfs2_log_flush</span><span class="p">(</span><span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdi</span><span class="o">-&gt;</span><span class="n">dirty_exceeded</span><span class="p">)</span>
		<span class="n">gfs2_ail1_flush</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">wbc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">filemap_fdatawrite</span><span class="p">(</span><span class="n">metamapping</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wbc</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">==</span> <span class="n">WB_SYNC_ALL</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">filemap_fdatawait</span><span class="p">(</span><span class="n">metamapping</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">mark_inode_dirty_sync</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_dirty_inode - check for atime updates</span>
<span class="cm"> * @inode: The inode in question</span>
<span class="cm"> * @flags: The type of dirty</span>
<span class="cm"> *</span>
<span class="cm"> * Unfortunately it can be called under any combination of inode</span>
<span class="cm"> * glock and transaction lock, so we have to check carefully.</span>
<span class="cm"> *</span>
<span class="cm"> * At the moment this deals only with atime - it should be possible</span>
<span class="cm"> * to expand that role in future, once a review of the locking has</span>
<span class="cm"> * been carried out.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_dirty_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_unlock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_endtrans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">I_DIRTY_DATASYNC</span><span class="o">|</span><span class="n">I_DIRTY_SYNC</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_glock_is_locked_by_me</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fs_err</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;dirty_inode: glock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">need_unlock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">journal_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">RES_DINODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fs_err</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;dirty_inode: gfs2_trans_begin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">need_endtrans</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gfs2_meta_inode_buffer</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_trans_add_bh</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gfs2_dinode_out</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_endtrans</span><span class="p">)</span>
		<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_unlock</span><span class="p">)</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_make_fs_ro - Turn a Read-Write FS into a Read-Only one</span>
<span class="cm"> * @sdp: the filesystem</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_make_fs_ro</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">t_gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">gfs2_delete_workqueue</span><span class="p">);</span>
	<span class="n">gfs2_quota_sync</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_statfs_sync</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_vfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_trans_gl</span><span class="p">,</span> <span class="n">LM_ST_SHARED</span><span class="p">,</span> <span class="n">GL_NOCACHE</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">t_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SDF_SHUTDOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">gfs2_meta_syncfs</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="n">gfs2_log_shutdown</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">SDF_JOURNAL_LIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t_gh</span><span class="p">.</span><span class="n">gh_gl</span><span class="p">)</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_gh</span><span class="p">);</span>

	<span class="n">gfs2_quota_cleanup</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_umount_recovery_wait</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">word</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_put_super - Unmount the filesystem</span>
<span class="cm"> * @sb: The VFS superblock</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_put_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_jdesc</span> <span class="o">*</span><span class="n">jd</span><span class="p">;</span>

	<span class="cm">/*  Unfreeze the filesystem, if we need to  */</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_freeze_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_freeze_count</span><span class="p">)</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_freeze_gh</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_freeze_lock</span><span class="p">);</span>

	<span class="cm">/* No more recovery requests */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">SDF_NORECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">);</span>
	<span class="n">smp_mb</span><span class="p">();</span>

	<span class="cm">/* Wait on outstanding recovery */</span>
<span class="nl">restart:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jindex_spin</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jindex_list</span><span class="p">,</span> <span class="n">jd_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JDF_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jindex_spin</span><span class="p">);</span>
		<span class="n">wait_on_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jd</span><span class="o">-&gt;</span><span class="n">jd_flags</span><span class="p">,</span> <span class="n">JDF_RECOVERY</span><span class="p">,</span>
			    <span class="n">gfs2_umount_recovery_wait</span><span class="p">,</span> <span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jindex_spin</span><span class="p">);</span>

	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quotad_process</span><span class="p">);</span>
	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_logd_process</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_make_fs_ro</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="n">gfs2_io_error</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*  At this point, we&#39;re through modifying the disk  */</span>

	<span class="cm">/*  Release stuff  */</span>

	<span class="n">iput</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jindex</span><span class="p">);</span>
	<span class="n">iput</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_inode</span><span class="p">);</span>
	<span class="n">iput</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rindex</span><span class="p">);</span>
	<span class="n">iput</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_quota_inode</span><span class="p">);</span>

	<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_rename_gl</span><span class="p">);</span>
	<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_trans_gl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_spectator</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_journal_gh</span><span class="p">);</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jinode_gh</span><span class="p">);</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sc_gh</span><span class="p">);</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_qc_gh</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sc_inode</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_qc_inode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_live_gh</span><span class="p">);</span>
	<span class="n">gfs2_clear_rgrpd</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="n">gfs2_jindex_free</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="cm">/*  Take apart glock structures and buffer lists  */</span>
	<span class="n">gfs2_gl_hash_clear</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="cm">/*  Unmount the locking protocol  */</span>
	<span class="n">gfs2_lm_unmount</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>

	<span class="cm">/*  At this point, we&#39;re through participating in the lockspace  */</span>
	<span class="n">gfs2_sys_fs_del</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_sync_fs - sync the filesystem</span>
<span class="cm"> * @sb: the superblock</span>
<span class="cm"> *</span>
<span class="cm"> * Flushes the log to disk.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_sync_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span> <span class="o">&amp;&amp;</span> <span class="n">sdp</span><span class="p">)</span>
		<span class="n">gfs2_log_flush</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_freeze - prevent further writes to the filesystem</span>
<span class="cm"> * @sb: the VFS structure for the filesystem</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SDF_SHUTDOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_freeze_fs</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EBUSY</span>:
			<span class="n">fs_err</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;waiting for recovery before freeze</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">fs_err</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;error freezing FS: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fs_err</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;retrying...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_unfreeze - reallow writes to the filesystem</span>
<span class="cm"> * @sb: the VFS structure for the filesystem</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_unfreeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gfs2_unfreeze_fs</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * statfs_fill - fill in the sg for a given RG</span>
<span class="cm"> * @rgd: the RG</span>
<span class="cm"> * @sc: the sc structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, -ESTALE if the LVB is invalid</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">statfs_slow_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gfs2_rgrp_verify</span><span class="p">(</span><span class="n">rgd</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_total</span> <span class="o">+=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_data</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_free</span> <span class="o">+=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_free</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_dinodes</span> <span class="o">+=</span> <span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_dinodes</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_statfs_slow - Stat a filesystem using asynchronous locking</span>
<span class="cm"> * @sdp: the filesystem</span>
<span class="cm"> * @sc: the sc info that will be returned</span>
<span class="cm"> *</span>
<span class="cm"> * Any error (other than a signal) will cause this routine to fall back</span>
<span class="cm"> * to the synchronous version.</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: This really shouldn&#39;t busy wait like this.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_statfs_slow</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd_next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="o">*</span><span class="n">gha</span><span class="p">,</span> <span class="o">*</span><span class="n">gh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slots</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span><span class="p">));</span>
	<span class="n">gha</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">slots</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_holder</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gha</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rgd_next</span> <span class="o">=</span> <span class="n">gfs2_rgrpd_get_first</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">slots</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gh</span> <span class="o">=</span> <span class="n">gha</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span> <span class="o">&amp;&amp;</span> <span class="n">gfs2_glock_poll</span><span class="p">(</span><span class="n">gh</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">gfs2_glock_wait</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
						<span class="n">error</span> <span class="o">=</span> <span class="n">statfs_slow_fill</span><span class="p">(</span>
							<span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_object</span><span class="p">,</span> <span class="n">sc</span><span class="p">);</span>
					<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="n">gh</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">gh</span><span class="o">-&gt;</span><span class="n">gh_gl</span><span class="p">)</span>
				<span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rgd_next</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">rgd_next</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">,</span>
							   <span class="n">LM_ST_SHARED</span><span class="p">,</span>
							   <span class="n">GL_ASYNC</span><span class="p">,</span>
							   <span class="n">gh</span><span class="p">);</span>
				<span class="n">rgd_next</span> <span class="o">=</span> <span class="n">gfs2_rgrpd_get_next</span><span class="p">(</span><span class="n">rgd_next</span><span class="p">);</span>
				<span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">yield</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">gha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_statfs_i - Do a statfs</span>
<span class="cm"> * @sdp: the filesystem</span>
<span class="cm"> * @sg: the sg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_statfs_i</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">m_sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="o">*</span><span class="n">l_sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_local</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>

	<span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="o">*</span><span class="n">m_sc</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_total</span> <span class="o">+=</span> <span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_total</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_free</span> <span class="o">+=</span> <span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_free</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_dinodes</span> <span class="o">+=</span> <span class="n">l_sc</span><span class="o">-&gt;</span><span class="n">sc_dinodes</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_statfs_spin</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_free</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_free</span> <span class="o">&gt;</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_total</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_free</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_total</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_dinodes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_dinodes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_statfs - Gather and return stats about the filesystem</span>
<span class="cm"> * @sb: The superblock</span>
<span class="cm"> * @statfsbuf: The buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success or error code</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_statfs_change_host</span> <span class="n">sc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_rindex_update</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_tune_get</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">gt_statfs_slow</span><span class="p">))</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_statfs_slow</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_statfs_i</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_type</span> <span class="o">=</span> <span class="n">GFS2_MAGIC</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bsize</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_sb</span><span class="p">.</span><span class="n">sb_bsize</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_blocks</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="n">sc_total</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="n">sc_free</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bavail</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="n">sc_free</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_files</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="n">sc_dinodes</span> <span class="o">+</span> <span class="n">sc</span><span class="p">.</span><span class="n">sc_free</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_ffree</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="n">sc_free</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_namelen</span> <span class="o">=</span> <span class="n">GFS2_FNAMESIZE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_remount_fs - called when the FS is remounted</span>
<span class="cm"> * @sb:  the filesystem</span>
<span class="cm"> * @flags:  the remount flags</span>
<span class="cm"> * @data:  extra data passed in (not used right now)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_remount_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_args</span> <span class="n">args</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">;</span> <span class="cm">/* Default to current settings */</span>
	<span class="k">struct</span> <span class="n">gfs2_tune</span> <span class="o">*</span><span class="n">gt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_tune</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_spin</span><span class="p">);</span>
	<span class="n">args</span><span class="p">.</span><span class="n">ar_commit</span> <span class="o">=</span> <span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_logd_secs</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">ar_quota_quantum</span> <span class="o">=</span> <span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_quota_quantum</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_statfs_slow</span><span class="p">)</span>
		<span class="n">args</span><span class="p">.</span><span class="n">ar_statfs_quantum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">args</span><span class="p">.</span><span class="n">ar_statfs_quantum</span> <span class="o">=</span> <span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_statfs_quantum</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_spin</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_mount_args</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Not allowed to change locking details */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ar_lockproto</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_lockproto</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">strcmp</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ar_locktable</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_locktable</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">strcmp</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ar_hostdata</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_hostdata</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Some flags must not be changed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args_neq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">,</span> <span class="n">spectator</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">args_neq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">,</span> <span class="n">localflocks</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">args_neq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">,</span> <span class="n">meta</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_spectator</span><span class="p">)</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">^</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_make_fs_ro</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_make_fs_rw</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span> <span class="o">=</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_posix_acl</span><span class="p">)</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_POSIXACL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_POSIXACL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">.</span><span class="n">ar_nobarrier</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">SDF_NOBARRIERS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">SDF_NOBARRIERS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_spin</span><span class="p">);</span>
	<span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_logd_secs</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">ar_commit</span><span class="p">;</span>
	<span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_quota_quantum</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">ar_quota_quantum</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ar_statfs_quantum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_statfs_slow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_statfs_quantum</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">ar_statfs_quantum</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_statfs_slow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_statfs_quantum</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">-&gt;</span><span class="n">gt_spin</span><span class="p">);</span>

	<span class="n">gfs2_online_uevent</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_drop_inode - Drop an inode (test for remote unlink)</span>
<span class="cm"> * @inode: The inode to drop</span>
<span class="cm"> *</span>
<span class="cm"> * If we&#39;ve received a callback on an iopen lock then its because a</span>
<span class="cm"> * remote node tried to deallocate the inode but failed due to this node</span>
<span class="cm"> * still having the inode open. Here we mark the link count zero</span>
<span class="cm"> * since we know that it must have reached zero if the GLF_DEMOTE flag</span>
<span class="cm"> * is set on the iopen glock. If we didn&#39;t do a disk read since the</span>
<span class="cm"> * remote node removed the final link then we might otherwise miss</span>
<span class="cm"> * this event. This check ensures that this node will deallocate the</span>
<span class="cm"> * inode&#39;s blocks, or alternatively pass the baton on to another</span>
<span class="cm"> * node for later deallocation.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_drop_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iopen_gh</span><span class="p">.</span><span class="n">gh_gl</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gl</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">GLF_DEMOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">))</span>
			<span class="n">clear_nlink</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">generic_drop_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_ancestor</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">d1</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">d2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d1</span> <span class="o">==</span> <span class="n">d2</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">d1</span> <span class="o">=</span> <span class="n">d1</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ROOT</span><span class="p">(</span><span class="n">d1</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_show_options - Show mount options for /proc/mounts</span>
<span class="cm"> * @s: seq_file structure</span>
<span class="cm"> * @root: root of this (sub)tree</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success or error code</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_show_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_args</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ancestor</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_master_dir</span><span class="p">))</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,meta&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_lockproto</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,lockproto=%s&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_lockproto</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_locktable</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,locktable=%s&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_locktable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,hostdata=%s&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_hostdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_spectator</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,spectator&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_localflocks</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,localflocks&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_debug</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,debug&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_posix_acl</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,acl&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_quota</span> <span class="o">!=</span> <span class="n">GFS2_QUOTA_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_quota</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GFS2_QUOTA_OFF</span>:
			<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;off&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GFS2_QUOTA_ACCOUNT</span>:
			<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;account&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GFS2_QUOTA_ON</span>:
			<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;on&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,quota=%s&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_suiddir</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,suiddir&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_data</span> <span class="o">!=</span> <span class="n">GFS2_DATA_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GFS2_DATA_WRITEBACK</span>:
			<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;writeback&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GFS2_DATA_ORDERED</span>:
			<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;ordered&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,data=%s&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_discard</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,discard&quot;</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_tune</span><span class="p">.</span><span class="n">gt_logd_secs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">30</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,commit=%d&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_tune</span><span class="p">.</span><span class="n">gt_statfs_quantum</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">30</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,statfs_quantum=%d&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_tune</span><span class="p">.</span><span class="n">gt_quota_quantum</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">60</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,quota_quantum=%d&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_statfs_percent</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,statfs_percent=%d&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_statfs_percent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_errors</span> <span class="o">!=</span> <span class="n">GFS2_ERRORS_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ar_errors</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GFS2_ERRORS_WITHDRAW</span>:
			<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;withdraw&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GFS2_ERRORS_PANIC</span>:
			<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;panic&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,errors=%s&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SDF_NOBARRIERS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">))</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,nobarrier&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SDF_DEMOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_flags</span><span class="p">))</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,demote_interface_used&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_final_release_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_glock</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">;</span>

	<span class="n">truncate_inode_pages</span><span class="p">(</span><span class="n">gfs2_glock2aspace</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">truncate_inode_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_revokes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_LFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">GLF_DIRTY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">gl_flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gfs2_dinode_dealloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">GFS2_SB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_qadata</span> <span class="o">*</span><span class="n">qa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_rgrpd</span> <span class="o">*</span><span class="n">rgd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfs2_get_inode_blocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qa</span> <span class="o">=</span> <span class="n">gfs2_qadata_get</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qa</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_quota_hold</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">NO_QUOTA_CHANGE</span><span class="p">,</span> <span class="n">NO_QUOTA_CHANGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rgd</span> <span class="o">=</span> <span class="n">gfs2_blk2rgrpd</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rgd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfs2_consist_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_qs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">rgd</span><span class="o">-&gt;</span><span class="n">rd_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_qs</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">RES_RG_BIT</span> <span class="o">+</span> <span class="n">RES_STATFS</span> <span class="o">+</span> <span class="n">RES_QUOTA</span><span class="p">,</span>
				 <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jdesc</span><span class="o">-&gt;</span><span class="n">jd_blocks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_rg_gunlock</span><span class="p">;</span>

	<span class="n">gfs2_free_di</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

	<span class="n">gfs2_final_release_pages</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>

<span class="nl">out_rg_gunlock:</span>
	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
<span class="nl">out_qs:</span>
	<span class="n">gfs2_quota_unhold</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">gfs2_qadata_put</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gfs2_evict_inode - Remove an inode from cache</span>
<span class="cm"> * @inode: The inode to evict</span>
<span class="cm"> *</span>
<span class="cm"> * There are three cases to consider:</span>
<span class="cm"> * 1. i_nlink == 0, we are final opener (and must deallocate)</span>
<span class="cm"> * 2. i_nlink == 0, we are not the final opener (and cannot deallocate)</span>
<span class="cm"> * 3. i_nlink &gt; 0</span>
<span class="cm"> *</span>
<span class="cm"> * If the fs is read only, then we have to treat all cases as per #3</span>
<span class="cm"> * since we are unable to do any deallocation. The inode will be</span>
<span class="cm"> * deallocated by the next read/write node to attempt an allocation</span>
<span class="cm"> * in the same resource group</span>
<span class="cm"> *</span>
<span class="cm"> * We have to (at the moment) hold the inodes main lock to cover</span>
<span class="cm"> * the gap between unlocking the shared lock on the iopen lock and</span>
<span class="cm"> * taking the exclusive lock. I&#39;d rather do a shared -&gt; exclusive</span>
<span class="cm"> * conversion on the iopen lock, but we can change that later. This</span>
<span class="cm"> * is safe, just less efficient.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_evict_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_sbd</span> <span class="o">*</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">GFS2_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gfs2_holder</span> <span class="n">gh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span> <span class="o">||</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Must not read inode block until block type has been verified */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq_init</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span> <span class="n">GL_SKIP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iopen_gh</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GIF_ALLOC_FAILED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_check_blk_type</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_no_addr</span><span class="p">,</span> <span class="n">GFS2_BLKST_UNLINKED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_truncate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GIF_INVALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_inode_refresh</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_truncate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iopen_gh</span><span class="p">.</span><span class="n">gh_flags</span> <span class="o">|=</span> <span class="n">GL_NOCACHE</span><span class="p">;</span>
	<span class="n">gfs2_glock_dq_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iopen_gh</span><span class="p">);</span>
	<span class="n">gfs2_holder_reinit</span><span class="p">(</span><span class="n">LM_ST_EXCLUSIVE</span><span class="p">,</span> <span class="n">LM_FLAG_TRY_1CB</span> <span class="o">|</span> <span class="n">GL_NOCACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iopen_gh</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_glock_nq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iopen_gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_truncate</span><span class="p">;</span>

	<span class="cm">/* Case 1 starts here */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_diskflags</span> <span class="o">&amp;</span> <span class="n">GFS2_DIF_EXHASH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_dir_exhash_dealloc</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_eattr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_ea_dealloc</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfs2_is_stuffed</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_file_dealloc</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_dinode_dealloc</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

<span class="nl">out_truncate:</span>
	<span class="n">gfs2_log_flush</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">);</span>
	<span class="n">write_inode_now</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gfs2_ail_flush</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Case 2 starts here */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">gfs2_trans_begin</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sd_jdesc</span><span class="o">-&gt;</span><span class="n">jd_blocks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="cm">/* Needs to be done before glock release &amp; also in a transaction */</span>
	<span class="n">truncate_inode_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gfs2_trans_end</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="cm">/* Error path for case 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HIF_HOLDER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iopen_gh</span><span class="p">.</span><span class="n">gh_iflags</span><span class="p">))</span>
		<span class="n">gfs2_glock_dq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iopen_gh</span><span class="p">);</span>
	<span class="n">gfs2_holder_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iopen_gh</span><span class="p">);</span>
	<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">error</span> <span class="o">!=</span> <span class="n">GLR_TRYFAILED</span> <span class="o">&amp;&amp;</span> <span class="n">error</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">)</span>
		<span class="n">fs_warn</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="s">&quot;gfs2_evict_inode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="cm">/* Case 3 starts here */</span>
	<span class="n">truncate_inode_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">clear_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">gfs2_dir_hash_inval</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="o">-&gt;</span><span class="n">gl_object</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">flush_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="o">-&gt;</span><span class="n">gl_work</span><span class="p">);</span>
	<span class="n">gfs2_glock_add_to_lru</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">);</span>
	<span class="n">gfs2_glock_put</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iopen_gh</span><span class="p">.</span><span class="n">gh_gl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iopen_gh</span><span class="p">.</span><span class="n">gh_gl</span><span class="o">-&gt;</span><span class="n">gl_object</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">gfs2_glock_dq_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iopen_gh</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">gfs2_alloc_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gfs2_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>

	<span class="n">ip</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">gfs2_inode_cachep</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_rgd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_i_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span><span class="p">,</span> <span class="n">i_rcu</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">gfs2_inode_cachep</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gfs2_destroy_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rcu</span><span class="p">,</span> <span class="n">gfs2_i_callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">super_operations</span> <span class="n">gfs2_super_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc_inode</span>		<span class="o">=</span> <span class="n">gfs2_alloc_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_inode</span>		<span class="o">=</span> <span class="n">gfs2_destroy_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_inode</span>		<span class="o">=</span> <span class="n">gfs2_write_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dirty_inode</span>		<span class="o">=</span> <span class="n">gfs2_dirty_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">evict_inode</span>		<span class="o">=</span> <span class="n">gfs2_evict_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_super</span>		<span class="o">=</span> <span class="n">gfs2_put_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_fs</span>		<span class="o">=</span> <span class="n">gfs2_sync_fs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze_fs</span> 		<span class="o">=</span> <span class="n">gfs2_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unfreeze_fs</span>		<span class="o">=</span> <span class="n">gfs2_unfreeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">statfs</span>			<span class="o">=</span> <span class="n">gfs2_statfs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remount_fs</span>		<span class="o">=</span> <span class="n">gfs2_remount_fs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drop_inode</span>		<span class="o">=</span> <span class="n">gfs2_drop_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_options</span>		<span class="o">=</span> <span class="n">gfs2_show_options</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
