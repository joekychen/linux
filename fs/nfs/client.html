<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › nfs › client.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>client.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* client.c: NFS client sharing and management code</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Red Hat, Inc. All Rights Reserved.</span>
<span class="cm"> * Written by David Howells (dhowells@redhat.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/clnt.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/stats.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/metrics.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/xprtsock.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/xprtrdma.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_fs.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_mount.h&gt;</span>
<span class="cp">#include &lt;linux/nfs4_mount.h&gt;</span>
<span class="cp">#include &lt;linux/lockd/bind.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_idmap.h&gt;</span>
<span class="cp">#include &lt;linux/vfs.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;net/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_xdr.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/bc_xprt.h&gt;</span>
<span class="cp">#include &lt;linux/nsproxy.h&gt;</span>
<span class="cp">#include &lt;linux/pid_namespace.h&gt;</span>


<span class="cp">#include &quot;nfs4_fs.h&quot;</span>
<span class="cp">#include &quot;callback.h&quot;</span>
<span class="cp">#include &quot;delegation.h&quot;</span>
<span class="cp">#include &quot;iostat.h&quot;</span>
<span class="cp">#include &quot;internal.h&quot;</span>
<span class="cp">#include &quot;fscache.h&quot;</span>
<span class="cp">#include &quot;pnfs.h&quot;</span>
<span class="cp">#include &quot;netns.h&quot;</span>

<span class="cp">#define NFSDBG_FACILITY		NFSDBG_CLIENT</span>

<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">nfs_client_active_wq</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_NFS_V4</span>

<span class="cm">/*</span>
<span class="cm"> * Get a unique NFSv4.0 callback identifier which will be used</span>
<span class="cm"> * by the V4.0 callback service to lookup the nfs_client struct</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_get_cb_ident_idr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">minorversion</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">minorversion</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">retry:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idr_pre_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">cb_ident_idr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">idr_get_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">cb_ident_idr</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_ident</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Turn off NFSv4 uid/gid mapping when using AUTH_SYS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">nfs4_disable_idmapping</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * RPC cruft for NFS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_version</span> <span class="o">*</span><span class="n">nfs_version</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_NFS_V2</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_version2</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_NFS_V3</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_version3</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_NFS_V4</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_version4</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_program</span> <span class="n">nfs_program</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;nfs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">number</span>			<span class="o">=</span> <span class="n">NFS_PROGRAM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nrvers</span>			<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nfs_version</span><span class="p">),</span>
	<span class="p">.</span><span class="n">version</span>		<span class="o">=</span> <span class="n">nfs_version</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stats</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_rpcstat</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pipe_dir_name</span>		<span class="o">=</span> <span class="n">NFS_PIPE_DIRNAME</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rpc_stat</span> <span class="n">nfs_rpcstat</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">program</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_program</span>
<span class="p">};</span>


<span class="cp">#ifdef CONFIG_NFS_V3_ACL</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_stat</span>		<span class="n">nfsacl_rpcstat</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">nfsacl_program</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_version</span> <span class="o">*</span><span class="n">nfsacl_version</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfsacl_version3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_program</span> <span class="n">nfsacl_program</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;nfsacl&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">number</span>			<span class="o">=</span> <span class="n">NFS_ACL_PROGRAM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nrvers</span>			<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nfsacl_version</span><span class="p">),</span>
	<span class="p">.</span><span class="n">version</span>		<span class="o">=</span> <span class="n">nfsacl_version</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stats</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfsacl_rpcstat</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif  </span><span class="cm">/* CONFIG_NFS_V3_ACL */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">nfs_client_initdata</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">init_flags</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">addrlen</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_rpc_ops</span> <span class="o">*</span><span class="n">rpc_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">proto</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">minorversion</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate a shared client record</span>
<span class="cm"> *</span>
<span class="cm"> * Since these are allocated/deallocated very rarely, we don&#39;t</span>
<span class="cm"> * bother putting them in a slab cache...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="nf">nfs_alloc_client</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_client_initdata</span> <span class="o">*</span><span class="n">cl_init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">clp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">clp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_0</span><span class="p">;</span>

	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span> <span class="o">=</span> <span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span> <span class="o">=</span> <span class="n">NFS_CS_INITING</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_addr</span><span class="p">,</span> <span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">addrlen</span><span class="p">);</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_addrlen</span> <span class="o">=</span> <span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">addrlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_superblocks</span><span class="p">);</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_proto</span> <span class="o">=</span> <span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">;</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_net</span> <span class="o">=</span> <span class="n">get_net</span><span class="p">(</span><span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_NFS_V4</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">nfs_get_cb_ident_idr</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_renewd</span><span class="p">,</span> <span class="n">nfs4_renew_state</span><span class="p">);</span>
	<span class="n">rpc_init_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcwaitq</span><span class="p">,</span> <span class="s">&quot;NFS client&quot;</span><span class="p">);</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">;</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_minorversion</span> <span class="o">=</span> <span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">;</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_mvops</span> <span class="o">=</span> <span class="n">nfs_v4_minor_ops</span><span class="p">[</span><span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="n">cred</span> <span class="o">=</span> <span class="n">rpc_lookup_machine_cred</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cred</span><span class="p">))</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_machine_cred</span> <span class="o">=</span> <span class="n">cred</span><span class="p">;</span>
	<span class="n">nfs_fscache_get_client_cookie</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>

<span class="nl">error_cleanup:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="nl">error_0:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NFS_V4</span>
<span class="cp">#ifdef CONFIG_NFS_V4_1</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_shutdown_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_has_session</span><span class="p">(</span><span class="n">clp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nfs4_destroy_session</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">);</span>
		<span class="n">nfs4_destroy_clientid</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_shutdown_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Destroy the NFS4 callback service</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_destroy_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__test_and_clear_bit</span><span class="p">(</span><span class="n">NFS_CS_CALLBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_res_state</span><span class="p">))</span>
		<span class="n">nfs_callback_down</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_mvops</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_shutdown_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__test_and_clear_bit</span><span class="p">(</span><span class="n">NFS_CS_RENEWD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_res_state</span><span class="p">))</span>
		<span class="n">nfs4_kill_renewd</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">nfs4_shutdown_session</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">nfs4_destroy_callback</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__test_and_clear_bit</span><span class="p">(</span><span class="n">NFS_CS_IDMAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_res_state</span><span class="p">))</span>
		<span class="n">nfs_idmap_delete</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>

	<span class="n">rpc_destroy_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcwaitq</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_serverowner</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_serverscope</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_implid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* idr_remove_all is not needed as all id&#39;s are removed by nfs_put_client */</span>
<span class="kt">void</span> <span class="nf">nfs_cleanup_cb_ident_idr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="n">idr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">cb_ident_idr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* nfs_client_lock held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_cb_idr_remove_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_ident</span><span class="p">)</span>
		<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">cb_ident_idr</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_ident</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pnfs_init_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rpc_init_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">roc_rpcwaitq</span><span class="p">,</span> <span class="s">&quot;pNFS ROC&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_destroy_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs4_purge_state_owners</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_shutdown_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs_cleanup_cb_ident_idr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_cb_idr_remove_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pnfs_init_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Destroy a shared client record</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_free_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs_free_client(%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

	<span class="n">nfs4_shutdown_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>

	<span class="n">nfs_fscache_release_client_cookie</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>

	<span class="cm">/* -EIO all pending I/O */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">))</span>
		<span class="n">rpc_shutdown_client</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_machine_cred</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">put_rpccred</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_machine_cred</span><span class="p">);</span>

	<span class="n">put_net</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_net</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs_free_client()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release a reference to a shared client record</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_put_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs_put_client({%d})</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">));</span>
	<span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_share_link</span><span class="p">);</span>
		<span class="n">nfs_cb_idr_remove_locked</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_superblocks</span><span class="p">));</span>

		<span class="n">nfs_free_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nfs_put_client</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_IPV6) || defined(CONFIG_IPV6_MODULE)</span>
<span class="cm">/*</span>
<span class="cm"> * Test if two ip6 socket addresses refer to the same socket by</span>
<span class="cm"> * comparing relevant fields. The padding bytes specifically, are not</span>
<span class="cm"> * compared. sin6_flowinfo is not compared because it only affects QoS</span>
<span class="cm"> * and sin6_scope_id is only compared if the address is &quot;link local&quot;</span>
<span class="cm"> * because &quot;link local&quot; addresses need only be unique to a specific</span>
<span class="cm"> * link. Conversely, ordinary unicast addresses might have different</span>
<span class="cm"> * sin6_scope_id.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller should ensure both socket addresses are AF_INET6.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_sockaddr_match_ipaddr6</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa1</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sin1</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">sa1</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sin2</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">sa2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sin1</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sin2</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sin1</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IPV6_ADDR_LINKLOCAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sin1</span><span class="o">-&gt;</span><span class="n">sin6_scope_id</span> <span class="o">==</span> <span class="n">sin2</span><span class="o">-&gt;</span><span class="n">sin6_scope_id</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else	</span><span class="cm">/* !defined(CONFIG_IPV6) &amp;&amp; !defined(CONFIG_IPV6_MODULE) */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_sockaddr_match_ipaddr6</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa1</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Test if two ip4 socket addresses refer to the same socket, by</span>
<span class="cm"> * comparing relevant fields. The padding bytes specifically, are</span>
<span class="cm"> * not compared.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller should ensure both socket addresses are AF_INET.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_sockaddr_match_ipaddr4</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa1</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin1</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">sa1</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin2</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">sa2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sin1</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span> <span class="n">sin2</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_sockaddr_cmp_ip6</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa1</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sin1</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">sa1</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sin2</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">sa2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nfs_sockaddr_match_ipaddr6</span><span class="p">(</span><span class="n">sa1</span><span class="p">,</span> <span class="n">sa2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">sin1</span><span class="o">-&gt;</span><span class="n">sin6_port</span> <span class="o">==</span> <span class="n">sin2</span><span class="o">-&gt;</span><span class="n">sin6_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_sockaddr_cmp_ip4</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa1</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin1</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">sa1</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin2</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">sa2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nfs_sockaddr_match_ipaddr4</span><span class="p">(</span><span class="n">sa1</span><span class="p">,</span> <span class="n">sa2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">sin1</span><span class="o">-&gt;</span><span class="n">sin_port</span> <span class="o">==</span> <span class="n">sin2</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
<span class="cm">/*</span>
<span class="cm"> * Test if two socket addresses represent the same actual socket,</span>
<span class="cm"> * by comparing (only) relevant fields, excluding the port number.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_sockaddr_match_ipaddr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa1</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sa1</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">sa2</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sa1</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="k">return</span> <span class="n">nfs_sockaddr_match_ipaddr4</span><span class="p">(</span><span class="n">sa1</span><span class="p">,</span> <span class="n">sa2</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="k">return</span> <span class="n">nfs_sockaddr_match_ipaddr6</span><span class="p">(</span><span class="n">sa1</span><span class="p">,</span> <span class="n">sa2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Test if two socket addresses represent the same actual socket,</span>
<span class="cm"> * by comparing (only) relevant fields, including the port number.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_sockaddr_cmp</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa1</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sa1</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">sa2</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sa1</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="k">return</span> <span class="n">nfs_sockaddr_cmp_ip4</span><span class="p">(</span><span class="n">sa1</span><span class="p">,</span> <span class="n">sa2</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="k">return</span> <span class="n">nfs_sockaddr_cmp_ip6</span><span class="p">(</span><span class="n">sa1</span><span class="p">,</span> <span class="n">sa2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
<span class="cm">/* Common match routine for v4.0 and v4.1 callback services */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">nfs4_cb_match_client</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">minorversion</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">clap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_addr</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t match clients that failed to initialise */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span> <span class="o">==</span> <span class="n">NFS_CS_READY</span> <span class="o">||</span>
	    <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span> <span class="o">==</span> <span class="n">NFS_CS_SESSION_INITING</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">smp_rmb</span><span class="p">();</span>

	<span class="cm">/* Match the version and minorversion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">||</span>
	    <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_minorversion</span> <span class="o">!=</span> <span class="n">minorversion</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Match only the IP address, not the port number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs_sockaddr_match_ipaddr</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">clap</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Find an nfs_client on the list that matches the initialisation data</span>
<span class="cm"> * that is supplied.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="nf">nfs_match_client</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_client_initdata</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_list</span><span class="p">,</span> <span class="n">cl_share_link</span><span class="p">)</span> <span class="p">{</span>
	        <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">clap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_addr</span><span class="p">;</span>
		<span class="cm">/* Don&#39;t match clients that failed to initialise properly */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Different NFS versions cannot share the same nfs_client */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_proto</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Match nfsv4 minorversion */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_minorversion</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Match the full socket address */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs_sockaddr_cmp</span><span class="p">(</span><span class="n">sap</span><span class="p">,</span> <span class="n">clap</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nfs_client_init_is_complete</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span> <span class="o">!=</span> <span class="n">NFS_CS_INITING</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs_wait_client_init_complete</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wait_event_killable</span><span class="p">(</span><span class="n">nfs_client_active_wq</span><span class="p">,</span>
			<span class="n">nfs_client_init_is_complete</span><span class="p">(</span><span class="n">clp</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Found an existing client.  Make sure it&#39;s ready before returning.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span>
<span class="nf">nfs_found_client</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_client_initdata</span> <span class="o">*</span><span class="n">cl_init</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_wait_client_init_complete</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs_put_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span> <span class="o">&lt;</span> <span class="n">NFS_CS_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span><span class="p">;</span>
		<span class="n">nfs_put_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">smp_rmb</span><span class="p">();</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s found nfs_client %p for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">hostname</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Look up a client by IP address and protocol version</span>
<span class="cm"> * - creates a new record if one doesn&#39;t yet exist</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span>
<span class="nf">nfs_get_client</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_client_initdata</span> <span class="o">*</span><span class="n">cl_init</span><span class="p">,</span>
	       <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="o">*</span><span class="n">timeparms</span><span class="p">,</span>
	       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ip_addr</span><span class="p">,</span>
	       <span class="n">rpc_authflavor_t</span> <span class="n">authflavour</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs_get_client(%s,v%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">hostname</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

	<span class="cm">/* see if the client already exists */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>

		<span class="n">clp</span> <span class="o">=</span> <span class="n">nfs_match_client</span><span class="p">(</span><span class="n">cl_init</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span>
				<span class="n">nfs_free_client</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">nfs_found_client</span><span class="p">(</span><span class="n">cl_init</span><span class="p">,</span> <span class="n">clp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">cl_share_link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_list</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">cl_flags</span> <span class="o">=</span> <span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">init_flags</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">init_client</span><span class="p">(</span><span class="n">new</span><span class="p">,</span>
						<span class="n">timeparms</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">,</span>
						<span class="n">authflavour</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>

		<span class="n">new</span> <span class="o">=</span> <span class="n">nfs_alloc_client</span><span class="p">(</span><span class="n">cl_init</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">new</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs_get_client() Failed to find %s (%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cl_init</span><span class="o">-&gt;</span><span class="n">hostname</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">new</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Mark a server as ready or failed</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_mark_client_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_client_active_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialise the timeout values for a connection</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_init_timeout_values</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="kt">int</span> <span class="n">proto</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">retrans</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span> <span class="o">=</span> <span class="n">timeo</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_retries</span> <span class="o">=</span> <span class="n">retrans</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">proto</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XPRT_TRANSPORT_TCP</span>:
	<span class="k">case</span> <span class="n">XPRT_TRANSPORT_RDMA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">to_retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_retries</span> <span class="o">=</span> <span class="n">NFS_DEF_TCP_RETRANS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span> <span class="o">=</span> <span class="n">NFS_DEF_TCP_TIMEO</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span> <span class="o">&gt;</span> <span class="n">NFS_MAX_TCP_TIMEOUT</span><span class="p">)</span>
			<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span> <span class="o">=</span> <span class="n">NFS_MAX_TCP_TIMEOUT</span><span class="p">;</span>
		<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_increment</span> <span class="o">=</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span><span class="p">;</span>
		<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_maxval</span> <span class="o">=</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span> <span class="o">+</span> <span class="p">(</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">to_increment</span> <span class="o">*</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_retries</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">to_maxval</span> <span class="o">&gt;</span> <span class="n">NFS_MAX_TCP_TIMEOUT</span><span class="p">)</span>
			<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_maxval</span> <span class="o">=</span> <span class="n">NFS_MAX_TCP_TIMEOUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">to_maxval</span> <span class="o">&lt;</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span><span class="p">)</span>
			<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_maxval</span> <span class="o">=</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span><span class="p">;</span>
		<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_exponential</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XPRT_TRANSPORT_UDP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">to_retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_retries</span> <span class="o">=</span> <span class="n">NFS_DEF_UDP_RETRANS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span><span class="p">)</span>
			<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span> <span class="o">=</span> <span class="n">NFS_DEF_UDP_TIMEO</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span> <span class="o">&gt;</span> <span class="n">NFS_MAX_UDP_TIMEOUT</span><span class="p">)</span>
			<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span> <span class="o">=</span> <span class="n">NFS_MAX_UDP_TIMEOUT</span><span class="p">;</span>
		<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_maxval</span> <span class="o">=</span> <span class="n">NFS_MAX_UDP_TIMEOUT</span><span class="p">;</span>
		<span class="n">to</span><span class="o">-&gt;</span><span class="n">to_exponential</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create an RPC client handle</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_create_rpc_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="o">*</span><span class="n">timeparms</span><span class="p">,</span>
				 <span class="n">rpc_authflavor_t</span> <span class="n">flavor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span>		<span class="o">*</span><span class="n">clnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_create_args</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">net</span>		<span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_net</span><span class="p">,</span>
		<span class="p">.</span><span class="n">protocol</span>	<span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_proto</span><span class="p">,</span>
		<span class="p">.</span><span class="n">address</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_addr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrsize</span>	<span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_addrlen</span><span class="p">,</span>
		<span class="p">.</span><span class="n">timeout</span>	<span class="o">=</span> <span class="n">timeparms</span><span class="p">,</span>
		<span class="p">.</span><span class="n">servername</span>	<span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">,</span>
		<span class="p">.</span><span class="n">program</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_program</span><span class="p">,</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
		<span class="p">.</span><span class="n">authflavor</span>	<span class="o">=</span> <span class="n">flavor</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_CS_DISCRTRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_flags</span><span class="p">))</span>
		<span class="n">args</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RPC_CLNT_CREATE_DISCRTRY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_CS_NORESVPORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_flags</span><span class="p">))</span>
		<span class="n">args</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RPC_CLNT_CREATE_NONPRIVPORT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">clnt</span> <span class="o">=</span> <span class="n">rpc_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: cannot create RPC client. Error = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clnt</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span> <span class="o">=</span> <span class="n">clnt</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Version 2 or 3 client destruction</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_destroy_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_LOCAL_FLOCK</span><span class="p">)</span> <span class="o">||</span>
			<span class="o">!</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_LOCAL_FCNTL</span><span class="p">))</span>
		<span class="n">nlmclnt_done</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nlm_host</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Version 2 or 3 lockd setup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_start_lockd</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmclnt_initdata</span> <span class="n">nlm_init</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">hostname</span>	<span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">,</span>
		<span class="p">.</span><span class="n">address</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_addr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrlen</span>	<span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_addrlen</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nfs_version</span>	<span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
		<span class="p">.</span><span class="n">noresvport</span>	<span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_NORESVPORT</span> <span class="o">?</span>
					<span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">net</span>		<span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_net</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nlm_init</span><span class="p">.</span><span class="n">nfs_version</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_LOCAL_FLOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_LOCAL_FCNTL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_proto</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">nlm_init</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XPRT_TRANSPORT_UDP</span>:
			<span class="n">nlm_init</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">IPPROTO_UDP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">nlmclnt_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nlm_init</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">host</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">nlm_host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">nfs_destroy_server</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialise an NFSv3 ACL client connection</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_NFS_V3_ACL</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_init_server_aclclient</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_noacl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_NOACL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_noacl</span><span class="p">;</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">client_acl</span> <span class="o">=</span> <span class="n">rpc_bind_new_program</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfsacl_program</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client_acl</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_noacl</span><span class="p">;</span>

	<span class="cm">/* No errors! Assume that Sun nfsacls are supported */</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_ACLS</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_noacl:</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_CAP_ACLS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nfs_init_server_aclclient</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_MOUNT_NOACL</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_CAP_ACLS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Create a general RPC client</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_init_server_rpcclient</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="o">*</span><span class="n">timeo</span><span class="p">,</span>
		<span class="n">rpc_authflavor_t</span> <span class="n">pseudoflavour</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">rpc_clone_client</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: couldn&#39;t create rpc_client!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_timeout_default</span><span class="p">,</span>
			<span class="n">timeo</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_timeout_default</span><span class="p">));</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_timeout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_timeout_default</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pseudoflavour</span> <span class="o">!=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="o">-&gt;</span><span class="n">cl_auth</span><span class="o">-&gt;</span><span class="n">au_flavor</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rpc_auth</span> <span class="o">*</span><span class="n">auth</span><span class="p">;</span>

		<span class="n">auth</span> <span class="o">=</span> <span class="n">rpcauth_create</span><span class="p">(</span><span class="n">pseudoflavour</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">auth</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: couldn&#39;t create credcache!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">auth</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_softrtry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_SOFT</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_softrtry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nfs_init_client - Initialise an NFS2 or NFS3 client</span>
<span class="cm"> *</span>
<span class="cm"> * @clp: nfs_client to initialise</span>
<span class="cm"> * @timeparms: timeout parameters for underlying RPC transport</span>
<span class="cm"> * @ip_addr: IP presentation address (not used)</span>
<span class="cm"> * @authflavor: authentication flavor for underlying RPC transport</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to an NFS client, or an ERR_PTR value.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="nf">nfs_init_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span>
		    <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="o">*</span><span class="n">timeparms</span><span class="p">,</span>
		    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">rpc_authflavor_t</span> <span class="n">authflavour</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span> <span class="o">==</span> <span class="n">NFS_CS_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the client is already initialised */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs_init_client() = 0 [already %p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create a client RPC handle for doing FSSTAT with UNIX auth only</span>
<span class="cm">	 * - RFC 2623, sec 2.3.2</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_create_rpc_client</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">timeparms</span><span class="p">,</span> <span class="n">RPC_AUTH_UNIX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">nfs_mark_client_ready</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">NFS_CS_READY</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">nfs_mark_client_ready</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="n">nfs_put_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs_init_client() = xerror %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create a version 2 or 3 client</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_init_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client_initdata</span> <span class="n">cl_init</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">hostname</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrlen</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">addrlen</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span>
		<span class="p">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="n">timeparms</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs_init_server()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_NFS_V2</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">cl_init</span><span class="p">.</span><span class="n">rpc_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_v2_clientops</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_NFS_V3</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">cl_init</span><span class="p">.</span><span class="n">rpc_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_v3_clientops</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nfs_init_timeout_values</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeparms</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">timeo</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">retrans</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_NORESVPORT</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS_CS_NORESVPORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl_init</span><span class="p">.</span><span class="n">init_flags</span><span class="p">);</span>

	<span class="cm">/* Allocate or find a client reference we can use */</span>
	<span class="n">clp</span> <span class="o">=</span> <span class="n">nfs_get_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cl_init</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeparms</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">RPC_AUTH_UNIX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs_init_server() = error %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clp</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span> <span class="o">=</span> <span class="n">clp</span><span class="p">;</span>

	<span class="cm">/* Initialise the client representation from the mount data */</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_HARDLINKS</span><span class="o">|</span><span class="n">NFS_CAP_SYMLINKS</span><span class="o">|</span><span class="n">NFS_CAP_FILEID</span><span class="o">|</span>
		<span class="n">NFS_CAP_MODE</span><span class="o">|</span><span class="n">NFS_CAP_NLINK</span><span class="o">|</span><span class="n">NFS_CAP_OWNER</span><span class="o">|</span><span class="n">NFS_CAP_OWNER_GROUP</span><span class="o">|</span>
		<span class="n">NFS_CAP_ATIME</span><span class="o">|</span><span class="n">NFS_CAP_CTIME</span><span class="o">|</span><span class="n">NFS_CAP_MTIME</span><span class="o">|</span><span class="n">NFS_CAP_CHANGE_ATTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">nfs_block_size</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">nfs_block_size</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">acregmin</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acregmin</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">acregmax</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acregmax</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">acdirmin</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acdirmin</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">acdirmax</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acdirmax</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="cm">/* Start lockd here, before we might error out */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_start_lockd</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_init_server_rpcclient</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeparms</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Preserve the values of mount_server-related mount options */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">addrlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">mountd_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">addrlen</span><span class="p">);</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">mountd_addrlen</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">addrlen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">mountd_version</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">version</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">mountd_port</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">mountd_protocol</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">protocol</span><span class="p">;</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span>  <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">namlen</span><span class="p">;</span>
	<span class="cm">/* Create a client RPC handle for the NFSv3 ACL management interface */</span>
	<span class="n">nfs_init_server_aclclient</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs_init_server() = 0 [new %p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">nfs_put_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs_init_server() = xerror %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Load up the server record from information gained in an fsinfo record</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_server_set_fsinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">mntfh</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="n">fsinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_rpc_payload</span><span class="p">;</span>

	<span class="cm">/* Work out a lot of parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">nfs_block_size</span><span class="p">(</span><span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">rtpref</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">nfs_block_size</span><span class="p">(</span><span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">wtpref</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">rtmax</span> <span class="o">&gt;=</span> <span class="mi">512</span> <span class="o">&amp;&amp;</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">&gt;</span> <span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">rtmax</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">nfs_block_size</span><span class="p">(</span><span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">rtmax</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">wtmax</span> <span class="o">&gt;=</span> <span class="mi">512</span> <span class="o">&amp;&amp;</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">&gt;</span> <span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">wtmax</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">nfs_block_size</span><span class="p">(</span><span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">wtmax</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">max_rpc_payload</span> <span class="o">=</span> <span class="n">nfs_block_size</span><span class="p">(</span><span class="n">rpc_max_payload</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">&gt;</span> <span class="n">max_rpc_payload</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">max_rpc_payload</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">&gt;</span> <span class="n">NFS_MAX_FILE_IO_SIZE</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">NFS_MAX_FILE_IO_SIZE</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">rpages</span> <span class="o">=</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">+</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nfs&quot;</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">rpages</span> <span class="o">*</span> <span class="n">NFS_MAX_READAHEAD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">&gt;</span> <span class="n">max_rpc_payload</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">max_rpc_payload</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">&gt;</span> <span class="n">NFS_MAX_FILE_IO_SIZE</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">NFS_MAX_FILE_IO_SIZE</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">wpages</span> <span class="o">=</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">+</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">pnfs_blksize</span> <span class="o">=</span> <span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">;</span>
	<span class="n">set_pnfs_layoutdriver</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">,</span> <span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">layouttype</span><span class="p">);</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">wtmult</span> <span class="o">=</span> <span class="n">nfs_block_bits</span><span class="p">(</span><span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">wtmult</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">dtsize</span> <span class="o">=</span> <span class="n">nfs_block_size</span><span class="p">(</span><span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">dtpref</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dtsize</span> <span class="o">&gt;</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">*</span> <span class="n">NFS_MAX_READDIR_PAGES</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">dtsize</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">*</span> <span class="n">NFS_MAX_READDIR_PAGES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dtsize</span> <span class="o">&gt;</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">dtsize</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_NOAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">acregmin</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">acregmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">acdirmin</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">acdirmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">maxfilesize</span> <span class="o">=</span> <span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">maxfilesize</span><span class="p">;</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">time_delta</span> <span class="o">=</span> <span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">time_delta</span><span class="p">;</span>

	<span class="cm">/* We&#39;re airborne Set socket buffersize */</span>
	<span class="n">rpc_setbufsize</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">+</span> <span class="mi">100</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">+</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Probe filesystem information, including the FSID on v2/v3</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_probe_fsinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">mntfh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="n">fsinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs_probe_fsinfo()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">set_capabilities</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">set_capabilities</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fsinfo</span><span class="p">.</span><span class="n">fattr</span> <span class="o">=</span> <span class="n">fattr</span><span class="p">;</span>
	<span class="n">fsinfo</span><span class="p">.</span><span class="n">layouttype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">fsinfo</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>

	<span class="n">nfs_server_set_fsinfo</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsinfo</span><span class="p">);</span>

	<span class="cm">/* Get some general file system info */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs_pathconf</span> <span class="n">pathinfo</span><span class="p">;</span>

		<span class="n">pathinfo</span><span class="p">.</span><span class="n">fattr</span> <span class="o">=</span> <span class="n">fattr</span><span class="p">;</span>
		<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="n">fattr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">pathconf</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pathinfo</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">=</span> <span class="n">pathinfo</span><span class="p">.</span><span class="n">max_namelen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs_probe_fsinfo() = 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_error:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfs_probe_fsinfo: error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy useful information when duplicating a server record</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_server_copy_userdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">acregmin</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">acregmin</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">acregmax</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">acregmax</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">acdirmin</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">acdirmin</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">acdirmax</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">acdirmax</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_server_insert_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
	<span class="n">list_add_tail_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client_link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_superblocks</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">master_link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_volume_list</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_CS_STOP_RENEW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_res_state</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_server_remove_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
	<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client_link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_superblocks</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS_CS_STOP_RENEW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_res_state</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">master_link</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>

	<span class="n">synchronize_rcu</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate and initialise a server record</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="nf">nfs_alloc_server</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>

	<span class="n">server</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">client_acl</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="cm">/* Zero out the NFS state stuff */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client_link</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">master_link</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">delegations</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">layouts</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">state_owners_lru</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">io_stats</span> <span class="o">=</span> <span class="n">nfs_alloc_iostats</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">io_stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bdi_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nfs_free_iostats</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">io_stats</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ida_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">openowner_id</span><span class="p">);</span>
	<span class="n">ida_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">lockowner_id</span><span class="p">);</span>
	<span class="n">pnfs_init_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">server</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free up a server record</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_free_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs_free_server()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">nfs_server_remove_lists</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="n">unset_pnfs_layoutdriver</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">destroy</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client_acl</span><span class="p">))</span>
		<span class="n">rpc_shutdown_client</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client_acl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">))</span>
		<span class="n">rpc_shutdown_client</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>

	<span class="n">nfs_put_client</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">);</span>

	<span class="n">ida_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">lockowner_id</span><span class="p">);</span>
	<span class="n">ida_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">openowner_id</span><span class="p">);</span>
	<span class="n">nfs_free_iostats</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">io_stats</span><span class="p">);</span>
	<span class="n">bdi_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="n">nfs_release_automount_timer</span><span class="p">();</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs_free_server()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create a version 2 or 3 volume record</span>
<span class="cm"> * - keyed on server and FSID</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="nf">nfs_create_server</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">mntfh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">server</span> <span class="o">=</span> <span class="n">nfs_alloc_server</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">fattr</span> <span class="o">=</span> <span class="n">nfs_alloc_fattr</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fattr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Get a client representation */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_init_server</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">file_inode_ops</span><span class="p">);</span>

	<span class="cm">/* Probe the root fh to retrieve its FSID */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_probe_fsinfo</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">,</span> <span class="n">fattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">&gt;</span> <span class="n">NFS3_MAXNAMLEN</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">=</span> <span class="n">NFS3_MAXNAMLEN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_NORDIRPLUS</span><span class="p">))</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_READDIRPLUS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">&gt;</span> <span class="n">NFS2_MAXNAMLEN</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">=</span> <span class="n">NFS2_MAXNAMLEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">NFS_ATTR_FATTR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">getattr</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">,</span> <span class="n">fattr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfs_create_server: getattr error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">error</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Server FSID: %llx:%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">.</span><span class="n">major</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>

	<span class="n">nfs_server_insert_lists</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">mount_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">nfs_free_fattr</span><span class="p">(</span><span class="n">fattr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">server</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">nfs_free_fattr</span><span class="p">(</span><span class="n">fattr</span><span class="p">);</span>
	<span class="n">nfs_free_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NFS_V4</span>
<span class="cm">/*</span>
<span class="cm"> * NFSv4.0 callback thread helper</span>
<span class="cm"> *</span>
<span class="cm"> * Find a client by callback identifier</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span>
<span class="nf">nfs4_find_client_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cb_ident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
	<span class="n">clp</span> <span class="o">=</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">cb_ident_idr</span><span class="p">,</span> <span class="n">cb_ident</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
<span class="cm">/*</span>
<span class="cm"> * NFSv4.1 callback thread helper</span>
<span class="cm"> * For CB_COMPOUND calls, find a client by IP address, protocol version,</span>
<span class="cm"> * minorversion, and sessionID</span>
<span class="cm"> *</span>
<span class="cm"> * Returns NULL if no such client</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span>
<span class="nf">nfs4_find_client_sessionid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nfs4_sessionid</span> <span class="o">*</span><span class="n">sid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_list</span><span class="p">,</span> <span class="n">cl_share_link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_cb_match_client</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_has_session</span><span class="p">(</span><span class="n">clp</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Match sessionid*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="o">-&gt;</span><span class="n">sess_id</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
		    <span class="n">sid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_MAX_SESSIONID_LEN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span>
<span class="nf">nfs4_find_client_sessionid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nfs4_sessionid</span> <span class="o">*</span><span class="n">sid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the NFS4 callback service</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_init_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">;</span>

		<span class="n">xprt</span> <span class="o">=</span> <span class="n">rcu_dereference_raw</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="o">-&gt;</span><span class="n">cl_xprt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_has_session</span><span class="p">(</span><span class="n">clp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xprt_setup_backchannel</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span>
						<span class="n">NFS41_BC_MIN_CALLBACKS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_callback_up</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_mvops</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">,</span> <span class="n">xprt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: failed to start callback. Error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">NFS_CS_CALLBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_res_state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the minor version specific parts of an NFS4 client record</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_init_client_minor_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_mvops</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Create the session and mark it expired.</span>
<span class="cm">		 * When a SEQUENCE operation encounters the expired session</span>
<span class="cm">		 * it will do session recovery to initialize it.</span>
<span class="cm">		 */</span>
		<span class="n">session</span> <span class="o">=</span> <span class="n">nfs4_alloc_session</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">session</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span> <span class="o">=</span> <span class="n">session</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * The create session reply races with the server back</span>
<span class="cm">		 * channel probe. Mark the client NFS_CS_SESSION_INITING</span>
<span class="cm">		 * so that the client back channel can find the</span>
<span class="cm">		 * nfs_client struct</span>
<span class="cm">		 */</span>
		<span class="n">nfs_mark_client_ready</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">NFS_CS_SESSION_INITING</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>

	<span class="k">return</span> <span class="n">nfs4_init_callback</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nfs4_init_client - Initialise an NFS4 client record</span>
<span class="cm"> *</span>
<span class="cm"> * @clp: nfs_client to initialise</span>
<span class="cm"> * @timeparms: timeout parameters for underlying RPC transport</span>
<span class="cm"> * @ip_addr: callback IP address in presentation format</span>
<span class="cm"> * @authflavor: authentication flavor for underlying RPC transport</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to an NFS client, or an ERR_PTR value.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="nf">nfs4_init_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="o">*</span><span class="n">timeparms</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ip_addr</span><span class="p">,</span>
				    <span class="n">rpc_authflavor_t</span> <span class="n">authflavour</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">INET6_ADDRSTRLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span> <span class="o">==</span> <span class="n">NFS_CS_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the client is initialised already */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs4_init_client() = 0 [already %p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check NFS protocol revision and initialize RPC op vector */</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_v4_clientops</span><span class="p">;</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">NFS_CS_DISCRTRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_flags</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_create_rpc_client</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">timeparms</span><span class="p">,</span> <span class="n">authflavour</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* If no clientaddr= option was specified, find a usable cb address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">cb_addr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cb_addr</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">rpc_localaddr</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="n">sap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cb_addr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">rpc_ntop</span><span class="p">(</span><span class="n">sap</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">ip_addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_ipaddr</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_ipaddr</span><span class="p">));</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_idmap_new</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: failed to create idmapper. Error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">NFS_CS_IDMAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_res_state</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs4_init_client_minor_version</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_has_session</span><span class="p">(</span><span class="n">clp</span><span class="p">))</span>
		<span class="n">nfs_mark_client_ready</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">NFS_CS_READY</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">nfs_mark_client_ready</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="n">nfs_put_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs4_init_client() = xerror %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up an NFS4 client</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_set_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">size_t</span> <span class="n">addrlen</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ip_addr</span><span class="p">,</span>
		<span class="n">rpc_authflavor_t</span> <span class="n">authflavour</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">proto</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="o">*</span><span class="n">timeparms</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">minorversion</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client_initdata</span> <span class="n">cl_init</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrlen</span> <span class="o">=</span> <span class="n">addrlen</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_v4_clientops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">proto</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minorversion</span> <span class="o">=</span> <span class="n">minorversion</span><span class="p">,</span>
		<span class="p">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs4_set_client()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_NORESVPORT</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS_CS_NORESVPORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl_init</span><span class="p">.</span><span class="n">init_flags</span><span class="p">);</span>

	<span class="cm">/* Allocate or find a client reference we can use */</span>
	<span class="n">clp</span> <span class="o">=</span> <span class="n">nfs_get_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cl_init</span><span class="p">,</span> <span class="n">timeparms</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">,</span> <span class="n">authflavour</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Query for the lease time on clientid setup or renewal</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note that this will be set on nfs_clients that were created</span>
<span class="cm">	 * only for the DS role and did not set this bit, but now will</span>
<span class="cm">	 * serve a dual role.</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS_CS_CHECK_LEASE_TIME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_res_state</span><span class="p">);</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span> <span class="o">=</span> <span class="n">clp</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs4_set_client() = 0 [new %p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs4_set_client() = xerror %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up a pNFS Data Server client.</span>
<span class="cm"> *</span>
<span class="cm"> * Return any existing nfs_client that matches server address,port,version</span>
<span class="cm"> * and minorversion.</span>
<span class="cm"> *</span>
<span class="cm"> * For a new nfs_client, use a soft mount (default), a low retrans and a</span>
<span class="cm"> * low timeout interval so that if a connection is lost, we retry through</span>
<span class="cm"> * the MDS.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="nf">nfs4_set_ds_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span><span class="o">*</span> <span class="n">mds_clp</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">ds_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ds_addrlen</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">ds_proto</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ds_timeo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ds_retrans</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client_initdata</span> <span class="n">cl_init</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ds_addr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrlen</span> <span class="o">=</span> <span class="n">ds_addrlen</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_v4_clientops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">ds_proto</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minorversion</span> <span class="o">=</span> <span class="n">mds_clp</span><span class="o">-&gt;</span><span class="n">cl_minorversion</span><span class="p">,</span>
		<span class="p">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">mds_clp</span><span class="o">-&gt;</span><span class="n">cl_net</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="n">ds_timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set an authflavor equual to the MDS value. Use the MDS nfs_client</span>
<span class="cm">	 * cl_ipaddr so as to use the same EXCHANGE_ID co_ownerid as the MDS</span>
<span class="cm">	 * (section 13.1 RFC 5661).</span>
<span class="cm">	 */</span>
	<span class="n">nfs_init_timeout_values</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds_timeout</span><span class="p">,</span> <span class="n">ds_proto</span><span class="p">,</span> <span class="n">ds_timeo</span><span class="p">,</span> <span class="n">ds_retrans</span><span class="p">);</span>
	<span class="n">clp</span> <span class="o">=</span> <span class="n">nfs_get_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cl_init</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds_timeout</span><span class="p">,</span> <span class="n">mds_clp</span><span class="o">-&gt;</span><span class="n">cl_ipaddr</span><span class="p">,</span>
			     <span class="n">mds_clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="o">-&gt;</span><span class="n">cl_auth</span><span class="o">-&gt;</span><span class="n">au_flavor</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">clp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">clp</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nfs4_set_ds_client</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Session has been established, and the client marked ready.</span>
<span class="cm"> * Set the mount rsize and wsize with negotiated fore channel</span>
<span class="cm"> * attributes which will be bound checked in nfs_server_set_fsinfo.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_session_set_rwsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_NFS_V4_1</span>
	<span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">server_resp_sz</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">server_rqst_sz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_has_session</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">;</span>
	<span class="n">server_resp_sz</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_resp_sz</span> <span class="o">-</span> <span class="n">nfs41_maxread_overhead</span><span class="p">;</span>
	<span class="n">server_rqst_sz</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_rqst_sz</span> <span class="o">-</span> <span class="n">nfs41_maxwrite_overhead</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">&gt;</span> <span class="n">server_resp_sz</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">server_resp_sz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">&gt;</span> <span class="n">server_rqst_sz</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">server_rqst_sz</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_server_common_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">mntfh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">file_inode_ops</span><span class="p">);</span>

	<span class="cm">/* data servers support only a subset of NFSv4.1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_ds_only_client</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>

	<span class="n">fattr</span> <span class="o">=</span> <span class="n">nfs_alloc_fattr</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fattr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* We must ensure the session is initialised first */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs4_init_session</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Probe the root fh to retrieve its FSID and filehandle */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs4_get_rootfh</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Server FSID: %llx:%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">.</span><span class="n">major</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Mount FH: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mntfh</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">nfs4_session_set_rwsize</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_probe_fsinfo</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">,</span> <span class="n">fattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">&gt;</span> <span class="n">NFS4_MAXNAMLEN</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">=</span> <span class="n">NFS4_MAXNAMLEN</span><span class="p">;</span>

	<span class="n">nfs_server_insert_lists</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">mount_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">nfs4_destroy_server</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">nfs_free_fattr</span><span class="p">(</span><span class="n">fattr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create a version 4 volume record</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_init_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="n">timeparms</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs4_init_server()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">nfs_init_timeout_values</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeparms</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">timeo</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">retrans</span><span class="p">);</span>

	<span class="cm">/* Initialise the client representation from the mount data */</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_ATOMIC_OPEN</span><span class="o">|</span><span class="n">NFS_CAP_CHANGE_ATTR</span><span class="o">|</span><span class="n">NFS_CAP_POSIX_LOCK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_NORDIRPLUS</span><span class="p">))</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_READDIRPLUS</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">;</span>

	<span class="cm">/* Get a client record */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs4_set_client</span><span class="p">(</span><span class="n">server</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">hostname</span><span class="p">,</span>
			<span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">addrlen</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">client_address</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">timeparms</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t use NFS uid/gid mapping if we&#39;re using AUTH_SYS or lower</span>
<span class="cm">	 * authentication.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_disable_idmapping</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_AUTH_UNIX</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_UIDGID_NOMAP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">nfs_block_size</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">nfs_block_size</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">acregmin</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acregmin</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">acregmax</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acregmax</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">acdirmin</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acdirmin</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">acdirmax</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acdirmax</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_init_server_rpcclient</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeparms</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

<span class="nl">error:</span>
	<span class="cm">/* Done */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs4_init_server() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create a version 4 volume record</span>
<span class="cm"> * - keyed on server and FSID</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="nf">nfs4_create_server</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">mntfh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs4_create_server()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">server</span> <span class="o">=</span> <span class="n">nfs_alloc_server</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="cm">/* set up the general RPC client */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs4_init_server</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs4_server_common_setup</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs4_create_server() = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">server</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">nfs_free_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs4_create_server() = error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create an NFS4 referral server record</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="nf">nfs4_create_referral_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_clone_mount</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">mntfh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">parent_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="o">*</span><span class="n">parent_server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs4_create_referral_server()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">server</span> <span class="o">=</span> <span class="n">nfs_alloc_server</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">parent_server</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">parent_client</span> <span class="o">=</span> <span class="n">parent_server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>

	<span class="cm">/* Initialise the client representation from the parent server */</span>
	<span class="n">nfs_server_copy_userdata</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">parent_server</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_ATOMIC_OPEN</span><span class="o">|</span><span class="n">NFS_CAP_CHANGE_ATTR</span><span class="p">;</span>

	<span class="cm">/* Get a client representation.</span>
<span class="cm">	 * Note: NFSv4 always uses TCP, */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs4_set_client</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">addrlen</span><span class="p">,</span>
				<span class="n">parent_client</span><span class="o">-&gt;</span><span class="n">cl_ipaddr</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">authflavor</span><span class="p">,</span>
				<span class="n">rpc_protocol</span><span class="p">(</span><span class="n">parent_server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">),</span>
				<span class="n">parent_server</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_timeout</span><span class="p">,</span>
				<span class="n">parent_client</span><span class="o">-&gt;</span><span class="n">cl_mvops</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">,</span>
				<span class="n">parent_client</span><span class="o">-&gt;</span><span class="n">cl_net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_init_server_rpcclient</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">parent_server</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_timeout</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">authflavor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs4_server_common_setup</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs_create_referral_server() = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">server</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">nfs_free_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs4_create_referral_server() = error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Clone an NFS2, NFS3 or NFS4 server record</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="nf">nfs_clone_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">,</span>
				    <span class="n">rpc_authflavor_t</span> <span class="n">flavor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr_fsinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs_clone_server(,%llx:%llx,)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">fattr</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">.</span><span class="n">major</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">fattr</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>

	<span class="n">server</span> <span class="o">=</span> <span class="n">nfs_alloc_server</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">fattr_fsinfo</span> <span class="o">=</span> <span class="n">nfs_alloc_fattr</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fattr_fsinfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_server</span><span class="p">;</span>

	<span class="cm">/* Copy data from the source */</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">);</span>
	<span class="n">nfs_server_copy_userdata</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span> <span class="o">=</span> <span class="n">fattr</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_init_server_rpcclient</span><span class="p">(</span><span class="n">server</span><span class="p">,</span>
			<span class="n">source</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_timeout</span><span class="p">,</span>
			<span class="n">flavor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_server</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">client_acl</span><span class="p">))</span>
		<span class="n">nfs_init_server_aclclient</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

	<span class="cm">/* probe the filesystem info for this server filesystem */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_probe_fsinfo</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fattr_fsinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_server</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">&gt;</span> <span class="n">NFS4_MAXNAMLEN</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">=</span> <span class="n">NFS4_MAXNAMLEN</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Cloned FSID: %llx:%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">.</span><span class="n">major</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_start_lockd</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_server</span><span class="p">;</span>

	<span class="n">nfs_server_insert_lists</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">mount_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">nfs_free_fattr</span><span class="p">(</span><span class="n">fattr_fsinfo</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs_clone_server() = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">server</span><span class="p">;</span>

<span class="nl">out_free_server:</span>
	<span class="n">nfs_free_fattr</span><span class="p">(</span><span class="n">fattr_fsinfo</span><span class="p">);</span>
	<span class="n">nfs_free_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs_clone_server() = error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs_clients_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_volume_list</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_NFS_V4</span>
	<span class="n">idr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">cb_ident_idr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
	<span class="n">nn</span><span class="o">-&gt;</span><span class="n">boot_time</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">proc_fs_nfs</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nfs_server_list_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">nfs_server_list_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">nfs_server_list_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nfs_server_list_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nfs_server_list_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">nfs_server_list_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">nfs_server_list_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">nfs_server_list_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">nfs_server_list_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">nfs_server_list_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">nfs_server_list_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">nfs_server_list_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nfs_volume_list_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">nfs_volume_list_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">nfs_volume_list_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nfs_volume_list_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nfs_volume_list_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">nfs_volume_list_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">nfs_volume_list_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">nfs_volume_list_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">nfs_volume_list_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">nfs_volume_list_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">nfs_volume_list_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">nfs_volume_list_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * open &quot;/proc/fs/nfsfs/servers&quot; which provides a summary of servers with which</span>
<span class="cm"> * we&#39;re dealing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_server_list_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pid_namespace</span> <span class="o">*</span><span class="n">pid_ns</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">pid_ns</span><span class="o">-&gt;</span><span class="n">child_reaper</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">net_ns</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfs_server_list_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set up the iterator to start reading from the server list and return the first item</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">nfs_server_list_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">_pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="cm">/* lock the list against modification */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">seq_list_start_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_list</span><span class="p">,</span> <span class="o">*</span><span class="n">_pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * move to next server</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">nfs_server_list_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">seq_list_next</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_list</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * clean up after reading from the transports list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_server_list_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * display a header line followed by a load of call lines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_server_list_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="cm">/* display header on line 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;NV SERVER   PORT USE HOSTNAME</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* display one transport per line on subsequent lines */</span>
	<span class="n">clp</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_client</span><span class="p">,</span> <span class="n">cl_share_link</span><span class="p">);</span>

	<span class="cm">/* Check if the client is initialized */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span> <span class="o">!=</span> <span class="n">NFS_CS_READY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;v%u %s %s %3d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
		   <span class="n">rpc_peeraddr2str</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="n">RPC_DISPLAY_HEX_ADDR</span><span class="p">),</span>
		   <span class="n">rpc_peeraddr2str</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="n">RPC_DISPLAY_HEX_PORT</span><span class="p">),</span>
		   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">),</span>
		   <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * open &quot;/proc/fs/nfsfs/volumes&quot; which provides a summary of extant volumes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_volume_list_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pid_namespace</span> <span class="o">*</span><span class="n">pid_ns</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">pid_ns</span><span class="o">-&gt;</span><span class="n">child_reaper</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">net_ns</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfs_volume_list_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set up the iterator to start reading from the volume list and return the first item</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">nfs_volume_list_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">_pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="cm">/* lock the list against modification */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">seq_list_start_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_volume_list</span><span class="p">,</span> <span class="o">*</span><span class="n">_pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * move to next volume</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">nfs_volume_list_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">seq_list_next</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_volume_list</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * clean up after reading from the transports list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_volume_list_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_client_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * display a header line followed by a load of call lines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_volume_list_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">dev</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">fsid</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="cm">/* display header on line 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">nfs_volume_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;NV SERVER   PORT DEV     FSID              FSC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* display one transport per line on subsequent lines */</span>
	<span class="n">server</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_server</span><span class="p">,</span> <span class="n">master_link</span><span class="p">);</span>
	<span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%u:%u&quot;</span><span class="p">,</span>
		 <span class="n">MAJOR</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">));</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">fsid</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="s">&quot;%llx:%llx&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">.</span><span class="n">major</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;v%u %s %s %-7s %-17s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
		   <span class="n">rpc_peeraddr2str</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="n">RPC_DISPLAY_HEX_ADDR</span><span class="p">),</span>
		   <span class="n">rpc_peeraddr2str</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="n">RPC_DISPLAY_HEX_PORT</span><span class="p">),</span>
		   <span class="n">dev</span><span class="p">,</span>
		   <span class="n">fsid</span><span class="p">,</span>
		   <span class="n">nfs_server_fscache_state</span><span class="p">(</span><span class="n">server</span><span class="p">));</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialise the /proc/fs/nfsfs/ directory</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">nfs_fs_proc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">proc_fs_nfs</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;fs/nfsfs&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_fs_nfs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_0</span><span class="p">;</span>

	<span class="cm">/* a file of servers with which we&#39;re dealing */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;servers&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span>
			<span class="n">proc_fs_nfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfs_server_list_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_1</span><span class="p">;</span>

	<span class="cm">/* a file of volumes that we have mounted */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;volumes&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span>
			<span class="n">proc_fs_nfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfs_volume_list_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_2</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_2:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;servers&quot;</span><span class="p">,</span> <span class="n">proc_fs_nfs</span><span class="p">);</span>
<span class="nl">error_1:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;fs/nfsfs&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">error_0:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * clean up the /proc/fs/nfsfs/ directory</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_fs_proc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;volumes&quot;</span><span class="p">,</span> <span class="n">proc_fs_nfs</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;servers&quot;</span><span class="p">,</span> <span class="n">proc_fs_nfs</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;fs/nfsfs&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="n">module_param</span><span class="p">(</span><span class="n">nfs4_disable_idmapping</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nfs4_disable_idmapping</span><span class="p">,</span>
		<span class="s">&quot;Turn off NFSv4 idmapping when using &#39;sec=sys&#39;&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
