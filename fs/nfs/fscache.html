<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › nfs › fscache.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>fscache.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* NFS filesystem cache interface</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Red Hat, Inc. All Rights Reserved.</span>
<span class="cm"> * Written by David Howells (dhowells@redhat.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public Licence</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the Licence, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_fs.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_fs_sb.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;internal.h&quot;</span>
<span class="cp">#include &quot;iostat.h&quot;</span>
<span class="cp">#include &quot;fscache.h&quot;</span>

<span class="cp">#define NFSDBG_FACILITY		NFSDBG_FSCACHE</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rb_root</span> <span class="n">nfs_fscache_keys</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">nfs_fscache_keys_lock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Get the per-client index cookie for an NFS client if the appropriate mount</span>
<span class="cm"> * flag was set</span>
<span class="cm"> * - We always try and get an index cookie for the client, but get filehandle</span>
<span class="cm"> *   cookies on a per-superblock basis, depending on the mount flags</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_fscache_get_client_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* create a cache index for looking up filehandles */</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">fscache</span> <span class="o">=</span> <span class="n">fscache_acquire_cookie</span><span class="p">(</span><span class="n">nfs_fscache_netfs</span><span class="p">.</span><span class="n">primary_index</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">nfs_fscache_server_index_def</span><span class="p">,</span>
					      <span class="n">clp</span><span class="p">);</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span> <span class="s">&quot;NFS: get client cookie (0x%p/0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">clp</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Dispose of a per-client cookie</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_fscache_release_client_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span> <span class="s">&quot;NFS: releasing client cookie (0x%p/0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">clp</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">);</span>

	<span class="n">fscache_relinquish_cookie</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">fscache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the cache cookie for an NFS superblock.  We have to handle</span>
<span class="cm"> * uniquification here because the cache doesn&#39;t do it for us.</span>
<span class="cm"> *</span>
<span class="cm"> * The default uniquifier is just an empty string, but it may be overridden</span>
<span class="cm"> * either by the &#39;fsc=xxx&#39; option to mount, or by inheriting it from the parent</span>
<span class="cm"> * superblock across an automount point of some nature.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_fscache_get_super_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uniq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ulen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_fscache_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">xkey</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">nfss</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uniq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uniq</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="n">ulen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="n">ulen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">key</span><span class="o">-&gt;</span><span class="n">nfs_client</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">super</span><span class="p">.</span><span class="n">s_flags</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">NFS_MS_MASK</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">acregmin</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acregmin</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">acregmax</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acregmax</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">acdirmin</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acdirmin</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">acdirmax</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acdirmax</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">fsid</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">rpc_auth</span><span class="p">.</span><span class="n">au_flavor</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_auth</span><span class="o">-&gt;</span><span class="n">au_flavor</span><span class="p">;</span>

	<span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">uniq_len</span> <span class="o">=</span> <span class="n">ulen</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">uniquifier</span><span class="p">,</span> <span class="n">uniq</span><span class="p">,</span> <span class="n">ulen</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_fscache_keys_lock</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_fscache_keys</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">xkey</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fscache_key</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">nfs_client</span> <span class="o">&lt;</span> <span class="n">xkey</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">go_left</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">nfs_client</span> <span class="o">&gt;</span> <span class="n">xkey</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">go_right</span><span class="p">;</span>

		<span class="n">diff</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">go_left</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">go_right</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">uniq_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">non_unique</span><span class="p">;</span>
		<span class="n">diff</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">uniquifier</span><span class="p">,</span>
			      <span class="n">xkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">uniquifier</span><span class="p">,</span>
			      <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">uniq_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">go_left</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">go_right</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">non_unique</span><span class="p">;</span>

	<span class="nl">go_left:</span>
		<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="nl">go_right:</span>
		<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfs_fscache_keys</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_fscache_keys_lock</span><span class="p">);</span>
	<span class="n">nfss</span><span class="o">-&gt;</span><span class="n">fscache_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>

	<span class="cm">/* create a cache index for looking up filehandles */</span>
	<span class="n">nfss</span><span class="o">-&gt;</span><span class="n">fscache</span> <span class="o">=</span> <span class="n">fscache_acquire_cookie</span><span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">nfs_fscache_super_index_def</span><span class="p">,</span>
					       <span class="n">nfss</span><span class="p">);</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span> <span class="s">&quot;NFS: get superblock cookie (0x%p/0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">nfss</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">non_unique:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_fscache_keys_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">nfss</span><span class="o">-&gt;</span><span class="n">fscache_key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">nfss</span><span class="o">-&gt;</span><span class="n">fscache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;NFS:&quot;</span>
	       <span class="s">&quot; Cache request denied due to non-unique superblock keys</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * release a per-superblock cookie</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_fscache_release_super_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">nfss</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span> <span class="s">&quot;NFS: releasing superblock cookie (0x%p/0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">nfss</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">);</span>

	<span class="n">fscache_relinquish_cookie</span><span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nfss</span><span class="o">-&gt;</span><span class="n">fscache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">fscache_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_fscache_keys_lock</span><span class="p">);</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">fscache_key</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfs_fscache_keys</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_fscache_keys_lock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">fscache_key</span><span class="p">);</span>
		<span class="n">nfss</span><span class="o">-&gt;</span><span class="n">fscache_key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialise the per-inode cache cookie pointer for an NFS inode.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_fscache_init_inode_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fscache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS_INO_FSCACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the per-inode cache cookie for an NFS inode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_fscache_enable_inode_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span> <span class="o">||</span> <span class="o">!</span><span class="n">NFS_FSCACHE</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">NFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NFS_OPTION_FSCACHE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span> <span class="o">=</span> <span class="n">fscache_acquire_cookie</span><span class="p">(</span>
			<span class="n">NFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">nfs_fscache_inode_object_def</span><span class="p">,</span>
			<span class="n">nfsi</span><span class="p">);</span>

		<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span> <span class="s">&quot;NFS: get FH cookie (0x%p/0x%p/0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">sb</span><span class="p">,</span> <span class="n">nfsi</span><span class="p">,</span> <span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release a per-inode cookie.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_fscache_release_inode_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span> <span class="s">&quot;NFS: clear cookie (0x%p/0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">nfsi</span><span class="p">,</span> <span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">);</span>

	<span class="n">fscache_relinquish_cookie</span><span class="p">(</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Retire a per-inode cookie, destroying the data attached to it.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_fscache_zap_inode_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span> <span class="s">&quot;NFS: zapping cookie (0x%p/0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">nfsi</span><span class="p">,</span> <span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">);</span>

	<span class="n">fscache_relinquish_cookie</span><span class="p">(</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Turn off the cache with regard to a per-inode cookie if opened for writing,</span>
<span class="cm"> * invalidating all the pages in the page cache relating to the associated</span>
<span class="cm"> * inode to clear the per-page caching.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_fscache_disable_inode_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_INO_FSCACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span>
			 <span class="s">&quot;NFS: nfsi 0x%p turning cache off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>

		<span class="cm">/* Need to uncache any pages attached to this inode that</span>
<span class="cm">		 * fscache knows about before turning off the cache.</span>
<span class="cm">		 */</span>
		<span class="n">fscache_uncache_all_inode_pages</span><span class="p">(</span><span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
		<span class="n">nfs_fscache_zap_inode_cookie</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * wait_on_bit() sleep function for uninterruptible waiting</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_fscache_wait_bit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Lock against someone else trying to also acquire or relinquish a cookie</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nfs_fscache_inode_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">NFS_INO_FSCACHE_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">wait_on_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">NFS_INO_FSCACHE_LOCK</span><span class="p">,</span>
			    <span class="n">nfs_fscache_wait_bit</span><span class="p">,</span> <span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unlock cookie management lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nfs_fscache_inode_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">smp_mb__before_clear_bit</span><span class="p">();</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_INO_FSCACHE_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
	<span class="n">wake_up_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">NFS_INO_FSCACHE_LOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Decide if we should enable or disable local caching for this inode.</span>
<span class="cm"> * - For now, with NFS, only regular files that are open read-only will be able</span>
<span class="cm"> *   to use the cache.</span>
<span class="cm"> * - May be invoked multiple times in parallel by parallel nfs_open() functions.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_fscache_set_inode_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NFS_FSCACHE</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nfs_fscache_inode_lock</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">O_RDONLY</span><span class="p">)</span>
			<span class="n">nfs_fscache_disable_inode_cookie</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">nfs_fscache_enable_inode_cookie</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="n">nfs_fscache_inode_unlock</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Replace a per-inode cookie due to revalidation detecting a file having</span>
<span class="cm"> * changed on the server.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_fscache_reset_inode_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">nfss</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">NFS_IFDEBUG</span><span class="p">(</span><span class="k">struct</span> <span class="n">fscache_cookie</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">);</span>

	<span class="n">nfs_fscache_inode_lock</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* retire the current fscache cache and get a new one */</span>
		<span class="n">fscache_relinquish_cookie</span><span class="p">(</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span> <span class="o">=</span> <span class="n">fscache_acquire_cookie</span><span class="p">(</span>
			<span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">nfs_fscache_inode_object_def</span><span class="p">,</span>
			<span class="n">nfsi</span><span class="p">);</span>

		<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span>
			 <span class="s">&quot;NFS: revalidation new cookie (0x%p/0x%p/0x%p/0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">nfss</span><span class="p">,</span> <span class="n">nfsi</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nfs_fscache_inode_unlock</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release the caching state associated with a page, if the page isn&#39;t busy</span>
<span class="cm"> * interacting with the cache.</span>
<span class="cm"> * - Returns true (can release page) or false (page busy).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nfs_fscache_release_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PageFsCache</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">fscache_cookie</span> <span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cookie</span><span class="p">);</span>
		<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span> <span class="s">&quot;NFS: fscache releasepage (0x%p/0x%p/0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">cookie</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">nfsi</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fscache_maybe_release_page</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">gfp</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">nfs_add_fscache_stats</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
				      <span class="n">NFSIOS_FSCACHE_PAGES_UNCACHED</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release the caching state associated with a page if undergoing complete page</span>
<span class="cm"> * invalidation.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__nfs_fscache_invalidate_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fscache_cookie</span> <span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cookie</span><span class="p">);</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span> <span class="s">&quot;NFS: fscache invalidatepage (0x%p/0x%p/0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">cookie</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">nfsi</span><span class="p">);</span>

	<span class="n">fscache_wait_on_page_write</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">PageLocked</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="n">fscache_uncache_page</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">nfs_add_fscache_stats</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			      <span class="n">NFSIOS_FSCACHE_PAGES_UNCACHED</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle completion of a page being read from the cache.</span>
<span class="cm"> * - Called in process (keventd) context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_readpage_from_fscache_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
					       <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span>
		 <span class="s">&quot;NFS: readpage_from_fscache_complete (0x%p/0x%p/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">page</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="cm">/* if the read completes with an error, we just unlock the page and let</span>
<span class="cm">	 * the VM reissue the readpage */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_readpage_async</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Retrieve a page from fscache</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__nfs_readpage_from_fscache</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span>
		 <span class="s">&quot;NFS: readpage_from_fscache(fsc:%p/p:%p(i:%lx f:%lx)/0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fscache_read_or_alloc_page</span><span class="p">(</span><span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span>
					 <span class="n">page</span><span class="p">,</span>
					 <span class="n">nfs_readpage_from_fscache_complete</span><span class="p">,</span>
					 <span class="n">ctx</span><span class="p">,</span>
					 <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* read BIO submitted (page in fscache) */</span>
		<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span>
			 <span class="s">&quot;NFS:    readpage_from_fscache: BIO submitted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">nfs_add_fscache_stats</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">NFSIOS_FSCACHE_PAGES_READ_OK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="n">ENOBUFS</span>: <span class="cm">/* inode not in cache */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODATA</span>: <span class="cm">/* page not in cache */</span>
		<span class="n">nfs_add_fscache_stats</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">NFSIOS_FSCACHE_PAGES_READ_FAIL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span>
			 <span class="s">&quot;NFS:    readpage_from_fscache %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span> <span class="s">&quot;NFS:    readpage_from_fscache %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">nfs_add_fscache_stats</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">NFSIOS_FSCACHE_PAGES_READ_FAIL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Retrieve a set of pages from fscache</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__nfs_readpages_from_fscache</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pages</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="o">*</span><span class="n">nr_pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">npages</span> <span class="o">=</span> <span class="o">*</span><span class="n">nr_pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span> <span class="s">&quot;NFS: nfs_getpages_from_fscache (0x%p/%u/0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fscache_read_or_alloc_pages</span><span class="p">(</span><span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span>
					  <span class="n">mapping</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">,</span>
					  <span class="n">nfs_readpage_from_fscache_complete</span><span class="p">,</span>
					  <span class="n">ctx</span><span class="p">,</span>
					  <span class="n">mapping_gfp_mask</span><span class="p">(</span><span class="n">mapping</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nr_pages</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">)</span>
		<span class="n">nfs_add_fscache_stats</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">NFSIOS_FSCACHE_PAGES_READ_OK</span><span class="p">,</span>
				      <span class="n">npages</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nr_pages</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nfs_add_fscache_stats</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">NFSIOS_FSCACHE_PAGES_READ_FAIL</span><span class="p">,</span>
				      <span class="o">*</span><span class="n">nr_pages</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* read submitted to the cache for all pages */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">pages</span><span class="p">));</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">*</span><span class="n">nr_pages</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span>
			 <span class="s">&quot;NFS: nfs_getpages_from_fscache: submitted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="n">ENOBUFS</span>: <span class="cm">/* some pages aren&#39;t cached and can&#39;t be */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODATA</span>: <span class="cm">/* some pages aren&#39;t cached */</span>
		<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span>
			 <span class="s">&quot;NFS: nfs_getpages_from_fscache: no page: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span>
			 <span class="s">&quot;NFS: nfs_getpages_from_fscache: ret  %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Store a newly fetched page in fscache</span>
<span class="cm"> * - PG_fscache must be set on the page</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__nfs_readpage_to_fscache</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span>
		 <span class="s">&quot;NFS: readpage_to_fscache(fsc:%p/p:%p(i:%lx f:%lx)/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">sync</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fscache_write_page</span><span class="p">(</span><span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">FSCACHE</span><span class="p">,</span>
		 <span class="s">&quot;NFS:     readpage_to_fscache: p:%p(i:%lu f:%lx) ret %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">page</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fscache_uncache_page</span><span class="p">(</span><span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="n">nfs_add_fscache_stats</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span>
				      <span class="n">NFSIOS_FSCACHE_PAGES_WRITTEN_FAIL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">nfs_add_fscache_stats</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">NFSIOS_FSCACHE_PAGES_UNCACHED</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nfs_add_fscache_stats</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span>
				      <span class="n">NFSIOS_FSCACHE_PAGES_WRITTEN_OK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
