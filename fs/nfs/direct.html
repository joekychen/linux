<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › nfs › direct.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>direct.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/fs/nfs/direct.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003 by Chuck Lever &lt;cel@netapp.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * High-performance uncached I/O for the Linux NFS client</span>
<span class="cm"> *</span>
<span class="cm"> * There are important applications whose performance or correctness</span>
<span class="cm"> * depends on uncached access to file data.  Database clusters</span>
<span class="cm"> * (multiple copies of the same instance running on separate hosts)</span>
<span class="cm"> * implement their own cache coherency protocol that subsumes file</span>
<span class="cm"> * system cache protocols.  Applications that process datasets</span>
<span class="cm"> * considerably larger than the client&#39;s memory do not always benefit</span>
<span class="cm"> * from a local cache.  A streaming video server, for instance, has no</span>
<span class="cm"> * need to cache the contents of a file.</span>
<span class="cm"> *</span>
<span class="cm"> * When an application requests uncached I/O, all read and write requests</span>
<span class="cm"> * are made directly to the server; data stored or fetched via these</span>
<span class="cm"> * requests is not cached in the Linux page cache.  The client does not</span>
<span class="cm"> * correct unaligned requests from applications.  All requested bytes are</span>
<span class="cm"> * held on permanent storage before a direct write system call returns to</span>
<span class="cm"> * an application.</span>
<span class="cm"> *</span>
<span class="cm"> * Solaris implements an uncached I/O facility called directio() that</span>
<span class="cm"> * is used for backups and sequential I/O to very large files.  Solaris</span>
<span class="cm"> * also supports uncaching whole NFS partitions with &quot;-o forcedirectio,&quot;</span>
<span class="cm"> * an undocumented mount option.</span>
<span class="cm"> *</span>
<span class="cm"> * Designed by Jeff Kimmel, Chuck Lever, and Trond Myklebust, with</span>
<span class="cm"> * help from Andrew Morton.</span>
<span class="cm"> *</span>
<span class="cm"> * 18 Dec 2001	Initial implementation for 2.4  --cel</span>
<span class="cm"> * 08 Jul 2002	Version for 2.4.19, with bug fixes --trondmy</span>
<span class="cm"> * 08 Jun 2003	Port to 2.5 APIs  --cel</span>
<span class="cm"> * 31 Mar 2004	Handle direct I/O without VFS support  --cel</span>
<span class="cm"> * 15 Sep 2004	Parallel async reads  --cel</span>
<span class="cm"> * 04 May 2005	support O_DIRECT with aio  --cel</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/kref.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/task_io_accounting_ops.h&gt;</span>

<span class="cp">#include &lt;linux/nfs_fs.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_page.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/clnt.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="cp">#include &quot;internal.h&quot;</span>
<span class="cp">#include &quot;iostat.h&quot;</span>
<span class="cp">#include &quot;pnfs.h&quot;</span>

<span class="cp">#define NFSDBG_FACILITY		NFSDBG_VFS</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">nfs_direct_cachep</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This represents a set of asynchronous requests that we&#39;re waiting on</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kref</span>		<span class="n">kref</span><span class="p">;</span>		<span class="cm">/* release manager */</span>

	<span class="cm">/* I/O parameters */</span>
	<span class="k">struct</span> <span class="n">nfs_open_context</span>	<span class="o">*</span><span class="n">ctx</span><span class="p">;</span>		<span class="cm">/* file open context info */</span>
	<span class="k">struct</span> <span class="n">nfs_lock_context</span> <span class="o">*</span><span class="n">l_ctx</span><span class="p">;</span>		<span class="cm">/* Lock context info */</span>
	<span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span>		<span class="n">iocb</span><span class="p">;</span>		<span class="cm">/* controlling i/o request */</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span>		<span class="n">inode</span><span class="p">;</span>		<span class="cm">/* target file of i/o */</span>

	<span class="cm">/* completion state */</span>
	<span class="n">atomic_t</span>		<span class="n">io_count</span><span class="p">;</span>	<span class="cm">/* i/os we&#39;re waiting for */</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>		<span class="cm">/* protect completion state */</span>
	<span class="kt">ssize_t</span>			<span class="n">count</span><span class="p">,</span>		<span class="cm">/* bytes actually processed */</span>
				<span class="n">error</span><span class="p">;</span>		<span class="cm">/* any reported error */</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">completion</span><span class="p">;</span>	<span class="cm">/* wait for i/o completion */</span>

	<span class="cm">/* commit state */</span>
	<span class="k">struct</span> <span class="n">nfs_mds_commit_info</span> <span class="n">mds_cinfo</span><span class="p">;</span>	<span class="cm">/* Storage for cinfo */</span>
	<span class="k">struct</span> <span class="n">pnfs_ds_commit_info</span> <span class="n">ds_cinfo</span><span class="p">;</span>	<span class="cm">/* Storage for cinfo */</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">work</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">;</span>
<span class="cp">#define NFS_ODIRECT_DO_COMMIT		(1)	</span><span class="cm">/* an unstable reply was received */</span><span class="cp"></span>
<span class="cp">#define NFS_ODIRECT_RESCHED_WRITES	(2)	</span><span class="cm">/* write verification failed */</span><span class="cp"></span>
	<span class="k">struct</span> <span class="n">nfs_writeverf</span>	<span class="n">verf</span><span class="p">;</span>		<span class="cm">/* unstable write verifier */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_pgio_completion_ops</span> <span class="n">nfs_direct_write_completion_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_commit_completion_ops</span> <span class="n">nfs_direct_commit_completion_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nfs_direct_write_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nfs_direct_write_schedule_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">get_dreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">io_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">put_dreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">io_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nfs_direct_IO - NFS address space operation for direct I/O</span>
<span class="cm"> * @rw: direction (read or write)</span>
<span class="cm"> * @iocb: target I/O control block</span>
<span class="cm"> * @iov: array of vectors that define I/O buffer</span>
<span class="cm"> * @pos: offset in file to begin the operation</span>
<span class="cm"> * @nr_segs: size of iovec array</span>
<span class="cm"> *</span>
<span class="cm"> * The presence of this routine in the address space ops vector means</span>
<span class="cm"> * the NFS client supports direct I/O.  However, we shunt off direct</span>
<span class="cm"> * read and write requests before the VFS gets them, so this method</span>
<span class="cm"> * should never be called.</span>
<span class="cm"> */</span>
<span class="kt">ssize_t</span> <span class="nf">nfs_direct_IO</span><span class="p">(</span><span class="kt">int</span> <span class="n">rw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_segs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS: nfs_direct_IO (%s) off/no(%Ld/%lu) EINVAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pos</span><span class="p">,</span> <span class="n">nr_segs</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_release_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs_init_cinfo_from_dreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_commit_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">mds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">mds_cinfo</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">ds_cinfo</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">dreq</span> <span class="o">=</span> <span class="n">dreq</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">completion_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_direct_commit_completion_ops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="nf">nfs_direct_req_alloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">;</span>

	<span class="n">dreq</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">nfs_direct_cachep</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dreq</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">mds_cinfo</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">nfs_direct_write_schedule_work</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dreq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_req_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_direct_req</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">l_ctx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">nfs_put_lock_context</span><span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">l_ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">ctx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">put_nfs_open_context</span><span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">nfs_direct_cachep</span><span class="p">,</span> <span class="n">dreq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_req_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">nfs_direct_req_free</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Collects and returns the final error value/byte-count.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">nfs_direct_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIOCBQUEUED</span><span class="p">;</span>

	<span class="cm">/* Async requests don&#39;t wait here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">wait_for_completion_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">dreq</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">dreq</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Synchronous I/O uses a stack-allocated iocb.  Thus we can&#39;t trust</span>
<span class="cm"> * the iocb is still valid here if this is a synchronous request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">dreq</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">dreq</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		<span class="n">aio_complete</span><span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>

	<span class="n">nfs_direct_req_release</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_readpage_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_page</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS: direct read done (%s/%lld %d@%lld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">wb_context</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">NFS_FILEID</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">wb_context</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">),</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">wb_bytes</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">req_offset</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
	<span class="n">nfs_release_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_read_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_pgio_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dreq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_IOHDR_REDO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_IOHDR_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">good_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">good_bytes</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs_page</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">nfs_list_entry</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">wb_page</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_IOHDR_EOF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">good_bytes</span><span class="p">)</span>
				<span class="n">zero_user</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">good_bytes</span> <span class="o">-</span> <span class="n">bytes</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
				<span class="n">zero_user_segment</span><span class="p">(</span><span class="n">page</span><span class="p">,</span>
					<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">good_bytes</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">,</span>
					<span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PageCompound</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_IOHDR_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">good_bytes</span><span class="p">)</span>
					<span class="n">set_page_dirty</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">set_page_dirty</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bytes</span> <span class="o">+=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">wb_bytes</span><span class="p">;</span>
		<span class="n">nfs_list_remove_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">nfs_direct_readpage_release</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out_put:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_dreq</span><span class="p">(</span><span class="n">dreq</span><span class="p">))</span>
		<span class="n">nfs_direct_complete</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_read_sync_pgio_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_page</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">nfs_list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">nfs_list_remove_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">nfs_release_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_pgio_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_pgio_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_dreq</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dreq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_pgio_completion_ops</span> <span class="n">nfs_direct_read_completion_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_cleanup</span> <span class="o">=</span> <span class="n">nfs_read_sync_pgio_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_hdr</span> <span class="o">=</span> <span class="n">nfs_direct_pgio_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">completion</span> <span class="o">=</span> <span class="n">nfs_direct_read_completion</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * For each rsize&#39;d chunk of the user&#39;s buffer, dispatch an NFS READ</span>
<span class="cm"> * operation.  If nfs_readdata_alloc() or get_user_pages() fails,</span>
<span class="cm"> * bail and stop sending more reads.  Read length accounting is</span>
<span class="cm"> * handled automatically by nfs_direct_read_result().  Otherwise, if</span>
<span class="cm"> * no requests have been sent, just return an error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">nfs_direct_read_schedule_segment</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_pageio_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
						<span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span>
						<span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">pg_dreq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">dreq</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">rsize</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pgbase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pagevec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">pgbase</span> <span class="o">=</span> <span class="n">user_addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">rsize</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">),</span> <span class="n">count</span><span class="p">);</span>

		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">npages</span> <span class="o">=</span> <span class="n">nfs_page_array_len</span><span class="p">(</span><span class="n">pgbase</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pagevec</span><span class="p">)</span>
			<span class="n">pagevec</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">npages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">),</span>
					  <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pagevec</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">get_user_pages</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span> <span class="n">user_addr</span><span class="p">,</span>
					<span class="n">npages</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pagevec</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">result</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">result</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;=</span> <span class="n">pgbase</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nfs_direct_release_pages</span><span class="p">(</span><span class="n">pagevec</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bytes</span> <span class="o">-=</span> <span class="n">pgbase</span><span class="p">;</span>
			<span class="n">npages</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">nfs_page</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">req_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">pgbase</span><span class="p">);</span>
			<span class="cm">/* XXX do we need to do the eof zeroing found in async_filler? */</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">nfs_create_request</span><span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dreq</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span>
						 <span class="n">pagevec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						 <span class="n">pgbase</span><span class="p">,</span> <span class="n">req_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">wb_index</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">wb_offset</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs_pageio_add_request</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">pg_error</span><span class="p">;</span>
				<span class="n">nfs_release_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pgbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bytes</span> <span class="o">-=</span> <span class="n">req_len</span><span class="p">;</span>
			<span class="n">started</span> <span class="o">+=</span> <span class="n">req_len</span><span class="p">;</span>
			<span class="n">user_addr</span> <span class="o">+=</span> <span class="n">req_len</span><span class="p">;</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">req_len</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="n">req_len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* The nfs_page now hold references to these pages */</span>
		<span class="n">nfs_direct_release_pages</span><span class="p">(</span><span class="n">pagevec</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pagevec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">started</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">started</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span> <span class="n">result</span> <span class="o">:</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">nfs_direct_read_schedule_iovec</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">,</span>
					      <span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span>
					      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_segs</span><span class="p">,</span>
					      <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_pageio_descriptor</span> <span class="n">desc</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">requested_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seg</span><span class="p">;</span>

	<span class="n">nfs_pageio_init_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="n">dreq</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">nfs_direct_read_completion_ops</span><span class="p">);</span>
	<span class="n">get_dreq</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
	<span class="n">desc</span><span class="p">.</span><span class="n">pg_dreq</span> <span class="o">=</span> <span class="n">dreq</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">seg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">seg</span> <span class="o">&lt;</span> <span class="n">nr_segs</span><span class="p">;</span> <span class="n">seg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">vec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">[</span><span class="n">seg</span><span class="p">];</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">nfs_direct_read_schedule_segment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">requested_bytes</span> <span class="o">+=</span> <span class="n">result</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="n">result</span> <span class="o">&lt;</span> <span class="n">vec</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">vec</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nfs_pageio_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If no bytes were started, return the error, and let the</span>
<span class="cm">	 * generic layer handle the completion.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">requested_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs_direct_req_release</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">result</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_dreq</span><span class="p">(</span><span class="n">dreq</span><span class="p">))</span>
		<span class="n">nfs_direct_complete</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">nfs_direct_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">;</span>

	<span class="n">dreq</span> <span class="o">=</span> <span class="n">nfs_direct_req_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dreq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">inode</span> <span class="o">=</span> <span class="n">inode</span><span class="p">;</span>
	<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">get_nfs_open_context</span><span class="p">(</span><span class="n">nfs_file_open_context</span><span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="p">));</span>
	<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">l_ctx</span> <span class="o">=</span> <span class="n">nfs_get_lock_context</span><span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">l_ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_release</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_sync_kiocb</span><span class="p">(</span><span class="n">iocb</span><span class="p">))</span>
		<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">iocb</span> <span class="o">=</span> <span class="n">iocb</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">nfs_direct_read_schedule_iovec</span><span class="p">(</span><span class="n">dreq</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">nfs_direct_wait</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
	<span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">read_io</span> <span class="o">+=</span> <span class="n">result</span><span class="p">;</span>
<span class="nl">out_release:</span>
	<span class="n">nfs_direct_req_release</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_inode_dio_write_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs_zap_mapping</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">);</span>
	<span class="n">inode_dio_done</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_NFS_V3) || defined(CONFIG_NFS_V4)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_write_reschedule</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_pageio_descriptor</span> <span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_page</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">reqs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_commit_info</span> <span class="n">cinfo</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">failed</span><span class="p">);</span>

	<span class="n">nfs_init_cinfo_from_dreq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">dreq</span><span class="p">);</span>
	<span class="n">pnfs_recover_commit_reqs</span><span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reqs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="n">cinfo</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nfs_scan_commit_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="p">.</span><span class="n">mds</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reqs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">cinfo</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">get_dreq</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>

	<span class="n">nfs_pageio_init_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="n">dreq</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="n">FLUSH_STABLE</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">nfs_direct_write_completion_ops</span><span class="p">);</span>
	<span class="n">desc</span><span class="p">.</span><span class="n">pg_dreq</span> <span class="o">=</span> <span class="n">dreq</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reqs</span><span class="p">,</span> <span class="n">wb_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs_pageio_add_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nfs_list_add_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">failed</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="n">cinfo</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="n">cinfo</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">nfs_release_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nfs_pageio_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">failed</span><span class="p">))</span>
		<span class="n">nfs_unlock_and_release_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_dreq</span><span class="p">(</span><span class="n">dreq</span><span class="p">))</span>
		<span class="n">nfs_direct_write_complete</span><span class="p">(</span><span class="n">dreq</span><span class="p">,</span> <span class="n">dreq</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_commit_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_commit_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dreq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_commit_info</span> <span class="n">cinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_page</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">tk_status</span><span class="p">;</span>

	<span class="n">nfs_init_cinfo_from_dreq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">dreq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS: %5u commit failed with error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">NFS_ODIRECT_RESCHED_WRITES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">verf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">verf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">verf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS: %5u commit verify failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">tk_pid</span><span class="p">);</span>
		<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">NFS_ODIRECT_RESCHED_WRITES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS: %5u commit returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">nfs_list_entry</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="n">nfs_list_remove_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">NFS_ODIRECT_RESCHED_WRITES</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Note the rewrite will go through mds */</span>
			<span class="n">nfs_mark_request_commit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">nfs_release_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">nfs_unlock_and_release_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="p">.</span><span class="n">mds</span><span class="o">-&gt;</span><span class="n">rpcs_out</span><span class="p">))</span>
		<span class="n">nfs_direct_write_complete</span><span class="p">(</span><span class="n">dreq</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_error_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* There is no lock to clear */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_commit_completion_ops</span> <span class="n">nfs_direct_commit_completion_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">completion</span> <span class="o">=</span> <span class="n">nfs_direct_commit_complete</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_cleanup</span> <span class="o">=</span> <span class="n">nfs_direct_error_cleanup</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_commit_schedule</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_commit_info</span> <span class="n">cinfo</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">mds_list</span><span class="p">);</span>

	<span class="n">nfs_init_cinfo_from_dreq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">dreq</span><span class="p">);</span>
	<span class="n">nfs_scan_commit</span><span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mds_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">nfs_generic_commit_list</span><span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mds_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* res == -ENOMEM */</span>
		<span class="n">nfs_direct_write_reschedule</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_write_schedule_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_direct_req</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">dreq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NFS_ODIRECT_DO_COMMIT</span>:
			<span class="n">nfs_direct_commit_schedule</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFS_ODIRECT_RESCHED_WRITES</span>:
			<span class="n">nfs_direct_write_reschedule</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">nfs_inode_dio_write_done</span><span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
			<span class="n">nfs_direct_complete</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_write_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span> <span class="cm">/* Calls nfs_direct_write_schedule_work */</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_write_schedule_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_write_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs_inode_dio_write_done</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">nfs_direct_complete</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * NB: Return the value of the first error return code.  Subsequent</span>
<span class="cm"> *     errors after the first one are ignored.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * For each wsize&#39;d chunk of the user&#39;s buffer, dispatch an NFS WRITE</span>
<span class="cm"> * operation.  If nfs_writedata_alloc() or get_user_pages() fails,</span>
<span class="cm"> * bail and stop sending more writes.  Write length accounting is</span>
<span class="cm"> * handled automatically by nfs_direct_write_result().  Otherwise, if</span>
<span class="cm"> * no requests have been sent, just return an error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">nfs_direct_write_schedule_segment</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_pageio_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
						 <span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span>
						 <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">pg_dreq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">dreq</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">wsize</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pgbase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pagevec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">pgbase</span> <span class="o">=</span> <span class="n">user_addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">wsize</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">),</span> <span class="n">count</span><span class="p">);</span>

		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">npages</span> <span class="o">=</span> <span class="n">nfs_page_array_len</span><span class="p">(</span><span class="n">pgbase</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pagevec</span><span class="p">)</span>
			<span class="n">pagevec</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">npages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pagevec</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">get_user_pages</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span> <span class="n">user_addr</span><span class="p">,</span>
					<span class="n">npages</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pagevec</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">result</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">result</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;=</span> <span class="n">pgbase</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nfs_direct_release_pages</span><span class="p">(</span><span class="n">pagevec</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bytes</span> <span class="o">-=</span> <span class="n">pgbase</span><span class="p">;</span>
			<span class="n">npages</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">nfs_page</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">req_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">pgbase</span><span class="p">);</span>

			<span class="n">req</span> <span class="o">=</span> <span class="n">nfs_create_request</span><span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dreq</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span>
						 <span class="n">pagevec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						 <span class="n">pgbase</span><span class="p">,</span> <span class="n">req_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">nfs_lock_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">wb_index</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">wb_offset</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs_pageio_add_request</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">pg_error</span><span class="p">;</span>
				<span class="n">nfs_unlock_and_release_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pgbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bytes</span> <span class="o">-=</span> <span class="n">req_len</span><span class="p">;</span>
			<span class="n">started</span> <span class="o">+=</span> <span class="n">req_len</span><span class="p">;</span>
			<span class="n">user_addr</span> <span class="o">+=</span> <span class="n">req_len</span><span class="p">;</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">req_len</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="n">req_len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* The nfs_page now hold references to these pages */</span>
		<span class="n">nfs_direct_release_pages</span><span class="p">(</span><span class="n">pagevec</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pagevec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">started</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">started</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span> <span class="n">result</span> <span class="o">:</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_direct_write_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_pgio_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dreq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_commit_info</span> <span class="n">cinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_page</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">nfs_list_entry</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_IOHDR_REDO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>

	<span class="n">nfs_init_cinfo_from_dreq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">dreq</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_IOHDR_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">NFS_IOHDR_ERROR</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">good_bytes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_IOHDR_NEED_RESCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">NFS_ODIRECT_RESCHED_WRITES</span><span class="p">;</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="n">NFS_IOHDR_NEED_RESCHED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_IOHDR_NEED_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">NFS_ODIRECT_RESCHED_WRITES</span><span class="p">)</span>
				<span class="n">bit</span> <span class="o">=</span> <span class="n">NFS_IOHDR_NEED_RESCHED</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">verf</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">verf</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">verf</span><span class="p">));</span>
				<span class="n">bit</span> <span class="o">=</span> <span class="n">NFS_IOHDR_NEED_COMMIT</span><span class="p">;</span>
				<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">NFS_ODIRECT_DO_COMMIT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">NFS_ODIRECT_DO_COMMIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">verf</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">verf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">verf</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">NFS_ODIRECT_RESCHED_WRITES</span><span class="p">;</span>
					<span class="n">bit</span> <span class="o">=</span> <span class="n">NFS_IOHDR_NEED_RESCHED</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">bit</span> <span class="o">=</span> <span class="n">NFS_IOHDR_NEED_COMMIT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">nfs_list_entry</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="n">nfs_list_remove_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NFS_IOHDR_NEED_RESCHED</span>:
		<span class="k">case</span> <span class="n">NFS_IOHDR_NEED_COMMIT</span>:
			<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">wb_kref</span><span class="p">);</span>
			<span class="n">nfs_mark_request_commit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">lseg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">nfs_unlock_and_release_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out_put:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_dreq</span><span class="p">(</span><span class="n">dreq</span><span class="p">))</span>
		<span class="n">nfs_direct_write_complete</span><span class="p">(</span><span class="n">dreq</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_write_sync_pgio_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_page</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">nfs_list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">nfs_list_remove_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">nfs_unlock_and_release_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_pgio_completion_ops</span> <span class="n">nfs_direct_write_completion_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_cleanup</span> <span class="o">=</span> <span class="n">nfs_write_sync_pgio_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_hdr</span> <span class="o">=</span> <span class="n">nfs_direct_pgio_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">completion</span> <span class="o">=</span> <span class="n">nfs_direct_write_completion</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">nfs_direct_write_schedule_iovec</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">,</span>
					       <span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_segs</span><span class="p">,</span>
					       <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_pageio_descriptor</span> <span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">dreq</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">requested_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seg</span><span class="p">;</span>

	<span class="n">nfs_pageio_init_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">FLUSH_COND_STABLE</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">nfs_direct_write_completion_ops</span><span class="p">);</span>
	<span class="n">desc</span><span class="p">.</span><span class="n">pg_dreq</span> <span class="o">=</span> <span class="n">dreq</span><span class="p">;</span>
	<span class="n">get_dreq</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dio_count</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">seg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">seg</span> <span class="o">&lt;</span> <span class="n">nr_segs</span><span class="p">;</span> <span class="n">seg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">vec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">[</span><span class="n">seg</span><span class="p">];</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">nfs_direct_write_schedule_segment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">requested_bytes</span> <span class="o">+=</span> <span class="n">result</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="n">result</span> <span class="o">&lt;</span> <span class="n">vec</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">vec</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nfs_pageio_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">NFS_I</span><span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">write_io</span> <span class="o">+=</span> <span class="n">desc</span><span class="p">.</span><span class="n">pg_bytes_written</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If no bytes were started, return the error, and let the</span>
<span class="cm">	 * generic layer handle the completion.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">requested_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inode_dio_done</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="n">nfs_direct_req_release</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">result</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_dreq</span><span class="p">(</span><span class="n">dreq</span><span class="p">))</span>
		<span class="n">nfs_direct_write_complete</span><span class="p">(</span><span class="n">dreq</span><span class="p">,</span> <span class="n">dreq</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">nfs_direct_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_direct_req</span> <span class="o">*</span><span class="n">dreq</span><span class="p">;</span>

	<span class="n">dreq</span> <span class="o">=</span> <span class="n">nfs_direct_req_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dreq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">inode</span> <span class="o">=</span> <span class="n">inode</span><span class="p">;</span>
	<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">get_nfs_open_context</span><span class="p">(</span><span class="n">nfs_file_open_context</span><span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="p">));</span>
	<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">l_ctx</span> <span class="o">=</span> <span class="n">nfs_get_lock_context</span><span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dreq</span><span class="o">-&gt;</span><span class="n">l_ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_release</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_sync_kiocb</span><span class="p">(</span><span class="n">iocb</span><span class="p">))</span>
		<span class="n">dreq</span><span class="o">-&gt;</span><span class="n">iocb</span> <span class="o">=</span> <span class="n">iocb</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">nfs_direct_write_schedule_iovec</span><span class="p">(</span><span class="n">dreq</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">nfs_direct_wait</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
<span class="nl">out_release:</span>
	<span class="n">nfs_direct_req_release</span><span class="p">(</span><span class="n">dreq</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nfs_file_direct_read - file direct read operation for NFS files</span>
<span class="cm"> * @iocb: target I/O control block</span>
<span class="cm"> * @iov: vector of user buffers into which to read data</span>
<span class="cm"> * @nr_segs: size of iov vector</span>
<span class="cm"> * @pos: byte offset in file where reading starts</span>
<span class="cm"> *</span>
<span class="cm"> * We use this function for direct reads instead of calling</span>
<span class="cm"> * generic_file_aio_read() in order to avoid gfar&#39;s check to see if</span>
<span class="cm"> * the request starts before the end of the file.  For that check</span>
<span class="cm"> * to work, we must generate a GETATTR before each direct read, and</span>
<span class="cm"> * even then there is a window between the GETATTR and the subsequent</span>
<span class="cm"> * READ where the file size could change.  Our preference is simply</span>
<span class="cm"> * to do all reads the application wants, and the server will take</span>
<span class="cm"> * care of managing the end of file boundary.</span>
<span class="cm"> *</span>
<span class="cm"> * This function also eliminates unnecessarily updating the file&#39;s</span>
<span class="cm"> * atime locally, as the NFS server sets the file&#39;s atime, and this</span>
<span class="cm"> * client must read the updated atime from the server back into its</span>
<span class="cm"> * cache.</span>
<span class="cm"> */</span>
<span class="kt">ssize_t</span> <span class="nf">nfs_file_direct_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">iov_length</span><span class="p">(</span><span class="n">iov</span><span class="p">,</span> <span class="n">nr_segs</span><span class="p">);</span>
	<span class="n">nfs_add_stats</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">NFSIOS_DIRECTREADBYTES</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="kt">FILE</span><span class="p">,</span> <span class="s">&quot;NFS: direct read(%s/%s, %zd@%Ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		<span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pos</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">nfs_sync_mapping</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">task_io_account_read</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">nfs_direct_read</span><span class="p">(</span><span class="n">iocb</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nfs_file_direct_write - file direct write operation for NFS files</span>
<span class="cm"> * @iocb: target I/O control block</span>
<span class="cm"> * @iov: vector of user buffers from which to write data</span>
<span class="cm"> * @nr_segs: size of iov vector</span>
<span class="cm"> * @pos: byte offset in file where writing starts</span>
<span class="cm"> *</span>
<span class="cm"> * We use this function for direct writes instead of calling</span>
<span class="cm"> * generic_file_aio_write() in order to avoid taking the inode</span>
<span class="cm"> * semaphore and updating the i_size.  The NFS server will set</span>
<span class="cm"> * the new i_size and this client must read the updated size</span>
<span class="cm"> * back into its cache.  We let the server do generic write</span>
<span class="cm"> * parameter checking and report problems.</span>
<span class="cm"> *</span>
<span class="cm"> * We eliminate local atime updates, see direct read above.</span>
<span class="cm"> *</span>
<span class="cm"> * We avoid unnecessary page cache invalidations for normal cached</span>
<span class="cm"> * readers of this file.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that O_APPEND is not supported for NFS direct writes, as there</span>
<span class="cm"> * is no atomic O_APPEND write facility in the NFS protocol.</span>
<span class="cm"> */</span>
<span class="kt">ssize_t</span> <span class="nf">nfs_file_direct_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">iov_length</span><span class="p">(</span><span class="n">iov</span><span class="p">,</span> <span class="n">nr_segs</span><span class="p">);</span>
	<span class="n">nfs_add_stats</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">NFSIOS_DIRECTWRITTENBYTES</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="kt">FILE</span><span class="p">,</span> <span class="s">&quot;NFS: direct write(%s/%s, %zd@%Ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		<span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pos</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">generic_write_checks</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">ssize_t</span><span class="p">)</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">nfs_sync_mapping</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">task_io_account_write</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">nfs_direct_write</span><span class="p">(</span><span class="n">iocb</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>

		<span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">retval</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_pos</span><span class="p">)</span>
			<span class="n">i_size_write</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_pos</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nfs_init_directcache - create a slab cache for nfs_direct_req structures</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">nfs_init_directcache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs_direct_cachep</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;nfs_direct_cache&quot;</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_direct_req</span><span class="p">),</span>
						<span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">SLAB_RECLAIM_ACCOUNT</span><span class="o">|</span>
							<span class="n">SLAB_MEM_SPREAD</span><span class="p">),</span>
						<span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs_direct_cachep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nfs_destroy_directcache - destroy the slab cache for nfs_direct_req structures</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_destroy_directcache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">nfs_direct_cachep</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
